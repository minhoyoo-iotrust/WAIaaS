# 마일스톤 v2.4.3: Yield Trading (Pendle) + Yield 프레임워크

## 목표

DeFi Yield 프레임워크(수익률 추적, 만기 관리, PT/YT 포지션 모니터링)를 구축하고, Pendle Finance를 첫 번째 Yield Provider로 구현하여, AI 에이전트가 고정 수익률 전략을 정책 평가 하에 실행할 수 있는 상태.

---

## 배경

v2.4.1~v2.4.2에서 Lending(변동 이자율)이 지원되지만, **고정 수익률**(fixed yield)은 불가능하다. Pendle은 수익률을 PT(원금 토큰)와 YT(수익 토큰)로 분리하여 거래할 수 있게 한다.

- **PT 구매**: 만기까지 보유하면 원금 100% 회수 + 고정 수익률 확보 (채권과 유사)
- **YT 구매**: 변동 수익률에 레버리지 노출 (수익률 상승 시 이익)

Pendle은 TVL ~$4B으로 수익률 거래 분야 선두이며, 11+ EVM 체인을 지원한다. REST API가 무료로 제공되어 트랜잭션 빌드까지 API 호출만으로 가능하다.

### 사용 시나리오

```
AI 에이전트: "stETH를 Pendle에서 고정 5% 수익률로 예치해줘"

1. Pendle API: /markets (stETH pool, 만기 2026-06, implied APY 5.2%)
2. stETH → PT-stETH 구매 (할인 가격)
3. 만기(2026-06)에 PT-stETH → stETH 1:1 상환 → 고정 5.2% 수익 확보
```

---

## 구현 대상

### Yield 프레임워크 (공통 인프라)

| 컴포넌트 | 내용 |
|----------|------|
| IYieldProvider | Yield 전용 인터페이스. IActionProvider 확장. 추가 메서드: `getMarkets(chain)`, `getPosition(walletId)`, `getYieldForecast(marketId)`. 표준 액션: buyPT, buyYT, redeemPT, addLiquidity, removeLiquidity |
| YieldPositionTracker | 월렛별 Yield 포지션 추적. yield_positions 테이블(wallet_id, provider, market_id, token_type[PT/YT/LP], amount, entry_price, maturity, apy). PositionTracker(v2.3)와 통합 |
| MaturityMonitor | 만기 접근 알림. 만기 7일 전, 1일 전 알림 발송. 만기 후 미상환 경고 |

### Pendle 구현체

| 컴포넌트 | 내용 |
|----------|------|
| PendleLendingProvider | IYieldProvider 구현체. Pendle REST API v2 호출. 5개 액션: buyPT(고정 수익률 확보), buyYT(변동 수익률 레버리지), redeemPT(만기 상환), addLiquidity(LP 추가), removeLiquidity(LP 제거) |
| PendleApiClient | Pendle REST API v2 래퍼 (https://api-v2.pendle.finance). /markets, /swap, /add-liquidity, /remove-liquidity 엔드포인트. API 키 불필요(무료). 응답 Zod 스키마 검증 |
| MCP 도구 | waiaas_pendle_buy_pt, waiaas_pendle_buy_yt, waiaas_pendle_redeem, waiaas_pendle_positions |
| SDK 지원 | TS/Python SDK: executeAction('pendle_buy_pt', params) 등 |

### 입력 스키마

```typescript
const PendleBuyPTInputSchema = z.object({
  market: z.string(),           // Pendle market 주소
  tokenIn: z.string(),          // 입력 토큰 주소 (예: stETH)
  amountIn: z.string(),         // 입력 수량
  slippage: z.number().default(0.01), // 슬리피지 (1%)
});
```

### config.toml

```toml
[actions.pendle]
enabled = true
api_base_url = "https://api-v2.pendle.finance"   # 기본값
default_slippage_pct = 0.01                       # 1%
maturity_warning_days = 7                         # 만기 경고 (7일 전)
```

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | Pendle 통합 방식 | REST API v2 (https://api-v2.pendle.finance) | 무료, 문서화 우수, calldata 직접 반환. SDK 의존성 불필요. Jupiter/0x와 동일한 REST → calldata 패턴 |
| 2 | Yield 프레임워크 분리 | IYieldProvider (ILendingProvider와 별도) | Yield는 만기(maturity) 개념이 있어 Lending과 근본적으로 다름. PT/YT 토큰화도 Lending에 없는 개념. 별도 인터페이스가 명확 |
| 3 | 만기 모니터링 | 폴링 기반 (1일 1회) | 만기는 초 단위 추적이 불필요. 일 1회 체크로 7일/1일 전 경고 충분 |
| 4 | 지원 체인 | Ethereum, Arbitrum, Base 우선 | Pendle의 주요 유동성이 집중된 3개 체인. 나머지 8+ 체인은 config로 활성화 가능 |

---

## E2E 검증 시나리오

**자동화 비율: 95%+ -- `[HUMAN]` 1건**

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | buyPT resolve -> ContractCallRequest 반환 | mock Pendle /swap 응답 -> PendleYieldProvider.resolve('buyPT') -> ContractCallRequest assert | [L0] |
| 2 | buyPT 실행 -> PT 포지션 생성 | mock 실행 -> yield_positions 테이블에 PT 포지션(만기 포함) 기록 assert | [L0] |
| 3 | buyYT resolve -> ContractCallRequest 반환 | resolve('buyYT') -> YT 구매 calldata assert | [L0] |
| 4 | redeemPT -> 만기 도래 PT 상환 | 만기 지난 PT -> redeem -> 원금 토큰 수령 assert | [L0] |
| 5 | 만기 미도래 PT redeem -> 에러 | 만기 전 redeem 시도 -> MATURITY_NOT_REACHED 에러 assert | [L0] |
| 6 | 만기 7일 전 경고 알림 | mock 만기 6일 후 PT -> MaturityMonitor -> MATURITY_WARNING 알림 assert | [L0] |
| 7 | GET /v1/wallets/:id/positions -> Yield 포지션 포함 | Aave SUPPLY + Pendle PT -> 통합 포지션 목록에 모두 포함 assert | [L0] |
| 8 | 시장 목록 조회 | getMarkets('ethereum') -> Pendle 마켓 목록(APY, 만기 포함) 반환 assert | [L0] |
| 9 | Pendle API 실 호출 | Ethereum에서 /markets 실 호출 -> 마켓 목록 성공 확인 | [HUMAN] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v2.4.1 (Lending 프레임워크) | PositionTracker 통합, Admin 포트폴리오 뷰 확장, 정책 평가 인프라 |
| v1.5 (가격 오라클) | PT/YT 토큰 USD 환산 |
| v1.4 (EVM 인프라) | EvmAdapter, ContractCallRequest |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | PT/YT 개념 복잡도 | AI 에이전트/Owner가 PT/YT 개념을 이해하기 어려움 | MCP 도구 설명에 "고정 수익률(buyPT)" vs "변동 수익률 레버리지(buyYT)" 명시. 스킬 파일에 예시 시나리오 추가 |
| 2 | 만기 관리 부재 시 손실 | 만기 후 미상환 PT는 수익률을 놓칠 수 있음 | MaturityMonitor로 경고. 만기 도래 시 자동 상환 옵션(config.toml auto_redeem=true) |
| 3 | Pendle 유동성 변동 | 만기 접근 시 유동성 감소로 슬리피지 증가 | 만기 14일 전부터 슬리피지 경고. 유동성 부족 시 거래 거부 |

---

## 예상 규모

| 항목 | 예상 |
|------|------|
| 페이즈 | 2-3개 (Yield 프레임워크 + DB 1 / Pendle Provider + API Client 1 / MCP+만기 모니터링+Admin 1) |
| 신규/수정 파일 | 15-20개 |
| 테스트 | 9-15개 |
| DB 마이그레이션 | yield_positions 테이블 추가 (또는 positions 확장) |

---

*생성일: 2026-02-15*
*선행: v2.4.1 (Lending 프레임워크)*
*관련: Pendle (https://api-v2.pendle.finance/core/docs)*
