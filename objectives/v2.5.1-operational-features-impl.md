# 마일스톤 v2.1.1: 운영 기능 확장 구현

## 목표

v2.1에서 설계한 7가지 운영 기능 — Transaction Dry-Run, Audit Log Query API, Encrypted Backup, Webhook Outbound, Metrics Export, Anomaly Detection, IP ACL — 을 구현하여, WAIaaS 데몬이 운영 환경에서 모니터링/감사/백업/보안 제어가 가능한 상태.

---

## 배경

v2.1에서 7가지 기능의 인터페이스, 데이터 모델, 테스트 시나리오가 설계 수준에서 정의되었다. v2.1.1은 이 설계를 코드로 구현한다.

---

## 구현 대상 설계 문서

| 설계 ID | 기능 | 구현 범위 |
|---------|------|----------|
| OPS-01 | Transaction Dry-Run | POST /v1/transactions/simulate, Stage 1~3 dry-run 분기, SimulationResult, SDK/MCP 확장 |
| OPS-02 | Audit Log Query API | GET /v1/audit-logs, cursor pagination, 복합 인덱스, 통계 엔드포인트 |
| OPS-03 | Encrypted Backup | waiaas backup/restore CLI, AES-256-GCM 아카이브, 자동 스케줄러, 보존 정책 |
| OPS-04 | Webhook Outbound | webhook CRUD API (4 엔드포인트), HMAC-SHA256 서명, 재시도 큐, webhooks/webhook_logs 테이블 |
| OPS-05 | Metrics Export | GET /metrics (Prometheus format), IMetricsRegistry, 10+ 메트릭, 수집 훅 |
| OPS-06 | Anomaly Detection | IAnomalyRule, 5개 통계 규칙, ANOMALY_DETECTED 이벤트, 자동 tier 상향 |
| OPS-07 | IP ACL | ipAcl 미들웨어, CIDR 매칭, 엔드포인트별 매핑, Docker 가이드 |

---

## 산출물

### REST API 추가

| 메서드 | 경로 | 인증 | 기능 |
|--------|------|------|------|
| POST | /v1/transactions/simulate | sessionAuth | Dry-Run 시뮬레이션 |
| GET | /v1/audit-logs | masterAuth | 감사 로그 조회 |
| GET | /v1/audit-logs/stats | masterAuth | 감사 로그 통계 |
| POST | /v1/webhooks | masterAuth | Webhook 등록 |
| GET | /v1/webhooks | masterAuth | Webhook 목록 |
| DELETE | /v1/webhooks/:id | masterAuth | Webhook 삭제 |
| GET | /v1/webhooks/:id/logs | masterAuth | Webhook 전송 이력 |
| GET | /metrics | 설정 가능 | Prometheus 메트릭 |

### CLI 커맨드 추가

| 커맨드 | 설명 |
|--------|------|
| waiaas backup | 암호화 백업 생성 |
| waiaas restore | 백업에서 복원 |

### DB 마이그레이션

| 테이블 | 변경 |
|--------|------|
| webhooks | 신규 (url, secret_hash, event_types, active, created_at) |
| webhook_logs | 신규 (webhook_id, event_type, status_code, response_time, created_at) |
| audit_logs | 복합 인덱스 추가 (agent_id + event_type + created_at) |

### 알림 이벤트 추가

| 이벤트 | 설명 |
|--------|------|
| ANOMALY_DETECTED | 이상 행동 패턴 감지 시 발송 |

---

## 기술 결정 사항

v2.1 설계 문서의 기술 결정을 그대로 따른다. 구현 시 추가 결정이 필요한 항목은 phase research에서 확정한다.

---

## E2E 검증 시나리오

v2.1에서 정의한 18개 핵심 검증 시나리오(T-01~T-18)와 6개 보안 시나리오(S-01~S-06)를 구현하여 자동화 테스트로 검증한다.

**자동화 비율: 100%**

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v2.1 (운영 기능 확장 설계) | 7가지 기능의 인터페이스, 스키마, 테스트 시나리오 정의 |
| v2.0 (릴리스) | 코어 인프라 안정화 상태에서 운영 기능 추가 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 7가지 기능 동시 구현 범위 과다 | 마일스톤 장기화 | 기능별 독립 페이즈로 분할. 우선순위: Dry-Run > Audit > Backup > Webhook > Metrics > ACL > Anomaly |
| 2 | DB 마이그레이션 2개 테이블 추가 | 기존 DB 호환성 | v1.4부터 적용된 증분 마이그레이션 전략(MIG-01~06) 준수 |
| 3 | Metrics 수집 성능 부하 | 파이프라인 처리 시간 증가 | 메트릭 수집은 비동기. Counter/Gauge는 인메모리 증감만으로 오버헤드 미미 |

---

## 예상 규모

| 항목 | 예상 |
|------|------|
| 페이즈 | 5-7개 (기능별 1-2 페이즈) |
| 신규/수정 파일 | 30-45개 |
| 테스트 | 24-36개 (T-01~T-18 + S-01~S-06 + 추가) |
| DB 마이그레이션 | 2개 테이블 추가 + 인덱스 1개 |

---

*생성일: 2026-02-15*
*선행: v2.1 (운영 기능 확장 설계)*
*관련: 설계 문서 OPS-01~OPS-07*
