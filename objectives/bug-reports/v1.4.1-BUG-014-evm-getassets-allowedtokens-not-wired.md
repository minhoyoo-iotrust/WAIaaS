# BUG-014: EVM getAssets()가 ERC-20 토큰 잔액을 반환하지 않음 — ALLOWED_TOKENS 정책 미연동

## 심각도

**MEDIUM** — EVM 지갑의 `getAssets()`가 항상 네이티브 ETH만 반환. ALLOWED_TOKENS 정책에 토큰을 등록해도 잔액 조회에 반영되지 않음. MCP `get_assets`와 REST API `GET /v1/wallet/assets` 모두 영향.

## 증상

Etherscan에서 25 LINK 보유가 확인되는 지갑에 대해:

```
GET /v1/wallet/assets → { assets: [{ mint: 'native', symbol: 'ETH', balance: '50000000000000000', isNative: true }] }
```

ERC-20 토큰(LINK)이 응답에 포함되지 않음. Claude Desktop에서도 "기타 토큰: 없음 (네이티브 ETH만 보유 중)"으로 표시.

## 원인

### EvmAdapter에 ERC-20 조회 로직은 구현되어 있으나 데몬이 토큰 목록을 전달하지 않음

**EvmAdapter** (`packages/adapters/evm/src/adapter.ts`):

```typescript
// 96-99행: 토큰 목록 주입 setter — 데몬에서 호출하는 곳 없음
setAllowedTokens(tokens: Array<{ address: string; symbol?: string; name?: string; decimals?: number }>): void {
  this._allowedTokens = tokens;
}

// 160-179행: getAssets()
async getAssets(addr: string): Promise<AssetInfo[]> {
  // 1. 네이티브 ETH 잔액 (항상)
  // 2. _allowedTokens.length > 0 일 때만 ERC-20 multicall
  if (this._allowedTokens.length > 0) {  // ← 항상 0이므로 이 블록 진입 불가
    // multicall balanceOf ...
  }
}
```

**데몬** (`packages/daemon/src/`):
- `setAllowedTokens()` 호출 코드 없음 (grep 결과 0건)
- 어댑터 초기화 시 토큰 목록 전달 없이 `connect(rpcUrl)`만 호출

### ALLOWED_TOKENS 정책은 정책 엔진 전용

`ALLOWED_TOKENS` 정책 (`policies` 테이블)은 파이프라인 Stage 3 정책 평가에서 **전송 허용 여부 판단**에만 사용됨:

```
ALLOWED_TOKENS 정책 → DatabasePolicyEngine.evaluateAllowedTokens() → 전송 허용/거부 판단
                    ↛ EvmAdapter.setAllowedTokens() (연동 없음)
```

정책에 토큰을 등록해도 잔액 조회에는 반영되지 않는 단절 상태.

### Solana와의 비대칭

| 항목 | Solana | EVM |
|------|--------|-----|
| 토큰 자동 발견 | `getTokenAccountsByOwner` RPC | 불가능 (EVM 구조적 한계) |
| 정책 없이 잔액 조회 | 모든 SPL 토큰 자동 표시 | 네이티브 ETH만 표시 |
| 추가 설정 필요 | 없음 | 토큰 컨트랙트 주소 목록 필요 |

## 수정안

### 방안 A: ALLOWED_TOKENS 정책 연동 (권장)

데몬이 `getAssets()` 호출 전 해당 지갑의 ALLOWED_TOKENS 정책에서 토큰 목록을 읽어 `setAllowedTokens()`로 전달.

```typescript
// packages/daemon/src/api/routes/wallet.ts — getAssets 엔드포인트 내
if (wallet.chain === 'ethereum') {
  const policies = await db.select().from(policiesTable)
    .where(and(
      eq(policiesTable.walletId, wallet.id),
      eq(policiesTable.type, 'ALLOWED_TOKENS'),
      eq(policiesTable.enabled, true),
    ));

  if (policies.length > 0) {
    const rules = JSON.parse(policies[0].rules);
    adapter.setAllowedTokens(rules.tokens);
  }
}

const assets = await adapter.getAssets(wallet.publicKey);
```

**장점**: 기존 ALLOWED_TOKENS 정책을 SSoT로 활용, 추가 스키마 불필요
**단점**: 잔액 조회가 정책 설정에 의존 — 정책 미설정 시 여전히 네이티브만 표시

### 방안 B: 별도 토큰 목록 설정

ALLOWED_TOKENS 정책과 독립적으로, 지갑별 "관심 토큰 목록"을 DB에 저장. `getAssets()`는 이 목록에서 토큰 주소를 가져옴.

**장점**: 정책(보안)과 조회(UX)를 분리
**단점**: 추가 테이블/스키마 필요, 관리 포인트 증가

### 방안 C: 인덱서 API 사용 (장기)

Alchemy `alchemy_getTokenBalances` 등 프로바이더별 확장 API로 모든 ERC-20 자동 발견.

**장점**: 정책/설정 없이 Solana처럼 자동 발견
**단점**: 특정 RPC 프로바이더 의존, Self-Hosted 원칙과 상충

### 권장: 방안 A 우선 적용 + 방안 C 장기 로드맵

방안 A는 기존 코드만으로 구현 가능하며, ALLOWED_TOKENS에 등록된 토큰 = 전송 가능한 토큰 = 잔액 조회 대상이라는 논리적 일관성도 있음. 정책 미설정 시 네이티브만 표시되는 것은 "기본 거부" 원칙과 일치.

## 영향 범위

| 항목 | 내용 |
|------|------|
| 수정 파일 | `packages/daemon/src/api/routes/wallet.ts` (getAssets 엔드포인트) |
| API 영향 | `GET /v1/wallet/assets` — ERC-20 토큰 잔액 포함 |
| MCP 영향 | `get_assets` 도구 — ERC-20 토큰 잔액 포함 |
| Solana | **영향 없음** — SPL 토큰 자동 발견은 정상 동작 |
| 전제 조건 | ALLOWED_TOKENS 정책에 토큰 등록 필요 |

## 기존 테스트가 감지하지 못한 이유

- EVM adapter 단위 테스트에서 `setAllowedTokens()` 호출 후 `getAssets()` 검증은 존재
- 그러나 데몬 통합 테스트에서 EVM 지갑의 `GET /v1/wallet/assets`가 ERC-20을 반환하는지 검증하는 E2E 없음
- Solana는 자동 발견이므로 별도 설정 없이 테스트 통과

## 재발 방지 테스트

```typescript
it('EVM getAssets가 ALLOWED_TOKENS 정책의 토큰 잔액을 반환한다', async () => {
  // 1. EVM 지갑 생성
  // 2. ALLOWED_TOKENS 정책 추가 (LINK 토큰 주소)
  // 3. GET /v1/wallet/assets 호출
  // 4. 응답에 LINK 토큰 잔액 포함 확인
});

it('ALLOWED_TOKENS 정책 미설정 시 네이티브 ETH만 반환한다', async () => {
  // 1. EVM 지갑 생성 (정책 없음)
  // 2. GET /v1/wallet/assets 호출
  // 3. 응답에 네이티브 ETH만 포함 확인
});
```

---

*발견일: 2026-02-13*
*마일스톤: v1.4.1*
*상태: OPEN*
*관련: BUG-012 (MCP get_assets 도구 누락 — 수정 완료), 설계 문서 56(spl-erc20), 57(token-policy)*
