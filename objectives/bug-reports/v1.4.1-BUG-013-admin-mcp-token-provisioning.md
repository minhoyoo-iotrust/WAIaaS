# BUG-013: Admin UI에서 MCP 토큰 발급 불가 — CLI 의존

## 심각도

**LOW** — 기능 결함이 아닌 DX 개선 사항. `waiaas mcp setup` CLI로 우회 가능하나, Admin UI에서 지갑 관리를 모두 처리할 수 있을 것이라는 사용자 기대와 불일치.

## 증상

Admin UI에서 지갑 생성 후 MCP 연동을 위해 별도로 터미널에서 `waiaas mcp setup`을 실행해야 함. Admin UI에서 세션을 생성해도 MCP 토큰 파일(`mcp-tokens/<walletId>`)이 저장되지 않아 Claude Desktop에서 해당 지갑을 사용할 수 없음.

## 현재 흐름

```
1. Admin UI → 지갑 생성 (POST /v1/wallets)              ✅
2. Admin UI → 세션 생성 (POST /v1/sessions)              ✅ (JWT 반환)
3. JWT → mcp-tokens/<walletId> 파일 저장                  ❌ (수동 불가)
4. Claude Desktop 설정에 MCP 서버 추가                     ❌ (수동 JSON 편집)
5. Claude Desktop 재시작                                   ❌ (수동)
```

3~4번이 Admin UI에서 불가능하여 CLI(`waiaas mcp setup`)에 의존.

## 기대 흐름

```
1. Admin UI → 지갑 생성
2. Admin UI → "MCP 토큰 발급" 버튼 클릭
3. 데몬이 세션 생성 + mcp-tokens/<walletId> 파일 저장
4. Admin UI가 Claude Desktop 설정 JSON 스니펫 표시 (복사 가능)
5. 사용자가 Claude Desktop 설정에 붙여넣기 + 재시작
```

## 수정안

### 1. 데몬 API 엔드포인트 추가

`POST /v1/mcp/tokens` (masterAuth)

```typescript
// 요청
{ "walletId": "019c5252-b5b0-790e-b3a6-c16fc6a7ea57" }

// 응답
{
  "walletId": "019c5252-b5b0-790e-b3a6-c16fc6a7ea57",
  "walletName": "ethereum-01",
  "tokenPath": "/Users/minho.yoo/.waiaas/mcp-tokens/019c5252-b5b0-790e-b3a6-c16fc6a7ea57",
  "expiresAt": 1739500800,
  "claudeDesktopConfig": {
    "waiaas-ethereum-01": {
      "command": "node",
      "args": ["/path/to/packages/mcp/dist/index.js"],
      "env": {
        "WAIAAS_DATA_DIR": "/Users/minho.yoo/.waiaas",
        "WAIAAS_BASE_URL": "http://127.0.0.1:3100",
        "WAIAAS_WALLET_ID": "019c5252-b5b0-790e-b3a6-c16fc6a7ea57",
        "WAIAAS_WALLET_NAME": "ethereum-01"
      }
    }
  }
}
```

내부 동작:
1. 해당 지갑의 세션 생성 (POST /v1/sessions와 동일 로직)
2. JWT를 `DATA_DIR/mcp-tokens/<walletId>` 파일에 저장
3. Claude Desktop 설정 스니펫 생성하여 반환

### 2. Admin UI에 MCP 토큰 관리 추가

지갑 상세 페이지에 "MCP Setup" 섹션 추가:
- "MCP 토큰 발급" 버튼 → `POST /v1/mcp/tokens` 호출
- 발급 결과로 Claude Desktop 설정 JSON 표시 (복사 버튼 포함)
- 기존 토큰 만료 시간 표시
- 토큰 갱신 버튼

### 3. 기존 `waiaas mcp setup` CLI와의 관계

CLI 명령은 그대로 유지. 내부적으로 동일한 `POST /v1/mcp/tokens` 엔드포인트를 호출하도록 리팩터링하면 로직 중복 제거 가능.

## 영향 범위

| 항목 | 내용 |
|------|------|
| 신규 파일 | `packages/daemon/src/api/routes/mcp.ts` |
| 수정 파일 | `packages/daemon/src/api/index.ts` (라우트 등록), `packages/admin/src/pages/wallets.tsx` (MCP 섹션) |
| API | `POST /v1/mcp/tokens` 1개 추가 |
| 기능 영향 | Admin UI에서 MCP 토큰 발급 + Claude Desktop 설정 제공 |
| 우회 방법 | `waiaas mcp setup` CLI 사용 |

## 참고

- `waiaas mcp setup` CLI: `packages/cli/src/commands/mcp-setup.ts`
- MCP SessionManager 토큰 파일 읽기: `packages/mcp/src/session-manager.ts`
- 토큰 파일 경로: `DATA_DIR/mcp-tokens/<walletId>`

---

*발견일: 2026-02-13*
*마일스톤: v1.4.1*
*상태: OPEN*
*관련: BUG-012 (MCP 도구 누락 — 동일 DX 갭 패턴)*
