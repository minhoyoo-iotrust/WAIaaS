# 마일스톤 v1.8.1: 업그레이드 + 배포 인프라 구현

## 목표

v1.8에서 설계한 업그레이드/배포 인프라가 모두 구현되어, 사용자가 새 버전 알림을 받고 `waiaas upgrade`로 안전하게 업그레이드할 수 있는 상태. npm/Docker/Desktop 3개 채널 모두 업그레이드 경로가 동작하며, DB 마이그레이션과 호환성 검증이 자동으로 실행된다.

---

## 구현 대상 설계 문서

| 문서 | 이름 | 구현 범위 | 전체/부분 |
|------|------|----------|----------|
| 66 | upgrade-distribution-spec | VersionCheckService, CLI 알림, `waiaas upgrade` 명령, Health 확장, Docker 업그레이드 경로, Tauri Auto Updater 연동, 호환성 매트릭스, CHANGELOG 자동 생성 | 전체 |
| 28 | daemon-lifecycle-cli | DaemonLifecycle Step 6에 VersionCheckWorker 등록 | 부분 (버전 체크 워커 추가만) |
| 54 | cli-flow-redesign | CLI에 `upgrade` 서브커맨드 + `--quiet` 글로벌 플래그 추가 | 부분 (명령 추가만) |

### v1.4~v1.8에서 이미 구현/설계된 부분 (v1.8.1에서 활용)

- DB 마이그레이션 인프라 MIG-01~06 (v1.4에서 구현)
- `schema_version` 테이블 + 증분 마이그레이션 (v1.4에서 구현)
- `key_value_store` 테이블 (v1.2에서 구현)
- `BackgroundWorkers` 레지스트리 (v1.1에서 구현)
- Tauri Desktop 앱 + Sidecar Manager (v1.6에서 구현)
- Docker Multi-stage Dockerfile + docker-compose (v1.6에서 구현)
- release-please + GitHub Actions release.yml (v1.7에서 구현)
- 설계 문서 66 (v1.8에서 작성)

---

## 산출물

### 컴포넌트

| 컴포넌트 | 위치 | 내용 |
|----------|------|------|
| VersionCheckService | `packages/daemon/src/infrastructure/version/` | npm registry 조회, semver 비교, key_value_store 저장, 5초 타임아웃 fail-soft |
| VersionCheckWorker | `packages/daemon/src/lifecycle/daemon.ts` | BackgroundWorkers에 24시간 주기 워커 등록 |
| CLI 알림 모듈 | `packages/cli/src/utils/update-notify.ts` | stderr 박스 출력, 24시간 중복 방지, `--quiet` / `WAIAAS_NO_UPDATE_NOTIFY` 억제 |
| upgrade 명령 | `packages/cli/src/commands/upgrade.ts` | 7단계 시퀀스 (확인→중지→백업→업데이트→마이그레이션→검증→재시작), `--check` / `--to` / `--rollback` / `--no-start` |
| 백업 서비스 | `packages/daemon/src/infrastructure/backup/` | DB + config.toml 파일 복사, `~/.waiaas/backups/pre-upgrade-{version}-{timestamp}/` |
| 호환성 매트릭스 | `packages/daemon/src/infrastructure/database/compatibility.ts` | 코드 버전 ↔ DB 스키마 버전 매핑, 시작 시 검증, 에러 메시지 |
| Health 확장 | `packages/daemon/src/api/routes/health.ts` | `latestVersion`, `updateAvailable`, `schemaVersion` 필드 추가 |
| Docker 라벨 | `Dockerfile` | Watchtower 호환 라벨, 3-tier 태깅 (latest/semver/major) |
| Tauri Updater 설정 | `packages/desktop/src-tauri/tauri.conf.json` | GitHub Releases 엔드포인트, Ed25519 서명 공개 키 |
| CHANGELOG 설정 | `.release-please-manifest.json`, `release-please-config.json` | Conventional Commits → 자동 버전 범프 + CHANGELOG 생성 |

### config.toml 확장

```toml
[daemon]
update_check = true           # 버전 체크 활성화 (기본: true)
update_check_interval = 86400 # 체크 주기 초 (기본: 86400 = 24시간)
```

### CLI 명령 추가

| 명령 | 설명 |
|------|------|
| `waiaas upgrade` | 최신 버전으로 업그레이드 (7단계 시퀀스) |
| `waiaas upgrade --check` | 업그레이드 가능 여부만 확인 (실행 없음) |
| `waiaas upgrade --to <version>` | 특정 버전으로 업그레이드 |
| `waiaas upgrade --rollback` | 직전 백업에서 DB + config 복원 |
| `waiaas upgrade --no-start` | 업그레이드 후 데몬 재시작 생략 |

### Health 응답 확장

```json
{
  "status": "ok",
  "version": "2.0.0",
  "latestVersion": "2.1.0",
  "updateAvailable": true,
  "schemaVersion": 5,
  "uptime": 86400,
  "timestamp": 1770000000
}
```

### Docker 태깅 전략

| 태그 | 용도 | 예시 |
|------|------|------|
| `latest` | 최신 안정 릴리스 (편의용) | `waiaas/daemon:latest` |
| semver | 고정 버전 배포 (운영 권장) | `waiaas/daemon:2.1.0` |
| major | major 내 최신 (자동 업데이트용) | `waiaas/daemon:2` |

---

## 기술 결정 사항

> v1.8에서 확정된 8개 기술 결정을 그대로 적용한다. 구현 시 추가 결정만 기록.

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 9 | npm registry HTTP 클라이언트 | Node.js native `fetch` | 외부 의존성 없음. Node.js 22 내장 fetch로 충분. 타임아웃은 `AbortSignal.timeout(5000)` |
| 10 | semver 비교 라이브러리 | `semver` npm 패키지 | 사실상 표준. 0 의존성, 작은 번들. compare/gt/satisfies 함수 필요 |
| 11 | 백업 파일 보존 기간 | 최근 5개 | `~/.waiaas/backups/` 내 5개 초과 시 오래된 순서로 자동 삭제. 디스크 부족 방지 |
| 12 | upgrade 명령의 npm 호출 방식 | `child_process.execSync` | 동기 실행으로 완료 대기. 에러 시 즉시 중단 + 롤백 안내 |
| 13 | release-please 설정 범위 | 모노레포 단일 버전 | 7개 패키지 동일 버전으로 릴리스. 독립 버전 관리는 복잡도 과다 |

---

## E2E 검증 시나리오

**자동화 비율: 100% -- `[HUMAN]` 0건**

> v1.8에서 정의한 20건 기준을 구체화하고 검증 방법을 명시한다.

### 버전 체크 + 알림 (6건)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | 데몬 시작 시 npm registry 조회 → latest_version 저장 | msw mock HTTP → key_value_store에 `latest_version` 키 존재 + 값 assert | [L0] |
| 2 | registry 조회 실패 → 데몬 정상 시작 (fail-soft) | msw mock 503 → 데몬 시작 성공 + `latest_version` 키 미생성 + 경고 로그 포함 assert | [L0] |
| 3 | `update_check = false` → 조회 안 함 | config 설정 후 시작 → msw 요청 카운트 0건 assert | [L0] |
| 4 | CLI 실행 시 새 버전 → stderr 알림 출력 | key_value_store에 latest_version > current 삽입 → CLI 실행 → stderr에 "Update available" 포함 assert | [L0] |
| 5 | 24시간 내 재실행 → 알림 중복 없음 | `version_notified_at` = now 설정 → CLI 재실행 → stderr에 "Update available" 미포함 assert | [L0] |
| 6 | `--quiet` 또는 환경변수 → 알림 억제 | `WAIAAS_NO_UPDATE_NOTIFY=1` 설정 → CLI 실행 → stderr 미포함 assert | [L0] |

### CLI 업그레이드 (5건)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 7 | `upgrade --check` → 버전 정보 출력 | msw mock registry → stdout에 current + latest 버전 + "Upgrade available" 포함 assert | [L0] |
| 8 | `upgrade` → 7단계 시퀀스 전체 실행 | npm 호출 mock + DB mock → 각 단계 호출 순서 검증 (stop→backup→npm→migrate→verify→start) assert | [L0] |
| 9 | 백업 디렉토리에 DB + config.toml 존재 | tmpdir에서 upgrade 실행 → `backups/pre-upgrade-*` 내 `waiaas.db` + `config.toml` 존재 assert | [L0] |
| 10 | `upgrade --rollback` → 백업에서 복원 | 백업 생성 후 DB 변경 → rollback → DB 내용 = 백업 시점과 동일 assert | [L0] |
| 11 | 이미 최신 → "Already up to date" | current == latest mock → stdout에 "Already up to date" + npm 미호출 assert | [L0] |

### Health + 호환성 (5건)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 12 | `GET /health` → version + latestVersion + updateAvailable + schemaVersion 필드 포함 | createApp + request('/health') → JSON 스키마 4필드 존재 assert | [L0] |
| 13 | 코드 > DB 스키마 → 자동 마이그레이션 후 정상 시작 | 구버전 스키마 DB 생성 → 신버전 코드 시작 → schema_version 테이블 업데이트 + 데몬 시작 성공 assert | [L0] |
| 14 | 코드 < DB 스키마 → 시작 거부 + 에러 메시지 | 신버전 스키마 DB + 구버전 호환성 매트릭스 → 시작 실패 + "upgrade your WAIaaS" 메시지 assert | [L0] |
| 15 | 호환 범위 밖 → 시작 거부 + 필요 버전 안내 | minSchema 미달 DB → 시작 실패 + 필요 버전 메시지 포함 assert | [L0] |
| 16 | 버전 체크 미실행 시 latestVersion = null | 데몬 시작 직후(체크 전) health 조회 → latestVersion: null + updateAvailable: false assert | [L0] |

### Docker (2건)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 17 | Docker 이미지 교체 → named volume 보존 + 자동 마이그레이션 | v1 이미지 → v2 이미지 compose up → 기존 에이전트 테이블 데이터 보존 + schema_version 업데이트 assert | [L1] |
| 18 | Watchtower 라벨 존재 | `docker inspect` → Labels에 `com.centurylinklabs.watchtower.enable=true` 포함 assert | [L0] |

### Desktop 자동 업데이트 (2건)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 19 | Tauri Updater → GitHub Release latest.json 조회 → 업데이트 감지 | mock latest.json 서버 → Tauri Updater 이벤트 `UPDATE_AVAILABLE` 발생 assert | [L0] |
| 20 | 업데이트 다운로드 → 서명 검증 → 설치 → Sidecar 교체 완료 | mock 서명 + 바이너리 → `DOWNLOAD_FINISHED` + `INSTALLED` 이벤트 순서 assert | [L1] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.8 (업그레이드 설계) | 설계 문서 66이 v1.8에서 작성됨. v1.8.1은 이 설계를 구현 |
| v1.4 (DB 마이그레이션) | MIG-01~06 인프라, `schema_version` 테이블, 증분 마이그레이션이 v1.4에서 구축됨 |
| v1.6 (Desktop + Docker) | Tauri 앱, Docker Dockerfile이 v1.6에서 구현됨. v1.8.1에서 Updater 설정 + 라벨 추가 |
| v1.7 (CI/CD) | release-please, release.yml이 v1.7에서 구축됨. v1.8.1에서 CHANGELOG 자동 생성 연동 |

---

## 리스크

> v1.8에서 정의한 6개 리스크를 그대로 적용. 구현 시 추가 리스크만 기록.

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 에어갭/방화벽 환경 npm registry 접근 불가 | 버전 체크 불가 | fail-soft + `update_check = false` + 수동 tgz 가이드 |
| 2 | npm i -g 권한 문제 | 업그레이드 실패 | 에러 메시지에 nvm/fnm 안내 |
| 3 | 마이그레이션 실패 시 데이터 손실 | DB 불일치 | 자동 백업 필수 + 트랜잭션 실행(MIG-03) + `--rollback` |
| 4 | semver 호환성 매트릭스 관리 복잡도 | 테스트 부담 | 최근 3 minor만 유지 |
| 5 | Tauri 서명 키 분실 | Desktop 업데이트 불가 | CI Secrets + 오프라인 백업 |
| 6 | Docker latest breaking change | Watchtower 호환성 문제 | major 태그 권장 |
| 7 | `waiaas upgrade` 중간 실패 (npm 실패, 마이그레이션 실패) | 데몬 중지 상태로 방치 | 각 단계 실패 시 명확한 에러 + 롤백 안내. 백업은 npm 호출 전에 완료되므로 `--rollback`으로 복원 가능 |
| 8 | 모노레포 단일 버전 전략의 한계 | 패키지 하나만 변경해도 전체 버전 범프 | Self-Hosted 특성상 7패키지가 한 세트로 배포되므로 단일 버전이 적절. 불필요한 범프는 CHANGELOG에서 "No changes" 표시 |

---

*최종 업데이트: 2026-02-10 — 초안 작성 (v1.8 설계 기반 구현 마일스톤)*
