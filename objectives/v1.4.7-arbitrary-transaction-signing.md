# 마일스톤 v1.4.7: 임의 트랜잭션 서명 API

## 목표

외부 dApp/프로토콜이 빌드한 unsigned 트랜잭션을 WAIaaS가 서명하여 반환하는 API를 제공한다. 기존 정책 엔진(CONTRACT_WHITELIST, SPENDING_LIMIT 등)이 서명 대상 트랜잭션의 내용을 검증한 후에만 서명이 수행된다. Solana와 EVM 모두 지원한다.

---

## 배경

### 현재 WAIaaS 트랜잭션 모델의 한계

WAIaaS는 트랜잭션의 전체 생명주기를 내부에서 관리한다:

```
요청 접수 → 정책 평가 → 트랜잭션 빌드 → 시뮬레이션 → 서명 → 제출 → 확인
(Stage 1)    (Stage 3)    (Stage 4)      (Stage 4)   (Stage 5) (Stage 5) (Stage 6)
```

이 모델은 WAIaaS가 **트랜잭션을 직접 빌드**하는 경우에만 동작한다. 그러나 외부 dApp과 상호작용할 때는 dApp이 트랜잭션을 빌드하고, 에이전트는 **서명만** 제공해야 하는 경우가 있다.

### 2-Step 트랜잭션 패턴

많은 dApp/프로토콜이 다음 패턴을 사용한다:

```
Step 1: dApp Backend → unsigned tx 반환 (base64/hex)
Step 2: 클라이언트가 서명 → dApp Backend에 signed tx 제출
```

예시:
- **Agentra (MoltHub)**: Solana Anchor 프로그램 기반, 19개 instruction. Backend가 unsigned tx를 빌드하고 에이전트가 서명 후 제출
- **Jupiter Swap**: /swap-instructions API가 instruction 목록 반환 → 클라이언트가 트랜잭션 조립 + 서명
- **NFT 마켓플레이스**: 리스팅/구매 트랜잭션을 마켓이 빌드
- **DAO 거버넌스**: 투표/제안 트랜잭션을 프론트엔드가 빌드

### WAIaaS의 현재 Gap

| 기능 | 지원 여부 | 설명 |
|------|-----------|------|
| 네이티브 전송 (SOL/ETH) | ✅ | `POST /v1/transactions/send` |
| 토큰 전송 (SPL/ERC-20) | ✅ | `POST /v1/transactions/send` (type: TOKEN_TRANSFER) |
| 컨트랙트 호출 | ✅ | `POST /v1/transactions/send` (type: CONTRACT_CALL) |
| Approve | ✅ | `POST /v1/transactions/send` (type: APPROVE) |
| 배치 | ✅ | `POST /v1/transactions/send` (type: BATCH) |
| **임의 트랜잭션 서명** | ❌ | 외부에서 빌드한 unsigned tx에 서명하는 API 없음 |

이 Gap으로 인해 Agentra 등 2-Step 패턴을 사용하는 dApp과의 상호작용이 불가능하다.

### Agentra 호환성 분석 결과

`how-to-test/agentra-test-240213/` 분석 결과:

| 체인 | 패턴 | WAIaaS 지원 | 비고 |
|------|------|-------------|------|
| EVM | Approve + Execute | ✅ | 기존 APPROVE + CONTRACT_CALL로 가능 |
| Solana | 2-Step (unsigned tx → sign → submit) | ❌ | 임의 서명 API 필요 |

EVM은 Approve 후 직접 CONTRACT_CALL이 가능하지만, Solana는 Anchor 프로그램의 복합 instruction이 포함된 unsigned tx를 그대로 서명해야 한다. 임의 서명 API가 추가되면 **양 체인 모두에서 모든 dApp 상호작용이 가능**해진다.

---

## 구현 대상

기존 설계 문서 없음. 이 마일스톤에서 sign-only 트랜잭션 경로를 신규 설계 + 구현한다.

### 핵심 원칙

| 원칙 | 설명 |
|------|------|
| **서명만, 제출 안 함** | WAIaaS는 서명된 트랜잭션을 반환할 뿐, 체인에 제출하지 않는다. 제출은 호출자의 책임 |
| **정책 평가 필수** | unsigned tx의 내용(수신자, 금액, 프로그램/컨트랙트)을 파싱하여 기존 정책 엔진으로 평가한 후에만 서명 |
| **기존 보안 모델 유지** | sessionAuth 인증, SPENDING_LIMIT, CONTRACT_WHITELIST, rate limiter, kill switch 모두 적용 |
| **감사 로그 기록** | 서명 요청과 결과를 transactions 테이블에 기록 (type: SIGN) |

---

## 산출물

### 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| IChainAdapter 확장 | `parseTransaction(rawTx)`: unsigned tx를 파싱하여 수신자, 금액, 프로그램/컨트랙트 정보 추출. `signExternalTransaction(rawTx)`: unsigned tx에 월렛 키로 서명하여 signed tx 반환 |
| SolanaAdapter | `parseTransaction()`: base64 → deserialize → instruction 목록에서 programId, accounts, 전송 금액 추출. `signExternalTransaction()`: VersionedTransaction/Transaction에 partialSign 수행 → base64 반환 |
| EvmAdapter | `parseTransaction()`: hex/RLP → to, value, data 추출 → 4byte selector로 메서드 식별. `signExternalTransaction()`: signTransaction으로 서명 → hex 반환 |
| 트랜잭션 파싱기 | unsigned tx 내용에서 정책 평가에 필요한 정보를 추출하는 체인별 파서. Solana: instruction 목록에서 SystemProgram.transfer, SPL Token transfer, 임의 program 호출을 식별. EVM: to/value/data에서 ETH 전송, ERC-20 transfer, 임의 컨트랙트 호출을 식별 |
| Sign-only 파이프라인 경로 | 기존 6-stage 파이프라인의 sign-only 변형: Stage 1(접수) → Stage 3(정책 평가) → 서명 → 반환. Stage 4(빌드/시뮬레이션)와 Stage 5-6(제출/확인)을 건너뜀 |
| REST API | `POST /v1/transactions/sign` — sessionAuth 보호. unsigned tx를 받아 정책 평가 후 서명하여 반환 |
| SDK (TS) | `WAIaaSClient.signTransaction(params)` 메서드 |
| SDK (Python) | `WAIaaSClient.sign_transaction(params)` 메서드 |
| MCP 도구 | `sign_transaction` 도구 |
| 감사 로그 | transactions 테이블에 type='SIGN' 기록. 제출하지 않으므로 status는 SIGNED (신규 상태) |
| 정책 거부 알림 보강 | POLICY_VIOLATION 알림에 `contractAddress`, `policyType`, Admin UI 딥링크를 포함하여 관리자가 즉시 대응 가능. 예: "에이전트가 0xABC... 컨트랙트를 호출하려 했으나 CONTRACT_NOT_WHITELISTED로 거부됨. Admin에서 확인: /admin/policies" |
| 기본 거부 정책 토글 | Admin UI/API에서 3가지 기본 거부 정책(ALLOWED_TOKENS, CONTRACT_WHITELIST, APPROVED_SPENDERS)의 기본 거부 동작을 개별적으로 끄고 켤 수 있는 설정. OFF 시 해당 화이트리스트 미설정 상태에서도 트랜잭션을 허용하며, SPENDING_LIMIT 등 다른 정책은 그대로 적용 |

### 기본 거부 정책 토글

현재 3가지 정책은 미설정 시 무조건 거부한다 (기본 거부):

| 정책 | 대상 | 미설정 시 현재 동작 |
|------|------|-------------------|
| ALLOWED_TOKENS | TOKEN_TRANSFER | 모든 토큰 전송 거부 |
| CONTRACT_WHITELIST | CONTRACT_CALL | 모든 컨트랙트 호출 거부 |
| APPROVED_SPENDERS | APPROVE | 모든 토큰 승인 거부 |

이 동작을 Admin UI에서 개별 토글로 제어할 수 있도록 한다.

#### 설정 키

| 키 | 기본값 | 설명 |
|----|--------|------|
| `default_deny_tokens` | `true` | OFF 시: ALLOWED_TOKENS 미설정 상태에서 모든 토큰 전송 허용 |
| `default_deny_contracts` | `true` | OFF 시: CONTRACT_WHITELIST 미설정 상태에서 모든 컨트랙트 호출 허용 |
| `default_deny_spenders` | `true` | OFF 시: APPROVED_SPENDERS 미설정 상태에서 모든 토큰 승인 허용 |

#### 정책 엔진 변경

`DatabasePolicyEngine`의 3개 평가 메서드에 설정 확인 분기를 추가:

```typescript
// 변경 전 (현재)
if (!contractWhitelistPolicy) {
  return { allowed: false, reason: 'Contract calls disabled: no CONTRACT_WHITELIST...' };
}

// 변경 후
if (!contractWhitelistPolicy) {
  if (this.settings.get('default_deny_contracts') === false) {
    return null; // 기본 허용 → 다음 정책 평가로 계속 (SPENDING_LIMIT 등)
  }
  return { allowed: false, reason: 'Contract calls disabled: no CONTRACT_WHITELIST...' };
}
```

화이트리스트 정책이 **설정되어 있으면** 토글과 무관하게 정상 동작한다. 토글은 **정책 미설정 시의 기본 동작만** 변경한다.

#### Admin UI

```
Admin UI > Settings > 보안

┌─ 기본 거부 정책 ────────────────────────────────────┐
│                                                     │
│  토큰 전송 제한 (ALLOWED_TOKENS)        [ON] / OFF  │
│  → ON: ALLOWED_TOKENS 미설정 시 모든 토큰 전송 거부    │
│  → OFF: 모든 토큰 전송 허용 (SPENDING_LIMIT 적용)     │
│                                                     │
│  컨트랙트 호출 제한 (CONTRACT_WHITELIST)  [ON] / OFF  │
│  → ON: CONTRACT_WHITELIST 미설정 시 모든 호출 거부     │
│  → OFF: 모든 컨트랙트 호출 허용                       │
│                                                     │
│  토큰 승인 제한 (APPROVED_SPENDERS)      [ON] / OFF  │
│  → ON: APPROVED_SPENDERS 미설정 시 모든 승인 거부      │
│  → OFF: 모든 토큰 승인 허용                           │
│                                                     │
│  ⚠ OFF로 전환하면 해당 유형의 트랜잭션이 화이트리스트    │
│    검증 없이 실행됩니다. SPENDING_LIMIT 등 다른 정책은   │
│    그대로 적용됩니다.                                  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### 저장 위치

| 방식 | 설명 |
|------|------|
| v1.4.4 이전 | `config.toml` `[security]` 섹션에 3개 키 추가 |
| v1.4.4 이후 | DB `settings` 테이블 (Admin UI hot-reload) |

v1.4.7 구현 시점에 v1.4.4 완료 여부에 따라 저장 위치를 결정한다. 정책 엔진은 어느 쪽이든 동일한 인터페이스로 설정값을 읽는다.

#### REST API

기존 `GET/PUT /v1/admin/settings`에 포함 (v1.4.4에서 추가되는 API). v1.4.4 미완료 시 `GET /v1/admin/status` 응답에 현재 설정값을 포함하고, `config.toml`로 제어한다.

### IChainAdapter 확장

```typescript
interface IChainAdapter {
  // 기존 20개 메서드 유지

  // 신규 (v1.4.7)
  parseTransaction(rawTx: string): Promise<ParsedTransaction>;
  signExternalTransaction(rawTx: string, walletId: string): Promise<SignedTransaction>;
}

interface ParsedTransaction {
  /** 트랜잭션에 포함된 작업 목록 */
  operations: ParsedOperation[];
  /** 원본 rawTx (검증용) */
  rawTx: string;
}

interface ParsedOperation {
  type: 'NATIVE_TRANSFER' | 'TOKEN_TRANSFER' | 'CONTRACT_CALL' | 'APPROVE' | 'UNKNOWN';
  to?: string;
  amount?: bigint;
  /** TOKEN_TRANSFER/APPROVE 시 토큰 mint/contract 주소 */
  token?: string;
  /** CONTRACT_CALL 시 프로그램/컨트랙트 주소 */
  programId?: string;
  /** CONTRACT_CALL 시 메서드 selector (EVM 4bytes) 또는 discriminator (Solana 8bytes) */
  method?: string;
}

interface SignedTransaction {
  /** 서명된 트랜잭션 (base64 for Solana, hex for EVM) */
  signedTransaction: string;
  /** 트랜잭션 해시 (사전 계산 가능한 경우) */
  txHash?: string;
}
```

### 정책 평가 흐름

unsigned tx의 파싱 결과를 기존 정책 엔진에 매핑한다:

```
1. parseTransaction(rawTx) → ParsedTransaction { operations[] }
2. 각 operation을 기존 정책으로 평가:
   - NATIVE_TRANSFER → SPENDING_LIMIT (금액 기준)
   - TOKEN_TRANSFER → ALLOWED_TOKENS + SPENDING_LIMIT
   - CONTRACT_CALL → CONTRACT_WHITELIST + METHOD_WHITELIST
   - APPROVE → APPROVED_SPENDERS + SPENDING_LIMIT
   - UNKNOWN → 기본 거부 (CONTRACT_WHITELIST에 없으면)
3. 모든 operation이 통과해야 서명 수행
4. 하나라도 거부되면 어떤 정책이 거부했는지 에러에 포함
```

복합 트랜잭션(Solana: 여러 instruction, EVM: multicall)은 모든 operation을 개별 평가하고, **가장 엄격한 티어**를 적용한다.

### 파일/모듈 구조

```
packages/core/src/
  interfaces/
    chain-adapter.types.ts       # ParsedTransaction, ParsedOperation, SignedTransaction 추가
  enums.ts                       # TransactionStatus에 SIGNED 추가

packages/daemon/src/
  pipeline/
    sign-only.ts                 # sign-only 파이프라인 (접수 → 파싱 → 정책 → 서명 → 반환)
  routes/
    transactions.ts              # POST /v1/transactions/sign 엔드포인트 추가

packages/adapters/solana/src/
  adapter.ts                     # parseTransaction(), signExternalTransaction() 구현
  tx-parser.ts                   # Solana 트랜잭션 파싱 유틸리티

packages/adapters/evm/src/
  adapter.ts                     # parseTransaction(), signExternalTransaction() 구현
  tx-parser.ts                   # EVM 트랜잭션 파싱 유틸리티

packages/sdk/src/
  client.ts                      # signTransaction() 메서드 추가

packages/mcp/src/
  tools.ts                       # sign_transaction 도구 추가

python-sdk/src/waiaas/
  client.py                      # sign_transaction() 메서드 추가
```

### REST API

| 메서드 | 경로 | 인증 | 설명 |
|--------|------|------|------|
| POST | /v1/transactions/sign | sessionAuth | unsigned tx를 정책 평가 후 서명하여 반환 |

#### 요청

```json
{
  "transaction": "base64-or-hex-encoded-unsigned-tx",
  "chain": "solana",
  "network": "mainnet"
}
```

- `transaction`: unsigned 트랜잭션 (Solana: base64, EVM: 0x-prefixed hex)
- `chain`: 서명에 사용할 월렛의 체인 (solana / evm)
- `network`: 네트워크 (mainnet / devnet / sepolia 등) — 정책 평가와 RPC 연결에 사용

#### 응답 (성공)

```json
{
  "signedTransaction": "base64-or-hex-encoded-signed-tx",
  "txHash": "optional-precomputed-hash",
  "operations": [
    {
      "type": "CONTRACT_CALL",
      "programId": "AGTRxyz...",
      "method": "create_post"
    }
  ],
  "policyResult": {
    "tier": "INSTANT",
    "evaluatedPolicies": ["CONTRACT_WHITELIST", "SPENDING_LIMIT"]
  }
}
```

#### 응답 (정책 거부)

```json
{
  "error": "POLICY_DENIED",
  "code": "CONTRACT_NOT_WHITELISTED",
  "message": "Program AGTRxyz... is not in CONTRACT_WHITELIST",
  "operations": [
    {
      "type": "CONTRACT_CALL",
      "programId": "AGTRxyz...",
      "denied": true,
      "reason": "CONTRACT_NOT_WHITELISTED"
    }
  ]
}
```

### DB 변경

| 항목 | 변경 |
|------|------|
| TransactionStatus | `SIGNED` 추가 — 서명 완료, 제출하지 않음 |
| TransactionType | `SIGN` 추가 — 외부 트랜잭션 서명 |
| transactions 테이블 | 기존 구조 활용. type='SIGN', status='SIGNED', metadata에 원본 rawTx 해시 저장 |
| DB 마이그레이션 | ALTER TABLE transactions CHECK 제약 업데이트 (SIGNED 상태, SIGN 타입 추가) |

---

## 리서치 대상

### 1. Solana 트랜잭션 파싱

| 결정 항목 | 선택지 |
|-----------|--------|
| 트랜잭션 포맷 | Transaction (legacy) vs VersionedTransaction (v0) — 둘 다 지원 필요 |
| Instruction 파싱 깊이 | programId만 확인 vs instruction data 디코드(Anchor discriminator 등) |
| 알려진 프로그램 식별 | SystemProgram(11111...), Token Program, Associated Token Program 하드코딩 |
| 서명자 검증 | unsigned tx의 feePayer/signers에 월렛 publicKey가 포함되어야 서명 가능 |

### 2. EVM 트랜잭션 파싱

| 결정 항목 | 선택지 |
|-----------|--------|
| 트랜잭션 포맷 | Legacy (type 0) vs EIP-1559 (type 2) vs EIP-2930 (type 1) — 모두 지원 |
| data 파싱 깊이 | 4byte selector만 추출 vs ABI 디코딩 (to 주소 + selector면 CONTRACT_WHITELIST 평가 충분) |
| chainId 검증 | tx의 chainId가 요청의 network와 일치하는지 검증 필수 |
| nonce 처리 | unsigned tx에 nonce가 포함되어 있으면 그대로 사용, 없으면 에러 |

### 3. 정책 평가 매핑

| 결정 항목 | 선택지 |
|-----------|--------|
| UNKNOWN operation 처리 | A) 기본 거부 B) CONTRACT_WHITELIST에 있으면 허용 |
| 복합 tx 티어 결정 | A) 가장 엄격한 티어 B) 각 operation 독립 평가 |
| SPENDING_LIMIT 누적 | 서명 후 제출 여부를 모르므로 A) 누적에 포함 B) 누적에 미포함 |
| DELAY/APPROVAL 티어 | A) 서명 보류 + 비동기 승인 B) 즉시 거부 (sign-only는 동기 API) |

### 4. 기본 거부 토글 설계

| 결정 항목 | 선택지 |
|-----------|--------|
| 저장 위치 | A) config.toml [security] B) DB settings 테이블 (v1.4.4 의존) C) 양쪽 지원 (fallback) |
| 정책 엔진 주입 | A) 생성자에서 settings 서비스 주입 B) 평가 시마다 settings 조회 |
| Admin UI 배치 | A) Settings > 보안 탭 B) Policies 페이지 상단 |
| 변경 즉시 반영 | config.toml은 재시작 필요, DB는 hot-reload 가능 |

### 5. 보안 고려사항

| 결정 항목 | 선택지 |
|-----------|--------|
| rawTx 크기 제한 | Solana: ~1232 bytes (MTU), EVM: 제한 없으나 합리적 상한 설정 |
| replay 방지 | 동일 rawTx 중복 서명 허용 여부 (dApp이 동일 tx 재시도 가능) |
| 서명된 tx 반환 후 추적 | 제출 여부를 모르므로 SIGNED 상태로 기록, 추후 확인 불가 |

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | 서명 후 제출 여부 | 서명만, 제출 안 함 | 2-Step 패턴에서 제출은 dApp 측 책임. WAIaaS가 제출하면 dApp의 비즈니스 로직(에스크로 검증 등)을 우회할 수 있음 |
| 2 | 정책 평가 대상 | unsigned tx 내용을 파싱하여 기존 정책 적용 | "서명 = 자금 이동 승인"이므로 기존 보안 모델을 우회해서는 안 됨 |
| 3 | UNKNOWN operation 처리 | CONTRACT_WHITELIST에 해당 programId/contract가 있으면 허용, 없으면 거부 | 기본 거부 원칙 유지. 알려지지 않은 프로그램이라도 화이트리스트에 등록하면 허용 |
| 4 | 트랜잭션 상태 | SIGNED (신규) — 서명 완료, 제출하지 않음 | 기존 SUBMITTED/CONFIRMED와 구분. 제출 여부는 WAIaaS가 알 수 없음 |
| 5 | DELAY/APPROVAL 티어 | 즉시 거부 | sign-only는 동기 API이며, 서명 대기 중 blockhash/nonce가 만료될 수 있음. DELAY/APPROVAL 금액의 외부 tx는 서명 거부가 안전 |
| 6 | SPENDING_LIMIT 누적 | 서명 시점에 reserved_amount에 포함 | 서명 = 자금 이동 가능성이므로 누적에 포함해야 이중 지출 방지. 실제 미제출 시 세션 만료와 함께 reserved 해제 |
| 7 | 기본 거부 토글 범위 | 정책 미설정 시의 기본 동작만 변경, 정책 설정 시 정상 평가 | 화이트리스트 정책이 존재하면 토글과 무관하게 정상 검증. 토글 OFF = "화이트리스트 없이 운영" 모드이지, "화이트리스트 무시" 모드가 아님 |
| 8 | 기본 거부 토글 기본값 | 3개 모두 ON (기본 거부 유지) | 기존 동작과 하위호환. 운영자가 명시적으로 OFF 전환해야만 허용 모드로 변경 |

---

## E2E 검증 시나리오

**자동화 비율: 100% — mock adapter + mock unsigned tx**

### 기본 흐름

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | Solana unsigned tx 서명 → signed tx 반환 | mock SolanaAdapter + valid unsigned tx(SystemProgram.transfer) → POST /v1/transactions/sign → signedTransaction 반환 assert | [L0] |
| 2 | EVM unsigned tx 서명 → signed tx 반환 | mock EvmAdapter + valid unsigned tx(ETH transfer) → POST /v1/transactions/sign → signedTransaction 반환 assert | [L0] |
| 3 | 서명 결과 transactions 테이블에 type='SIGN', status='SIGNED' 기록 | 시나리오 1 수행 후 → DB 조회 → type='SIGN' + status='SIGNED' assert | [L0] |

### 트랜잭션 파싱

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 4 | Solana: SystemProgram.transfer → NATIVE_TRANSFER 파싱 | parseTransaction(transferTx) → operations[0].type='NATIVE_TRANSFER' + to + amount assert | [L0] |
| 5 | Solana: SPL Token transfer → TOKEN_TRANSFER 파싱 | parseTransaction(splTransferTx) → operations[0].type='TOKEN_TRANSFER' + token assert | [L0] |
| 6 | Solana: Anchor program instruction → CONTRACT_CALL 파싱 | parseTransaction(anchorTx) → operations[0].type='CONTRACT_CALL' + programId assert | [L0] |
| 7 | Solana: 복합 tx (transfer + program call) → 다중 operation 파싱 | parseTransaction(multiTx) → operations.length >= 2 assert | [L0] |
| 8 | EVM: ETH transfer (data 없음) → NATIVE_TRANSFER 파싱 | parseTransaction(ethTransferTx) → operations[0].type='NATIVE_TRANSFER' + to + amount assert | [L0] |
| 9 | EVM: ERC-20 transfer(address,uint256) → TOKEN_TRANSFER 파싱 | parseTransaction(erc20Tx) → operations[0].type='TOKEN_TRANSFER' + token + to + amount assert | [L0] |
| 10 | EVM: ERC-20 approve(address,uint256) → APPROVE 파싱 | parseTransaction(approveTx) → operations[0].type='APPROVE' + token + to + amount assert | [L0] |
| 11 | EVM: 임의 contract call → CONTRACT_CALL 파싱 | parseTransaction(contractTx) → operations[0].type='CONTRACT_CALL' + programId + method assert | [L0] |
| 12 | EVM: chainId 불일치 → 에러 | parseTransaction(tx with chainId=1) + network='sepolia' → CHAIN_ID_MISMATCH 에러 assert | [L0] |

### 정책 평가

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 13 | NATIVE_TRANSFER + SPENDING_LIMIT INSTANT → 서명 허용 | mock 소액 transfer tx + SPENDING_LIMIT INSTANT 범위 → 서명 성공 assert | [L0] |
| 14 | NATIVE_TRANSFER + SPENDING_LIMIT APPROVAL → 즉시 거부 | mock 고액 transfer tx + APPROVAL 티어 → POLICY_DENIED + APPROVAL_REQUIRED assert | [L0] |
| 15 | CONTRACT_CALL + CONTRACT_WHITELIST 등록됨 → 서명 허용 | mock contract call tx + programId가 CONTRACT_WHITELIST에 있음 → 서명 성공 assert | [L0] |
| 16 | CONTRACT_CALL + CONTRACT_WHITELIST 미등록 → 거부 | mock contract call tx + programId가 CONTRACT_WHITELIST에 없음 → CONTRACT_NOT_WHITELISTED assert | [L0] |
| 17 | TOKEN_TRANSFER + ALLOWED_TOKENS 미등록 → 거부 | mock SPL/ERC-20 transfer tx + token이 ALLOWED_TOKENS에 없음 → TOKEN_NOT_ALLOWED assert | [L0] |
| 18 | 복합 tx: 하나의 operation 거부 → 전체 거부 | mock 2-instruction tx (허용 + 거부) → 전체 POLICY_DENIED assert | [L0] |
| 19 | Kill Switch 활성 시 서명 거부 | killSwitch 활성 → POST /v1/transactions/sign → 503 assert | [L0] |
| 20 | Rate limiter 초과 시 거부 | tx_rpm 초과 → 429 assert | [L0] |

### 정책 거부 알림

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 21 | CONTRACT_NOT_WHITELISTED 거부 시 알림에 contractAddress 포함 | mock contract call tx 거부 → POLICY_VIOLATION 알림 payload에 contractAddress 필드 포함 assert | [L0] |
| 22 | CONTRACT_CALL_DISABLED 거부 시 알림에 policyType 포함 | CONTRACT_WHITELIST 미설정 상태에서 거부 → 알림 payload에 policyType='CONTRACT_WHITELIST' 포함 assert | [L0] |
| 23 | TOKEN_NOT_ALLOWED 거부 시 알림에 tokenAddress 포함 | ALLOWED_TOKENS 미등록 토큰 거부 → 알림 payload에 tokenAddress 필드 포함 assert | [L0] |

### 기본 거부 토글

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 24 | default_deny_contracts=OFF + CONTRACT_WHITELIST 미설정 → CONTRACT_CALL 허용 | settings default_deny_contracts=false + 정책 없음 → CONTRACT_CALL 서명 성공 assert | [L0] |
| 25 | default_deny_contracts=ON(기본값) + CONTRACT_WHITELIST 미설정 → CONTRACT_CALL 거부 | settings default_deny_contracts=true + 정책 없음 → CONTRACT_CALL_DISABLED assert | [L0] |
| 26 | default_deny_contracts=OFF + CONTRACT_WHITELIST 설정됨 → 정상 화이트리스트 평가 | settings false + 정책 있음 + 미등록 주소 → CONTRACT_NOT_WHITELISTED 거부 assert | [L0] |
| 27 | default_deny_tokens=OFF + ALLOWED_TOKENS 미설정 → TOKEN_TRANSFER 허용 | settings default_deny_tokens=false → 토큰 전송 성공 assert | [L0] |
| 28 | default_deny_spenders=OFF + APPROVED_SPENDERS 미설정 → APPROVE 허용 | settings default_deny_spenders=false → 토큰 승인 성공 assert | [L0] |

### SPENDING_LIMIT 누적

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 29 | 서명 시 reserved_amount 누적 | 서명 성공 → 세션 reserved_amount 증가 assert | [L0] |
| 30 | 누적 후 send 요청 시 합산 평가 | sign(5 SOL) → send(5 SOL) → 합산 10 SOL 기준 SPENDING_LIMIT 평가 assert | [L0] |

### SDK / MCP

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 31 | TS SDK signTransaction() → 데몬 호출 + 결과 반환 | WAIaaSClient.signTransaction({...}) → POST /v1/transactions/sign 호출 + signedTransaction 반환 assert | [L0] |
| 32 | Python SDK sign_transaction() → 데몬 호출 + 결과 반환 | client.sign_transaction({...}) → POST /v1/transactions/sign 호출 assert | [L0] |
| 33 | MCP sign_transaction 도구 → 도구 목록 + 호출 성공 | MCP tools/list → sign_transaction 포함 assert + callTool 성공 assert | [L0] |

### 에러 처리

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 34 | 잘못된 base64/hex → 파싱 에러 | POST /v1/transactions/sign { transaction: "invalid" } → INVALID_TRANSACTION 에러 assert | [L0] |
| 35 | 월렛이 서명자에 포함되지 않음 → 에러 | Solana tx의 feePayer가 다른 pubkey → WALLET_NOT_SIGNER 에러 assert | [L0] |
| 36 | 세션 없이 요청 → 401 | sessionAuth 없이 요청 → 401 assert | [L0] |
| 37 | 잘못된 chain 파라미터 → 400 | chain='bitcoin' → UNSUPPORTED_CHAIN 에러 assert | [L0] |
| 38 | rawTx 크기 초과 → 413 | Solana MTU 초과 또는 EVM 상한 초과 → TRANSACTION_TOO_LARGE assert | [L0] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.4 (토큰 + 컨트랙트 확장) | CONTRACT_WHITELIST, ALLOWED_TOKENS, APPROVED_SPENDERS 정책이 구현되어 있어야 서명 대상 tx의 정책 평가가 가능 |
| v1.4.2 (agent → wallet 용어 변경) | wallet 기반 API 구조 |

v1.5 (DeFi + 가격 오라클)와는 **독립적**. USD 환산 없이 네이티브 금액 기준으로 정책 평가한다. v1.5 이후에는 USD 환산도 자동 적용된다.

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | unsigned tx 파싱 정확도 | 알려지지 않은 프로그램의 instruction을 정확히 파싱할 수 없어 정책 평가가 불완전할 수 있음 | UNKNOWN operation은 CONTRACT_WHITELIST 기반으로만 평가. programId/contract 주소가 화이트리스트에 있으면 세부 instruction 무관하게 허용 |
| 2 | 서명 후 실제 제출 추적 불가 | 서명된 tx가 제출되었는지, 성공했는지 WAIaaS가 알 수 없음 | SIGNED 상태로 기록하고 추적 불가 명시. 향후 비동기 확인 메커니즘(tx hash 기반 폴링) 검토 가능 |
| 3 | SPENDING_LIMIT 과다 예약 | 서명 후 미제출 시 reserved_amount가 불필요하게 점유 | 세션 TTL 만료 시 자동 해제. 별도 해제 API는 v1.4.7 범위 외 |
| 4 | Solana VersionedTransaction 호환성 | v0 lookup table을 사용하는 tx는 instruction 파싱이 복잡 | Address Lookup Table 조회 필요. RPC getAddressLookupTable() 호출로 실제 주소 해석 |
| 5 | EVM EIP-4844 (blob tx) 등 신규 타입 | Type 3 blob tx는 현재 사용 사례가 제한적 | Type 0, 1, 2만 지원. 미지원 타입은 UNSUPPORTED_TX_TYPE 에러 반환 |
| 6 | 재생 공격 (replay) | 동일 tx를 여러 번 서명 요청할 수 있음 | Solana: blockhash 만료(~60초)로 자연 방어. EVM: nonce 기반 자연 방어. 추가 방어 불필요 |
| 7 | 기본 거부 OFF 시 보안 약화 | 화이트리스트 없이 모든 컨트랙트/토큰/spender 허용 → 악의적 에이전트의 임의 호출 가능 | SPENDING_LIMIT, RATE_LIMIT, Kill Switch 등 다른 정책은 그대로 적용. Admin UI에 경고 문구 표시. 알림에 토글 OFF 상태 명시 |

---

## 예상 규모

| 항목 | 예상 |
|------|------|
| 리서치 | Solana/EVM tx 파싱, 정책 매핑, 보안 고려사항 |
| 페이즈 | 2-3개 (설계 1 + Solana 구현 1 + EVM 구현 1, 또는 설계 1 + 통합 구현 2) |
| 신규/수정 파일 | 15-20개 |
| 테스트 | 38-55개 |
| DB 마이그레이션 | 1건 (CHECK 제약 업데이트 — SIGNED 상태, SIGN 타입) |

---

*생성일: 2026-02-13*
*선행: v1.4 (토큰 + 컨트랙트 확장), v1.4.2 (wallet 용어)*
*관련: Agentra 호환성 (`how-to-test/agentra-test-240213/`), v1.5 Action Provider (보완적 관계)*
