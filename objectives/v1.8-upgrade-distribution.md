# 마일스톤 v1.8: 업그레이드 + 배포 인프라 설계

## 목표

설치된 WAIaaS가 새 버전 출시를 감지하여 사용자에게 알리고, 안전하게 업그레이드할 수 있는 체계를 **설계**하는 상태. npm/Docker/Desktop 각 배포 채널별 업그레이드 경로, DB 마이그레이션 연동, 호환성 매트릭스, 롤백 전략이 설계 문서로 확정되어 v1.8.1에서 즉시 구현할 수 있다.

> **v1.8 = 설계, v1.8.1 = 구현**

---

## 산출물

### 설계 문서

| 문서 | 이름 | 범위 |
|------|------|------|
| 66 | upgrade-distribution-spec | 전체 업그레이드/배포 인프라 설계 (8개 섹션: 버전 체크, CLI 알림, upgrade 명령, Health 확장, Docker 경로, 호환성 매트릭스, CHANGELOG/release-please, 패키지 의존 구조) |

### 설계 문서 66 목차 (예상)

#### 1. 버전 체크 서비스 (VersionCheckService)

데몬 시작 시 및 주기적으로 최신 버전을 확인하는 백그라운드 서비스 설계.

| 항목 | 설계 범위 |
|------|----------|
| 체크 소스 | npm registry (`registry.npmjs.org/@waiaas/cli`) — 별도 서버 불필요 |
| 체크 시점 | 데몬 시작 시 즉시 1회 + 24시간 주기 BackgroundWorker (`version-check` worker, 즉시 실행 후 interval 반복) |
| 체크 방식 | HTTP GET → `dist-tags.latest` 파싱 → semver 비교 |
| 결과 저장 | `key_value_store` 테이블 — `version_check_latest`(semver 문자열), `version_check_checked_at`(Unix 초), `version_check_notified_at`(Unix 초). 키 네이밍은 `{도메인}_{속성}` 컨벤션 (기존 `kill_switch_state` 패턴 준수). 값은 plain text (JSON 직렬화 없음) |
| 타임아웃 | 5초 (fail-soft — 실패 시 무시, 데몬 시작 차단 없음) |
| 비활성화 | `config.toml`의 `[daemon] update_check = false` |
| 프라이버시 | User-Agent에 현재 버전만 포함, 식별 정보 미전송 |

#### 2. CLI 업그레이드 알림

| 항목 | 설계 범위 |
|------|----------|
| 출력 | stderr에 업그레이드 안내 박스 (stdout 오염 방지) |
| 빈도 | 24시간에 1회 (`version_check_notified_at` 타임스탬프 제어) |
| 억제 | `--quiet` 플래그 또는 `WAIAAS_NO_UPDATE_NOTIFY=1` |
| 구현 | 직접 구현 (외부 의존성 없음) |

#### 3. `waiaas upgrade` CLI 명령

```
waiaas upgrade              # 최신 버전으로 업그레이드
waiaas upgrade --check      # 업그레이드 가능 여부만 확인
waiaas upgrade --to 2.1.0   # 특정 버전으로 업그레이드
waiaas upgrade --rollback   # 직전 백업에서 복원
```

7단계 업그레이드 시퀀스:
1. 버전 확인 (npm registry)
2. 데몬 중지 (`waiaas stop` 내부 호출)
3. 백업 (`~/.waiaas/backups/pre-upgrade-{version}-{timestamp}/` — DB + config.toml)
4. 패키지 업데이트 (`npm i -g @waiaas/cli@{version}` — CLI가 `@waiaas/core` + `@waiaas/daemon`을 dependencies로 선언하므로 전체 패키지가 함께 업데이트됨)
5. DB 마이그레이션 (MIG-01~06 전략 연동)
6. 호환성 검증 (스키마 버전 ↔ 코드 버전)
7. 데몬 재시작 (선택, `--no-start` 플래그로 억제)

#### 4. Health 엔드포인트 확장

`GET /health` 응답에 버전 정보 추가:

```json
{
  "status": "ok",
  "version": "2.0.0",
  "latestVersion": "2.1.0",
  "updateAvailable": true,
  "schemaVersion": 16,
  "uptime": 3600,
  "timestamp": 1739750400
}
```

> 기존 필드 (`status`, `version`, `uptime`, `timestamp`)는 유지하고, `latestVersion`(nullable), `updateAvailable`, `schemaVersion` 3개 필드를 추가한다. `HealthResponseSchema` (Zod + OpenAPI) 변경에 따라 v1.8.1 구현 시 **SDK 타입/MCP 응답/스킬 파일 동기화**가 필요하다 (CLAUDE.md 인터페이스 싱크 규칙).

#### 5. Docker 업그레이드 경로

| 항목 | 설계 범위 |
|------|----------|
| 이미지 태깅 | `latest` + semver (`2.1.0`) + major (`2`) |
| 업그레이드 | `docker pull` → `docker compose up -d` (named volume 보존) |
| 마이그레이션 | 컨테이너 시작 시 자동 실행 (MIG-04) |
| Watchtower | `LABEL com.centurylinklabs.watchtower.enable="true"` |

#### 6. 호환성 매트릭스

> Tauri Desktop 자동 업데이트 설계는 v2.6.1로 이연 (Desktop App 자체가 v2.6.1로 이연됨).

코드 버전과 DB 스키마 버전 간 호환성 관리 설계:

**메커니즘**: 코드에 `LATEST_SCHEMA_VERSION`(현재 16)과 `MIN_COMPATIBLE_SCHEMA_VERSION` 상수를 정의한다. 데몬 시작 시 `schema_version` 테이블에서 DB의 현재 버전을 읽어 3가지 시나리오를 판별한다.

| 시나리오 | 조건 | 동작 |
|---------|------|------|
| 코드 > DB 스키마 | DB 버전 ≥ `MIN_COMPATIBLE_SCHEMA_VERSION` | 자동 마이그레이션(MIG-01~06) 후 시작 |
| 코드 < DB 스키마 | DB 버전 > `LATEST_SCHEMA_VERSION` | 시작 거부 + "waiaas upgrade 실행 필요" 메시지 |
| 호환 범위 밖 | DB 버전 < `MIN_COMPATIBLE_SCHEMA_VERSION` | 시작 거부 + 단계별 업그레이드 안내 (예: "먼저 v1.6 이상으로 업그레이드하세요") |

**호환 범위 정책**: 최근 3개 minor 버전의 스키마를 자동 마이그레이션 지원. 이전 버전은 중간 버전을 거쳐 단계별 업그레이드를 안내한다.

#### 7. 릴리스 자동화 (2-게이트 모델)

v1.7에서 구축된 CI/CD 위에 release-please를 추가하고, **2개의 수동 게이트**로 배포 안전성을 확보한다. 기존 `tag-release.sh`는 폐기하고 release-please로 일원화한다.

**2-게이트 모델 흐름:**

```
PR 머지 (자동)
  → release-please가 Conventional Commits 파싱
  → Release PR 자동 생성/갱신 (CHANGELOG.md + 버전 범프 포함)

━━━ 게이트 1: Release PR 머지 (수동) ━━━
  → 릴리스할 준비가 되었는지 판단 후 머지
  → GitHub Release 자동 생성 + 태그 v{version}
  → release.yml 자동 트리거 (품질 게이트)
    → full test suite + coverage hard + Docker 빌드 + npm dry-run

━━━ 게이트 2: 배포 승인 (수동) ━━━
  → release.yml의 deploy job에 environment: production 설정
  → GitHub Environment Protection Rules로 수동 승인 필요
  → 승인 후: npm publish + Docker Hub push 실행
```

| 항목 | 설계 범위 |
|------|----------|
| 커밋 규약 | Conventional Commits — `feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `chore:`, `BREAKING CHANGE:` |
| 자동화 도구 | `google-github-actions/release-please-action@v4` GitHub Actions |
| 릴리스 전략 | `release-type: node` — `package.json` 버전 자동 범프 |
| 모노레포 지원 | 루트 `package.json` 기준 단일 릴리스 (패키지별 독립 릴리스는 v2.0에서 검토) |
| CHANGELOG 포맷 | Keep a Changelog + Conventional Commits 자동 생성 — `CHANGELOG.md` 루트에 생성 |
| GitHub Release | release-please가 Release PR 머지 시 자동 생성 — 태그 `v{version}` + Release Notes |
| 품질 게이트 | release.yml이 GitHub Release `published` 이벤트로 자동 트리거 — full-test-suite + Docker 빌드 + npm dry-run |
| 배포 게이트 | release.yml의 `deploy` job에 `environment: production` — GitHub Environment Protection Rules로 수동 승인 후 npm publish + Docker push |
| pre-release | `v{version}-rc.{n}` 프리릴리스 태그 지원 — 정식 릴리스 전 검증용 |
| tag-release.sh 폐기 | release-please가 버전 범프 + 태그 생성을 담당하므로 `scripts/tag-release.sh`는 폐기. CLAUDE.md 규칙도 갱신 |

**게이트 1 (Release PR 머지) — 릴리스 의사 결정:**
- release-please가 자동 생성한 Release PR에 CHANGELOG 변경사항과 버전 범프가 포함됨
- PR 내용을 검토하고 릴리스할 준비가 되었을 때만 머지
- 마일스톤 완료와 무관하게, 릴리스하고 싶은 시점에 머지 (매 마일스톤 또는 다수 마일스톤 누적 후)

**게이트 2 (배포 승인) — 배포 실행 결정:**
- release.yml의 품질 게이트(test + coverage + Docker 빌드)가 모두 통과한 후
- `deploy` job이 `environment: production`으로 대기
- GitHub Settings → Environments → production → "Required reviewers" 설정
- 승인하면 npm publish + Docker Hub push 실행
- 거부하면 GitHub Release만 존재하고 실제 배포는 안 됨

> v2.0 전까지 deploy job은 dry-run 상태. v2.0에서 실제 배포 활성화 시 게이트 2가 작동한다.

#### 8. npm 패키지 의존 구조 및 업그레이드 단위

`npm i -g @waiaas/cli@{version}` 한 번으로 전체 패키지가 업데이트되는 구조를 설계한다.

| 패키지 | 역할 | npm 배포 | 의존 관계 |
|--------|------|---------|----------|
| `@waiaas/cli` | 글로벌 설치 진입점 | 공개 | → `@waiaas/core`, `@waiaas/daemon` |
| `@waiaas/core` | 공유 타입/스키마 | 공개 | (독립) |
| `@waiaas/daemon` | 데몬 서버 | 공개 | → `@waiaas/core`, `@waiaas/adapter-solana`, `@waiaas/adapter-evm` |
| `@waiaas/adapter-solana` | Solana 체인 어댑터 | 공개 | → `@waiaas/core` |
| `@waiaas/adapter-evm` | EVM 체인 어댑터 | 공개 | → `@waiaas/core` |
| `@waiaas/sdk` | TypeScript SDK | 공개 (독립 설치) | → `@waiaas/core` |
| `@waiaas/mcp` | MCP 서버 | 공개 (독립 설치) | → `@waiaas/core`, `@waiaas/sdk` |
| `@waiaas/admin` | Admin UI (빌드 산출물) | 공개 | → `@waiaas/core` |

> 개발 시 `workspace:*`로 연결된 패키지가 npm 배포 시 정확한 semver로 치환된다. `@waiaas/cli` 설치 시 npm이 전이적 의존성(core, daemon, adapters)을 자동 해결하므로 **단일 명령으로 전체 업데이트**가 보장된다.

---

## 관련 기존 설계 문서

| 문서 | 이름 | 관련 내용 |
|------|------|----------|
| 28 | daemon-lifecycle-cli | 데몬 시작 시퀀스 — 버전 체크 삽입 지점 |
| 39 | tauri-desktop-architecture | Tauri Auto Updater (v2.6.1로 이연) |
| 40 | telegram-bot-docker | Docker 이미지 태깅 |
| 54 | cli-flow-redesign | CLI 명령어 체계 — `upgrade` 명령 추가 |
| 65 | db-migration-strategy | DB 마이그레이션 — 업그레이드 시 연동 (v1.4에서 작성) |
| 50 | cicd-pipeline-coverage-gate | CI/CD 4-stage 파이프라인 — release-please 워크플로우 추가 기반 |

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | 버전 체크 소스 | npm registry | 별도 서버 불필요, 공개 API, Self-Hosted 원칙 유지 |
| 2 | 업그레이드 알림 | 직접 구현 | `update-notifier`는 외부 의존성 추가. 기능이 단순하므로 직접 구현 |
| 3 | CLI 업그레이드 방식 | `npm i -g` 위임 | npm global 설치 기준이므로 npm에 위임. CLI → core+daemon → adapters 전이적 의존 해결 |
| 4 | 백업 범위 | DB + config.toml | keystore는 업그레이드 영향 없음 (파일 포맷 불변) |
| 5 | Docker 자동 업데이트 | Watchtower 호환 라벨 | 자체 메커니즘 불필요, 라벨만 추가 |
| 6 | Desktop 자동 업데이트 | v2.6.1로 이연 | Desktop App 자체가 v2.6.1로 이연됨 |
| 7 | 릴리스 모델 | 2-게이트 (release-please + Environment Protection) | 게이트 1: Release PR 머지(릴리스 의사 결정), 게이트 2: deploy job 수동 승인(배포 실행). 태그/CHANGELOG 자동 + 배포 수동 |
| 8 | 호환성 매트릭스 | `LATEST_SCHEMA_VERSION` + `MIN_COMPATIBLE_SCHEMA_VERSION` 코드 내 상수 | 외부 의존 불필요, 빌드타임 포함. 최근 3 minor 자동 마이그레이션 |
| 9 | KV 키 네이밍 | `{도메인}_{속성}` plain text | 기존 `kill_switch_state` 패턴 준수. 버전 체크 키는 `version_check_*` 접두사 |
| 10 | 릴리스 전략 | 루트 단일 릴리스 | 모노레포 패키지별 독립 릴리스는 v2.0에서 검토. 초기에는 단일 버전으로 관리 복잡도 최소화 |
| 11 | tag-release.sh 폐기 | release-please 일원화 | release-please가 버전 범프 + 태그 + CHANGELOG를 모두 관리. 수동 스크립트 이중 관리 제거 |

---

## E2E 검증 시나리오

> v1.8은 설계 마일스톤이므로 E2E 시나리오는 **v1.8.1 구현 시 검증 기준**으로 정의한다.

### 버전 체크 + 알림 (6건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 1 | 데몬 시작 시 npm registry 조회 → latest_version 저장 | [L0] |
| 2 | registry 조회 실패 → 데몬 정상 시작 (fail-soft) | [L0] |
| 3 | `update_check = false` → 조회 안 함 | [L0] |
| 4 | CLI 실행 시 새 버전 → stderr 알림 출력 | [L0] |
| 5 | 24시간 내 재실행 → 알림 중복 없음 | [L0] |
| 6 | `--quiet` → 알림 억제 | [L0] |

### CLI 업그레이드 (5건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 7 | `upgrade --check` → 버전 정보 출력 | [L0] |
| 8 | `upgrade` → 7단계 시퀀스 전체 실행 | [L0] |
| 9 | 백업 디렉토리에 DB + config 존재 | [L0] |
| 10 | `upgrade --rollback` → 백업에서 복원 | [L0] |
| 11 | 이미 최신 → "Already up to date" | [L0] |

### Health + 호환성 (5건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 12 | `GET /health` → updateAvailable 필드 포함 | [L0] |
| 13 | 코드 > DB 스키마 → 자동 마이그레이션 | [L0] |
| 14 | 코드 < DB 스키마 → 시작 거부 | [L0] |
| 15 | 호환 범위 밖 → 시작 거부 + 안내 | [L0] |
| 16 | 버전 체크 미실행 시 latestVersion = null | [L0] |

### Docker (2건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 17 | Docker pull + compose up → volume 보존 + 마이그레이션 | [L1] |
| 18 | Watchtower 라벨 존재 | [L0] |

### 2-게이트 릴리스 모델 (6건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 19 | `feat:` 커밋 머지 → release-please가 Release PR 자동 생성 | [L1] |
| 20 | Release PR 머지(게이트 1) → CHANGELOG.md 갱신 + GitHub Release 자동 생성 + 태그 | [L1] |
| 21 | GitHub Release `published` → release.yml 품질 게이트 자동 트리거 | [L1] |
| 22 | 품질 게이트 통과 → deploy job이 `environment: production` 대기(게이트 2) | [L1] |
| 23 | 배포 승인 → npm publish + Docker push 실행 | [L1] |
| 24 | `BREAKING CHANGE:` 커밋 → major 버전 범프 | [L1] |

> Tauri Desktop 자동 업데이트 E2E (2건)는 v2.6.1로 이연.

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.4 (토큰 + 컨트랙트) | DB 마이그레이션 인프라(MIG-01~06)가 v1.4에서 구축됨. 호환성 매트릭스 설계 전제 |
| v1.6 (Docker) | Docker 이미지 태깅이 v1.6에서 구현됨. Tauri Auto Updater는 v2.6.1로 이연 |
| v1.7 (CI/CD) | GitHub Actions ci.yml/nightly.yml/release.yml이 v1.7에서 구축됨. release-please 워크플로우는 이 위에 추가 설계 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 에어갭/방화벽 환경에서 npm registry 접근 불가 | 버전 체크 불가 | fail-soft + `update_check = false` 비활성화 + 수동 tgz 설치 가이드 |
| 2 | npm i -g 권한 문제 (sudo 필요) | 업그레이드 실패 | 에러 메시지에 해결 방법 안내 (nvm/fnm 사용 시 sudo 불필요) |
| 3 | 마이그레이션 실패 시 데이터 손실 | DB 불일치 | 자동 백업 필수 + 트랜잭션 내 실행(MIG-03) + 롤백 명령 |
| 4 | semver 호환성 매트릭스 관리 복잡도 | 테스트 부담 | 최근 3개 minor 버전만 유지. 이전은 단계별 업그레이드 안내 |
| 5 | Tauri 서명 키 분실 | v2.6.1로 이연 (Desktop 자동 업데이트는 v2.6.1에서 구현) | — |
| 6 | Docker latest 태그 breaking change | Watchtower 자동 업데이트 시 호환성 문제 | major 태그(`waiaas/daemon:2`) 사용 권장 |
| 7 | Conventional Commits 미준수 | CHANGELOG 자동 생성 실패, 수동 릴리스 필요 | CI에서 commitlint 검증 추가 검토 (v1.8.1 구현 시). 최소한 PR 제목에 type prefix 강제 |
| 8 | Health 응답 스키마 변경 | SDK/MCP 타입 불일치 | v1.8.1 구현 시 HealthResponseSchema 변경 → SDK 타입 재생성 → MCP 응답 동기화 → 스킬 파일 업데이트를 단일 PR로 처리 |

---

*최종 업데이트: 2026-02-17 — (1) 2-게이트 릴리스 모델 확정: 게이트 1(Release PR 머지=릴리스 의사 결정) + 게이트 2(deploy job 수동 승인=배포 실행), tag-release.sh 폐기 → release-please 일원화. (2) 7건 리뷰 반영: release-please 설계 승격, Health SDK/MCP 동기화, KV 네이밍, BackgroundWorker 패턴, 호환성 메커니즘, npm 패키지 의존 구조, v1.7 의존 전제 수정. E2E 18→24건, 리스크 8건, 기술 결정 11건, 설계 문서 66 범위 8개 섹션*
