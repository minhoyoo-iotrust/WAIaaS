# 마일스톤 v1.8: 업그레이드 + 배포 인프라 설계

## 목표

설치된 WAIaaS가 새 버전 출시를 감지하여 사용자에게 알리고, 안전하게 업그레이드할 수 있는 체계를 **설계**하는 상태. npm/Docker/Desktop 각 배포 채널별 업그레이드 경로, DB 마이그레이션 연동, 호환성 매트릭스, 롤백 전략이 설계 문서로 확정되어 v1.8.1에서 즉시 구현할 수 있다.

> **v1.8 = 설계, v1.8.1 = 구현**

---

## 산출물

### 설계 문서

| 문서 | 이름 | 범위 |
|------|------|------|
| 66 | upgrade-distribution-spec | 전체 업그레이드/배포 인프라 설계 |

### 설계 문서 66 목차 (예상)

#### 1. 버전 체크 서비스 (VersionCheckService)

데몬 시작 시 및 주기적으로 최신 버전을 확인하는 백그라운드 서비스 설계.

| 항목 | 설계 범위 |
|------|----------|
| 체크 소스 | npm registry (`registry.npmjs.org/@waiaas/cli`) — 별도 서버 불필요 |
| 체크 시점 | 데몬 시작 1회 + 24시간 주기 BackgroundWorker |
| 체크 방식 | HTTP GET → `dist-tags.latest` 파싱 → semver 비교 |
| 결과 저장 | `key_value_store` 테이블 (`latest_version`, `version_checked_at`) |
| 타임아웃 | 5초 (fail-soft — 실패 시 무시, 데몬 시작 차단 없음) |
| 비활성화 | `config.toml`의 `[daemon] update_check = false` |
| 프라이버시 | User-Agent에 현재 버전만 포함, 식별 정보 미전송 |

#### 2. CLI 업그레이드 알림

| 항목 | 설계 범위 |
|------|----------|
| 출력 | stderr에 업그레이드 안내 박스 (stdout 오염 방지) |
| 빈도 | 24시간에 1회 (`version_notified_at` 타임스탬프 제어) |
| 억제 | `--quiet` 플래그 또는 `WAIAAS_NO_UPDATE_NOTIFY=1` |
| 구현 | 직접 구현 (외부 의존성 없음) |

#### 3. `waiaas upgrade` CLI 명령

```
waiaas upgrade              # 최신 버전으로 업그레이드
waiaas upgrade --check      # 업그레이드 가능 여부만 확인
waiaas upgrade --to 2.1.0   # 특정 버전으로 업그레이드
waiaas upgrade --rollback   # 직전 백업에서 복원
```

7단계 업그레이드 시퀀스:
1. 버전 확인 (npm registry)
2. 데몬 중지 (`waiaas stop` 내부 호출)
3. 백업 (`~/.waiaas/backups/pre-upgrade-{version}-{timestamp}/` — DB + config.toml)
4. 패키지 업데이트 (`npm i -g @waiaas/cli@{version}`)
5. DB 마이그레이션 (MIG-01~06 전략 연동)
6. 호환성 검증 (스키마 버전 ↔ 코드 버전)
7. 데몬 재시작 (선택, `--no-start` 플래그로 억제)

#### 4. Health 엔드포인트 확장

`GET /health` 응답에 버전 정보 추가:

```json
{
  "status": "ok",
  "version": "2.0.0",
  "latestVersion": "2.1.0",
  "updateAvailable": true,
  "schemaVersion": 5
}
```

#### 5. Docker 업그레이드 경로

| 항목 | 설계 범위 |
|------|----------|
| 이미지 태깅 | `latest` + semver (`2.1.0`) + major (`2`) |
| 업그레이드 | `docker pull` → `docker compose up -d` (named volume 보존) |
| 마이그레이션 | 컨테이너 시작 시 자동 실행 (MIG-04) |
| Watchtower | `LABEL com.centurylinklabs.watchtower.enable="true"` |

#### 6. 호환성 매트릭스

> Tauri Desktop 자동 업데이트 설계는 v2.6.1로 이연 (Desktop App 자체가 v2.6.1로 이연됨).

코드 버전과 DB 스키마 버전 간 호환성 관리 설계:

| 시나리오 | 동작 |
|---------|------|
| 코드 > DB 스키마 | 자동 마이그레이션 후 시작 |
| 코드 < DB 스키마 | 시작 거부 + "업그레이드 필요" 메시지 |
| 호환 범위 밖 | 시작 거부 + 필요 버전 안내 |

#### 7. CHANGELOG 자동 생성

- Conventional Commits (`feat:`, `fix:`, `BREAKING CHANGE:`)
- release-please (v2.0 목표에서 결정됨)
- `CHANGELOG.md` + GitHub Release Notes

---

## 관련 기존 설계 문서

| 문서 | 이름 | 관련 내용 |
|------|------|----------|
| 28 | daemon-lifecycle-cli | 데몬 시작 시퀀스 — 버전 체크 삽입 지점 |
| 39 | tauri-desktop-architecture | Tauri Auto Updater (v2.6.1로 이연) |
| 40 | telegram-bot-docker | Docker 이미지 태깅 |
| 54 | cli-flow-redesign | CLI 명령어 체계 — `upgrade` 명령 추가 |
| 65 | db-migration-strategy | DB 마이그레이션 — 업그레이드 시 연동 (v1.4에서 작성) |

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | 버전 체크 소스 | npm registry | 별도 서버 불필요, 공개 API, Self-Hosted 원칙 유지 |
| 2 | 업그레이드 알림 | 직접 구현 | `update-notifier`는 외부 의존성 추가. 기능이 단순하므로 직접 구현 |
| 3 | CLI 업그레이드 방식 | `npm i -g` 위임 | npm global 설치 기준이므로 npm에 위임 |
| 4 | 백업 범위 | DB + config.toml | keystore는 업그레이드 영향 없음 (파일 포맷 불변) |
| 5 | Docker 자동 업데이트 | Watchtower 호환 라벨 | 자체 메커니즘 불필요, 라벨만 추가 |
| 6 | Desktop 자동 업데이트 | v2.6.1로 이연 | Desktop App 자체가 v2.6.1로 이연됨 |
| 7 | CHANGELOG | release-please | v2.0에서 이미 결정 |
| 8 | 호환성 매트릭스 | 코드 내 상수 | 외부 의존 불필요, 빌드타임 포함 |

---

## E2E 검증 시나리오

> v1.8은 설계 마일스톤이므로 E2E 시나리오는 **v1.8.1 구현 시 검증 기준**으로 정의한다.

### 버전 체크 + 알림 (6건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 1 | 데몬 시작 시 npm registry 조회 → latest_version 저장 | [L0] |
| 2 | registry 조회 실패 → 데몬 정상 시작 (fail-soft) | [L0] |
| 3 | `update_check = false` → 조회 안 함 | [L0] |
| 4 | CLI 실행 시 새 버전 → stderr 알림 출력 | [L0] |
| 5 | 24시간 내 재실행 → 알림 중복 없음 | [L0] |
| 6 | `--quiet` → 알림 억제 | [L0] |

### CLI 업그레이드 (5건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 7 | `upgrade --check` → 버전 정보 출력 | [L0] |
| 8 | `upgrade` → 7단계 시퀀스 전체 실행 | [L0] |
| 9 | 백업 디렉토리에 DB + config 존재 | [L0] |
| 10 | `upgrade --rollback` → 백업에서 복원 | [L0] |
| 11 | 이미 최신 → "Already up to date" | [L0] |

### Health + 호환성 (5건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 12 | `GET /health` → updateAvailable 필드 포함 | [L0] |
| 13 | 코드 > DB 스키마 → 자동 마이그레이션 | [L0] |
| 14 | 코드 < DB 스키마 → 시작 거부 | [L0] |
| 15 | 호환 범위 밖 → 시작 거부 + 안내 | [L0] |
| 16 | 버전 체크 미실행 시 latestVersion = null | [L0] |

### Docker (2건)

| # | 시나리오 | 태그 |
|---|---------|------|
| 17 | Docker pull + compose up → volume 보존 + 마이그레이션 | [L1] |
| 18 | Watchtower 라벨 존재 | [L0] |

> Tauri Desktop 자동 업데이트 E2E (2건)는 v2.6.1로 이연.

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.4 (토큰 + 컨트랙트) | DB 마이그레이션 인프라(MIG-01~06)가 v1.4에서 구축됨. 호환성 매트릭스 설계 전제 |
| v1.6 (Docker) | Docker 이미지 태깅이 v1.6에서 구현됨. Tauri Auto Updater는 v2.6.1로 이연 |
| v1.7 (CI/CD) | release-please, GitHub Actions release.yml이 v1.7에서 구축됨 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 에어갭/방화벽 환경에서 npm registry 접근 불가 | 버전 체크 불가 | fail-soft + `update_check = false` 비활성화 + 수동 tgz 설치 가이드 |
| 2 | npm i -g 권한 문제 (sudo 필요) | 업그레이드 실패 | 에러 메시지에 해결 방법 안내 (nvm/fnm 사용 시 sudo 불필요) |
| 3 | 마이그레이션 실패 시 데이터 손실 | DB 불일치 | 자동 백업 필수 + 트랜잭션 내 실행(MIG-03) + 롤백 명령 |
| 4 | semver 호환성 매트릭스 관리 복잡도 | 테스트 부담 | 최근 3개 minor 버전만 유지. 이전은 단계별 업그레이드 안내 |
| 5 | Tauri 서명 키 분실 | v2.6.1로 이연 (Desktop 자동 업데이트는 v2.6.1에서 구현) | — |
| 6 | Docker latest 태그 breaking change | Watchtower 자동 업데이트 시 호환성 문제 | major 태그(`waiaas/daemon:2`) 사용 권장 |

---

*최종 업데이트: 2026-02-16 — Tauri Desktop 자동 업데이트 섹션을 v2.6.1로 이연. 설계 전용 마일스톤, 구현은 v1.8.1*
