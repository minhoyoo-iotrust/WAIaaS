# 마일스톤 v1.5.6: 0x EVM DEX Swap

## 목표

v1.5 Action Provider 프레임워크 위에 0x Swap API를 ActionProvider로 구현하여, AI 에이전트가 EVM 체인(Ethereum, Base, Arbitrum 등)에서 토큰 스왑을 정책 평가 하에 실행할 수 있는 상태.

---

## 배경

v1.5.5에서 Jupiter(Solana DEX)가 첫 번째 ActionProvider로 구현된다. v1.5.6은 **동일한 REST API -> calldata 패턴**을 EVM 체인에 적용하여, WAIaaS가 Solana와 EVM 양쪽에서 DEX 스왑을 지원하는 상태를 만든다.

0x Swap API는 19+ EVM 체인을 지원하는 기관급 DEX 애그리게이터로, 100+ 유동성 소스(Uniswap, Curve, Sushiswap 등)를 집계하여 최적 경로를 계산한다. REST API가 calldata를 직접 반환하므로 Jupiter와 거의 동일한 통합 패턴으로 구현 가능하다.

### Jupiter vs 0x 패턴 비교

```
Jupiter (Solana):
  POST /swap/v1/quote → 견적 → POST /swap-instructions → instruction → ContractCallRequest

0x (EVM):
  GET /swap/permit2/price → 견적 → GET /swap/permit2/quote → calldata → ContractCallRequest
```

---

## 구현 대상

### 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| ZeroExSwapActionProvider | IActionProvider 구현체. 0x Swap API v2 호출(Permit2 기반). resolve() -> ContractCallRequest(to/data/value 매핑). 지원 체인: Ethereum, Base, Arbitrum, Optimism, Polygon, BSC, Avalanche 등 19+ 체인 |
| ZeroExApiClient | 0x REST API 래퍼. `/swap/permit2/price`(견적 조회), `/swap/permit2/quote`(실행용 calldata). API 키 기반 인증(`0x-api-key` 헤더). 요청 타임아웃 10초(AbortController). 응답 Zod 스키마 검증 |
| 슬리피지 제어 | 기본 100bps(1%), 상한 500bps(5%). config.toml [actions.0x_swap] 섹션에서 오버라이드. 0x API의 `slippagePercentage` 파라미터에 매핑 |
| Permit2 토큰 승인 | ERC-20 토큰 스왑 시 Permit2 컨트랙트 승인 필요. 첫 스왑 시 자동으로 approve 트랜잭션 선행 실행. ETH(네이티브) 스왑은 승인 불필요 |
| MCP 도구 | waiaas_0x_swap — ActionDefinition -> MCP Tool 자동 매핑(v1.5 프레임워크 활용) |
| SDK 지원 | TS SDK executeAction('0x_swap', params) + Python SDK execute_action('0x_swap', params) |

### 입력 스키마

```typescript
const ZeroExSwapInputSchema = z.object({
  sellToken: z.string(),       // 판매 토큰 주소 (0x...)
  buyToken: z.string(),        // 구매 토큰 주소 (0x...)
  sellAmount: z.string(),      // 판매 수량 (smallest unit)
  slippagePercentage: z.number().optional(), // 슬리피지 (0.01 = 1%)
  chain: z.string().optional(), // 체인 (기본: 월렛 체인)
});
```

### 파일/모듈 구조

```
packages/actions/src/
  providers/
    0x-swap/
      index.ts                   # ZeroExSwapActionProvider
      0x-api-client.ts           # 0x REST API 래퍼
      schemas.ts                 # ZeroExSwapInputSchema, PriceResponse, QuoteResponse Zod 스키마
      config.ts                  # ZeroExSwapConfig 타입 + 기본값
      permit2.ts                 # Permit2 승인 헬퍼
  index.ts                       # 내장 프로바이더 export (jupiter_swap, 0x_swap)
```

### config.toml

```toml
[actions.0x_swap]
enabled = true
api_key = ""                                   # 0x API 키 (필수)
api_base_url = "https://api.0x.org"            # 기본값
default_slippage_pct = 0.01                    # 1%
max_slippage_pct = 0.05                        # 5%
```

### REST API

기존 POST /v1/actions/:provider/:action 엔드포인트 재사용:

```
POST /v1/actions/0x_swap/swap
Body: { sellToken, buyToken, sellAmount, slippagePercentage?, chain? }
```

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | 0x API 버전 | Swap API v2 (Permit2 기반) | 최신 버전. Permit2로 토큰 승인 UX 개선(한 번 승인 → 모든 DEX에서 사용). v1 대비 가스 효율 향상 |
| 2 | API 키 정책 | 필수 (config.toml) | 0x API는 API 키가 필수. 무료 플랜(제한적 rate limit) + 유료 플랜 모두 동일 키 필드 사용. Admin Settings > Actions에서 설정 가능 |
| 3 | 체인 라우팅 | 월렛의 chain 속성 기반 자동 선택 | 월렛이 ethereum 체인이면 0x Ethereum API 호출, base 체인이면 Base API 호출. 0x는 체인별 동일 API 구조 |
| 4 | Permit2 승인 처리 | ActionProvider 내부에서 자동 처리 | ERC-20 첫 스왑 시 Permit2 approve를 별도 트랜잭션으로 선행. 이후 스왑은 approve 불필요. ETH 네이티브 스왑은 승인 자체 불필요 |
| 5 | 1inch 대비 0x 선택 근거 | 0x | 체인 커버리지(19+ vs 9+), 기관급 API 안정성, Permit2 기반 최신 아키텍처. 1inch Fusion(gasless)은 향후 별도 ActionProvider로 추가 가능 |

---

## E2E 검증 시나리오

**자동화 비율: 95%+ -- `[HUMAN]` 1건**

### 0x Swap resolve + execute

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | 0x_swap resolve -> ContractCallRequest 반환 | mock 0x /swap/permit2/quote 응답 -> ZeroExSwapActionProvider.resolve() -> ContractCallRequest(to/data/value) 반환 assert | [L0] |
| 2 | 0x_swap execute -> 파이프라인 실행 | mock 0x API + mock EvmAdapter -> resolve() -> ContractCallRequest -> 파이프라인 실행 -> 상태 전이 assert | [L0] |
| 3 | MCP: waiaas_0x_swap 도구 자동 노출 | 0x_swap 프로바이더(mcpExpose=true) 등록 -> MCP tool 목록에 waiaas_0x_swap 포함 assert | [L0] |
| 4 | ETH -> USDC 스왑 -> 네이티브 토큰 판매 | mock quote(ETH->USDC) -> value 필드에 ETH 금액 포함 + Permit2 승인 불필요 assert | [L0] |
| 5 | USDC -> ETH 스왑 -> ERC-20 판매 + Permit2 | mock quote(USDC->ETH) -> Permit2 승인 트랜잭션 선행 + 스왑 트랜잭션 실행 assert | [L0] |

### 슬리피지 + 에러

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 6 | 슬리피지: 기본 1% 적용 확인 | 기본 설정 -> 0x API 호출 시 slippagePercentage=0.01 파라미터 assert | [L0] |
| 7 | 슬리피지: max 초과 요청 -> 상한 적용 | 사용자 slippagePercentage=0.1(10%) 요청 -> max 0.05(5%) 적용 assert | [L0] |
| 8 | 0x API 에러 응답 -> ACTION_API_ERROR | mock 0x API 400 에러 -> resolve() ACTION_API_ERROR 반환 assert | [L0] |
| 9 | API 키 미설정 -> 명확한 에러 메시지 | config에 api_key 빈 값 -> "0x API 키를 설정하세요 (Admin Settings > Actions)" 에러 assert | [L0] |

### 정책 연동

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 10 | CONTRACT_WHITELIST에 0x 라우터 미등록 -> 정책 거부 | 0x ExchangeProxy 미화이트리스트 + 스왑 요청 -> 정책 거부 assert | [L0] |
| 11 | 스왑 금액 USD 환산 -> SPENDING_LIMIT 정책 평가 | mock oracle + 1 ETH($3000) -> USDC 스왑 -> SPENDING_LIMIT 평가 assert | [L0] |

### 멀티체인

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 12 | Ethereum 월렛 -> 0x Ethereum API 호출 | ethereum 체인 월렛 + 스왑 -> api.0x.org 호출 assert | [L0] |
| 13 | Base 월렛 -> 0x Base API 호출 | base 체인 월렛 + 스왑 -> base.api.0x.org 호출 assert | [L0] |

### 외부 API 실 호출

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 14 | 0x API 실 호출 테스트넷 검증 | Sepolia에서 0x /swap/permit2/price 실 호출 -> 견적 응답 성공 확인 | [HUMAN] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.5 (Action Provider 프레임워크) | IActionProvider, ActionProviderRegistry, MCP Tool 자동 변환, POST /v1/actions/:provider/:action |
| v1.5.5 (Jupiter Swap) | 첫 번째 ActionProvider 구현으로 패턴 확립. packages/actions/ 패키지 구조, 내장 프로바이더 로딩 로직 재사용 |
| v1.4 (EVM 인프라) | EvmAdapter, ContractCallRequest(EVM: to/data/value), CONTRACT_WHITELIST |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 0x API 키 필수 | Jupiter(키 선택)와 달리 0x는 API 키 필수. DX 장벽 | Admin Settings에서 키 설정 UI 제공. 무료 플랜으로 시작 가능. 키 미설정 시 명확한 안내 메시지 |
| 2 | Permit2 승인 UX | 첫 ERC-20 스왑 시 추가 트랜잭션(approve) 필요 | 자동으로 approve 선행 실행. 사용자에게 "첫 스왑 시 토큰 승인이 필요합니다" 알림 |
| 3 | 0x API 체인별 엔드포인트 분기 | 19+ 체인에 대해 base URL 매핑 관리 필요 | chainId -> API base URL 매핑 테이블 관리. 미지원 체인 요청 시 명확한 에러 |
| 4 | 0x API rate limit | 무료 플랜은 rate limit 존재 | 견적 캐시(30초 TTL). 실행(quote)은 캐시 불가하므로 rate limit 도달 시 ACTION_RATE_LIMITED 에러 반환 |

---

## 예상 규모

| 항목 | 예상 |
|------|------|
| 페이즈 | 2개 (ZeroExSwapActionProvider + API Client + Permit2 1 / MCP+SDK+스킬+테스트 1) |
| 신규/수정 파일 | 12-16개 |
| 테스트 | 14-20개 |
| DB 마이그레이션 | 없음 |

---

*생성일: 2026-02-15*
*선행: v1.5.5 (Jupiter Swap)*
*관련: 0x Swap API v2 (https://0x.org/docs/0x-swap-api/introduction)*
