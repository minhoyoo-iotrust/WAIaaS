# 마일스톤 v1.2: 인증 + 정책 엔진

## 목표

세션 인증으로 에이전트 접근을 제어하고, 금액별 4-tier 정책이 동작하며, Owner가 고액 거래를 승인/거부할 수 있는 상태

---

## 구현 대상 설계 문서

이 마일스톤에서 구현하는 설계 문서 목록과 각 문서에서 구현할 범위를 명시한다.

| # | 문서 | 이름 | 구현 범위 | 전체/부분 |
|---|------|------|----------|----------|
| 30 | SESS-PROTO | session-token-protocol | JWT HS256 발급/검증(jose v6.x), `wai_sess_` 접두사 토큰 포맷, SessionConstraints DB 조회(8 필드), 세션 수명주기 5단계(생성/활성/갱신/폐기/만료), SIWS/SIWE Owner 서명 기반 세션 생성, 세션 사용량 추적(SessionUsageStats) | 전체 |
| 32 | TX-PIPE | transaction-pipeline-api | Stage 2(인증 검증 — sessionAuth JWT 검증 + DB lookup) 완성, Stage 3(정책 평가 — DatabasePolicyEngine 4-tier 분류) 완성, Stage 4(DELAY/APPROVAL 대기 처리 — 큐잉/폴링/타임아웃) 완성. Stage 1/5/6은 v1.1 골격 유지 | 부분 |
| 33 | LOCK-MECH | time-lock-approval-mechanism | DatabasePolicyEngine(policies 테이블 규칙 로드, evaluate() 11단계 평가), 4-tier 상태 머신(INSTANT/NOTIFY/DELAY/APPROVAL), DELAY 쿨다운 플로우(15분 대기, 10초 폴링, Owner 취소), APPROVAL 승인 플로우(3단계 타임아웃 우선순위: 정책별>config>3600초, 30초 폴링, Owner SIWS/SIWE 서명), TOCTOU 방지(BEGIN IMMEDIATE + reserved_amount), PolicyType 10개 Zod discriminatedUnion + superRefine | 전체 |
| 34 | OWNR-CONN | owner-wallet-connection | ownerAuth 미들웨어(8단계 검증), Owner API 엔드포인트(approve/reject, sessions list/revoke, status — 8개), CLI 수동 서명 플로우, Owner 생명주기 3-State 상태 머신(NONE/GRACE/LOCKED), set-owner 사후 등록(masterAuth), `markOwnerVerified()` 자동 GRACE->LOCKED 전이 | 전체 |
| 52 | AUTH-REDESIGN | auth-model-redesign | masterAuth(Argon2id 검증, 암묵적/명시적 이중 모드, X-Master-Password 헤더), ownerAuth(SIWS/SIWE per-request 서명 검증, 2곳 한정: 거래 승인 + KS 복구), sessionAuth(JWT HS256 2-stage 검증, SessionConstraints DB 조회), authRouter 디스패치(31 엔드포인트 인증 맵), 3-tier 인증 책임 분리 | 전체 |
| 53 | SESS-RENEW | session-renewal-protocol | 낙관적 갱신(PUT /v1/sessions/:id/renew), 5종 안전 장치(maxRenewals, 절대 수명, 50% 시점 갱신, 거부 윈도우, 갱신 단위 고정), token_hash CAS(RENEWAL_CONFLICT 409), Owner 사후 거부 + 알림 | 전체 |
| 29 | CORE-06 | api-framework-design | 미들웨어 7(rateLimiter — 미인증/인증 2단계 분리), 미들웨어 8(authRouter — masterAuth/ownerAuth/sessionAuth 라우트 분기) | 부분 |

### v0.8 + v0.10 설계 반영

| 설계 결정 ID | 출처 | 내용 | 반영 위치 |
|-------------|------|------|----------|
| OWNER-01 | v0.8 | owner_address nullable (선택적 등록) | agents 테이블, resolveOwnerState() |
| OWNER-07 | v0.8 | owner_verified 컬럼, GRACE->LOCKED 자동 전이 | markOwnerVerified(), ownerAuth 미들웨어 Step 8.5 |
| PLCY-01 | v0.10 | APPROVAL 타임아웃 3단계 우선순위 (정책별 > config > 3600초) | evaluate() Step 10, pending_approvals.expires_at |
| PLCY-02 | v0.10 | GRACE 무기한, ownerAuth 첫 사용 시 LOCKED 전이 | resolveOwnerState(), 34-owner §10 |
| PLCY-03 | v0.10 | GRACE에서 APPROVAL 거래 DELAY 다운그레이드 | evaluateTier() Step 9.5, resolveOwnerState() !== 'LOCKED' |
| CONC-02 | v0.10 | 세션 갱신 token_hash WHERE 조건 CAS + RENEWAL_CONFLICT 409 | PUT /v1/sessions/:id/renew, 낙관적 잠금 |

### 구현하지 않는 범위

| 문서 | 제외 항목 | 처리 마일스톤 |
|------|----------|-------------|
| 32 (transaction-pipeline) | Stage 1 discriminatedUnion 5-type 확장, Stage 5 완전 의사코드(build->simulate->sign->submit+에러분기+재시도) | v1.4 |
| 34 (owner-wallet-connection) | WalletConnect v2 Reown AppKit 통합 (Tauri Desktop 전용) | v1.6 |
| 29 (api-framework) | OpenAPI 3.0 전체 스펙 자동 생성, 38 엔드포인트 전체 라우트 | v1.3 |
| 35 (notification-architecture) | INotificationChannel 3채널 구현 (세션 갱신 알림은 알림 시스템 의존) | v1.3 |

---

## 산출물

### 컴포넌트별 산출물

| # | 컴포넌트 | 내용 |
|---|----------|------|
| 1 | **sessionAuth** | JWT HS256 발급(`jose` SignJWT)/검증(`jwtVerify`), `wai_sess_` 접두사, JWT Claims(iss/exp/iat/jti/sid/aid), SessionConstraints DB 조회(maxAmount, allowedOperations, maxDailyAmount, maxDailyCount, expiresIn, allowedRecipients, maxRenewals, renewalRejectWindow), 2-stage 검증(JWT 파싱 -> DB lookup + 만료/폐기/제약 확인) |
| 2 | **masterAuth** | Argon2id 검증(sodium-native `crypto_pwhash_str_verify`), 암묵적 모드(데몬 구동 = 인증 완료, 추가 헤더 불필요), 명시적 모드(X-Master-Password 헤더, 파괴적 작업: 에이전트 삭제, config 변경), localhost only 강제 |
| 3 | **ownerAuth** | SIWS(Sign-In With Solana) / SIWE(Sign-In With Ethereum, viem/siwe) per-request 서명 검증, replay nonce(SqliteNonceStore 5분 TTL), OwnerSignaturePayload action 2개(approve_tx, recover), 2곳 한정(거래 승인 + Kill Switch 복구) |
| 4 | **authRouter** | 31 엔드포인트 인증 맵 디스패치(masterAuth implicit 19개, masterAuth explicit 4개, ownerAuth 2개, sessionAuth 5개, 없음 1개), Hono 미들웨어 체인 분기 |
| 5 | **DatabasePolicyEngine** | policies 테이블에서 Zod 규칙 로드, evaluate() 11단계 평가 알고리즘, 4-tier 분류(INSTANT/NOTIFY/DELAY/APPROVAL), PolicyType 10개(SPENDING_LIMIT, DAILY_LIMIT, RECIPIENT_WHITELIST, ALLOWED_OPERATIONS, ALLOWED_TOKENS, CONTRACT_WHITELIST, APPROVED_SPENDERS, AMOUNT_LIMIT, TIER_OVERRIDE, TIME_RESTRICTION), Zod discriminatedUnion + superRefine 검증 |
| 6 | **DELAY Worker** | 15분 쿨다운 대기, 10초 폴링 간격, Owner 취소 가능(DELETE /v1/transactions/:id — status QUEUED 시), 미취소 시 자동 실행(Stage 5 진입), `setInterval` 기반 대기 폴링 |
| 7 | **APPROVAL Worker** | 3단계 타임아웃 우선순위(정책별 `approvalTimeout` > `config.toml [policy].approval_timeout_default` > 하드코딩 3600초), 30초 폴링 간격, pending_approvals 테이블 관리, Owner SIWS/SIWE 서명 승인(POST /v1/owner/approve), Owner 거부(POST /v1/owner/reject), 타임아웃 시 EXPIRED 전이 |
| 8 | **TOCTOU 방지** | `BEGIN IMMEDIATE` 트랜잭션, `reserved_amount` 컬럼 업데이트, 잔액 검증 시 `available = balance - SUM(reserved_amount)` 계산, 동시 요청 안전성 확보 |
| 9 | **Owner API** | 8개 엔드포인트: `POST /v1/owner/approve`(거래 승인), `POST /v1/owner/reject`(거래 거부), `GET /v1/owner/pending`(대기 중 거래 목록), `GET /v1/owner/status`(Owner 상태 조회), `GET /v1/sessions`(세션 목록), `DELETE /v1/sessions/:id`(세션 해지), `PUT /v1/agents/:id/owner`(Owner 등록/변경 — masterAuth/ownerAuth 조건부), `DELETE /v1/agents/:id/owner`(Owner 해제 — GRACE만 가능) |
| 10 | **세션 관리** | 생성(`POST /v1/sessions` — masterAuth implicit), 조회(`GET /v1/sessions/:id`), 해지(`DELETE /v1/sessions/:id`), 갱신(`PUT /v1/sessions/:id/renew` — sessionAuth, 낙관적 갱신), token_hash CAS(WHERE 조건 낙관적 잠금, 실패 시 RENEWAL_CONFLICT 409), 5종 안전 장치(maxRenewals, absoluteLifetime, 50% 시점, rejectionWindow, renewalUnit) |
| 11 | **Rate Limiter 2단계** | 미인증 요청(IP 기반, 엄격한 한도), 인증 요청(세션 기반, 완화된 한도), `sliding-window-rate-limiter-flexible` 또는 자체 구현, v0.7 설계 반영 |

### 주요 인터페이스/클래스와 핵심 메서드

```typescript
// sessionAuth 미들웨어
async function sessionAuth(c: Context, next: Next): Promise<void>
  // 1. Authorization 헤더에서 wai_sess_ 접두사 토큰 추출
  // 2. jose jwtVerify() — HS256, issuer='waiaas'
  // 3. DB sessions 테이블 lookup (jti = session.id)
  // 4. 만료/폐기/에이전트 상태 확인
  // 5. SessionConstraints 로드 → c.set('constraints', ...)
  // 6. c.set('sessionId', sid), c.set('agentId', aid)

// masterAuth 미들웨어 (명시적 모드)
async function masterAuthExplicit(c: Context, next: Next): Promise<void>
  // X-Master-Password 헤더 → Argon2id 검증 (sodium-native)

// ownerAuth 미들웨어
async function ownerAuth(c: Context, next: Next): Promise<void>
  // 1. Authorization 헤더에서 OwnerSignaturePayload 추출
  // 2. agents.owner_address 조회
  // 3. SIWS/SIWE 서명 검증 (체인별 분기)
  // 4. replay nonce 확인 (SqliteNonceStore)
  // 5. Step 8.5: markOwnerVerified() — GRACE→LOCKED 자동 전이

// DatabasePolicyEngine
class DatabasePolicyEngine implements IPolicyEngine {
  async evaluate(request: PolicyEvaluationRequest): Promise<PolicyDecision>
    // 11단계: 에이전트 로드 → 정책 로드 → 타입별 순차 평가 →
    //         TOCTOU 검증 → 티어 결정 → reserved_amount 업데이트
}

// resolveOwnerState (Owner 3-State)
function resolveOwnerState(agent: Agent): 'NONE' | 'GRACE' | 'LOCKED'
  // owner_address === null → NONE
  // owner_address !== null && !owner_verified → GRACE
  // owner_address !== null && owner_verified → LOCKED

// 세션 갱신
async function renewSession(sessionId: string, currentTokenHash: string): Promise<RenewResult>
  // 1. 5종 안전 장치 검증
  // 2. UPDATE sessions SET token_hash = :new WHERE token_hash = :old (CAS)
  // 3. affected === 0 → RENEWAL_CONFLICT 409
  // 4. 새 JWT 발급 + 반환
```

### JWT Secret Dual-Key 로테이션

v0.7에서 설계한 JWT 비밀키 로테이션 구현:

- **current_key**: 새 토큰 서명에 사용
- **previous_key**: 기존 토큰 검증에만 사용 (5분 윈도우)
- 로테이션 주기: config.toml `[security].jwt_rotation_interval` (기본 24시간)
- 검증 순서: current_key로 먼저 검증 → 실패 시 previous_key로 검증 → 모두 실패 시 401

---

## 기술 결정 사항

| # | 결정 항목 | 현재 상태 | 선택지 | 비고 |
|---|----------|----------|--------|------|
| TD-01 | Owner 서명 검증 라이브러리 | **확정** | SIWS: `@solana/wallet-standard`, SIWE: `viem/siwe` | v0.7에서 ethers 제거, viem/siwe 전환 확정 |
| TD-02 | WalletConnect vs CLI 수동 서명 | **확정** | CLI 수동 서명 우선, WalletConnect는 v1.6(Tauri Desktop)에서 구현 | v0.5에서 WC 선택화 확정 |
| TD-03 | DELAY/APPROVAL Worker 구현 | 미확정 | `setInterval` 반복 폴링 vs `setTimeout` 재귀 | setInterval이 단순하나, 장시간 대기 시 drift 가능. setTimeout 재귀가 더 정확 |
| TD-04 | 정책 규칙 스키마 검증 | **확정** | Zod discriminatedUnion + superRefine | v0.6에서 PolicyType 10개 확정. 33-time-lock §2.2가 SSoT |
| TD-05 | JWT Secret dual-key 로테이션 | 미확정 | in-memory 키 쌍 관리 vs DB 저장 | 단일 프로세스이므로 in-memory 유력. 재시작 시 새 키 생성 |
| TD-06 | resolveOwnerState() 위치 | 미확정 | `@waiaas/core` (순수 함수) vs `@waiaas/daemon` (서비스 계층) | 순수 함수이므로 core가 적합. agent 엔티티와 함께 위치 |
| TD-07 | Rate Limiter 구현체 | 미확정 | `rate-limiter-flexible` npm vs 자체 구현 (Map + sliding window) | 자체 구현이 의존성 적지만, edge case(메모리 정리 등) 고려 필요 |
| TD-08 | SIWS 라이브러리 | 미확정 | `@solana/wallet-standard` 직접 사용 vs `@civic/solana-sign-in` 래퍼 | @solana/wallet-standard가 공식이나 API 복잡도 확인 필요 |

---

## E2E 검증 시나리오

**자동화 수준 요약: L0 18건, L1 0건, [HUMAN] 0건**

모든 시나리오는 완전 자동화(L0)로 검증한다. DELAY/APPROVAL 테스트는 타임아웃을 테스트용 값(수 초)으로 단축하고, Owner 서명은 테스트 전용 키페어로 SIWS 메시지를 프로그래밍 방식으로 서명한다.

### 세션 인증

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| E-01 | 마스터 패스워드로 세션 토큰 발급 | `POST /v1/sessions` (masterAuth implicit) -> 201 + `wai_sess_` 접두사 JWT 반환, sessions 테이블 행 삽입 확인 | [L0] |
| E-02 | 세션 토큰으로 API 호출 -> 인증 성공 | `GET /v1/wallet/balance` (Authorization: Bearer wai_sess_...) -> 200 OK | [L0] |
| E-03 | 만료된 세션 토큰 -> 401 거부 | TTL=1초 세션 생성 -> 2초 대기 -> API 호출 -> 401 Unauthorized + 에러 JSON | [L0] |
| E-04 | 폐기된 세션 토큰 -> 401 거부 | 세션 생성 -> `DELETE /v1/sessions/:id` -> 동일 토큰으로 API 호출 -> 401 | [L0] |

### 세션 갱신

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| E-05 | 세션 갱신 (PUT /renew) -> 새 토큰 반환 | `PUT /v1/sessions/:id/renew` (sessionAuth) -> 200 + 새 JWT, 구 토큰 무효화 확인 | [L0] |
| E-06 | 세션 갱신 동시 요청 -> RENEWAL_CONFLICT 409 | 동일 세션에 대해 2개 갱신 요청 동시 전송 -> 1개 성공(200) + 1개 실패(409 RENEWAL_CONFLICT) | [L0] |
| E-07 | maxRenewals 초과 -> 갱신 거부 | maxRenewals=2 세션 생성 -> 3번째 갱신 시도 -> 403 거부 | [L0] |

### 정책 엔진 (4-tier)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| E-08 | 소액(0.01 SOL) 전송 -> INSTANT -> 즉시 실행 | `POST /v1/transactions` -> status QUEUED -> CONFIRMED (패스스루, 대기 없음) | [L0] |
| E-09 | 중액(5 SOL) 전송 -> DELAY -> 대기 -> 자동 실행 | 테스트용 DELAY 타이머 5초 설정 -> 5초 후 자동 실행 -> CONFIRMED | [L0] |
| E-10 | 고액(100 SOL) 전송 -> APPROVAL -> 서명 승인 -> 실행 | 테스트 키페어로 SIWS 자동 서명 -> `POST /v1/owner/approve` -> CONFIRMED | [L0] |
| E-11 | APPROVAL 타임아웃 -> REJECTED/EXPIRED | 테스트용 타임아웃 5초 설정 -> 승인 없이 대기 -> status EXPIRED 확인 | [L0] |
| E-12 | DELAY 중 Owner 취소 | DELAY 상태 트랜잭션에 `DELETE /v1/transactions/:id` -> status CANCELLED | [L0] |

### Owner 상태 관리

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| E-13 | Owner 미등록 에이전트 -> APPROVAL 비활성, DELAY 다운그레이드 | owner_address=null 에이전트에 고액 전송 -> APPROVAL 대신 DELAY 적용 확인 | [L0] |
| E-14 | Owner 등록 (NONE->GRACE) -> 정책 활성화 | `PUT /v1/agents/:id/owner` (masterAuth) -> owner_address 설정, resolveOwnerState()='GRACE' 확인 | [L0] |
| E-15 | GRACE->LOCKED 자동 전이 | Owner 등록 후 ownerAuth 사용(approve) -> owner_verified=1, resolveOwnerState()='LOCKED' 확인 | [L0] |

### Owner API + 관리

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| E-16 | Owner API: 대기 중 트랜잭션 approve/reject | APPROVAL 대기 트랜잭션 생성 -> `POST /v1/owner/approve` (ownerAuth) -> CONFIRMED / `POST /v1/owner/reject` -> CANCELLED | [L0] |
| E-17 | Owner API: 세션 목록 조회 + 특정 세션 해지 | `GET /v1/sessions` -> 세션 목록 반환, `DELETE /v1/sessions/:id` -> 해당 세션 폐기 확인 | [L0] |

### 보안 + 인프라

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| E-18 | Rate Limiter 초과 -> 429 | 미인증 상태에서 빠른 연속 요청 -> 429 Too Many Requests 반환 확인 | [L0] |
| E-19 | TOCTOU 방어: reserved_amount 확인 | 동시 2건 전송 요청 (합산 > 잔액) -> 1건 성공 + 1건 잔액 부족 실패 확인 | [L0] |
| E-20 | Kill Switch 활성 중 -> 모든 요청 503 | Kill Switch 활성화 -> API 호출 -> 503 Service Unavailable 반환 확인 | [L0] |

---

## 의존

**v1.1 (코어 인프라 + 기본 전송)**

v1.1에서 구축한 다음 인프라를 기반으로 한다:

- 모노레포 7-pkg 구조, pnpm workspace, Turborepo
- SQLite + Drizzle 7 테이블 (sessions, policies, pending_approvals 포함)
- Keystore (AES-256-GCM + Argon2id) — masterAuth 검증의 기반
- 6-stage 파이프라인 골격 (Stage 2/3/4를 v1.2에서 완성)
- SolanaAdapter 6개 메서드 (Stage 5 실행에 사용)
- Hono HTTP 서버 + 미들웨어 1~6

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| R-01 | DELAY/APPROVAL 타이머 테스트 안정성 | 실 시간 대기(15분, 1시간) 테스트 불가. 타이머 단축 시 race condition 가능 | 테스트 전용 config로 타임아웃 5~10초 단축. `setTimeout` mock 또는 실제 단축 타이머 사용. 폴링 간격도 1초로 단축 |
| R-02 | WalletConnect v2 Reown SDK 호환성 | Tauri 전용이므로 v1.2에서는 CLI 수동 서명만 구현 | WalletConnect는 v1.6(Desktop)에서 구현. v1.2는 CLI 기반 SIWS/SIWE 테스트 키페어로 검증 |
| R-03 | Owner 상태 전이 edge case | GRACE->LOCKED 타이밍 — ownerAuth 검증 중 동시 요청 시 race condition | `markOwnerVerified()` 는 `UPDATE agents SET owner_verified=1 WHERE id=? AND owner_verified=0` — 멱등 연산이므로 안전 |
| R-04 | 정책 규칙 Zod 스키마 복잡도 | PolicyType 10개 + superRefine 검증 로직이 복잡하여 디버깅 난이도 상승 | 33-time-lock §2.2의 PolicyRuleSchema를 SSoT로 하여 1:1 구현. 각 PolicyType별 독립 단위 테스트 작성 |
| R-05 | JWT dual-key 로테이션 구현 | 로테이션 윈도우(5분) 동안 current + previous 두 키로 검증해야 하며, 재시작 시 키 재생성 | in-memory 키 관리 + 재시작 시 이전 세션 토큰은 자동 무효화 (DB lookup에서 차단). 5분 윈도우 내 요청만 previous_key 사용 |
| R-06 | 세션 갱신 동시성 (RENEWAL_CONFLICT) | token_hash CAS 실패 시 에이전트가 재시도 로직을 구현해야 함 | SDK/MCP에서 자동 재시도(jitter 포함) 구현 예정(v1.3). v1.2에서는 API 레벨에서 409 반환 + 에러 메시지에 재시도 안내 포함 |

---

*최종 업데이트: 2026-02-09 v1.0 Phase 45 Plan 01 산출물*
