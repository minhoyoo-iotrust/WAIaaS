# 마일스톤 v2.8: SOL Staking 확장 (Marinade)

## 목표

v1.5.8 Staking 인프라 위에 Marinade Finance를 추가 Staking Provider로 구현하여, AI 에이전트가 Jito 외에 Marinade의 분산 스테이킹(mSOL)도 선택할 수 있는 상태.

---

## 배경

Marinade는 TVL ~$1.7B으로 Solana 2위 Liquid Staking 프로토콜이다. Jito(v1.5.8)와 달리 **100+ 밸리데이터 알고리즘 분산 스테이킹**으로 Solana 네트워크 탈중앙화에 기여한다.

### Jito vs Marinade

| 비교 | Jito (JitoSOL) | Marinade (mSOL) |
|------|----------------|-----------------|
| TVL | ~$3B | ~$1.7B |
| 차별점 | MEV 수익 공유 | 분산 스테이킹 (100+ 밸리데이터) |
| 홀더 수 | 192K+ | 148K+ |
| 수수료 | 4% (JitoSOL) | 6% (Native), 0% (Liquid) |
| Native Staking | 미지원 | 지원 (Native + Liquid 이중) |

v1.5.8의 JitoStakingActionProvider와 동일 패턴으로 구현하므로 추가 프레임워크 구축 불필요.

---

## 구현 대상

### 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| MarinadeStakingActionProvider | IActionProvider 구현체 (Solana). 2개 액션: stake(SOL→mSOL), unstake(mSOL→SOL). @marinade.finance/marinade-ts-sdk 사용. Program: `MarBmsSgKXdrN1egZf5sqe1TMai9K1rChYNDJgjq7aD` |
| MarinadeSdkWrapper | @marinade.finance/marinade-ts-sdk 래퍼. deposit/liquidUnstake 호출 추상화 |
| MCP 도구 | waiaas_marinade_stake, waiaas_marinade_unstake |
| SDK 지원 | TS/Python SDK: executeAction('marinade_stake', params) 등 |

### 입력 스키마

```typescript
const MarinadeStakeInputSchema = z.object({
  amount: z.string(),           // SOL 수량
});

const MarinadeUnstakeInputSchema = z.object({
  amount: z.string(),           // mSOL 수량
  mode: z.enum(['liquid', 'delayed']).default('liquid'),
  // liquid: 즉시 (약간의 수수료), delayed: 에포크 대기 (수수료 없음)
});
```

### config.toml

```toml
[actions.marinade]
enabled = true
msol_mint = "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"
```

---

## E2E 검증 시나리오

**자동화 비율: 100%**

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | Marinade stake resolve -> instruction 반환 | resolve('stake', {amount: "10.0"}) -> Marinade deposit instruction assert | [L0] |
| 2 | Marinade unstake (liquid) -> 즉시 SOL 수령 | resolve('unstake', {amount: "9.8", mode: 'liquid'}) -> liquidUnstake instruction assert | [L0] |
| 3 | Marinade unstake (delayed) -> 에포크 대기 | mode='delayed' -> 지연 unstake instruction assert | [L0] |
| 4 | 스테이킹 상태 조회 -> Jito+Marinade 통합 | GET /v1/wallets/:id/staking -> JitoSOL + mSOL 포지션 모두 포함 assert | [L0] |
| 5 | 정책 평가 -> SPENDING_LIMIT 적용 | 10 SOL stake -> USD 환산 -> SPENDING_LIMIT 평가 assert | [L0] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.5.8 (Liquid Staking) | 스테이킹 상태 API, Admin 대시보드 스테이킹 섹션 |
| v1.5 (가격 오라클) | mSOL USD 환산 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | Marinade SDK 의존성 | @marinade.finance/marinade-ts-sdk 버전 변경 | SDK 래퍼로 추상화 |
| 2 | mSOL/SOL 환율 | Marinade 환율이 Jito와 다름 | 스테이킹 시 예상 mSOL 수량 표시. 가격 오라클로 mSOL USD 가격 조회 |

---

## 예상 규모

| 항목 | 예상 |
|------|------|
| 페이즈 | 1개 (Provider + SDK + MCP) |
| 신규/수정 파일 | 6-8개 |
| 테스트 | 5-8개 |
| DB 마이그레이션 | 없음 |

---

*생성일: 2026-02-15*
*선행: v1.5.8 (Liquid Staking)*
*관련: Marinade (https://docs.marinade.finance/), @marinade.finance/marinade-ts-sdk*
