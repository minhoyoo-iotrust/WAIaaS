# 마일스톤 v1.4.2: 용어 변경 (agent → wallet)

## 목표

코드베이스와 설계 문서 전체에서 "agent"를 "wallet"으로 일괄 변경하여, WAIaaS가 관리하는 엔티티의 실체(AI 에이전트가 사용하는 **지갑**)를 정확히 반영한다. AI 에이전트는 외부 소비자이고, WAIaaS가 생성·관리하는 것은 지갑이다.

---

## 배경

### 문제

현재 코드베이스에서 "agent"라고 부르는 엔티티의 실제 역할:

| 현재 용어 | 실체 |
|-----------|------|
| `agents` 테이블 | AI 에이전트가 사용하는 **지갑** |
| `POST /v1/agents` | 지갑 생성 |
| `agent_id` FK | 지갑 참조 |
| `AgentSchema` | 지갑 데이터 모델 |
| `--agent` CLI 플래그 | 지갑 지정 |

"Agent"라는 용어는 외부의 AI 에이전트(Claude, GPT 등)와 혼동을 일으키며, Wallet-as-a-Service라는 서비스 이름과도 불일치한다.

### 변경 원칙

- **wallet**: 엔티티 이름 (`agents` → `wallets`)
- **walletId**: 참조 필드 (`agentId` → `walletId`, `agent_id` → `wallet_id`)
- 기존 `/v1/wallet/balance` 등의 세션 기반 경로는 `/v1/wallets/{id}/balance`로 통합하여 API 일관성 확보
- 모든 변경은 단일 마일스톤에서 atomic하게 수행

---

## 변경 범위

### 1. 데이터베이스 스키마 (DB 마이그레이션)

| 현재 | 변경 후 | 비고 |
|------|---------|------|
| `agents` 테이블 | `wallets` | 테이블 재생성 (SQLite ALTER TABLE RENAME 지원) |
| `sessions.agent_id` | `sessions.wallet_id` | FK + 인덱스 |
| `transactions.agent_id` | `transactions.wallet_id` | FK + 인덱스 |
| `policies.agent_id` | `policies.wallet_id` | FK + 인덱스 |
| `audit_log.agent_id` | `audit_log.wallet_id` | nullable FK + 인덱스 |
| `notification_logs.agent_id` | `notification_logs.wallet_id` | nullable FK + 인덱스 |
| `idx_agents_*` (4개) | `idx_wallets_*` | 인덱스명 |
| `idx_*_agent_id` (3개) | `idx_*_wallet_id` | FK 인덱스명 |

**마이그레이션 전략:** schema_version N 증분 마이그레이션. SQLite `ALTER TABLE RENAME` + 컬럼별 테이블 재생성. 기존 데이터 100% 보존.

### 2. REST API 엔드포인트

| 현재 | 변경 후 |
|------|---------|
| `POST /v1/agents` | `POST /v1/wallets` |
| `GET /v1/agents` | `GET /v1/wallets` |
| `GET /v1/agents/{id}` | `GET /v1/wallets/{id}` |
| `PUT /v1/agents/{id}` | `PUT /v1/wallets/{id}` |
| `DELETE /v1/agents/{id}` | `DELETE /v1/wallets/{id}` |
| `PUT /v1/agents/{id}/owner` | `PUT /v1/wallets/{id}/owner` |
| `GET /v1/wallet/balance` | `GET /v1/wallets/{id}/balance` 통합 검토 |
| `GET /v1/wallet/address` | `GET /v1/wallets/{id}/address` 통합 검토 |
| `GET /v1/wallet/assets` | `GET /v1/wallets/{id}/assets` 통합 검토 |

**참고:** 세션 기반 `/v1/wallet/*` 경로와 `/v1/wallets/{id}/*` 통합 여부는 Phase 계획 단계에서 확정. 기존 세션 기반 접근을 유지할 경우 `/v1/wallet/*`은 그대로 두고 CRUD만 변경할 수도 있음.

### 3. Zod 스키마 + TypeScript 타입

| 현재 | 변경 후 |
|------|---------|
| `AgentSchema` | `WalletSchema` |
| `CreateAgentRequestSchema` | `CreateWalletRequestSchema` |
| `AgentResponseSchema` | `WalletResponseSchema` |
| `AgentOwnerResponseSchema` | `WalletOwnerResponseSchema` |
| `AgentListResponseSchema` | `WalletListResponseSchema` |
| `AgentDetailResponseSchema` | `WalletDetailResponseSchema` |
| `AgentDeleteResponseSchema` | `WalletDeleteResponseSchema` |
| `Agent` 타입 | `Wallet` 타입 |
| `CreateAgentRequest` 타입 | `CreateWalletRequest` 타입 |
| `AgentStatus` / `AgentStatusEnum` | `WalletStatus` / `WalletStatusEnum` |
| `AGENT_STATUSES` 상수 | `WALLET_STATUSES` 상수 |
| 모든 `agentId` 필드 | `walletId` |

### 4. 에러 코드

| 현재 | 변경 후 |
|------|---------|
| `AGENT_NOT_FOUND` | `WALLET_NOT_FOUND` |
| `AGENT_SUSPENDED` | `WALLET_SUSPENDED` |
| `AGENT_TERMINATED` | `WALLET_TERMINATED` |
| ErrorDomain `'AGENT'` | `'WALLET'` |

### 5. MCP / CLI / 환경변수

| 현재 | 변경 후 |
|------|---------|
| `AgentContext` 인터페이스 | `WalletContext` |
| `agentName` 필드 | `walletName` |
| `withAgentPrefix()` 함수 | `withWalletPrefix()` |
| CLI `--agent <id>` 플래그 | `--wallet <id>` |
| `WAIAAS_AGENT_ID` 환경변수 | `WAIAAS_WALLET_ID` |
| `WAIAAS_AGENT_NAME` 환경변수 | `WAIAAS_WALLET_NAME` |
| `mcp-tokens/<agentId>` 경로 | `mcp-tokens/<walletId>` |

### 6. SDK (TypeScript + Python)

| 현재 | 변경 후 |
|------|---------|
| TS: `BalanceResponse.agentId` 등 | `BalanceResponse.walletId` |
| Python: `WalletAddress.agent_id` 등 | `WalletAddress.wallet_id` |

### 7. Config

| 현재 | 변경 후 |
|------|---------|
| `max_sessions_per_agent` | `max_sessions_per_wallet` |
| `WAIAAS_SECURITY_MAX_SESSIONS_PER_AGENT` | `WAIAAS_SECURITY_MAX_SESSIONS_PER_WALLET` |

### 8. Admin Web UI

| 현재 | 변경 후 |
|------|---------|
| Agents 페이지 (`/admin` → agents 탭) | Wallets 페이지 |
| `Agent` / `AgentDetail` 인터페이스 | `Wallet` / `WalletDetail` |
| `agentColumns` | `walletColumns` |
| UI 텍스트: "Agents", "Agent Detail" 등 | "Wallets", "Wallet Detail" |

### 9. 설계 문서 (12개)

agent 용어를 사용하는 설계 문서 12개의 용어를 일괄 갱신:

| 문서 | 발생 횟수 |
|------|----------|
| 67-admin-web-ui-spec.md | 33 |
| 47-boundary-value-chain-scenarios.md | 15 |
| 46-keystore-external-security-scenarios.md | 21 |
| 43-layer1-session-auth-attacks.md | 13 |
| 42-mock-boundaries-interfaces-contracts.md | 11 |
| 57-asset-query-fee-estimation-spec.md | 6 |
| 56-token-transfer-extension-spec.md | 6 |
| 60-batch-transaction-spec.md | 5 |
| 44-layer2-policy-bypass-attacks.md | 4 |
| 45-layer3-killswitch-recovery-attacks.md | 4 |
| 62-action-provider-architecture.md | 2 |
| 58-contract-call-spec.md | 2 |

**총 122건** 용어 치환 + 문맥 검토 (단순 치환이 아닌 문장 자연스러움 확인).

### 10. 테스트 파일 (47개)

코드 변경에 따라 자동으로 동기화. 테스트 명세의 "agent" 문자열도 "wallet"으로 갱신.

### 11. README.md

프로젝트 README의 "agent" 용어 갱신 + v1.4.2 시점의 프로젝트 현황 반영:

- "agent" → "wallet" 용어 치환 (5건)
- API 예시 코드의 엔드포인트/필드명 갱신
- 기능 목록에 v1.4~v1.4.1에서 추가된 내용 반영 (토큰 전송, EVM 지원 등)

---

## 기술 결정 사항

| # | 결정 항목 | 결정 | 근거 |
|---|----------|------|------|
| 1 | 새 엔티티 이름 | `wallet` | 서비스명(WaaS)과 일치, 가장 직관적. "account"는 너무 추상적 |
| 2 | API 버전 | v1 유지 (breaking change) | v1.4.2는 아직 외부 소비자 없음 (self-hosted 내부 사용). API v2 불필요 |
| 3 | DB 마이그레이션 | 증분 마이그레이션 | v1.4 Phase 76에서 구축한 마이그레이션 러너 활용. 테이블 재생성으로 컬럼명 변경 |
| 4 | `/v1/wallet/*` 세션 경로 | Phase 계획 시 확정 | 세션 기반 단일 지갑 접근(현재 `/v1/wallet/balance`)을 유지할지, `/v1/wallets/{id}/*`로 통합할지는 Phase 설계 시 결정 |
| 5 | 설계 문서 갱신 | 코드와 동시 | 코드 변경과 문서 변경을 같은 phase에서 수행하여 불일치 방지 |
| 6 | 하위 호환 shim | 제공하지 않음 | 외부 배포 전이므로 deprecated alias 불필요. 깔끔하게 일괄 변경 |

---

## 영향 범위 요약

| 카테고리 | 항목 수 |
|----------|---------|
| DB 테이블 | 1 (`agents` → `wallets`) |
| DB 컬럼 (FK) | 5 (`agent_id` → `wallet_id`) |
| DB 인덱스 | 7 |
| REST 엔드포인트 | 6~9 (통합 여부에 따라) |
| Zod 스키마 | 16 |
| TypeScript 파일 | ~106 |
| Python 파일 | 4 |
| 에러 코드 | 3 + 도메인 1 |
| MCP/CLI | ~11 파일 |
| 환경변수 | 3 |
| Config 키 | 1 |
| Admin UI | 1 페이지 + 컴포넌트 |
| 설계 문서 | 12 (122건) |
| 테스트 파일 | 47 |
| README.md | 1 (용어 + 현황 갱신) |

---

## E2E 검증 시나리오

**자동화 비율: 100% -- `[HUMAN]` 0건**

### 코드 변경 검증

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | "agent" 잔존 검사 | `grep -r 'agent' packages/` 결과에서 의도적 잔존(AI agent 설명 등) 외 0건 assert | [L0] |
| 2 | 기존 전체 테스트 통과 | `pnpm test` 895+ 테스트 전수 통과 assert | [L0] |
| 3 | Wallet CRUD 동작 | `POST /v1/wallets` → 201, `GET /v1/wallets` → 200 + walletId 필드 존재 assert | [L0] |
| 4 | DB 마이그레이션 정상 | v1.4.1 DB → 마이그레이션 실행 → `wallets` 테이블 존재 + 기존 데이터 보존 assert | [L0] |
| 5 | OpenAPI 스펙 일관성 | `GET /doc` → 모든 스키마에서 `agentId` 0건, `walletId` 존재 assert | [L0] |
| 6 | SDK 필드명 변경 | TS SDK `BalanceResponse.walletId` 존재, Python SDK `wallet_id` 존재 assert | [L0] |
| 7 | MCP 도구 동작 | MCP 서버 `WalletContext` 기반 도구 6개 정상 응답 assert | [L0] |
| 8 | CLI `--wallet` 플래그 | `waiaas mcp setup --wallet <id>` 정상 동작 assert | [L0] |
| 9 | Admin UI Wallets 페이지 | `/admin` → Wallets 탭 렌더링 + API 호출 정상 assert | [L0] |
| 10 | Config 키 변경 | `max_sessions_per_wallet` 파싱 정상 + 기존 `max_sessions_per_agent` 거부 assert | [L0] |

### 설계 문서 검증

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 11 | 설계 문서 용어 일관성 | 12개 문서에서 "agent" → "wallet" 치환 완료 + 문맥 자연스러움 검토 | [L0] |
| 12 | 코드-문서 일치 | 설계 문서의 API 경로/스키마명이 실제 코드와 일치 assert | [L0] |
| 13 | README 용어 + 현황 갱신 | README.md에서 "agent" 0건 (의도적 제외 외) + API 예시 경로/필드명 코드 일치 assert | [L0] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.4 (토큰 + 컨트랙트 확장) | 코드 변경 완료 후 용어 변경해야 merge conflict 최소화 |
| v1.4.1 (EVM 지갑 인프라) | EVM 관련 코드에서도 agent 용어 사용. 모든 기능 코드 완성 후 일괄 변경 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 대규모 rename으로 인한 누락 | 일부 파일에서 agent 잔존 시 런타임 에러 | `grep` 전수 검사 + 전체 테스트 통과 필수. 타입 에러로 컴파일 타임에 대부분 검출 |
| 2 | DB 마이그레이션 실패 | 기존 데이터 손실 | 마이그레이션 트랜잭션 내 실행. 실패 시 자동 롤백. 마이그레이션 전 백업 권장 |
| 3 | MCP 토큰 파일 경로 변경 | 기존 `mcp-tokens/<agentId>` 파일과 호환 불가 | 마이그레이션 시 파일 경로 자동 rename 또는 하위 호환 폴백 |
| 4 | 설계 문서 문맥 왜곡 | 단순 치환 시 문장이 부자연스러울 수 있음 | 기계적 치환 후 문맥별 수동 검토 |

---

*최종 업데이트: 2026-02-12 신규 작성. 코드베이스 용어 감사 결과 기반 — 106 TS 파일, 47 테스트 파일, 12 설계 문서(122건) 영향 확인*
