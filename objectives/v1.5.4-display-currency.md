# 마일스톤 v1.5.4: 표시 통화 (Display Currency)

## 목표

Admin UI, 알림, API 응답에서 USD 외에 사용자가 선호하는 법정 통화(KRW, EUR, JPY 등)로 자산 가치와 정책 임계값을 환산 표시할 수 있는 상태. 정책 평가 자체는 USD로 수행하되, 표시 레이어에서 환율을 적용한다. Admin Settings 페이지에서 표시 통화를 변경할 수 있다.

---

## 배경

v1.5에서 USD 기준 정책 평가가 도입되지만, 한국/일본/유럽 등 비영어권 Owner는 USD 금액의 체감이 어렵다:

```
현재: "월렛 agent-1이 3.33 SOL ($500)을 전송했습니다"
개선: "월렛 agent-1이 3.33 SOL (₩725,000)을 전송했습니다"
```

정책 평가 로직은 변경하지 않고, **표시 레이어에서만 환율 변환**을 적용하여 DX를 개선한다.

---

## 핵심 원칙

- **평가는 USD, 표시만 변환**: 정책 엔진은 항상 USD로 평가. 환율 변동이 정책 결과에 영향을 주지 않음
- **Zero-config 동작**: Pyth forex 피드로 환율 조회 (API 키 불필요). CoinGecko 활성 시 직접 통화 조회 가능
- **Fallback**: 환율 조회 실패 시 USD 그대로 표시 (기능 저하 없음)

---

## 지원 통화

Pyth forex 피드(142쌍)와 CoinGecko vs_currencies(46개)의 교집합 기반으로 43개 법정 통화를 지원한다.

### 1차 지원 (주요 통화)

| 통화 | 코드 | Pyth FX | CoinGecko |
|------|------|---------|-----------|
| 미국 달러 | USD | - (기본) | O |
| 한국 원 | KRW | USD/KRW | O |
| 일본 엔 | JPY | USD/JPY | O |
| 유로 | EUR | EUR/USD | O |
| 영국 파운드 | GBP | GBP/USD | O |
| 중국 위안 | CNY | USD/CNY | O |
| 캐나다 달러 | CAD | USD/CAD | O |
| 호주 달러 | AUD | AUD/USD | O |
| 스위스 프랑 | CHF | USD/CHF | O |
| 싱가포르 달러 | SGD | USD/SGD | O |
| 홍콩 달러 | HKD | USD/HKD | O |
| 인도 루피 | INR | USD/INR | O |

### 2차 지원 (지역 통화)

| 통화 | 코드 | Pyth FX | CoinGecko |
|------|------|---------|-----------|
| 대만 달러 | TWD | USD/TWD | O |
| 태국 바트 | THB | USD/THB | O |
| 말레이시아 링깃 | MYR | USD/MYR | O |
| 인도네시아 루피아 | IDR | USD/IDR | O |
| 필리핀 페소 | PHP | USD/PHP | O |
| 베트남 동 | VND | USD/VND | O |
| 브라질 헤알 | BRL | USD/BRL | O |
| 멕시코 페소 | MXN | USD/MXN | O |
| 칠레 페소 | CLP | USD/CLP | O |
| 터키 리라 | TRY | USD/TRY | O |
| 폴란드 즐로티 | PLN | USD/PLN | O |
| 체코 코루나 | CZK | USD/CZK | O |
| 헝가리 포린트 | HUF | USD/HUF | O |
| 스웨덴 크로나 | SEK | USD/SEK | O |
| 노르웨이 크로네 | NOK | USD/NOK | O |
| 덴마크 크로네 | DKK | USD/DKK | O |
| 뉴질랜드 달러 | NZD | NZD/USD | O |
| 남아공 랜드 | ZAR | USD/ZAR | O |
| 이스라엘 셰켈 | ILS | USD/ILS | O |
| 사우디 리얄 | SAR | USD/SAR | O |
| UAE 디르함 | AED | USD/AED | O |
| 쿠웨이트 디나르 | KWD | USD/KWD | O |
| 바레인 디나르 | BHD | USD/BHD | O |
| 나이지리아 나이라 | NGN | USD/NGN | O |
| 러시아 루블 | RUB | USD/RUB | O |
| 우크라이나 흐리브냐 | UAH | USD/UAH | O |
| 파키스탄 루피 | PKR | USD/PKR | O |
| 방글라데시 타카 | BDT | - | O |
| 스리랑카 루피 | LKR | - | O |
| 미얀마 챗 | MMK | - | O |
| 조지아 라리 | GEL | - | O |

**총 43개 법정 통화** 지원. Pyth 미지원 통화(BDT, LKR, MMK, GEL)는 CoinGecko 활성 시에만 지원.

---

## 구현 대상

### 설정

기본값은 config.toml, 런타임 변경은 Admin Settings:

```toml
[display]
currency = "USD"   # 기본값
```

환경변수: `WAIAAS_DISPLAY_CURRENCY=KRW`

Admin Settings에서 변경 시 SettingsService를 통해 hot-reload 즉시 반영. 기존 default deny 토글(v1.4.7)과 동일한 패턴.

### Admin Settings 통화 선택 UI

| 항목 | 내용 |
|------|------|
| 위치 | Admin Settings 페이지 > Display 섹션 |
| UI | 드롭다운(검색 가능). 통화 코드 + 이름 + 기호 표시 (예: "KRW - 한국 원 (₩)") |
| 적용 | 선택 즉시 hot-reload. 페이지 새로고침 없이 모든 금액 표시 갱신 |
| 현재 환율 | 드롭다운 옆에 현재 환율 미리보기 표시 (예: "1 USD = ₩1,450") |

### 환율 서비스 (ForexRateService)

| 항목 | 내용 |
|------|------|
| 인터페이스 | `getRate(from: "USD", to: CurrencyCode): Promise<ForexRate>` |
| Primary 소스 | Pyth Hermes forex 피드 (Zero-config, 38쌍 이상) |
| Fallback 소스 | CoinGecko vs_currencies (opt-in, 46개 통화) |
| 캐시 | 기존 InMemoryPriceCache 재사용. 환율 TTL: 30분 (forex는 crypto보다 변동폭 작음) |
| 장애 시 | 환율 조회 실패 → USD 그대로 표시 (표시 기능 저하, 정책 영향 없음) |

### 적용 범위

| 위치 | 변환 대상 | 예시 |
|------|----------|------|
| Admin 대시보드 | 자산 잔고, 총 자산 가치 | SOL: 12.5 (₩1,875,000) |
| Admin 정책 폼 | USD 임계값 옆에 환산 표시 | instant_max_usd: $10 (≈₩14,500) |
| Admin 트랜잭션 | 트랜잭션 금액 | 3.33 SOL (≈₩725,000) |
| Admin Settings | 통화 드롭다운 + 환율 미리보기 | 1 USD = ₩1,450 |
| 알림 메시지 | 전송/정책 위반 금액 | "≈₩725,000 상당의 SOL 전송" |
| REST API 응답 | `display_amount` 필드 (opt-in) | `"display_amount": "≈₩725,000"` |
| MCP 도구 응답 | 금액 표시 | 환산 금액 포함 |

### 통화 포매팅

`Intl.NumberFormat` API를 활용하여 locale 기반 자동 포매팅:

| 통화 | 포맷 | 예시 |
|------|------|------|
| KRW | ₩#,### (소수점 없음) | ≈₩725,000 |
| JPY | ¥#,### (소수점 없음) | ≈¥75,000 |
| USD | $#,###.## | $500.00 |
| EUR | €#,###.## | ≈€465.50 |
| GBP | £#,###.## | ≈£395.25 |

USD 외 통화는 환율 환산 근사치이므로 "≈" 접두사를 붙인다.

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | 환율 소스 | Pyth forex Primary + CoinGecko Fallback | v1.5 오라클 구조와 동일한 패턴. Pyth forex는 키 불필요, 142쌍 지원 |
| 2 | 환율 캐시 TTL | 30분 | Forex는 crypto 대비 변동폭이 작음. 5분은 과도, 1시간은 부정확할 수 있음 |
| 3 | 포매팅 | Intl.NumberFormat | Node.js 내장 API, 외부 의존성 없음. locale별 천 단위 구분자/소수점/통화 기호 자동 처리 |
| 4 | API 응답 포함 여부 | display_amount 필드 opt-in | 기본 응답은 USD 유지 (하위 호환). `?display_currency=KRW` 쿼리 파라미터 또는 config 기반 자동 포함 |
| 5 | 설정 변경 방식 | SettingsService + Admin UI | 기존 Settings 인프라(v1.4.4) 재사용. config.toml은 초기값, Admin에서 런타임 오버라이드 |

---

## E2E 검증 시나리오

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | Admin Settings에서 KRW 선택 → 전체 UI 원화 표시 | Settings 드롭다운 KRW 선택 → 대시보드 잔고 ₩ 표시 assert | [L0] |
| 2 | Admin Settings 변경 → hot-reload 즉시 반영 | USD→KRW 변경 → 페이지 새로고침 없이 금액 갱신 assert | [L0] |
| 3 | 환율 조회 성공 → 알림에 환산 금액 포함 | mock ForexRate(USD/KRW=1450) + SOL 전송 알림 → "≈₩725,000" 포함 assert | [L0] |
| 4 | 환율 조회 실패 → USD 그대로 표시 (graceful fallback) | mock forex 실패 + 알림 → "$500.00" 표시 assert | [L0] |
| 5 | display_currency=JPY → ¥ 기호 + 소수점 없음 포맷 | config JPY + 환산 표시 → "≈¥75,000" 포맷 assert | [L0] |
| 6 | display_currency=EUR → € 기호 + 소수점 2자리 포맷 | config EUR + 환산 표시 → "≈€465.50" 포맷 assert | [L0] |
| 7 | 정책 폼에 USD 임계값 + 환산 동시 표시 | instant_max_usd=10 입력 → 옆에 "(≈₩14,500)" 표시 assert | [L0] |
| 8 | REST API ?display_currency=KRW → display_amount 필드 포함 | GET /v1/wallets/:id/transactions?display_currency=KRW → display_amount 필드 assert | [L0] |
| 9 | Pyth forex 미지원 통화(BDT) + CoinGecko 활성 → 정상 환산 | Settings BDT 선택 + CoinGecko 키 설정 → 환산 표시 assert | [L0] |
| 10 | Pyth forex 미지원 통화(BDT) + CoinGecko 미활성 → USD fallback + 안내 | Settings BDT 선택 + CoinGecko 미설정 → USD 표시 + "CoinGecko API 키 필요" 안내 assert | [L0] |
| 11 | 통화 드롭다운에 환율 미리보기 표시 | Settings 드롭다운 KRW 선택 → "1 USD = ₩1,450" 미리보기 assert | [L0] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.5 (DeFi + 가격 오라클) | IPriceOracle, InMemoryPriceCache, Pyth Hermes 인프라가 v1.5에서 구현됨. ForexRateService가 동일 캐시/HTTP 인프라를 재사용 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | Pyth forex 시장 시간 제한 | FX 피드는 미국 동부 시간 기준 시장 시간에만 갱신. 주말/공휴일에 stale 가능 | 마지막 유효 환율을 캐시에서 사용 (forex 30분 TTL이지만 시장 휴장 시 연장). 표시 용도이므로 약간의 지연 허용 |
| 2 | 환율 변동으로 표시 금액 혼란 | 같은 트랜잭션이 시점에 따라 다른 원화 금액으로 표시될 수 있음 | 트랜잭션 목록은 기록 시점 환율 사용 (amount_usd × 당시 환율). 실시간 잔고는 현재 환율 사용. "≈" 접두사로 근사치임을 명시 |
| 3 | 초인플레이션 통화 (VEF, ARS) | 환율이 급격히 변동하여 표시 금액이 비현실적일 수 있음 | 표시 전용이므로 정책 평가에 영향 없음. 환율 갱신 주기(30분)로 자연 대응 |

---

*최종 업데이트: 2026-02-15 v1.5 USD 정책 평가의 다국어 DX 개선을 위해 신규 생성. Admin Settings 통화 선택 UI 포함. Pyth forex 142쌍 + CoinGecko 46개 통화 기반 43개 법정 통화 지원.*
