# 마일스톤 v2.1.2: 지갑 앱 알림 채널

## 목표

D'CENT 등 WAIaaS SDK 통합 지갑 앱에서 **모든 알림을 수신**할 수 있는 상태. Telegram 없이 지갑 앱 하나로 알림 수신 + 승인/거부까지 완결되는 UX를 제공한다.

---

## 배경

### v2.1.1 이후 남은 갭

v2.1.1에서 D'CENT 지갑은 **승인 요청(SignRequest)**만 수신할 수 있다. 트랜잭션 완료, 정책 위반, 세션 이벤트 등 일반 알림은 여전히 기존 알림 시스템(Telegram/Slack/ntfy 등)을 통해 별도로 수신해야 한다.

| 기능 | v2.1.1 | v2.1.2 |
|------|--------|--------|
| 승인/거부 요청 수신 | 지갑 앱 (ntfy) | 지갑 앱 (ntfy) |
| 일반 알림 수신 | Telegram/Slack 등 별도 채널 | **지갑 앱 (ntfy)** |
| Telegram 없이 운영 가능 | 승인만 가능 | **모든 기능 가능** |

### 목표 UX

```
D'CENT 지갑 앱 하나로:
  ✓ 트랜잭션 승인/거부 (v2.1.1)
  ✓ 트랜잭션 완료 알림
  ✓ 정책 위반 알림
  ✓ 세션 생성/만료 알림
  ✓ Kill Switch 발동 알림
  ✓ 시스템 상태 알림
```

---

## 구현 대상

### 알림 메시지 프로토콜

Wallet SDK에 `NotificationMessage` 스키마를 추가한다. 기존 `SignRequest`/`SignResponse`와 동일한 패턴:

```typescript
const NotificationMessageSchema = z.object({
  version: z.literal('1'),
  type: z.literal('notification'),
  notificationId: z.string().uuid(),
  category: z.enum([
    'transaction_completed',    // 트랜잭션 완료 (CONFIRMED/FAILED)
    'transaction_pending',      // 트랜잭션 대기 중 (PENDING_APPROVAL/DELAYED)
    'policy_violation',         // 정책 위반으로 차단
    'session_event',            // 세션 생성/만료/갱신
    'security_alert',           // Kill Switch, 비정상 활동 감지
    'system',                   // 데몬 상태, 업데이트 등
  ]),
  title: z.string(),            // 짧은 제목 (푸시 알림 헤더)
  body: z.string(),             // 상세 내용
  metadata: z.record(z.string()).optional(),  // 카테고리별 추가 정보
  walletId: z.string().uuid(),
  timestamp: z.string().datetime(),
});
```

### ntfy 토픽 구조

```
waiaas-sign-{walletId}        → 서명 요청 (v2.1.1, 기존)
waiaas-notify-{walletId}      → 일반 알림 (v2.1.2, 신규)
```

두 토픽을 분리하여 지갑 앱이 선택적으로 구독할 수 있도록 한다. 서명 요청은 높은 우선순위(ntfy priority 5), 일반 알림은 보통 우선순위(ntfy priority 3)로 전송.

### 컴포넌트

| 컴포넌트 | 위치 | 내용 |
|----------|------|------|
| WalletNotificationChannel | daemon | 기존 알림 시스템에 지갑 ntfy 채널 추가. 알림 이벤트 발생 시 `waiaas-notify-{walletId}` 토픽에 `NotificationMessage` publish |
| NotificationMessage 스키마 | wallet-sdk | `NotificationMessageSchema` Zod 스키마 + TypeScript 타입 |
| subscribeToNotifications() | wallet-sdk | ntfy 알림 토픽을 SSE로 구독. 새 알림 수신 시 콜백 호출 |
| parseNotification() | wallet-sdk | ntfy 메시지에서 `NotificationMessage` 추출 + Zod 검증 |

### 데몬 알림 시스템 확장

기존 알림 발행 흐름에 지갑 채널을 추가한다:

```
알림 이벤트 발생
  → NotificationService.notify()
    → 기존 채널 (Telegram/Slack/ntfy/Discord/Webhook)  ← 변경 없음
    → WalletNotificationChannel (신규)
      → 해당 walletId의 owner_approval_method가 sdk_ntfy인 경우
      → waiaas-notify-{walletId} 토픽에 NotificationMessage publish
```

### Wallet SDK 추가 API

```typescript
// 알림 구독 (지갑 앱 백그라운드)
subscribeToNotifications(
  walletId: string,
  serverUrl?: string,     // self-hosted ntfy URL (기본: https://ntfy.sh)
  callback: (notification: NotificationMessage) => void
): () => void;            // unsubscribe 함수 반환

// 알림 파싱
parseNotification(data: string): NotificationMessage;
```

### config.toml

```toml
[signing_sdk]
# 기존 설정 유지 (v2.1.1)

[signing_sdk.notifications]
enabled = true                              # 지갑 앱 알림 채널 활성화
topic_prefix = "waiaas-notify"              # 알림 토픽 접두어
categories = ["transaction_completed", "policy_violation", "security_alert"]
                                            # 지갑에 전송할 알림 카테고리 (기본: 전체)
```

### 파일/모듈 구조

```
packages/daemon/src/services/
  notification/
    channels/
      wallet-notification-channel.ts    # 지갑 ntfy 알림 채널 (신규)

packages/wallet-sdk/src/
  schemas.ts                            # NotificationMessageSchema 추가
  notifications.ts                      # subscribeToNotifications(), parseNotification()
  index.ts                              # 공개 API에 알림 함수 추가
```

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | 토픽 분리 | sign 토픽과 notify 토픽 분리 | 서명 요청은 긴급(즉시 응답 필요), 알림은 정보성. ntfy priority 차등 적용. 지갑 앱이 선택적 구독 가능 |
| 2 | 알림 대상 | owner_approval_method가 sdk_ntfy인 지갑만 | 기존 알림 채널과 중복 방지. SDK 지갑을 사용하는 Owner만 지갑 알림 수신 |
| 3 | 카테고리 필터링 | config에서 전송 카테고리 설정 | 모든 알림을 지갑에 보내면 과다 알림. Owner가 중요 카테고리만 선택 |
| 4 | 기존 알림 병행 | 기존 채널과 동시 발행 | 지갑 알림은 추가 채널. 기존 Telegram/Slack 설정이 있으면 양쪽 모두 수신 |

---

## E2E 검증 시나리오

**자동화 비율: 100%**

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | 트랜잭션 완료 → 지갑 알림 | TX CONFIRMED + wallet(sdk_ntfy) → waiaas-notify-{walletId} publish assert | [L0] |
| 2 | 정책 위반 → 지갑 알림 | 정책 차단 + wallet(sdk_ntfy) → category='policy_violation' 알림 assert | [L0] |
| 3 | 세션 만료 → 지갑 알림 | 세션 TTL 만료 + wallet(sdk_ntfy) → category='session_event' 알림 assert | [L0] |
| 4 | Kill Switch → 지갑 알림 | Kill Switch 발동 → category='security_alert' 알림 assert (priority 5) | [L0] |
| 5 | SDK subscribeToNotifications → 콜백 | mock ntfy SSE → subscribeToNotifications(walletId, cb) → 콜백에 NotificationMessage 전달 assert | [L0] |
| 6 | SDK parseNotification → 검증 | parseNotification(valid) → NotificationMessage 정상 파싱 assert | [L0] |
| 7 | 비SDK 지갑 → 알림 미전송 | wallet(walletconnect) → waiaas-notify 토픽 publish 없음 assert | [L0] |
| 8 | 카테고리 필터링 | categories=['security_alert'] 설정 → transaction_completed 미전송 assert | [L0] |
| 9 | 기존 알림 채널 병행 | Telegram + sdk_ntfy 동시 설정 → 양쪽 모두 수신 assert | [L0] |
| 10 | 알림 비활성화 | notifications.enabled=false → 지갑 알림 미전송 + 기존 채널 정상 assert | [L0] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v2.1.1 (Wallet Signing SDK) | @waiaas/wallet-sdk 패키지, ntfy 토픽 구조, owner_approval_method 인프라 |
| v1.3.4 (알림 이벤트) | NotificationService 이벤트 발행 인프라 재사용 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 알림 과다 | 지갑 앱에 너무 많은 푸시 알림 → UX 저하 | config 카테고리 필터링으로 Owner가 수신 범위 제어. 기본값은 중요 카테고리만 |
| 2 | ntfy 토픽 증가 | 지갑 수 × 2 토픽 (sign + notify) | ntfy는 토픽 수 제한 없음. self-hosted 시 무제한 |
| 3 | 기존 채널과 중복 알림 | 같은 이벤트가 Telegram + 지갑 양쪽에 도착 | 의도된 동작. 사용자가 기존 채널을 비활성화하면 지갑만 수신 |

---

## 예상 규모

| 항목 | 예상 |
|------|------|
| 페이즈 | 1개 |
| 신규 파일 | 2-3개 (데몬 채널 1 + SDK 함수 1-2) |
| 수정 파일 | 3-4개 (NotificationService, SDK index/schemas, config loader) |
| 테스트 | 10개 |
| DB 마이그레이션 | 없음 |

---

*생성일: 2026-02-15*
*선행: v2.1.1 (WAIaaS Wallet Signing SDK)*
