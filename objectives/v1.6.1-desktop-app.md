# 마일스톤 v1.6.1: Tauri Desktop App

## 목표

Tauri 2 기반 데스크탑 앱으로 WAIaaS 데몬을 GUI에서 관리할 수 있는 상태. Sidecar로 데몬 바이너리를 내장하고, 8개 화면(대시보드, 거래 목록/상세, 에이전트 관리, 정책 관리, 세션 관리, 설정, Kill Switch)에서 전체 기능을 조작할 수 있다. WalletConnect를 통해 Owner 지갑 연결 및 SIWS/SIWE 서명을 수행한다.

---

## 구현 대상 설계 문서

| 문서 | 이름 | 구현 범위 | 전체/부분 |
|------|------|----------|----------|
| 39 | tauri-desktop-architecture | Tauri 2 Desktop App 전체: Rust Backend(IPC Command Layer 12개 커맨드, Sidecar Manager, 시스템 트레이 3색 상태 아이콘), WebView Frontend(React 18 + TailwindCSS 4, 8개 화면), Setup Wizard 5단계(패스워드 설정 → 체인 선택 → 에이전트 생성 → Owner 연결(선택) → 완료), WalletConnect @reown/appkit Tauri 통합(QR 페어링 → 세션 → SIWS/SIWE 서명 → Owner 등록) | 전체 |

### v1.6에서 이미 구현된 부분 (v1.6.1에서 활용)

- Kill Switch KillSwitchService (3-state 상태 머신, 6-step cascade, dual-auth 복구) -- v1.6에서 구현
- AutoStop Engine AutoStopService (5 규칙 기반 자동 정지) -- v1.6에서 구현
- Telegram Bot 연동 (Long Polling, 명령 수신) -- v1.6에서 구현
- Docker 배포 -- v1.6에서 구현
- REST API 38+ 엔드포인트 전체 (v1.3에서 완성)
- @waiaas/sdk TypeScript SDK (v1.3에서 구현)
- 세션 인증(sessionAuth), 마스터 인증(masterAuth), Owner 인증(ownerAuth) -- v1.2에서 구현

### v1.6.1에서 새로 추가하는 부분

- Tauri 2 Desktop App (Rust Backend + WebView Frontend)
- Sidecar Manager (Node.js SEA 바이너리 관리, crash detection, graceful 종료)
- 시스템 트레이 (3색 상태 아이콘: 녹=정상, 주황=경고, 빨강=정지, 컨텍스트 메뉴)
- Setup Wizard 5단계 (초기 설정 GUI 흐름)
- WalletConnect @reown/appkit Tauri 통합 (QR 페어링, SIWS/SIWE 서명)
- 8개 Desktop 화면 (대시보드, 거래 목록, 거래 상세, 에이전트 관리, 정책 관리, 세션 관리, 설정, Kill Switch)

---

## 산출물

### 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| Desktop App | Tauri 2 (Rust + WebView). Rust Backend: Sidecar Manager(Node.js SEA 바이너리 시작/종료/crash detection, graceful shutdown 5초 타임아웃 후 SIGKILL), IPC Command Layer(12개 커맨드: get_daemon_status, get_agents, get_agent, create_agent, get_transactions, get_transaction, send_transaction, create_session, list_sessions, get_policies, activate_kill_switch, recover_kill_switch), 시스템 트레이(3색 상태 아이콘 + 컨텍스트 메뉴: Open Dashboard/Pause/Resume/Quit) |
| Dashboard 화면 | 에이전트 수, 활성 세션, 24h 거래 수, Kill Switch 상태 카드. 최근 거래 5건 목록. 데몬 상태(uptime, DB 크기, 체인 연결 상태). 30초 자동 갱신 |
| 거래 목록 화면 | 전체 거래 페이지네이션 목록(20건/페이지). 필터: 상태(CONFIRMED/FAILED/PENDING), 에이전트, 날짜 범위. 거래 클릭 → 거래 상세 |
| 거래 상세 화면 | 거래 전체 정보: 금액, 수신자, 상태, 타임스탬프, 체인 txHash(블록 익스플로러 링크). 정책 평가 결과, 스테이지별 처리 시간 |
| 에이전트 관리 화면 | 에이전트 목록 + 생성/편집. 에이전트별 상태, 세션 수, 24h 거래 수 표시. Owner 상태(NONE/GRACE/LOCKED) 배지 |
| 정책 관리 화면 | 에이전트별 정책 CRUD. 정책 타입별 폼: DAILY_LIMIT(금액), TX_LIMIT(금액), WHITELIST(주소 목록), CONTRACT_WHITELIST(주소 목록). 정책 우선순위 시각화 |
| 세션 관리 화면 | 에이전트별 세션 목록. 만료 시간, 생성 시간, 상태(active/expired/revoked). 세션 취소 버튼 |
| 설정 화면 | config.toml 현재 값 읽기전용 표시. 마스터 패스워드 변경 폼. Owner 지갑 연결(WalletConnect QR 팝업) |
| Kill Switch 화면 | 현재 Kill Switch 상태 표시(ACTIVE/SUSPENDED/LOCKED). 긴급 정지 버튼(확인 다이얼로그). 복구 버튼(Owner 서명 + Master 패스워드 입력). 이력 표시 |
| Setup Wizard | 5단계: (1)마스터 패스워드 설정 (2)체인 선택(Solana/EVM/Both) (3)첫 에이전트 이름+생성 (4)Owner 지갑 연결(WalletConnect, "나중에" 스킵 가능) (5)완료 요약+대시보드 이동 |
| WalletConnect | @reown/appkit Tauri 통합. QR 코드 페어링 → WalletConnect 세션 → SIWS(Solana)/SIWE(EVM) 서명 요청 → Owner 등록 API 호출. Phantom/Backpack(Solana), MetaMask/Rainbow(EVM) 지원 |

### 다국어(i18n) 적용

Desktop UI는 config.toml `locale` 설정에 따라 영문/한글을 지원한다.

#### 적용 범위

**Desktop UI:**
- 8개 화면 전체의 UI 텍스트 (헤더, 버튼, 라벨, 상태 배지, 에러 메시지)
- Setup Wizard 5단계 안내 텍스트
- Kill Switch 확인 다이얼로그 텍스트
- 시스템 트레이 컨텍스트 메뉴 라벨

**영문 고정 (i18n 미적용):**
- Rust Backend IPC 에러 (개발자 디버깅용)
- Sidecar Manager 로그 (console.error)
- config.toml 키 이름, 환경변수

#### 적용 방식

- React Context + useLocale 훅으로 메시지 키 참조
- `@waiaas/core/i18n` 메시지 키 구조 활용
- 별도 i18n 프레임워크(react-intl 등) 미사용, 메시지 키 직접 참조로 단순화

#### 언어별 예시

| 컴포넌트 | 키 | 영문 (en) | 한글 (ko) |
|----------|-----|----------|----------|
| Desktop | DASHBOARD_TITLE | Dashboard | 대시보드 |
| Desktop | AGENT_STATUS_ACTIVE | Active | 활성 |
| Desktop | KILLSWITCH_CONFIRM | ⚠️ Activate Kill Switch? | ⚠️ Kill Switch를 발동하시겠습니까? |
| Desktop | WIZARD_STEP1_TITLE | Set Master Password | 마스터 패스워드 설정 |
| Desktop | TRAY_OPEN | Open Dashboard | 대시보드 열기 |

### 파일/모듈 구조

```
apps/desktop/
  src-tauri/
    src/
      main.rs                            # Tauri 메인 + 시스템 트레이
      commands/
        mod.rs                           # IPC 커맨드 12개
      sidecar/
        manager.rs                       # Sidecar Manager (SEA 바이너리 관리)
    Cargo.toml
    tauri.conf.json
  src/
    App.tsx                              # React 루트
    pages/
      Dashboard.tsx                      # 대시보드
      Transactions.tsx                   # 거래 목록
      TransactionDetail.tsx              # 거래 상세
      Agents.tsx                         # 에이전트 관리
      Policies.tsx                       # 정책 관리
      Sessions.tsx                       # 세션 관리
      Settings.tsx                       # 설정
      KillSwitch.tsx                     # Kill Switch
    components/
      SetupWizard/                       # 5단계 Setup Wizard
      WalletConnect/                     # @reown/appkit 통합
      Layout/                            # 사이드바, 헤더
    hooks/
      useLocale.ts                       # i18n 훅
      useDaemon.ts                       # IPC 통신 훅
    i18n/
      en.ts                              # 영문 메시지
      ko.ts                              # 한글 메시지
  package.json
  vite.config.ts
```

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | Tauri 2 + React 18 번들러 | Vite (Tauri 기본) | Tauri 2 공식 템플릿이 Vite 기반. HMR 지원으로 개발 효율성. React 18과 네이티브 통합 |
| 2 | TailwindCSS 4 설정 | JIT 모드 + 커스텀 디자인 토큰 | TailwindCSS 4는 JIT 기본. 커스텀 색상(상태 녹/주/빨), 간격, 폰트 토큰 정의. Tauri WebView에서 CSS 성능 최적화 |
| 3 | WalletConnect 라이브러리 | @reown/appkit (Tauri 바인딩) | WalletConnect v2 공식 SDK. Tauri WebView 환경에서 QR 코드 페어링 + 서명 요청 지원. 호환성 검증은 스파이크에서 수행 |
| 4 | Sidecar Node.js SEA 빌드 | esbuild single-file -> node --experimental-sea-config | esbuild로 단일 .cjs 파일 번들 -> Node.js SEA config로 바이너리 생성 -> postject로 Tauri sidecar에 주입. v0.7 prebuildify 전략과 연동(native addon은 사전 빌드 바이너리 포함) |
| 5 | Desktop i18n | React Context + `@waiaas/core/i18n` 메시지 키 참조 | v1.1에서 정의한 i18n 구조 활용. React Context + useLocale 훅. 별도 i18n 프레임워크(react-intl 등) 미사용, 메시지 키 직접 참조로 단순화 |

---

## E2E 검증 시나리오

**자동화 비율: 70%+ -- `[HUMAN]` 5건**

### Sidecar Manager

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | Sidecar 시작 -> 데몬 health check 성공 | Desktop 앱 실행 -> Sidecar Manager가 SEA 바이너리 시작 -> GET /health 200 assert | [L1] |
| 2 | Sidecar crash detection -> 자동 재시작 | 데몬 프로세스 강제 종료 -> Sidecar Manager crash 감지 -> 자동 재시작 -> health check 성공 assert | [L1] |
| 3 | Sidecar graceful shutdown(5초 타임아웃) | Desktop 앱 종료 -> SIGTERM 전송 -> 5초 내 정상 종료 assert. 미종료 시 SIGKILL assert | [L1] |

### Desktop 화면

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 4 | 대시보드 -> 통계 카드 + 최근 거래 표시 | 에이전트 2개 + 거래 5건 생성 -> Dashboard 페이지 -> 에이전트 수, 거래 수, Kill Switch 상태 표시 assert | [L1] |
| 5 | 거래 목록 -> 필터 + 페이지네이션 | 거래 30건 생성 -> Transactions 페이지 -> 20건 표시 + 다음 페이지 클릭 -> 10건 표시 assert | [L1] |
| 6 | 거래 상세 -> 전체 정보 + 익스플로러 링크 | 거래 1건 CONFIRMED -> TransactionDetail 페이지 -> txHash, 금액, 상태, 스테이지 시간 표시 assert | [L1] |
| 7 | 에이전트 생성 -> 목록 반영 | Agents 페이지 -> 에이전트 생성 폼 -> 제출 -> 목록에 새 에이전트 표시 assert | [L1] |
| 8 | 정책 CRUD -> 에이전트별 정책 관리 | Policies 페이지 -> DAILY_LIMIT 정책 생성 -> 편집 -> 삭제 -> 목록 반영 assert | [L1] |
| 9 | 세션 목록 -> 세션 취소 | Sessions 페이지 -> 활성 세션 표시 -> 취소 버튼 클릭 -> 세션 revoked assert | [L1] |
| 10 | Kill Switch 화면 -> 긴급 정지 + 복구 | KillSwitch 페이지 -> 긴급 정지 버튼 -> 확인 다이얼로그 -> SUSPENDED 전환 assert -> 복구 버튼 -> dual-auth -> ACTIVE 복구 assert | [L1] |

### Setup Wizard

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 11 | Wizard 5단계 전체 흐름 완료 | 앱 최초 실행 -> 패스워드 설정 -> 체인 선택(Solana) -> 에이전트 생성 -> Owner 스킵 -> 완료 -> 대시보드 이동 assert | [L1] |
| 12 | Wizard Owner 연결(WalletConnect) | 4단계에서 WalletConnect QR 표시 -> 지갑 연결 -> SIWS 서명 -> Owner 등록 성공 assert | [L1] |

### Desktop UI/UX (HUMAN)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 13 | 대시보드 + 거래 목록 반응성 | 다양한 화면 크기(1280x720, 1920x1080)에서 레이아웃 깨짐 없음, 사이드바 축소/확장, 테이블 스크롤 확인 | [HUMAN] |
| 14 | Setup Wizard 사용자 경험 | 5단계 흐름이 직관적인지, 각 단계 입력이 명확한지, "나중에" 스킵이 눈에 띄는지, 진행 표시줄 적절성 확인 | [HUMAN] |
| 15 | Kill Switch 확인 다이얼로그 경고성 | 긴급 정지 버튼 클릭 시 충분히 경고하는지, 실수 방지가 되는지 확인 | [HUMAN] |
| 16 | 시스템 트레이 아이콘 가시성 | 3색 아이콘(녹/주/빨)이 macOS/Windows/Linux 시스템 트레이에서 명확히 구분되는지 확인 | [HUMAN] |
| 17 | WalletConnect QR 코드 흐름 | QR 코드 표시 -> 모바일 지갑 스캔 -> 연결 확인 -> 서명 요청 -> 완료 흐름이 자연스러운지 확인 | [HUMAN] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.6 (운영 인프라) | Kill Switch, AutoStop가 v1.6에서 구현. Desktop 화면에서 이들 기능을 표시/조작하므로 v1.6 완료 필요 |
| v1.5 (DeFi + 가격 오라클) | 정책 관리 화면에서 USD 기준 한도 표시, Action Provider MCP 도구 Desktop 표시 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | Node.js SEA 크로스 플랫폼 빌드 | macOS(arm64/x64), Windows(x64), Linux(x64) 3개 타겟. native addon(sodium-native, better-sqlite3) 플랫폼별 바이너리 필요 | v0.7 prebuildify 전략 활용. CI에서 3 플랫폼 빌드 매트릭스. 로컬 개발은 현재 플랫폼만 빌드 |
| 2 | Tauri 2 + @reown/appkit 호환성 | Tauri WebView 환경에서 WalletConnect가 정상 동작하지 않을 수 있음 | 스파이크: Tauri WebView에서 @reown/appkit QR 페어링 테스트. 실패 시 대안: WebSocket 직접 연결 또는 딥링크 방식 |
| 3 | Desktop UI/UX 수동 테스트 비중 | 자동화 70%이나 UI/UX 검증은 수동([HUMAN] 5건) | UI 컴포넌트 단위 테스트(Vitest + Testing Library)로 보완. HUMAN 시나리오는 릴리스 전 체크리스트로 관리 |
| 4 | Setup Wizard 초기 설정 복잡도 | 5단계가 너무 많으면 사용자 이탈 가능 | 각 단계 최소 입력(패스워드, 체인 선택, 에이전트 이름). Owner 연결은 "나중에" 스킵 가능. 진행 표시줄로 현재 단계 시각화 |

---

*최종 업데이트: 2026-02-11 v1.6에서 분리하여 생성. Desktop App 전체(Tauri 2, Sidecar, Setup Wizard, WalletConnect, 8개 화면)를 독립 마일스톤으로 구성. 설계 문서 39 참조*
