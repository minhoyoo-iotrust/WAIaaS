# 마일스톤 v1.5.3: 누적 USD 지출 한도

## 목표

월렛 단위로 기간별(일/월) 누적 USD 지출을 추적하여, 건별 정책을 우회하는 분할 전송을 방지하는 상태.

---

## 배경

v1.5에서 건별 USD 정책 평가가 도입되지만, 한도 미만 소액을 반복 전송하면 누적 지출이 의도한 한도를 초과할 수 있다:

```
instant_max_usd: $10

$9 SOL 전송 → INSTANT ✓
$9 USDC 전송 → INSTANT ✓
$9 BONK 전송 → INSTANT ✓
합계 $27 — 건별로는 모두 통과
```

누적 한도는 토큰 종류와 무관하게 **기간 내 총 USD 지출**을 제한하여 이 문제를 해결한다.

---

## 구현 대상

### SpendingLimitRuleSchema 확장

기존 건별 필드(v1.5)에 누적 필드를 추가한다:

```json
{
  "type": "SPENDING_LIMIT",
  "instant_max_usd": 10,
  "notify_max_usd": 100,
  "delay_max_usd": 1000,
  "daily_limit_usd": 500,
  "monthly_limit_usd": 5000
}
```

| 필드 | 설명 |
|------|------|
| daily_limit_usd | 24시간 롤링 윈도우 내 누적 USD 지출 상한 |
| monthly_limit_usd | 30일 롤링 윈도우 내 누적 USD 지출 상한 |

### 핵심 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| 누적 추적 | 월렛별 기간 내 USD 지출 합산. transactions 테이블에서 CONFIRMED/SIGNED 상태 트랜잭션의 amount_usd를 집계 |
| 정책 평가 통합 | DatabasePolicyEngine Stage 3에서 건별 평가 후 누적 평가 추가. 건별 OK + 누적 초과 시 APPROVAL로 격상 |
| reserved_amount 연동 | 대기 중(PENDING/DELAYED) 트랜잭션의 USD 환산 금액도 누적에 포함하여 이중 지출 방지 |
| Admin UI | 정책 폼에 daily_limit_usd / monthly_limit_usd 입력 필드 추가. 현재 누적 사용량 표시 |

### 누적 한도 초과 시 동작

기존 4-tier 보안 모델과 일관되게, 누적 한도 초과 시 **무조건 거부가 아닌 APPROVAL 격상**으로 처리한다. Owner에게 판단 기회를 제공한다.

```
1. 건별 USD 평가 → tier_per_tx (INSTANT/NOTIFY/DELAY/APPROVAL)
2. 누적 USD 평가:
   - 기간 내 누적 + 현재 건 USD > daily_limit_usd → APPROVAL로 격상
   - 기간 내 누적 + 현재 건 USD > monthly_limit_usd → APPROVAL로 격상
3. 최종 tier = max(tier_per_tx, tier_cumulative)
```

예시 (daily_limit_usd: $500, 현재 누적 $480):

| 요청 | 예상 누적 | 건별 결과 | 누적 결과 | 최종 |
|------|----------|----------|----------|------|
| $15 전송 | $495 | INSTANT | 한도 내 | INSTANT |
| $30 전송 | $510 | INSTANT | 한도 초과 | **APPROVAL** |

### Owner의 선택지

누적 한도 초과 알림을 받은 Owner는 세 가지 대응이 가능하다:

1. **건별 승인** — Admin UI/API에서 해당 트랜잭션만 승인하여 실행
2. **한도 상향** — daily_limit_usd / monthly_limit_usd 값을 조정 (hot-reload 즉시 반영)
3. **거부** — 트랜잭션 거부

### 오라클 장애 시

- 현재 건의 USD 환산 실패 → 누적 평가 스킵, 건별 네이티브 금액 평가만 수행 (v1.5 graceful fallback 동일)
- 과거 트랜잭션 amount_usd는 트랜잭션 시점에 기록되므로 누적 합산에는 영향 없음

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.5 (DeFi + 가격 오라클) | IPriceOracle, resolveEffectiveAmountUsd(), SpendingLimitRuleSchema USD 필드가 v1.5에서 구현됨 |

---

## 산출물 요약

| 항목 | 내용 |
|------|------|
| DB | transactions 테이블에 amount_usd 컬럼 추가 (트랜잭션 시점 USD 환산 금액 기록) |
| 정책 스키마 | daily_limit_usd, monthly_limit_usd 필드 |
| 정책 엔진 | 누적 USD 집계 쿼리 + APPROVAL 격상 로직 |
| Admin UI | 누적 한도 설정 폼 + 현재 사용량 표시 + 한도 상향 기능 |
| SDK/MCP | 정책 생성 시 누적 필드 지원 |
| 알림 | 누적 한도 80% 도달 시 경고 알림, 초과 시 APPROVAL 대기 알림 |

---

## E2E 검증 시나리오

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | 일별 누적 한도 내 → 건별 평가 유지 | daily_limit_usd=$500, 누적 $400 + $50 전송 → 건별 INSTANT 유지 assert | [L0] |
| 2 | 일별 누적 한도 초과 → APPROVAL 격상 | daily_limit_usd=$500, 누적 $480 + $30 전송 → APPROVAL 격상 assert | [L0] |
| 3 | 월별 누적 한도 초과 → APPROVAL 격상 | monthly_limit_usd=$5000, 누적 $4900 + $200 전송 → APPROVAL 격상 assert | [L0] |
| 4 | 일별+월별 동시 설정 → 더 엄격한 쪽 적용 | daily=$500, monthly=$5000, 일 누적 $490 + $20 → 일별 초과 → APPROVAL assert | [L0] |
| 5 | Owner 승인 후 실행 → 누적에 반영 | APPROVAL 격상 → Owner 승인 → CONFIRMED → 누적 합산에 포함 assert | [L0] |
| 6 | Owner 한도 상향 → hot-reload 즉시 반영 | daily_limit_usd $500→$1000 변경 → 다음 요청에서 새 한도 적용 assert | [L0] |
| 7 | PENDING 트랜잭션 reserved_amount 포함 | $400 PENDING + $150 요청 → 예상 누적 $550 → APPROVAL 격상 assert | [L0] |
| 8 | 24시간 롤링 윈도우 → 오래된 건 제외 | 25시간 전 $300 + 현재 $400 → 누적 $400 (25시간 전 건 제외) assert | [L0] |
| 9 | 오라클 장애 → 누적 평가 스킵 → 건별 네이티브 fallback | 오라클 실패 + 전송 → 누적 미평가 + 건별 네이티브 평가만 수행 assert | [L0] |
| 10 | 누적 80% 도달 → 경고 알림 발송 | daily=$500, 누적 $400 ($9 전송으로 $409 도달) → 80% 경고 알림 assert | [L0] |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | 누적 집계 쿼리 성능 | 트랜잭션 수가 많아지면 기간 내 SUM 쿼리 비용 증가 | transactions 테이블에 (wallet_id, created_at, amount_usd) 복합 인덱스 추가. 롤링 윈도우 집계를 인메모리 캐시로 최적화 가능 |
| 2 | 과거 트랜잭션 USD 미기록 | v1.5.3 이전 트랜잭션에는 amount_usd가 없음 | NULL 허용, 누적 집계에서 NULL 제외. 마이그레이션 시 과거 데이터 백필은 선택사항 |
| 3 | 타임존/윈도우 기준 | "일별"의 기준 시점이 모호 | 24시간/30일 롤링 윈도우(UTC) 사용. 고정 날짜 기준이 아닌 슬라이딩 윈도우로 구현 |

---

*최종 업데이트: 2026-02-15 v1.5 건별 USD 정책의 분할 전송 우회 문제 해결을 위해 신규 생성. 4-tier 보안 모델과 일관되게 누적 초과 시 APPROVAL 격상 방식 채택.*
