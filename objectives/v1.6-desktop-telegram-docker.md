# 마일스톤 v1.6: Desktop + Telegram Bot + Docker

## 목표

Owner가 데스크톱 앱이나 Telegram으로 거래를 관리하고, Docker로 원클릭 배포가 가능한 상태.

---

## 구현 대상 설계 문서

이 마일스톤에서 구현하는 설계 문서 목록과 각 문서에서 구현할 범위를 명시한다.

| 문서 | 이름 | 구현 범위 | 전체/부분 |
|------|------|----------|----------|
| 39 | tauri-desktop-architecture | Tauri 2 + React 18 + TailwindCSS 4 Desktop 앱 전체. Rust Backend: Sidecar Manager(데몬 프로세스 spawn/kill/crash detection max 3x 재시작/35초 graceful 종료 SIGTERM->30초 대기->SIGKILL), System Tray(3색 상태 아이콘 정상=녹색/대기=주황/긴급=빨강 + 컨텍스트 메뉴 대시보드 열기/로그 보기/종료), IPC Commands(invoke handlers), Notification Bridge(OS 네이티브 알림 전달), Auto Updater(CrabNebula/GitHub). WebView Frontend: React 18 SPA + TailwindCSS 4 + @waiaas/sdk(HTTP localhost 호출) + @reown/appkit(WalletConnect QR). 8개 화면(Dashboard, 거래 목록, 거래 상세, 에이전트 관리, 정책 관리, 세션 관리, 설정, Kill Switch). Setup Wizard 5단계(마스터 패스워드 설정->체인 선택->에이전트 생성->Owner 연결->완료). Sidecar: Node.js SEA 바이너리(waiaas-daemon), esbuild single-file->node --experimental-sea-config. WalletConnect: @reown/appkit Tauri 통합, QR 코드 페어링, SIWS/SIWE 서명 요청 | 전체 |
| 40 | telegram-bot-docker | Telegram Bot: TelegramBotService(Long Polling getUpdates, 5초 폴링 간격, 오프셋 기반), 9개 명령어(/start, /status, /pending, /approve, /reject, /killswitch, /agents, /newsession, /help), 인라인 키보드(Approve/Reject 버튼, 에이전트 선택 키보드, Kill Switch 확인 대화), 2-Tier 인증(관리자=ownerAuth 대리: chatId 등록+승인 권한, 읽기전용=chatId 등록+조회만), native fetch 전용(외부 Bot 프레임워크 미사용). Docker: Multi-stage Dockerfile(builder: node:22-slim+pnpm install+turbo build, runner: node:22-slim+non-root UID 1001), docker-compose.yml(daemon 서비스+named volume ~/.waiaas 데이터 영속+HEALTHCHECK curl /v1/health), Docker Secrets+_FILE 패턴(마스터 패스워드, Telegram Bot Token), 포트 매핑 3100:3100(localhost only) | 전체 |
| 36 | killswitch-autostop-evm | Kill Switch: KillSwitchService 3-state 상태 머신(ACTIVE/SUSPENDED/LOCKED), 6-step cascade(세션 무효화->진행 중 거래 중단->에이전트 전체 정지->API 503 잠금->알림 발송->감사 로그 기록), dual-auth 복구(Owner SIWS/SIWE 서명+Master 패스워드 Argon2id 검증->ACTIVE 전환), 4전이 CAS ACID 패턴(ACTIVE->SUSPENDED, SUSPENDED->LOCKED, SUSPENDED->ACTIVE, LOCKED->ACTIVE), Kill Switch API(POST /v1/owner/kill-switch ownerAuth, POST /v1/admin/kill-switch masterAuth). AutoStop Engine: AutoStopService 5 규칙(DAILY_SPENDING_LIMIT 초과, CONSECUTIVE_FAILURES 5회 연속 실패, UNUSUAL_ACTIVITY 이상 패턴, IDLE_TIMEOUT 유휴 시간 초과, MANUAL_TRIGGER 수동 트리거), 이벤트 기반 트리거(TransactionCompleted/TransactionFailed/AgentActivity 이벤트 구독), 규칙별 에이전트 정지 또는 Kill Switch 자동 발동. EVM 어댑터 부분은 v1.4에서 이미 구현 완료 | 부분 (Kill Switch + AutoStop만, EVM 어댑터 제외) |

### v0.10 설계 결정 반영

v0.10에서 확정된 설계 결정을 v1.6 구현에 반영한다:

| 결정 ID | 내용 | 적용 범위 |
|---------|------|----------|
| CONC-03 | Kill Switch 4전이 CAS ACID 패턴: SQLite BEGIN IMMEDIATE + UPDATE WHERE state = expected 조건으로 동시성 제어. 4개 전이 모두 WHERE value = :expectedCurrentState 조건 포함. 두 요청 동시 도착 시 하나만 성공, 나머지 409 반환 | KillSwitchService 상태 전이 전체, ACTIVE->SUSPENDED/SUSPENDED->LOCKED/SUSPENDED->ACTIVE/LOCKED->ACTIVE |

### 구현 범위 상세

#### v1.4/v1.5에서 이미 구현된 부분 (v1.6에서 활용)

- EVM 어댑터 (viem 2.x, EIP-1559, ERC-20, gas 추정, nonce 관리) -- v1.4에서 구현
- REST API 38 엔드포인트 전체 (v1.3에서 완성)
- @waiaas/sdk TypeScript SDK (v1.3에서 구현)
- MCP Server 6+3 도구/리소스 + Action 도구 (v1.3+v1.5에서 구현)
- 세션 인증(sessionAuth), 마스터 인증(masterAuth), Owner 인증(ownerAuth) -- v1.2에서 구현
- DatabasePolicyEngine 4-tier 정책 평가 -- v1.2에서 구현
- 알림 아키텍처 INotificationChannel, TelegramChannel(알림 발송 전용) -- v1.3에서 구현
- Owner API approve/reject, sessions, status 엔드포인트 -- v1.2에서 구현

#### v1.6에서 새로 추가하는 부분

- Tauri 2 Desktop 앱 전체 (Rust Backend + WebView Frontend + 8개 화면)
- Sidecar Manager (Node.js SEA 바이너리 관리, crash detection, graceful 종료)
- 시스템 트레이 (3색 상태 아이콘, 컨텍스트 메뉴)
- Setup Wizard 5단계 (초기 설정 GUI 흐름)
- WalletConnect @reown/appkit Tauri 통합 (QR 페어링, SIWS/SIWE 서명)
- TelegramBotService (Long Polling, 명령 수신, 인라인 키보드 인터랙션)
- Kill Switch KillSwitchService (3-state 상태 머신, 6-step cascade, dual-auth 복구)
- AutoStop Engine AutoStopService (5 규칙 기반 자동 정지)
- Docker 배포 (Multi-stage Dockerfile, docker-compose, named volume, Secrets)

---

## 산출물

### 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| Desktop App | Tauri 2 + React 18 + TailwindCSS 4. Rust Backend(src-tauri/): Sidecar Manager, System Tray, IPC Commands, Notification Bridge, Auto Updater. WebView Frontend(src/): React 18 SPA, @waiaas/sdk HTTP localhost 호출, @reown/appkit WalletConnect QR. Vite 번들러(Tauri 기본). 8개 화면 각각의 UI 컴포넌트와 API 연동 |
| Dashboard 화면 | 잔액 요약(네이티브+토큰, getAssets() API), 최근 거래 목록(GET /v1/transactions?limit=10), 에이전트 상태 카드(GET /v1/agents), 시스템 상태 배너(GET /v1/health + kill_switch 상태). 5초 주기 자동 갱신 |
| 거래 목록 화면 | 전체 거래 목록(페이지네이션 커서 기반), 상태별 필터(QUEUED/EXECUTING/CONFIRMED/FAILED), 타입별 필터(TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH), 날짜 범위 필터 |
| 거래 상세 화면 | 트랜잭션 상태 타임라인(8-state 시각화), 파이프라인 단계별 로그, 체인 탐색기 링크(Solscan/Etherscan), APPROVAL 대기 시 승인/거부 버튼(ownerAuth SIWS/SIWE 서명) |
| 에이전트 관리 화면 | 에이전트 목록(상태/체인/세션 수 표시), 에이전트 생성 폼(name/chain/allowedChains), 에이전트 상세(세션 목록, 정책 목록, 잔액), 에이전트 삭제(확인 대화상자) |
| 정책 관리 화면 | 에이전트별 정책 목록(PolicyType 10개 표시), 정책 생성 폼(타입 선택->동적 rules 입력), 정책 수정/삭제, SPENDING_LIMIT USD 임계값 시각화 |
| 세션 관리 화면 | 에이전트별 활성 세션 목록(만료 시간, 남은 시간 표시), 세션 해지 버튼(개별/전체), 세션 제약 조건 표시(allowedOperations, maxAmount) |
| 설정 화면 | config.toml 주요 설정 표시(읽기전용), 마스터 패스워드 변경, 알림 채널 설정(Telegram Bot Token, Discord Webhook URL), 체인 RPC 엔드포인트 표시 |
| Kill Switch 화면 | 현재 Kill Switch 상태(ACTIVE/SUSPENDED/LOCKED) 대형 상태 표시, 긴급 정지 버튼(확인 대화상자 2단계: "정말 실행하시겠습니까?" + "모든 거래가 중단됩니다"), 복구 버튼(dual-auth: Owner 서명 + Master 패스워드 입력), 최근 Kill Switch 이벤트 로그 |
| Sidecar | Node.js SEA(Single Executable Application) 바이너리. esbuild single-file 빌드 -> node --experimental-sea-config -> postject inject. waiaas-daemon sidecar 프로세스. Sidecar Manager: spawn()/kill() 프로세스 관리, crash detection(exit code != 0 감지, max 3회 재시작, 3회 초과 시 에러 상태), 35초 graceful 종료(SIGTERM 전송 -> 30초 대기 -> WAL 체크포인트 완료 확인 -> 30초 초과 시 SIGKILL). 5초 주기 health check(GET /v1/health) |
| 시스템 트레이 | 3색 상태 아이콘: 녹색=정상(데몬 실행 중+에이전트 활성), 주황=대기(APPROVAL 대기 거래 있음 또는 DELAY 쿨다운), 빨강=긴급(Kill Switch SUSPENDED/LOCKED 또는 데몬 비정상). 컨텍스트 메뉴: 대시보드 열기, 로그 보기(~/.waiaas/logs/ 디렉토리 열기), 종료(graceful 종료 확인) |
| Setup Wizard | 5단계 초기 설정 흐름. Step 1: 마스터 패스워드 설정(8자 이상, 강도 표시기, 확인 입력). Step 2: 체인 선택(Solana/Ethereum 다중 선택, RPC 엔드포인트 자동 감지 또는 수동 입력). Step 3: 첫 에이전트 생성(이름/체인/설명 입력, POST /v1/agents 호출). Step 4: Owner 연결(선택적, WalletConnect QR 표시 또는 "나중에" 스킵). Step 5: 완료 요약(생성된 에이전트 주소 표시, 데이터 디렉토리 경로, 다음 단계 안내) |
| WalletConnect | @reown/appkit Tauri 통합. WalletConnect Relay(wss://relay.walletconnect.com) E2E 암호화 연결. QR 코드 페어링(모바일 지갑 스캔). SIWS(Sign In With Solana)/SIWE(Sign In With Ethereum) 서명 요청 -> Owner 인증. Approve/Reject 트랜잭션 서명 요청 -> Owner 승인 흐름 |
| Telegram Bot | TelegramBotService: TelegramChannel(NOTI-ARCH) 확장. Long Polling(getUpdates, 5초 폴링 간격, 오프셋 기반, 네트워크 단절 시 지수 백오프 재연결). 2-Tier 인증: 관리자(chat_id 등록 + ownerAuth 대리 + 승인/거부/killswitch 권한), 읽기전용(chat_id 등록 + 조회만). 9개 명령어: /start(봇 시작+chat_id 등록), /status(데몬 상태+에이전트 요약), /pending(대기 중 거래 목록), /approve {txId}(거래 승인), /reject {txId}(거래 거부), /killswitch(긴급 정지 발동), /agents(에이전트 목록), /newsession(새 세션 발급+에이전트 선택 인라인 키보드), /help(명령어 도움말). 인라인 키보드: Approve/Reject 버튼(callback_query 처리), 에이전트 선택 키보드(/newsession용), Kill Switch 확인 대화("정말 실행하시겠습니까?" Yes/No). MarkdownV2 포매팅 |
| Kill Switch | KillSwitchService: 3-state 상태 머신(ACTIVE=정상/SUSPENDED=일시 정지/LOCKED=영구 잠금). 6-step cascade: (1)세션 전체 무효화(revoked_at 일괄 갱신) -> (2)진행 중 거래 중단(QUEUED/EXECUTING -> CANCELLED) -> (3)에이전트 전체 정지(status=SUSPENDED) -> (4)API 503 잠금(killSwitch 미들웨어 SYSTEM_LOCKED 반환) -> (5)알림 발송(INotificationChannel.send KILL_SWITCH_ACTIVATED) -> (6)감사 로그 기록(audit_logs 테이블). 4전이 CAS ACID: BEGIN IMMEDIATE + UPDATE WHERE state=expected, 동시 요청 하나만 성공/나머지 409. dual-auth 복구: SUSPENDED->ACTIVE = Owner 서명(SIWS/SIWE) + Master 패스워드(Argon2id), LOCKED->ACTIVE = 동일 dual-auth + 추가 대기 시간 |
| AutoStop Engine | AutoStopService: 5 규칙 기반 자동 정지. DAILY_SPENDING_LIMIT(에이전트별 일일 지출 한도 초과 -> 에이전트 정지), CONSECUTIVE_FAILURES(5회 연속 트랜잭션 실패 -> 에이전트 정지), UNUSUAL_ACTIVITY(정상 패턴 대비 이상 감지 -> 에이전트 정지 + 알림), IDLE_TIMEOUT(설정 시간 이상 유휴 -> 세션 해지), MANUAL_TRIGGER(수동 트리거 -> Kill Switch 발동). 이벤트 기반: TransactionCompleted/TransactionFailed/AgentActivity 이벤트 구독, EventEmitter 패턴 |
| Docker | Multi-stage Dockerfile: builder 스테이지(FROM node:22-slim, pnpm install --frozen-lockfile, turbo build --filter=@waiaas/daemon), runner 스테이지(FROM node:22-slim, COPY --from=builder, non-root UID 1001 useradd waiaas, EXPOSE 3100). docker-compose.yml: daemon 서비스(build: ., ports: "127.0.0.1:3100:3100", volumes: waiaas-data:/home/waiaas/.waiaas, restart: unless-stopped, healthcheck: curl -f http://localhost:3100/v1/health). named volume(waiaas-data -> ~/.waiaas 데이터 영속, restart 후 데이터 유지). Docker Secrets + _FILE 패턴(MASTER_PASSWORD_FILE, TELEGRAM_BOT_TOKEN_FILE). HEALTHCHECK(interval 30s, timeout 5s, retries 3) |

### 다국어(i18n) 적용

Desktop UI와 Telegram Bot은 사람이 직접 보는 인터페이스이므로, config.toml `locale` 설정에 따라 영문/한글을 지원한다.

#### 적용 범위

**Desktop UI (React 18):**
- 8개 화면의 모든 UI 텍스트 (제목, 레이블, 버튼, 상태 표시, 안내 문구)
- Setup Wizard 5단계 텍스트 (단계 제목, 입력 레이블, 안내 문구, 에러 메시지)
- 시스템 트레이 컨텍스트 메뉴 (대시보드 열기, 로그 보기, 종료)
- OS 알림 제목/본문 (Notification Bridge)
- 확인 대화상자 (Kill Switch 2단계 확인, 에이전트 삭제 확인 등)

**Telegram Bot:**
- 9개 명령어 응답 메시지 (MarkdownV2 포매팅)
- 인라인 키보드 버튼 레이블 (Approve/Reject, Yes/No, 에이전트 선택)
- /start 환영 메시지, /help 도움말 텍스트
- Kill Switch 확인 대화 ("정말 실행하시겠습니까?")
- 에러/권한 거부 메시지 (읽기전용 사용자 승인 시도 등)

**영문 고정 (i18n 미적용):**
- 로그 메시지 (console.error, Sidecar Manager 로그)
- Rust Backend IPC 에러 (개발자 디버깅용)
- Docker 헬스체크 로그
- config.toml 키 이름, 환경변수

#### 적용 방식

**Desktop:**
- `@waiaas/core/i18n`의 메시지 키를 React i18n 훅(`useLocale()`)으로 참조
- App 초기화 시 config.toml `locale` 값 로드 → 전체 앱에 Context 주입
- 메시지 키 예시: `DASHBOARD_TITLE`, `SETUP_STEP1_TITLE`, `KILLSWITCH_CONFIRM_MSG`, `TRAY_OPEN_DASHBOARD`

**Telegram Bot:**
- TelegramBotService 초기화 시 `locale` 주입
- 명령어 응답 생성 시 `getMessages(locale)` 함수로 메시지 템플릿 로드
- MarkdownV2 포매팅은 언어와 독립 (포맷 계층은 동일, 텍스트만 교체)
- 메시지 키 예시: `BOT_WELCOME`, `BOT_STATUS_HEADER`, `BOT_KILLSWITCH_CONFIRM`, `KEYBOARD_APPROVE`, `KEYBOARD_REJECT`

#### 언어별 예시

| 컴포넌트 | 키 | 영문 (en) | 한글 (ko) |
|----------|-----|----------|----------|
| Dashboard | DASHBOARD_TITLE | Dashboard | 대시보드 |
| Setup Wizard | SETUP_STEP1_TITLE | Set Master Password | 마스터 패스워드 설정 |
| Kill Switch | KILLSWITCH_CONFIRM_MSG | Are you sure? All transactions will be stopped. | 정말 실행하시겠습니까? 모든 거래가 중단됩니다. |
| System Tray | TRAY_OPEN_DASHBOARD | Open Dashboard | 대시보드 열기 |
| Telegram | BOT_WELCOME | Welcome to WAIaaS Bot! | WAIaaS Bot에 오신 것을 환영합니다! |
| Telegram | KEYBOARD_APPROVE | ✅ Approve | ✅ 승인 |
| Telegram | BOT_KILLSWITCH_CONFIRM | ⚠️ Activate Kill Switch? | ⚠️ Kill Switch를 발동하시겠습니까? |

### 파일/모듈 구조

```
apps/desktop/                        # Tauri Desktop 앱
  src-tauri/
    src/
      main.rs                        # Tauri 앱 엔트리포인트
      sidecar.rs                     # Sidecar Manager (spawn/kill/health)
      tray.rs                        # System Tray (3색 아이콘 + 메뉴)
      ipc.rs                         # IPC Command handlers
      notification.rs                # OS Notification Bridge
    tauri.conf.json                  # Tauri 설정 (capabilities, sidecar)
    Cargo.toml
  src/
    App.tsx                          # React 앱 루트
    pages/
      Dashboard.tsx                  # 대시보드 화면
      TransactionList.tsx            # 거래 목록
      TransactionDetail.tsx          # 거래 상세
      AgentManagement.tsx            # 에이전트 관리
      PolicyManagement.tsx           # 정책 관리
      SessionManagement.tsx          # 세션 관리
      Settings.tsx                   # 설정
      KillSwitch.tsx                 # Kill Switch
    components/
      SetupWizard/                   # 5단계 Setup Wizard
      WalletConnect/                 # @reown/appkit 통합
      InlineApproval/                # 거래 승인/거부 UI
    i18n/
      useLocale.ts                   # i18n React 훅 (@waiaas/core/i18n 래퍼)
    hooks/
      useWaiaas.ts                   # @waiaas/sdk 래퍼 훅
      useSidecar.ts                  # Sidecar 상태 훅
      useTray.ts                     # 트레이 상태 훅
    package.json
    vite.config.ts
    tailwind.config.ts

packages/daemon/src/
  services/
    killswitch/
      killswitch-service.ts          # KillSwitchService (3-state + 6-step + CAS)
      autostop-service.ts            # AutoStopService (5 규칙)
      autostop-rules.ts              # 개별 규칙 구현
  infrastructure/
    telegram/
      telegram-bot-service.ts        # TelegramBotService (Long Polling + 9 명령어)
      telegram-commands.ts           # 명령어 핸들러 (start/status/pending/...)
      telegram-keyboard.ts           # 인라인 키보드 빌더
      telegram-auth.ts               # 2-Tier 인증 (관리자/읽기전용)
  middleware/
    killswitch-guard.ts              # Kill Switch 503 미들웨어

docker/
  Dockerfile                         # Multi-stage Dockerfile
  docker-compose.yml                 # compose 설정
  .dockerignore                      # 빌드 컨텍스트 제외
```

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | Tauri 2 + React 18 번들러 | Vite (Tauri 기본) | Tauri 2 공식 템플릿이 Vite 기반. HMR 지원으로 개발 효율성. React 18과 네이티브 통합 |
| 2 | TailwindCSS 4 설정 | JIT 모드 + 커스텀 디자인 토큰 | TailwindCSS 4는 JIT 기본. 커스텀 색상(상태 녹/주/빨), 간격, 폰트 토큰 정의. Tauri WebView에서 CSS 성능 최적화 |
| 3 | WalletConnect 라이브러리 | @reown/appkit (Tauri 바인딩) | WalletConnect v2 공식 SDK. Tauri WebView 환경에서 QR 코드 페어링 + 서명 요청 지원. 호환성 검증은 v1.6 스파이크에서 수행 |
| 4 | Telegram Bot 라이브러리 | native fetch 전용 (프레임워크 미사용) | NOTI-ARCH(문서 35) 결정: 외부 Bot 프레임워크(telegraf/grammy) 불필요. Telegram Bot API는 단순 HTTP 호출이므로 native fetch로 충분. Long Polling getUpdates + sendMessage + answerCallbackQuery 3개 API만 사용 |
| 5 | Docker base 이미지 | node:22-slim | alpine 대비 native addon(sodium-native, better-sqlite3) 호환성 우수. glibc 기반으로 prebuildify 바이너리 직접 사용 가능. slim으로 불필요한 패키지 제거하여 이미지 크기 최소화 |
| 6 | Sidecar Node.js SEA 빌드 | esbuild single-file -> node --experimental-sea-config | esbuild로 단일 .cjs 파일 번들 -> Node.js SEA config로 바이너리 생성 -> postject로 Tauri sidecar에 주입. v0.7 prebuildify 전략과 연동(native addon은 사전 빌드 바이너리 포함) |
| 7 | Kill Switch CAS 구현 | SQLite BEGIN IMMEDIATE + UPDATE WHERE state = expected | v0.10 CONC-03 결정. SQLite 단일 writer 특성 활용. BEGIN IMMEDIATE로 즉시 write lock 획득. WHERE 조건으로 현재 상태 확인. affected rows=0이면 이미 전이됨 -> 409 반환 |
| 8 | AutoStop 규칙 저장 | config.toml [autostop] 섹션 | 규칙 임계값은 정적 설정(daily_spending_limit_usd, consecutive_failures_max 등). 런타임 변경 빈도 낮음. policies 테이블은 에이전트별 트랜잭션 정책 전용이므로 혼용 방지 |
| 9 | Desktop/Telegram i18n | `@waiaas/core/i18n` 메시지 키 참조 | v1.1에서 정의한 i18n 구조 활용. Desktop은 React Context + useLocale 훅, Telegram은 서비스 초기화 시 locale 주입. 별도 i18n 프레임워크(react-intl 등) 미사용, 메시지 키 직접 참조로 단순화 |

---

## E2E 검증 시나리오

**자동화 비율: 70%+ -- `[HUMAN]` 7건**

### Docker

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | docker compose up -> health check -> SDK 거래 성공 | docker compose up -d -> HEALTHCHECK 통과 대기 -> @waiaas/sdk로 SOL 전송 -> CONFIRMED assert | [L1] |
| 2 | named volume 영속성 -- restart 후 데이터 유지 | docker compose up -> 에이전트 생성 -> docker compose down -> docker compose up -> 에이전트 조회 성공 assert | [L1] |
| 3 | non-root UID 1001 -- 프로세스 권한 확인 | docker compose exec daemon whoami -> waiaas assert + id -u -> 1001 assert | [L0] |
| 4 | Docker Secrets _FILE 패턴 -- 시크릿 파일에서 환경변수 로드 | docker secret create + compose secrets 설정 -> 데몬 시작 시 MASTER_PASSWORD_FILE 읽기 성공 assert | [L1] |
| 5 | HEALTHCHECK 실패 시 컨테이너 unhealthy 상태 | 데몬 프로세스 강제 종료 -> docker inspect healthcheck.status -> unhealthy assert | [L1] |

### Kill Switch

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 6 | Kill Switch cascade: ACTIVE->SUSPENDED -> 세션 무효화 + 거래 중단 + API 503 | POST /v1/admin/kill-switch -> 세션 조회 전체 revoked assert + QUEUED 거래 CANCELLED assert + 일반 API 503 assert | [L0] |
| 7 | Kill Switch SUSPENDED->LOCKED -> 복구 불가 상태 | SUSPENDED 상태에서 LOCK 전이 -> LOCKED 상태에서 일반 복구 시도 실패 assert (dual-auth + 추가 대기 필요) | [L0] |
| 8 | Kill Switch 복구: dual-auth(Owner서명 + Master패스워드) -> ACTIVE 전환 | SUSPENDED 상태 -> POST /v1/admin/recover (ownerAuth + masterAuth) -> ACTIVE 전환 + API 정상 동작 재개 assert | [L0] |
| 9 | Kill Switch CAS 동시성: 두 요청 동시 전이 -> 하나만 성공 | Promise.all([killswitch(), killswitch()]) -> 하나 200 + 하나 409 assert + DB 상태 일관성 assert | [L0] |
| 10 | Kill Switch 4전이 전수: 각 전이별 CAS 정상 동작 | ACTIVE->SUSPENDED, SUSPENDED->LOCKED, SUSPENDED->ACTIVE(복구), LOCKED->ACTIVE(복구) 4가지 전이 각각 테스트 + WHERE 조건 assert | [L0] |
| 11 | Kill Switch 잘못된 전이 시도 -> 409 거부 | ACTIVE에서 직접 LOCKED 시도 -> 409 assert, LOCKED에서 SUSPENDED 시도 -> 409 assert | [L0] |

### AutoStop Engine

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 12 | DAILY_SPENDING_LIMIT 초과 -> 에이전트 자동 정지 | daily_spending_limit_usd=100 설정 + $110 거래 완료 이벤트 -> 에이전트 status=SUSPENDED assert | [L0] |
| 13 | CONSECUTIVE_FAILURES(5회) -> 에이전트 자동 정지 | 5회 연속 TransactionFailed 이벤트 발생 -> 에이전트 status=SUSPENDED + 알림 mock 수신 assert | [L0] |
| 14 | UNUSUAL_ACTIVITY 이상 패턴 -> 에이전트 정지 + 알림 | 정상 패턴 대비 10배 빈도 거래 시뮬레이션 -> 에이전트 정지 + UNUSUAL_ACTIVITY 알림 assert | [L0] |
| 15 | IDLE_TIMEOUT 유휴 시간 초과 -> 세션 해지 | idle_timeout=60 설정 + 120초 무활동 -> 세션 자동 해지 assert | [L0] |

### Sidecar

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 16 | 데몬 프로세스 crash -> 자동 재시작 (max 3회) | sidecar 프로세스 kill -9 -> Sidecar Manager 재시작 감지 -> health check 복구 assert (3회 반복) | [L1] |
| 17 | 35초 graceful 종료 -> SIGTERM + WAL 체크포인트 | sidecar 종료 요청 -> SIGTERM 전송 확인 -> WAL 체크포인트 완료 로그 확인 -> 프로세스 종료 assert | [L1] |
| 18 | crash 3회 초과 -> 재시작 중단 + 에러 상태 | 4회 연속 crash -> Sidecar Manager 재시작 중단 + 트레이 빨강 아이콘 상태 assert | [L1] |

### Telegram Bot

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 19 | /status -> 데몬 상태 + 에이전트 요약 반환 | mock Telegram Bot API -> /status 명령 전송 -> sendMessage 호출 파라미터에 데몬 상태 + 에이전트 수 포함 assert | [L0] |
| 20 | /pending -> 대기 중 거래 목록 반환 | APPROVAL 대기 거래 2건 생성 -> /pending 명령 -> 거래 목록 + 인라인 키보드(Approve/Reject) 포함 sendMessage assert | [L0] |
| 21 | /approve {txId} -> 거래 승인 + 상태 전이 | APPROVAL 대기 거래 -> /approve TX-001 명령 -> masterAuth 대리 승인 -> 거래 상태 EXECUTING 전이 assert | [L0] |
| 22 | /reject {txId} -> 거래 거부 + 상태 전이 | APPROVAL 대기 거래 -> /reject TX-001 명령 -> 거래 상태 REJECTED 전이 assert | [L0] |
| 23 | 2-Tier auth -- 관리자 승인, 읽기전용 조회만 가능 | 관리자 chat_id -> /approve 성공 assert + 읽기전용 chat_id -> /approve 권한 거부 assert | [L0] |
| 24 | /killswitch -> 확인 요청 -> 실행 -> 결과 알림 | /killswitch 명령 -> 확인 인라인 키보드(Yes/No) -> Yes 클릭 -> Kill Switch 발동 + 결과 메시지 assert | [L0] |
| 25 | /newsession -> 에이전트 선택 인라인 키보드 -> 세션 발급 | /newsession 명령 -> 에이전트 목록 인라인 키보드 -> 에이전트 선택 -> 세션 토큰 발급 + 응답 assert | [L0] |
| 26 | Long Polling 네트워크 단절 -> 지수 백오프 재연결 | mock Telegram API 일시 실패(3회) -> 지수 백오프(1s, 2s, 4s) 후 재연결 성공 assert | [L0] |

### Desktop UI/UX (HUMAN)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 27 | Setup Wizard 5단계 UX 적합성 | 5단계 순차 진행: 패스워드 강도 표시, 체인 선택 UI, 에이전트 생성 피드백, Owner QR 표시, 완료 요약. 화면 전환 자연스러움, 입력 검증 즉시 피드백, 에러 메시지 명확성 확인 | [HUMAN] |
| 28 | Dashboard 레이아웃 + 데이터 표시 정확성 | 잔액 수치 정확성, 거래 목록 최신순 정렬, 에이전트 상태 카드 색상, 시스템 상태 배너 표시. 레이아웃 반응형(최소 1024x768) 확인 | [HUMAN] |
| 29 | APPROVAL 거래 알림 -> Owner 서명 -> 승인 UI 흐름 | APPROVAL 대기 거래 발생 -> OS 알림 + 거래 상세 화면 자동 이동 -> WalletConnect QR 표시 -> 모바일 지갑 서명 -> 승인 완료 피드백. 전체 흐름 자연스러움 확인 | [HUMAN] |
| 30 | 시스템 트레이 3색 상태 아이콘 표시 + 컨텍스트 메뉴 동작 | 정상=녹색, APPROVAL 대기=주황, Kill Switch=빨강 아이콘 전환 확인. 컨텍스트 메뉴 클릭 -> 대시보드 열기/로그 보기/종료 정상 동작 확인 | [HUMAN] |
| 31 | Kill Switch 긴급 정지 UI -> 확인 대화상자 -> cascade 결과 | Kill Switch 화면에서 긴급 정지 클릭 -> 2단계 확인 대화상자 -> cascade 진행 시각화(6-step) -> 완료 후 상태 표시 변경(빨강) 확인 | [HUMAN] |

### Telegram UI/UX (HUMAN)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 32 | /pending -> 인라인 키보드 -> Approve/Reject 대화 흐름 자연스러움 | /pending 실행 -> 거래 요약 MarkdownV2 포매팅 가독성 + 인라인 키보드 버튼 배치 + Approve 클릭 후 확인 메시지 피드백 자연스러움 확인 | [HUMAN] |
| 33 | /killswitch -> 확인 요청 -> 실행 -> 결과 알림 대화 흐름 | /killswitch -> "정말 실행하시겠습니까?" 확인 키보드 -> Yes -> cascade 진행 메시지 -> 완료 요약 메시지. 대화 흐름 명확성 + 위험 작업 경고 적절성 확인 | [HUMAN] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.5 (DeFi + 가격 오라클) | Kill Switch가 USD 기준 AutoStop 규칙(DAILY_SPENDING_LIMIT)을 사용하므로 IPriceOracle이 필요. Action Provider MCP 도구가 Desktop/Telegram에서 표시되므로 v1.5 MCP 통합 완료 필요. Docker 배포에 v1.5 기능(오라클, Action) 포함 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | Node.js SEA + native addon(sodium-native, better-sqlite3) 크로스 플랫폼 호환성 | macOS/Windows/Linux 5 타겟에서 native addon 바이너리 호환 실패 가능 | v0.7 prebuildify 전략 설계 완료. v1.6 초기에 스파이크 테스트 수행: esbuild 번들 + SEA config + postject 파이프라인을 3개 OS에서 검증. 실패 시 SEA 대신 Node.js 번들 + runtime 포함 방식으로 fallback |
| 2 | Tauri 2 + React 18 + @reown/appkit 호환성 | Tauri WebView 환경에서 WalletConnect 동작 미검증. window.ethereum 미존재, WebSocket 지원 범위 불확실 | @reown/appkit이 Tauri WebView를 공식 지원하는지 v1.6 스파이크에서 검증. 미지원 시 직접 WalletConnect SignClient 사용으로 fallback |
| 3 | Telegram Bot API Long Polling 안정성 | 네트워크 단절 시 getUpdates 타임아웃, 재연결 실패 가능 | 지수 백오프 재연결(1s, 2s, 4s, max 30s). getUpdates timeout=25초 설정. 3회 연속 실패 시 TELEGRAM_DISCONNECTED 경고 로그 + 알림. 5분 후 자동 재시도 |
| 4 | Desktop UI/UX 수동 검증 비용 | 8화면 x 다중 상태 조합으로 [HUMAN] 항목 집중(7건). 검증 시간 + 반복 비용 | 기능 정합성(API 호출, 상태 전이)은 자동화(L0/L1). [HUMAN]은 레이아웃/UX 적합성만. Playwright/Puppeteer 스크린샷 비교는 v1.7에서 검토 |
| 5 | Docker image 크기 (native addon 포함) | sodium-native + better-sqlite3 native 바이너리로 이미지 크기 증가 가능(예상 300-500MB) | Multi-stage 빌드: builder에서 devDependencies 설치/빌드, runner에서 production만 복사. node:22-slim으로 기본 이미지 최소화. .dockerignore로 불필요 파일 제외 |
| 6 | Kill Switch CAS 패턴 SQLite 성능 | BEGIN IMMEDIATE 잠금 범위가 6-step cascade 전체(세션 무효화+거래 중단+에이전트 정지)를 포함하면 write lock 장시간 점유 | cascade 6-step은 별도 트랜잭션으로 분리: 상태 전이(CAS)만 단일 트랜잭션, cascade 단계는 순차 실행(각각 독립 트랜잭션). 상태 전이 성공 후 cascade 일부 실패 시 상태는 유지하되 재시도 |
| 7 | Setup Wizard 초기 설정 복잡도 | 5단계가 너무 많으면 사용자 이탈 가능 | 각 단계 최소 입력(패스워드, 체인 선택, 에이전트 이름). Owner 연결은 "나중에" 스킵 가능. 진행 표시줄로 현재 단계 시각화 |

---

*최종 업데이트: 2026-02-09 v1.0 구현 계획 기반 생성, v0.10 설계 결정(CONC-03 Kill Switch 4전이 CAS ACID) 반영, 설계 문서 39/40/36 참조, Desktop/Telegram i18n 다국어(en/ko) 적용 범위 추가*
