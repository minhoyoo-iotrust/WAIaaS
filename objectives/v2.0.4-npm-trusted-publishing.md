# 마일스톤 v2.0.4: npm Trusted Publishing 전환

## 목표

npm 패키지 발행 방식을 Classic Automation Token에서 Trusted Publishing (OIDC)으로 전환하여, 장기 시크릿(NPM_TOKEN) 없이 GitHub Actions가 직접 npm에 인증하는 보안 강화 상태.

> **핵심 원칙**: "발행 토큰이 유출되어도 패키지가 오염되지 않는다." OIDC 기반 단기 토큰으로 supply chain 보안 확보.

---

## 배경

현재 release.yml의 deploy 잡은 Classic Automation Token(`NPM_TOKEN`)을 사용하여 npm에 발행한다. 이 토큰은:
- 장기(만료 없음) 시크릿으로 유출 시 임의 발행 가능
- npm이 공식적으로 Trusted Publishing 전환을 권장 (2FA bypass 경고)
- 토큰 회전(rotation) 관리 부담

npm Trusted Publishing은 GitHub Actions OIDC 토큰으로 인증하므로:
- NPM_TOKEN 시크릿 불필요 (제거 가능)
- 토큰이 워크플로 실행 시에만 생성, 단기 만료
- `--provenance` 플래그로 빌드 출처 증명 (SLSA Level 3)
- npm 패키지 페이지에 "Published from GitHub Actions" 배지 표시

---

## 산출물

| # | 산출물 | 설명 |
|---|--------|------|
| 1 | npm Trusted Publishing 설정 | 8개 패키지에 GitHub repo/workflow 신뢰 관계 등록 |
| 2 | release.yml OIDC 전환 | `id-token: write` 퍼미션 + `npm publish --provenance` |
| 3 | NPM_TOKEN 시크릿 제거 | 더 이상 불필요한 장기 시크릿 정리 |
| 4 | Provenance 검증 | 발행된 패키지에 출처 증명 메타데이터 확인 |

---

## 전제 조건

- 8개 패키지가 npm에 최초 발행 완료 (v2.0.0-rc.1 이상)
- GitHub 레포가 public 상태 (Trusted Publishing은 public 레포 권장)

---

## 구현 범위

### Phase 1: npm 패키지별 Trusted Publishing 설정

각 패키지(npmjs.com)에서 Trusted Publishing 구성:
- Repository: `minhoyoo-iotrust/WAIaaS`
- Workflow: `release.yml`
- Environment: `production`

대상 패키지 (8개):
- `@waiaas/core`, `@waiaas/daemon`, `@waiaas/cli`, `@waiaas/sdk`
- `@waiaas/mcp`, `@waiaas/skills`
- `@waiaas/adapter-solana`, `@waiaas/adapter-evm`

### Phase 2: release.yml 수정

```yaml
# 변경 전
permissions:
  contents: read
  packages: write

# 변경 후
permissions:
  contents: read
  packages: write
  id-token: write  # OIDC 토큰 발급

# deploy 잡 npm publish 변경
- name: npm publish
  run: |
    for pkg_path in "${PACKAGES[@]}"; do
      cd "$pkg_path"
      npm publish --provenance --access public
      cd "$GITHUB_WORKSPACE"
    done
```

### Phase 3: 정리

- GitHub Secrets에서 `NPM_TOKEN` 제거
- release.yml에서 `Setup npmrc` 스텝 제거
- 문서 업데이트 (DEPLOY.md, skill files)

---

## 성공 기준

- [ ] 8개 패키지 모두 Trusted Publishing으로 발행 성공
- [ ] npm 패키지 페이지에 provenance 배지 표시
- [ ] NPM_TOKEN 시크릿 완전 제거
- [ ] 릴리스 파이프라인 E2E 검증 통과
