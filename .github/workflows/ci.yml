name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # Stage 1: push + PR common - affected packages only
  stage1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Fetch base branch
        shell: bash
        run: git fetch origin main

      - name: Determine affected base
        id: affected-base
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Push to main: compare with previous commit so --affected detects changes
            # (origin/main == HEAD after push, making --affected find no diff)
            echo "base=HEAD~1" >> "$GITHUB_OUTPUT"
          else
            echo "base=origin/main" >> "$GITHUB_OUTPUT"
          fi

      - name: Lint (affected)
        run: pnpm turbo run lint --affected
        env:
          TURBO_SCM_BASE: ${{ steps.affected-base.outputs.base }}

      - name: Typecheck (affected)
        run: pnpm turbo run typecheck --affected
        env:
          TURBO_SCM_BASE: ${{ steps.affected-base.outputs.base }}

      - name: Unit Tests (affected)
        run: pnpm turbo run test:unit --affected -- --coverage
        env:
          TURBO_SCM_BASE: ${{ steps.affected-base.outputs.base }}

  # Stage 2: PR only - full suite + coverage gate + coverage reports
  stage2:
    if: github.event_name != 'push'
    needs: stage1
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build
        run: pnpm turbo run build

      - name: Unit Tests - Full
        run: pnpm turbo run test:unit -- --coverage

      - name: Integration Tests
        run: pnpm turbo run test:integration

      - name: Security Tests
        run: pnpm turbo run test:security

      - name: Verify Enum SSoT
        run: pnpm run verify:enums

      - name: Validate OpenAPI Spec
        run: pnpm run validate:openapi

      - name: Coverage Gate
        run: bash scripts/coverage-gate.sh
        env:
          COVERAGE_GATE_MODE: soft

      - name: 'Coverage Report - @waiaas/core'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/core'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/core

      - name: 'Coverage Report - @waiaas/daemon'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/daemon'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/daemon

      - name: 'Coverage Report - @waiaas/adapter-solana'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/adapter-solana'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/adapters/solana

      - name: 'Coverage Report - @waiaas/sdk'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/sdk'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/sdk

      - name: 'Coverage Report - @waiaas/cli'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/cli'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/cli

      - name: 'Coverage Report - @waiaas/mcp'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/mcp'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/mcp

      - name: 'Coverage Report - @waiaas/admin'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/admin'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/admin

      - name: 'Coverage Report - @waiaas/adapter-evm'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/adapter-evm'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/adapters/evm

      - name: 'Coverage Report - @waiaas/wallet-sdk'
        uses: davelosert/vitest-coverage-report-action@v2
        if: always()
        with:
          name: '@waiaas/wallet-sdk'
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          working-directory: packages/wallet-sdk
