# =============================================================================
# WAIaaS Docker Compose
#
# Usage:
#   docker compose up -d          # Start daemon
#   docker compose logs -f        # Follow logs
#   docker compose down           # Stop (data preserved in named volume)
#   docker compose down -v        # Stop + delete data volume
#
# =============================================================================
#
# Docker Secrets (Docker Swarm):
#   echo "your_master_password" | docker secret create waiaas_master_password -
#   docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
#
#   docker-compose.secrets.yml:
#     services:
#       daemon:
#         secrets:
#           - waiaas_master_password
#         environment:
#           - WAIAAS_MASTER_PASSWORD_FILE=/run/secrets/waiaas_master_password
#     secrets:
#       waiaas_master_password:
#         external: true
#
# File-based secrets (Docker Compose without Swarm):
#   services:
#     daemon:
#       secrets:
#         - waiaas_master_password
#       environment:
#         - WAIAAS_MASTER_PASSWORD_FILE=/run/secrets/waiaas_master_password
#   secrets:
#     waiaas_master_password:
#       file: ./secrets/master_password.txt
#
# =============================================================================

services:
  daemon:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: waiaas-daemon
    ports:
      - "127.0.0.1:3100:3100"
    volumes:
      - waiaas-data:/data
    environment:
      - WAIAAS_DATA_DIR=/data
      - WAIAAS_DAEMON_HOSTNAME=0.0.0.0
    env_file:
      - path: .env
        required: false
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

volumes:
  waiaas-data:
    driver: local
