---
name: "WAIaaS x402"
description: "x402 auto-payment protocol: fetch URLs with automatic cryptocurrency payments"
category: "api"
tags: [wallet, blockchain, x402, payments, waiass]
version: "2.3.0-rc.1"
dispatch:
  kind: "tool"
  allowedCommands: ["curl"]
---

# WAIaaS x402 Auto-Payment

Fetch external URLs with automatic x402 protocol payment. When a server responds with HTTP 402 Payment Required, the daemon automatically signs a cryptocurrency payment (USDC via EIP-3009 on EVM or SPL TransferChecked on Solana) and retries the request.

## Base URL / Authentication

```
http://localhost:3100
```

Requires **sessionAuth** via `Authorization: Bearer <token>` header.

## 1. Fetch with Auto-Payment

### POST /v1/x402/fetch

Proxy an HTTP request to an external URL. If the server responds with HTTP 402, automatically sign a payment and retry.

```bash
curl -s -X POST http://localhost:3100/v1/x402/fetch \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer wai_sess_eyJ...' \
  -d '{
    "url": "https://api.example.com/premium/data",
    "method": "GET",
    "headers": {"Accept": "application/json"}
  }'
```

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `url` | string | Yes | Target URL to fetch (HTTPS required) |
| `method` | string | No | HTTP method: GET, POST, PUT, DELETE, PATCH (default: GET) |
| `headers` | object | No | Additional HTTP headers as key-value pairs |
| `body` | string | No | Request body string |

**Response (200) -- Non-402 Passthrough:**

When the target server does not respond with 402, the response is passed through directly:

```json
{
  "status": 200,
  "headers": {"content-type": "application/json"},
  "body": "{\"data\": \"free content\"}"
}
```

**Response (200) -- After x402 Payment:**

When the target server responds with 402 and payment succeeds:

```json
{
  "status": 200,
  "headers": {"content-type": "application/json"},
  "body": "{\"data\": \"premium content\"}",
  "payment": {
    "amount": "1000000",
    "asset": "USDC",
    "network": "eip155:8453",
    "payTo": "0xPaymentReceiver",
    "txId": "01958f3c-9999-7000-8000-abcdef999999"
  }
}
```

The `payment` field is only present when an x402 payment was made. The `payment.txId` is the WAIaaS transaction record ID, queryable via `GET /v1/transactions/{txId}`.

## 2. Prerequisites

Before using x402 auto-payment, ensure:

1. **x402 enabled** in `config.toml`:
   ```toml
   [x402]
   enabled = true
   ```

2. **X402_ALLOWED_DOMAINS policy** for the wallet (default-deny):
   ```bash
   curl -s -X POST http://localhost:3100/v1/policies \
     -H 'Content-Type: application/json' \
     -H 'X-Master-Password: your-master-password' \
     -d '{
       "walletId": "01958f3a-1234-7000-8000-abcdef123456",
       "type": "X402_ALLOWED_DOMAINS",
       "rules": {
         "domains": ["api.example.com", "*.premium-apis.com"]
       },
       "priority": 0,
       "enabled": true
     }'
   ```

3. **SPENDING_LIMIT policy** (optional): Controls per-period spending. x402 payments are evaluated against the same SPENDING_LIMIT as regular transactions.

## 3. Payment Flow

1. Daemon sends the initial HTTP request to the target URL (SSRF-guarded)
2. If response is not 402, it is returned as-is (passthrough)
3. If response is 402:
   a. Parse `PAYMENT-REQUIRED` header for payment requirements
   b. Select compatible payment scheme (EIP-3009 or SPL TransferChecked)
   c. Create transaction record (type=X402_PAYMENT)
   d. Evaluate SPENDING_LIMIT policy (DELAY/APPROVAL tier handling)
   e. Sign payment with wallet's private key
   f. Retry request with `PAYMENT-SIGNATURE` header
   g. If retry succeeds, mark transaction CONFIRMED
   h. If retry returns 402 again, mark FAILED (single retry only)

## 4. SDK Usage

**TypeScript SDK:**
```typescript
const result = await client.x402Fetch({
  url: 'https://api.example.com/premium/data',
});

if (result.payment) {
  console.log(`Paid ${result.payment.amount} ${result.payment.asset}`);
}
console.log(result.body); // response from the server
```

**Python SDK:**
```python
result = await client.x402_fetch("https://api.example.com/premium/data")

if result.payment:
    print(f"Paid {result.payment.amount} {result.payment.asset}")
print(result.body)  # response from the server
```

**MCP Tool:**
- Tool name: `x402_fetch`
- Parameters: `url` (required), `method` (optional), `headers` (optional), `body` (optional)

## 5. x402 Payment Records

x402 payments are recorded as transactions with `type: "X402_PAYMENT"`. Query them using the standard transaction endpoints:

```bash
# Get specific x402 payment details
curl -s http://localhost:3100/v1/transactions/{txId} \
  -H 'Authorization: Bearer wai_sess_eyJ...'

# List all transactions (includes X402_PAYMENT type)
curl -s http://localhost:3100/v1/transactions?limit=20 \
  -H 'Authorization: Bearer wai_sess_eyJ...'
```

X402_PAYMENT transactions have:
- `type`: `"X402_PAYMENT"`
- `status`: PENDING -> CONFIRMED or FAILED
- `amount`: Payment amount in smallest unit
- `toAddress`: Payment recipient address
- `metadata`: Contains target_url, payment_amount, network, asset, scheme

## 6. Error Reference

| Code | HTTP | Description | Recovery |
|------|------|-------------|----------|
| `X402_DISABLED` | 403 | x402 payments disabled in config | Enable `[x402] enabled = true` in config.toml |
| `X402_DOMAIN_NOT_ALLOWED` | 403 | Target domain not in X402_ALLOWED_DOMAINS | Add domain to X402_ALLOWED_DOMAINS policy |
| `X402_SSRF_BLOCKED` | 403 | URL targets private/internal network | Use a public HTTPS URL |
| `X402_UNSUPPORTED_SCHEME` | 400 | No compatible payment scheme available | Target server must support EIP-3009 or SPL TransferChecked |
| `X402_PAYMENT_REJECTED` | 402 | Payment rejected by resource server | Check payment amount and wallet balance |
| `X402_DELAY_TIMEOUT` | 408 | SPENDING_LIMIT delay exceeds request timeout | Increase x402.request_timeout or adjust SPENDING_LIMIT thresholds |
| `X402_APPROVAL_REQUIRED` | 403 | Amount requires owner approval (incompatible with x402) | Lower amount or adjust SPENDING_LIMIT tiers |
| `X402_SERVER_ERROR` | 502 | Resource server error after payment | Retry; check resource server status |
| `POLICY_DENIED` | 403 | SPENDING_LIMIT policy denied the payment | Check spending limits with GET /v1/policies |

## 7. Related Skill Files

- **policies.skill.md** -- X402_ALLOWED_DOMAINS and SPENDING_LIMIT policy management
- **transactions.skill.md** -- Transaction lifecycle and query (X402_PAYMENT type)
- **wallet.skill.md** -- Wallet CRUD, sessions, balance
- **admin.skill.md** -- Daemon configuration, kill switch
