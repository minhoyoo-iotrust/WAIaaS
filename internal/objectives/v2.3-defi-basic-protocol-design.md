# 마일스톤 v2.3: 기본 DeFi 프로토콜 설계 (Swap/Bridge/Staking)

## 목표

v1.5에서 구축된 Action Provider 프레임워크 위에 4개 기본 DeFi 프로토콜(DEX Swap, EVM Swap, 크로스체인 브릿지, Liquid Staking)을 구현하기 위한 공통 설계를 확정한다. packages/actions/ 패키지 구조, REST API → calldata 변환 공통 패턴, 정책 연동 설계, 비동기 상태 추적 패턴, 테스트 전략을 정의하여 v2.3.1~v2.3.4 구현 마일스톤의 입력을 생산한다.

---

## 배경

v1.5에서 IActionProvider 인터페이스, ActionProviderRegistry, MCP Tool 자동 변환, POST /v1/actions/:provider/:action 엔드포인트가 구현되었다. 그러나 이 프레임워크의 **실 구현체**는 아직 없다. v2.3은 4개 프로토콜의 공통 설계를 확정하고, v2.3.1~v2.3.4에서 각각 구현한다.

### 4개 프로토콜 개요

| 마일스톤 | 프로토콜 | 체인 | 패턴 |
|---------|----------|------|------|
| v2.3.1 | Jupiter Swap | Solana | REST → instruction → ContractCallRequest |
| v2.3.2 | 0x Swap API | EVM (19+ 체인) | REST → calldata → ContractCallRequest |
| v2.3.3 | LI.FI Bridge | Solana↔EVM | REST → calldata + 비동기 상태 추적 |
| v2.3.4 | Lido + Jito Staking | EVM + Solana | ABI/프로그램 직접 호출 + 포지션 조회 |

---

## 설계 대상

### 1. packages/actions/ 패키지 구조

내장 ActionProvider 구현체를 코어/데몬과 분리하여 선택적 설치가 가능한 독립 패키지로 설계한다.

#### 1.1 설계 범위

| 항목 | 내용 |
|------|------|
| 패키지 이름 | @waiaas/actions (모노레포 packages/actions/) |
| 프로바이더 디렉토리 | providers/{name}/ — index.ts, schemas.ts, config.ts, api-client.ts |
| 내장 프로바이더 로딩 | 데몬 시작 시 enabled 프로바이더만 ActionProviderRegistry에 등록 |
| config.toml 패턴 | [actions.{provider_name}] 섹션 — enabled, 프로바이더별 설정 |
| 의존성 정책 | 프로바이더별 외부 SDK는 선택적 의존성. REST API 직접 호출 우선 |

#### 1.2 설계 산출물

- packages/actions/ 디렉토리 구조 확정
- 내장 프로바이더 등록/해제 라이프사이클
- config.toml [actions.*] 섹션 스키마 공통 패턴
- Admin Settings 노출 항목 (API 키, 슬리피지 등 런타임 변경 가능 설정)

---

### 2. REST API → calldata 변환 공통 패턴

4개 프로토콜 모두 **외부 REST API 호출 → calldata/instruction 획득 → ContractCallRequest 변환**이라는 동일 패턴을 따른다. 이 공통 패턴을 설계한다.

#### 2.1 공통 플로우

```
resolve(actionName, params)
  1. 입력 파라미터 Zod 검증
  2. 외부 API 호출 (Quote/견적 조회)
  3. 견적 검증 (슬리피지, priceImpact 등)
  4. 외부 API 호출 (calldata/instruction 획득)
  5. ContractCallRequest 변환 (체인별 매핑)
  6. 반환 → 기존 파이프라인 Stage 1~6 실행
```

#### 2.2 설계 범위

| 항목 | 내용 |
|------|------|
| API Client 공통 패턴 | native fetch + AbortController 타임아웃 + 응답 Zod 검증 |
| 타임아웃 기본값 | 10초 (크로스체인은 15초) |
| 에러 처리 | ACTION_API_ERROR, ACTION_RATE_LIMITED, PRICE_IMPACT_TOO_HIGH 에러 코드 |
| 슬리피지 제어 | 프로바이더별 기본값/상한 config, 사용자 입력 → 상한 클램핑 |
| 견적 캐시 | 프로바이더별 선택적 캐시 (30초 TTL) |

#### 2.3 설계 산출물

- ActionApiClient 베이스 패턴 (fetch 래퍼, 타임아웃, Zod 검증)
- ContractCallRequest 변환 매핑 (Solana: programId/instructionData/accounts, EVM: to/data/value)
- 에러 코드 추가 (ACTION_API_ERROR, ACTION_RATE_LIMITED, PRICE_IMPACT_TOO_HIGH)
- 슬리피지 제어 공통 로직 (기본값/상한/클램핑)

---

### 3. 정책 연동 설계

기존 정책 엔진이 ActionProvider 실행에 어떻게 적용되는지 공통 설계를 확정한다.

#### 3.1 설계 범위

| 항목 | 내용 |
|------|------|
| CONTRACT_WHITELIST | 각 프로토콜의 프로그램/컨트랙트 주소를 화이트리스트에 등록 필수 (기본 거부) |
| SPENDING_LIMIT | resolve()가 반환한 금액을 USD 환산하여 기존 4-tier 평가 |
| 크로스체인 정책 | 출발 체인 월렛의 정책으로 평가 (자금이 나가는 쪽) |
| 스테이킹 정책 | stake 금액을 지출로 평가 (SPENDING_LIMIT 적용) |

#### 3.2 설계 산출물

- ActionProvider → 정책 평가 연동 플로우 다이어그램
- 프로토콜별 CONTRACT_WHITELIST 등록 대상 주소 목록
- 크로스체인/스테이킹 정책 평가 규칙 확정

---

### 4. 비동기 상태 추적 패턴

크로스체인 브릿지(v2.3.3)와 unstake(v2.3.4)는 비동기 완료를 추적해야 한다. 공통 폴링 패턴을 설계한다.

#### 4.1 설계 범위

| 항목 | 내용 |
|------|------|
| 추적 대상 | 브릿지 전송 (수 분~수십 분), unstake 대기 (수 시간~수 일) |
| 추적 방식 | 폴링 기반 (외부 API /status 호출) |
| 폴링 간격 | 브릿지 30초, unstake 5분 (config.toml 오버라이드) |
| 최대 폴링 | 브릿지 60회 (30분), unstake 288회 (24시간) |
| 상태 전이 | PENDING → COMPLETED / FAILED / TIMEOUT |
| 알림 | 완료/실패/타임아웃 시 알림 발송 |

#### 4.2 설계 산출물

- AsyncStatusTracker 공통 인터페이스
- 폴링 스케줄러 설계 (setInterval vs setTimeout 체인)
- transactions 테이블 bridge_status 컬럼 추가 검토
- 상태 전이 다이어그램

---

### 5. 테스트 전략

4개 프로토콜 공통의 테스트 패턴을 설계한다.

#### 5.1 설계 범위

| 항목 | 내용 |
|------|------|
| 단위 테스트 | mock 외부 API 응답 → resolve() → ContractCallRequest 검증 |
| 통합 테스트 | mock API + mock ChainAdapter → 파이프라인 실행 → 상태 전이 |
| 정책 테스트 | CONTRACT_WHITELIST / SPENDING_LIMIT 연동 검증 |
| MCP 테스트 | 프로바이더 등록 → MCP tool 목록 자동 노출 |
| 외부 API 실 호출 | [HUMAN] 태그 — Devnet/Testnet에서 수동 검증 |

#### 5.2 설계 산출물

- mock API 응답 픽스처 공통 구조
- 프로바이더 테스트 헬퍼 (createMockApiResponse, assertContractCallRequest)
- 4개 프로토콜 × 공통 시나리오 매트릭스

---

## 신규 산출물

| ID | 산출물 | 설명 |
|----|--------|------|
| DEFI-01 | packages/actions/ 구조 설계 | 디렉토리, config 패턴, 프로바이더 로딩 |
| DEFI-02 | REST → calldata 공통 패턴 | API Client, 슬리피지, 에러 코드 |
| DEFI-03 | 정책 연동 설계 | CONTRACT_WHITELIST, SPENDING_LIMIT, 크로스체인 |
| DEFI-04 | 비동기 상태 추적 설계 | AsyncStatusTracker, 폴링, 상태 전이 |
| DEFI-05 | 테스트 전략 | mock 패턴, 테스트 매트릭스 |

---

## 영향받는 설계 문서

| 문서 | 변경 |
|------|------|
| 62 (action-provider-architecture) | 내장 프로바이더 패키지 구조, config 패턴 추가 |
| 63 (swap-action-spec) | 공통 패턴으로 리팩터링 |
| 37 (rest-api) | ACTION_API_ERROR 등 에러 코드 추가 |
| 33 (policy) | ActionProvider 정책 연동 플로우 |
| 35 (notification) | 비동기 완료/실패 알림 이벤트 |

---

## 성공 기준

1. 4개 프로토콜의 공통 설계 요소가 일관된 패턴으로 정의됨
2. packages/actions/ 구조가 확정되어 v2.3.1에서 바로 구현 가능
3. 정책 연동 규칙이 명확하여 구현 시 모호함 없음
4. 비동기 상태 추적 패턴이 브릿지/unstake 양쪽에 재사용 가능
5. 테스트 전략이 4개 프로토콜에 일관되게 적용 가능

---

*생성일: 2026-02-15*
*범위: 설계 마일스톤 — 코드 구현은 v2.3.1~v2.3.4에서 수행*
*선행: v1.5 (Action Provider 프레임워크 + 가격 오라클)*
*관련: 설계 문서 62 (action-provider-architecture), 63 (swap-action-spec)*
