# Issue #071: 배포 패키지 스모크 테스트 자동화 (npm pack)

- **유형**: ENHANCEMENT
- **심각도**: MEDIUM
- **마일스톤**: v2.0.1

## 현황

현재 테스트는 모두 `workspace:*`로 연결된 로컬 모노레포 환경에서만 실행됨. `npm publish --dry-run`으로 패키지 발행 가능 여부만 확인하고, 실제 설치 후 동작 여부는 검증하지 않음.

이로 인해 다음 문제를 사전에 잡지 못함:

- `package.json`의 `exports` / `main` / `types` 필드 누락
- `files` 필드 오설정으로 dist/ 파일 미포함
- 런타임 의존성 누락 (devDependencies에만 있는 패키지)
- ESM/CJS 호환성 문제

## 설계

### npm pack + 임시 프로젝트 스모크 테스트

```bash
# 1. 전체 빌드
pnpm turbo build

# 2. 각 패키지 tarball 생성
for pkg in core sdk cli mcp daemon adapters/solana adapters/evm skills; do
  cd packages/$pkg && npm pack && cd -
done

# 3. 임시 프로젝트에서 tarball 설치 + import 검증
mkdir /tmp/smoke-test && cd /tmp/smoke-test
npm init -y

# SDK (내부 의존성 0개 — 완전한 독립 검증)
npm install /path/to/waiaas-sdk-*.tgz
node -e "const { WAIaaSClient } = require('@waiaas/sdk'); console.log('sdk:ok')"
node --input-type=module -e "import { WAIaaSClient } from '@waiaas/sdk'; console.log('sdk:esm:ok')"

# Core (타입/스키마 export 검증)
npm install /path/to/waiaas-core-*.tgz
node -e "const { WAIaaSError } = require('@waiaas/core'); console.log('core:ok')"

# MCP (SDK 의존 — npm에서 sdk 해소)
npm install /path/to/waiaas-mcp-*.tgz

# CLI (바이너리 진입점 검증)
npm install /path/to/waiaas-cli-*.tgz
npx waiaas --version
```

### 검증 항목

| 패키지 | 검증 내용 |
|--------|----------|
| `@waiaas/core` | CJS require + ESM import + 주요 export (WAIaaSError, ChainType, Zod 스키마) |
| `@waiaas/sdk` | CJS require + ESM import + WAIaaSClient 클래스 인스턴스화 |
| `@waiaas/cli` | `npx waiaas --version` 정상 출력 |
| `@waiaas/mcp` | CJS require 정상 |
| `@waiaas/daemon` | CJS require 정상 (native addon 로드 포함) |
| `@waiaas/adapter-solana` | CJS require 정상 |
| `@waiaas/adapter-evm` | CJS require 정상 |
| `@waiaas/skills` | `npx @waiaas/skills list` 정상 출력 |

## 작업 범위

### 1. 스모크 테스트 스크립트 작성

- `scripts/smoke-test-published.sh` 신규 생성
- npm pack → 임시 디렉토리 → tarball 설치 → import/실행 검증 → 정리
- 종료 코드로 성공/실패 판정

### 2. CI 통합

- `release.yml`의 기존 `publish-check` job에 스모크 테스트 단계 추가
- 기존 `npm publish --dry-run` 이후 실행
- 실패 시 릴리스 차단

### 3. 로컬 실행 지원

- `package.json` 루트에 `test:smoke` 스크립트 추가
- 개발자가 `pnpm test:smoke`로 로컬에서도 실행 가능

## 완료 기준

- [ ] `scripts/smoke-test-published.sh` 작성됨
- [ ] 8개 패키지 전체에 대해 tarball 설치 + import 검증 통과
- [ ] CJS/ESM 듀얼 검증 (core, sdk)
- [ ] CLI 바이너리 진입점 검증 (waiaas --version)
- [ ] release.yml에 스모크 테스트 단계 통합
- [ ] `pnpm test:smoke`로 로컬 실행 가능
