# 마일스톤 v1.4.3: EVM 토큰 레지스트리 + MCP/Admin DX 개선 + 버그 수정

## 목표

EVM 지갑이 주요 ERC-20 토큰의 잔액을 자동으로 조회할 수 있고, Admin UI에서 MCP 토큰 발급까지 원스톱으로 처리 가능한 상태. 체인별 내장 토큰 레지스트리를 도입하여 EVM의 토큰 자동 발견 한계를 해소하고, ALLOWED_TOKENS 정책과 getAssets() 간의 단절을 연결한다. 아울러 EVM 트랜잭션 확인 타임아웃 오판(BUG-015)과 패키지 버전 표시(BUG-016)를 수정한다.

---

## 배경

### EVM 토큰 자동 발견 불가

Solana는 `getTokenAccountsByOwner` RPC로 주소가 보유한 모든 SPL 토큰을 자동 발견하지만, EVM에는 동등한 표준 RPC가 없다. ERC-20 토큰 잔액을 조회하려면 토큰 컨트랙트 주소를 미리 알아야 `balanceOf(address)`를 호출할 수 있다.

| 항목 | Solana | EVM |
|------|--------|-----|
| 토큰 발견 | `getTokenAccountsByOwner` RPC | 불가능 (구조적 한계) |
| getAssets() | 정책 없이 모든 SPL 토큰 자동 표시 | 네이티브 ETH만 표시 (BUG-014) |
| 해결 방법 | 불필요 | 토큰 컨트랙트 주소 목록 필요 |

현재 EvmAdapter에 `setAllowedTokens()` + multicall 로직이 구현되어 있으나, 데몬이 이 메서드를 호출하지 않아 ERC-20 잔액이 항상 비어 있다 (BUG-014).

### MCP/Admin DX 갭

Admin UI에서 지갑을 생성한 뒤 MCP 연동을 위해 터미널에서 `waiaas mcp setup`을 별도 실행해야 한다 (BUG-013). Admin UI에서 원스톱으로 처리할 수 없는 상태.

### EVM 트랜잭션 확인 타임아웃 오판

EVM 트랜잭션이 온체인에서 성공했으나 `waitForConfirmation` 단계에서 RPC 에러/타임아웃 발생 시, Stage 6이 해당 트랜잭션을 FAILED로 기록한다 (BUG-015). 온체인 상태와 DB 상태가 불일치하는 데이터 정합성 문제.

### 패키지 버전 미관리

모든 패키지의 package.json version이 0.0.0으로 초기값 그대로이며, Admin UI 대시보드와 OpenAPI 문서에 잘못된 버전이 표시된다 (BUG-016).

---

## 리서치 대상

이 마일스톤은 구현 전 리서치가 필요하다. 다음 항목을 조사하여 설계 결정을 확정한다.

### 1. 토큰 리스트 표준 및 데이터 소스

| 조사 항목 | 내용 |
|-----------|------|
| Uniswap Token List 포맷 | [tokenlists.org](https://tokenlists.org/) 표준 JSON 스키마, 체인별 토큰 목록 구조 |
| 주요 토큰 리스트 | CoinGecko, 1inch, Uniswap Default, Superchain Token List 등 커뮤니티 리스트 |
| 체인별 주요 토큰 | Tier 1 5체인(Ethereum, Polygon, Arbitrum, Optimism, Base) × 메인넷/테스트넷 |
| 테스트넷 토큰 | Sepolia/Amoy 등 테스트넷에서 사용 가능한 faucet 토큰 (LINK, USDC 등) 주소 |

### 2. 토큰 레지스트리 아키텍처

| 결정 항목 | 선택지 |
|-----------|--------|
| 저장 위치 | A) 코드 내 정적 JSON B) DB 테이블 C) config.toml |
| 데이터 구조 | network → token[] 매핑, 토큰별 address/symbol/name/decimals/logoURI |
| 커스텀 토큰 | 사용자가 UI/API로 추가하는 토큰 관리 방식 |
| 업데이트 전략 | 패키지 업데이트 시 내장 목록 갱신, 사용자 커스텀 토큰 보존 |
| ALLOWED_TOKENS 관계 | 레지스트리 = 조회용(UX), ALLOWED_TOKENS = 전송 허용(보안). 분리 vs 통합 |

### 3. getAssets() 연동 전략

| 결정 항목 | 선택지 |
|-----------|--------|
| 조회 대상 | A) 레지스트리 전체 B) ALLOWED_TOKENS 정책 토큰만 C) 레지스트리 ∪ ALLOWED_TOKENS |
| multicall 성능 | 토큰 50개 이상일 때 multicall 배치 크기, RPC rate limit 고려 |
| 캐시 | 토큰 잔액 캐시 여부 및 TTL |

### 4. Admin MCP 토큰 관리 API

| 결정 항목 | 선택지 |
|-----------|--------|
| 엔드포인트 | `POST /v1/mcp/tokens` (신규) vs 기존 세션 API 확장 |
| Claude Desktop 설정 | 설정 스니펫 반환 포맷, `command` 필드 값 (`node` vs `npx`) |
| CLI 리팩터링 | `waiaas mcp setup`이 새 API를 호출하도록 전환 여부 |

---

## 산출물

### 컴포넌트

| 컴포넌트 | 패키지 | 유형 | 내용 |
|----------|--------|------|------|
| TokenRegistry | `@waiaas/core` 또는 `@waiaas/daemon` | 신규 | 체인별 내장 토큰 목록 + 사용자 커스텀 토큰 관리. 레지스트리 = 잔액 조회용(UX), ALLOWED_TOKENS = 전송 허용(보안). getAssets()는 양쪽 합집합을 조회 대상으로 사용 |
| getAssets 연동 | `@waiaas/daemon` | 수정 | wallet.ts 라우트에서 TokenRegistry/ALLOWED_TOKENS → adapter.setAllowedTokens() 연결 |
| MCP 토큰 API | `@waiaas/daemon` | 신규 | `POST /v1/mcp/tokens` — 세션 생성 + 토큰 파일 저장 + Claude Desktop 설정 반환 |
| Admin MCP 섹션 | `@waiaas/admin` | 수정 | 지갑 상세 페이지에 MCP 토큰 발급 UI 추가 |
| Admin 토큰 관리 | `@waiaas/admin` | 수정 | 커스텀 토큰 추가/삭제 UI (선택) |
| Stage 6 확인 로직 | `@waiaas/daemon` + `adapter-evm` | 수정 | adapter에 fallback receipt 조회 추가 + Stage 6이 반환값 기반으로 CONFIRMED/SUBMITTED/FAILED 분기 (SUBMITTED는 이미 존재 — Stage 5에서 설정됨. Stage 6이 이를 FAILED로 덮어쓰는 버그 수정) |
| tag-release 스크립트 | 루트 | 신규 | `scripts/tag-release.sh` — 패키지 버전 일괄 갱신 + tag |

### API 변경

| 엔드포인트 | 유형 | 인증 | 내용 |
|-----------|------|------|------|
| `POST /v1/mcp/tokens` | 신규 | masterAuth | MCP 토큰 발급 + 파일 저장 |
| `GET /v1/wallet/assets` | 개선 | sessionAuth | ERC-20 토큰 잔액 포함 |
| 토큰 레지스트리 CRUD | 미정 | masterAuth | 커스텀 토큰 추가/삭제 (리서치 후 결정) |

---

## 해소 버그

| ID | 심각도 | 제목 | 해소 방식 |
|----|--------|------|----------|
| BUG-013 | LOW | Admin UI에서 MCP 토큰 발급 불가 — CLI 의존 | `POST /v1/mcp/tokens` + Admin UI MCP 섹션 |
| BUG-014 | MEDIUM | EVM getAssets()가 ERC-20 토큰 잔액 미반환 | TokenRegistry → setAllowedTokens() 연동 |
| BUG-015 | HIGH | EVM 트랜잭션 확인 타임아웃 시 성공 건을 FAILED 처리 | adapter fallback receipt 조회 + Stage 6 반환값 기반 상태 분기 (SUBMITTED 상태는 이미 존재 — Stage 6이 덮어쓰는 버그 수정) |
| BUG-016 | LOW | 모든 패키지 버전이 0.0.0 | `scripts/tag-release.sh` + 즉시 버전 갱신 |

---

## 순서 의존성

| 선행 | 내용 |
|------|------|
| v1.4.2 | 용어 변경 (agent → wallet) — v1.4.2 완료 후 v1.4.3 착수 |
| v1.4.3 → v1.5 | 토큰 레지스트리의 TokenRef를 v1.5 가격 오라클에서 활용 가능 |

---

## 예상 규모

| 항목 | 예상 |
|------|------|
| 리서치 | 토큰 리스트 표준, 체인별 주요 토큰, multicall 성능 |
| 페이즈 | 4~6개 (리서치 1 + 버그수정 1 + 설계 1 + 구현 2~3) |
| 신규/수정 파일 | 15~20개 |
| 테스트 | 토큰 레지스트리 단위 + getAssets ERC-20 통합 + Admin MCP UI + Stage 6 fallback |

---

*생성일: 2026-02-13*
*선행: v1.4.2 (용어 변경)*
*관련 버그: BUG-013, BUG-014, BUG-015, BUG-016*
