# 마일스톤 v1.4: 토큰 + 컨트랙트 확장

## 목표

SPL/ERC-20 토큰 전송, 자산 조회, 스마트 컨트랙트 호출, Approve 관리, 배치 트랜잭션이 동작하며, EVM 어댑터가 본격 가동되는 상태.

---

## 구현 대상 설계 문서

이 마일스톤에서 구현하는 설계 문서 목록과 각 문서에서 구현할 범위를 명시한다.

| 문서 | 이름 | 구현 범위 | 전체/부분 |
|------|------|----------|----------|
| 56 | token-transfer-extension | TransferRequest.token 필드 확장, TokenInfo 인터페이스, SPL buildSplTokenTransfer(getTransferCheckedInstruction + Token-2022 분기), ERC-20 buildErc20Transfer(approve+transfer), ALLOWED_TOKENS 정책(기본 거부, opt-in 화이트리스트) | 전체 |
| 57 | asset-query-fee-estimation | getAssets() 인터페이스 + AssetInfo 스키마, Solana getTokenAccountsByOwner 단일 호출, EVM ALLOWED_TOKENS 기반 보수적 multicall, estimateFee 확장(SPL ATA 생성 비용 동적 조회, ERC-20 gas 추정), REST API GET /v1/wallet/assets | 전체 |
| 58 | contract-call-spec | ContractCallRequest 인터페이스(EVM calldata + Solana programId/instructionData/accounts), CONTRACT_WHITELIST + METHOD_WHITELIST 정책, 기본 전면 거부(opt-in), Stage 1-5 크로스커팅 확장(discriminatedUnion 5-type 분기), DB TransactionType Enum 확장, 에러 코드 체계 | 전체 |
| 59 | approve-management-spec | ApproveRequest 독립 인터페이스(from/spender/token/amount), APPROVED_SPENDERS(기본 거부), APPROVE_AMOUNT_LIMIT(무제한 차단), APPROVE_TIER_OVERRIDE(기본 APPROVAL 강제), EVM ERC-20 approve + Solana SPL ApproveChecked 체인별 빌드, 보안 위험 매트릭스 | 전체 |
| 60 | batch-transaction-spec | BatchRequest + InstructionRequest 인터페이스, Solana 원자적 배치(min 2/max 20 instructions), 2단계 정책 합산 평가(개별 + 합산), All-or-Nothing 위반 처리, 부모-자식 자기참조 DB(transactions.parentId + batchIndex), EVM 명시적 미지원(BATCH_NOT_SUPPORTED), PARTIAL_FAILURE 상태 | 전체 |
| 36 | killswitch-autostop-evm | EVM 어댑터 신규 생성: `@waiaas/adapter-evm` 패키지 생성 (viem 2.x 기반, EIP-1559, ERC-20 전송, gas 추정, nonce 관리). Kill Switch/AutoStop 기능 자체는 v1.6에서 구현. **참고:** 기존 EvmStub은 코드베이스에 존재하지 않으므로 처음부터 구현 | 부분 (EVM 어댑터만) |
| 27 | chain-adapter-interface | IChainAdapter 인터페이스에 9개 메서드 선언 추가 + SolanaAdapter/EvmAdapter 구현하여 총 20개로 확장. 현재 인터페이스 11개 선언(v1.1 10개 + v1.3 1개) | 전체 (완성) |

### v0.10 설계 결정 반영

v0.10에서 확정된 설계 결정을 v1.4 구현에 반영한다:

| 결정 ID | 내용 | 적용 범위 |
|---------|------|----------|
| CONC-01 | Stage 5 완전 의사코드: build -> simulate -> sign -> submit + 에러 분기(PERMANENT 즉시 실패, TRANSIENT 지수 백오프, STALE blockhash 갱신 재시도) + MAX_RETRIES=2 | 파이프라인 Stage 5 구현, 모든 트랜잭션 타입에 적용 |
| ERRH-02 | ChainError 3-카테고리: PERMANENT(17개) / TRANSIENT(4개) / STALE(4개), category -> retryable 자동 파생 | IChainAdapter 에러 처리, SolanaAdapter + EvmAdapter 모두 적용 |
| OPER-02 | Batch 부모-자식 2계층 DB: metadata JSON -> 정규화. **현재 구현:** transactions 테이블 자기참조(parentId FK + batchIndex 컬럼)로 정규화 완료. 별도 batch_items 테이블 대신 동일 테이블 내 부모-자식 관계 사용. PARTIAL_FAILURE 상태 | BatchRequest 처리, 기존 transactions 스키마 활용 |
| ERRH-03 | PolicyType 10개 중 6개 신규 타입 평가 로직 구현 + superRefine: type별 rules 검증 분기 (.superRefine()으로 ALLOWED_TOKENS~APPROVE_TIER_OVERRIDE 6개 타입 rules 스키마 검증). enum은 이미 정의됨, 실제 PolicyEngine 평가 로직 + Zod 검증 구현 필요 | POST /v1/owner/policies 엔드포인트, 정책 생성 Zod 검증, PolicyEngine 평가 |
| PLCY-01 | APPROVAL 타임아웃 3단계 우선순위: 정책별 > config > 하드코딩 3600초 | Stage 4 APPROVAL 큐 삽입 시 타임아웃 결정 |

---

## 산출물

### 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| 토큰 전송 | TransferRequest.token 필드(TokenInfo: address/decimals/symbol), SPL buildSplTokenTransfer(getTransferCheckedInstruction, Token-2022 분기), ERC-20 buildErc20Transfer(ERC-20 ABI transfer(address,uint256)) |
| 자산 조회 | getAssets(address): AssetInfo[] -- Solana getTokenAccountsByOwner 단일 RPC, EVM ALLOWED_TOKENS 기반 multicall, 네이티브 토큰 첫 번째 + 잔액 내림차순 |
| ALLOWED_TOKENS | 에이전트별 토큰 화이트리스트 정책 -- policies 테이블 type='ALLOWED_TOKENS', rules.tokens 배열(mint/contract 주소), 미설정 시 토큰 전송 거부(네이티브만 허용) |
| ContractCallRequest | EVM: from/to/calldata/abi?/value?, Solana: from/to/programId/instructionData/accounts, 체인별 교차 검증 서비스 레이어 |
| CONTRACT_WHITELIST | 기본 전면 거부 + opt-in 화이트리스트 -- policies 테이블 type='CONTRACT_WHITELIST', rules.contracts 배열 + METHOD_WHITELIST rules.methods 배열 |
| ApproveRequest | 독립 타입 -- from/spender/token(TokenInfo)/amount, APPROVED_SPENDERS(기본 거부)/APPROVE_AMOUNT_LIMIT(무제한 차단, block_unlimited=true 기본)/APPROVE_TIER_OVERRIDE(기본 APPROVAL 강제) 3중 정책 |
| BatchRequest | Solana 원자적 배치 -- from/chain/instructions(InstructionRequest[]), min 2/max 20, 2단계 정책 합산(개별 평가 + 합산 SPENDING_LIMIT), All-or-Nothing(하나라도 정책 위반 시 전체 거부) |
| 부모-자식 자기참조 DB | transactions 테이블 자기참조 -- parentId(FK, ON DELETE CASCADE) + batchIndex 컬럼으로 부모-자식 관계 표현. 자식 트랜잭션도 동일 테이블에 저장되어 개별 상태 추적 가능. 부모 트랜잭션 PARTIAL_FAILURE 상태 |
| `@waiaas/adapter-evm` | EVM 어댑터 -- viem 2.x Client/Action 패턴, EIP-1559 gas 추정, ERC-20 전송/approve, nonce 관리(getCurrentNonce/resetNonceTracker), gas multiplier 1.2x |
| 파이프라인 확장 | Stage 1: discriminatedUnion 5-type 파싱(TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH) — 현재 SendTransactionRequestSchema(기본 transfer만)를 TransactionRequestSchema(z.discriminatedUnion)로 확장. Stage 2: type별 인증 분기(APPROVE/CONTRACT_CALL은 ownerAuth 필수 여부 정책 참조). Stage 3: 11단계 평가(기존 SPENDING_LIMIT/WHITELIST + ALLOWED_TOKENS/CONTRACT_WHITELIST/METHOD_WHITELIST/APPROVED_SPENDERS/APPROVE_AMOUNT_LIMIT/APPROVE_TIER_OVERRIDE, type별 적용 가능 정책 필터링). Stage 5: 완전 의사코드(CONC-01), type별 adapter 메서드 라우팅(TRANSFER→buildTransaction, TOKEN_TRANSFER→buildTokenTransfer, CONTRACT_CALL→buildContractCall, APPROVE→buildApprove, BATCH→buildBatch) |
| ChainError | 3-카테고리(PERMANENT 17개/TRANSIENT 4개/STALE 4개), category -> retryable 자동 파생, ChainError 클래스 확장(code/message/category/chain) |

### IChainAdapter 메서드 구현 현황

현재 인터페이스에 11개 메서드만 선언되어 있음. v1.4에서 9개 메서드를 인터페이스에 선언 추가 + SolanaAdapter/EvmAdapter 구현하여 총 20개로 확장한다.

v1.1~v1.3에서 선언 + 구현 완료된 11개 (SolanaAdapter 기준):
1. `connect(rpcUrl)` -- 체인 연결 (v1.1)
2. `disconnect()` -- 체인 연결 해제 (v1.1)
3. `isConnected()` -- 연결 상태 확인 (v1.1)
4. `getHealth()` -- 레이턴시 포함 헬스 체크 (v1.1)
5. `getBalance(address)` -- 네이티브 잔액 조회 (v1.1)
6. `buildTransaction(request)` -- 트랜잭션 빌드 (v1.1)
7. `simulateTransaction(tx)` -- 시뮬레이션 (v1.1)
8. `signTransaction(tx, privateKey)` -- 로컬 서명 (v1.1)
9. `submitTransaction(signedTx)` -- 제출 (v1.1)
10. `waitForConfirmation(txHash, timeout)` -- 확인 대기 (v1.1)
11. `getAssets(address)` -- 자산 목록 조회 (v1.3, REST API GET /v1/wallet/assets도 구현 완료)

v1.4에서 인터페이스 선언 추가 + 구현하는 9개:
12. `estimateFee(request)` -- 수수료 추정 (SPL ATA 생성 비용, ERC-20 gas 확장)
13. `buildTokenTransfer(request)` -- SPL/ERC-20 토큰 전송 빌드
14. `buildContractCall(request)` -- 컨트랙트 호출 빌드
15. `buildApprove(request)` -- approve 빌드
16. `buildBatch(request)` -- 배치 빌드 (Solana only)
17. `getTransactionFee(tx)` -- 트랜잭션 수수료 조회
18. `getTokenInfo(tokenAddress)` -- 토큰 메타데이터 조회
19. `getCurrentNonce(address)` -- EVM nonce 조회
20. `sweepAll(from, to)` -- 전체 자산 회수

### Stage 5 완전 의사코드 (CONC-01)

```
executeStage5(tx, adapter):
  retryCount = 0
  MAX_RETRIES = 2

  loop:
    // 5a. Build
    try:
      rawTx = adapter.buildTransaction(tx.request)
    catch (err):
      if err.category === 'PERMANENT': return FAILED(err)
      if err.category === 'TRANSIENT' && retryCount < MAX_RETRIES:
        retryCount++; await backoff(retryCount); continue
      return FAILED(err)

    // 5b. Simulate
    try:
      simResult = adapter.simulateTransaction(rawTx)
      if !simResult.success: return FAILED(simResult.error)
    catch (err):
      if err.category === 'TRANSIENT' && retryCount < MAX_RETRIES:
        retryCount++; await backoff(retryCount); continue
      return FAILED(err)

    // 5c. Sign
    try:
      signedTx = adapter.signTransaction(rawTx)
    catch (err):
      return FAILED(err)  // 서명 실패는 재시도 불가

    // 5d. Submit
    try:
      txHash = adapter.submitTransaction(signedTx)
      return SUBMITTED(txHash)
    catch (err):
      if err.code === 'DUPLICATE_TRANSACTION': return SUBMITTED(err.txHash)
      if err.category === 'STALE' && retryCount < MAX_RETRIES:
        retryCount++; continue  // blockhash 만료 -> 5a부터 재시도
      if err.category === 'TRANSIENT' && retryCount < MAX_RETRIES:
        retryCount++; await backoff(retryCount)
        continue from 5d  // submit만 재시도
      return FAILED(err)
```

### ChainError 3-카테고리 (ERRH-02)

| 카테고리 | retryable | 백오프 | 에러 코드 예시 |
|----------|:---------:|--------|-------------|
| PERMANENT (17개) | No | - | INSUFFICIENT_BALANCE, INVALID_ADDRESS, ACCOUNT_NOT_FOUND, CONTRACT_EXECUTION_FAILED, INVALID_INSTRUCTION, PROGRAM_NOT_FOUND, TOKEN_ACCOUNT_NOT_FOUND, INSUFFICIENT_TOKEN_BALANCE, SPENDER_NOT_APPROVED, ATA_CREATION_FAILED 등 |
| TRANSIENT (4개) | Yes | 지수 백오프 (1s, 2s, 4s, max 3회) | RPC_TIMEOUT, RPC_CONNECTION_ERROR, RATE_LIMITED, NODE_BEHIND |
| STALE (4개) | Yes (1회) | 즉시 재시도 (fresh 데이터) | BLOCKHASH_EXPIRED, NONCE_TOO_LOW, NONCE_ALREADY_USED, SLOT_SKIPPED |

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | EVM 테스트 노드 | Anvil (Foundry) | Hardhat보다 빠른 기동 속도, viem 친화적, 포크 모드 지원 |
| 2 | Solana SPL 토큰 테스트 | solana-test-validator + spl-token create-token | 로컬 validator에서 SPL 토큰 생성 -> ATA 생성 -> 전송 검증 |
| 3 | ERC-20 토큰 테스트 | Anvil 로컬 배포 | 표준 ERC-20 컨트랙트 배포 -> mint -> transfer 검증 |
| 4 | 배치 트랜잭션 DB 스키마 | transactions 테이블 자기참조 (parentId + batchIndex) | v0.10 OPER-02 결정 반영. 현재 스키마에 이미 parentId(FK) + batchIndex 컬럼 존재. 별도 batch_items 테이블 대신 동일 테이블 자기참조 사용. ON DELETE CASCADE로 부모 삭제 시 자식 자동 정리 |
| 5 | ChainError 코드 | 25개 에러 코드 (PERMANENT 17 + TRANSIENT 4 + STALE 4) | v0.10 ERRH-02 결정. category 필드에서 retryable 자동 파생 |
| 6 | Stage 5 재시도 파라미터 | 지수 백오프: 초기 1초, 배수 2x, 최대 3회 (MAX_RETRIES=2) | v0.10 CONC-01 결정. TRANSIENT는 백오프, STALE은 즉시 재시도 |
| 7 | EVM gas 추정 | viem estimateGas + 1.2x 배수 | estimateGas로 기본 추정 후 20% 마진. 급격한 gas 변동 대응 |
| 8 | CONTRACT_WHITELIST 저장 | DB policies 테이블 (config.toml 아님) | 에이전트별 독립 정책, 런타임 변경 가능, 기존 PolicyEngine 통합 |

---

## E2E 검증 시나리오

**자동화 비율: 100% -- `[HUMAN]` 0건**

### 토큰 전송

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | USDC 전송 (SPL) -> CONFIRMED | solana-test-validator에서 SPL 토큰 생성 + ATA 생성 + transferChecked -> 트랜잭션 CONFIRMED assert | [L1] |
| 2 | USDC 전송 (ERC-20) -> CONFIRMED | Anvil에서 ERC-20 배포 + mint + transfer -> 트랜잭션 CONFIRMED assert | [L1] |
| 3 | 미허용 토큰 전송 -> ALLOWED_TOKENS 거부 -> POLICY_DENIED 에러 코드 | ALLOWED_TOKENS 미설정 에이전트에서 토큰 전송 시도 -> 403 assert | [L0] |
| 4 | ALLOWED_TOKENS 설정 후 허용 토큰 전송 -> 성공 | 정책 생성 -> 허용 토큰 전송 -> CONFIRMED | [L0] |

### 자산 조회

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 5 | getAssets() -> SOL + USDC + BONK 잔액 반환 | mock RPC 응답으로 3개 토큰 잔액 반환, 네이티브 첫 번째 + 잔액 내림차순 정렬 assert | [L0] |
| 6 | getAssets() (EVM) -> ETH + USDC 잔액 반환 | mock RPC multicall 응답, ALLOWED_TOKENS 기반 보수적 조회 assert | [L0] |
| 7 | 토큰 없는 에이전트 -> 네이티브 토큰만 반환 | 빈 토큰 계좌 -> [{ tokenAddress: 'native', ... }] assert | [L0] |

### 컨트랙트 호출

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 8 | 허용된 컨트랙트 호출 (EVM) -> 실행 -> CONFIRMED | Anvil에서 화이트리스트 컨트랙트 배포 -> CONTRACT_WHITELIST 정책 설정 -> 호출 -> CONFIRMED assert | [L1] |
| 9 | 허용된 프로그램 호출 (Solana) -> 실행 -> CONFIRMED | solana-test-validator에서 프로그램 배포 -> 호출 -> CONFIRMED assert | [L1] |
| 10 | 미허용 컨트랙트 호출 -> CONTRACT_WHITELIST 거부 -> CONTRACT_NOT_WHITELISTED 에러 | 화이트리스트 미등록 주소 -> 403 assert | [L0] |
| 11 | CONTRACT_WHITELIST 미설정 에이전트 -> CONTRACT_CALL 전면 거부 | 정책 없음 -> CONTRACT_DISABLED 에러 assert | [L0] |

### Approve 관리

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 12 | Approve 요청 -> 독립 정책 평가 -> APPROVED_SPENDERS 검증 통과 | APPROVED_SPENDERS 정책 설정 + approve 요청 -> 정책 통과 assert | [L0] |
| 13 | 무제한 금액 Approve 요청 -> UNLIMITED_APPROVE_BLOCKED 차단 | amount=MAX_UINT256 -> block_unlimited 기본값 true -> 차단 assert | [L0] |
| 14 | 미허용 spender Approve -> SPENDER_NOT_APPROVED 에러 | APPROVED_SPENDERS에 없는 spender -> 거부 assert | [L0] |
| 15 | APPROVE_TIER_OVERRIDE 미설정 -> 기본 APPROVAL 티어 강제 | 정책 없음 -> APPROVAL 티어 (Owner 승인 필수) 결정 assert | [L0] |

### 배치 트랜잭션

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 16 | Solana 3-instruction 배치 -> 원자적 실행 -> CONFIRMED | solana-test-validator에서 SOL 전송 + SPL 전송 + memo 3개 instruction -> 단일 tx CONFIRMED assert | [L1] |
| 17 | 배치 부분 실패 (EVM) -> BATCH_NOT_SUPPORTED 에러 | EVM 체인에서 배치 요청 -> BATCH_NOT_SUPPORTED 에러 코드 assert | [L0] |
| 18 | 배치 정책 합산: 소액 분할 우회 시도 -> 합산 SPENDING_LIMIT 거부 | 10개 소액 instruction 합산이 APPROVAL 티어 -> 전체 거부 assert | [L0] |
| 19 | 배치 All-or-Nothing: 1개 instruction 정책 위반 -> 전체 거부 | 3개 중 1개 WHITELIST 위반 -> 전체 배치 거부 assert | [L0] |
| 20 | 부모-자식 DB: 배치 트랜잭션 조회 -> 자식 트랜잭션 포함 | GET /v1/transactions/:id -> parentId가 일치하는 자식 트랜잭션 items 배열 포함 assert | [L0] |

### EVM 어댑터

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 21 | EVM ETH 전송 -> CONFIRMED | Anvil에서 ETH 전송 -> EIP-1559 트랜잭션 -> CONFIRMED assert | [L1] |
| 22 | EVM ERC-20 전송 -> CONFIRMED | Anvil에서 ERC-20 토큰 transfer -> CONFIRMED assert | [L1] |
| 23 | EVM gas 추정 -> viem estimateGas * 1.2x | estimateFee 호출 -> gas 추정값 * 1.2 배수 적용 assert | [L0] |

### Stage 5 의사코드 분기

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 24 | Stage 5 TRANSIENT 에러 -> 지수 백오프 재시도 -> 최종 성공 | mock adapter: 첫 2회 RPC_TIMEOUT, 3회째 성공 -> SUBMITTED assert | [L0] |
| 25 | Stage 5 PERMANENT 에러 -> 즉시 FAILED -> 에러 코드 반환 | mock adapter: INSUFFICIENT_BALANCE -> 재시도 없이 즉시 FAILED assert | [L0] |
| 26 | Stage 5 STALE blockhash -> fresh 데이터로 재시도 -> 성공 | mock adapter: 첫 submit BLOCKHASH_EXPIRED -> 5a부터 재빌드 -> SUBMITTED assert | [L0] |
| 27 | Stage 5 DUPLICATE_TRANSACTION -> SUBMITTED 반환 (정상) | mock adapter: submit 시 DUPLICATE -> 기존 txHash로 SUBMITTED 처리 assert | [L0] |
| 28 | Stage 5 sign 실패 -> 재시도 없이 즉시 FAILED | mock adapter: signTransaction 에러 -> 재시도 0회 FAILED assert | [L0] |

### discriminatedUnion + IChainAdapter

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 29 | discriminatedUnion: TransferRequest 파싱 -> type='TRANSFER' 식별 | Zod parse + type 필드 assert | [L0] |
| 30 | discriminatedUnion: TokenTransferRequest 파싱 -> type='TOKEN_TRANSFER' 식별 | Zod parse + token 필드 포함 assert | [L0] |
| 31 | discriminatedUnion: ContractCallRequest 파싱 -> type='CONTRACT_CALL' 식별 | Zod parse + calldata/programId 필드 assert | [L0] |
| 32 | discriminatedUnion: ApproveRequest 파싱 -> type='APPROVE' 식별 | Zod parse + spender/token 필드 assert | [L0] |
| 33 | discriminatedUnion: BatchRequest 파싱 -> type='BATCH' 식별 | Zod parse + instructions 배열 assert | [L0] |
| 34 | IChainAdapter 20 메서드 전수: SolanaAdapter에서 모든 메서드 호출 가능 | 각 메서드 호출 -> TypeError 없음 + 적절한 반환 타입 assert | [L0] |
| 35 | IChainAdapter 20 메서드 전수: EvmAdapter에서 모든 메서드 호출 가능 | 각 메서드 호출 -> TypeError 없음 + 적절한 반환 타입 assert (buildBatch는 BATCH_NOT_SUPPORTED) | [L0] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.3 (SDK + MCP + 알림) | 토큰/컨트랙트 확장 API가 SDK/MCP를 통해 호출됨. 알림 시스템이 토큰 전송/컨트랙트 호출/approve 이벤트를 Owner에게 알림 |

---

## 선행 과제 (구현 순서 의존성)

v1.4 본격 구현 전에 완료해야 하는 인프라 작업:

| # | 선행 과제 | 이유 | 현재 상태 |
|---|----------|------|----------|
| P-1 | ChainError 클래스 + 3-카테고리 시스템 | Stage 5 의사코드(CONC-01)가 `err.category` (PERMANENT/TRANSIENT/STALE) 분기에 전적으로 의존. ChainError 없이는 Stage 5 재시도 로직 구현 불가 | 미구현. ERROR_CODES 객체(68개)만 존재, ChainError 클래스 없음 |
| P-2 | DB 마이그레이션 러너 구현 | v1.4부터 DB 마이그레이션 필수 정책(설계 문서 65). 스키마 변경 시 ALTER TABLE 증분 마이그레이션 제공 필요. 현재 schema_version 테이블은 존재하나 실제 마이그레이션 실행 메커니즘 없음 | schema_version 테이블 존재 (version 1), 마이그레이션 러너 미구현 |
| P-3 | `@waiaas/adapter-evm` 패키지 스캐폴딩 | EVM 어댑터 코드가 전무. monorepo workspace 등록, tsconfig, viem 2.x 의존성 설치, 기본 패키지 구조 생성 필요 | 패키지 미존재, viem 미설치 |
| P-4 | discriminatedUnion 스키마 정의 | 현재 SendTransactionRequestSchema는 기본 transfer만 지원. 5-type discriminatedUnion으로 교체해야 모든 Stage에서 type별 분기 가능 | SendTransactionRequestSchema(to/amount/memo만), discriminatedUnion 미구현 |

### 구현 순서 권장

```
P-1 ChainError ─┐
P-2 DB Migration ├─→ 토큰/컨트랙트/Approve/배치 구현
P-3 EVM 스캐폴딩 ┤
P-4 discriminatedUnion ─┘
```

---

## DD-04 마이그레이션 영향 분석

`INSUFFICIENT_FOR_FEE` 에러 코드를 WITHDRAW → TX 도메인으로 이동하는 것은 breaking change:

| 영향 범위 | 확인 사항 |
|----------|----------|
| SDK (`@waiaas/sdk`) | `WAIaaSError.code` 비교 코드에서 도메인 참조 여부 확인 |
| MCP (`@waiaas/mcp`) | 에러 전달 시 도메인 필드 포함 여부 확인 |
| Admin UI | 에러 코드 표시 로직에서 도메인 필터링 여부 확인 |
| Python SDK | error code 매핑에서 WITHDRAW 도메인 하드코딩 여부 확인 |

**결론:** httpStatus 500 → 400 변경과 도메인 이동을 동시 수행. SDK/MCP는 `code` 필드(도메인 아닌)로 에러 판별하므로 실질 영향 없음. 단, Python SDK 에러 매핑 테스트 필요.

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | EVM 어댑터 viem 2.x API 변경 가능성 | Client/Action 패턴 변경 시 어댑터 수정 필요 | viem 2.x 고정, 마이너 업데이트만 허용. API 변경 시 Tier 1 인라인 수정 |
| 2 | Solana SPL 토큰 프로그램 API 변경 | @solana-program/token 패키지 호환성 | @solana/kit 6.x 기반 (현재 6.0.1 설치), getTransferCheckedInstruction 인터페이스 안정 |
| 3 | 배치 트랜잭션 Solana 크기 제한 | 1232 바이트 패킷 제한으로 instruction 수 실질 제한 | max 20 제한 + 시뮬레이션으로 크기 초과 사전 감지. TRANSACTION_TOO_LARGE 에러 코드 |
| 4 | PARTIAL_FAILURE 상태 복구 UX | EVM 배치 미지원으로 인한 사용자 혼란 | EVM에서 BATCH_NOT_SUPPORTED 명확한 에러 반환. Solana only 원자적 배치 지원 명시 |
| 5 | ChainError 25개 코드 실제 체인 에러 매핑 정확도 | 체인 RPC 에러 메시지가 코드와 불일치 가능 | RPC 에러 메시지 패턴 매칭으로 카테고리 자동 분류. 미매핑 에러는 PERMANENT 기본 |
| 6 | Stage 5 의사코드 구현 복잡도 | build -> simulate -> sign -> submit + 에러 분기 + 재시도 경로 수가 많음 | 상태 머신 패턴으로 경로 관리. 각 분기별 독립 테스트 (시나리오 24-28) |
| 7 | Token-2022 프로그램 호환성 | Solana Token-2022 (Token Extensions)의 transferChecked 분기 | buildSplTokenTransfer에서 프로그램 ID 기반 Token/Token-2022 자동 분기 |
| 8 | EVM nonce 관리 동시성 | 동시 트랜잭션 제출 시 nonce 충돌 | getCurrentNonce + 인메모리 nonce 트래킹 + resetNonceTracker 복구 (v0.7 설계) |

---

## 설계 부채 해소

### DD-04: 가스비 부족 에러 코드 분리

**문제:** `INSUFFICIENT_FOR_FEE` 에러 코드가 WITHDRAW 도메인에만 존재하고, `estimateFee()` 및 Stage 5에서 가스비 부족 시 `INSUFFICIENT_BALANCE`를 사용하여 에이전트가 "전송 금액 부족"과 "가스비 부족"을 구분할 수 없음.

**해결 방안:**

| 항목 | 변경 내용 |
|------|----------|
| error-codes.ts | `INSUFFICIENT_FOR_FEE`를 TX 도메인으로 이동/확장 (HTTP 400, retryable: false) |
| estimateFee() | 잔액 < 수수료일 때 `INSUFFICIENT_FOR_FEE` 사용 (INSUFFICIENT_BALANCE 대신) |
| Stage 5 (시뮬레이션) | Solana/EVM 시뮬레이션 에러 파싱 시 가스비 부족 패턴 감지 → `INSUFFICIENT_FOR_FEE` 매핑 |
| 에러 hint | `"Insufficient native token for fee. Required: {required}, Available: {available}, Shortfall: {shortfall}."` |
| 에러 details | `{ required: string, available: string, shortfall: string, feeCurrency: string }` 포함 |
| SDK | `WAIaaSError.code === 'INSUFFICIENT_FOR_FEE'`로 가스비 부족 판별 가능 |

**에이전트 복구 판단 기준:**

| 에러 코드 | 의미 | 에이전트 조치 |
|----------|------|-------------|
| `INSUFFICIENT_BALANCE` | 전송 금액 부족 | 전송 금액 줄이거나 잔액 충전 |
| `INSUFFICIENT_FOR_FEE` | 가스비/수수료 부족 | 네이티브 토큰(SOL/ETH) 충전 |
| `INSUFFICIENT_TOKEN_BALANCE` | 토큰 잔액 부족 | 해당 토큰 충전 |

---

*최종 업데이트: 2026-02-12 코드베이스 재검증 — IChainAdapter "20 메서드" 표현 정정(현재 인터페이스 11개 선언, v1.4에서 9개 선언 추가+구현 명시). 2026-02-12 마일스톤 시작 전 정정 — getAssets 구현 시점 v1.1→v1.3 정정, IChainAdapter 메서드 구현 이력 명확화(v1.1 10개+v1.3 1개), PolicyType ERRH-03 표현 정정(enum 이미 존재, 평가 로직 구현 필요). 2026-02-12 코드베이스 대조 검증 — 7건 불일치 정정. 2026-02-11 DD-04 설계 부채 해소 항목 추가. 2026-02-09 v1.0 구현 계획 기반 생성, v0.10 설계 결정(CONC-01/ERRH-02/OPER-02/ERRH-03/PLCY-01) 반영*
