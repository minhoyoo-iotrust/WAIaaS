# 마일스톤 v1.6: 운영 인프라 + 잔액 모니터링

## 목표

Kill Switch/AutoStop으로 긴급 제어, Telegram Bot으로 원격 관리, Docker로 원클릭 배포, 잔액 모니터링으로 가스비 부족 사전 알림이 동작하는 상태. Desktop App은 v2.6/v2.6.1에서 구현한다 (v2.0 이후 이연).

---

## 구현 대상 설계 문서

이 마일스톤에서 구현하는 설계 문서 목록과 각 문서에서 구현할 범위를 명시한다.

| 문서 | 이름 | 구현 범위 | 전체/부분 |
|------|------|----------|----------|
| 40 | telegram-bot-docker | Telegram Bot: TelegramBotService(Long Polling getUpdates, 5초 폴링 간격, 오프셋 기반), 9개 명령어(/start, /status, /pending, /approve, /reject, /killswitch, /wallets, /newsession, /help), 인라인 키보드(Approve/Reject 버튼, 월렛 선택 키보드, Kill Switch 확인 대화), 2-Tier 인증(관리자=ownerAuth 대리: chatId 등록+승인 권한, 읽기전용=chatId 등록+조회만), native fetch 전용(외부 Bot 프레임워크 미사용). Docker: Multi-stage Dockerfile(builder: node:22-slim+pnpm install+turbo build, runner: node:22-slim+non-root UID 1001), docker-compose.yml(daemon 서비스+named volume ~/.waiaas 데이터 영속+HEALTHCHECK curl /v1/health), Docker Secrets+_FILE 패턴(마스터 패스워드, Telegram Bot Token), 포트 매핑 3100:3100(localhost only) | 전체 |
| 36 | killswitch-autostop-evm | Kill Switch: KillSwitchService 3-state 상태 머신(ACTIVE/SUSPENDED/LOCKED), 6-step cascade(세션 무효화->진행 중 거래 중단->월렛 전체 정지->API 503 잠금->알림 발송->감사 로그 기록), dual-auth 복구(Owner SIWS/SIWE 서명+Master 패스워드 Argon2id 검증->ACTIVE 전환), 4전이 CAS ACID 패턴(ACTIVE->SUSPENDED, SUSPENDED->LOCKED, SUSPENDED->ACTIVE, LOCKED->ACTIVE), Kill Switch API(POST /v1/owner/kill-switch ownerAuth, POST /v1/admin/kill-switch masterAuth). AutoStop Engine: AutoStopService 4 규칙(CONSECUTIVE_FAILURES 5회 연속 실패, UNUSUAL_ACTIVITY 이상 패턴, IDLE_TIMEOUT 유휴 시간 초과, MANUAL_TRIGGER 수동 트리거 — DAILY_SPENDING_LIMIT는 v1.5.3 CUMULATIVE_SPENDING_DAILY 정책과 중복이므로 제거), 이벤트 기반 트리거(EventEmitter 기반 트랜잭션/월렛 이벤트 발행 + AutoStopService 구독), 규칙별 월렛 정지 또는 Kill Switch 자동 발동. EVM 어댑터 부분은 v1.4에서 이미 구현 완료 | 부분 (Kill Switch + AutoStop만, EVM 어댑터 제외) |
| (신규) | balance-monitoring | 잔액 모니터링 스케줄러 + LOW_BALANCE NotificationEventType 추가 + 가스비 부족 사전 알림. config.toml 임계값 설정, 월렛별 주기적 잔액 체크, 임계값 이하 시 알림 발송 | 전체 |

### v0.10 설계 결정 반영

v0.10에서 확정된 설계 결정을 v1.6 구현에 반영한다:

| 결정 ID | 내용 | 적용 범위 |
|---------|------|----------|
| CONC-03 | Kill Switch 4전이 CAS ACID 패턴: SQLite BEGIN IMMEDIATE + UPDATE WHERE state = expected 조건으로 동시성 제어. 4개 전이 모두 WHERE value = :expectedCurrentState 조건 포함. 두 요청 동시 도착 시 하나만 성공, 나머지 409 반환 | KillSwitchService 상태 전이 전체, ACTIVE->SUSPENDED/SUSPENDED->LOCKED/SUSPENDED->ACTIVE/LOCKED->ACTIVE |

### 구현 범위 상세

#### v1.4/v1.5에서 이미 구현된 부분 (v1.6에서 활용)

- EVM 어댑터 (viem 2.x, EIP-1559, ERC-20, gas 추정, nonce 관리) -- v1.4에서 구현
- REST API 50+ 엔드포인트 (v1.3~v1.5.3 누적)
- @waiaas/sdk TypeScript SDK (v1.3에서 구현)
- MCP Server 15+ 도구 + Action Provider 동적 도구 (v1.3~v1.5 누적)
- 세션 인증(sessionAuth), 마스터 인증(masterAuth), Owner 인증(ownerAuth) -- v1.2에서 구현
- DatabasePolicyEngine 4-tier 정책 평가 -- v1.2에서 구현
- 알림 아키텍처 INotificationChannel, 4채널(Telegram/Discord/ntfy/Slack, 알림 발송 전용) -- v1.3~v1.3.4에서 구현
- Owner API approve/reject, sessions, status 엔드포인트 -- v1.2에서 구현

#### v1.6에서 새로 추가하는 부분

- TelegramBotService (Long Polling, 명령 수신, 인라인 키보드 인터랙션)
- Kill Switch KillSwitchService (3-state 상태 머신, 6-step cascade, dual-auth 복구) -- 기존 kill-switch-guard.ts skeleton(`ACTIVATED` 상태 체크)을 3-state 모델로 리팩토링
- AutoStop Engine AutoStopService (4 규칙 기반 자동 정지 — v1.5.3 CUMULATIVE_SPENDING_DAILY와 중복된 DAILY_SPENDING_LIMIT 제거)
- 이벤트 버스 (EventEmitter 기반 트랜잭션/월렛 이벤트 발행 — AutoStopService·BalanceMonitorService 구독용. 기존 NotificationService.notify() 호출 지점에서 이벤트 동시 발행)
- Docker 배포 (Multi-stage Dockerfile, docker-compose, named volume, Secrets, entrypoint.sh)
- 잔액 모니터링 스케줄러 (BalanceMonitorService, 주기적 잔액 체크 + LOW_BALANCE 알림)

#### v2.6/v2.6.1에서 구현 (v2.0 이후 이연)

- Tauri 2 Desktop 앱 전체 (Rust Backend + WebView Frontend + 8개 화면)
- Sidecar Manager (Node.js SEA 바이너리 관리, crash detection, graceful 종료)
- 시스템 트레이 (3색 상태 아이콘, 컨텍스트 메뉴)
- Setup Wizard 5단계 (초기 설정 GUI 흐름)
- WalletConnect @reown/appkit Tauri 통합 (QR 페어링, SIWS/SIWE 서명)

> Desktop App은 배포 채널이므로 v2.0 릴리스 후 진행. 설계는 v2.6, 구현은 v2.6.1에서 수행.

---

## 산출물

### 컴포넌트

| 컴포넌트 | 내용 |
|----------|------|
| Telegram Bot | TelegramBotService: 기존 TelegramChannel(알림 발송 전용, sendMessage 단방향)과 동일 Bot Token을 공유하되 별도 서비스로 구현. Long Polling 기반 명령 수신 + 인라인 키보드 상호작용 담당(getUpdates, 5초 폴링 간격, 오프셋 기반, 네트워크 단절 시 지수 백오프 재연결). 2-Tier 인증: 관리자(chat_id 등록 + ownerAuth 대리 + 승인/거부/killswitch 권한), 읽기전용(chat_id 등록 + 조회만). chatId 등록 방식: `/start` 명령 시 `telegram_users` 테이블에 자동 등록(role=PENDING), Admin UI에서 관리자가 role 승인(ADMIN/READONLY) — `telegram_users(chat_id PK, username, role TEXT CHECK('PENDING','ADMIN','READONLY'), registered_at, approved_at)` DB 테이블 + DB 마이그레이션 추가. 9개 명령어: /start(봇 시작+chat_id 등록), /status(데몬 상태+월렛 요약), /pending(대기 중 거래 목록), /approve {txId}(거래 승인), /reject {txId}(거래 거부), /killswitch(긴급 정지 발동), /wallets(월렛 목록), /newsession(새 세션 발급+월렛 선택 인라인 키보드), /help(명령어 도움말). 인라인 키보드: Approve/Reject 버튼(callback_query 처리), 월렛 선택 키보드(/newsession용), Kill Switch 확인 대화("정말 실행하시겠습니까?" Yes/No). MarkdownV2 포매팅 |
| Kill Switch | KillSwitchService: 3-state 상태 머신(ACTIVE=정상/SUSPENDED=일시 정지/LOCKED=영구 잠금). 기존 kill-switch-guard.ts skeleton(`NORMAL`/`ACTIVATED` 2-state)을 3-state 모델로 리팩토링 — 상태명 매핑: `NORMAL`→`ACTIVE`, `ACTIVATED`→삭제(SUSPENDED/LOCKED 2단계로 분리). keyValueStore의 `kill_switch_state` 키 값을 `NORMAL`→`ACTIVE`로 마이그레이션. 6-step cascade: (1)세션 전체 무효화(revoked_at 일괄 갱신) -> (2)진행 중 거래 중단(QUEUED/EXECUTING -> CANCELLED) -> (3)월렛 전체 정지(status=SUSPENDED) -> (4)API 503 잠금(killSwitch 미들웨어 SYSTEM_LOCKED 반환) -> (5)알림 발송(INotificationChannel.send KILL_SWITCH_ACTIVATED) -> (6)감사 로그 기록(audit_log 테이블). 4전이 CAS ACID: BEGIN IMMEDIATE + UPDATE WHERE state=expected, 동시 요청 하나만 성공/나머지 409. dual-auth 복구: SUSPENDED->ACTIVE = Owner 서명(SIWS/SIWE) + Master 패스워드(Argon2id), LOCKED->ACTIVE = 동일 dual-auth + 추가 대기 시간 |
| AutoStop Engine | AutoStopService: 4 규칙 기반 자동 정지 (DAILY_SPENDING_LIMIT는 v1.5.3 CUMULATIVE_SPENDING_DAILY 정책과 중복이므로 제거). CONSECUTIVE_FAILURES(5회 연속 트랜잭션 실패 -> 월렛 정지), UNUSUAL_ACTIVITY(정상 패턴 대비 이상 감지 -> 월렛 정지 + 알림), IDLE_TIMEOUT(설정 시간 이상 유휴 -> 세션 해지), MANUAL_TRIGGER(수동 트리거 -> Kill Switch 발동). 이벤트 기반: EventEmitter 이벤트 버스를 v1.6에서 신규 도입하여 TransactionCompleted/TransactionFailed/WalletActivity 이벤트 구독. 기존 파이프라인 NotificationService.notify() 호출 지점에서 이벤트를 동시 발행 |
| 잔액 모니터링 | BalanceMonitorService: 주기적 잔액 체크 스케줄러. config.toml flat key(monitoring_check_interval_sec=300 기본 5분, monitoring_low_balance_threshold_sol=0.01, monitoring_low_balance_threshold_eth=0.005) + Admin Settings 런타임 오버라이드. 월렛별 네이티브 토큰 잔액 조회(getBalance), 임계값 이하 시 `LOW_BALANCE` 알림 발송(NotificationService.notify). 중복 알림 방지(동일 월렛 24시간 내 1회). AutoStopService와 동일 EventEmitter 기반 스케줄러 패턴. NotificationEventType에 `LOW_BALANCE` 추가(23번째 이벤트, 기존 22개: v1.5.3 CUMULATIVE_LIMIT_WARNING까지). 메시지 템플릿 en/ko 추가("Wallet {walletId} balance low: {balance} {currency}. Threshold: {threshold}") |
| Docker | Multi-stage Dockerfile: builder 스테이지(FROM node:22-slim, pnpm install --frozen-lockfile, turbo build --filter=@waiaas/daemon), runner 스테이지(FROM node:22-slim, COPY --from=builder, non-root UID 1001 useradd waiaas, EXPOSE 3100). docker-compose.yml: daemon 서비스(build: ., ports: "127.0.0.1:3100:3100", volumes: waiaas-data:/home/waiaas/.waiaas, restart: unless-stopped, healthcheck: curl -f http://localhost:3100/v1/health). named volume(waiaas-data -> ~/.waiaas 데이터 영속, restart 후 데이터 유지). Docker Secrets + _FILE 패턴: `docker/entrypoint.sh` 쉘 스크립트에서 처리 — `*_FILE` 환경변수 감지 시 해당 파일 내용을 읽어 원본 환경변수로 설정 후 데몬 실행(MASTER_PASSWORD_FILE→WAIAAS_SECURITY_MASTER_PASSWORD, TELEGRAM_BOT_TOKEN_FILE→WAIAAS_TELEGRAM_BOT_TOKEN). HEALTHCHECK(interval 30s, timeout 5s, retries 3) |

### 다국어(i18n) 적용

Telegram Bot과 잔액 모니터링 알림은 사람이 직접 보는 인터페이스이므로, config.toml `locale` 설정에 따라 영문/한글을 지원한다. Desktop UI i18n은 v2.6.1에서 적용한다.

#### 적용 범위

**Telegram Bot:**
- 9개 명령어 응답 메시지 (MarkdownV2 포매팅)
- 인라인 키보드 버튼 레이블 (Approve/Reject, Yes/No, 월렛 선택)
- /start 환영 메시지, /help 도움말 텍스트
- Kill Switch 확인 대화 ("정말 실행하시겠습니까?")
- 에러/권한 거부 메시지 (읽기전용 사용자 승인 시도 등)

**영문 고정 (i18n 미적용):**
- 로그 메시지 (console.error, Sidecar Manager 로그)
- Rust Backend IPC 에러 (개발자 디버깅용)
- Docker 헬스체크 로그
- config.toml 키 이름, 환경변수

#### 적용 방식

**Telegram Bot:**
- TelegramBotService 초기화 시 `locale` 주입
- 명령어 응답 생성 시 `getMessages(locale)` 함수로 메시지 템플릿 로드
- MarkdownV2 포매팅은 언어와 독립 (포맷 계층은 동일, 텍스트만 교체)
- 메시지 키 예시: `BOT_WELCOME`, `BOT_STATUS_HEADER`, `BOT_KILLSWITCH_CONFIRM`, `KEYBOARD_APPROVE`, `KEYBOARD_REJECT`

#### 언어별 예시

| 컴포넌트 | 키 | 영문 (en) | 한글 (ko) |
|----------|-----|----------|----------|
| Telegram | BOT_WELCOME | Welcome to WAIaaS Bot! | WAIaaS Bot에 오신 것을 환영합니다! |
| Telegram | KEYBOARD_APPROVE | ✅ Approve | ✅ 승인 |
| Telegram | BOT_KILLSWITCH_CONFIRM | ⚠️ Activate Kill Switch? | ⚠️ Kill Switch를 발동하시겠습니까? |
| 잔액 모니터링 | LOW_BALANCE_TITLE | Low Balance Alert | 잔액 부족 알림 |
| 잔액 모니터링 | LOW_BALANCE_BODY | Wallet {walletId} balance low: {balance} {currency}. Threshold: {threshold}. | 월렛 {walletId} 잔액 부족: {balance} {currency}. 임계값: {threshold}. |

### 파일/모듈 구조

```
packages/daemon/src/
  services/
    killswitch/
      killswitch-service.ts          # KillSwitchService (3-state + 6-step + CAS)
      autostop-service.ts            # AutoStopService (4 규칙)
      autostop-rules.ts              # 개별 규칙 구현
    events/
      event-bus.ts                   # EventEmitter 기반 이벤트 버스 (신규 도입)
      event-types.ts                 # TransactionCompleted/TransactionFailed/WalletActivity 이벤트 정의
    monitoring/
      balance-monitor-service.ts     # BalanceMonitorService (주기적 잔액 체크)
  infrastructure/
    telegram/
      telegram-bot-service.ts        # TelegramBotService (Long Polling + 9 명령어)
      telegram-commands.ts           # 명령어 핸들러 (start/status/pending/...)
      telegram-keyboard.ts           # 인라인 키보드 빌더
      telegram-auth.ts               # 2-Tier 인증 (관리자/읽기전용, telegram_users 테이블 참조)
  middleware/
    killswitch-guard.ts              # Kill Switch 503 미들웨어 (기존 skeleton → 3-state 리팩토링)

docker/
  Dockerfile                         # Multi-stage Dockerfile
  docker-compose.yml                 # compose 설정
  entrypoint.sh                      # _FILE 패턴 처리 + 데몬 실행
  .dockerignore                      # 빌드 컨텍스트 제외
```

---

## 기술 결정 사항

| # | 결정 항목 | 선택지 | 결정 근거 |
|---|----------|--------|----------|
| 1 | Telegram Bot 라이브러리 | native fetch 전용 (프레임워크 미사용) | NOTI-ARCH(문서 35) 결정: 외부 Bot 프레임워크(telegraf/grammy) 불필요. Telegram Bot API는 단순 HTTP 호출이므로 native fetch로 충분. Long Polling getUpdates + sendMessage + answerCallbackQuery 3개 API만 사용 |
| 2 | Docker base 이미지 | node:22-slim | alpine 대비 native addon(sodium-native, better-sqlite3) 호환성 우수. glibc 기반으로 prebuildify 바이너리 직접 사용 가능. slim으로 불필요한 패키지 제거하여 이미지 크기 최소화 |
| 3 | Kill Switch CAS 구현 | SQLite BEGIN IMMEDIATE + UPDATE WHERE state = expected | v0.10 CONC-03 결정. SQLite 단일 writer 특성 활용. BEGIN IMMEDIATE로 즉시 write lock 획득. WHERE 조건으로 현재 상태 확인. affected rows=0이면 이미 전이됨 -> 409 반환 |
| 4 | AutoStop 규칙 저장 | config.toml flat key(autostop_consecutive_failures_threshold=5, autostop_idle_timeout_sec=3600 등) + Admin Settings 런타임 오버라이드 | 규칙 임계값 초기값은 config.toml flat key(CLAUDE.md 중첩 금지 규칙 준수). DAILY_SPENDING_LIMIT는 v1.5.3 CUMULATIVE_SPENDING_DAILY 정책과 중복이므로 AutoStop에서 제거. 런타임 조정이 유용한 임계값은 SettingsService autostop 카테고리로 Admin UI에서 hot-reload 가능. policies 테이블은 월렛별 트랜잭션 정책 전용이므로 혼용 방지 |
| 5 | Telegram i18n | `@waiaas/core/i18n` 메시지 키 참조 | v1.1에서 정의한 i18n 구조 활용. Telegram은 서비스 초기화 시 locale 주입. 별도 i18n 프레임워크 미사용, 메시지 키 직접 참조로 단순화 |
| 6 | notification_channels 설정 | config.toml `notification_channels` enum에 `SLACK` 추가 | v1.4.8에서 Slack 채널 구현 완료했으나 config schema enum에 누락됨. v1.6에서 `['TELEGRAM', 'DISCORD', 'NTFY', 'SLACK']`으로 수정 |
| 7 | Docker _FILE 패턴 처리 | `docker/entrypoint.sh` 쉘 스크립트 | Docker 관행에 따라 entrypoint에서 `*_FILE` 환경변수를 감지하여 파일 내용을 읽고 원본 환경변수로 설정 후 `exec node` 실행. Node.js config loader 변경 불필요 |
| 8 | chatId 저장소 | `telegram_users` DB 테이블 + Admin UI 관리 | config.toml은 런타임 변경이 어려우므로 DB 저장. `/start` 시 PENDING으로 자동 등록, Admin UI에서 ADMIN/READONLY로 승인. DB 마이그레이션 추가 필요 |

---

## E2E 검증 시나리오

**자동화 비율: 90%+ -- `[HUMAN]` 2건**

### Docker

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 1 | docker compose up -> health check -> SDK 거래 성공 | docker compose up -d -> HEALTHCHECK 통과 대기 -> @waiaas/sdk로 SOL 전송 -> CONFIRMED assert | [L1] |
| 2 | named volume 영속성 -- restart 후 데이터 유지 | docker compose up -> 월렛 생성 -> docker compose down -> docker compose up -> 월렛 조회 성공 assert | [L1] |
| 3 | non-root UID 1001 -- 프로세스 권한 확인 | docker compose exec daemon whoami -> waiaas assert + id -u -> 1001 assert | [L0] |
| 4 | Docker Secrets _FILE 패턴 -- 시크릿 파일에서 환경변수 로드 | docker secret create + compose secrets 설정 -> 데몬 시작 시 MASTER_PASSWORD_FILE 읽기 성공 assert | [L1] |
| 5 | HEALTHCHECK 실패 시 컨테이너 unhealthy 상태 | 데몬 프로세스 강제 종료 -> docker inspect healthcheck.status -> unhealthy assert | [L1] |

### Kill Switch

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 6 | Kill Switch cascade: ACTIVE->SUSPENDED -> 세션 무효화 + 거래 중단 + API 503 | POST /v1/admin/kill-switch -> 세션 조회 전체 revoked assert + QUEUED 거래 CANCELLED assert + 일반 API 503 assert | [L0] |
| 7 | Kill Switch SUSPENDED->LOCKED -> 복구 불가 상태 | SUSPENDED 상태에서 LOCK 전이 -> LOCKED 상태에서 일반 복구 시도 실패 assert (dual-auth + 추가 대기 필요) | [L0] |
| 8 | Kill Switch 복구: dual-auth(Owner서명 + Master패스워드) -> ACTIVE 전환 | SUSPENDED 상태 -> POST /v1/admin/recover (ownerAuth + masterAuth) -> ACTIVE 전환 + API 정상 동작 재개 assert | [L0] |
| 9 | Kill Switch CAS 동시성: 두 요청 동시 전이 -> 하나만 성공 | Promise.all([killswitch(), killswitch()]) -> 하나 200 + 하나 409 assert + DB 상태 일관성 assert | [L0] |
| 10 | Kill Switch 4전이 전수: 각 전이별 CAS 정상 동작 | ACTIVE->SUSPENDED, SUSPENDED->LOCKED, SUSPENDED->ACTIVE(복구), LOCKED->ACTIVE(복구) 4가지 전이 각각 테스트 + WHERE 조건 assert | [L0] |
| 11 | Kill Switch 잘못된 전이 시도 -> 409 거부 | ACTIVE에서 직접 LOCKED 시도 -> 409 assert, LOCKED에서 SUSPENDED 시도 -> 409 assert | [L0] |

### AutoStop Engine

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 12 | CONSECUTIVE_FAILURES(5회) -> 월렛 자동 정지 | 5회 연속 TransactionFailed 이벤트 발생 -> 월렛 status=SUSPENDED + 알림 mock 수신 assert | [L0] |
| 13 | UNUSUAL_ACTIVITY 이상 패턴 -> 월렛 정지 + 알림 | 정상 패턴 대비 10배 빈도 거래 시뮬레이션 -> 월렛 정지 + UNUSUAL_ACTIVITY 알림 assert | [L0] |
| 14 | IDLE_TIMEOUT 유휴 시간 초과 -> 세션 해지 | idle_timeout=60 설정 + 120초 무활동 -> 세션 자동 해지 assert | [L0] |
| 15 | EventEmitter 이벤트 발행 -> AutoStop 규칙 트리거 | 파이프라인 TX_FAILED -> EventEmitter TransactionFailed 이벤트 발행 -> AutoStopService 수신 + 카운터 증가 assert | [L0] |

### 잔액 모니터링

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 16 | 잔액 임계값 이하 -> LOW_BALANCE 알림 발송 | low_balance_threshold_sol=0.01 설정 + 월렛 잔액 0.005 SOL -> LOW_BALANCE 알림 mock 수신 assert | [L0] |
| 17 | 잔액 임계값 이상 -> 알림 미발송 | 월렛 잔액 1.0 SOL -> 알림 미발송 assert | [L0] |
| 18 | 중복 알림 방지 -> 24시간 내 동일 월렛 1회만 발송 | LOW_BALANCE 알림 1회 발송 후 -> 다음 체크 주기에 동일 월렛 알림 미발송 assert | [L0] |
| 19 | 잔액 회복 후 다시 하락 -> 새 알림 발송 | LOW_BALANCE -> 잔액 충전 -> 다시 하락 -> 새 LOW_BALANCE 알림 발송 assert | [L0] |

### Telegram Bot

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 20 | /status -> 데몬 상태 + 월렛 요약 반환 | mock Telegram Bot API -> /status 명령 전송 -> sendMessage 호출 파라미터에 데몬 상태 + 월렛 수 포함 assert | [L0] |
| 21 | /pending -> 대기 중 거래 목록 반환 | APPROVAL 대기 거래 2건 생성 -> /pending 명령 -> 거래 목록 + 인라인 키보드(Approve/Reject) 포함 sendMessage assert | [L0] |
| 22 | /approve {txId} -> 거래 승인 + 상태 전이 | APPROVAL 대기 거래 -> /approve TX-001 명령 -> masterAuth 대리 승인 -> 거래 상태 EXECUTING 전이 assert | [L0] |
| 23 | /reject {txId} -> 거래 거부 + 상태 전이 | APPROVAL 대기 거래 -> /reject TX-001 명령 -> 거래 상태 REJECTED 전이 assert | [L0] |
| 24 | 2-Tier auth -- 관리자 승인, 읽기전용 조회만 가능 | 관리자 chat_id -> /approve 성공 assert + 읽기전용 chat_id -> /approve 권한 거부 assert | [L0] |
| 25 | /killswitch -> 확인 요청 -> 실행 -> 결과 알림 | /killswitch 명령 -> 확인 인라인 키보드(Yes/No) -> Yes 클릭 -> Kill Switch 발동 + 결과 메시지 assert | [L0] |
| 26 | /newsession -> 월렛 선택 인라인 키보드 -> 세션 발급 | /newsession 명령 -> 월렛 목록 인라인 키보드 -> 월렛 선택 -> 세션 토큰 발급 + 응답 assert | [L0] |
| 27 | Long Polling 네트워크 단절 -> 지수 백오프 재연결 | mock Telegram API 일시 실패(3회) -> 지수 백오프(1s, 2s, 4s) 후 재연결 성공 assert | [L0] |

### Telegram UI/UX (HUMAN)

| # | 시나리오 | 검증 방법 | 태그 |
|---|---------|----------|------|
| 28 | /pending -> 인라인 키보드 -> Approve/Reject 대화 흐름 자연스러움 | /pending 실행 -> 거래 요약 MarkdownV2 포매팅 가독성 + 인라인 키보드 버튼 배치 + Approve 클릭 후 확인 메시지 피드백 자연스러움 확인 | [HUMAN] |
| 29 | /killswitch -> 확인 요청 -> 실행 -> 결과 알림 대화 흐름 | /killswitch -> "정말 실행하시겠습니까?" 확인 키보드 -> Yes -> cascade 진행 메시지 -> 완료 요약 메시지. 대화 흐름 명확성 + 위험 작업 경고 적절성 확인 | [HUMAN] |

---

## 의존

| 의존 대상 | 이유 |
|----------|------|
| v1.5 (DeFi + 가격 오라클) | Action Provider MCP 도구가 Telegram에서 표시되므로 v1.5 MCP 통합 완료 필요. Docker 배포에 v1.5 기능(오라클, Action Provider) 포함. IPriceOracle은 잔액 모니터링 USD 환산에 활용 가능 |

---

## 리스크

| # | 리스크 | 영향 | 대응 방안 |
|---|--------|------|----------|
| 1 | Telegram Bot API Long Polling 안정성 | 네트워크 단절 시 getUpdates 타임아웃, 재연결 실패 가능 | 지수 백오프 재연결(1s, 2s, 4s, max 30s). getUpdates timeout=25초 설정. 3회 연속 실패 시 TELEGRAM_DISCONNECTED 경고 로그 + 알림. 5분 후 자동 재시도 |
| 2 | Docker image 크기 (native addon 포함) | sodium-native + better-sqlite3 native 바이너리로 이미지 크기 증가 가능(예상 300-500MB) | Multi-stage 빌드: builder에서 devDependencies 설치/빌드, runner에서 production만 복사. node:22-slim으로 기본 이미지 최소화. .dockerignore로 불필요 파일 제외 |
| 3 | Kill Switch CAS 패턴 SQLite 성능 | BEGIN IMMEDIATE 잠금 범위가 6-step cascade 전체(세션 무효화+거래 중단+월렛 정지)를 포함하면 write lock 장시간 점유 | cascade 6-step은 별도 트랜잭션으로 분리: 상태 전이(CAS)만 단일 트랜잭션, cascade 단계는 순차 실행(각각 독립 트랜잭션). 상태 전이 성공 후 cascade 일부 실패 시 상태는 유지하되 재시도 |

---

*최종 업데이트: 2026-02-16 코드베이스 검증 반영 — AutoStop DAILY_SPENDING_LIMIT 제거(v1.5.3 CUMULATIVE_SPENDING_DAILY 중복), EventEmitter 이벤트 버스 도입 명시, Kill Switch 상태명 매핑(NORMAL→ACTIVE) 추가, TelegramBot/TelegramChannel 관계 정리, chatId 등록 방식(telegram_users DB 테이블) 구체화, Docker entrypoint.sh _FILE 패턴 처리 명시, notification_channels SLACK enum 추가, 기술 결정 6~8번 추가. 설계 문서 40/36 참조*
