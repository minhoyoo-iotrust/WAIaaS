---
milestone: v27.3
audited: 2026-02-22T20:15:00Z
status: passed
scores:
  requirements: 27/27
  phases: 4/4
  integration: 14/14 exports wired
  flows: 4/4 E2E complete
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 236-policy-engine-token-tier
    items:
      - "sign-only mapOperationToParam cannot set tokenDecimals (ParsedOperation lacks decimals) -- token_limits silently skipped on sign-only TOKEN_TRANSFER path. Design-documented known limitation."
      - "NATIVE_DECIMALS duplicated in database-policy-engine.ts and resolve-effective-amount-usd.ts (DRY violation, not a runtime failure)"
  - phase: 237-admin-ui-token-limits
    items:
      - "prompt() used for manual CAIP-19 entry -- functional but not styled consistently with admin UI"
      - "Pre-existing type errors in unrelated admin files (currency-select, dashboard, wallets) -- not introduced by v27.3"
  - phase: 238-compat-docs
    items:
      - "Pre-existing policies.skill.md schema mismatches for TIME_RESTRICTION (allowedHours vs allowed_hours) and RATE_LIMIT (maxTransactions vs max_requests) -- not introduced or fixed by v27.3"
---

# Milestone v27.3: 토큰별 지출 한도 정책 — Audit Report

**Audited:** 2026-02-22T20:15:00Z
**Status:** PASSED
**Requirements:** 27/27 satisfied
**Phases:** 4/4 verified

## Phase Summary

| Phase | Goal | Status | Score | Plans |
|-------|------|--------|-------|-------|
| 235 | Schema -- Zod SSoT 확장 | passed | 8/8 | 1/1 |
| 236 | Policy Engine -- 토큰별 티어 평가 | passed | 13/13 | 3/3 |
| 237 | Admin UI -- 토큰별 한도 편집 폼 | passed | 10/10 | 2/2 |
| 238 | Compat + Docs -- 하위 호환 검증 및 문서화 | passed | 6/6 | 1/1 |

## Requirements Coverage (3-Source Cross-Reference)

### Schema (SCHM-01~06) — Phase 235

| REQ-ID | REQUIREMENTS.md | VERIFICATION.md | SUMMARY | Final |
|--------|----------------|-----------------|---------|-------|
| SCHM-01 | [x] | passed | 235-01 | satisfied |
| SCHM-02 | [x] | passed | 235-01 | satisfied |
| SCHM-03 | [x] | passed | 235-01 | satisfied |
| SCHM-04 | [x] | passed | 235-01 | satisfied |
| SCHM-05 | [x] | passed | 235-01 | satisfied |
| SCHM-06 | [x] | passed | 235-01 | satisfied |

### Engine (ENGN-01~10) — Phase 236

| REQ-ID | REQUIREMENTS.md | VERIFICATION.md | SUMMARY | Final |
|--------|----------------|-----------------|---------|-------|
| ENGN-01 | [x] | passed | 236-01 | satisfied |
| ENGN-02 | [x] | passed | 236-01 | satisfied |
| ENGN-03 | [x] | passed | 236-02, 236-03 | satisfied |
| ENGN-04 | [x] | passed | 236-02 | satisfied |
| ENGN-05 | [x] | passed | 236-02 | satisfied |
| ENGN-06 | [x] | passed | 236-02 | satisfied |
| ENGN-07 | [x] | passed | 236-02 | satisfied |
| ENGN-08 | [x] | passed | 236-02, 236-03 | satisfied |
| ENGN-09 | [x] | passed | 236-02, 236-03 | satisfied |
| ENGN-10 | [x] | passed | 236-02, 236-03 | satisfied |

### Admin (ADMN-01~07) — Phase 237

| REQ-ID | REQUIREMENTS.md | VERIFICATION.md | SUMMARY | Final |
|--------|----------------|-----------------|---------|-------|
| ADMN-01 | [x] | passed | 237-01 | satisfied |
| ADMN-02 | [x] | passed | 237-01 | satisfied |
| ADMN-03 | [x] | passed | 237-02 | satisfied |
| ADMN-04 | [x] | passed | 237-01 | satisfied |
| ADMN-05 | [x] | passed | 237-02 | satisfied |
| ADMN-06 | [x] | passed | 237-01 | satisfied |
| ADMN-07 | [x] | passed | 237-02 | satisfied |

### Compat (CMPT-01~04) — Phase 238

| REQ-ID | REQUIREMENTS.md | VERIFICATION.md | SUMMARY | Final |
|--------|----------------|-----------------|---------|-------|
| CMPT-01 | [x] | passed | 238-01 | satisfied |
| CMPT-02 | [x] | passed | 238-01 | satisfied |
| CMPT-03 | [x] | passed | 238-01 | satisfied |
| CMPT-04 | [x] | passed | 238-01 | satisfied |

**Orphaned requirements:** None
**Unsatisfied requirements:** None

## Integration Check

### Cross-Phase Wiring: 14/14 Connected

All exports are properly consumed across phase boundaries:

| From | To | Via | Status |
|------|----|-----|--------|
| Schema (token_limits) | Engine (evaluateTokenTier) | SpendingLimitRules interface | WIRED |
| Schema (raw optional) | Engine (evaluateNativeTier) | undefined guards | WIRED |
| Schema (superRefine) | API (CreatePolicyRequest) | OpenAPI schema chain | WIRED |
| Engine (TransactionParam.tokenDecimals) | stages.ts (buildTransactionParam) | TOKEN_TRANSFER/APPROVE | WIRED |
| Engine (evaluateSpendingLimit) | 3 callsites | tokenContext parameter | WIRED |
| Admin (SpendingLimitForm) | API (/v1/policies) | token_limits in rules JSON | WIRED |
| Admin (PolicyFormRouter) | SpendingLimitForm | network prop | WIRED |
| Admin (spending-limit-form) | /v1/tokens | apiGet(API.TOKENS) | WIRED |
| Admin (validateRules) | Schema (superRefine) | Parallel validation | WIRED |

### E2E Flows: 4/4 Complete

1. **Token-specific policy creation**: Admin form → token_limits → POST /v1/policies → DB — COMPLETE
2. **Token-specific evaluation**: Request → buildTransactionParam → evaluateSpendingLimit → evaluateTokenTier → tier — COMPLETE
3. **Raw-only backward compat**: Existing raw policy → evaluateNativeTier → same tier as pre-v27.3 — COMPLETE
4. **USD-only flow**: USD-only policy → evaluateUsdTier → no raw, no token_limits needed — COMPLETE

## Tech Debt

### Phase 236: Policy Engine
- sign-only `mapOperationToParam` cannot set `tokenDecimals` (ParsedOperation lacks decimals field). token_limits silently skipped on sign-only TOKEN_TRANSFER path. **Design-documented known limitation** (m27-03 line 146).
- `NATIVE_DECIMALS` duplicated in `database-policy-engine.ts` and `resolve-effective-amount-usd.ts` (DRY violation, not runtime failure).

### Phase 237: Admin UI
- `prompt()` used for manual CAIP-19 entry — functional but not styled consistently with admin UI.

### Phase 238: Compat + Docs
- Pre-existing `policies.skill.md` schema mismatches for TIME_RESTRICTION and RATE_LIMIT — not introduced by v27.3.

**Total tech debt:** 5 items across 3 phases. **None are blockers.** All are either design-documented limitations or pre-existing issues.

## Conclusion

Milestone v27.3 토큰별 지출 한도 정책 is **PASSED**.

- 27/27 requirements satisfied across 4 phases, 7 plans
- 4/4 E2E flows verified complete
- 14/14 cross-phase exports properly wired
- 97 engine tests pass (88 existing + 9 backward compat)
- 46 schema tests pass (including 17 token_limits tests)
- Zero critical gaps, zero broken flows
- 5 tech debt items tracked (all non-blocking)

---
*Audited: 2026-02-22T20:15:00Z*
*Auditor: Claude (gsd-audit-milestone)*
