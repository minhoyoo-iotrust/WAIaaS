# Feature Landscape: WalletConnect v2 Owner 승인

**Domain:** Self-hosted AI 에이전트 지갑 -- WalletConnect v2 QR 페어링, 서명 요청 기반 Owner 승인, Telegram fallback
**Researched:** 2026-02-16
**Overall Confidence:** HIGH (primary: Reown/WalletConnect 공식 문서 + 기존 코드베이스 분석, secondary: npm 레지스트리 + WC specs)

---

## Table Stakes

Owner가 외부 지갑으로 거래를 승인하는 시스템에서 사용자가 당연히 기대하는 기능.

| Feature | Why Expected | Complexity | Dependencies | Notes |
|---------|--------------|------------|--------------|-------|
| WC SignClient 초기화 + 세션 관리 | WC를 쓰려면 SignClient가 데몬 프로세스에서 상시 구동되어야 함 | Med | `@walletconnect/sign-client` 2.23.x, Reown Cloud projectId | 데몬 시작 시 init, 종료 시 cleanup. FileSystemStorage 기본 사용. Node.js 호환 확인됨 (공식: "Node.js, browsers and React Native compatible") |
| QR 코드 페어링 URI 생성 | Owner가 모바일 지갑으로 스캔하여 세션 수립하는 표준 플로우 | Low | SignClient.connect() -> URI | 5분 inactive pairing 만료 (WC spec). CLI는 qrcode-terminal ASCII, Admin UI는 QR 이미지 렌더링 |
| WC 세션 통한 서명 요청 발송 | APPROVAL tier 거래 발생 시 Owner 지갑에 signMessage 요청을 push | High | 기존 ApprovalWorkflow, NotificationService, WC session topic | 핵심 기능. signClient.request()로 personal_sign/solana_signMessage 전송. 기본 5분(300초) 타임아웃 (WC 하드코딩) |
| 서명 응답 수신 + 검증 + 승인 처리 | Owner 지갑에서 서명하면 자동으로 ApprovalWorkflow.approve() 호출 | High | 기존 ownerAuth 검증 로직 (verifySIWS/verifySIWE), ApprovalWorkflow | signClient.request() Promise 해결 시 서명 검증 후 approve. 기존 ownerAuth 8단계 검증 로직 재사용 |
| Telegram fallback 승인 | WC 세션 미연결 또는 서명 요청 타임아웃 시 Telegram /approve 폴백 | Med | 기존 TelegramBotService, ADMIN 권한 체크 | 이미 구현됨 (/approve, /reject 명령어). 추가 필요: WC 실패 시 자동 Telegram 알림 전환 로직 |
| WC 세션 상태 조회 API | Owner/Admin이 현재 WC 연결 상태를 확인할 수 있어야 함 | Low | 기존 Admin API 패턴 | GET /v1/admin/walletconnect/status -- connected/disconnected, 세션 만료일, 연결된 지갑 주소 |
| WC 세션 persist/restore | 데몬 재시작 시 기존 WC 세션 복원 | Med | FileSystemStorage 또는 SQLite 저장 | WC v2 SignClient 기본 FileSystemStorage 지원. 30일 active pairing 만료 (WC spec). 세션 데이터를 ~/.waiaas/wc-sessions/ 에 저장 |

## Differentiators

경쟁 제품 대비 WAIaaS를 차별화하는 기능. 없어도 동작하지만 있으면 UX가 크게 향상됨.

| Feature | Value Proposition | Complexity | Dependencies | Notes |
|---------|-------------------|------------|--------------|-------|
| Admin UI QR 코드 페어링 페이지 | 브라우저에서 QR 스캔하여 즉시 Owner 지갑 연결 -- CLI 없이 온보딩 | Med | Admin UI (Preact), QR 라이브러리 (qrcode 또는 @preact/signals 기반 렌더링) | Admin Settings 페이지에 WalletConnect 섹션 추가. QR 표시 + 연결 상태 실시간 반영 |
| 멀티체인 단일 세션 | Solana + EVM 모두 하나의 QR 스캔으로 연결 (CAIP-25 namespace) | Med | WC v2 네임스페이스 설정 | WC v2는 requiredNamespaces에 solana + eip155 동시 지정 가능. 월렛별로 지원 범위 다를 수 있음 (optionalNamespaces 활용) |
| 승인 알림 + WC 자동 서명 요청 체인 | APPROVAL 이벤트 -> 4채널 알림 발송 동시에 WC push 서명 요청 | Med | 기존 NotificationService EventBus, ApprovalWorkflow | TX_APPROVAL_REQUIRED 이벤트 구독 -> WC signRequest + 알림 동시 발송. 서명 완료 시 추가 알림 (TX_CONFIRMED) |
| 세션 자동 연장 | Owner 활동 시 WC 세션 만료 자동 갱신 (30일 리셋) | Low | WC signClient.extend() | WC spec: "Pairing expiry should be updated to another 30 days on each peer after any request or response." 승인 완료 시 자동 extend |
| WC 연결 해제 시 Telegram 자동 전환 알림 | WC 세션이 끊기면 Telegram으로 "WC 연결 해제됨, Telegram 승인으로 전환합니다" 알림 | Low | session_delete 이벤트 리스너, NotificationService | UX 안정성. Owner가 왜 갑자기 Telegram에서 승인 요청이 오는지 혼란 방지 |
| CLI `waiaas owner connect` 명령어 | 터미널에서 ASCII QR로 Owner 지갑 연결 (headless 서버 환경용) | Med | @walletconnect/sign-client, qrcode-terminal | 설계 문서 34에 이미 설계됨. Tauri Desktop 없는 서버 환경 지원 |

## Anti-Features

명시적으로 빌드하지 않아야 하는 기능.

| Anti-Feature | Why Avoid | What to Do Instead |
|--------------|-----------|-------------------|
| WC를 통한 트랜잭션 서명 (solana_signTransaction, eth_sendTransaction) | WAIaaS 데몬이 에이전트 개인키로 직접 서명. Owner 지갑은 관리 인가(메시지 서명)에만 사용 (설계 문서 34 섹션 2.4 명시) | solana_signMessage, personal_sign만 사용. Owner는 "승인 여부"만 결정, 실제 TX 서명은 데몬 키 |
| @reown/appkit 사용 (데몬 측) | AppKit은 브라우저 전용 고수준 라이브러리. Node.js 데몬에서는 불필요한 UI 의존성 | @walletconnect/sign-client (저수준 API) 직접 사용. Admin UI에서만 선택적으로 AppKit 검토 가능하나, QR URI 직접 렌더링이 더 가벼움 |
| WalletConnect 필수화 | WC는 외부 인프라(relay.walletconnect.com) 의존. 장애 시 승인 불가 발생 | WC는 선택적 편의 기능. 항상 CLI 수동 서명 + REST API 직접 호출 + Telegram 폴백 유지 (설계 문서 34 v0.5 결정) |
| WC 세션 데이터 SQLite 저장 | WC SDK 자체 저장소 메커니즘(FileSystemStorage)과 충돌. 이중 저장 관리 복잡도 증가 | WC SDK 기본 FileSystemStorage 사용 (~/.waiaas/wc-sessions/). 메타데이터(연결 상태, 주소)만 SQLite에 캐시 |
| 복수 Owner 지갑 동시 연결 | 현재 wallet.ownerAddress는 단일 주소. 복수 Owner는 거버넌스 모델 근본 변경 필요 | 단일 Owner 지갑 연결 유지. Owner 변경은 기존 3-State (NONE/GRACE/LOCKED) 생명주기 따름 |
| WC Notify API (Push 알림 서비스) | WC Notify는 별도 유료 서비스. 기존 4채널 알림 시스템과 중복. 외부 의존성 추가 | 기존 NotificationService (Telegram/Discord/ntfy/Slack) 유지. WC는 서명 전달 채널로만 사용 |

## Feature Dependencies

```
WC SignClient 초기화
  -> QR 코드 페어링 URI 생성
    -> WC 세션 수립
      -> WC 서명 요청 발송
        -> 서명 응답 수신 + 검증
          -> ApprovalWorkflow.approve() 호출 (기존)
      -> WC 세션 상태 조회 API
      -> 세션 자동 연장
      -> WC 연결 해제 감지
        -> Telegram fallback 자동 전환

설정 관리 (기존 walletconnect.project_id 설정키)
  -> WC SignClient 초기화 (project_id 필수)

Admin UI QR 페어링 페이지
  -> QR 코드 페어링 URI 생성 (REST API)
  -> WC 세션 상태 조회 API

기존 ApprovalWorkflow.requestApproval()
  -> TX_APPROVAL_REQUIRED 알림
  -> WC 서명 요청 발송 (WC 연결 시)
  -> Telegram /approve fallback (WC 미연결 시)
```

## MVP Recommendation

### 즉시 구현 (Table Stakes)

1. **WC SignClient 서비스** -- 데몬 프로세스 내 @walletconnect/sign-client 초기화, 세션 관리, persist/restore. WalletConnectService 클래스로 캡슐화. 기존 SettingsService에서 project_id 로드.

2. **QR 페어링 + 세션 수립 API** -- REST API `POST /v1/admin/walletconnect/pair` -> 페어링 URI 반환 + `GET /v1/admin/walletconnect/status` -> 세션 상태. Admin UI 또는 CLI에서 QR 표시.

3. **WC 서명 요청 + 승인 자동화** -- ApprovalWorkflow.requestApproval() 확장: WC 세션 활성 시 자동으로 signMessage 요청 발송. 서명 응답 수신 시 기존 ownerAuth 검증 로직 재사용하여 approve() 호출.

4. **Telegram fallback 로직** -- WC 세션 미활성 또는 서명 요청 타임아웃(5분) 시, 기존 Telegram /approve 알림으로 자동 폴백. Owner에게 "WC 서명 타임아웃, Telegram으로 전환" 알림.

### 후순위 (Differentiator)

- **Admin UI QR 페어링 페이지** -- Admin Settings에 WalletConnect 섹션 추가
- **CLI `waiaas owner connect`** -- 터미널 ASCII QR 페어링
- **멀티체인 단일 세션** -- solana + eip155 동시 namespace 지정
- **세션 자동 연장** -- 승인 시 extend() 호출

### 보류 (Defer)

- **복수 Owner 동시 연결** -- Owner 거버넌스 모델 근본 변경 필요. 현재 스코프 밖
- **WC Notify API 통합** -- 기존 4채널 알림으로 충분

## 기존 시스템 활용도

이 기능은 기존 인프라를 최대한 재사용한다.

| 기존 컴포넌트 | 재사용 방식 | 변경 필요 |
|-------------|-----------|----------|
| ApprovalWorkflow | requestApproval() 호출 후 WC 서명 요청 트리거 추가 | 확장 (WC 서명 결과로 approve 호출) |
| ownerAuth 검증 (verifySIWS/verifySIWE) | WC 서명 응답 검증에 그대로 재사용 | 없음 (검증 함수 이미 존재) |
| TelegramBotService | /approve, /reject 명령어 그대로 유지 (fallback) | 없음 (이미 구현) |
| NotificationService | TX_APPROVAL_REQUIRED 이벤트에 WC 서명 요청 추가 | 확장 (WC 채널 추가 또는 이벤트 리스너) |
| SettingsService | walletconnect.project_id 이미 설정키 등록됨 | 없음 (setting-keys.ts에 이미 존재) |
| Admin API | /v1/admin/settings에 walletconnect 카테고리 존재 | 확장 (pair/status 엔드포인트 추가) |
| EventBus | 이벤트 기반 아키텍처 활용 | 없음 (TX_APPROVAL_REQUIRED 이미 정의) |
| pending_approvals 테이블 | WC 서명 메타데이터(wc_request_id 등) 컬럼 추가 가능 | 마이그레이션 (ALTER TABLE) |

## Sources

- [WalletConnect Sign API Dapp Usage](https://docs.reown.com/advanced/api/sign/dapp-usage) - HIGH confidence
- [WalletConnect Session Proposal Spec](https://specs.walletconnect.com/2.0/specs/clients/sign/session-proposal) - HIGH confidence
- [WalletConnect Pairing API Spec](https://specs.walletconnect.com/2.0/specs/clients/core/pairing) - HIGH confidence
- [WalletConnect Namespaces Spec](https://specs.walletconnect.com/2.0/specs/clients/sign/namespaces) - HIGH confidence
- [@walletconnect/sign-client npm](https://www.npmjs.com/package/@walletconnect/sign-client) - v2.23.1, 853K weekly downloads - HIGH confidence
- [WalletConnect RPC Methods Spec](https://specs.walletconnect.com/2.0/specs/clients/sign/rpc-methods) - 기본 5분(300초) 서명 요청 타임아웃 - HIGH confidence
- [Reown Migration Guide](https://docs.reown.com/walletkit/upgrade/from-web3wallet-web) - WalletConnect -> Reown 브랜딩 전환, 패키지 구조 동일 - MEDIUM confidence
- 기존 설계 문서 34 (Owner 지갑 연결 설계 OWNR-CONN v0.8) - HIGH confidence
- 기존 코드베이스 분석 (approval-workflow.ts, owner-auth.ts, telegram-bot-service.ts, setting-keys.ts) - HIGH confidence
