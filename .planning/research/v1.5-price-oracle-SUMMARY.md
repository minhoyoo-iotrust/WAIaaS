# Research Summary: v1.5 Price Oracle + Action Provider Framework

**Domain:** DeFi Price Oracle + Plugin Architecture
**Researched:** 2026-02-15
**Overall confidence:** HIGH

## Executive Summary

v1.5의 스택 리서치 결과, **신규 외부 의존성 0개**로 전체 마일스톤을 구현할 수 있다. Pyth Hermes REST API와 CoinGecko Demo API는 Node.js 22 내장 `fetch()`만으로 호출 가능한 단순 REST API이며, LRU 캐시는 128항목 고정 상한으로 직접 구현이 합리적이다. API 키 암호화는 기존 `settings-crypto.ts`의 HKDF+AES-256-GCM 패턴을 재사용하면 새 암호화 코드가 불필요하다. ESM dynamic import 플러그인 시스템은 Node.js 22 런타임 내장 기능이다.

Pyth Hermes API는 Zero-config(API 키 불필요)로 380+ 가격 피드를 제공하며, `/v2/updates/price/latest` 엔드포인트 하나로 다수 토큰 가격을 배치 조회할 수 있다. 가격 데이터에 confidence interval이 포함되어 있어 PriceInfo.confidence 매핑이 자연스럽다. Rate limit(30 req/10s)은 5분 TTL 캐시와 배치 조회 최적화로 충분히 관리 가능하다.

CoinGecko Demo API는 opt-in fallback으로, Demo 키(무료, 30 req/min) 설정 시에만 활성화된다. `/simple/token_price/{platform}` 엔드포인트로 컨트랙트 주소 기반 가격 조회가 가능하여 Pyth 미지원 롱테일 토큰 커버리지를 확보한다. 월간 10,000 호출 상한은 128항목 캐시의 5분 TTL 갱신 패턴으로 24시간 연속 운영 시 약 8,640건으로 빠듯하지만, Pro 키 업그레이드 경로가 동일 config 필드로 지원된다.

API 키 암호화에 대해 목표 문서는 "sodium-native secretbox"을 명시했으나, 기존 코드베이스 분석 결과 `settings-crypto.ts`의 AES-256-GCM 패턴 재사용이 더 합리적이다. 보안 수준이 동등하고, 코드 재사용으로 구현 비용이 0이며, 기존 알림 credential(Telegram bot token 등)과 일관된 패턴을 유지한다.

## Key Findings

**Stack:** 신규 의존성 0개. Node.js 22 native fetch + 기존 settings-crypto + ESM import()로 전체 구현 가능.
**Architecture:** Pyth(primary, zero-config) -> CoinGecko(fallback, opt-in) 2단계 OracleChain + 128항목 LRU 5분 TTL 캐시.
**Critical pitfall:** Pyth feed ID 매핑 전략 -- 주요 토큰 하드코딩 + `/v2/price_feeds` 동적 검색 하이브리드 방식 필요. 하드코딩 없이 전부 동적 검색하면 불필요한 API 호출 증가.

## Implications for Roadmap

Based on research, suggested phase structure:

1. **Phase 1: IPriceOracle 인터페이스 + InMemoryPriceCache** - 핵심 인프라 먼저
   - Addresses: IPriceOracle 인터페이스(4개 메서드), PriceInfo/TokenRef Zod 스키마, LRU 캐시 128항목, classifyPriceAge() 3단계
   - Avoids: 외부 API 의존 없이 순수 로직만 구현하여 테스트 용이

2. **Phase 2: PythOracle + CoinGeckoOracle 구현체** - API 통합
   - Addresses: Pyth Hermes REST 호출, CoinGecko REST 호출, feed ID 매핑, platformId 매핑
   - Avoids: OracleChain 없이 개별 구현체만 먼저 완성

3. **Phase 3: OracleChain + 교차 검증 + resolveEffectiveAmountUsd()** - 정책 통합
   - Addresses: Pyth->CoinGecko fallback, 교차 검증 인라인(편차>5%), PriceResult discriminated union, SpendingLimitRuleSchema USD 필드
   - Avoids: 파이프라인 Stage 3 통합은 이 단계에서 완성

4. **Phase 4: IActionProvider + ActionProviderRegistry** - 플러그인 프레임워크
   - Addresses: 인터페이스, ESM dynamic import, validate-then-trust, ~/.waiaas/actions/ 디렉토리 스캔
   - Avoids: MCP 통합 전에 프레임워크 자체를 먼저 검증

5. **Phase 5: MCP Tool 변환 + REST API + Admin UI** - 외부 인터페이스
   - Addresses: ActionDefinition->MCP Tool 변환, POST /v1/actions/:provider/:action, oracle-status, api-keys CRUD, Admin UI
   - Avoids: 전체 통합 테스트로 마무리

**Phase ordering rationale:**
- Phase 1->2: 캐시와 인터페이스가 없으면 구현체 테스트 시 매번 실제 API 호출 필요
- Phase 2->3: 개별 구현체가 완성되어야 OracleChain과 교차 검증 테스트 가능
- Phase 3 완료 후 Phase 4 시작: Oracle과 Action Provider는 독립적이나, Oracle 완성 후 Action Provider에서 가격 평가가 동작하는지 확인 가능
- Phase 5 마지막: 모든 서비스가 완성된 후 외부 인터페이스(MCP, REST, Admin) 통합

**Research flags for phases:**
- Phase 2: Pyth feed ID 매핑 전략 심화 연구 필요 (USDC, USDT 등 주요 스테이블코인 feed ID 확인)
- Phase 4: ESM 플러그인 캐시 무효화/리로드 전략 심화 연구 필요
- Phase 5: MCP 동적 도구 등록/해제 패턴 심화 연구 필요

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | HIGH | 신규 의존성 없음. 모든 기술이 기존 스택 + Node.js 22 내장 기능 |
| Features | HIGH | 목표 문서가 상세하게 정의됨. API 응답 구조 검증 완료 |
| Architecture | HIGH | OracleChain fallback + LRU 캐시 + ESM 플러그인 패턴 모두 표준적 |
| Pitfalls | MEDIUM | Pyth rate limit 관리, CoinGecko 월간 상한, feed ID 매핑 등 운영 이슈 존재 |

## Gaps to Address

- Pyth feed ID: USDC, USDT, BONK 등 추가 토큰의 feed ID를 `/v2/price_feeds` API로 검증 필요
- CoinGecko 월간 10K 상한: 실제 운영 패턴에서 상한 도달 여부 시뮬레이션 필요
- ESM 플러그인 보안: validate-then-trust의 검증 범위 한계 (Zod 검증으로 인터페이스 준수는 확인되나, 악성 코드 실행은 방지 불가)
- sodium-native v4 -> v5 마이그레이션: v1.5 범위 외이지만 향후 검토 필요
