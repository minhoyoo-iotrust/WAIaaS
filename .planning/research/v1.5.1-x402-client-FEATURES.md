# Feature Landscape: v1.5.1 x402 Client Support

**Domain:** x402 프로토콜 클라이언트 -- AI 에이전트용 HTTP 402 자동 결제
**Researched:** 2026-02-15

---

## Table Stakes

에이전트가 x402 유료 API를 사용하기 위해 반드시 필요한 기능.

| Feature | Why Expected | Complexity | Notes |
|---------|--------------|------------|-------|
| HTTP 402 응답 파싱 + PaymentRequirements 해석 | x402 프로토콜의 핵심 흐름. 402를 이해하지 못하면 결제 불가 | Low | @x402/core Zod 스키마로 파싱 |
| EVM EIP-3009 결제 서명 생성 | EVM 체인 USDC 결제의 유일한 방식. x402 EVM exact 스킴의 기본 | Med | viem signTypedData 사용. 도메인 파라미터 체인별 관리 필요 |
| Solana SPL TransferChecked 부분 서명 | Solana 결제의 유일한 방식. x402 SVM exact 스킴의 기본 | Med | @solana/kit 기존 패턴. feePayer를 noopSigner로 처리 |
| X-PAYMENT 헤더 인코딩 + 재요청 | 결제 서명을 서버에 전달하는 유일한 방법 | Low | JSON → base64 → X-PAYMENT 헤더 |
| X402_ALLOWED_DOMAINS 정책 | 기본-거부 보안 원칙. 허용하지 않은 도메인 결제 차단 | Low | 기존 policies 테이블 + DB 정책 CRUD API 활용 |
| SPENDING_LIMIT 통합 | x402 결제도 지출이므로 4-tier 평가 필수 | Low | 기존 파이프라인 정책 평가 재사용 |
| SSRF 보호 | 프록시 서비스의 필수 보안. 없으면 내부 네트워크 노출 | Med | DNS 사전 해석 + 사설 IP 차단 + 리다이렉트 재검증 |
| POST /v1/x402/fetch 엔드포인트 | 에이전트가 x402 결제를 요청하는 API | Low | OpenAPIHono 라우트 추가 |
| 감사 로그 (transactions 테이블) | 모든 결제 이력 추적. 운영/디버깅/분쟁 해결에 필수 | Low | 기존 transactions 테이블에 type=X402_PAYMENT |
| CAIP-2 → NetworkType 매핑 | x402의 네트워크 식별자를 WAIaaS 내부 타입으로 변환 | Low | 상수 매핑 테이블 |
| 비-402 응답 프록시 | x402Fetch로 일반 API도 호출 가능해야 함. 402가 아니면 그대로 반환 | Low | 결제 없이 응답 패스스루 |

## Differentiators

경쟁 제품(Coinbase Agentic Wallet)과 차별화되는 기능.

| Feature | Value Proposition | Complexity | Notes |
|---------|-------------------|------------|-------|
| 4-tier 정책 평가 (INSTANT/NOTIFY/DELAY/APPROVAL) | Coinbase는 정책 없이 모든 결제 즉시 실행. WAIaaS는 고액 결제 시 Owner 알림/승인 | Low | 기존 정책 엔진 재사용. x402 결제는 금액 → USD → 4-tier |
| Owner 알림 연동 | x402 결제 시 기존 4채널(Telegram/Discord/ntfy/Slack) 알림 | Low | 기존 TX_REQUESTED, TX_CONFIRMED 트리거 재사용 |
| Kill Switch | 긴급 시 x402 포함 모든 거래 차단 | Low | 기존 Kill Switch 그대로 적용 |
| Self-Hosted (로컬 키 관리) | Coinbase는 클라우드 커스터디. WAIaaS는 로컬 데몬 | Low | 기존 아키텍처 그대로. 키가 외부로 나가지 않음 |
| 에이전트별 도메인 화이트리스트 | 에이전트 A는 api.openai.com만, 에이전트 B는 api.anthropic.com만 결제 허용 | Low | X402_ALLOWED_DOMAINS가 에이전트(월렛)별로 적용 |
| SDK/MCP 통합 | TS SDK `x402Fetch()`, Python SDK `x402_fetch()`, MCP `x402_fetch` 도구 | Med | 3개 인터페이스 모두에 동일 기능 노출 |

## Anti-Features

명시적으로 구현하지 않을 기능.

| Anti-Feature | Why Avoid | What to Do Instead |
|--------------|-----------|-------------------|
| Facilitator 운영 | WAIaaS는 클라이언트(돈 내는 쪽)이지 서버(돈 받는 쪽)가 아님 | facilitator 통신은 리소스 서버 책임 |
| x402 서버 미들웨어 | 리소스 보호(돈 받기)는 WAIaaS 목적이 아님 | @x402/hono 참조. WAIaaS는 결제자 역할만 |
| 환불/분쟁 해결 | x402 스펙 범위 외. 복잡도 과잉 | 감사 로그에 결제 정보 기록하여 수동 분쟁 해결 |
| x402 v1 지원 | Legacy. v2가 현재 표준 | x402Version != 2이면 `X402_UNSUPPORTED_VERSION` |
| Permit2 방식 지원 (초기) | EIP-3009보다 복잡 (사전 approve 필요). USDC는 EIP-3009 네이티브 지원 | v1.5.1에서는 EIP-3009만. Permit2는 향후 확장 |
| 다중 PaymentRequirements 자동 선택 | 여러 결제 옵션 중 최적 선택은 복잡 | 현재 어댑터 풀에서 지원하는 첫 번째 (scheme, network) 선택 |
| 자동 ATA 생성 (Solana) | x402 Solana 결제에서 수신자의 ATA가 없으면 생성 필요하나, 이는 facilitator 책임 | facilitator가 ATA 생성 처리 |
| 비-USDC 토큰 결제 (EVM 초기) | EIP-3009 미구현 토큰은 결제 불가 | 지원 토큰 목록에 USDC만 포함. 향후 확장 |

---

## Feature Dependencies

```
SSRF 보호 → x402 핸들러 (외부 요청 전 URL 검증)
CAIP-2 매핑 → x402 핸들러 (네트워크 식별)
결제 서명 생성 → x402 핸들러 (결제 서명을 X-PAYMENT에 포함)
X402_ALLOWED_DOMAINS → x402 핸들러 (도메인 검증 후 요청 진행)
SPENDING_LIMIT → x402 핸들러 (금액 검증 후 서명 생성)
x402 핸들러 → POST /v1/x402/fetch (API 노출)
POST /v1/x402/fetch → SDK x402Fetch() (SDK 래핑)
POST /v1/x402/fetch → MCP x402_fetch (MCP 도구)
```

---

## MVP Recommendation

**v1.5.1 MVP에 포함:**

1. **x402 핸들러 + SSRF 보호** -- 핵심 프록시 로직
2. **EVM EIP-3009 결제 서명** -- x402 주 사용 네트워크(Base USDC)
3. **Solana TransferChecked 부분 서명** -- Solana 생태계 지원
4. **X402_ALLOWED_DOMAINS 정책** -- 기본-거부 보안
5. **SPENDING_LIMIT 통합** -- 기존 4-tier 정책
6. **POST /v1/x402/fetch** -- API 엔드포인트
7. **감사 로그** -- 결제 이력 추적
8. **SDK (TS/Python) + MCP** -- 에이전트 인터페이스
9. **CAIP-2 매핑** -- 네트워크 변환

**Defer:**
- Permit2 지원: EIP-3009으로 USDC 결제 커버 충분. 향후 다양한 토큰 지원 시 추가
- 다중 PaymentRequirements 최적 선택: 첫 번째 지원 가능한 옵션 선택으로 충분
- x402 v1 호환: v2만 지원

---

## Sources

- [x402 Specification v2](https://github.com/coinbase/x402/blob/main/specs/x402-specification.md) -- 프로토콜 스펙
- [x402 Welcome](https://docs.cdp.coinbase.com/x402/welcome) -- Coinbase x402 개발자 문서
- [x402 Network Support](https://docs.cdp.coinbase.com/x402/network-support) -- 지원 네트워크 목록
- [x402 v2 Launch Blog](https://www.x402.org/writing/x402-v2-launch) -- v2 변경 사항
- WAIaaS `objectives/v1.5.1-x402-client.md` -- 마일스톤 목표, 컴포넌트 23개 E2E 시나리오
