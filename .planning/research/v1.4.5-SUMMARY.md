# Research Summary: Multichain Wallet Environment Model

**Domain:** Multichain wallet management for AI agent WaaS
**Researched:** 2026-02-14
**Overall confidence:** HIGH

---

## Executive Summary

멀티체인 월렛 환경 모델 전환은 **새로운 라이브러리 도입 없이** 기존 스택(viem 2.x, better-sqlite3, Drizzle ORM, Zod)의 코드 레벨 변경만으로 구현할 수 있다. 이는 기존 아키텍처가 이미 올바른 추상화를 갖추고 있기 때문이다.

핵심 기술 발견은 세 가지다. 첫째, viem은 설계적으로 단일 체인 PublicClient이며, 멀티 체인 지원은 "per-chain 인스턴스 Map" 패턴이 공식 권장이다. 현재 AdapterPool이 이미 이 패턴을 `chain:network` 키로 구현하고 있어, 어댑터 캐싱 구조는 변경 불필요하다. 호출자만 "wallet.network" 대신 "resolved transaction network"를 전달하면 된다.

둘째, SQLite 마이그레이션은 better-sqlite3 12.6.2에 번들된 SQLite 3.51.2가 ALTER TABLE RENAME COLUMN을 완전 지원하지만, CHECK 제약 변경이 동반되므로 12-step 테이블 재생성이 필요하다. 이 패턴은 v2(CHECK 확장), v3(테이블/컬럼 리네임) 마이그레이션에서 이미 실전 검증 완료되었다.

셋째, 환경 기반 지갑 추상화는 업계에서 MetaMask(네트워크 전환), WalletConnect v2(사전 승인 멀티체인), Wepin WaaS(단일 지갑 멀티체인) 등에서 유사 패턴이 확인된다. WAIaaS의 "1 wallet = 1 chain + 1 environment" 모델은 서버 사이드 WaaS에 적합한 변형이다.

---

## Key Findings

**Stack:** 새 라이브러리 0개. viem 2.45.3 + better-sqlite3 12.6.2 + Drizzle 0.45.1 + Zod 3.24.x 그대로.

**Architecture:** AdapterPool 구조 변경 없음. 네트워크 해결 로직(resolveNetwork)을 파이프라인 Stage 1에 추가하고, 호출자만 변경.

**Critical pitfall:** DB 마이그레이션 중 network -> environment 데이터 변환이 불완전하면 mainnet/testnet 혼재 위험. CASE ELSE 분기 + 전후 검증 assertion 필수.

---

## Implications for Roadmap

Based on research, suggested phase structure:

### 1. **리서치 + 설계** (v1.4.5) -- 아키텍처 확정
- Addresses: 환경 모델 데이터 구조, 마이그레이션 전략, API 변경 범위
- Avoids: Pitfall 6 (pushSchema/마이그레이션 불일치) -- 설계 단계에서 DDL과 마이그레이션을 동시에 정의

### 2. **Core 스키마 + DB 마이그레이션** (v1.4.6 Phase 1)
- Addresses: EnvironmentType enum, 매핑 함수, DB migration v6~v7, Drizzle 스키마
- Avoids: Pitfall 1 (데이터 손실) -- 마이그레이션을 먼저 구현하고 검증 후 API 변경
- Rationale: DB 변경이 모든 상위 레이어의 기반

### 3. **API + 파이프라인** (v1.4.6 Phase 2)
- Addresses: 트랜잭션 레벨 network 지정, resolveNetwork, 환경 검증, ALLOWED_NETWORKS
- Avoids: Pitfall 3 (환경 혼재) -- 단일 resolveNetwork() 진입점
- Rationale: DB가 준비된 후 API 변경. 파이프라인이 핵심 비즈니스 로직

### 4. **MCP + SDK + Admin** (v1.4.6 Phase 3)
- Addresses: MCP 도구 network 파라미터, SDK 옵션, Admin UI environment 모드
- Avoids: Pitfall 10 (Admin 표시 문제) -- 마이그레이션 완료 후 UI 업데이트
- Rationale: API가 안정된 후 클라이언트 인터페이스 업데이트

### 5. **CLI Quickstart + 통합 테스트** (v1.4.6 Phase 4)
- Addresses: Quickstart 원스톱 명령, E2E 검증
- Avoids: Pitfall 7 (데몬 미실행) -- health check 패턴
- Rationale: 모든 컴포넌트 완성 후 통합 명령어. 최종 검증

**Phase ordering rationale:**
- DB 마이그레이션이 모든 변경의 기반이므로 최우선
- API/파이프라인이 비즈니스 로직 핵심이므로 DB 직후
- MCP/SDK/Admin은 API에 의존하므로 3번째
- Quickstart는 전체 동작을 전제하므로 마지막
- 설계(v1.4.5)와 구현(v1.4.6)이 분리되어 있으므로 설계가 먼저

**Research flags for phases:**
- Phase 1 (Core + DB): 리서치 충분. 12-step 패턴 검증 완료. 추가 리서치 불필요
- Phase 2 (API + Pipeline): 표준 패턴. resolveNetwork 설계가 핵심이나 리서치보다 설계 판단
- Phase 3 (MCP/SDK/Admin): 기존 패턴 확장. 추가 리서치 불필요
- Phase 4 (Quickstart): CLI 흐름 설계 필요하나, 리서치 대상은 아님

---

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | **HIGH** | 새 의존성 0개. 기존 버전 직접 확인. viem 멀티체인 패턴 공식 Discussion 확인 |
| Features | **HIGH** | v1.4.5/v1.4.6 objective에서 범위 명확. 기존 코드베이스와 매핑 완료 |
| Architecture | **HIGH** | AdapterPool, Pipeline, Migration 패턴 모두 코드 레벨 확인 |
| Pitfalls | **HIGH** | v2/v3 마이그레이션 선례에서 발생 가능 문제 확인. FK 관리 패턴 검증 |

---

## Gaps to Address

- **네트워크 스코프 정책 세부 설계:** policies.network 컬럼 추가 시 Stage 3 매칭 로직의 정확한 SQL 변경은 설계 단계에서 확정 필요
- **Quickstart MCP 토큰 생성 흐름:** 2개 월렛에 대한 MCP 토큰 자동 생성 + 설정 스니펫 출력의 구체적 구현은 CLI 설계에서 확정
- **token_registry 환경별 조회 패턴:** 단일 API 호출로 환경 내 모든 네트워크의 토큰을 조회하는 최적 쿼리 패턴은 구현 시 확정
- **기존 테스트 영향:** 1,467개 테스트 중 wallets.network를 직접 참조하는 테스트의 수정 범위 파악 필요

---

## Files Created

| File | Purpose |
|------|---------|
| `.planning/research/v1.4.5-SUMMARY.md` | 리서치 요약 + 로드맵 제안 |
| `.planning/research/v1.4.5-STACK.md` | 기술 스택 분석 (델타 -- 변경 사항만) |
| `.planning/research/v1.4.5-FEATURES.md` | 기능 범위 (table stakes + differentiators) |
| `.planning/research/v1.4.5-ARCHITECTURE.md` | 아키텍처 패턴 + anti-patterns |
| `.planning/research/v1.4.5-PITFALLS.md` | 도메인 위험 요소 11개 |
