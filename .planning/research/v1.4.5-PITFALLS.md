# Domain Pitfalls: Multichain Wallet Environment Model

**Domain:** Multichain wallet management for AI agent WaaS
**Researched:** 2026-02-14

---

## Critical Pitfalls

실수 시 데이터 손실, 자금 손실, 또는 전체 재작성을 야기하는 위험.

### Pitfall 1: DB 마이그레이션 중 데이터 손실

**What goes wrong:** 12-step 테이블 재생성에서 INSERT INTO ... SELECT 구문이 모든 컬럼을 매핑하지 않거나, CASE 분기가 불완전하여 기존 데이터가 누락/잘못 변환됨

**Why it happens:** wallets 테이블의 network 값을 environment로 변환할 때, 예상치 못한 network 값(커스텀 값, 빈 문자열, CHECK 우회 삽입)이 CASE 분기에서 누락

**Consequences:** 기존 월렛의 environment가 잘못 설정되어 mainnet 월렛이 testnet으로, 또는 그 반대로 전환. 자금 접근 불가 또는 의도치 않은 mainnet 자금 사용

**Prevention:**
- CASE ELSE 분기를 반드시 포함하여 매핑되지 않은 값을 에러로 처리
- 마이그레이션 전 `SELECT DISTINCT network FROM wallets` 확인 assertion
- 마이그레이션 후 `SELECT * FROM wallets WHERE environment NOT IN ('testnet','mainnet')` 검증
- 전체 과정을 트랜잭션으로 감싸 실패 시 ROLLBACK

**Detection:** 마이그레이션 후 integrity check: `PRAGMA foreign_key_check` + 데이터 검증 쿼리

### Pitfall 2: Foreign Key Cascade 문제 (12-step 재생성 시)

**What goes wrong:** wallets 테이블을 DROP+RENAME할 때, sessions/transactions/policies의 FK 참조(wallet_id REFERENCES wallets)가 깨짐

**Why it happens:** `PRAGMA foreign_keys=OFF` 없이 12-step을 실행하거나, 재생성 후 FK를 다시 켜기 전에 COMMIT하지 않음

**Consequences:** FK 무결성 깨짐 -> 고아 레코드 -> 이후 FK ON DELETE CASCADE/RESTRICT가 동작하지 않음

**Prevention:**
- v2, v3 마이그레이션의 검증된 패턴 그대로 사용
- `managesOwnTransaction: true` 사용 (runMigrations가 외부 트랜잭션을 감지 않음)
- PRAGMA foreign_keys=OFF -> BEGIN -> ... -> COMMIT -> PRAGMA foreign_keys=ON -> PRAGMA foreign_key_check
- FK check 결과가 비어있지 않으면 즉시 예외

**Detection:** `PRAGMA foreign_key_check` 빈 결과 assertion

### Pitfall 3: Testnet-Mainnet 환경 혼재

**What goes wrong:** 환경 불일치 검증이 불완전하여, mainnet 월렛으로 testnet 네트워크에 트랜잭션을 보내거나 그 반대가 발생

**Why it happens:**
- validateNetworkEnvironment()가 호출되지 않는 코드 경로 존재
- 기본 네트워크가 환경과 불일치하는 상태로 저장됨
- MCP/SDK에서 직접 AdapterPool을 우회하는 경로

**Consequences:** AI 에이전트가 실수로 mainnet 자금을 testnet에서 사용 (실제로는 불가능하지만 잘못된 RPC 연결), 또는 testnet 키로 mainnet 트랜잭션 시도

**Prevention:**
- resolveNetwork()를 단일 진입점으로 사용. 모든 트랜잭션 경로가 이 함수를 거치도록 강제
- default_network 설정 시에도 환경 일치 검증
- 파이프라인 Stage 1에서 검증하므로 어댑터 레벨에서 한 번 더 확인 불필요 (단일 검증 지점)

**Detection:** 테스트: 환경 불일치 요청 -> 400 에러 assertion. 모든 5-type에 대해 검증

---

## Moderate Pitfalls

기능 결함이나 하위호환 문제를 야기하지만, 데이터 손실은 없는 위험.

### Pitfall 4: transactions.network 역참조 실패

**What goes wrong:** 기존 트랜잭션에 network 값을 채울 때, 해당 월렛이 이미 삭제(TERMINATED)되어 JOIN 실패

**Prevention:**
- LEFT JOIN 사용, 매칭 안 되는 경우 NULL 유지 (NOT NULL 제약 걸지 않음)
- 삭제된 월렛의 트랜잭션은 `transactions ON DELETE RESTRICT`로 보호되어 있으므로, wallet이 존재하는 한 JOIN 성공. 하지만 안전을 위해 NULL 허용

### Pitfall 5: ALLOWED_NETWORKS와 기존 정책의 충돌

**What goes wrong:** ALLOWED_NETWORKS가 특정 네트워크만 허용하지만, 기존 SPENDING_LIMIT 정책이 해당 네트워크가 아닌 다른 네트워크에 대한 것일 때, 정책 평가 순서 혼동

**Prevention:**
- ALLOWED_NETWORKS는 Stage 1에서 네트워크 접근 자체를 차단 (gate keeper)
- 기존 정책은 Stage 3에서 평가 (네트워크가 이미 확정된 후)
- 순서: 네트워크 해결 -> ALLOWED_NETWORKS 검증 -> 기존 정책 평가

### Pitfall 6: CHECK 제약 불일치 (pushSchema vs 마이그레이션)

**What goes wrong:** 새 DB는 pushSchema()의 DDL로 생성되는데, 마이그레이션 후 DB와 DDL이 불일치

**Prevention:**
- pushSchema()의 DDL을 마이그레이션 결과와 동일하게 업데이트
- LATEST_SCHEMA_VERSION을 새 마이그레이션 버전으로 업데이트
- pushSchema()가 새 DB에서 모든 마이그레이션 버전을 기록하도록 기존 패턴 유지

### Pitfall 7: Quickstart의 데몬 미실행 상태

**What goes wrong:** `waiaas quickstart --mode testnet` 실행 시 데몬이 실행 중이지 않아 API 호출 실패

**Prevention:**
- Quickstart 시작 시 데몬 health check 필수 (GET /health)
- 실패 시 명확한 에러 메시지: "Start daemon first: waiaas start"
- 또는 데몬 자동 시작 옵션 고려 (--auto-start)

### Pitfall 8: Solana 환경 매핑의 비대칭

**What goes wrong:** Solana testnet 환경에서 devnet과 testnet 2개 네트워크가 가능한데, 기본값이 devnet이라면 testnet을 사용하려는 사용자가 혼동

**Prevention:**
- Solana testnet 환경의 기본 네트워크를 devnet으로 명확히 문서화
- Solana testnet(네트워크)은 사실상 사용되지 않으므로, 환경 이름과 네트워크 이름의 충돌을 API 문서에서 명시적 설명

---

## Minor Pitfalls

DX 문제나 작은 버그를 야기하는 위험.

### Pitfall 9: 키스토어 파일 내 network 메타데이터 불일치

**What goes wrong:** 기존 키스토어 파일은 `"network": "ethereum-sepolia"`로 저장되어 있지만, 마이그레이션 후 월렛은 `environment: "testnet"`. 메타데이터 불일치

**Prevention:** 키스토어 파일의 network 필드는 키 로드에 사용되지 않으므로 (경로는 walletId만으로 결정), 변경하지 않아도 동작에 영향 없음. 향후 신규 키에만 `environment` 필드 추가 고려

### Pitfall 10: Admin UI에서 기존 월렛의 environment 표시

**What goes wrong:** 마이그레이션 전에 생성된 월렛이 Admin UI에서 environment 표시가 이상하게 보임

**Prevention:** 마이그레이션이 모든 기존 월렛의 environment를 올바르게 변환하므로, Admin UI는 새 필드만 표시하면 됨. 마이그레이션 후에만 Admin UI를 업데이트하면 문제 없음

### Pitfall 11: token_registry 네트워크 범위 혼동

**What goes wrong:** token_registry는 네트워크별 토큰을 관리하는데, 환경 모델에서 "이 환경의 모든 토큰"을 조회하려면 여러 네트워크를 OR 조건으로 쿼리해야 함

**Prevention:** token_registry는 변경하지 않음 (네트워크별 관리 유지). 환경별 토큰 조회는 getNetworksForEnvironment()로 네트워크 목록을 얻어 IN 절로 쿼리

---

## Phase-Specific Warnings

| Phase Topic | Likely Pitfall | Mitigation |
|-------------|---------------|------------|
| DB 마이그레이션 설계 | Pitfall 1, 2: 데이터 손실 + FK 깨짐 | 12-step 패턴 엄격 준수, 마이그레이션 전후 검증 쿼리 |
| Core 스키마 변경 | Pitfall 6: pushSchema/마이그레이션 불일치 | DDL + LATEST_SCHEMA_VERSION 동시 업데이트 |
| 파이프라인 변경 | Pitfall 3: 환경 혼재 | resolveNetwork() 단일 진입점 + 5-type 전체 테스트 |
| 정책 확장 | Pitfall 5: 정책 충돌 | Stage 1 ALLOWED_NETWORKS -> Stage 3 기존 정책 순서 |
| CLI Quickstart | Pitfall 7: 데몬 미실행 | health check 선행 |
| Solana 환경 매핑 | Pitfall 8: devnet/testnet 혼동 | 명확한 기본값 문서화 |

---

## Sources

- v2/v3 마이그레이션 선례: `packages/daemon/src/infrastructure/database/migrate.ts`
- FK 관리 패턴: SQLite 12-step procedure (`PRAGMA foreign_keys=OFF`)
- Policy evaluation order: 6-stage pipeline (docs/32-transaction-pipeline-api.md)
- Keystore path: `packages/daemon/src/infrastructure/keystore/keystore.ts` (`keystorePath(walletId)`)
- [SQLite ALTER TABLE 12-step](https://www.sqlite.org/lang_altertable.html)
