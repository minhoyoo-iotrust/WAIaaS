# Domain Pitfalls: v1.5 Price Oracle + Action Provider

**Domain:** DeFi Price Oracle + ESM Plugin Architecture
**Researched:** 2026-02-15

---

## Critical Pitfalls

심각한 보안/기능 문제를 유발할 수 있는 함정.

### Pitfall 1: Pyth 가격 정밀도 손실 (Number 변환)

**What goes wrong:** Pyth 가격이 `"6140993501000"` (string) + `expo: -8` 형태로 반환된다. JavaScript `Number`로 변환 시 부동소수점 정밀도 손실이 발생할 수 있다. 예: `Number("9007199254740993")` -> `9007199254740992` (마지막 자릿수 변경).

**Why it happens:** JavaScript Number는 IEEE 754 double (53-bit mantissa)로 `Number.MAX_SAFE_INTEGER` = 2^53-1 = 9,007,199,254,740,991까지만 정확. Pyth의 price 문자열이 이를 초과할 수 있다.

**Consequences:** USD 가격 평가 시 미세한 오차가 발생하여 정책 임계값 경계에서 잘못된 티어 판정 가능. 예: instant_max_usd=100인데 $99.999999가 $100.000001로 계산되어 다음 티어로 격상.

**Prevention:**
```typescript
// 1. Pyth 가격의 실제 범위 확인: BTC $100K일 때 price="10000000000000", expo=-8
//    10,000,000,000,000 < 9,007,199,254,740,991 -> Number 안전
// 2. 그러나 방어적으로: BigInt 기반 변환 사용
function pythPriceToUsd(price: string, expo: number): number {
  if (expo >= 0) return Number(BigInt(price) * BigInt(10 ** expo));
  // expo < 0: 나눗셈은 Number로 해도 충분한 정밀도
  return Number(price) / (10 ** Math.abs(expo));
}
// 3. 정책 비교는 센트 단위 정수로 변환하여 부동소수점 비교 회피
```

**Detection:** 테스트에서 `Number.MAX_SAFE_INTEGER` 근처 값으로 변환 정확성 검증.

### Pitfall 2: 가격 불명 토큰 $0 처리 -> USD 한도 우회

**What goes wrong:** 가격을 조회할 수 없는 토큰의 USD 가치를 $0으로 처리하면, USD 기반 spending limit을 완전히 우회할 수 있다. 공격자가 가치 있는 미등록 토큰을 $0으로 전송.

**Why it happens:** "가격 정보 없음 = 무가치"라는 잘못된 가정.

**Consequences:** USD 한도($1000 instant, $5000 approval 등)가 완전히 무력화. 보안 모델 붕괴.

**Prevention:** 목표 문서의 PriceResult discriminated union으로 해결:
- `success(usdAmount)`: 정상 USD 평가
- `oracleDown()`: 오라클 장애 -> 네이티브 금액만으로 평가
- `notListed()`: 미등록 토큰 -> **최소 NOTIFY 격상** (건별 결과와 비교하여 높은 쪽 적용)

**Detection:** 테스트: 미등록 토큰 전송 시 NOTIFY 이상 티어 적용 assert.

### Pitfall 3: ESM 플러그인 악성 코드 실행

**What goes wrong:** `~/.waiaas/actions/` 디렉토리에 배치된 ESM 플러그인이 `import()` 시점에 임의 코드를 실행할 수 있다. 파일 시스템 접근, 네트워크 호출, 프로세스 종료 등.

**Why it happens:** `import()`는 모듈의 top-level 코드를 즉시 실행. Node.js에는 모듈 레벨 샌드박스가 없다.

**Consequences:** 데몬 프로세스의 전체 권한으로 임의 코드 실행. 키스토어 접근, 마스터 패스워드 탈취 가능.

**Prevention:**
1. **validate-then-trust**: 인터페이스 준수 검증 (Zod) + resolve() 반환값 검증
2. **Owner 책임**: 플러그인은 Owner가 직접 설치하므로 신뢰 경계는 Owner
3. **향후 검토**: VM 격리(vm.Module, isolated-vm) -- v1.5 범위 외
4. **문서화**: 플러그인 설치 시 보안 경고 명시 + 소스 코드 검토 권고

**Detection:** 플러그인 로드 시 metadata 검증 전에 console.log 등 사이드 이펙트 감지는 불가능. 로드 자체가 실행이다.

---

## Moderate Pitfalls

### Pitfall 4: Pyth Feed ID 매핑 불일치

**What goes wrong:** TokenRef.address(온체인 컨트랙트 주소)와 Pyth feed ID(bytes32 해시)가 직접 매핑되지 않는다. USDC의 Solana mint 주소 `EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v`와 Pyth USDC/USD feed ID는 완전히 다른 값이다.

**Prevention:**
- 주요 토큰 10~15개: `address -> feedId` 하드코딩 맵
- 네이티브 토큰: `chain -> feedId` 별도 매핑 (SOL->SOL/USD, ETH->ETH/USD)
- 미등록: `/v2/price_feeds?query=<symbol>` 동적 검색 + 결과 캐싱
- 동일 심볼 충돌: 검색 결과에서 정확한 feed 선택 로직 필요 (e.g., "USD Coin" vs "USDC.e")

### Pitfall 5: CoinGecko 월간 10,000 호출 상한 도달

**What goes wrong:** Demo API 월간 10,000 호출 상한에 도달하면 CoinGecko fallback이 완전히 비활성화된다. 이후 Pyth만으로 운영해야 하며, Pyth 미지원 토큰의 가격을 전혀 조회할 수 없다.

**Prevention:**
- 5분 TTL 캐시 + 배치 조회로 요청 최소화
- 캐시 히트 시 API 호출 하지 않음 (히트율 추적)
- 월간 사용량 모니터링: `GET /v1/admin/oracle-status`에 CoinGecko 호출 횟수 포함
- 상한 근접 시 Admin 알림 + Pro 키 업그레이드 안내
- 상한 도달 시 graceful degradation: CoinGecko 비활성화 + notListed 토큰은 NOTIFY 격상

### Pitfall 6: 교차 검증 오탐 (저유동성 토큰)

**What goes wrong:** Pyth와 CoinGecko 가격 편차 >5% 임계값이 저유동성 토큰에서 정상적인 가격 차이를 "이상"으로 판정. STALE 격하가 빈번하게 발생하여 USD 정책 평가가 사실상 비활성화.

**Prevention:**
- 5% 임계값은 Admin Settings > Oracle에서 런타임 오버라이드 가능
- CoinGecko 키 미설정 시 교차 검증 자체가 비활성화되므로 영향 없음
- PRICE_DEVIATION_WARNING 감사 로그로 빈도 모니터링
- 토큰별 임계값은 v1.5 범위 외

### Pitfall 7: fetch() 타임아웃 미설정 -> 데몬 블로킹

**What goes wrong:** `AbortSignal.timeout()` 없이 외부 API 호출 시, 응답이 오지 않으면 파이프라인이 무한 대기. 트랜잭션 처리가 멈춘다.

**Prevention:**
```typescript
// 모든 외부 API 호출에 AbortSignal.timeout() 필수
fetch(url, { signal: AbortSignal.timeout(5000) }); // Pyth: 5s
fetch(url, { signal: AbortSignal.timeout(10000) }); // CoinGecko: 10s

// AbortError 처리
try {
  const res = await fetch(url, { signal: AbortSignal.timeout(5000) });
} catch (e) {
  if (e instanceof DOMException && e.name === 'TimeoutError') {
    throw new ChainError('TRANSIENT', 'Pyth: request timeout');
  }
  throw e;
}
```

### Pitfall 8: ESM import() 캐시로 플러그인 핫 리로드 불가

**What goes wrong:** Node.js ESM은 모듈 URL을 키로 캐시한다. `import('/path/to/plugin.mjs')`를 두 번 호출하면 두 번째는 캐시된 모듈을 반환. 플러그인 파일을 교체해도 재시작 전까지 이전 버전이 유지.

**Prevention:**
- v1.5 범위: 플러그인 로드는 데몬 시작 시 1회만 수행. 핫 리로드 미지원 명시.
- 플러그인 추가/변경 시 데몬 재시작 안내 (Admin UI에서 알림)
- 향후 필요 시: `import(fileUrl + '?t=' + Date.now())` 쿼리 파라미터로 캐시 무효화 (메모리 누수 주의)

---

## Minor Pitfalls

### Pitfall 9: Pyth 가격 publish_time과 시스템 시간 불일치

**What goes wrong:** Pyth publish_time은 UTC 초 단위. 시스템 시간이 크게 어긋나면 classifyPriceAge()가 FRESH 가격을 STALE로 판정하거나 반대.

**Prevention:** NTP 동기화 전제. classifyPriceAge()에서 미래 publish_time(시스템 시간보다 앞선)은 FRESH로 처리.

### Pitfall 10: CoinGecko platformId 대소문자

**What goes wrong:** CoinGecko API는 platformId에 소문자를 기대 (`ethereum`, `solana`). 대문자 전달 시 404 또는 빈 응답.

**Prevention:** `ChainType -> platformId` 매핑에서 항상 소문자로 정규화.

### Pitfall 11: 동시 요청 시 Cache Stampede

**What goes wrong:** 캐시 만료 직후 동일 토큰에 대한 다수 요청이 동시에 들어오면, 모두 캐시 미스로 처리되어 동일 API를 중복 호출.

**Prevention:**
```typescript
// in-flight 요청 추적으로 중복 방지
private readonly pending = new Map<string, Promise<PriceInfo>>();

async getPrice(key: string): Promise<PriceInfo> {
  const cached = this.cache.get(key);
  if (cached && !isExpired(cached)) return cached;

  const existing = this.pending.get(key);
  if (existing) return existing; // 진행 중인 요청 재사용

  const promise = this.fetchFromSource(key).finally(() => this.pending.delete(key));
  this.pending.set(key, promise);
  return promise;
}
```

---

## Phase-Specific Warnings

| Phase Topic | Likely Pitfall | Mitigation |
|-------------|---------------|------------|
| IPriceOracle 인터페이스 | 가격 정밀도 타입 결정 (number vs BigInt) | number 사용하되 변환 함수에서 방어적 검증 |
| PythOracle 구현 | Feed ID 매핑 불일치 | 하이브리드 전략 (하드코딩 + 동적 검색) |
| CoinGeckoOracle 구현 | Rate limit 429 처리 누락 | 모든 HTTP 응답에서 429 명시적 처리 + TRANSIENT 에러 |
| OracleChain 교차 검증 | 저유동성 토큰 오탐 | 5% 기본값 + Admin Settings 오버라이드 |
| resolveEffectiveAmountUsd | 가격 불명 토큰 $0 우회 | PriceResult discriminated union + NOTIFY 격상 |
| InMemoryPriceCache | Cache stampede | in-flight 요청 추적 (pending Map) |
| ActionProviderRegistry | 악성 플러그인 실행 | validate-then-trust + Owner 책임 명시 |
| ESM dynamic import | 캐시로 핫 리로드 불가 | 데몬 재시작 시에만 플러그인 로드 |
| MCP Tool 변환 | 동적 도구 등록/해제 시 MCP 세션 상태 불일치 | 프로바이더 등록/해제 시 tool 목록 갱신 알림 |
| API 키 저장 | 암호화 패턴 불일치 (secretbox vs AES-GCM) | 기존 AES-GCM 패턴 재사용 권장 |

---

## Sources

- [Pyth Developer Hub](https://docs.pyth.network/price-feeds/core/fetch-price-updates) - 가격 데이터 형식 [HIGH]
- [CoinGecko Rate Limits](https://docs.coingecko.com/docs/common-errors-rate-limit) - 429 처리 [HIGH]
- [Node.js ESM Docs](https://nodejs.org/api/esm.html) - 모듈 캐시 동작 [HIGH]
- [sodium-native secretbox](https://sodium-friends.github.io/docs/docs/secretkeyboxencryption) - API 사양 [HIGH]
- [MDN AbortSignal.timeout](https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal/timeout_static) - 타임아웃 패턴 [HIGH]
