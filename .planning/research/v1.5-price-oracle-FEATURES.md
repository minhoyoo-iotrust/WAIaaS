# Feature Landscape: v1.5 Price Oracle + Action Provider

**Domain:** DeFi Price Oracle + Plugin Architecture
**Researched:** 2026-02-15

---

## Table Stakes

v1.5 마일스톤이 "완료"되려면 반드시 동작해야 하는 기능.

| Feature | Why Expected | Complexity | Notes |
|---------|--------------|------------|-------|
| IPriceOracle 인터페이스 (4개 메서드) | USD 정책 평가의 기반. 인터페이스 없이 구현체 작성 불가 | Low | getPrice, getPrices, getNativePrice, getCacheStats |
| PythOracle (Hermes REST) | Zero-config Primary Oracle. 설치 직후 USD 평가 동작 필수 | Med | `/v2/updates/price/latest` + feed ID 매핑 |
| CoinGeckoOracle (Demo API) | Pyth fallback + 롱테일 토큰 커버리지. opt-in이지만 구현은 필수 | Med | `/simple/token_price/{platform}` + platformId 매핑 |
| OracleChain (Pyth->CoinGecko) | 2단계 fallback + 교차 검증. 단일 소스 장애 시 서비스 연속성 보장 | Med | 교차 검증 인라인 (편차>5% STALE 격하) |
| InMemoryPriceCache (LRU 128) | API 호출 최소화 + rate limit 관리. 캐시 없으면 매 트랜잭션마다 API 호출 | Med | 5분 TTL, FRESH/AGING/STALE 3단계 |
| classifyPriceAge() 3단계 | 가격 신선도 기반 정책 분기. 목표 문서 OPER-03 결정 반영 | Low | FRESH<5분, AGING 5~30분, STALE>30분 |
| resolveEffectiveAmountUsd() | 5-type 트랜잭션 모두 USD 변환. USD 정책의 핵심 함수 | High | PriceResult discriminated union (success/oracleDown/notListed) |
| SpendingLimitRuleSchema USD 필드 | instant_max_usd, notify_max_usd, delay_max_usd. Zod SSoT 원칙 | Med | 현재 TypeScript interface -> Zod 스키마 신규 생성 |
| IActionProvider 인터페이스 | 플러그인 프레임워크의 핵심. metadata/actions/resolve 3-part | Low | resolve()는 ContractCallRequest만 반환 |
| ActionProviderRegistry | 플러그인 발견/로드/검증. ESM dynamic import | High | ~/.waiaas/actions/ 디렉토리 스캔 |
| ActionDefinition -> MCP Tool 변환 | Action을 MCP 도구로 자동 노출. AI 에이전트가 Action 호출 가능 | Med | zodToJsonSchema + server.tool() 등록 |
| REST API (actions, oracle-status) | HTTP API로 Action 실행 + 오라클 상태 조회 | Med | POST /v1/actions/:provider/:action, GET /v1/admin/oracle-status |
| API 키 관리 (CRUD) | 프로바이더별 API 키 암호화 저장/조회/삭제 | Med | DB 암호화, 마스킹 조회, Admin UI |
| DB v11 마이그레이션 | api_keys 테이블 추가 | Low | ALTER TABLE 증분 마이그레이션 |

---

## Differentiators

사용자가 기대하지 않지만, 있으면 가치를 느끼는 기능.

| Feature | Value Proposition | Complexity | Notes |
|---------|-------------------|------------|-------|
| Pyth confidence interval 활용 | PriceInfo.confidence에 Pyth의 conf 값 매핑. 가격 신뢰도를 사용자에게 제공 | Low | Pyth 응답에 conf 필드 이미 포함 |
| 교차 검증 편차 임계값 Admin 오버라이드 | 운영 환경에 맞게 5% 기본값을 조정 가능 | Low | SettingsService 확장 |
| CoinGecko 키 안내 힌트 (최초 1회) | 미등록 토큰 첫 전송 시 "CoinGecko API 키를 설정하면..." 안내 | Low | 스팸 방지: 동일 토큰 재발생 시 생략 |
| Cache stampede 방지 (in-flight 추적) | 동시 요청 시 중복 API 호출 방지 | Low | pending Map 패턴 |
| mcpExpose 플래그 기반 MCP 도구 필터링 | 프로바이더별 MCP 노출 여부 제어 | Low | ActionProviderMetadata.mcpExpose |
| PRICE_DEVIATION_WARNING 감사 로그 | 교차 검증 편차 발생 시 감사 추적 | Low | 기존 감사 로그 인프라 활용 |

---

## Anti-Features

명시적으로 구현하지 않는 기능.

| Anti-Feature | Why Avoid | What to Do Instead |
|--------------|-----------|-------------------|
| Chainlink Oracle | EVM 전용(Solana 미지원), Aggregator 주소 유지 부담. Pyth가 체인 무관 380+ 피드 제공 | Pyth Primary + CoinGecko Fallback 2단계로 충분 |
| WebSocket/SSE 실시간 가격 스트리밍 | 5분 TTL 캐시로 충분. 실시간 스트리밍은 데몬 리소스 과다 소비 + 복잡도 증가 | REST API 폴링 + 캐시 TTL 갱신 |
| 온체인 Oracle 직접 조회 | RPC 호출 비용 + 체인별 구현 필요. Hermes REST가 동일 데이터를 무료 제공 | Pyth Hermes REST API |
| Action Provider VM 샌드박스 | 구현 복잡도 HIGH. Node.js VM은 보안 경계로 부적절 (공식 문서 경고). v1.5 범위 초과 | validate-then-trust + Owner 책임 |
| 플러그인 핫 리로드 | ESM 캐시 무효화 시 메모리 누수 위험. 복잡도 대비 가치 낮음 | 데몬 재시작으로 플러그인 갱신 |
| 구체적 DeFi 프로토콜 연동 (Jupiter, Uniswap) | v1.5는 프레임워크만 구현. 개별 프로토콜은 v1.5.5+ | IActionProvider 인터페이스로 향후 추가 |
| 토큰별 교차 검증 임계값 | 복잡도 대비 v1.5 MVP에서 불필요. 글로벌 5% 기본값 + Admin 오버라이드로 충분 | 글로벌 임계값 + Admin Settings |
| MCP Tool 개수 상한 | MCP 프로토콜에 상한 없음. mcpExpose 플래그로 충분히 제어 | mcpExpose + Admin Settings priority |

---

## Feature Dependencies

```
IPriceOracle 인터페이스 → PythOracle 구현체
IPriceOracle 인터페이스 → CoinGeckoOracle 구현체
PythOracle + CoinGeckoOracle → OracleChain fallback
InMemoryPriceCache → PythOracle (캐시 레이어)
InMemoryPriceCache → CoinGeckoOracle (캐시 레이어)
classifyPriceAge() → OracleChain (가격 나이 판정)
OracleChain → resolveEffectiveAmountUsd() (가격 제공)
SpendingLimitRuleSchema USD 필드 → resolveEffectiveAmountUsd() (USD 임계값)
resolveEffectiveAmountUsd() → Pipeline Stage 3 (정책 평가 통합)

IActionProvider 인터페이스 → ActionProviderRegistry
ActionProviderRegistry → MCP Tool 변환
ActionProviderRegistry → REST API /v1/actions/
API 키 관리 (CRUD) → ActionProviderRegistry (requiresApiKey 검증)
DB v11 (api_keys 테이블) → API 키 관리 (저장소)
```

---

## MVP Recommendation

Prioritize:
1. IPriceOracle + InMemoryPriceCache + classifyPriceAge() -- 핵심 인프라
2. PythOracle + CoinGeckoOracle -- API 통합
3. OracleChain + resolveEffectiveAmountUsd() -- USD 정책 동작
4. IActionProvider + ActionProviderRegistry -- 플러그인 프레임워크
5. MCP Tool 변환 + REST API -- 외부 인터페이스

Defer:
- 교차 검증 편차 임계값 토큰별 커스텀: v1.5 범위 외
- 구체적 DeFi 프로토콜 플러그인: v1.5.5+
- 플러그인 핫 리로드: 향후 검토
- VM 샌드박스: 향후 검토

---

## Sources

- [v1.5 목표 문서](/Users/minho.yoo/dev/wallet/WAIaaS/objectives/v1.5-defi-price-oracle.md) - 구현 범위 정의
- [Pyth Developer Hub](https://docs.pyth.network/price-feeds/core/fetch-price-updates) - Oracle 기능 범위
- [CoinGecko API](https://docs.coingecko.com/reference/simple-token-price) - Fallback 기능 범위
