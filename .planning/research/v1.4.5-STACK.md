# Technology Stack: Multichain Wallet Environment Model

**Project:** WAIaaS v1.4.5 (multichain wallet design) + v1.4.6 (implementation)
**Researched:** 2026-02-14
**Mode:** Ecosystem (subsequent milestone -- delta stack only)

---

## Executive Summary

멀티체인 월렛 환경 모델은 **새로운 라이브러리 추가가 필요 없다.** 기존 viem 2.x + better-sqlite3 + Drizzle ORM 스택이 이 기능을 완전히 지원한다. 핵심 변경은 데이터 모델(DB 마이그레이션)과 어댑터 해결 로직(런타임 네트워크 선택)이며, 이는 순수 코드 변경으로 해결된다.

viem은 설계적으로 단일 체인 클라이언트이고, 현재 AdapterPool이 이미 `chain:network` 키로 멀티 클라이언트를 관리하는 패턴을 구현하고 있어 구조 변경 없이 트랜잭션 레벨 네트워크 지정으로 전환할 수 있다. SQLite 3.51.2(better-sqlite3 12.6.2 번들)는 ALTER TABLE RENAME COLUMN을 완전히 지원하지만, CHECK 제약 변경이 필요하므로 기존 12-step 테이블 재생성 패턴을 사용해야 한다.

---

## Recommended Stack (Delta -- Changes Only)

### No New Dependencies Required

| Category | Decision | Rationale |
|----------|----------|-----------|
| EVM multi-chain RPC | **viem 2.x 그대로 (^2.21.0, 현재 2.45.3)** | viem PublicClient는 단일 체인 설계. 현재 AdapterPool의 per-network 인스턴스 맵 패턴이 이미 올바른 패턴. 새 라이브러리 불필요 |
| Chain metadata resolution | **viem/chains 내장 정의 그대로** | EVM_CHAIN_MAP이 이미 10개 네트워크를 viem Chain 객체로 매핑. chainId, nativeSymbol, nativeName 포함 |
| DB migration | **better-sqlite3 12.6.2 + 자체 Migration 프레임워크 그대로** | SQLite 3.51.2 번들 (RENAME COLUMN 3.25+ 지원). 기존 MIGRATIONS 배열 + runMigrations() 완전히 적합 |
| ORM schema | **Drizzle ORM 0.45.x 그대로** | Drizzle 스키마를 `network` -> `environment`로 변경. DDL은 자체 migrate.ts에서 관리 |
| Zod validation | **zod 3.24.x 그대로** | 새 EnvironmentType enum + 환경-네트워크 매핑 함수 추가만 필요 |
| Policy engine | **기존 POLICY_TYPES SSoT 확장** | `'ALLOWED_NETWORKS'` 추가 (11번째 정책 타입) |

### Explicitly NOT Adding

| Library | Why NOT |
|---------|---------|
| **wagmi / @wagmi/core** | wagmi는 프론트엔드 멀티체인 추상화. 서버 사이드 데몬에서는 viem PublicClient 맵이 더 가볍고 적합. wagmi는 Connector/Account 관리가 핵심인데 데몬은 raw private key signing이므로 불필요 |
| **ethers.js** | viem 이미 사용 중. 같은 역할의 라이브러리를 중복 추가할 이유 없음 |
| **chainlist / chains npm** | viem/chains가 이미 Tier 1 5체인 + testnet 정의를 모두 포함. 외부 체인 메타데이터 라이브러리 불필요 |
| **drizzle-kit migrate** | Drizzle Kit의 마이그레이션은 SQL 파일 기반. WAIaaS는 이미 프로그래매틱 Migration[] 배열을 사용하며, 12-step 재생성 같은 복잡한 마이그레이션에 더 적합 |
| **node-sqlite3 / sql.js** | better-sqlite3 동기 API가 마이그레이션 트랜잭션 제어에 최적. 변경 불필요 |

---

## Existing Stack Integration Points

### 1. viem 2.x -- Multi-Chain Client Pattern

**현재 상태 (HIGH confidence):**

viem은 설계적으로 단일 체인 PublicClient이다. 공식 패턴은 "Chain당 하나의 PublicClient 인스턴스를 Map에 캐싱"이다.

```typescript
// 현재 AdapterPool이 이미 이 패턴을 구현
// Key: "ethereum:ethereum-sepolia" -> Value: EvmAdapter(PublicClient)
private readonly _pool = new Map<string, IChainAdapter>();
```

**변경 필요 사항:**

1. AdapterPool.resolve()의 호출자만 변경: 월렛의 `network` 대신 트랜잭션의 `network` 전달
2. AdapterPool 자체의 캐시 키(`${chain}:${network}`)는 변경 불필요
3. EvmAdapter의 chain/network 필드도 변경 불필요 -- 개별 어댑터는 여전히 단일 네트워크

```typescript
// 변경 전: 월렛에서 network 가져옴
const adapter = await pool.resolve(wallet.chain, wallet.network, rpcUrl);

// 변경 후: 트랜잭션 요청에서 network 해결 후 전달
const resolvedNetwork = request.network ?? wallet.defaultNetwork;
const adapter = await pool.resolve(wallet.chain, resolvedNetwork, rpcUrl);
```

**viem/chains 현재 활용 (HIGH confidence):**

```typescript
// evm-chain-map.ts에서 이미 10개 네트워크 정의
import { mainnet, sepolia, polygon, polygonAmoy, ... } from 'viem/chains';

export const EVM_CHAIN_MAP: Record<EvmNetworkType, EvmChainEntry> = {
  'ethereum-mainnet': { viemChain: mainnet, chainId: 1, ... },
  'ethereum-sepolia': { viemChain: sepolia, chainId: 11155111, ... },
  // ... 10개 전체
};
```

EVM_CHAIN_MAP은 변경 불필요. 환경-네트워크 매핑은 별도 함수(`getNetworksForEnvironment`)로 처리.

**Source:** [viem Discussion #986: Build a Map with PublicClients](https://github.com/wevm/viem/discussions/986), [viem Chains docs](https://viem.sh/docs/chains/introduction)

### 2. SQLite Migration -- Column Transformation Pattern

**현재 상태 (HIGH confidence):**

- better-sqlite3 12.6.2 번들: **SQLite 3.51.2** (RENAME COLUMN은 3.25.0+에서 지원)
- 현재 schema_version: **5** (5개 마이그레이션 적용)
- 마이그레이션 프레임워크: `MIGRATIONS[]` 배열 + `runMigrations()` (v2~v5 마이그레이션 실적)
- 12-step 테이블 재생성: v2(CHECK 확장), v3(테이블/컬럼 리네임)에서 검증 완료

**network -> environment 변환에 필요한 마이그레이션:**

단순 RENAME COLUMN은 가능하지만(`ALTER TABLE wallets RENAME COLUMN network TO environment`), 이 경우는 **데이터 변환 + CHECK 제약 변경**이 동반되므로 12-step 테이블 재생성이 필요하다.

| 변경 항목 | SQLite 지원 | 필요 패턴 |
|-----------|------------|----------|
| 컬럼명 변경 (network -> environment) | `ALTER TABLE RENAME COLUMN` (3.25+) | RENAME COLUMN 사용 가능 |
| CHECK 제약 변경 (NETWORK_TYPES -> ENVIRONMENT_TYPES) | 미지원 | 12-step 재생성 필요 |
| 데이터 변환 (network 값 -> environment 값) | UPDATE 문 | 표준 UPDATE |
| 새 컬럼 추가 (default_network) | `ALTER TABLE ADD COLUMN` | 표준 ADD COLUMN |

**결론: CHECK 제약 변경 때문에 12-step 재생성 패턴을 사용해야 한다.** 단순 RENAME COLUMN으로는 CHECK 제약의 허용 값 목록을 변경할 수 없다.

**마이그레이션 순서 (v6):**

```
1. PRAGMA foreign_keys=OFF
2. BEGIN
3. CREATE TABLE wallets_new (... environment TEXT ... CHECK environment IN ('testnet','mainnet') ... default_network TEXT ...)
4. INSERT INTO wallets_new SELECT id, name, chain,
     CASE
       WHEN network IN ('mainnet','ethereum-mainnet','polygon-mainnet','arbitrum-mainnet','optimism-mainnet','base-mainnet') THEN 'mainnet'
       ELSE 'testnet'
     END as environment,
     network as default_network,
     public_key, status, ...
   FROM wallets
5. DROP TABLE wallets
6. ALTER TABLE wallets_new RENAME TO wallets
7. Recreate indexes
8. COMMIT
9. PRAGMA foreign_key_check
10. PRAGMA foreign_keys=ON
```

**추가 마이그레이션 (v7 -- transactions.network + policies.network 컬럼 추가):**

```sql
-- 표준 ADD COLUMN (12-step 불필요)
ALTER TABLE transactions ADD COLUMN network TEXT;
ALTER TABLE policies ADD COLUMN network TEXT;

-- 기존 트랜잭션에 네트워크 역참조 (wallets 조인)
UPDATE transactions SET network = (
  SELECT w.default_network FROM wallets w WHERE w.id = transactions.wallet_id
);
```

**Source:** [SQLite ALTER TABLE docs](https://www.sqlite.org/lang_altertable.html)

### 3. Drizzle ORM Schema Change

**현재 상태 (HIGH confidence):**

Drizzle 스키마(`schema.ts`)는 DDL의 TypeScript 미러이다. WAIaaS는 Drizzle Kit 마이그레이션을 사용하지 않고 자체 `pushSchema()` + `MIGRATIONS[]`를 사용한다.

**변경 필요:**

```typescript
// 변경 전
export const wallets = sqliteTable('wallets', {
  chain: text('chain').notNull(),
  network: text('network').notNull(),
  // ...
});

// 변경 후
export const wallets = sqliteTable('wallets', {
  chain: text('chain').notNull(),
  environment: text('environment').notNull(),
  defaultNetwork: text('default_network'),
  // ...
});

// CHECK 제약 변경
check('check_environment', buildCheckSql('environment', ENVIRONMENT_TYPES)),
// check_network 제거

// 인덱스 변경
index('idx_wallets_chain_environment').on(table.chain, table.environment),
// idx_wallets_chain_network 대체
```

transactions/policies 테이블에 `network` 컬럼 추가:

```typescript
export const transactions = sqliteTable('transactions', {
  // ... 기존 필드
  network: text('network'),  // nullable -- 마이그레이션 후 역참조로 채움
});

export const policies = sqliteTable('policies', {
  // ... 기존 필드
  network: text('network'),  // nullable -- null이면 전체 네트워크 적용
});
```

### 4. Zod Schema + Enum SSoT

**현재 상태 (HIGH confidence):**

```typescript
// packages/core/src/enums/chain.ts -- 현재
export const NETWORK_TYPES = ['mainnet', 'devnet', 'testnet',
  'ethereum-mainnet', 'ethereum-sepolia', ...] as const;
```

**추가 필요:**

```typescript
// 새 enum
export const ENVIRONMENT_TYPES = ['testnet', 'mainnet'] as const;
export type EnvironmentType = (typeof ENVIRONMENT_TYPES)[number];
export const EnvironmentTypeEnum = z.enum(ENVIRONMENT_TYPES);

// 새 매핑 함수
export function getNetworksForEnvironment(chain: ChainType, env: EnvironmentType): NetworkType[];
export function getDefaultNetwork(chain: ChainType, env: EnvironmentType): NetworkType;
export function validateNetworkEnvironment(chain: ChainType, env: EnvironmentType, network: NetworkType): void;
export function deriveEnvironment(network: NetworkType): EnvironmentType;
```

NETWORK_TYPES는 유지 -- 트랜잭션 레벨에서 여전히 사용.
CHAIN_TYPES는 유지 -- `'solana' | 'ethereum'` 변경 없음.

### 5. Policy Engine Extension

**현재 상태 (HIGH confidence):**

```typescript
// 현재 10개 정책 타입
export const POLICY_TYPES = [
  'SPENDING_LIMIT', 'WHITELIST', 'TIME_RESTRICTION', 'RATE_LIMIT',
  'ALLOWED_TOKENS', 'CONTRACT_WHITELIST', 'METHOD_WHITELIST',
  'APPROVED_SPENDERS', 'APPROVE_AMOUNT_LIMIT', 'APPROVE_TIER_OVERRIDE',
] as const;
```

**추가:**

```typescript
// 11번째 정책 타입
export const POLICY_TYPES = [
  ...existingTypes,
  'ALLOWED_NETWORKS',
] as const;
```

이 변경은 DB의 `policies.type` CHECK 제약에 전파된다. 하지만 policies 테이블의 `type` CHECK는 SSoT 배열에서 동적으로 생성되므로, 새 DB(pushSchema)에서는 자동 반영된다. 기존 DB의 CHECK 제약은 `'ALLOWED_NETWORKS'` 값이 삽입될 때 위반될 수 있으므로, v6 또는 v7 마이그레이션에서 policies 테이블 CHECK도 갱신해야 한다.

### 6. Keystore -- No Change Required

**현재 상태 (HIGH confidence):**

```typescript
// keystore.ts
private keystorePath(walletId: string): string {
  return join(this.keystoreDir, `${walletId}.json`);
}
```

키 파일 경로는 `walletId`만으로 결정된다. 키 파일 내부에 `network` 필드가 메타데이터로 존재하지만, 키 로드/복호화에 사용되지 않는다. **키스토어 구조 변경 불필요.**

키 파일 내부의 `network` 메타데이터를 `environment`로 업데이트하는 것은 선택 사항이며, 하위호환에 영향 없음.

---

## Environment-Network Mapping Architecture

### Standard Pattern Analysis

멀티체인 지갑의 환경 기반 추상화는 업계 표준 패턴이다:

| 서비스 | 모델 | 참고 |
|--------|------|------|
| MetaMask | 네트워크 전환 (wallet_switchEthereumChain) | 런타임 네트워크 선택 |
| Magic.link | 체인별 인스턴스 생성, 멀티체인 지원 | per-chain Magic 인스턴스 |
| Wepin WaaS | 단일 지갑으로 멀티체인 관리 | 환경 기반 지갑 그루핑 |
| WalletConnect v2 | 연결 시 모든 지원 체인 승인 | 사전 승인 기반 멀티체인 |

WAIaaS의 "1 wallet = 1 chain + 1 environment" 모델은 이 패턴들과 일치하며, 특히 서버 사이드 WaaS에 적합한 설계이다:

- **MetaMask 패턴과 유사:** 런타임에 네트워크를 선택하되, 키는 공유
- **Magic.link과 차이:** 인스턴스를 per-chain으로 만들 필요 없음 (AdapterPool이 캐싱)
- **WalletConnect v2와 유사:** 환경(testnet/mainnet) 레벨에서 사전 정의된 네트워크 세트 사용

**MEDIUM confidence** -- WebSearch 결과 기반, 공식 아키텍처 문서 없음

**Source:** [Magic.link multichain docs](https://magic.link/docs/blockchains/multichain), [Wepin blog on multi-chain](https://www.wepin.io/en/blog/evm-non-evm-multi-chain)

---

## Version Matrix

| Package | Current Version | Required Change | New Version |
|---------|----------------|-----------------|-------------|
| viem | 2.45.3 (^2.21.0) | 없음 | 동일 |
| better-sqlite3 | 12.6.2 | 없음 | 동일 |
| drizzle-orm | 0.45.1 (^0.45.0) | 없음 | 동일 |
| @waiaas/core | 1.4.3 | Zod 스키마 + enum 추가 | 1.4.5 |
| @waiaas/daemon | 1.4.3 | DB 마이그레이션 + route 변경 | 1.4.5/1.4.6 |
| @waiaas/adapter-evm | 1.4.3 | 없음 (어댑터 자체 변경 없음) | 동일 |
| @waiaas/adapter-solana | (현재 버전) | 없음 | 동일 |
| @waiaas/sdk | (현재 버전) | 메서드 시그니처에 network 옵션 추가 | 1.4.6 |
| @waiaas/mcp | (현재 버전) | 도구 파라미터에 network 추가 | 1.4.6 |
| @waiaas/admin | (현재 버전) | UI 변경 (environment 라디오버튼) | 1.4.6 |

---

## Installation

```bash
# 새 패키지 설치 없음.
# 기존 의존성 그대로 사용.
```

---

## Migration Complexity Assessment

| 마이그레이션 | 복잡도 | 패턴 | 선례 |
|-------------|--------|------|------|
| wallets: network -> environment + default_network | **High** | 12-step 재생성 + 데이터 변환 | v2(CHECK 확장), v3(리네임) 선례 있음 |
| transactions: network 컬럼 추가 + 역참조 | **Medium** | ADD COLUMN + UPDATE JOIN | 표준 패턴, 선례: v4(token_registry 생성) |
| policies: network 스코프 + type CHECK 갱신 | **Medium** | 12-step 재생성 (CHECK 변경) 또는 ADD COLUMN + 별도 12-step | v2 선례 |
| POLICY_TYPES SSoT 확장 | **Low** | enum 배열에 항목 추가 | v1.4에서 여러 번 수행 |

**총 마이그레이션 수: 2~3개 (v6, v7, 선택적 v8)**

- v6: wallets 테이블 재생성 (network -> environment + default_network + CHECK 변경)
- v7: transactions + policies ADD COLUMN + transactions 역참조 UPDATE
- v8 (선택): policies 테이블 재생성 (type CHECK에 ALLOWED_NETWORKS 추가)

또는 v6에서 wallets + policies를 한 번에 재생성하고, v7에서 transactions만 처리하는 2-migration 전략도 가능.

---

## Key Technical Decisions for Design Phase

| # | 결정 항목 | 추천 | 근거 |
|---|-----------|------|------|
| 1 | 마이그레이션 수 | 2개 (v6: wallets+policies 재생성, v7: transactions ADD+UPDATE) | 마이그레이션 횟수 최소화. policies의 CHECK도 v6에서 함께 변경 |
| 2 | default_network NULL 의미 | NULL = 환경 기본값 사용 | getDefaultNetwork()로 런타임 해결. DB에 중복 저장 회피 |
| 3 | transactions.network NOT NULL | 아니오 -- nullable | 기존 레코드는 역참조로 채우되, NULL인 경우 wallet.defaultNetwork 폴백 |
| 4 | 키스토어 파일 내 network 메타데이터 | 변경하지 않음 | 하위호환 보존. 키 로드에 영향 없음. 향후 필요 시 신규 생성 키만 `environment`로 기록 |
| 5 | ALLOWED_NETWORKS 미설정 동작 | 환경 내 전체 네트워크 허용 | 기본 거부 원칙의 예외. 하위호환 필수 (기존 월렛이 추가 정책 없이 동작) |
| 6 | EVM_CHAIN_MAP 변경 | 변경 없음 | 네트워크 -> viem Chain 매핑은 그대로. 환경 -> 네트워크 매핑은 별도 함수 |
| 7 | LATEST_SCHEMA_VERSION | 6 -> 7 (또는 8) | pushSchema의 DDL도 업데이트 필요 |

---

## Confidence Assessment

| Area | Level | Reason |
|------|-------|--------|
| viem multi-chain pattern | **HIGH** | 코드베이스 직접 확인 + viem 공식 Discussion 패턴 일치. AdapterPool이 이미 올바른 구현 |
| SQLite migration pattern | **HIGH** | SQLite 3.51.2 (RENAME COLUMN 지원 확인), 12-step 패턴 v2/v3에서 실전 검증 완료 |
| Drizzle schema change | **HIGH** | 코드베이스 직접 확인. Drizzle 스키마는 DDL 미러이므로 필드 변경만으로 충분 |
| Environment-based wallet pattern | **MEDIUM** | WebSearch 기반. Magic.link, Wepin, WalletConnect 사례 확인했으나 정확히 동일한 서버사이드 WaaS 패턴의 공식 문서는 없음 |
| No new dependencies needed | **HIGH** | 기존 스택 기능을 코드 레벨에서 확인. 모든 필요 기능이 현재 버전에서 지원됨 |

---

## Sources

### HIGH confidence (직접 확인)
- viem 2.45.3 소스: `packages/adapters/evm/src/adapter.ts` (createPublicClient 단일 체인 패턴)
- EVM_CHAIN_MAP: `packages/adapters/evm/src/evm-chain-map.ts` (10 네트워크 정의)
- AdapterPool: `packages/daemon/src/infrastructure/adapter-pool.ts` (chain:network 캐시 키)
- migrate.ts: `packages/daemon/src/infrastructure/database/migrate.ts` (v2~v5 마이그레이션, 12-step 패턴)
- keystore.ts: `packages/daemon/src/infrastructure/keystore/keystore.ts` (walletId 기반 경로)
- SQLite 3.51.2: `better-sqlite3/deps/sqlite3.h` SQLITE_VERSION 확인

### MEDIUM confidence (WebSearch 검증)
- [viem Discussion #986: PublicClient Map pattern](https://github.com/wevm/viem/discussions/986)
- [viem Chains documentation](https://viem.sh/docs/chains/introduction)
- [SQLite ALTER TABLE official documentation](https://www.sqlite.org/lang_altertable.html)
- [Magic.link multichain documentation](https://magic.link/docs/blockchains/multichain)
- [Wepin multi-chain blog](https://www.wepin.io/en/blog/evm-non-evm-multi-chain)
