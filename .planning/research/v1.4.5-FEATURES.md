# Feature Landscape: Multichain Wallet Environment Model

**Domain:** Multichain wallet management for AI agent WaaS
**Researched:** 2026-02-14

---

## Table Stakes

환경 모델 전환에 필수인 기능. 하나라도 빠지면 하위호환이 깨지거나 사용 불가.

| Feature | Why Expected | Complexity | Notes |
|---------|--------------|------------|-------|
| wallets.network -> environment 마이그레이션 | 데이터 모델 전환의 핵심. 기존 월렛이 새 모델에서 동작해야 함 | High | 12-step 재생성 + 데이터 변환. v2/v3 선례 있음 |
| 트랜잭션 레벨 network 지정 | EVM 월렛이 여러 네트워크에서 tx 실행하려면 필수 | Medium | POST /v1/transactions/send에 `network` 선택 파라미터 |
| 기본 네트워크(default_network) | network 미지정 시 폴백. 하위호환 보장의 핵심 | Low | wallets 테이블에 컬럼 추가. NULL이면 환경 기본값 |
| 환경-네트워크 매핑 함수 | chain+environment로 허용 네트워크 목록 해결 | Low | getNetworksForEnvironment(), getDefaultNetwork() |
| 환경 불일치 검증 | mainnet 월렛이 testnet 네트워크 사용 시 400 에러 | Low | validateNetworkEnvironment() |
| transactions.network 컬럼 | 실행된 네트워크를 기록. 감사/추적에 필수 | Medium | ADD COLUMN + 기존 레코드 역참조 UPDATE |
| Drizzle 스키마 동기화 | ORM이 새 테이블 구조를 반영해야 동작 | Low | schema.ts 필드 변경 |
| Zod SSoT EnvironmentType | 타입 안전성 보장. Zod -> TypeScript -> DB CHECK 파생 체인 | Low | 새 enum + 스키마 변경 |

## Differentiators

기본 동작에는 영향 없지만, 환경 모델의 가치를 극대화하는 기능.

| Feature | Value Proposition | Complexity | Notes |
|---------|-------------------|------------|-------|
| ALLOWED_NETWORKS 정책 | 월렛이 사용할 수 있는 네트워크 제한. 보안 강화 | Medium | 새 정책 타입 + Stage 1 검증 |
| 네트워크 스코프 정책 | 네트워크별 차등 정책 (e.g., Polygon에서만 높은 한도) | Medium | policies에 network 컬럼 추가. Stage 3 매칭 변경 |
| Quickstart 원스톱 명령 | `waiaas quickstart --mode testnet` -> 2 월렛(6 블록체인) 일괄 생성 | High | CLI 새 명령 + MCP 토큰 자동 생성 + 출력 포맷 |
| MCP network 파라미터 | "Polygon에서 ETH 보내줘" -> 직접 네트워크 지정 | Low | 기존 도구에 선택 파라미터 추가 |
| SDK network 옵션 | TypeScript/Python SDK에서 네트워크 선택 | Low | 메서드 시그니처 확장 |
| 월렛 네트워크 목록 API | GET /v1/wallets/:id/networks -> 사용 가능 네트워크 | Low | 새 엔드포인트 1개 |
| 기본 네트워크 변경 API | PUT /v1/wallets/:id/default-network | Low | 새 엔드포인트 1개 |
| Admin UI environment 모드 | 월렛 생성 시 testnet/mainnet 라디오버튼 | Medium | Preact 컴포넌트 변경 |
| 잔액 조회 네트워크 지정 | GET /v1/wallet/balance?network=polygon-mainnet | Low | 쿼리 파라미터 추가 |

## Anti-Features

명시적으로 구현하지 않을 기능.

| Anti-Feature | Why Avoid | What to Do Instead |
|--------------|-----------|-------------------|
| 환경 간 키 공유 | testnet 키가 mainnet에서 사용되면 보안 위험. AI 에이전트 실수 방지 | 환경별 월렛 분리 유지. mainnet 월렛은 mainnet 네트워크만 |
| 자동 네트워크 감지 | 수신 주소로 네트워크 추론은 불가능 (EVM 주소는 체인 무관). 잘못된 추론은 자금 손실 | 명시적 network 파라미터 또는 기본 네트워크 사용 |
| 크로스체인 전송 | Ethereum -> Polygon 브릿지는 DeFi 기능. 현재 스코프 초과 | v1.5 DeFi 확장에서 별도 고려 |
| 동적 체인 추가 | 런타임에 새 EVM 체인 등록은 RPC 설정/Chain 정의/토큰 레지스트리 등 복잡도 증가 | EVM_CHAIN_MAP에 코드 레벨로 Tier 1 체인만 관리 |
| 다중 환경 지원 | 'staging' 등 제3의 환경은 불필요한 복잡도. 블록체인은 testnet/mainnet 이분법 | testnet/mainnet 2개만 지원 |

## Feature Dependencies

```
EnvironmentType enum (core)
  -> WalletSchema 변경 (core)
    -> DB 마이그레이션 v6 (daemon)
      -> Drizzle 스키마 동기화 (daemon)
        -> API route 변경 (daemon)
          -> MCP 도구 변경 (mcp)
          -> SDK 메서드 변경 (sdk)
          -> Admin UI 변경 (admin)
          -> CLI Quickstart (cli)

ALLOWED_NETWORKS 정책 (core enum + daemon)
  -> Stage 1 검증 (daemon pipeline)
  -> policies 테이블 CHECK 갱신 (daemon migration)

네트워크 스코프 정책 (core + daemon)
  -> policies.network 컬럼 (daemon migration)
  -> Stage 3 매칭 변경 (daemon pipeline)
```

## MVP Recommendation

**Phase 1 (설계):** 전체 아키텍처를 설계 문서로 확정

**Phase 2 (Core + DB):**
1. EnvironmentType enum + 매핑 함수 (table stakes)
2. DB 마이그레이션 v6 (wallets 재생성) + v7 (transactions/policies)
3. Drizzle 스키마 동기화

**Phase 3 (API + Pipeline):**
4. 트랜잭션 레벨 network 지정 (table stakes)
5. 네트워크 해결 흐름 + 환경 불일치 검증
6. ALLOWED_NETWORKS 정책 (differentiator)

**Phase 4 (Interface):**
7. MCP/SDK network 파라미터 (differentiator)
8. Admin UI environment 모드

**Phase 5 (Quickstart + 통합):**
9. CLI Quickstart (differentiator)
10. 통합 테스트

**Defer:**
- 네트워크 스코프 정책: v1.4.6에서 구현하되, policies.network 컬럼은 v1.4.5 설계에서 확정
- 크로스체인 기능: v1.5 이후

## Sources

- v1.4.5 objective: `/Users/minho.yoo/dev/wallet/WAIaaS/objectives/v1.4.5-multichain-wallet-design.md`
- v1.4.6 objective: `/Users/minho.yoo/dev/wallet/WAIaaS/objectives/v1.4.6-multichain-wallet-impl.md`
- 기존 파이프라인: 6-stage, 8-state machine (docs/32-transaction-pipeline-api.md)
- 정책 엔진: DatabasePolicyEngine + POLICY_TYPES 10개 (packages/core/src/enums/policy.ts)
