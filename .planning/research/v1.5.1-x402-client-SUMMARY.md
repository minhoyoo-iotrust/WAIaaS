# Research Summary: v1.5.1 x402 Client Support

**Domain:** x402 프로토콜 클라이언트 -- AI 에이전트용 HTTP 402 자동 결제
**Researched:** 2026-02-15
**Overall confidence:** HIGH

---

## Executive Summary

WAIaaS에 x402 프로토콜 클라이언트를 추가하기 위한 기술 스택을 6가지 영역에서 조사했다. 핵심 발견은 **신규 npm 의존성이 `@x402/core` 1개만 필요**하다는 것이다.

Coinbase의 @x402/core v2.3.1은 Zod ^3.24.2를 유일한 런타임 의존성으로 사용하며, PaymentRequired, PaymentPayload, PaymentRequirements 등 x402 v2 프로토콜 타입의 Zod 스키마를 공식 제공한다. 이는 WAIaaS의 "Zod SSoT" 원칙과 완벽히 호환되므로, 자체 스키마를 정의하는 대신 @x402/core의 스키마를 import하여 사용한다.

EVM 결제 서명(EIP-3009 TransferWithAuthorization)은 viem 2.x의 `account.signTypedData()` API로 구현 가능하다. 이 API는 이미 설치된 viem의 `privateKeyToAccount`로 생성한 LocalAccount 객체에 내장되어 있으며, EvmAdapter에서 동일 패턴(`privateKeyToAccount`)을 사용 중이다. Solana 부분 서명은 @solana/kit 6.x의 기존 패턴(createNoopSigner + signBytes)을 그대로 활용한다. feePayer를 noopSigner로 지정하면 자연스럽게 부분 서명 트랜잭션이 생성되며, 이 패턴은 SolanaAdapter.buildTransaction()에서 이미 검증됨.

SSRF 보호는 외부 라이브러리(`request-filtering-agent`, `private-ip` 등)가 native fetch와 호환되지 않거나 CVE가 존재하므로, Node.js 내장 `node:dns/promises` + `node:net`으로 직접 구현한다. DNS 사전 해석 방식은 Agent 기반보다 DNS 리바인딩 공격에 더 강건하다.

CAIP-2 네트워크 식별자 매핑은 x402가 사용하는 `eip155:{chainId}` / `solana:{genesisHash}` 형식이 단순하므로 `caip` npm 패키지 없이 상수 테이블로 해결한다. WAIaaS의 13개 NetworkType과 x402 지원 네트워크 10개의 교차점을 완전 매핑했다.

---

## Key Findings

**Stack:** @x402/core v2.3.1 추가 (Zod 스키마). viem signTypedData, @solana/kit signBytes 기존 활용. SSRF는 node:dns 자체 구현. HTTP는 native fetch.

**Architecture:** x402-handler (오케스트레이터) + payment-signer (체인별 서명) + ssrf-guard (URL 검증). 기존 파이프라인 정책 엔진 재사용. IChainAdapter 경유하지 않음.

**Critical pitfall:** SSRF -- 프록시 서비스의 가장 큰 보안 위험. DNS 리바인딩, IPv4-mapped IPv6, 옥탈 인코딩 등 다양한 바이패스 기법에 대한 포괄적 방어 필수.

---

## Implications for Roadmap

연구 결과를 기반으로, 다음 phase 구조를 권장한다:

1. **Phase A: Core 타입 + CAIP-2 매핑 + DB 마이그레이션** -- 기반 타입과 스키마 정립
   - Addresses: @x402/core 의존성 추가, X402FetchRequest/Response 스키마, TransactionType에 X402_PAYMENT 추가, PolicyType에 X402_ALLOWED_DOMAINS 추가, CAIP-2 매핑 테이블, DB 마이그레이션 (CHECK 제약 + 정책 타입)
   - Avoids: 타입 불일치로 인한 후속 phase 재작업

2. **Phase B: SSRF 가드 + x402 핸들러 + 결제 서명** -- 핵심 로직 구현
   - Addresses: ssrf-guard.ts, x402-handler.ts (402 파싱 + 정책 평가 + 재요청), payment-signer.ts (EVM EIP-3009 + Solana TransferChecked)
   - Avoids: SSRF 취약점을 나중에 패치하는 것보다 처음부터 방어 구현

3. **Phase C: REST API + 정책 통합 + 감사 로그** -- API 노출 + 정책 연동
   - Addresses: POST /v1/x402/fetch 엔드포인트, X402_ALLOWED_DOMAINS 정책 평가, SPENDING_LIMIT 통합, transactions 테이블 기록, 알림 연동
   - Avoids: 정책 없는 결제 기능 노출

4. **Phase D: SDK/MCP + E2E 테스트** -- 인터페이스 + 검증
   - Addresses: TS SDK x402Fetch(), Python SDK x402_fetch(), MCP x402_fetch 도구, E2E 테스트 23개 시나리오
   - Avoids: 인터페이스 불일치

**Phase ordering rationale:**
- Phase A가 먼저인 이유: 타입/스키마가 모든 후속 phase의 기반
- Phase B에서 SSRF를 x402 핸들러와 함께 구현하는 이유: 핸들러의 첫 번째 단계가 URL 검증이므로 분리하면 안 됨
- Phase C에서 정책을 분리하는 이유: 핸들러 로직과 정책 통합은 관심사가 다르며, 핸들러가 먼저 동작해야 정책 통합 테스트 가능
- Phase D가 마지막인 이유: API가 완성된 후 SDK/MCP 래핑은 기계적

**Research flags for phases:**
- Phase B: EIP-3009 도메인 파라미터(USDC name/version)가 체인별로 다를 수 있어 구현 시 확인 필요
- Phase B: Solana 부분 서명에서 noopSigner feePayer 슬롯이 올바르게 빈 서명으로 처리되는지 검증 필요
- Phase C: DELAY 티어의 x402 타임아웃 처리 (request_timeout vs 정책 대기시간) 세부 로직 확인 필요

---

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | HIGH | @x402/core npm 확인, package.json 검증, GitHub 소스 확인. viem/solana-kit 기존 사용 패턴 |
| Features | HIGH | x402 스펙 + 기존 WAIaaS 기능(정책, 알림, Kill Switch) 재사용 |
| Architecture | HIGH | x402-handler + payment-signer + ssrf-guard 분리. 기존 파이프라인 정책 재사용 |
| Pitfalls | HIGH | OWASP SSRF 가이드 + SSRF 라이브러리 CVE 분석 + x402 스펙 Edge case |

---

## Gaps to Address

- **EIP-3009 도메인 파라미터**: USDC 컨트랙트의 EIP-712 domain separator가 체인별로 다른 값(name, version)을 사용하는지 구현 시 on-chain 확인 또는 Coinbase 문서에서 확인 필요
- **@x402/svm 버전 차이**: @x402/svm v2.3.0이 @solana/kit ^5.1.0 사용 (WAIaaS는 6.x). x402 SVM 참조 구현 확인 시 API 차이 주의. 직접 사용하지 않으므로 블로커는 아님
- **x402 v2 PaymentPayload issue #577**: PaymentPayload에서 원본 PaymentRequirements 정보가 유실되는 이슈가 open. WAIaaS 구현에서는 자체적으로 PaymentRequirements를 보존해야 함 (감사 로그용)
- **Permit2 지원**: v1.5.1에서는 EIP-3009만 지원. Permit2는 향후 마일스톤에서 추가 연구 필요

---

## Files Created

| File | Purpose |
|------|---------|
| `.planning/research/v1.5.1-x402-client-SUMMARY.md` | 연구 요약 + 로드맵 시사점 |
| `.planning/research/v1.5.1-x402-client-STACK.md` | 기술 스택 상세 분석 (6개 영역) |
| `.planning/research/v1.5.1-x402-client-FEATURES.md` | 기능 목록 (Table Stakes / Differentiators / Anti-Features) |
| `.planning/research/v1.5.1-x402-client-ARCHITECTURE.md` | 아키텍처 패턴 + 컴포넌트 경계 |
| `.planning/research/v1.5.1-x402-client-PITFALLS.md` | 도메인 함정 (SSRF, EIP-3009, 무한 루프 등) |
