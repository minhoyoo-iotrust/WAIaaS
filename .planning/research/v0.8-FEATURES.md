# Feature Landscape: Owner 선택적 등록 + 점진적 보안 모델 (v0.8)

**Domain:** Optional guardian/owner registration and progressive security unlock for AI agent wallet daemon
**Researched:** 2026-02-08
**Overall Confidence:** HIGH (ecosystem patterns well-established, WAIaaS design already detailed)
**Milestone:** v0.8 Owner 선택적 등록 + 점진적 보안 모델

---

## Overview

v0.8은 WAIaaS의 Owner 등록을 필수에서 선택으로 전환하고, Owner 등록 여부에 따라 보안 기능이 점진적으로 해금되는 모델을 설계한다. 이는 크립토 지갑 생태계에서 확립된 "점진적 보안(progressive security)" 패턴과 AI 에이전트 지갑의 "정책 기반 자율성(policy-based autonomy)" 패턴을 결합한 것이다.

**생태계 위치:**
- **Argent Wallet**: 첫 번째 Guardian은 즉시 활성화, 이후 추가는 36시간 딜레이. Guardian 없어도 기본 사용 가능, 추가할수록 보안 강화. WAIaaS v0.8의 가장 직접적인 선례.
- **Safe (Gnosis Safe)**: Owner/Module 기반 선택적 보안 확장. 트랜잭션 가드, 타임락 모듈 등 옵션으로 추가.
- **Coinbase AgentKit**: Owner가 항상 존재 (CDP Smart Wallet), 에이전트에 위임된 권한으로만 동작.
- **ElizaOS**: Guardian/Owner 개념 없음. 에이전트가 키를 직접 보유, 보호 메커니즘 부재.

WAIaaS v0.8은 이 스펙트럼에서 Argent의 점진적 모델을 채택하되, 에이전트 지갑 컨텍스트에 맞게 변형한다: Owner 없이 DELAY까지 자율 운영 가능, Owner 등록 시 APPROVAL 해금 + 자금 회수 + 세션 거부.

---

## 기존 설계와의 관계 (v0.5-v0.7 의존성)

v0.8 기능은 기존 설계 위에 변경/확장을 적용한다:

| 기존 설계 | v0.8 변경 | 영향 |
|-----------|----------|------|
| 3-tier 인증 (v0.5: 52-auth) | ownerAuth를 선택적으로 전환 | masterAuth/sessionAuth는 불변, ownerAuth만 조건부 |
| 4-tier 정책 (v0.5: 33-time-lock) | APPROVAL 다운그레이드 로직 삽입 | evaluate() 11단계 중 9단계 이후 분기 |
| Kill Switch 3-state (v0.7: 36-killswitch) | 복구 시간 Owner 유무 분기 (30min vs 24h) | POST /v1/admin/recover 인증 분기 |
| 세션 갱신 (v0.5: 53-renewal) | Owner 없으면 거부 윈도우 비활성 | 갱신 즉시 확정 vs Owner 거부 가능 |
| IChainAdapter 19메서드 (v0.6-v0.7) | sweepAll 1개 추가 (19->20) | getAssets() + buildBatch() 재사용 |
| agents 테이블 (v0.7: 25-sqlite) | owner_address nullable + owner_verified 추가 | DDL 변경, 인덱스 유지 |
| 알림 아키텍처 (v0.5: 35-notification) | 다운그레이드 알림 + 등록 안내 메시지 | 신규 템플릿, 기존 채널 재사용 |

---

## Table Stakes (필수 기능)

Owner 없는 에이전트와 Owner 있는 에이전트가 모두 정상적으로 동작하기 위해 반드시 구현해야 하는 기능. 하나라도 빠지면 설계 일관성이 깨지거나 보안 허점이 발생한다.

### TS-1: Owner 없는 에이전트 생성 및 운영

**What:** `--owner` 플래그 없이 에이전트를 생성하고, INSTANT/NOTIFY/DELAY 정책 범위 내에서 완전히 동작하는 에이전트.

| Attribute | Value |
|-----------|-------|
| Complexity | Low |
| 기존 의존성 | 25-sqlite (agents 테이블), 28-daemon (CLI), 54-cli-flow |
| Priority | CRITICAL -- 전체 v0.8의 전제 조건 |

**Expected Behavior:**
- `waiaas agent create --name bot --chain solana` -- Owner 없이 즉시 생성
- `agents.owner_address = NULL`, `agents.owner_verified = 0`
- sessionAuth 발급/사용 정상 동작
- masterAuth로 에이전트 관리 (정지, 종료 등) 정상 동작
- `agent info` 출력에서 Owner 미등록 상태와 등록 안내 표시

**Edge Cases:**
- Owner NULL인 에이전트에 ownerAuth 엔드포인트 호출 시 적절한 에러 반환 (404 또는 403)
- 다수 에이전트 중 일부만 Owner 등록된 혼합 상태에서의 쿼리 정확성
- Owner 없는 에이전트의 `--quickstart` 모드: `--chain`만 필수

**Confidence:** HIGH -- SQLite nullable 컬럼과 CLI 플래그 선택화는 표준 패턴

---

### TS-2: APPROVAL 다운그레이드 (Owner 없을 때)

**What:** Owner 없는 에이전트에서 정책 평가 결과가 APPROVAL인 거래를 차단하지 않고 DELAY로 자동 다운그레이드. 에이전트의 자율 운영을 보장하면서 시간 기반 보호를 유지.

| Attribute | Value |
|-----------|-------|
| Complexity | Medium |
| 기존 의존성 | 33-time-lock (evaluate 11단계), 61-price-oracle (USD dual 평가) |
| Priority | CRITICAL -- Owner 없는 에이전트의 고액 거래 처리 전략 |

**Expected Behavior:**
- evaluate() 결과 `{ tier: 'APPROVAL' }` + `agent.owner_address === null` --> `{ tier: 'DELAY', downgraded: true, originalTier: 'APPROVAL' }`
- 다운그레이드 삽입 지점: evaluate() 9단계 (maxTier 산출) 직후
- DELAY 쿨다운 시간은 APPROVAL이 아닌 DELAY 기본값 (15분) 적용
- 다운그레이드된 거래도 일반 DELAY와 동일하게 취소 가능

**Edge Cases:**
- Owner 등록과 APPROVAL 다운그레이드 거래가 동시에 진행되는 경우: 이미 DELAY로 다운그레이드된 거래는 소급 변경하지 않음 (진행 중인 DELAY는 그대로 실행)
- USD 환산 불가 시 (오라클 장애): 네이티브 금액 기준으로만 평가, 다운그레이드 판단은 최종 티어 기준
- APPROVAL 다운그레이드가 연속 발생할 때 rate limiting과의 상호작용: DELAY 큐에 정상 적재

**Confidence:** HIGH -- 패턴 자체는 단순 (조건 분기 + 반환값 변환), 삽입 지점 명확

**Industry Precedent:**
- Argent: Guardian 없을 때 대액 전송을 차단하지 않고 48시간 딜레이 적용 (유사 패턴)
- Safe: 트랜잭션 가드 미설치 시 모든 거래 즉시 실행 (차단 없음)
- WAIaaS 차별점: 다운그레이드 시 "Owner 등록 안내" 알림을 포함하여 자연스러운 업그레이드 유도

---

### TS-3: Owner 주소 등록 (사후 등록)

**What:** 이미 생성된 에이전트에 Owner 주소를 masterAuth만으로 등록하는 기능. 서명 불필요 (주소는 공개 정보).

| Attribute | Value |
|-----------|-------|
| Complexity | Low |
| 기존 의존성 | 52-auth (masterAuth), 34-owner-wallet-connection |
| Priority | CRITICAL -- 점진적 보안의 핵심 전환점 |

**Expected Behavior:**
- `waiaas agent set-owner <agent> <address>` CLI 명령
- API: `PUT /v1/agents/:agentId/owner` (또는 PATCH), 인증: masterAuth
- 주소 형식 검증만 수행: Solana (Base58 32bytes), Ethereum (0x + EIP-55)
- 등록 즉시 `agents.owner_address` 설정, `owner_verified = 0` (유예 구간 진입)
- 등록 즉시 APPROVAL 정책 해금, 자금 회수 가능, 세션 거부 윈도우 활성화

**Edge Cases:**
- 이미 Owner가 있는 에이전트에 `set-owner` 호출: 유예 구간이면 변경 허용, 잠금 구간이면 ownerAuth 필요 에러 반환
- 잘못된 주소 형식: 형식 검증에서 400 반환, 등록 안 됨
- 체인 불일치 (Solana 에이전트에 0x... 주소): 에이전트의 chain 타입과 주소 형식 불일치 시 400 반환
- Owner 등록 직후 즉시 APPROVAL 거래 제출: 정책 엔진이 실시간으로 owner_address 체크하므로 즉시 APPROVAL 동작

**Confidence:** HIGH -- 표준 CRUD + 주소 검증

**Industry Precedent:**
- 지갑 주소를 watchlist에 추가하는 패턴과 유사 (서명 없이 주소만 등록)
- Coinbase AgentKit: Smart Wallet 생성 시 owner 즉시 지정 (사후 변경은 Smart Account의 setOwner)
- Argent: Guardian 추가 시 즉시 효력 (첫 번째) 또는 36시간 딜레이 (이후)

---

### TS-4: Owner 주소 변경 (유예/잠금 2단계)

**What:** Owner 주소 변경 시 ownerAuth 사용 이력(owner_verified)에 따라 인증 요구 수준이 달라지는 2단계 보호. 유예 구간(오타 교정)에서는 masterAuth만, 잠금 구간(검증된 Owner)에서는 ownerAuth + masterAuth 필요.

| Attribute | Value |
|-----------|-------|
| Complexity | Medium |
| 기존 의존성 | 52-auth (masterAuth + ownerAuth), 30-session (SIWS/SIWE) |
| Priority | CRITICAL -- Owner 변경은 최고 위험 조작 |

**Expected Behavior:**
- `owner_verified = 0` (유예): masterAuth만으로 주소 변경/해제 가능
- `owner_verified = 1` (잠금): 기존 Owner의 SIWS/SIWE 서명 + masterAuth 모두 필요
- ownerAuth 첫 사용 시 `owner_verified = 0 -> 1` 자동 전환 (한 번 검증되면 영구)
- 잠금 구간에서 Owner 해제(제거)는 불가 (보안 다운그레이드 방지)

**Edge Cases:**
- 유예 구간에서 masterAuth 유출 시 공격자가 Owner 주소를 변경하는 시나리오: 아직 ownerAuth 미사용 상태이므로 Owner 검증 전 단계. 위험하지만 설계상 허용 (유예 구간의 의도적 trade-off).
- ownerAuth 첫 사용이 "거래 승인"인 경우: 승인 완료 후 owner_verified = 1로 전환. 이후 Owner 변경에 기존 Owner 서명 필요.
- owner_verified가 1인 상태에서 Owner의 개인키 분실: 해당 에이전트의 Owner 변경 불가 (교착). 에이전트 종료 후 새 에이전트 생성이 유일한 해결책.
- 유예 구간 → 잠금 구간 전환 중 동시 변경 요청: DB 트랜잭션으로 owner_verified 체크와 변경을 원자적으로 처리

**Confidence:** HIGH -- Argent의 36시간 딜레이 패턴과 유사한 2단계 모델, 다만 시간 기반이 아닌 "사용 이력" 기반이므로 더 단순

**Industry Precedent:**
- Argent: Guardian 변경에 36시간 딜레이 (시간 기반 보호)
- Safe: Owner 추가/제거에 기존 Owner의 m-of-n 서명 필요 (다중 서명 보호)
- ERC-4337 Social Recovery: Guardian 교체에 기존 Guardian 과반수 승인 + 시간 딜레이
- Bybit 해킹 (2025): 타임락 없이 즉시 Owner 변경이 가능했던 것이 $1.4B 피해의 핵심 원인

**주요 교훈 (Cantina 보안 연구):**
- Guardian rotation 공격: 타임락 또는 기존 Guardian 승인 없이 Guardian을 교체하면 즉시 자금 탈취 가능
- WAIaaS의 owner_verified 2단계 모델은 이 공격을 방어: 잠금 구간에서는 기존 Owner 서명 없이 변경 불가

---

### TS-5: 자금 회수 (sweepAll)

**What:** Owner가 등록된 에이전트의 모든 자산(네이티브 + SPL 토큰 + rent)을 owner_address로 전량 회수하는 기능. 수신 주소가 owner_address로 고정되므로 masterAuth만으로 안전.

| Attribute | Value |
|-----------|-------|
| Complexity | High |
| 기존 의존성 | 27-chain-adapter (IChainAdapter), 57-asset-query (getAssets), 60-batch (buildBatch) |
| Priority | CRITICAL -- Owner 등록의 핵심 가치 제안 |

**Expected Behavior:**
- `POST /v1/owner/agents/:agentId/withdraw` -- 인증: masterAuth
- scope: "native" (네이티브만) 또는 "all" (토큰 포함 전량)
- 수신 주소: `agents.owner_address` 고정 (요청에 주소 포함 안 됨)
- HTTP 200 (전량 회수) / 207 (부분 회수, failed 배열 비어있지 않음) / 404 (에이전트/Owner 미등록)
- 정책 엔진 우회 (회수는 Owner 의도적 행위)

**Solana sweep 실행 순서:**
1. `getAssets(address)` -- 보유 자산 전수 조사
2. 토큰별 `transfer + closeAccount` -- buildBatch()로 원자적 배치 (min 2 / max 20 instruction per batch)
3. 배치 실패 시 개별 토큰 fallback (partial sweep 허용)
4. 네이티브 SOL 전량 전송 (잔액 - tx fee) -- 마지막 tx

**Edge Cases:**
- **Frozen 토큰 계정**: SPL Token 프로그램에서 freeze_authority가 계정을 동결한 경우, transfer 불가. failed 배열에 포함하고 나머지 진행 (partial sweep).
- **Token-2022 확장 토큰**: permanent_delegate가 설정된 토큰은 delegate가 회수 가능하지만, WAIaaS는 agent 키로만 서명하므로 delegate 권한 없으면 failed.
- **0 잔액 토큰 계정**: balance 0이지만 계정은 존재. closeAccount로 rent만 회수.
- **closeAccount 권한**: agent의 키가 토큰 계정 owner여야 함. 제3자가 생성한 토큰 계정이면 close 불가.
- **SOL 전량 전송 시 수수료 계산**: 마지막 tx에서 fee를 차감해야 하므로, fee estimation 후 `balance - estimatedFee` 전송. fee 추정 오차 발생 시 재시도.
- **Kill Switch ACTIVATED 상태에서의 회수**: killSwitchGuard 허용 목록에 withdraw 추가 또는 데몬 내부 직접 실행 (v0.8 objective에서 "구현 시 결정"으로 남겨둠).
- **동시 트랜잭션 진행 중 회수**: DELAY 대기 중인 거래가 있을 때 sweep 실행 시 잔액 경합. sweep 전 pending 거래 취소 또는 경고.
- **EVM sweep**: ERC-20은 approve 없이 직접 transfer. 단, gas 토큰(ETH) 잔액으로 gas 지불 후 나머지 전송.

**Confidence:** HIGH (getAssets + buildBatch 재사용), MEDIUM (frozen 토큰, Token-2022 엣지 케이스는 구현 시 검증 필요)

**Industry Precedent:**
- Coinbase Asset Recovery Tool: Solana SPL 토큰 자동 복구 (2025 출시)
- Sol Asset Recovery: 해킹된 지갑에서 자산 이동 도구
- Solana closeAccount: 토큰 잔액 0이어야 close 가능 (transfer 선행 필수)

---

### TS-6: Kill Switch 복구 Owner 유무 분기

**What:** Kill Switch 복구 시 Owner 유무에 따라 인증 요건과 대기 시간을 분기. Owner 있으면 30분(이중 인증), Owner 없으면 24시간(시간으로 보상).

| Attribute | Value |
|-----------|-------|
| Complexity | Low-Medium |
| 기존 의존성 | 36-killswitch (3-state, POST /v1/admin/recover) |
| Priority | HIGH -- 보안 일관성 |

**Expected Behavior:**
- Owner 없음: `POST /v1/admin/recover` + masterAuth + 24시간 강제 대기
- Owner 있음: `POST /v1/admin/recover` + ownerAuth + masterAuth + 30분 대기
- 발동은 masterAuth 또는 ownerAuth (Owner 있을 때)

**Edge Cases:**
- Kill Switch 상태에서 Owner를 등록하려는 경우: killSwitchGuard가 대부분 API를 차단하므로, set-owner도 차단되어야 함 (ACTIVATED 상태에서 보안 설정 변경 불가)
- 24시간 대기 중 Owner를 등록한 경우 (killSwitchGuard 우회 불가하므로 사실상 불가능): 설계상 불가능한 경로이지만, 방어적으로 복구 시작 시 owner_address snapshot을 기록하고 그 기준으로 인증
- Owner 있는 에이전트에서 ownerAuth 없이 masterAuth만으로 복구 시도: 거부 (Owner 있으면 반드시 이중 인증)

**Confidence:** HIGH -- 단순 조건 분기, 기존 recover 엔드포인트에 인증 로직만 추가

**Industry Precedent:**
- Argent: 지갑 잠금 후 5일 보안 기간 (Guardian 복구)
- Unleash Protocol 해킹 (2025): 타임락 없이 즉시 실행되어 $3.9M 피해. WAIaaS의 24시간/30분 대기는 이 공격 차단

---

### TS-7: 세션 갱신 Owner 유무 분기

**What:** 세션 갱신 시 Owner 없으면 거부 윈도우 없이 즉시 확정, Owner 있으면 기본 1시간 거부 윈도우 활성화.

| Attribute | Value |
|-----------|-------|
| Complexity | Low |
| 기존 의존성 | 53-session-renewal (낙관적 갱신 프로토콜) |
| Priority | HIGH -- 세션 보안 일관성 |

**Expected Behavior:**
- Owner 없음: 갱신 요청 -> 즉시 확정 (거부자 없음), 알림 "세션 갱신됨 (3/30)"
- Owner 있음: 갱신 요청 -> 확정 + 알림 "세션 갱신됨 (3/30)" + [거부하기] 버튼
- maxRenewals, 30일 총 수명 상한 등 안전 장치는 Owner 유무 무관 동일 적용

**Edge Cases:**
- Owner 등록 직후 세션 갱신: 실시간 owner_address 체크, 등록 즉시 거부 윈도우 활성화
- 거부 윈도우 내 Owner가 해제된 경우 (유예 구간에서만 가능): 해제 시점에 활성 거부 윈도우 자동 만료 처리

**Confidence:** HIGH -- 단순 조건 분기

---

### TS-8: 다운그레이드 알림 + Owner 등록 안내

**What:** APPROVAL -> DELAY 다운그레이드 발생 시 알림에 Owner 등록 안내 메시지를 포함. 자연스러운 보안 업그레이드 유도.

| Attribute | Value |
|-----------|-------|
| Complexity | Low |
| 기존 의존성 | 35-notification (INotificationChannel, 13 이벤트) |
| Priority | HIGH -- 점진적 보안의 UX 전환점 |

**Expected Behavior:**
- `downgraded: true` 플래그가 있으면 알림 메시지에 등록 안내 포함
- 안내 내용: CLI 명령어 (`waiaas agent set-owner <agent> <address>`)
- Telegram: 인라인 메시지로 안내, Discord/ntfy.sh: 텍스트 메시지

**Edge Cases:**
- 다운그레이드 알림이 빈번하게 발생하는 경우 (매번 동일 안내): 알림 피로. 일정 횟수 이후 안내 메시지 생략 또는 빈도 제한 고려.
- 알림 채널이 미설정된 경우: 다운그레이드 자체는 정상 동작, 안내만 전달 불가

**Confidence:** HIGH -- 기존 알림 아키텍처에 템플릿 추가

---

## Differentiators (차별화 기능)

경쟁 제품과 차별화되는 기능. 기대하지 않지만 있으면 가치가 높은 기능.

### DF-1: 유예/잠금 2단계 Owner 생명주기

**What:** Owner 주소의 변경 난이도를 "ownerAuth 사용 이력"에 따라 동적으로 조절하는 2단계 모델. 기존 지갑 생태계의 "시간 기반 딜레이"와 달리 "행동 기반 전환"을 채택.

| Attribute | Value |
|-----------|-------|
| Complexity | Medium |
| Value Proposition | 보안과 DX의 동시 최적화 -- 오타 교정은 쉽게, 검증된 Owner 보호는 강하게 |
| Competitive Advantage | Argent(시간 딜레이), Safe(m-of-n 서명)와 다른 제3의 접근 |

**Why Differentiating:**
- Argent: 첫 Guardian 즉시, 이후 36시간 딜레이 (시간 기반). "왜 36시간인가?"에 대한 논리적 근거가 약함.
- Safe: 모든 Owner 변경에 m-of-n 서명 필요 (일률적 높은 보안). 초기 설정 단계에서도 불편.
- WAIaaS: "한 번이라도 서명으로 검증한 Owner"는 강하게 보호, "아직 검증 안 된 주소"는 오타 교정 수준으로 유연. 보안 수준이 실제 사용 패턴과 연동.

**Edge Cases (TS-4에서 상세 기술):** 위 TS-4 참조

**Confidence:** HIGH -- 개념적으로 단순하고 구현 복잡도 낮음

---

### DF-2: APPROVAL 다운그레이드 + 자연스러운 업그레이드 유도

**What:** APPROVAL을 차단이 아닌 DELAY 다운그레이드로 처리하면서, 알림에 Owner 등록 안내를 포함하여 "강제 없는 보안 강화"를 유도하는 패턴.

| Attribute | Value |
|-----------|-------|
| Complexity | Low-Medium |
| Value Proposition | ElizaOS(보호 없음)과 Coinbase(항상 통제) 사이의 유일한 점진적 위치 |
| Competitive Advantage | 에이전트 자율성을 유지하면서 보안 업그레이드를 자연스럽게 유도 |

**Why Differentiating:**
- ElizaOS: 보호 메커니즘 없음. 에이전트가 무제한 거래.
- Coinbase AgentKit: Owner가 항상 존재하므로 "Owner 없음" 상태 자체가 불가.
- WAIaaS: Owner 없어도 DELAY로 시간 보호 적용, 알림으로 Owner 등록을 안내하되 강제하지 않음. 개발자의 여정을 존중하는 "nudge" 패턴.

**Industry Insight:**
- a16z 핀테크 뉴스레터 (2025.05): "에이전트에 지갑을 부여하는 것은 쉽지만, 지출 한도와 승인 워크플로우를 정의하는 표준이 아직 없다." WAIaaS의 4-tier 정책 + 다운그레이드는 이 공백을 채우는 구체적 구현.
- Google Agent Payments Protocol (AP2, 2025.09): "위임된 권한 + 한도"를 표준화하려는 시도. WAIaaS의 정책 엔진이 이 방향과 일치.

**Confidence:** HIGH -- 설계 이미 상세 확정 (v0.8 objective 3)

---

### DF-3: Owner 유무별 Kill Switch 시간 보상

**What:** Owner가 없어서 이중 인증이 불가능한 경우, 복구 대기 시간을 24시간으로 늘려 "시간으로 보안을 보상"하는 모델.

| Attribute | Value |
|-----------|-------|
| Complexity | Low |
| Value Proposition | 이중 인증 부재를 시간으로 대체하는 참신한 보안 모델 |
| Competitive Advantage | 대부분의 지갑은 Kill Switch/긴급 정지 후 고정 복구 시간만 제공 |

**Why Differentiating:**
- 일반 지갑: 복구 시간이 고정 (Argent: 5일, Safe: 트랜잭션 즉시)
- WAIaaS: 보안 수준(Owner 유무)에 따라 복구 시간 동적 조절. 더 높은 보안 = 더 빠른 복구.
- Unleash Protocol 해킹 사례: 타임락 없는 즉시 실행이 $3.9M 피해. 시간 딜레이의 가치를 입증.

**Confidence:** HIGH

---

### DF-4: 자금 회수의 목적지 고정 보안

**What:** withdraw API의 수신 주소를 `agents.owner_address`로 고정하여, masterAuth 유출 시에도 자금이 Owner에게만 이동하는 구조적 안전 장치.

| Attribute | Value |
|-----------|-------|
| Complexity | Low (구현 자체), High (보안 설계 가치) |
| Value Proposition | "masterAuth만으로 안전한 회수" -- 편의성과 보안의 동시 달성 |
| Competitive Advantage | 대부분의 withdraw/sweep 기능은 임의 주소 지정 가능 (공격 표면) |

**Why Differentiating:**
- 일반 패턴: withdraw(to: address) -- 임의 주소 지정 가능, masterAuth 유출 시 공격자 주소로 회수 가능
- WAIaaS: withdraw() -- 수신 주소가 owner_address 고정. masterAuth 유출 -> withdraw 호출 -> 자금 -> Owner 지갑 (공격자 이득 없음)
- 잠금 구간에서 주소 변경에 ownerAuth 필요하므로 "주소 변경 -> withdraw" 공격도 차단

**Confidence:** HIGH

---

## Anti-Features (의도적 비구현)

의도적으로 구현하지 않는 기능. 이 도메인에서 흔한 실수 또는 복잡성 함정.

### AF-1: 다중 Owner (Multi-Guardian)

**What to Avoid:** 에이전트당 여러 Owner를 등록하고 m-of-n 승인을 구현하는 것.

| Why Avoid | Complexity 폭발, 에이전트 지갑의 유스케이스에 비해 과도 |
|-----------|------|
| What to Do Instead | 에이전트당 Owner 1명. 팀 운영이 필요하면 Owner 주소를 multi-sig 지갑(Safe 등)으로 설정 |

**Rationale:**
- Safe/Argent의 multi-guardian은 "사람이 직접 사용하는 지갑"을 위한 설계. AI 에이전트 지갑은 "에이전트 1개 = 관리자 1명"이 자연스러운 모델.
- Multi-guardian 구현 시 quorum 변경, Guardian 리스트 관리, 투표 메커니즘, 타임아웃 처리 등 복잡성이 기하급수적 증가.
- 에이전트별 Owner 1명이면 권한 체계가 명확하고 구현/테스트가 단순.
- 필요 시 Owner 주소를 multi-sig 지갑으로 설정하면 multi-guardian과 동일한 효과를 외부에서 달성.

**Confidence:** HIGH -- 의도적 범위 제한

---

### AF-2: Owner 없는 에이전트의 APPROVAL 차단

**What to Avoid:** Owner 없는 에이전트에서 APPROVAL 티어 거래를 아예 거부(reject)하는 것.

| Why Avoid | 에이전트 자율 운영을 불필요하게 제한, "Owner를 강제하는" 설계로 회귀 |
|-----------|------|
| What to Do Instead | DELAY로 다운그레이드하여 시간 보호 유지 + Owner 등록 안내 |

**Rationale:**
- ElizaOS 사용자들이 WAIaaS로 이동할 때, "이전에 되던 거래가 안 된다"는 경험이 되면 채택 장벽.
- DELAY 다운그레이드는 완전 차단보다 낫다: 15분 쿨다운 + 알림 + 취소 기회 제공.
- Argent도 Guardian 없을 때 대액 전송을 차단하지 않고 딜레이로 처리.

**Confidence:** HIGH -- v0.8 objective에서 이미 확정

---

### AF-3: Owner 등록 시 서명 요구

**What to Avoid:** Owner 주소 등록 시 해당 주소의 SIWS/SIWE 서명을 요구하는 것.

| Why Avoid | 온보딩 마찰 극대화. "주소만 등록"하려면 Owner 지갑을 연결해야 하는 역설적 UX |
|-----------|------|
| What to Do Instead | 등록은 masterAuth만으로 (주소는 공개 정보), 서명 검증은 ownerAuth 첫 사용 시점에 수행 |

**Rationale:**
- 주소는 블록체인 상 공개 정보. "이 주소의 Owner다"라는 주장은 등록 시 검증할 필요 없음.
- 서명 검증이 필요한 시점은 "이 주소의 Owner로서 권한을 행사할 때" (거래 승인, 회수 등).
- 유예/잠금 2단계 모델이 이 gap을 보완: 서명 전에는 주소 변경이 쉽고 (오타 교정), 서명 후에는 보호 강화.
- Argent의 Guardian 추가도 서명 없이 주소/디바이스만 지정 (활성화 딜레이로 보호).

**Confidence:** HIGH -- v0.8 objective 핵심 원칙 3에서 확정

---

### AF-4: 잠금 구간에서 Owner 해제(제거)

**What to Avoid:** ownerAuth로 검증된 Owner를 masterAuth만으로 제거할 수 있게 하는 것.

| Why Avoid | 보안 다운그레이드 공격의 핵심 경로. masterAuth 유출 시 Owner 제거 -> APPROVAL 무력화 -> 대액 거래 자유 |
|-----------|------|
| What to Do Instead | 잠금 구간에서 Owner 해제 자체를 불가능하게 설계. Owner 변경(다른 주소로)은 기존 Owner 서명 + masterAuth로 가능 |

**Rationale:**
- Bybit 해킹 (2025.02): Owner 변경이 multi-sig 서명만으로 가능했고, 타임락 없이 즉시 실행되어 $1.4B 피해.
- WAIaaS의 잠금 구간 해제 불가는 이 공격 벡터를 구조적으로 차단.
- "Owner를 제거하고 싶다" = "Owner를 변경한 후 새 Owner가 해제를 승인"과 논리적으로 동치. 별도 해제 경로 불필요.
- Cantina 보안 연구: "타임락이나 meta-approval 없는 Guardian 업데이트는 가장 위험한 공격 벡터."

**Confidence:** HIGH -- v0.8 objective 4.4에서 확정

---

### AF-5: Owner 등록 시간 기반 딜레이

**What to Avoid:** Argent처럼 Owner 등록/변경에 시간 기반 딜레이(36시간, 48시간 등)를 도입하는 것.

| Why Avoid | 에이전트 지갑 컨텍스트에서 불필요한 마찰. 에이전트는 Owner 등록 직후 APPROVAL 해금을 즉시 기대 |
|-----------|------|
| What to Do Instead | 등록은 즉시 효력, 보호는 owner_verified(행동 기반)로 점진적 강화 |

**Rationale:**
- Argent의 36시간 딜레이는 "사용자 지갑"에서 "실수로 악성 Guardian 추가"를 방지하기 위한 것. AI 에이전트 지갑에서 Owner는 개발자/운영자가 의도적으로 설정하는 것이므로 딜레이가 불필요.
- 등록 즉시 APPROVAL 해금이 WAIaaS의 DX 핵심 약속. 딜레이 도입은 이를 위반.
- owner_verified 2단계 모델이 딜레이 없이도 동등한 보안 제공: 검증 전에는 변경이 쉽고 (오타 교정), 검증 후에는 변경이 어려움.

**Confidence:** HIGH -- v0.8 objective와 일관

---

### AF-6: Kill Switch 상태에서 보안 설정 변경 허용

**What to Avoid:** Kill Switch ACTIVATED 상태에서 Owner 등록/변경/해제를 허용하는 것.

| Why Avoid | 긴급 정지 상태에서 보안 구성을 변경하면 "정지 후 탈취" 공격 가능 |
|-----------|------|
| What to Do Instead | killSwitchGuard가 차단하는 경로에 owner 관련 엔드포인트도 포함 |

**Rationale:**
- Kill Switch ACTIVATED는 "뭔가 잘못되었다"는 신호. 이 상태에서 Owner를 변경할 수 있으면 공격자가 Kill Switch를 발동한 후 Owner를 교체하고 복구할 수 있음.
- 복구 경로 (POST /v1/admin/recover)만 허용하고, 나머지 보안 설정 변경은 복구 완료 후에만 가능.

**Confidence:** HIGH

---

## Feature Dependencies

```
TS-1 (Owner 없는 에이전트 생성)
  |
  +---> TS-2 (APPROVAL 다운그레이드) -- requires: owner_address NULL 체크
  |       |
  |       +---> TS-8 (다운그레이드 알림) -- requires: downgraded 플래그
  |
  +---> TS-3 (Owner 등록) -- requires: 기존 에이전트에 owner_address 추가
  |       |
  |       +---> TS-4 (Owner 변경) -- requires: owner_verified 2단계
  |       |
  |       +---> TS-5 (자금 회수) -- requires: owner_address 존재 + sweepAll
  |       |
  |       +---> TS-6 (Kill Switch 분기) -- requires: owner_address 존재 여부
  |       |
  |       +---> TS-7 (세션 갱신 분기) -- requires: owner_address 존재 여부
  |
  (DF-1, DF-2, DF-3, DF-4 are aspects of TS features, not separate implementations)
```

**핵심 의존 순서:**
1. TS-1이 모든 것의 전제 (DDL 변경, CLI 변경)
2. TS-2와 TS-3은 병렬 진행 가능 (TS-1 완료 후)
3. TS-4/5/6/7은 TS-3 완료 후 (Owner 등록 기능 필요)
4. TS-8은 TS-2 완료 후 (다운그레이드 플래그 필요)
5. TS-5 (sweepAll)은 가장 복잡하므로 마지막 구현 권장

---

## MVP Recommendation

v0.8은 "설계 마일스톤"이므로 코드 구현이 아닌 설계 문서 수정이 산출물이다. 그러나 향후 구현 마일스톤 (v1.2)에서의 구현 우선순위를 권장한다:

**Phase 1 (즉시 필요):**
1. TS-1: agents 테이블 DDL 변경 (owner_address nullable + owner_verified)
2. TS-2: APPROVAL 다운그레이드 로직 (evaluate 1줄 조건문)
3. TS-3: set-owner CLI/API 엔드포인트

**Phase 2 (Owner 등록 후 기능):**
4. TS-4: Owner 변경/해제 유예/잠금 2단계
5. TS-6: Kill Switch 복구 분기
6. TS-7: 세션 갱신 분기

**Phase 3 (복잡 기능):**
7. TS-5: sweepAll 구현 (가장 높은 구현 복잡도)
8. TS-8: 다운그레이드 알림 템플릿

**Defer to post-v0.8:**
- Multi-Owner (AF-1): 의도적 비구현
- Owner 등록 딜레이 (AF-5): 불필요
- Kill Switch 상태에서 보안 변경 (AF-6): killSwitchGuard 기존 로직으로 자연스럽게 차단

---

## Complexity Summary

| Feature | ID | Complexity | 기존 코드 변경 | 신규 코드 | 설계 문서 영향 |
|---------|-----|-----------|:-------------:|:---------:|:-------------:|
| Owner 없는 에이전트 | TS-1 | Low | DDL + CLI | 최소 | 3개 (25, 28, 54) |
| APPROVAL 다운그레이드 | TS-2 | Medium | evaluate() | 조건 분기 | 2개 (33, 61) |
| Owner 등록 | TS-3 | Low | CRUD | API 엔드포인트 | 3개 (34, 37, 54) |
| Owner 변경 2단계 | TS-4 | Medium | 인증 로직 | 상태 전환 | 2개 (34, 52) |
| 자금 회수 sweepAll | TS-5 | High | IChainAdapter | sweepAll 메서드 | 4개 (27, 31, 37, 57) |
| Kill Switch 분기 | TS-6 | Low-Med | recover 인증 | 조건 분기 | 1개 (36) |
| 세션 갱신 분기 | TS-7 | Low | 갱신 로직 | 조건 분기 | 1개 (53) |
| 다운그레이드 알림 | TS-8 | Low | 알림 템플릿 | 메시지 | 2개 (35, 40) |

**총 영향 설계 문서: 14개** (v0.8 objective에서 식별한 수와 일치)

---

## Sources

### HIGH Confidence (공식 문서 + 프로젝트 내부)
- WAIaaS v0.8 objective 문서 (`objectives/v0.8-optional-owner-progressive-security.md`)
- WAIaaS v1.0 구현 계획 (`objectives/v1.0-implementation-planning.md`)
- Solana Token Program - [Close Account](https://solana.com/docs/tokens/basics/close-account)

### MEDIUM Confidence (WebSearch + 공식 소스 교차 검증)
- [Argent Guardian Model](https://www.ready.co/blog/a-new-era-for-crypto-security) -- 36시간 딜레이, 첫 Guardian 즉시, 잠금/복구
- [Argent Guardian 추가](https://support.argent.xyz/hc/en-us/articles/360008013258-How-to-add-a-guardian) -- 36시간 딜레이 확인
- [Cantina: Smart Wallet Recovery Attack Paths](https://cantina.xyz/blog/smart-wallet-social-recovery-risks) -- Guardian rotation 공격, 리스트 조작
- [Safe Multisig Best Practices](https://frameworks.securityalliance.org/wallet-security/secure-multisig-best-practices/) -- 타임락, Owner 관리
- [Coinbase AgentKit](https://docs.cdp.coinbase.com/agent-kit/welcome) -- Owner 기반 Smart Wallet
- [ERC-4337 Account Abstraction](https://hacken.io/discover/erc-4337-account-abstraction/) -- Social Recovery, Guardian 시스템
- [Social Recovery Wallets](https://university.mitosis.org/intro-to-social-recovery-wallets-safe-argent-and-erc-4337/) -- Safe, Argent, ERC-4337 비교
- [a16z Agent Payments](https://a16z.com/newsletter/agent-payments-stack/) -- 에이전트 지갑 지출 한도, 승인 워크플로우 미해결
- [Coinbase Asset Recovery for Solana](https://cryptoslate.com/coinbase-launches-asset-recovery-tool-for-lost-solana-tokens/)

### LOW Confidence (WebSearch only, 추가 검증 필요)
- [Bybit 해킹 분석](https://mamk13.medium.com/top-blockchain-security-breaches-of-2025-a-year-end-post-mortem-new-years-lessons-babb33f97a95) -- Owner 변경 공격 $1.4B
- [Unleash Protocol 해킹](https://mamk13.medium.com/top-blockchain-security-breaches-of-2025-a-year-end-post-mortem-new-years-lessons-babb33f97a95) -- 타임락 부재 $3.9M
- [Solana Phishing - Owner Permission Alteration](https://slowmist.medium.com/beware-of-solana-phishing-attacks-wallet-owner-permissions-may-be-altered-708bbb30518e) -- Solana Owner 권한 변조 피싱
- [Vitalik: Social Recovery Wallets](https://vitalik.ca/general/2021/01/11/recovery.html) -- 2021년 글이지만 Guardian 모델의 원형 설명
