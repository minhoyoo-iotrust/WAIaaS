---
phase: 10-v01-잔재-정리
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/42-interface-mapping.md
  - .planning/deliverables/43-error-code-mapping.md
  - .planning/deliverables/44-escalation-mapping.md
autonomous: true

must_haves:
  truths:
    - "IBlockchainAdapter -> IChainAdapter 변경 대응표가 모든 메서드를 매핑함"
    - "RFC 9457 46개 에러 코드 -> v0.2 36개 에러 코드 매핑이 완료됨"
    - "4단계 에스컬레이션 -> 4-tier 정책 대응이 명시됨"
    - "구현자가 v0.1 용어를 v0.2 용어로 변환할 수 있음"
  artifacts:
    - path: ".planning/deliverables/42-interface-mapping.md"
      provides: "인터페이스명 대응표"
      contains: "IBlockchainAdapter"
    - path: ".planning/deliverables/43-error-code-mapping.md"
      provides: "에러 코드 대응표"
      contains: "RFC 9457"
    - path: ".planning/deliverables/44-escalation-mapping.md"
      provides: "에스컬레이션 대응표"
      contains: "4-tier"
  key_links:
    - from: ".planning/deliverables/42-interface-mapping.md"
      to: ".planning/deliverables/27-chain-adapter-interface.md"
      via: "IChainAdapter 정의 참조"
      pattern: "27-chain-adapter"
    - from: ".planning/deliverables/43-error-code-mapping.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "v0.2 에러 코드 정의 참조"
      pattern: "37-rest-api"
---

<objective>
IBlockchainAdapter -> IChainAdapter 인터페이스 대응표, RFC 9457 에러 코드 매핑, 4단계 에스컬레이션 -> 4-tier 정책 대응표를 작성한다.

Purpose: v0.1 용어와 v0.2 용어 간 명시적 매핑을 제공하여 구현자의 혼란을 방지하고, 레거시 참조를 올바르게 변환할 수 있게 한다.
Output: 42-interface-mapping.md, 43-error-code-mapping.md, 44-escalation-mapping.md (3개 대응표 문서)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/10-v01-잔재-정리/10-RESEARCH.md
@.planning/deliverables/12-multichain-extension.md
@.planning/deliverables/27-chain-adapter-interface.md
@.planning/deliverables/20-error-codes.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/19-permission-policy-model.md
@.planning/deliverables/33-time-lock-approval-mechanism.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: IBlockchainAdapter -> IChainAdapter 인터페이스 대응표 작성</name>
  <files>.planning/deliverables/42-interface-mapping.md</files>
  <action>
  RESEARCH.md의 "인터페이스명 대응표 패턴"과 12-multichain-extension.md, 27-chain-adapter-interface.md를 기반으로 인터페이스 대응표 작성:

  1. 프론트매터:
     ```markdown
     # IBlockchainAdapter -> IChainAdapter 변경 대응표 (LEGACY-06, LEGACY-07)

     **작성일:** 2026-02-06
     **버전:** 1.0
     **문서 ID:** MAP-02
     **관련 요구사항:** LEGACY-06 (H1 인터페이스명), LEGACY-07 (H10 Squads 메서드)
     ```

  2. 개요:
     - v0.1의 IBlockchainAdapter는 Squads Protocol 기반 멀티시그 지갑 운영을 가정
     - v0.2의 IChainAdapter는 Self-Hosted 로컬 키스토어 기반
     - 주요 변경: 온체인 멀티시그 -> 오프체인 로컬 정책

  3. 인터페이스명 변경:
     | v0.1 | v0.2 | 변경 유형 |
     |------|------|-----------|
     | `IBlockchainAdapter` | `IChainAdapter` | 이름 변경 |

  4. 메서드 대응표 (상세):
     | v0.1 메서드 (12-multichain-extension.md) | v0.2 메서드 (27-chain-adapter-interface.md) | 변경 유형 | 비고 |
     |------------------------------------------|---------------------------------------------|-----------|------|
     | `getChainId(): string` | `readonly chain: ChainType` | 타입 강화 | 리터럴 타입으로 변경 |
     | `getNetwork(): string` | `readonly network: NetworkType` | 타입 강화 | 리터럴 타입으로 변경 |
     | `createSmartWallet(owner, agents, threshold)` | **제거** | Squads 제거 | 로컬 키스토어로 대체 |
     | `addMember(walletAddress, member)` | **제거** | Squads 제거 | - |
     | `removeMember(walletAddress, member)` | **제거** | Squads 제거 | - |
     | `updateWalletConfig(walletAddress, config)` | **제거** | Squads 제거 | 로컬 정책 엔진으로 대체 |
     | `getBalance(address)` | `getBalance(address): Promise<BalanceInfo>` | 유지 | 반환 타입 확장 |
     | `buildTransaction(from, to, amount)` | `buildTransaction(params): Promise<UnsignedTransaction>` | 확장 | params 객체화 |
     | `signTransaction(tx, privateKey)` | `signTransaction(unsignedTx): Promise<SignedTransaction>` | 변경 | 키스토어 내부 서명 |
     | `sendTransaction(signedTx)` | `submitTransaction(signedTx): Promise<TransactionResult>` | 이름 변경 | - |
     | `getTransactionStatus(txHash)` | `getTransaction(txHash): Promise<TransactionInfo \| null>` | 확장 | 상세 정보 반환 |
     | `healthCheck(): boolean` | `getHealth(): Promise<{healthy, latency}>` | 확장 | latency 추가 |
     | - | `connect(): Promise<void>` | **신규** | RPC 연결 관리 |
     | - | `disconnect(): Promise<void>` | **신규** | RPC 연결 해제 |
     | - | `simulate(unsignedTx): Promise<SimulationResult>` | **신규** | 트랜잭션 시뮬레이션 |
     | - | `waitForConfirmation(txHash, timeout): Promise<TransactionInfo>` | **신규** | 확인 대기 |
     | - | `estimateFee(unsignedTx): Promise<FeeEstimate>` | **신규** | 수수료 추정 |

  5. Squads 관련 제거된 메서드 정리 (LEGACY-07):
     - `createSmartWallet()`: Squads Vault 생성 -> 로컬 키 생성으로 대체
     - `addMember()`: 멀티시그 멤버 추가 -> v0.2에서 미사용
     - `removeMember()`: 멀티시그 멤버 제거 -> v0.2에서 미사용
     - `updateWalletConfig()`: 임계값/정책 변경 -> DatabasePolicyEngine으로 대체

  6. 마이그레이션 가이드:
     - v0.1 코드에서 IBlockchainAdapter 사용 시 -> IChainAdapter로 변경
     - Squads 관련 메서드 호출 -> 제거 (로컬 정책 엔진 사용)
     - signTransaction에 privateKey 전달 -> 키스토어 내부 처리
  </action>
  <verify>
  ```bash
  # 문서 존재 확인
  test -f .planning/deliverables/42-interface-mapping.md && echo "PASS: 인터페이스 대응표 생성됨"

  # IBlockchainAdapter, IChainAdapter 모두 언급 확인
  grep -c "IBlockchainAdapter\|IChainAdapter" .planning/deliverables/42-interface-mapping.md
  # 예상: 10 이상

  # Squads 제거 메서드 언급 확인
  grep -c "createSmartWallet\|addMember\|removeMember\|updateWalletConfig" .planning/deliverables/42-interface-mapping.md
  # 예상: 4 이상
  ```
  </verify>
  <done>
  - 42-interface-mapping.md 파일이 존재함
  - IBlockchainAdapter의 모든 메서드가 IChainAdapter와 매핑됨
  - Squads 관련 4개 메서드가 "제거"로 표시됨
  - v0.2 신규 메서드 5개가 명시됨
  </done>
</task>

<task type="auto">
  <name>Task 2: RFC 9457 에러 코드 -> v0.2 에러 코드 매핑 작성</name>
  <files>.planning/deliverables/43-error-code-mapping.md</files>
  <action>
  RESEARCH.md의 "에러 코드 대응표 패턴"과 20-error-codes.md, 37-rest-api-complete-spec.md를 기반으로 에러 코드 대응표 작성:

  1. 프론트매터:
     ```markdown
     # RFC 9457 에러 코드 -> v0.2 7-domain 에러 코드 매핑 (LEGACY-08)

     **작성일:** 2026-02-06
     **버전:** 1.0
     **문서 ID:** MAP-03
     **관련 요구사항:** LEGACY-08 (H11 에러 코드 체계)
     ```

  2. 개요:
     - v0.1: RFC 9457 Problem Details 기반 46개 에러 코드
     - v0.2: 7-domain 기반 36개 에러 코드
     - 변경 이유: Self-Hosted 모델에서 불필요한 코드 제거, 도메인 기반 분류로 단순화

  3. 도메인 체계 비교:
     | v0.1 분류 | v0.2 도메인 | 코드 범위 |
     |----------|------------|-----------|
     | Authentication | AUTH | AUTH_001 ~ AUTH_006 |
     | Session | SESSION | SESSION_001 ~ SESSION_005 |
     | Agent | AGENT | AGENT_001 ~ AGENT_004 |
     | Transaction | TRANSACTION | TX_001 ~ TX_008 |
     | Policy | POLICY | POLICY_001 ~ POLICY_004 |
     | Chain | CHAIN | CHAIN_001 ~ CHAIN_005 |
     | System | SYSTEM | SYS_001 ~ SYS_004 |

  4. 삭제된 코드 (v0.1 only) - Squads/Enclave/Cloud 관련:
     | v0.1 코드 | HTTP | 삭제 이유 |
     |-----------|------|-----------|
     | `SQUADS_THRESHOLD_NOT_MET` | 403 | Squads 미사용 |
     | `SQUADS_MEMBER_NOT_FOUND` | 404 | Squads 미사용 |
     | `MULTISIG_TIMEOUT` | 408 | 온체인 멀티시그 미사용 |
     | `ENCLAVE_UNAVAILABLE` | 503 | Nitro Enclave 미사용 |
     | `KMS_KEY_NOT_FOUND` | 404 | AWS KMS 미사용 |
     | `KMS_DECRYPT_FAILED` | 500 | AWS KMS 미사용 |
     | `REDIS_CONNECTION_FAILED` | 503 | Redis 미사용 |
     | `POSTGRES_CONNECTION_FAILED` | 503 | PostgreSQL 미사용 |
     | `API_KEY_EXPIRED` | 401 | 영구 API Key 미사용 |
     | `API_KEY_REVOKED` | 401 | 영구 API Key 미사용 |

  5. 변환된 코드 대응표 (v0.1 -> v0.2):
     | v0.1 코드 (RFC 9457) | v0.2 코드 (7-domain) | HTTP | 매핑 근거 |
     |---------------------|---------------------|------|-----------|
     | `AUTH_INVALID_SIGNATURE` | `AUTH_001` | 401 | 서명 검증 실패 |
     | `AUTH_TOKEN_EXPIRED` | `AUTH_002` | 401 | 토큰 만료 |
     | `AUTH_TOKEN_INVALID` | `AUTH_003` | 401 | 토큰 무효 |
     | `AUTH_OWNER_REQUIRED` | `AUTH_004` | 403 | Owner 권한 필요 |
     | `SESSION_NOT_FOUND` | `SESSION_001` | 404 | 세션 없음 |
     | `SESSION_EXPIRED` | `SESSION_002` | 401 | 세션 만료 |
     | `SESSION_REVOKED` | `SESSION_003` | 401 | 세션 취소됨 |
     | `AGENT_NOT_FOUND` | `AGENT_001` | 404 | 에이전트 없음 |
     | `AGENT_INACTIVE` | `AGENT_002` | 403 | 에이전트 비활성 |
     | `POLICY_LIMIT_EXCEEDED` | `POLICY_001` | 403 | 한도 초과 |
     | `POLICY_APPROVAL_REQUIRED` | `POLICY_002` | 403 | 승인 필요 |
     | `POLICY_DELAY_REQUIRED` | `POLICY_003` | 403 | 지연 필요 |
     | `TX_INSUFFICIENT_BALANCE` | `TX_001` | 400 | 잔액 부족 |
     | `TX_SIMULATION_FAILED` | `TX_002` | 400 | 시뮬레이션 실패 |
     | `TX_SUBMIT_FAILED` | `TX_003` | 500 | 제출 실패 |
     | `CHAIN_RPC_ERROR` | `CHAIN_001` | 503 | RPC 오류 |
     | `CHAIN_NETWORK_MISMATCH` | `CHAIN_002` | 400 | 네트워크 불일치 |

  6. 신규 추가된 코드 (v0.2 only):
     | v0.2 코드 | HTTP | 설명 | v0.1 해당 없음 이유 |
     |-----------|------|------|-------------------|
     | `SESSION_004` | 400 | 세션 제약 위반 | JWT 세션 제약은 v0.2 신규 |
     | `TX_006` | 202 | 지연 큐잉됨 | DELAY tier는 v0.2 신규 |
     | `TX_007` | 202 | 승인 대기중 | APPROVAL tier는 v0.2 신규 |
     | `SYS_003` | 503 | Kill Switch 활성 | v0.2 Kill Switch 신규 |

  7. 마이그레이션 가이드:
     - v0.1 에러 핸들링 코드 -> v0.2 도메인 코드로 변환
     - Squads/KMS/Enclave 에러 -> 해당 없음 (제거)
     - RFC 9457 Problem Details 형식 -> 단순 JSON 에러 응답
  </action>
  <verify>
  ```bash
  # 문서 존재 확인
  test -f .planning/deliverables/43-error-code-mapping.md && echo "PASS: 에러 코드 대응표 생성됨"

  # RFC 9457, 7-domain 모두 언급 확인
  grep -c "RFC 9457\|7-domain" .planning/deliverables/43-error-code-mapping.md
  # 예상: 5 이상

  # 삭제된 코드 섹션 존재 확인
  grep -c "삭제된 코드\|SQUADS\|ENCLAVE\|KMS" .planning/deliverables/43-error-code-mapping.md
  # 예상: 5 이상
  ```
  </verify>
  <done>
  - 43-error-code-mapping.md 파일이 존재함
  - RFC 9457 46개 코드 중 삭제된 10개가 명시됨
  - v0.1 -> v0.2 변환 대응표가 작성됨
  - v0.2 신규 코드가 명시됨
  </done>
</task>

<task type="auto">
  <name>Task 3: 4단계 에스컬레이션 -> 4-tier 정책 대응표 작성</name>
  <files>.planning/deliverables/44-escalation-mapping.md</files>
  <action>
  RESEARCH.md의 "에스컬레이션 모델 대응표 패턴"과 19-permission-policy-model.md, 33-time-lock-approval-mechanism.md를 기반으로 대응표 작성:

  1. 프론트매터:
     ```markdown
     # 4단계 에스컬레이션 -> 4-tier 정책 대응표 (LEGACY-09)

     **작성일:** 2026-02-06
     **버전:** 1.0
     **문서 ID:** MAP-04
     **관련 요구사항:** LEGACY-09 (H13 에스컬레이션 모델)
     ```

  2. 개요:
     - v0.1: 위반 심각도 기반 4단계 에스컬레이션 (Warning -> Throttle -> Require Approval -> Freeze)
     - v0.2: 금액 임계값 기반 4-tier 정책 (INSTANT -> NOTIFY -> DELAY -> APPROVAL)
     - 변경 이유: 금액 기반 자동 분류로 예측 가능한 정책 적용

  3. 모델 비교:
     | 기준 | v0.1 (19-permission-policy-model.md) | v0.2 (33-time-lock-approval-mechanism.md) |
     |------|-------------------------------------|------------------------------------------|
     | 분류 기준 | 위반 심각도/패턴 | 금액 임계값 |
     | 자동화 | 수동 에스컬레이션 | 자동 tier 분류 |
     | 복잡성 | RBAC/ABAC 규칙 조합 | 단순 금액 비교 |
     | 예측 가능성 | 규칙 의존 | 금액으로 즉시 판단 |

  4. 에스컬레이션 -> Tier 대응표:
     | v0.1 에스컬레이션 (Level) | v0.2 Tier | 금액 임계값 | 동작 | 매핑 근거 |
     |--------------------------|-----------|------------|------|-----------|
     | - | INSTANT | < 0.1 SOL | 즉시 실행, 알림 없음 | **v0.2 신규**: 소액 자동 처리 |
     | Level 1: 경고 (Warning) | NOTIFY | < 1 SOL | 즉시 실행 + 알림 발송 | 경고 -> 알림으로 매핑 |
     | Level 2: 제한 (Throttle) | - | - | **v0.2에서 미사용** | 세션 제약(SessionConstraints)으로 대체 |
     | - | DELAY | < 10 SOL | 15분 쿨다운 후 실행 | **v0.2 신규**: 중간 금액 지연 처리 |
     | Level 3: 승인 필요 | APPROVAL | >= 10 SOL | Owner 서명 필요, 1시간 타임아웃 | 승인 -> 승인 (직접 매핑) |
     | Level 4: 동결 (Freeze) | Kill Switch | - | 캐스케이드 정지 | 동결 -> Kill Switch 확장 |

  5. 세부 동작 변경:
     | 항목 | v0.1 | v0.2 | 변경 사항 |
     |------|------|------|-----------|
     | 경고 | 로깅 + UI 알림 | 즉시 실행 + 알림 채널 발송 | 실행 차단 안 함 |
     | 제한 | Rate Limit 적용 | SessionConstraints | 세션 생성 시 제약 설정 |
     | 승인 | Squads 멀티시그 | Owner SIWS/SIWE | 온체인 -> 오프체인 서명 |
     | 동결 | 에이전트 비활성화 | 6단계 캐스케이드 | 세션/트랜잭션/에이전트/키스토어 |

  6. Throttle -> SessionConstraints 변환:
     v0.1 Throttle:
     ```
     - rate_limit: 10 tx/hour
     - cooldown: 5 minutes between txs
     ```
     v0.2 SessionConstraints:
     ```typescript
     {
       max_amount_per_tx: "1000000000",  // 1 SOL
       max_amount_per_day: "10000000000", // 10 SOL
       allowed_programs: ["11111111111111111111111111111111"], // System only
       expires_at: "2026-02-07T00:00:00Z" // 24h
     }
     ```

  7. Kill Switch 확장 (v0.1 Freeze 대비):
     | v0.1 Freeze | v0.2 Kill Switch |
     |-------------|------------------|
     | 에이전트만 비활성화 | 6단계 캐스케이드 정지 |
     | 복구: 관리자 해제 | 복구: dual-auth (Owner SIWS + master password) |
     | 쿨다운 없음 | 30분 최소 쿨다운 |

  8. 마이그레이션 가이드:
     - v0.1 에스컬레이션 레벨 코드 -> v0.2 tier 분류 코드로 변환
     - Throttle 로직 -> SessionConstraints 제약으로 이동 (세션 생성 시 설정)
     - Freeze 로직 -> Kill Switch 호출로 변환
  </action>
  <verify>
  ```bash
  # 문서 존재 확인
  test -f .planning/deliverables/44-escalation-mapping.md && echo "PASS: 에스컬레이션 대응표 생성됨"

  # 4단계, 4-tier 모두 언급 확인
  grep -c "Level 1\|Level 2\|Level 3\|Level 4\|INSTANT\|NOTIFY\|DELAY\|APPROVAL" .planning/deliverables/44-escalation-mapping.md
  # 예상: 10 이상

  # Kill Switch 언급 확인
  grep -c "Kill Switch\|Freeze" .planning/deliverables/44-escalation-mapping.md
  # 예상: 3 이상
  ```
  </verify>
  <done>
  - 44-escalation-mapping.md 파일이 존재함
  - v0.1 4단계 에스컬레이션이 v0.2 4-tier와 매핑됨
  - Throttle -> SessionConstraints 변환이 명시됨
  - Freeze -> Kill Switch 확장이 명시됨
  </done>
</task>

</tasks>

<verification>
Phase 10 Plan 02 완료 검증:

1. **LEGACY-06 충족**: 42-interface-mapping.md에 IBlockchainAdapter -> IChainAdapter 대응표 존재
2. **LEGACY-07 충족**: Squads 메서드 4개(createSmartWallet, addMember, removeMember, updateWalletConfig)가 "제거"로 표시됨
3. **LEGACY-08 충족**: 43-error-code-mapping.md에 RFC 9457 -> v0.2 에러 코드 매핑 존재
4. **LEGACY-09 충족**: 44-escalation-mapping.md에 4단계 -> 4-tier 대응표 존재

```bash
# 전체 검증
test -f .planning/deliverables/42-interface-mapping.md && \
test -f .planning/deliverables/43-error-code-mapping.md && \
test -f .planning/deliverables/44-escalation-mapping.md && \
echo "Phase 10 Plan 02 VERIFIED"
```
</verification>

<success_criteria>
- [ ] 42-interface-mapping.md 파일이 .planning/deliverables/에 존재함
- [ ] 43-error-code-mapping.md 파일이 .planning/deliverables/에 존재함
- [ ] 44-escalation-mapping.md 파일이 .planning/deliverables/에 존재함
- [ ] IBlockchainAdapter의 모든 메서드가 IChainAdapter와 매핑됨
- [ ] Squads 관련 4개 메서드가 "제거"로 표시됨
- [ ] RFC 9457 46개 코드 중 삭제된 10개가 명시됨
- [ ] v0.1 4단계 에스컬레이션이 v0.2 4-tier와 매핑됨
</success_criteria>

<output>
After completion, create `.planning/phases/10-v01-잔재-정리/10-02-SUMMARY.md`
</output>
