---
phase: 144-admin-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/pages/settings.tsx
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/components/layout.tsx
  - packages/admin/src/pages/telegram-users.tsx
  - packages/admin/src/__tests__/settings.test.tsx
  - packages/admin/src/__tests__/telegram-users.test.tsx
autonomous: true

must_haves:
  truths:
    - "Admin UI에서 Kill Switch 상태(ACTIVE/SUSPENDED/LOCKED)를 시각적으로 구분하여 조회할 수 있다"
    - "Admin UI에서 Kill Switch를 ACTIVE->SUSPENDED로 발동하고, SUSPENDED->LOCKED로 격상할 수 있다"
    - "Admin UI에서 Kill Switch를 SUSPENDED/LOCKED->ACTIVE로 복구할 수 있다 (복구 시 LOCKED는 5초 대기)"
    - "Admin UI에서 telegram_users 목록을 조회하고, PENDING 사용자의 role을 ADMIN 또는 READONLY로 승인할 수 있다"
    - "Admin UI에서 Telegram 사용자를 삭제할 수 있다"
  artifacts:
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "Kill Switch 3-state UI (기존 2-state 토글을 3-state 상태 카드 + 발동/격상/복구 버튼으로 리팩토링)"
      contains: "SUSPENDED.*LOCKED.*ACTIVE"
    - path: "packages/admin/src/pages/telegram-users.tsx"
      provides: "Telegram Users 관리 페이지 (목록 조회, role 변경, 삭제)"
      min_lines: 100
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "ADMIN_KILL_SWITCH_ESCALATE, ADMIN_TELEGRAM_USERS, ADMIN_TELEGRAM_USER 엔드포인트 추가"
      contains: "ADMIN_TELEGRAM_USERS"
    - path: "packages/admin/src/components/layout.tsx"
      provides: "Telegram Users 페이지 라우트 + 사이드바 네비게이션 추가"
      contains: "telegram-users"
  key_links:
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/kill-switch"
      via: "apiGet/apiPost (GET 상태 조회 + POST 발동)"
      pattern: "API\\.ADMIN_KILL_SWITCH"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/kill-switch/escalate"
      via: "apiPost (격상)"
      pattern: "API\\.ADMIN_KILL_SWITCH_ESCALATE"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/recover"
      via: "apiPost (복구)"
      pattern: "API\\.ADMIN_RECOVER"
    - from: "packages/admin/src/pages/telegram-users.tsx"
      to: "/v1/admin/telegram-users"
      via: "apiGet (목록 조회) + apiPut (role 변경) + apiDelete (삭제)"
      pattern: "API\\.ADMIN_TELEGRAM_USER"
---

<objective>
Kill Switch 3-state UI 리팩토링 + Telegram Users 관리 페이지를 Admin UI에 추가한다.

Purpose: 기존 2-state(NORMAL/ACTIVATED) Kill Switch 토글을 3-state(ACTIVE/SUSPENDED/LOCKED) UI로 리팩토링하고, Telegram Bot 사용자를 Admin UI에서 관리할 수 있게 한다. (ADUI-01, ADUI-02)
Output: Settings 페이지 Kill Switch 섹션 리팩토링 + 새 Telegram Users 페이지 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@packages/admin/src/pages/settings.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/components/layout.tsx
@packages/admin/src/components/form.tsx
@packages/admin/src/components/table.tsx
@packages/admin/src/components/modal.tsx
@packages/admin/src/components/toast.tsx
@packages/admin/src/utils/format.ts
@packages/admin/src/utils/error-messages.ts
@packages/admin/src/__tests__/settings.test.tsx
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/services/kill-switch-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kill Switch 3-state UI 리팩토링 + API 엔드포인트 추가</name>
  <files>
    packages/admin/src/api/endpoints.ts
    packages/admin/src/pages/settings.tsx
    packages/admin/src/__tests__/settings.test.tsx
  </files>
  <action>
**1. packages/admin/src/api/endpoints.ts**에 누락된 엔드포인트 추가:
```typescript
ADMIN_KILL_SWITCH_ESCALATE: '/v1/admin/kill-switch/escalate',
ADMIN_TELEGRAM_USERS: '/v1/admin/telegram-users',
ADMIN_TELEGRAM_USER: (chatId: number) => `/v1/admin/telegram-users/${chatId}`,
```

**2. packages/admin/src/pages/settings.tsx** Kill Switch 섹션 리팩토링:

기존 Kill Switch 섹션(908-937줄, `settings-section` div)을 삭제하고 새로운 3-state 섹션으로 교체한다.

기존 코드에서 변경 사항:
- `KillSwitchState` 인터페이스는 그대로 유지 (state/activatedAt/activatedBy 이미 올바름)
- `isActivated` 변수 (`ksState?.state === 'ACTIVATED'`)를 삭제하고, 상태별 판별 변수로 교체:
  - `const isSuspended = ksState?.state === 'SUSPENDED';`
  - `const isLocked = ksState?.state === 'LOCKED';`
  - `const isActive = ksState?.state === 'ACTIVE';`
- `handleKillSwitchToggle` 함수를 삭제하고, 3개 액션 함수로 교체:

```typescript
// Kill Switch 발동 (ACTIVE -> SUSPENDED)
const handleKillSwitchActivate = async () => {
  ksActionLoading.value = true;
  try {
    await apiPost(API.ADMIN_KILL_SWITCH);
    showToast('success', 'Kill switch activated - all operations suspended');
    await fetchKillSwitchState();
  } catch (err) {
    const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
    showToast('error', getErrorMessage(e.code));
  } finally {
    ksActionLoading.value = false;
  }
};

// Kill Switch 격상 (SUSPENDED -> LOCKED)
const handleKillSwitchEscalate = async () => {
  ksActionLoading.value = true;
  try {
    await apiPost(API.ADMIN_KILL_SWITCH_ESCALATE);
    showToast('success', 'Kill switch escalated to LOCKED');
    await fetchKillSwitchState();
  } catch (err) {
    const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
    showToast('error', getErrorMessage(e.code));
  } finally {
    ksActionLoading.value = false;
  }
};

// Kill Switch 복구 (SUSPENDED/LOCKED -> ACTIVE)
const handleKillSwitchRecover = async () => {
  ksActionLoading.value = true;
  try {
    await apiPost(API.ADMIN_RECOVER);
    showToast('success', 'Kill switch recovered - operations resumed');
    await fetchKillSwitchState();
  } catch (err) {
    const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
    showToast('error', getErrorMessage(e.code));
  } finally {
    ksActionLoading.value = false;
  }
};
```

- Kill Switch 섹션 UI를 `settings-section` 패턴에서 `settings-category` 패턴으로 변경하여 다른 섹션과 일관성을 맞춘다:

```tsx
function KillSwitchSection() {
  return (
    <div class="settings-category">
      <div class="settings-category-header">
        <h3>Kill Switch</h3>
        <p class="settings-description">
          Emergency stop - suspends all wallet operations immediately.
          3-state: ACTIVE (normal) → SUSPENDED (paused) → LOCKED (permanent).
        </p>
      </div>
      <div class="settings-category-body">
        {ksLoading.value ? (
          <span>Loading...</span>
        ) : ksState ? (
          <>
            {/* State indicator card */}
            <div class="ks-state-card" style={{ marginBottom: 'var(--space-4)' }}>
              <Badge variant={isActive ? 'success' : isLocked ? 'danger' : 'warning'}>
                {ksState.state}
              </Badge>
              {!isActive && ksState.activatedAt && (
                <span class="ks-state-info">
                  Since {formatDate(ksState.activatedAt)}
                  {ksState.activatedBy ? ` by ${ksState.activatedBy}` : ''}
                </span>
              )}
            </div>

            {/* Action buttons based on current state */}
            <div style={{ display: 'flex', gap: 'var(--space-2)', flexWrap: 'wrap' }}>
              {isActive && (
                <Button
                  variant="danger"
                  onClick={handleKillSwitchActivate}
                  loading={ksActionLoading.value}
                >
                  Activate Kill Switch
                </Button>
              )}

              {isSuspended && (
                <>
                  <Button
                    variant="primary"
                    onClick={handleKillSwitchRecover}
                    loading={ksActionLoading.value}
                  >
                    Recover
                  </Button>
                  <Button
                    variant="danger"
                    onClick={handleKillSwitchEscalate}
                    loading={ksActionLoading.value}
                  >
                    Escalate to LOCKED
                  </Button>
                </>
              )}

              {isLocked && (
                <Button
                  variant="primary"
                  onClick={handleKillSwitchRecover}
                  loading={ksActionLoading.value}
                >
                  Recover from LOCKED (5s wait)
                </Button>
              )}
            </div>

            {/* State description */}
            {isSuspended && (
              <div class="settings-info-box" style={{ marginTop: 'var(--space-3)' }}>
                All wallet operations are suspended. Sessions revoked, transactions cancelled.
                You can Recover to resume operations, or Escalate to LOCKED for permanent lockdown.
              </div>
            )}
            {isLocked && (
              <div class="settings-info-box" style={{ marginTop: 'var(--space-3)', borderColor: 'var(--color-danger)' }}>
                System is permanently locked. Recovery requires dual-auth (Owner signature + Master password)
                and has a mandatory 5-second wait period.
              </div>
            )}
          </>
        ) : null}
      </div>
    </div>
  );
}
```

- 메인 렌더에서 기존 Kill Switch `settings-section` div(908-937줄)을 `<KillSwitchSection />`으로 교체한다. 위치는 모든 Settings 카테고리 뒤, JWT Rotation 앞에 배치한다.

**3. packages/admin/src/__tests__/settings.test.tsx**에 Kill Switch 3-state 테스트 추가:

기존 Kill Switch 테스트를 3-state 동작으로 업데이트한다:
- `ACTIVE` 상태에서 "Activate Kill Switch" 버튼 렌더 확인
- `SUSPENDED` 상태에서 "Recover"와 "Escalate to LOCKED" 버튼 렌더 확인
- `LOCKED` 상태에서 "Recover from LOCKED (5s wait)" 버튼 렌더 확인
- 발동 클릭 -> `POST /v1/admin/kill-switch` 호출 확인
- 격상 클릭 -> `POST /v1/admin/kill-switch/escalate` 호출 확인
- 복구 클릭 -> `POST /v1/admin/recover` 호출 확인
- Badge variant 확인: ACTIVE=success, SUSPENDED=warning, LOCKED=danger
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin test -- --run` -- settings 테스트 포함 전체 통과.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin build` -- 빌드 성공.
  </verify>
  <done>
Settings 페이지에서 Kill Switch가 3-state(ACTIVE/SUSPENDED/LOCKED)로 표시되고, 상태별 적절한 버튼(발동/격상/복구)이 렌더링되며, 각 버튼 클릭 시 올바른 API 엔드포인트가 호출된다. 테스트 통과.
  </done>
</task>

<task type="auto">
  <name>Task 2: Telegram Users 관리 페이지 + 라우트 통합</name>
  <files>
    packages/admin/src/pages/telegram-users.tsx
    packages/admin/src/components/layout.tsx
    packages/admin/src/__tests__/telegram-users.test.tsx
  </files>
  <action>
**1. packages/admin/src/pages/telegram-users.tsx** 신규 생성:

기존 Admin 페이지 패턴을 따라 Telegram Users 관리 페이지를 생성한다. 기존 `sessions.tsx` 패턴(Table + Badge + 액션 버튼)을 참조한다.

```typescript
import { useSignal } from '@preact/signals';
import { useEffect } from 'preact/hooks';
import { apiGet, apiPut, apiDelete, ApiError } from '../api/client';
import { API } from '../api/endpoints';
import { Badge, Button } from '../components/form';
import { Table } from '../components/table';
import type { Column } from '../components/table';
import { Modal } from '../components/modal';
import { showToast } from '../components/toast';
import { getErrorMessage } from '../utils/error-messages';
import { formatDate } from '../utils/format';
```

타입 정의:
```typescript
interface TelegramUser {
  chat_id: number;
  username: string | null;
  role: 'PENDING' | 'ADMIN' | 'READONLY';
  registered_at: number;
  approved_at: number | null;
}
```

컴포넌트 구현 상세:
- `useSignal`으로 상태 관리: users 목록, loading, 선택된 user, approve 모달 열림/닫힘, approve role 선택, delete 확인 모달
- `useEffect`에서 `fetchUsers()` 호출: `apiGet<{ users: TelegramUser[]; total: number }>(API.ADMIN_TELEGRAM_USERS)`
- Table 컬럼 정의:
  - `chat_id`: Chat ID (숫자)
  - `username`: Username (nullable -- null이면 "-" 표시)
  - `role`: Badge로 렌더 (PENDING=warning, ADMIN=success, READONLY=info)
  - `registered_at`: 등록 시간 (`formatDate` 사용)
  - `approved_at`: 승인 시간 (null이면 "-" 표시, 값 있으면 `formatDate`)
  - Actions 컬럼: 각 행에 버튼 렌더
    - PENDING 사용자: "Approve" 버튼 (클릭 시 role 선택 모달 열기)
    - ADMIN/READONLY 사용자: role 변경 드롭다운은 필요 없음 -- Approve 모달에서 ADMIN/READONLY 중 선택
    - 모든 사용자: "Delete" 버튼 (danger variant, 클릭 시 delete 확인 모달)

- Approve 모달 (Modal 컴포넌트 사용):
  - title: "Approve Telegram User"
  - 내용: chat_id, username 표시 + ADMIN/READONLY 라디오 버튼 또는 select
  - 확인 클릭: `apiPut(API.ADMIN_TELEGRAM_USER(chatId), { role: selectedRole })` 호출
  - 성공 시 toast + 목록 새로고침

- Delete 확인 모달 (Modal 컴포넌트 사용):
  - title: "Delete Telegram User"
  - 내용: "Are you sure you want to remove this user? They will need to /start again to re-register."
  - confirmVariant: "danger"
  - 확인 클릭: `apiDelete(API.ADMIN_TELEGRAM_USER(chatId))` 호출
  - 성공 시 toast + 목록 새로고침

- EmptyState: 사용자가 없을 때 "No Telegram users registered. Users appear here after sending /start to the bot." 메시지

**2. packages/admin/src/components/layout.tsx** 수정:

- `TelegramUsersPage` import 추가: `import TelegramUsersPage from '../pages/telegram-users';`
- NAV_ITEMS에 Telegram Users 추가 (Notifications 뒤, Settings 앞):
  ```typescript
  { path: '/telegram-users', label: 'Telegram' },
  ```
- PAGE_TITLES에 추가: `'/telegram-users': 'Telegram Users'`
- PageRouter에 라우트 추가: `if (path === '/telegram-users') return <TelegramUsersPage />;`
  - Settings 분기 전에 배치

**3. packages/admin/src/__tests__/telegram-users.test.tsx** 신규 생성:

기존 `settings.test.tsx` mock 패턴을 따라 테스트 작성:
- `vi.mock('../api/client', ...)` -- apiGet, apiPut, apiDelete mock
- `vi.mock('../components/toast', ...)` -- showToast mock
- `vi.mock('../auth/store', ...)` -- masterPassword, isAuthenticated mock

테스트 케이스:
1. **목록 렌더**: mock users 3명(PENDING, ADMIN, READONLY) -> Table에 3행 렌더 확인 + 각 Badge variant 확인
2. **빈 목록**: users=[] -> EmptyState 메시지 표시
3. **Approve 동작**: PENDING 사용자 Approve 클릭 -> 모달 열기 -> ADMIN 선택 -> Confirm -> `apiPut('/v1/admin/telegram-users/123', { role: 'ADMIN' })` 호출 확인
4. **Delete 동작**: 사용자 Delete 클릭 -> 확인 모달 -> Confirm -> `apiDelete('/v1/admin/telegram-users/123')` 호출 확인
5. **에러 처리**: apiPut 실패 시 showToast('error', ...) 호출 확인
6. **로딩 상태**: 초기 렌더 시 loading 표시 -> 데이터 로드 후 테이블 표시
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin test -- --run` -- telegram-users 테스트 포함 전체 통과.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin build` -- 빌드 성공.
  </verify>
  <done>
Admin UI 사이드바에 "Telegram" 네비게이션이 추가되고, 클릭 시 Telegram Users 페이지가 렌더링된다. 페이지에서 telegram_users 목록을 조회하고, PENDING 사용자를 ADMIN/READONLY로 승인하고, 사용자를 삭제할 수 있다. 6개 테스트 통과.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin build` 성공 (TSX 컴파일 + 번들 정상)
2. `pnpm --filter @waiaas/admin test -- --run` 전체 통과 (기존 + 신규 테스트)
3. Settings 페이지에서 Kill Switch가 3-state(ACTIVE/SUSPENDED/LOCKED)로 표시되고, 상태별 버튼이 올바르게 렌더링됨
4. Telegram Users 페이지에서 목록 조회, 승인, 삭제가 동작함
5. 사이드바에 Telegram 네비게이션이 추가됨
</verification>

<success_criteria>
- Kill Switch UI가 3-state(ACTIVE/SUSPENDED/LOCKED) 모델을 반영하여 상태별 적절한 액션 버튼(발동/격상/복구)을 제공한다 (ADUI-01)
- Telegram Users 페이지에서 사용자 목록 조회, PENDING->ADMIN/READONLY 승인, 삭제가 가능하다 (ADUI-02)
- 모든 Admin UI 테스트가 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/144-admin-ui-integration/144-01-SUMMARY.md`
</output>
