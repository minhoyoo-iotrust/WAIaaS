---
phase: 128-action-provider-api-key
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/action/api-key-store.ts
  - packages/daemon/src/infrastructure/action/index.ts
  - packages/daemon/src/__tests__/api-key-store.test.ts
  - packages/daemon/src/__tests__/migration-chain.test.ts
autonomous: true

must_haves:
  truths:
    - "api_keys 테이블이 DB v11 마이그레이션으로 생성되어 프로바이더별 API 키를 저장한다"
    - "ApiKeyStore가 API 키를 HKDF + AES-256-GCM으로 암호화 저장/복호화 조회한다"
    - "ApiKeyStore.getMasked()가 키를 앞 4자 + '...' + 끝 2자 형태로 마스킹 반환한다"
    - "기존 DB(v10)에서 v11로 증분 마이그레이션이 정상 수행된다"
    - "신규 DB에서 api_keys 테이블이 자동 생성된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "api_keys Drizzle 테이블 스키마 (Table 11)"
      contains: "apiKeys"
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v11 마이그레이션 (CREATE TABLE api_keys) + LATEST_SCHEMA_VERSION=11"
      contains: "version: 11"
    - path: "packages/daemon/src/infrastructure/action/api-key-store.ts"
      provides: "ApiKeyStore (set/get/getMasked/delete/listAll)"
      exports: ["ApiKeyStore"]
  key_links:
    - from: "packages/daemon/src/infrastructure/action/api-key-store.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-crypto.ts"
      via: "import encryptSettingValue, decryptSettingValue"
      pattern: "import.*settings-crypto"
    - from: "packages/daemon/src/infrastructure/action/api-key-store.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "import apiKeys table"
      pattern: "import.*schema"
---

<objective>
api_keys 테이블 DB v11 마이그레이션 + ApiKeyStore 암호화 저장소 구현

Purpose: Action Provider의 API 키를 DB에 안전하게 암호화 저장/조회/삭제할 수 있는 인프라를 구축한다. 기존 settings-crypto.ts의 HKDF + AES-256-GCM 패턴을 재사용한다.
Output: api_keys Drizzle 스키마 + v11 마이그레이션 + ApiKeyStore 클래스 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/128-action-provider-api-key/128-RESEARCH.md
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/settings/settings-crypto.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: api_keys Drizzle 스키마 + DB v11 마이그레이션</name>
  <files>
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/infrastructure/database/migrate.ts
  </files>
  <action>
    1. `packages/daemon/src/infrastructure/database/schema.ts` 수정:
       - 파일 최상단 주석의 테이블 수를 "10 tables" -> "11 tables"로 갱신, 목록에 api_keys 추가
       - 파일 하단에 Table 11: api_keys 추가:
       ```typescript
       // ---------------------------------------------------------------------------
       // Table 11: api_keys -- Action Provider API key encrypted storage (v1.5)
       // ---------------------------------------------------------------------------

       export const apiKeys = sqliteTable('api_keys', {
         providerName: text('provider_name').primaryKey(),
         encryptedKey: text('encrypted_key').notNull(),
         createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
         updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull(),
       });
       ```

    2. `packages/daemon/src/infrastructure/database/migrate.ts` 수정 (3곳 동시):
       - (a) `LATEST_SCHEMA_VERSION`을 10 -> 11로 변경
       - (b) `getCreateTableStatements()` 함수 내에 api_keys CREATE TABLE 추가:
       ```sql
       CREATE TABLE IF NOT EXISTS api_keys (
         provider_name TEXT PRIMARY KEY,
         encrypted_key TEXT NOT NULL,
         created_at INTEGER NOT NULL,
         updated_at INTEGER NOT NULL
       )
       ```
       - (c) 기존 v10 마이그레이션 아래에 v11 마이그레이션 추가:
       ```typescript
       MIGRATIONS.push({
         version: 11,
         description: 'Add api_keys table for Action Provider API key storage',
         up: (sqlite) => {
           sqlite.exec(`CREATE TABLE IF NOT EXISTS api_keys (
         provider_name TEXT PRIMARY KEY,
         encrypted_key TEXT NOT NULL,
         created_at INTEGER NOT NULL,
         updated_at INTEGER NOT NULL
       )`);
         },
       });
       ```

    주의: LATEST_SCHEMA_VERSION과 getCreateTableStatements()와 MIGRATIONS.push()를 반드시 3곳 동시에 수정해야 한다 (Pitfall 6 참고).
    주의: pushSchema() 내부의 schema_version 기록 로직에서 v11까지 기록하도록 확인 (LATEST_SCHEMA_VERSION 변경으로 자동 반영됨).
  </action>
  <verify>
    - `grep 'LATEST_SCHEMA_VERSION = 11' packages/daemon/src/infrastructure/database/migrate.ts` 존재
    - `grep 'api_keys' packages/daemon/src/infrastructure/database/schema.ts` 존재
    - `grep "version: 11" packages/daemon/src/infrastructure/database/migrate.ts` 존재
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx vitest run src/__tests__/migration-chain.test.ts --reporter=verbose` 통과 (기존 마이그레이션 체인 테스트가 v11까지 검증)
  </verify>
  <done>api_keys 테이블이 Drizzle 스키마에 정의되고, LATEST_SCHEMA_VERSION=11로 변경되며, v11 증분 마이그레이션이 기존 마이그레이션 체인 테스트를 통과한다</done>
</task>

<task type="auto">
  <name>Task 2: ApiKeyStore 암호화 저장소 + 단위 테스트</name>
  <files>
    packages/daemon/src/infrastructure/action/api-key-store.ts
    packages/daemon/src/infrastructure/action/index.ts
    packages/daemon/src/__tests__/api-key-store.test.ts
  </files>
  <action>
    1. `packages/daemon/src/infrastructure/action/api-key-store.ts` 신규 생성:
       - import { encryptSettingValue, decryptSettingValue } from '../settings/settings-crypto.js'
       - import { eq } from 'drizzle-orm'
       - import { apiKeys } from '../database/schema.js'
       - ApiKeyStore 클래스:
         - constructor(private readonly db: BetterSQLite3Database<typeof schema>, private readonly masterPassword: string)
         - `set(providerName: string, apiKey: string): void` -- encryptSettingValue()로 암호화 후 upsert (onConflictDoUpdate). createdAt은 insert 시만, updatedAt은 항상 갱신. timestamp는 Unix epoch 초 단위 (Math.floor(Date.now() / 1000))
         - `get(providerName: string): string | null` -- 행 조회 후 decryptSettingValue()로 복호화. 없으면 null
         - `getMasked(providerName: string): string | null` -- get()으로 복호화 후 마스킹: 길이>6이면 `key.slice(0,4) + '...' + key.slice(-2)`, 4~6이면 `key.slice(0,2) + '...'`, <4이면 '****'
         - `has(providerName: string): boolean` -- 행 존재 여부만 확인 (복호화 불필요, SELECT 1)
         - `delete(providerName: string): boolean` -- 삭제 후 result.changes > 0 반환
         - `listAll(): { providerName: string; hasKey: boolean; maskedKey: string | null; updatedAt: Date }[]` -- 전체 행 조회, 각 행에 대해 getMasked() 호출

    2. `packages/daemon/src/infrastructure/action/index.ts` 수정 -- ApiKeyStore export 추가:
       `export { ApiKeyStore } from './api-key-store.js';`
       (Plan 01에서 ActionProviderRegistry도 여기서 export되므로, 이미 있으면 추가 라인만)

    3. `packages/daemon/src/__tests__/api-key-store.test.ts` 작성:
       - 테스트용 in-memory SQLite DB 생성 (기존 database.test.ts 패턴 참조: createDatabase(':memory:') 사용)
       - pushSchema()로 전체 스키마 생성 (api_keys 포함)
       - 테스트 케이스:
         a. set -- 새 키 저장 성공 + DB에 암호화된 값 존재 (plaintext와 다름)
         b. get -- 저장 후 복호화 조회 성공
         c. get -- 미존재 프로바이더 null 반환
         d. set (upsert) -- 기존 키 업데이트 시 updatedAt 갱신
         e. getMasked -- 긴 키 마스킹 (앞 4자 + ... + 끝 2자)
         f. getMasked -- 짧은 키 마스킹 (****)
         g. has -- 존재하는 키 true
         h. has -- 미존재 키 false
         i. delete -- 존재하는 키 삭제 성공 (true)
         j. delete -- 미존재 키 삭제 (false)
         k. listAll -- 다수 키 목록 조회 + 마스킹 확인
         l. set + delete + get -- 삭제 후 get null 확인

    기존 daemon 테스트 회귀 확인.
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx vitest run src/__tests__/api-key-store.test.ts --reporter=verbose` 전체 통과
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx vitest run --reporter=verbose` 기존 테스트 회귀 없음
  </verify>
  <done>ApiKeyStore가 API 키를 HKDF+AES-256-GCM으로 암호화 저장/복호화 조회/마스킹 반환/삭제하고, 12개 이상 단위 테스트가 통과한다</done>
</task>

</tasks>

<verification>
- LATEST_SCHEMA_VERSION = 11
- api_keys 테이블이 getCreateTableStatements()과 MIGRATIONS 양쪽에 존재
- migration-chain.test.ts 통과 (v1->v11 전체 경로)
- ApiKeyStore.set/get/getMasked/has/delete/listAll 모든 메서드 동작
- 암호화된 값이 plaintext와 다름 (DB 직접 조회 시 암호화 확인)
- 기존 daemon 테스트 회귀 없음
</verification>

<success_criteria>
api_keys 테이블이 DB v11으로 추가되고, ApiKeyStore가 기존 settings-crypto 패턴으로 API 키를 암호화 CRUD하며, 마이그레이션 체인 테스트와 단위 테스트가 모두 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/128-action-provider-api-key/128-02-SUMMARY.md`
</output>
