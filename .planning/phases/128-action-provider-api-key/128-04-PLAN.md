---
phase: 128-action-provider-api-key
plan: 04
type: execute
wave: 2
depends_on: ["128-02"]
files_modified:
  - packages/daemon/src/api/routes/admin.ts
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/pages/settings.tsx
  - packages/daemon/src/__tests__/api-admin-api-keys.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /v1/admin/api-keys가 프로바이더별 키 설정 상태를 마스킹 반환한다"
    - "PUT /v1/admin/api-keys/:provider가 API 키를 암호화 저장한다"
    - "DELETE /v1/admin/api-keys/:provider가 API 키를 삭제한다"
    - "Admin UI API Keys 섹션에서 프로바이더별 키를 입력/수정/삭제할 수 있다"
    - "requiresApiKey=true 프로바이더 중 키 미설정 항목에 경고 배지가 표시된다"
  artifacts:
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "GET/PUT/DELETE /v1/admin/api-keys 라우트"
      contains: "api-keys"
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "API Keys 섹션 UI"
      contains: "ApiKeys"
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "ADMIN_API_KEYS 엔드포인트 상수"
      contains: "ADMIN_API_KEYS"
    - path: "packages/daemon/src/__tests__/api-admin-api-keys.test.ts"
      provides: "Admin API Keys REST API 테스트"
  key_links:
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "packages/daemon/src/infrastructure/action/api-key-store.ts"
      via: "ApiKeyStore.set/getMasked/delete/listAll"
      pattern: "apiKeyStore\\."
    - from: "packages/admin/src/pages/settings.tsx"
      to: "packages/admin/src/api/endpoints.ts"
      via: "API.ADMIN_API_KEYS"
      pattern: "ADMIN_API_KEYS"
---

<objective>
Admin UI API Keys CRUD + GET/PUT/DELETE /v1/admin/api-keys REST API

Purpose: Admin이 웹 UI에서 프로바이더별 API 키를 관리(설정/수정/삭제)할 수 있게 하고, REST API가 키를 마스킹 반환하여 보안을 유지한다.
Output: admin.ts에 API Keys 라우트 추가 + Admin UI settings.tsx에 API Keys 섹션 추가 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/128-action-provider-api-key/128-RESEARCH.md
@.planning/phases/128-action-provider-api-key/128-02-SUMMARY.md
@packages/daemon/src/api/routes/admin.ts
@packages/admin/src/pages/settings.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: GET/PUT/DELETE /v1/admin/api-keys REST API + 테스트</name>
  <files>
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/__tests__/api-admin-api-keys.test.ts
  </files>
  <action>
    1. **AdminRouteDeps 확장** (`packages/daemon/src/api/routes/admin.ts`):
       - import 추가: `import type { ApiKeyStore } from '../../infrastructure/action/api-key-store.js';`
       - import 추가: `import type { ActionProviderRegistry } from '../../infrastructure/action/action-provider-registry.js';`
       - AdminRouteDeps에 추가:
         ```typescript
         apiKeyStore?: ApiKeyStore;
         actionProviderRegistry?: ActionProviderRegistry;
         ```

    2. **3개 API Keys 라우트 추가** (admin.ts 내 adminRoutes 함수):
       - `GET /admin/api-keys`:
         - createRoute(): method 'get', path '/admin/api-keys', tags ['Admin'], summary 'List Action Provider API key status'
         - 핸들러:
           - registry에서 listProviders()로 프로바이더 목록 가져오기
           - 각 프로바이더에 대해 apiKeyStore.listAll() 결과와 매칭
           - 응답: { keys: [{ providerName: string, hasKey: boolean, maskedKey: string|null, requiresApiKey: boolean, updatedAt: string|null }] }
           - registry 미설정 시 빈 목록 반환
         - 200 응답

       - `PUT /admin/api-keys/{provider}`:
         - createRoute(): method 'put', path '/admin/api-keys/{provider}', tags ['Admin'], summary 'Set or update Action Provider API key'
         - request body: z.object({ apiKey: z.string().min(1) })
         - 핸들러:
           - params.provider로 프로바이더 이름 추출
           - apiKeyStore.set(provider, body.apiKey)
           - 200 응답: { success: true, providerName: provider }
         - buildErrorResponses 필요시 추가

       - `DELETE /admin/api-keys/{provider}`:
         - createRoute(): method 'delete', path '/admin/api-keys/{provider}', tags ['Admin'], summary 'Delete Action Provider API key'
         - 핸들러:
           - params.provider로 프로바이더 이름 추출
           - const deleted = apiKeyStore.delete(provider)
           - deleted이면 200 { success: true }, 아니면 404 반환
         - buildErrorResponses(['ACTION_NOT_FOUND']) 사용

    3. **masterAuth 등록** (`packages/daemon/src/api/server.ts`):
       - masterAuth 블록에 추가:
         ```typescript
         app.use('/v1/admin/api-keys', masterAuthForAdmin);
         app.use('/v1/admin/api-keys/*', masterAuthForAdmin);
         ```

    4. **통합 테스트** (`packages/daemon/src/__tests__/api-admin-api-keys.test.ts`):
       - createApp()에 apiKeyStore (in-memory DB 기반) + actionProviderRegistry를 deps로 전달
       - Mock IActionProvider 등록 (requiresApiKey: true + requiresApiKey: false 각 1개)
       - 테스트 케이스:
         a. GET /v1/admin/api-keys -- 프로바이더 목록 + hasKey 상태 반환 (200)
         b. PUT /v1/admin/api-keys/test_provider -- 키 설정 성공 (200)
         c. GET /v1/admin/api-keys -- 설정 후 hasKey=true + maskedKey 확인
         d. PUT /v1/admin/api-keys/test_provider -- 키 업데이트 성공
         e. DELETE /v1/admin/api-keys/test_provider -- 삭제 성공 (200)
         f. DELETE /v1/admin/api-keys/nonexistent -- 404 반환
         g. GET /v1/admin/api-keys -- 삭제 후 hasKey=false 확인
         h. masterAuth 미인증 시 401 반환

    기존 daemon 테스트 회귀 확인.
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx vitest run src/__tests__/api-admin-api-keys.test.ts --reporter=verbose` 전체 통과
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx vitest run --reporter=verbose` 기존 테스트 회귀 없음
  </verify>
  <done>GET/PUT/DELETE /v1/admin/api-keys API가 masterAuth로 보호되고, 키 CRUD + 마스킹 반환이 동작하며, 8개 이상 테스트가 통과한다</done>
</task>

<task type="auto">
  <name>Task 2: Admin UI API Keys 섹션</name>
  <files>
    packages/admin/src/api/endpoints.ts
    packages/admin/src/pages/settings.tsx
  </files>
  <action>
    1. **엔드포인트 상수** (`packages/admin/src/api/endpoints.ts`):
       - API 객체에 추가:
         ```typescript
         ADMIN_API_KEYS: '/v1/admin/api-keys',
         ADMIN_API_KEY: (provider: string) => `/v1/admin/api-keys/${provider}`,
         ```

    2. **API Keys 섹션** (`packages/admin/src/pages/settings.tsx`):
       - 타입 추가:
         ```typescript
         interface ApiKeyEntry {
           providerName: string;
           hasKey: boolean;
           maskedKey: string | null;
           requiresApiKey: boolean;
           updatedAt: string | null;
         }
         ```

       - SettingsPage 컴포넌트 내에 상태 추가:
         ```typescript
         const apiKeys = useSignal<ApiKeyEntry[]>([]);
         const apiKeysLoading = useSignal(true);
         const apiKeyEditing = useSignal<string | null>(null);  // provider name being edited
         const apiKeyInput = useSignal('');
         const apiKeySaving = useSignal(false);
         ```

       - fetchApiKeys 함수:
         ```typescript
         const fetchApiKeys = async () => {
           try {
             const result = await apiGet<{ keys: ApiKeyEntry[] }>(API.ADMIN_API_KEYS);
             apiKeys.value = result.keys;
           } catch (err) {
             // 404/기능 미활성 시 빈 배열 유지
           } finally {
             apiKeysLoading.value = false;
           }
         };
         ```
         useEffect에 fetchApiKeys() 추가.

       - handleSaveApiKey 함수:
         ```typescript
         const handleSaveApiKey = async (providerName: string) => {
           apiKeySaving.value = true;
           try {
             await apiPut(API.ADMIN_API_KEY(providerName), { apiKey: apiKeyInput.value });
             showToast('success', `API key saved for ${providerName}`);
             apiKeyEditing.value = null;
             apiKeyInput.value = '';
             await fetchApiKeys();
           } catch (err) { ... }
           finally { apiKeySaving.value = false; }
         };
         ```

       - handleDeleteApiKey 함수:
         ```typescript
         const handleDeleteApiKey = async (providerName: string) => {
           try {
             await apiDelete(API.ADMIN_API_KEY(providerName));
             showToast('success', `API key deleted for ${providerName}`);
             await fetchApiKeys();
           } catch (err) { ... }
         };
         ```

       - apiDelete import 확인 (기존 client.ts에 apiDelete가 없으면 추가 필요)

       - ApiKeysSection 컴포넌트 구현:
         ```tsx
         function ApiKeysSection() {
           if (apiKeysLoading.value) return <div class="settings-loading">Loading API keys...</div>;
           if (apiKeys.value.length === 0) return null;  // 프로바이더 없으면 섹션 숨김

           return (
             <div class="settings-category">
               <div class="settings-category-header">
                 <h3>API Keys</h3>
                 <p class="settings-description">Manage API keys for Action Providers</p>
               </div>
               <div class="settings-category-body">
                 {apiKeys.value.map(entry => (
                   <div class="settings-field-row" key={entry.providerName}>
                     <div class="settings-field-label">
                       <span>{entry.providerName}</span>
                       {entry.requiresApiKey && !entry.hasKey && (
                         <Badge variant="warning">Required</Badge>
                       )}
                     </div>
                     <div class="settings-field-value">
                       {apiKeyEditing.value === entry.providerName ? (
                         <div class="api-key-edit-row">
                           <FormField
                             type="password"
                             value={apiKeyInput.value}
                             onChange={(v) => { apiKeyInput.value = v; }}
                             placeholder="Enter API key"
                           />
                           <Button
                             onClick={() => handleSaveApiKey(entry.providerName)}
                             loading={apiKeySaving.value}
                             size="sm"
                           >Save</Button>
                           <Button
                             variant="ghost"
                             onClick={() => { apiKeyEditing.value = null; apiKeyInput.value = ''; }}
                             size="sm"
                           >Cancel</Button>
                         </div>
                       ) : (
                         <div class="api-key-display-row">
                           <span class="api-key-masked">{entry.hasKey ? entry.maskedKey : 'Not set'}</span>
                           <Button
                             variant="ghost"
                             onClick={() => { apiKeyEditing.value = entry.providerName; apiKeyInput.value = ''; }}
                             size="sm"
                           >{entry.hasKey ? 'Change' : 'Set'}</Button>
                           {entry.hasKey && (
                             <Button
                               variant="danger"
                               onClick={() => handleDeleteApiKey(entry.providerName)}
                               size="sm"
                             >Delete</Button>
                           )}
                         </div>
                       )}
                     </div>
                   </div>
                 ))}
               </div>
             </div>
           );
         }
         ```

       - SettingsPage 렌더링에 ApiKeysSection 추가 (NotificationSettings 위 또는 아래):
         ```tsx
         <ApiKeysSection />
         ```

       주의: 기존 settings.tsx의 컴포넌트 패턴(FormField, Button, Badge, showToast 등)을 정확히 따른다. apiDelete가 client.ts에 없으면 추가한다 (기존 apiGet/apiPost/apiPut 패턴 참조).
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/admin && npx tsc --noEmit` 타입 체크 통과 (또는 vite build)
    - `grep 'ADMIN_API_KEYS' packages/admin/src/api/endpoints.ts` 존재
    - `grep 'ApiKeysSection' packages/admin/src/pages/settings.tsx` 존재
    - `grep 'apiKeyEditing' packages/admin/src/pages/settings.tsx` 존재
  </verify>
  <done>Admin UI Settings 페이지에 API Keys 섹션이 추가되어 프로바이더별 키 입력/수정/삭제가 가능하고, requiresApiKey 경고 배지가 표시된다</done>
</task>

</tasks>

<verification>
- GET /v1/admin/api-keys: 프로바이더 목록 + hasKey + maskedKey 반환
- PUT /v1/admin/api-keys/:provider: 키 암호화 저장
- DELETE /v1/admin/api-keys/:provider: 키 삭제
- masterAuth로 3개 엔드포인트 모두 보호
- Admin UI에서 키 설정/변경/삭제 동작
- requiresApiKey=true + 키 미설정 시 경고 배지
- 8개 이상 API 테스트 통과
- 기존 daemon 테스트 회귀 없음
</verification>

<success_criteria>
Admin UI API Keys 섹션과 GET/PUT/DELETE /v1/admin/api-keys REST API가 구현되어 프로바이더별 키 CRUD가 완전히 동작하고, 마스킹 반환과 경고 배지가 적용된다
</success_criteria>

<output>
After completion, create `.planning/phases/128-action-provider-api-key/128-04-SUMMARY.md`
</output>
