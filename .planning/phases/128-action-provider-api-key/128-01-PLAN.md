---
phase: 128-action-provider-api-key
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/action-provider.types.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/index.ts
  - packages/core/src/errors/error-codes.ts
  - packages/daemon/src/infrastructure/action/action-provider-registry.ts
  - packages/daemon/src/infrastructure/action/index.ts
  - packages/daemon/src/__tests__/action-provider-registry.test.ts
autonomous: true

must_haves:
  truths:
    - "IActionProvider 인터페이스가 metadata/actions/resolve 3개 멤버를 Zod SSoT로 정의한다"
    - "ActionProviderRegistry가 IActionProvider 구현체를 등록/조회/해제하고 이름 중복을 거부한다"
    - "ActionProviderRegistry가 ~/.waiaas/actions/ 디렉토리에서 ESM 플러그인을 발견/로드/검증한다"
    - "resolve() 반환값이 ContractCallRequestSchema.parse()로 재검증되어 정책 우회를 차단한다"
    - "잘못된 플러그인 로드 실패 시 전체 데몬이 중단되지 않고 해당 플러그인만 건너뛴다"
  artifacts:
    - path: "packages/core/src/interfaces/action-provider.types.ts"
      provides: "IActionProvider, ActionProviderMetadata, ActionDefinition, ActionContext Zod SSoT"
      exports: ["IActionProvider", "ActionProviderMetadataSchema", "ActionDefinitionSchema", "ActionContextSchema", "ActionProviderMetadata", "ActionDefinition", "ActionContext"]
    - path: "packages/daemon/src/infrastructure/action/action-provider-registry.ts"
      provides: "ActionProviderRegistry (register/unregister/getAction/listProviders/loadPlugins/executeResolve)"
      exports: ["ActionProviderRegistry"]
    - path: "packages/daemon/src/__tests__/action-provider-registry.test.ts"
      provides: "ActionProviderRegistry 단위 테스트"
  key_links:
    - from: "packages/daemon/src/infrastructure/action/action-provider-registry.ts"
      to: "packages/core/src/interfaces/action-provider.types.ts"
      via: "import IActionProvider, ActionProviderMetadataSchema, ActionDefinitionSchema"
      pattern: "import.*action-provider\\.types"
    - from: "packages/daemon/src/infrastructure/action/action-provider-registry.ts"
      to: "packages/core/src/schemas/transaction.schema.ts"
      via: "ContractCallRequestSchema.parse() for resolve() return validation"
      pattern: "ContractCallRequestSchema\\.parse"
---

<objective>
IActionProvider Zod SSoT 인터페이스 정의 + ActionProviderRegistry (등록/조회/해제/ESM 플러그인 로드/resolve 실행) 구현

Purpose: Action Provider 프레임워크의 핵심 인터페이스와 레지스트리를 구축하여, 후속 Plan 02(DB), Plan 03(REST API)의 토대를 마련한다.
Output: core 패키지에 IActionProvider 타입, daemon 패키지에 ActionProviderRegistry 구현체 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/128-action-provider-api-key/128-RESEARCH.md
@packages/core/src/interfaces/price-oracle.types.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/schemas/transaction.schema.ts
@packages/daemon/src/infrastructure/oracle/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: IActionProvider Zod SSoT 타입 정의 + API_KEY_REQUIRED 에러 코드</name>
  <files>
    packages/core/src/interfaces/action-provider.types.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/index.ts
    packages/core/src/errors/error-codes.ts
  </files>
  <action>
    1. `packages/core/src/interfaces/action-provider.types.ts` 신규 생성:
       - `ActionProviderMetadataSchema`: z.object({ name: z.string().regex(/^[a-z][a-z0-9_]*$/).min(3).max(50), description: z.string().min(10).max(500), version: z.string().regex(/^\d+\.\d+\.\d+$/), chains: z.array(ChainTypeEnum).min(1), mcpExpose: z.boolean().default(false), requiresApiKey: z.boolean().default(false), requiredApis: z.array(z.string()).optional().default([]) })
       - `ActionDefinitionSchema`: z.object({ name: z.string().regex(/^[a-z][a-z0-9_]*$/).min(3).max(50), description: z.string().min(20).max(1000), chain: ChainTypeEnum, inputSchema: z.any(), riskLevel: z.enum(['low','medium','high']), defaultTier: z.enum(['INSTANT','NOTIFY','DELAY','APPROVAL']) })
       - `ActionContextSchema`: z.object({ walletAddress: z.string().min(1), chain: ChainTypeEnum, walletId: z.string(), sessionId: z.string().optional() })
       - `IActionProvider` interface: readonly metadata: ActionProviderMetadata, readonly actions: readonly ActionDefinition[], resolve(actionName, params: Record<string,unknown>, context: ActionContext): Promise<ContractCallRequest>
       - ChainTypeEnum import는 기존 `@waiaas/core`의 ChainType enum Zod 스키마 사용 (packages/core/src/enums/chain.ts 확인). ContractCallRequest import는 `../schemas/transaction.schema.js`에서 가져온다.
       - Named export 모두 수행 (type + schema 둘 다)

    2. `packages/core/src/interfaces/index.ts`에 action-provider.types.ts 전체 re-export 추가

    3. `packages/core/src/index.ts`에 IActionProvider, ActionProviderMetadata, ActionDefinition, ActionContext 타입 + 4개 Schema re-export 추가

    4. `packages/core/src/errors/error-codes.ts`의 ACTION 도메인에 `API_KEY_REQUIRED` 에러 코드 추가:
       ```
       API_KEY_REQUIRED: {
         code: 'API_KEY_REQUIRED',
         domain: 'ACTION',
         httpStatus: 403,
         retryable: false,
         message: 'API key required for this action provider',
       }
       ```

    5. core 패키지 빌드: `cd packages/core && npx tsc --noEmit` 로 타입 체크 후 `npm run build` (또는 npx tsc) 로 dist/ 갱신
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/core && npx tsc --noEmit` 성공
    - `grep -c 'IActionProvider' packages/core/src/interfaces/action-provider.types.ts` >= 1
    - `grep 'API_KEY_REQUIRED' packages/core/src/errors/error-codes.ts` 존재
  </verify>
  <done>IActionProvider 인터페이스 + 4개 Zod 스키마가 core 패키지에 정의되고, API_KEY_REQUIRED 에러 코드가 추가되어 빌드 통과</done>
</task>

<task type="auto">
  <name>Task 2: ActionProviderRegistry 구현 + 단위 테스트</name>
  <files>
    packages/daemon/src/infrastructure/action/action-provider-registry.ts
    packages/daemon/src/infrastructure/action/index.ts
    packages/daemon/src/__tests__/action-provider-registry.test.ts
  </files>
  <action>
    1. `packages/daemon/src/infrastructure/action/action-provider-registry.ts` 신규 생성:
       - ActionProviderRegistry 클래스:
         - private providers: Map<string, IActionProvider>
         - private actions: Map<string, { provider: IActionProvider; action: ActionDefinition }>
         - `register(provider: IActionProvider): void` -- ActionProviderMetadataSchema.parse(provider.metadata) 검증, 이름 중복 시 WAIaaSError('ACTION_NAME_CONFLICT') throw, 각 action에 대해 ActionDefinitionSchema.parse() 검증, inputSchema 덕 타이핑 검증 (typeof action.inputSchema?.parse === 'function' && typeof action.inputSchema?.safeParse === 'function'), actions map에 `${providerName}/${actionName}` 키로 등록
         - `unregister(providerName: string): boolean` -- providers/actions map에서 제거, 반환 boolean
         - `getProvider(name: string): IActionProvider | undefined`
         - `getAction(key: string): { provider: IActionProvider; action: ActionDefinition } | undefined` -- key 형식: `providerName/actionName`
         - `listProviders(): ActionProviderMetadata[]` -- 등록된 모든 프로바이더 metadata 배열
         - `listActions(providerName?: string): { providerName: string; action: ActionDefinition }[]` -- 특정 프로바이더 또는 전체 액션 목록
         - `getMcpExposedActions(): { provider: IActionProvider; action: ActionDefinition }[]` -- mcpExpose=true인 프로바이더의 액션만 반환
         - `async executeResolve(actionKey: string, params: Record<string,unknown>, context: ActionContext): Promise<ContractCallRequest>` -- (1) getAction()으로 조회 (없으면 WAIaaSError('ACTION_NOT_FOUND')), (2) action.inputSchema.parse(params) 입력 검증 (실패시 ACTION_VALIDATION_FAILED), (3) provider.resolve(action.name, params, context) 호출, (4) ContractCallRequestSchema.parse(result) 반환값 재검증 (실패시 ACTION_RETURN_INVALID), (5) 반환
         - `async loadPlugins(actionsDir: string): Promise<{ loaded: string[]; failed: string[] }>` -- readdir로 디렉토리 스캔, 각 하위 디렉토리에 대해 loadSinglePlugin() 호출, 개별 실패 시 warn 로그 + 건너뛰기 (fail-open)
         - `private async loadSinglePlugin(pluginDir: string, pluginName: string): Promise<void>` -- (1) package.json 읽기 (type: "module" 확인), (2) main 필드 또는 index.js 경로 결정, (3) pathToFileURL(mainPath).href로 ESM dynamic import, (4) module.default 추출 (클래스면 new로 인스턴스화, 함수면 호출, 객체면 직접 사용), (5) register()로 등록

    2. `packages/daemon/src/infrastructure/action/index.ts` barrel export 생성:
       - `export { ActionProviderRegistry } from './action-provider-registry.js';`

    3. `packages/daemon/src/__tests__/action-provider-registry.test.ts` 작성:
       - Mock IActionProvider 생성 (metadata + actions + resolve 구현)
       - 테스트 케이스:
         a. register -- 유효한 프로바이더 등록 성공
         b. register -- 이름 중복 거부 (ACTION_NAME_CONFLICT)
         c. register -- metadata 검증 실패 시 에러
         d. register -- inputSchema 덕 타이핑 실패 시 에러
         e. unregister -- 등록된 프로바이더 제거 성공
         f. unregister -- 미등록 프로바이더 false 반환
         g. getProvider -- 등록된 프로바이더 조회
         h. getAction -- providerName/actionName 키로 액션 조회
         i. listProviders -- 전체 프로바이더 metadata 목록
         j. listActions -- 특정 프로바이더 액션 필터링
         k. getMcpExposedActions -- mcpExpose=true만 반환
         l. executeResolve -- 정상 실행 (resolve -> ContractCallRequestSchema.parse)
         m. executeResolve -- 미등록 액션 시 ACTION_NOT_FOUND
         n. executeResolve -- inputSchema 검증 실패 시 ACTION_VALIDATION_FAILED
         o. executeResolve -- resolve() 반환값 스키마 검증 실패 시 ACTION_RETURN_INVALID
       - loadPlugins는 파일 시스템 의존이므로 단위 테스트에서는 register/executeResolve에 집중. loadPlugins 통합 테스트는 Plan 03에서 수행

    기존 daemon 테스트 회귀 확인: `npx vitest run --reporter=verbose` (daemon 패키지 내)
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx vitest run src/__tests__/action-provider-registry.test.ts --reporter=verbose` 전체 통과
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx vitest run --reporter=verbose` 기존 테스트 회귀 없음
  </verify>
  <done>ActionProviderRegistry가 IActionProvider 등록/조회/해제/resolve 실행을 수행하고, ESM 플러그인 로드 로직이 구현되며, 15개 이상 단위 테스트가 통과한다</done>
</task>

</tasks>

<verification>
- packages/core 빌드 통과 (tsc --noEmit)
- IActionProvider, ActionProviderMetadataSchema, ActionDefinitionSchema, ActionContextSchema가 @waiaas/core에서 export됨
- API_KEY_REQUIRED 에러 코드가 error-codes.ts에 존재
- ActionProviderRegistry가 register/unregister/getAction/listProviders/executeResolve/loadPlugins 메서드를 제공
- executeResolve()가 ContractCallRequestSchema.parse()로 반환값을 재검증
- 15개 이상 단위 테스트 통과
- 기존 daemon 테스트 회귀 없음
</verification>

<success_criteria>
IActionProvider 인터페이스가 core 패키지에 Zod SSoT로 정의되고, ActionProviderRegistry가 프로바이더 등록/조회/해제/resolve 실행/ESM 플러그인 로드를 수행하며, 단위 테스트가 모두 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/128-action-provider-api-key/128-01-SUMMARY.md`
</output>
