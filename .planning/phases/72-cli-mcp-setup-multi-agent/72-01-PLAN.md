---
phase: 72-cli-mcp-setup-multi-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/utils/slug.ts
  - packages/cli/src/commands/mcp-setup.ts
  - packages/cli/src/index.ts
  - packages/cli/src/__tests__/slug.test.ts
  - packages/cli/src/__tests__/mcp-setup.test.ts
autonomous: true

must_haves:
  truths:
    - "--agent 지정 시 토큰이 mcp-tokens/<agentId> 경로에 저장되고 config 스니펫에 WAIAAS_AGENT_ID + WAIAAS_AGENT_NAME 환경변수가 포함되며 키 이름이 waiaas-{agentName} 형태이다"
    - "--all 플래그로 전체 에이전트의 토큰을 일괄 생성하고 통합 config 스니펫을 출력한다"
    - "--all + 에이전트 0개 시 에러 메시지를 표시하고, slug 충돌 시 {slug}-{agentId 앞 8자} 접미사를 추가한다"
    - "--agent 미지정 + 에이전트 1개 자동 선택 시에도 새 경로(mcp-tokens/<agentId>)를 사용한다"
  artifacts:
    - path: "packages/cli/src/utils/slug.ts"
      provides: "toSlug utility + resolveSlugCollisions helper"
      exports: ["toSlug", "resolveSlugCollisions"]
    - path: "packages/cli/src/commands/mcp-setup.ts"
      provides: "mcpSetupCommand with --all flag, per-agent token paths, multi-agent config snippets"
      contains: "mcp-tokens"
    - path: "packages/cli/src/index.ts"
      provides: "--all flag wiring in commander"
      contains: "--all"
    - path: "packages/cli/src/__tests__/mcp-setup.test.ts"
      provides: "Tests for all 7 CLIP requirements"
      contains: "mcp-tokens"
  key_links:
    - from: "packages/cli/src/commands/mcp-setup.ts"
      to: "packages/cli/src/utils/slug.ts"
      via: "import { toSlug, resolveSlugCollisions }"
      pattern: "toSlug|resolveSlugCollisions"
    - from: "packages/cli/src/commands/mcp-setup.ts"
      to: "mcp-tokens/<agentId> file path"
      via: "join(dataDir, 'mcp-tokens', agentId)"
      pattern: "mcp-tokens"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/mcp-setup.ts"
      via: "--all option passed as opts.all"
      pattern: "all.*boolean"
---

<objective>
CLI `mcp setup` 명령어를 다중 에이전트 지원으로 확장: 에이전트별 토큰 경로(`mcp-tokens/<agentId>`), config 스니펫에 `WAIAAS_AGENT_ID`/`WAIAAS_AGENT_NAME` 환경변수, `--all` 플래그로 전체 에이전트 일괄 설정, slug 충돌 해결.

Purpose: Phase 71에서 MCP 서버 측 agentId 토큰 경로 분리가 완료되었으므로, 이제 CLI 측에서 에이전트별 토큰 파일을 생성하고 올바른 config 스니펫을 출력하여 다중 에이전트 MCP 워크플로우를 완성한다.
Output: slug.ts 유틸리티, mcp-setup.ts 다중 에이전트 지원, index.ts --all 플래그 연결, 테스트.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/71-mcp-token-path-agent-identity/71-01-SUMMARY.md
@packages/cli/src/commands/mcp-setup.ts
@packages/cli/src/__tests__/mcp-setup.test.ts
@packages/cli/src/index.ts
@packages/mcp/src/session-manager.ts
@packages/mcp/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: slug 유틸리티 + mcp-setup 다중 에이전트 지원 + index.ts --all 플래그</name>
  <files>
    packages/cli/src/utils/slug.ts
    packages/cli/src/commands/mcp-setup.ts
    packages/cli/src/index.ts
  </files>
  <action>
**1. 새 파일: `packages/cli/src/utils/slug.ts`**

slug 유틸리티 두 함수 생성:

```typescript
/**
 * Convert agent name to URL/config-safe slug.
 * - lowercase
 * - non-alphanumeric/non-hyphen → hyphen
 * - collapse consecutive hyphens
 * - trim leading/trailing hyphens
 * - fallback to 'agent' if result is empty
 */
export function toSlug(name: string): string {
  const slug = name
    .toLowerCase()
    .replace(/[^a-z0-9-]/g, '-')
    .replace(/-{2,}/g, '-')
    .replace(/^-|-$/g, '');
  return slug || 'agent';
}

/**
 * Resolve slug collisions for a list of agents.
 * Returns Map<agentId, resolvedSlug>.
 *
 * If two or more agents produce the same slug, append `-{agentId first 8 chars}`.
 * Example: "trading-bot" collides → "trading-bot-01929abc"
 */
export function resolveSlugCollisions(
  agents: Array<{ id: string; name?: string | null }>,
): Map<string, string> {
  // Step 1: compute raw slugs
  const entries = agents.map((a) => ({
    id: a.id,
    slug: toSlug(a.name ?? a.id),
  }));

  // Step 2: detect collisions (count occurrences per slug)
  const slugCounts = new Map<string, number>();
  for (const e of entries) {
    slugCounts.set(e.slug, (slugCounts.get(e.slug) ?? 0) + 1);
  }

  // Step 3: resolve collisions
  const result = new Map<string, string>();
  for (const e of entries) {
    if (slugCounts.get(e.slug)! > 1) {
      result.set(e.id, `${e.slug}-${e.id.slice(0, 8)}`);
    } else {
      result.set(e.id, e.slug);
    }
  }

  return result;
}
```

**2. `packages/cli/src/commands/mcp-setup.ts` 수정**

`McpSetupOptions` 인터페이스에 `all?: boolean` 필드 추가.

`import { toSlug, resolveSlugCollisions } from '../utils/slug.js'` 추가.

**핵심 변경사항:**

A) **에이전트별 토큰 경로 (CLIP-01, CLIP-07):**
Step 5의 토큰 파일 경로를 변경:
- 기존: `join(opts.dataDir, 'mcp-token')`
- 변경: `join(opts.dataDir, 'mcp-tokens', agentId)` -- agentId는 항상 존재함 (자동 감지 포함).

B) **config 스니펫 변경 (CLIP-02, CLIP-03):**
Step 7의 config 스니펫 키와 env를 변경:
- 키 이름: `waiaas-wallet` → `waiaas-{slug}` (slug = toSlug(agentName ?? agentId)).
- env에 `WAIAAS_AGENT_ID: agentId`와 `WAIAAS_AGENT_NAME: agentName` 추가 (agentName이 있을 때만 WAIAAS_AGENT_NAME 포함).
- agentName은 Step 3에서 agents API 응답의 `name` 필드에서 가져옴. `--agent` 옵션으로 ID 직접 지정 시에도 GET /v1/agents/{id}로 이름 조회 (또는 GET /v1/agents 전체 목록에서 찾기).

**구체적인 변경:**

Step 3 (Resolve agent ID) 수정:
- `--agent` 직접 지정 시에도 에이전트 이름을 가져오기 위해 `GET /v1/agents` 호출 필요. 이미 auto-detect에서 호출하고 있으므로 통합.
- `agentId`와 함께 `agentName`도 변수로 관리: `let agentName: string | undefined`.
- auto-detect (단일 에이전트) 시: `agentName = agents[0]?.name ?? undefined`.
- `--agent` 지정 시: agents 목록을 가져와서 `agentName = agents.find(a => a.id === agentId)?.name ?? undefined`. 에이전트 이름 조회 실패(에이전트 미발견)해도 에러가 아님 -- 이름 없이 진행.

C) **`--all` 플래그 (CLIP-04, CLIP-05, CLIP-06):**
`opts.all` === true일 때의 분기 추가 (Step 3 이후, 기존 단일 에이전트 플로우와 분리):

```
if (opts.all) {
  // 1. 에이전트 목록 조회 (GET /v1/agents)
  // 2. agents.length === 0 → 에러: "Error: No agents found. Run waiaas init first." + process.exit(1)
  // 3. slug 충돌 해결: resolveSlugCollisions(agents)
  // 4. 각 에이전트에 대해:
  //    a. POST /v1/sessions (agentId, expiresIn)
  //    b. 토큰 파일 저장: join(dataDir, 'mcp-tokens', agent.id)
  //    c. console.log 성공 메시지
  // 5. 통합 config 스니펫 출력: 모든 에이전트의 mcpServers 합친 JSON
  // 6. 플랫폼별 config 경로 출력
  return;  // --all 시 단일 에이전트 플로우 스킵
}
```

통합 config 스니펫 형태 (CLIP-04):
```json
{
  "mcpServers": {
    "waiaas-trading-bot": {
      "command": "npx",
      "args": ["@waiaas/mcp"],
      "env": {
        "WAIAAS_DATA_DIR": "/path/to/data",
        "WAIAAS_BASE_URL": "http://127.0.0.1:3100",
        "WAIAAS_AGENT_ID": "agent-1-uuid",
        "WAIAAS_AGENT_NAME": "trading-bot"
      }
    },
    "waiaas-research-bot": {
      "command": "npx",
      "args": ["@waiaas/mcp"],
      "env": {
        "WAIAAS_DATA_DIR": "/path/to/data",
        "WAIAAS_BASE_URL": "http://127.0.0.1:3100",
        "WAIAAS_AGENT_ID": "agent-2-uuid",
        "WAIAAS_AGENT_NAME": "research-bot"
      }
    }
  }
}
```

D) **함수 구조 리팩터링:**

내부 헬퍼 함수를 추출하여 코드 중복 방지:

```typescript
// 에이전트 목록 조회 (재사용)
async function fetchAgents(baseUrl: string, password: string): Promise<Array<{ id: string; name?: string }>>

// 단일 에이전트 세션 생성 + 토큰 파일 저장
async function setupAgent(opts: {
  baseUrl: string;
  dataDir: string;
  password: string;
  agentId: string;
  expiresIn: number;
}): Promise<{ token: string; expiresAt: number }>

// config 스니펫 항목 생성
function buildConfigEntry(opts: {
  slug: string;
  dataDir: string;
  baseUrl: string;
  agentId: string;
  agentName?: string;
}): Record<string, unknown>
```

E) **플랫폼별 config 경로 출력 함수 추출:**

현재 인라인인 platform 분기를 `printConfigPath()` 함수로 추출. --all과 단일 에이전트 모두에서 재사용.

**3. `packages/cli/src/index.ts` 수정**

mcp setup 커맨드에 `--all` 옵션 추가:
```typescript
.option('--all', 'Set up all agents at once')
```

action 핸들러에서 `opts.all`을 `mcpSetupCommand`에 전달:
```typescript
all: opts.all ?? false,
```

**중요: `--all`과 `--agent`가 동시 지정되면 에러 처리:**
```typescript
if (opts.all && opts.agent) {
  console.error('Error: Cannot use --all with --agent');
  process.exit(1);
}
```
이 검증은 `mcpSetupCommand` 시작부에 추가.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/cli build` 실행하여 타입 체크 + 빌드 성공 확인.
  </verify>
  <done>
- slug.ts: toSlug + resolveSlugCollisions 유틸리티 구현.
- mcp-setup.ts: 에이전트별 토큰 경로(mcp-tokens/<agentId>), config 스니펫에 WAIAAS_AGENT_ID/WAIAAS_AGENT_NAME 포함, --all 일괄 설정, slug 충돌 해결.
- index.ts: --all 옵션 연결.
- 빌드 성공.
  </done>
</task>

<task type="auto">
  <name>Task 2: slug 유닛 테스트 + mcp-setup 통합 테스트 (7개 CLIP 요구사항)</name>
  <files>
    packages/cli/src/__tests__/slug.test.ts
    packages/cli/src/__tests__/mcp-setup.test.ts
  </files>
  <action>
**1. 새 파일: `packages/cli/src/__tests__/slug.test.ts`**

```typescript
describe('toSlug', () => {
  // 기본 변환
  it('lowercase + 특수문자 → hyphen', () => {
    expect(toSlug('Trading Bot')).toBe('trading-bot');
  });
  it('연속 하이픈 축약', () => {
    expect(toSlug('my--bot')).toBe('my-bot');
  });
  it('앞뒤 하이픈 제거', () => {
    expect(toSlug('-bot-')).toBe('bot');
  });
  it('빈 문자열 → agent 기본값', () => {
    expect(toSlug('')).toBe('agent');
  });
  it('특수문자만 → agent 기본값', () => {
    expect(toSlug('!!!')).toBe('agent');
  });
  it('한글 이름 처리', () => {
    expect(toSlug('트레이딩봇')).toBe('agent'); // 비 ASCII → 하이픈 → 축약 → 빈 → agent
  });
});

describe('resolveSlugCollisions', () => {
  it('충돌 없으면 slug 그대로', () => {
    const agents = [
      { id: '01929abc-1111-7000-8000-000000000001', name: 'trading-bot' },
      { id: '01929abc-2222-7000-8000-000000000002', name: 'research-bot' },
    ];
    const result = resolveSlugCollisions(agents);
    expect(result.get(agents[0].id)).toBe('trading-bot');
    expect(result.get(agents[1].id)).toBe('research-bot');
  });

  it('충돌 시 {slug}-{agentId 앞 8자} 접미사', () => {
    const agents = [
      { id: '01929abc-1111-7000-8000-000000000001', name: 'bot' },
      { id: '01929def-2222-7000-8000-000000000002', name: 'bot' },
    ];
    const result = resolveSlugCollisions(agents);
    expect(result.get(agents[0].id)).toBe('bot-01929abc');
    expect(result.get(agents[1].id)).toBe('bot-01929def');
  });

  it('name 없으면 id를 slug 소스로', () => {
    const agents = [
      { id: 'abc12345-xxxx', name: null },
    ];
    const result = resolveSlugCollisions(agents);
    expect(result.get(agents[0].id)).toBe('abc12345-xxxx');
  });
});
```

**2. `packages/cli/src/__tests__/mcp-setup.test.ts` 확장**

기존 11개 테스트 유지 + 아래 신규 테스트 추가.

기존 테스트 중 토큰 파일 경로를 검증하는 테스트들의 경로 기대값 변경 필요:
- `join(testDir, 'mcp-token')` → `join(testDir, 'mcp-tokens', 'agent-1')` (auto-detect 시에도 agentId 경로 사용)
- 기존 `createSuccessFetchMock` 헬퍼가 반환하는 agents 응답에 `name` 필드가 이미 있으므로 (`name: 'Test Agent'`), config 스니펫의 키 이름이 `waiaas-test-agent`로 변경됨을 반영.

**기존 테스트 수정 사항:**

a) `successful setup flow` 테스트:
- `tokenPath` 검증: `join(testDir, 'mcp-tokens', 'agent-1')` 경로로 변경.
- config 스니펫 키: `waiaas-test-agent` (toSlug('Test Agent') = 'test-agent').

b) `mcp-token file written with correct content` 테스트:
- `tokenPath` 경로 변경: `join(testDir, 'mcp-tokens', 'agent-1')`.

c) `config.json snippet output format` 테스트:
- 키 이름: `waiaas-test-agent`.
- env에 `WAIAAS_AGENT_ID`, `WAIAAS_AGENT_NAME` 포함 확인.

d) `file atomic write (tmp + rename pattern)` 테스트:
- `tokenPath` 경로 변경.

e) `--agent flag passed to session creation` 테스트:
- fetchMock에 `/v1/agents` 응답 추가 (이름 조회용). `--agent` 지정 시에도 agents 목록을 조회할 수 있어야 함.
- `tokenPath` 경로 변경: `join(testDir, 'mcp-tokens', 'my-custom-agent')`.

**신규 테스트 추가:**

1. **CLIP-01: --agent 지정 시 mcp-tokens/<agentId> 경로에 저장**:
   - `agent: 'specific-agent-id'` 옵션으로 실행.
   - 토큰 파일이 `join(testDir, 'mcp-tokens', 'specific-agent-id')` 경로에 존재 확인.
   - 기존 `join(testDir, 'mcp-token')` 경로에는 파일 없음 확인.

2. **CLIP-02: config 스니펫에 WAIAAS_AGENT_ID + WAIAAS_AGENT_NAME 포함**:
   - 실행 후 출력된 JSON 파싱.
   - `env.WAIAAS_AGENT_ID === 'agent-1'` 확인.
   - `env.WAIAAS_AGENT_NAME === 'Test Agent'` 확인.

3. **CLIP-03: config 키 이름이 waiaas-{agentName}**:
   - name이 'My Trading Bot'인 에이전트로 실행.
   - config 스니펫의 키가 `waiaas-my-trading-bot`인지 확인.

4. **CLIP-04: --all 플래그로 전체 에이전트 일괄 생성 + 통합 config**:
   - 에이전트 2개 (agent-1 'Alpha', agent-2 'Beta') 응답 mock.
   - sessions POST 2번 호출 확인.
   - 토큰 파일 2개 생성 확인: `mcp-tokens/agent-1`, `mcp-tokens/agent-2`.
   - config 스니펫에 `waiaas-alpha`, `waiaas-beta` 두 키 존재 확인.
   - 각 entry에 해당 `WAIAAS_AGENT_ID` + `WAIAAS_AGENT_NAME` 존재 확인.

5. **CLIP-05: --all + 에이전트 0개 시 에러**:
   - agents 응답: `{ items: [] }`.
   - `process.exit(1)` + 에러 메시지 'No agents found' 확인.

6. **CLIP-06: --all + slug 충돌 시 접미사**:
   - 에이전트 2개, 동일 이름 'Bot':
     - `{ id: '01929abc-1111-7000-8000-000000000001', name: 'Bot' }`
     - `{ id: '01929def-2222-7000-8000-000000000002', name: 'Bot' }`
   - config 스니펫에 `waiaas-bot-01929abc`, `waiaas-bot-01929def` 두 키 존재 확인.

7. **CLIP-07: --agent 미지정 + 자동 선택 시에도 새 경로 사용**:
   - 에이전트 1개 자동 감지 (기존 auto-detect 시나리오).
   - 토큰 파일이 `join(testDir, 'mcp-tokens', 'agent-1')` 경로에 존재 확인.
   - `join(testDir, 'mcp-token')` 경로에는 파일 없음 확인.

8. **--all + --agent 동시 지정 시 에러**:
   - `all: true, agent: 'some-id'` 옵션.
   - `process.exit(1)` + 'Cannot use --all with --agent' 에러 메시지 확인.

**테스트에서 주의할 점:**
- `vi.doMock`으로 동적 import하므로, 각 테스트에서 `await import('../commands/mcp-setup.js')`를 사용.
- `--all` 테스트에서는 sessions POST를 여러 번 호출하므로 fetchMock에서 호출 횟수에 따라 다른 토큰을 반환하거나, 동일 토큰으로 처리.
- `existsSync`, `readFileSync`로 파일 시스템 검증 (실제 tmpdir 사용이므로 mock 아님).
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/cli test` 실행하여 기존 + 신규 테스트 모두 통과 확인.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/cli build` 실행하여 빌드 성공 확인.
  </verify>
  <done>
- slug.test.ts: toSlug 6개 + resolveSlugCollisions 3개 = 9개 테스트 통과.
- mcp-setup.test.ts: 기존 11개 수정 + 신규 8개 = 19개 테스트 통과.
- CLIP-01 ~ CLIP-07 모든 요구사항 테스트 커버.
- 빌드 성공, regression 없음.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/cli test` -- 전체 테스트 통과 (기존 수정 + 신규)
2. `pnpm --filter @waiaas/cli build` -- 타입 체크 + 빌드 성공
3. 수동 확인: 테스트에서 CLIP-01~07 모든 요구사항이 커버되는지 테스트 이름으로 확인
</verification>

<success_criteria>
- CLIP-01: `--agent` 지정 시 `mcp-tokens/<agentId>` 경로에 토큰 저장
- CLIP-02: config 스니펫에 `WAIAAS_AGENT_ID` + `WAIAAS_AGENT_NAME` 환경변수 포함
- CLIP-03: config 키 이름이 `waiaas-{agentName}` 형태
- CLIP-04: `--all` 플래그로 전체 에이전트 일괄 생성 + 통합 config 스니펫
- CLIP-05: `--all` + 에이전트 0개 시 에러 메시지
- CLIP-06: `--all` + slug 충돌 시 `{slug}-{agentId 앞 8자}` 접미사
- CLIP-07: `--agent` 미지정 + 자동 선택 시에도 새 경로 사용
- 기존 테스트 regression 없음
</success_criteria>

<output>
After completion, create `.planning/phases/72-cli-mcp-setup-multi-agent/72-01-SUMMARY.md`
</output>
