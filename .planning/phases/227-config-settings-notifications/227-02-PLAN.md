---
phase: 227-config-settings-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/enums/notification.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/core/src/__tests__/enums.test.ts
  - packages/daemon/src/services/incoming/incoming-tx-monitor-service.ts
  - packages/daemon/src/services/incoming/__tests__/incoming-tx-monitor-service.test.ts
  - packages/daemon/src/notifications/notification-service.ts
  - packages/admin/src/pages/settings.tsx
autonomous: true
requirements:
  - EVT-02
  - EVT-06

must_haves:
  truths:
    - "NOTIFICATION_EVENT_TYPES array has 30 entries (28 existing + TX_INCOMING + TX_INCOMING_SUSPICIOUS)"
    - "en.ts and ko.ts both have TX_INCOMING and TX_INCOMING_SUSPICIOUS notification templates with {title, body}"
    - "IncomingTxMonitorService uses 'TX_INCOMING' and 'TX_INCOMING_SUSPICIOUS' canonical names instead of 'INCOMING_TX_DETECTED'/'INCOMING_TX_SUSPICIOUS' string literals"
    - "TX_INCOMING_SUSPICIOUS is in BROADCAST_EVENTS for all-channel delivery"
    - "Admin UI Settings page renders an IncomingSettings component with 7 form fields"
    - "enums.test.ts count assertion updated from 28 to 30"
  artifacts:
    - path: "packages/core/src/enums/notification.ts"
      provides: "TX_INCOMING and TX_INCOMING_SUSPICIOUS enum values"
      contains: "TX_INCOMING"
    - path: "packages/core/src/i18n/en.ts"
      provides: "English notification templates for incoming TX"
      contains: "TX_INCOMING:"
    - path: "packages/core/src/i18n/ko.ts"
      provides: "Korean notification templates for incoming TX"
      contains: "TX_INCOMING:"
    - path: "packages/daemon/src/notifications/notification-service.ts"
      provides: "TX_INCOMING_SUSPICIOUS in BROADCAST_EVENTS"
      contains: "TX_INCOMING_SUSPICIOUS"
    - path: "packages/daemon/src/services/incoming/incoming-tx-monitor-service.ts"
      provides: "Canonical notification type names (no more string literals)"
      contains: "TX_INCOMING_SUSPICIOUS"
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "IncomingSettings UI component"
      contains: "IncomingSettings"
  key_links:
    - from: "packages/core/src/enums/notification.ts"
      to: "packages/core/src/i18n/en.ts"
      via: "Record<NotificationEventType, {title, body}> type enforcement"
      pattern: "TX_INCOMING"
    - from: "packages/daemon/src/services/incoming/incoming-tx-monitor-service.ts"
      to: "packages/daemon/src/notifications/notification-service.ts"
      via: "notify(eventType, walletId, vars) call with canonical type names"
      pattern: "TX_INCOMING"
---

<objective>
Add TX_INCOMING and TX_INCOMING_SUSPICIOUS to NotificationEventType enum, create en/ko i18n templates, fix monitor service notification type names from string literals to canonical enum values, add TX_INCOMING_SUSPICIOUS to BROADCAST_EVENTS, and add IncomingSettings component to Admin UI.

Purpose: Enables 4-channel notification delivery for incoming transactions and gives operators UI control over incoming monitoring settings.
Output: 30 notification event types with complete i18n coverage, type-safe monitor service notification calls, broadcast delivery for suspicious TX alerts, and Admin UI settings panel.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/227-config-settings-notifications/227-RESEARCH.md
@packages/core/src/enums/notification.ts
@packages/core/src/i18n/en.ts
@packages/core/src/i18n/ko.ts
@packages/core/src/__tests__/enums.test.ts
@packages/daemon/src/services/incoming/incoming-tx-monitor-service.ts
@packages/daemon/src/services/incoming/__tests__/incoming-tx-monitor-service.test.ts
@packages/daemon/src/notifications/notification-service.ts
@packages/admin/src/pages/settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NotificationEventType entries + i18n templates + BROADCAST_EVENTS + fix monitor service</name>
  <files>
    packages/core/src/enums/notification.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/core/src/__tests__/enums.test.ts
    packages/daemon/src/notifications/notification-service.ts
    packages/daemon/src/services/incoming/incoming-tx-monitor-service.ts
    packages/daemon/src/services/incoming/__tests__/incoming-tx-monitor-service.test.ts
  </files>
  <action>
**Step 1: Add enum values** (packages/core/src/enums/notification.ts)
Add `'TX_INCOMING'` and `'TX_INCOMING_SUSPICIOUS'` to the NOTIFICATION_EVENT_TYPES array, after `'UPDATE_AVAILABLE'` (at the end, before `] as const`). This brings the total from 28 to 30. Update the comment from "28 total" to "30 total".

**Step 2: Add English templates** (packages/core/src/i18n/en.ts)
Add after the `UPDATE_AVAILABLE` entry in the `notifications` object:
```typescript
TX_INCOMING: { title: 'Incoming Transaction Detected', body: 'Wallet {walletId} received {amount} from {fromAddress} on {chain} {display_amount}' },
TX_INCOMING_SUSPICIOUS: { title: 'Suspicious Incoming Transaction', body: 'Wallet {walletId} received suspicious transaction: {amount} from {fromAddress}. Reasons: {reasons} {display_amount}' },
```
Update the comment "22 event types" to "30 event types".

**Step 3: Add Korean templates** (packages/core/src/i18n/ko.ts)
Add after the `UPDATE_AVAILABLE` entry:
```typescript
TX_INCOMING: { title: '수신 트랜잭션 감지', body: '지갑 {walletId}이(가) {chain}에서 {fromAddress}로부터 {amount}을(를) 수신했습니다 {display_amount}' },
TX_INCOMING_SUSPICIOUS: { title: '의심스러운 수신 트랜잭션', body: '지갑 {walletId}에 의심스러운 입금 감지: {fromAddress}로부터 {amount}. 사유: {reasons} {display_amount}' },
```
Update the comment "22 event types" to "30 event types".

**Step 4: Update enums.test.ts** (packages/core/src/__tests__/enums.test.ts)
Change line 103 test name from 'NotificationEventType has 28 values' to 'NotificationEventType has 30 values'.
Change line 104 assertion from `.toHaveLength(28)` to `.toHaveLength(30)`.

**Step 5: Add TX_INCOMING_SUSPICIOUS to BROADCAST_EVENTS** (packages/daemon/src/notifications/notification-service.ts)
Add `'TX_INCOMING_SUSPICIOUS'` to the BROADCAST_EVENTS Set (line ~21, after 'AUTO_STOP_TRIGGERED'). This ensures suspicious incoming TX alerts are sent to ALL notification channels simultaneously.

**Step 6: Fix monitor service notification type names** (packages/daemon/src/services/incoming/incoming-tx-monitor-service.ts)
Around lines 296-304, replace:
```typescript
const eventType = isSuspicious
  ? 'INCOMING_TX_SUSPICIOUS'
  : 'INCOMING_TX_DETECTED';
if (!this.isCooldownActive(tx.walletId, eventType)) {
  this.notificationService?.notify(
    eventType as any,
    tx.walletId,
    { txHash: tx.txHash, amount: tx.amount, chain: tx.chain },
  );
```
With:
```typescript
const eventType = isSuspicious
  ? 'TX_INCOMING_SUSPICIOUS' as const
  : 'TX_INCOMING' as const;
if (!this.isCooldownActive(tx.walletId, eventType)) {
  this.notificationService?.notify(
    eventType,
    tx.walletId,
    {
      walletId: tx.walletId,
      txHash: tx.txHash,
      amount: tx.amount,
      fromAddress: tx.fromAddress,
      chain: tx.chain,
      display_amount: '',
      ...(isSuspicious && suspiciousReasons ? { reasons: suspiciousReasons.join(', ') } : {}),
    },
  );
```
Note: Remove the `as any` cast -- the type should now be assignable since TX_INCOMING/TX_INCOMING_SUSPICIOUS are in the enum. Also expand the vars object to include walletId, fromAddress, and reasons (for suspicious) to match the i18n template placeholders.

**Step 7: Fix monitor service test** (packages/daemon/src/services/incoming/__tests__/incoming-tx-monitor-service.test.ts)
Find the cooldown test at line ~529 that references `'wallet-001:INCOMING_TX_DETECTED'` and change it to `'wallet-001:TX_INCOMING'`. Also search for any other occurrences of `INCOMING_TX_DETECTED` or `INCOMING_TX_SUSPICIOUS` in the test file and replace with `TX_INCOMING` or `TX_INCOMING_SUSPICIOUS` respectively.
  </action>
  <verify>
Run in sequence:
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/core --filter=@waiaas/daemon`
2. `pnpm vitest run packages/core/src/__tests__/enums.test.ts`
3. `pnpm vitest run packages/daemon/src/services/incoming/__tests__/incoming-tx-monitor-service.test.ts`

All must pass. No `as any` casts on notification type names should remain in the monitor service.
  </verify>
  <done>NOTIFICATION_EVENT_TYPES has 30 entries. en.ts and ko.ts both have TX_INCOMING and TX_INCOMING_SUSPICIOUS templates. Monitor service uses canonical type names without `as any`. TX_INCOMING_SUSPICIOUS is in BROADCAST_EVENTS. Enums test passes with count=30. Monitor service tests pass with updated type names.</done>
</task>

<task type="auto">
  <name>Task 2: Add IncomingSettings component to Admin UI Settings page</name>
  <files>packages/admin/src/pages/settings.tsx</files>
  <action>
Add an `IncomingSettings()` function component to `settings.tsx`, following the pattern established by `SigningSDKSettings()` (lines 722-849) and `MonitoringSettings()`.

The component should render a collapsible settings section with 7 form fields matching the incoming.* setting keys:

```tsx
function IncomingSettings() {
  return (
    <div class="settings-category">
      <div class="settings-category-header">
        <h3>Incoming Transaction Monitoring</h3>
        <p class="settings-description">
          Monitor incoming transactions to wallets. Detects native and token transfers,
          flags suspicious activity (dust attacks, large amounts, unknown tokens).
        </p>
      </div>
      <div class="settings-category-body">
        <div class="settings-fields-grid">
          <FormField
            label="Monitoring Enabled"
            name="incoming.enabled"
            type="select"
            value={getEffectiveValue('incoming', 'enabled') || 'false'}
            onChange={(v) => handleFieldChange('incoming.enabled', v)}
            options={[
              { label: 'Yes', value: 'true' },
              { label: 'No', value: 'false' },
            ]}
          />
          <FormField
            label="Poll Interval (seconds)"
            name="incoming.poll_interval"
            type="number"
            value={Number(getEffectiveValue('incoming', 'poll_interval')) || 30}
            onChange={(v) => handleFieldChange('incoming.poll_interval', v)}
            min={5}
            max={3600}
          />
          <FormField
            label="Retention Days"
            name="incoming.retention_days"
            type="number"
            value={Number(getEffectiveValue('incoming', 'retention_days')) || 90}
            onChange={(v) => handleFieldChange('incoming.retention_days', v)}
            min={1}
            max={365}
          />
          <FormField
            label="Suspicious Dust USD Threshold"
            name="incoming.suspicious_dust_usd"
            type="number"
            value={Number(getEffectiveValue('incoming', 'suspicious_dust_usd')) || 0.01}
            onChange={(v) => handleFieldChange('incoming.suspicious_dust_usd', v)}
            min={0}
            max={1000}
          />
          <FormField
            label="Suspicious Amount Multiplier"
            name="incoming.suspicious_amount_multiplier"
            type="number"
            value={Number(getEffectiveValue('incoming', 'suspicious_amount_multiplier')) || 10}
            onChange={(v) => handleFieldChange('incoming.suspicious_amount_multiplier', v)}
            min={1}
            max={1000}
          />
          <FormField
            label="Notification Cooldown (minutes)"
            name="incoming.cooldown_minutes"
            type="number"
            value={Number(getEffectiveValue('incoming', 'cooldown_minutes')) || 5}
            onChange={(v) => handleFieldChange('incoming.cooldown_minutes', v)}
            min={1}
            max={1440}
          />
          <FormField
            label="WebSocket URL (optional)"
            name="incoming.wss_url"
            type="text"
            value={getEffectiveValue('incoming', 'wss_url')}
            onChange={(v) => handleFieldChange('incoming.wss_url', v)}
            placeholder="wss://custom-rpc.example.com"
          />
        </div>
        <div class="settings-info-box">
          Monitors wallets with incoming monitoring enabled for incoming transactions.
          Uses WebSocket subscription when available, falls back to polling.
          Suspicious transactions (dust attacks, unusually large amounts, unknown tokens)
          trigger broadcast alerts to all notification channels.
          Changes take effect immediately via hot-reload.
        </div>
      </div>
    </div>
  );
}
```

Then add `<IncomingSettings />` to the main render section, after `<MonitoringSettings />` (around line 1156, before the closing `</>` of the loading conditional). The render order should be:
```
...
<AutoStopSettings />
<MonitoringSettings />
<IncomingSettings />
```
  </action>
  <verify>
Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/admin`
TypeScript/Preact compilation must pass.
  </verify>
  <done>Admin UI Settings page renders IncomingSettings component with 7 form fields (enabled, poll_interval, retention_days, suspicious_dust_usd, suspicious_amount_multiplier, cooldown_minutes, wss_url). Component uses existing getEffectiveValue/handleFieldChange pattern. TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck` passes for @waiaas/core, @waiaas/daemon, and @waiaas/admin
2. `pnpm vitest run packages/core/src/__tests__/enums.test.ts` passes (30 event types)
3. `pnpm vitest run packages/daemon/src/services/incoming/__tests__/incoming-tx-monitor-service.test.ts` passes
4. No `as any` casts on notification event type strings remain in incoming-tx-monitor-service.ts
5. BROADCAST_EVENTS includes TX_INCOMING_SUSPICIOUS
6. en.ts and ko.ts both have TX_INCOMING and TX_INCOMING_SUSPICIOUS entries
7. Admin UI settings.tsx renders IncomingSettings component
</verification>

<success_criteria>
- NOTIFICATION_EVENT_TYPES has exactly 30 entries
- en.ts and ko.ts have type-safe TX_INCOMING and TX_INCOMING_SUSPICIOUS templates with variable placeholders
- Monitor service calls notify() with canonical enum values (no `as any`)
- TX_INCOMING_SUSPICIOUS triggers broadcast to all 4 channels
- Admin UI has IncomingSettings section with 7 form fields for runtime configuration
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/227-config-settings-notifications/227-02-SUMMARY.md`
</output>
