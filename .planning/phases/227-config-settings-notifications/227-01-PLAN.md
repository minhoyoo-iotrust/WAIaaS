---
phase: 227-config-settings-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/__tests__/config-loader.test.ts
autonomous: true
requirements:
  - CFG-01
  - CFG-02
  - CFG-03
  - CFG-05

must_haves:
  truths:
    - "config.toml [incoming] section with 7 keys is parsed and validated by Zod schema with correct defaults"
    - "Unknown [incoming] section no longer rejected by detectNestedSections"
    - "WAIAAS_INCOMING_ENABLED=true env var overrides config.toml incoming.enabled to true"
    - "All 7 incoming.* setting keys in setting-keys.ts have matching counterparts in DaemonConfigSchema"
    - "HotReloadOrchestrator incoming.* change detection (from Phase 226-04) still works with the new config section"
  artifacts:
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "DaemonConfigSchema incoming section + KNOWN_SECTIONS entry"
      contains: "incoming:"
    - path: "packages/daemon/src/__tests__/config-loader.test.ts"
      provides: "Config loader tests for [incoming] section"
      contains: "[incoming] section"
  key_links:
    - from: "packages/daemon/src/infrastructure/config/loader.ts"
      to: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      via: "configPath mapping (incoming.enabled -> config.incoming.enabled)"
      pattern: "incoming\\."
---

<objective>
Add the `[incoming]` section to DaemonConfigSchema with 7 keys (enabled, poll_interval, retention_days, suspicious_dust_usd, suspicious_amount_multiplier, cooldown_minutes, wss_url), add 'incoming' to KNOWN_SECTIONS, and verify CFG-02/CFG-03 (already done in Phase 226-04). Write config-loader tests for the new section.

Purpose: Without the config.toml schema, operators cannot configure incoming TX monitoring via config.toml or WAIAAS_INCOMING_* env vars, even though the SettingsService keys already exist.
Output: Working config.toml [incoming] section with Zod validation, env override support, and passing tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/227-config-settings-notifications/227-RESEARCH.md
@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/__tests__/config-loader.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add incoming section to DaemonConfigSchema and KNOWN_SECTIONS</name>
  <files>packages/daemon/src/infrastructure/config/loader.ts</files>
  <action>
1. Add the `incoming` section to `DaemonConfigSchema` z.object(), after the `telegram` section. Use these exact Zod definitions matching setting-keys.ts defaults:

```typescript
incoming: z
  .object({
    enabled: z.boolean().default(false),
    poll_interval: z.number().int().min(5).max(3600).default(30),
    retention_days: z.number().int().min(1).max(365).default(90),
    suspicious_dust_usd: z.number().min(0).max(1000).default(0.01),
    suspicious_amount_multiplier: z.number().min(1).max(1000).default(10),
    cooldown_minutes: z.number().int().min(1).max(1440).default(5),
    wss_url: z.string().default(''),
  })
  .default({}),
```

2. Add `'incoming'` to the KNOWN_SECTIONS array (after 'telegram').

3. Update the section count comment from "10 sections" to "11 sections" in the Zod schema header comment.

IMPORTANT: The 7 keys here MUST match setting-keys.ts lines 144-152 exactly (key names and default values). Do NOT add a `mode` key -- the requirements doc mentions `mode` but setting-keys.ts uses `cooldown_minutes` instead (the subscriber auto-detects WS vs polling). Follow setting-keys.ts as SSoT.
  </action>
  <verify>
Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/daemon`
TypeScript compilation must pass with the new schema section.
  </verify>
  <done>DaemonConfigSchema has an `incoming` z.object() section with 7 keys and correct defaults, and 'incoming' is in KNOWN_SECTIONS. TypeScript compiles successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Add config-loader tests for [incoming] section + verify CFG-02/CFG-03</name>
  <files>packages/daemon/src/__tests__/config-loader.test.ts</files>
  <action>
Add a new `describe('[incoming] section', () => { ... })` block to config-loader.test.ts with the following tests:

1. **loads [incoming] section with defaults** -- Call loadConfig() with no config.toml. Assert:
   - `config.incoming.enabled` === `false`
   - `config.incoming.poll_interval` === `30`
   - `config.incoming.retention_days` === `90`
   - `config.incoming.suspicious_dust_usd` === `0.01`
   - `config.incoming.suspicious_amount_multiplier` === `10`
   - `config.incoming.cooldown_minutes` === `5`
   - `config.incoming.wss_url` === `''`

2. **config.toml [incoming] section accepted** -- Write a config.toml with `[incoming]\nenabled = true\npoll_interval = 60\n`. Load and assert enabled=true, poll_interval=60, retention_days=90 (default).

3. **WAIAAS_INCOMING_ENABLED=true overrides** -- Set `process.env.WAIAAS_INCOMING_ENABLED = 'true'`. Load config. Assert `config.incoming.enabled` === `true`. Clean up env var after.

4. **WAIAAS_INCOMING_POLL_INTERVAL overrides** -- Set `process.env.WAIAAS_INCOMING_POLL_INTERVAL = '120'`. Load config. Assert `config.incoming.poll_interval` === `120`. Clean up env var.

5. **Zod rejects invalid poll_interval** -- Write config.toml with `[incoming]\npoll_interval = 2\n`. Assert loadConfig() throws (min is 5).

Follow existing test patterns in the file (use the same temp dir helpers, beforeEach/afterEach cleanup for env vars).

Additionally, add 2 verification-only tests:

6. **CFG-02 verify: incoming keys registered in setting-keys** -- Import `SETTING_DEFINITIONS` and assert that keys starting with 'incoming.' total exactly 7.

7. **CFG-03 verify: HotReload has incoming key detection** -- Read `hot-reload.ts` and grep for `INCOMING_KEYS_PREFIX` (or import the constant if exported). This is a simple assertion that the constant exists in the module. If not easily importable, a comment-only verification is acceptable -- just note in the test that CFG-03 was verified by code review of Phase 226-04 SUMMARY.
  </action>
  <verify>
Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/config-loader.test.ts`
All tests including new [incoming] section tests must pass.
  </verify>
  <done>Config-loader test suite has 5+ new tests covering [incoming] defaults, config.toml parsing, env override, Zod validation, and CFG-02/CFG-03 verification. All tests pass.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` passes
2. `pnpm vitest run packages/daemon/src/__tests__/config-loader.test.ts` passes
3. DaemonConfigSchema includes `incoming` section with 7 keys
4. KNOWN_SECTIONS includes 'incoming'
5. Defaults in DaemonConfigSchema match setting-keys.ts defaults exactly
</verification>

<success_criteria>
- config.toml `[incoming]` section is Zod-validated with 7 keys matching setting-keys.ts
- `WAIAAS_INCOMING_*` env vars automatically override config values (via KNOWN_SECTIONS entry)
- All 7 tests pass covering defaults, TOML parsing, env override, validation, and cross-verification of CFG-02/CFG-03
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/227-config-settings-notifications/227-01-SUMMARY.md`
</output>
