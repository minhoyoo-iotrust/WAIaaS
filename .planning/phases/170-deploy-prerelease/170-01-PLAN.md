---
phase: 170-deploy-prerelease
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - release-please-config.json
  - packages/admin/package.json
  - packages/core/package.json
  - packages/daemon/package.json
  - packages/cli/package.json
  - packages/sdk/package.json
  - packages/mcp/package.json
  - packages/skills/package.json
  - packages/adapters/solana/package.json
  - packages/adapters/evm/package.json
autonomous: true
requirements: [DEPLOY-01]

must_haves:
  truths:
    - "8개 publishable 패키지가 npm publish --dry-run 전수 성공한다 (admin은 private:true로 정상 제외)"
    - "모든 패키지의 files 필드가 실제 빌드 산출물을 포함한다"
    - "workspace:* 의존성이 npm publish 시 실제 버전으로 치환 가능한 상태이다"
    - "release-please extra-files에 skills 패키지가 포함되어 버전 동기화된다"
  artifacts:
    - path: "release-please-config.json"
      provides: "skills 패키지 포함된 extra-files 설정"
      contains: "packages/skills/package.json"
    - path: "packages/core/package.json"
      provides: "publishable npm 패키지 설정"
      contains: "@waiaas/core"
    - path: "packages/admin/package.json"
      provides: "private 패키지 확인 (publish 제외)"
      contains: "private"
  key_links:
    - from: "release-please-config.json"
      to: "packages/skills/package.json"
      via: "extra-files 버전 동기화"
      pattern: "packages/skills/package.json"
    - from: "packages/daemon/package.json"
      to: "@waiaas/core"
      via: "workspace:* 의존성"
      pattern: "workspace:\\*"
---

<objective>
npm 9개 패키지(8 publishable + 1 private) publish 검증 -- files 필드, 의존성 정합성, 버전 동기화 확인

Purpose: npm publish --dry-run으로 실제 배포 전 패키지 내용/의존성 문제를 사전에 발견하여 배포 실패를 방지한다
Output: 8개 패키지 전수 npm publish --dry-run 성공, release-please 설정 보완
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@release-please-config.json
@.release-please-manifest.json
@packages/admin/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: release-please 설정 보완 + 패키지 메타데이터 검증/수정</name>
  <files>
    release-please-config.json
    packages/core/package.json
    packages/daemon/package.json
    packages/cli/package.json
    packages/sdk/package.json
    packages/mcp/package.json
    packages/skills/package.json
    packages/admin/package.json
    packages/adapters/solana/package.json
    packages/adapters/evm/package.json
  </files>
  <action>
1. release-please-config.json의 `extra-files` 배열에 `"packages/skills/package.json"` 추가 (현재 누락됨). 이것이 없으면 release-please가 skills 패키지 버전을 업데이트하지 않는다.

2. 8개 publishable 패키지(core, daemon, cli, sdk, mcp, skills, adapter-solana, adapter-evm)의 package.json 검증:
   - `"name"` 필드가 `@waiaas/` scope 사용 확인
   - `"license": "MIT"` 존재 확인
   - `"files"` 필드가 빌드 산출물(dist, 기타 필요 파일)을 포함하는지 확인
   - `"main"`, `"types"`, `"exports"` 필드가 dist/ 내 파일을 가리키는지 확인
   - `"private": true`가 없는지 확인 (admin만 예외)
   - `"repository"`, `"homepage"`, `"bugs"` 필드가 없으면 추가 (npm 레지스트리 메타데이터 품질 향상)

3. @waiaas/admin 검증:
   - `"private": true` 확인 -- admin은 daemon의 public/admin/ 으로 번들되므로 별도 publish 불필요
   - npm publish --dry-run 시 private 패키지는 자동 스킵되므로 에러가 아닌 정상 동작

4. 각 패키지에 `"repository"`, `"homepage"` 필드 추가 (없는 경우):
   ```json
   "repository": {
     "type": "git",
     "url": "https://github.com/minho-yoo/waiaas.git",
     "directory": "packages/{name}"
   },
   "homepage": "https://github.com/minho-yoo/waiaas#readme"
   ```
   adapter 패키지는 directory를 `"packages/adapters/{chain}"`으로 설정.
  </action>
  <verify>
`node -e "const c=require('./release-please-config.json'); const ef=c.packages['.']['extra-files']; console.log(ef.includes('packages/skills/package.json') ? 'PASS' : 'FAIL')"` 로 skills 포함 확인. 각 패키지의 package.json에 repository/homepage 필드 존재 확인.
  </verify>
  <done>release-please extra-files에 skills 포함, 8개 publishable 패키지 메타데이터 완비, admin은 private:true 유지</done>
</task>

<task type="auto">
  <name>Task 2: npm publish --dry-run 전수 실행 + 패키지 내용 검증</name>
  <files>
    packages/core/package.json
    packages/daemon/package.json
    packages/cli/package.json
    packages/sdk/package.json
    packages/mcp/package.json
    packages/skills/package.json
    packages/adapters/solana/package.json
    packages/adapters/evm/package.json
  </files>
  <action>
1. `pnpm turbo run build`로 전체 빌드 실행 (dist/ 디렉토리 생성 필수)

2. 8개 publishable 패키지 각각에 대해 `npm publish --dry-run` 실행:
   ```bash
   for pkg in packages/core packages/daemon packages/cli packages/sdk packages/mcp packages/skills packages/adapters/solana packages/adapters/evm; do
     echo "=== $pkg ==="
     cd $pkg && npm publish --dry-run 2>&1 && cd -
   done
   ```

3. 각 패키지의 `npm pack --dry-run`으로 포함될 파일 목록 확인:
   - dist/ 디렉토리 파일이 포함되는지
   - 불필요한 파일(src/, tests/, node_modules/)이 제외되는지
   - package.json, README.md, LICENSE가 포함되는지

4. 만약 dry-run 실패가 있으면:
   - `files` 필드 누락 → 추가
   - `dist/` 미빌드 → 빌드 의존성 확인
   - scope 에러 → `"publishConfig": {"access": "public"}` 추가 (scoped 패키지는 기본이 restricted)

5. workspace:* 의존성 확인: pnpm publish는 workspace:* 를 실제 버전으로 자동 치환한다. `pnpm pack --pack-destination /tmp/waiaas-packs` 로 실제 tarball을 만들어 내부 package.json에서 workspace:*가 실제 버전(예: 1.7.0)으로 치환되었는지 확인한다.

주의: `npm publish --dry-run`은 scoped 패키지(@waiaas/)에서 "You must sign up for private packages" 에러를 낼 수 있다. 이 경우 각 패키지에 `"publishConfig": {"access": "public"}` 추가가 필요하다.
  </action>
  <verify>
8개 패키지 모두 `npm publish --dry-run` 또는 `pnpm publish --dry-run --no-git-checks` exit code 0. `pnpm pack` tarball 내부 package.json에서 workspace:* 가 실제 버전으로 치환된 것 확인.
  </verify>
  <done>8개 publishable 패키지 전수 npm publish --dry-run 성공, 패키지 내용(files)이 올바르고 workspace:* 의존성이 치환 가능</done>
</task>

</tasks>

<verification>
1. `release-please-config.json` extra-files에 9개 패키지 JSON 포함 (skills 추가됨)
2. 8개 publishable 패키지 전수 npm publish --dry-run 성공
3. admin 패키지는 private:true로 정상 제외
4. 패키지 tarball에 dist/ + 메타파일만 포함, src/tests 제외
5. workspace:* 의존성이 pnpm pack 시 실제 버전으로 치환
</verification>

<success_criteria>
8개 npm publishable 패키지가 npm publish --dry-run 전수 성공하고, 패키지 내용(files)이 올바르며, release-please가 skills 패키지 버전도 동기화할 수 있는 상태
</success_criteria>

<output>
After completion, create `.planning/phases/170-deploy-prerelease/170-01-SUMMARY.md`
</output>
