---
phase: 170-deploy-prerelease
plan: 03
type: execute
wave: 3
depends_on: [170-01, 170-02]
files_modified:
  - release-please-config.json
  - .github/workflows/release-please.yml
autonomous: false
requirements: [DEPLOY-04, RELEASE-03]

must_haves:
  truths:
    - "release-please가 v2.0.0-rc.1 pre-release PR을 생성할 수 있는 설정이 적용되어 있다"
    - "Release PR 머지 시 v2.0.0-rc.1 GitHub Release가 생성되고 release.yml이 트리거된다"
    - "3일 관찰 후 v2.0.0 정식 릴리스 발행 절차가 문서화되어 있다"
  artifacts:
    - path: "release-please-config.json"
      provides: "RC pre-release 설정"
      contains: "prerelease-type"
    - path: ".github/workflows/release-please.yml"
      provides: "release-please 워크플로우 (변경 있을 시)"
      contains: "release-please-action"
  key_links:
    - from: "release-please-config.json"
      to: ".github/workflows/release-please.yml"
      via: "config-file 참조"
      pattern: "release-please-config.json"
    - from: ".github/workflows/release-please.yml"
      to: ".github/workflows/release.yml"
      via: "release published 이벤트 트리거"
      pattern: "release_created"
---

<objective>
v2.0.0-rc.1 pre-release 발행 준비 -- release-please RC 설정 + 3일 관찰 계획

Purpose: pre-release RC를 먼저 발행하여 3일간 관찰한 후 정식 v2.0.0을 릴리스하는 안전한 릴리스 절차를 확립한다
Output: release-please RC 설정 완료, feat 커밋 → Release PR 생성 → 머지 → v2.0.0-rc.1 발행 가능 상태
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@release-please-config.json
@.release-please-manifest.json
@.github/workflows/release-please.yml
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: release-please RC pre-release 설정 + 트리거 커밋</name>
  <files>
    release-please-config.json
    .github/workflows/release-please.yml
  </files>
  <action>
1. **release-please-config.json에 RC pre-release 설정 추가:**

   `packages["."]` 객체에 다음 필드 추가:
   ```json
   "prerelease": true,
   "prerelease-type": "rc"
   ```
   이 설정은 release-please가 다음 릴리스를 `2.0.0-rc.1` 형태로 생성하게 한다.

   중요: `"bump-minor-pre-major": false`는 유지 -- 이미 v1.x에서 major bump 될 것이므로 minor bump 억제가 필요 없다.

2. **release-please 워크플로우에서 prerelease 관련 출력 전달 확인:**

   현재 release-please.yml에서 `release_created`, `tag_name`, `version` 출력을 전달하고 있으므로 추가 변경 불필요할 수 있다. 다만 pre-release가 GitHub Release에 "pre-release" 플래그로 표시되도록 release-please-action@v4가 자동 처리하는지 확인한다 (v4는 prerelease 설정을 자동 반영).

3. **release.yml에서 RC release 동작 확인:**

   release.yml의 `on.release.types: [published]`는 pre-release 발행도 포함하므로 추가 변경 불필요. 다만 deploy job에서 RC 버전도 npm publish 하도록 조건 확인 -- 현재 `if: github.event_name == 'release'` 이므로 pre-release도 트리거된다.

4. **v2.0.0 정식 릴리스 전환 절차 문서화:**

   release-please-config.json에 주석을 남길 수 없으므로, 170-03-SUMMARY.md의 "Next Steps" 섹션에 다음 절차를 기록:

   a) RC 발행: 현재 설정으로 Release PR 생성 → 머지 → v2.0.0-rc.1 발행
   b) 3일 관찰: npm 설치 테스트, Docker 이미지 pull 테스트, 이슈 모니터링
   c) 정식 발행: release-please-config.json에서 `"prerelease": true`와 `"prerelease-type": "rc"` 제거 → 커밋 → Release PR 자동 갱신 → 머지 → v2.0.0 발행

5. **트리거 커밋:**

   이 plan의 변경 사항을 `feat(v2.0): activate deployment pipeline for npm + Docker Hub` 형태의 conventional commit으로 커밋한다. release-please는 이 feat 커밋을 감지하여 Release PR을 생성/갱신한다.

주의: release-please는 manifest 파일(`.release-please-manifest.json`)의 현재 버전 `1.7.0`에서 feat commit을 감지하면 `2.0.0-rc.1`로 bump한다. minor가 아닌 major bump가 필요한데, 이를 위해:
- 커밋에 `BREAKING CHANGE:` footer를 포함하거나
- `release-as` 설정을 사용: `"release-as": "2.0.0"` 추가

`"release-as": "2.0.0"` 를 release-please-config.json의 `packages["."]`에 추가한다. 이렇게 하면 prerelease-type과 결합하여 `2.0.0-rc.1`이 된다.
  </action>
  <verify>
`node -e "const c=require('./release-please-config.json'); const p=c.packages['.']; console.log(p.prerelease===true && p['prerelease-type']==='rc' && p['release-as']==='2.0.0' ? 'PASS' : 'FAIL')"` 로 RC 설정 확인. release-please-config.json이 valid JSON인지 `node -e "require('./release-please-config.json')"` 로 확인.
  </verify>
  <done>release-please가 v2.0.0-rc.1 pre-release를 생성할 수 있는 설정 완료, feat 커밋으로 Release PR 트리거 준비</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Release PR 생성 확인 + v2.0.0-rc.1 발행 결정</name>
  <action>
release-please RC 설정이 완료되었습니다. main 브랜치에 feat 커밋이 push되면 release-please가 v2.0.0-rc.1 Release PR을 자동 생성합니다. 대장님이 Release PR을 검토하고 머지하여 RC를 발행해야 합니다.
  </action>
  <how-to-verify>
1. **Release PR 확인:**
   - `gh pr list --label "autorelease: pending"` 또는 GitHub PR 탭에서 release-please가 생성한 PR 확인
   - PR 제목이 "chore(main): release 2.0.0-rc.1" 형태인지 확인
   - PR 본문에 CHANGELOG가 v2.0 변경 사항을 포함하는지 확인
   - 버전 범프가 올바른지 확인 (1.7.0 → 2.0.0-rc.1)

2. **Release PR 머지 (Gate 1 - 릴리스 의사 결정):**
   - PR 내용 검토 후 머지
   - release-please가 v2.0.0-rc.1 GitHub Release + 태그 자동 생성

3. **배포 실행 확인 (Gate 2 - deploy job):**
   - GitHub Actions 탭에서 release.yml 워크플로우 실행 확인
   - test → chain-integration → platform → publish-check 통과 확인
   - docker-publish: GHCR + Docker Hub 이미지 push 확인
   - deploy: "production" 환경 수동 승인 → 8개 npm 패키지 실제 publish

4. **발행 결과 검증:**
   - `npm view @waiaas/core versions` 로 2.0.0-rc.1 존재 확인
   - `docker pull waiaas/daemon:v2.0.0-rc.1` 성공 확인
   - GitHub Release 페이지에서 "Pre-release" 배지 확인

5. **3일 관찰 계획:**
   - Day 1: npm install @waiaas/sdk@2.0.0-rc.1 + docker run 정상 동작 확인
   - Day 2: examples/simple-agent 실행 테스트
   - Day 3: 이슈 없으면 정식 릴리스 절차 진행

6. **정식 릴리스 절차 (3일 후):**
   - release-please-config.json에서 `"prerelease": true`, `"prerelease-type": "rc"`, `"release-as": "2.0.0"` 제거
   - 커밋 + push → release-please가 v2.0.0 Release PR 생성
   - PR 머지 → v2.0.0 정식 릴리스 + npm publish + Docker Hub push
  </how-to-verify>
  <verify>Release PR이 생성되고, 머지 후 v2.0.0-rc.1 GitHub Release가 존재하며, release.yml이 트리거됨</verify>
  <done>v2.0.0-rc.1 pre-release가 발행되고 3일 관찰 계획이 수립된 상태</done>
  <resume-signal>"RC 발행 완료" 또는 "Release PR에서 이슈 발견: {설명}"</resume-signal>
</task>

</tasks>

<verification>
1. release-please-config.json에 prerelease: true, prerelease-type: rc, release-as: 2.0.0 설정 존재
2. feat 커밋이 main에 push되어 release-please Release PR이 생성/갱신됨
3. Release PR 머지 시 v2.0.0-rc.1 GitHub Release + 태그 생성
4. release.yml 트리거로 npm publish + Docker push 실행
5. 3일 관찰 후 정식 릴리스 전환 절차 문서화
</verification>

<success_criteria>
release-please가 v2.0.0-rc.1 pre-release를 생성할 수 있는 설정이 완료되고, Release PR 머지 → GitHub Release → release.yml → npm publish + Docker push 전체 파이프라인이 활성화된 상태. 3일 관찰 후 v2.0.0 정식 릴리스 전환 절차가 명확한 상태.
</success_criteria>

<output>
After completion, create `.planning/phases/170-deploy-prerelease/170-03-SUMMARY.md`
</output>
