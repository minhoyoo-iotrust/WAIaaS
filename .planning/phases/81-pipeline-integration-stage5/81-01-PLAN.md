---
phase: 81-pipeline-integration-stage5
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/pipeline/pipeline.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts
autonomous: true

must_haves:
  truths:
    - "Stage 1이 TransactionRequestSchema (discriminatedUnion 5-type)으로 파싱하고, type 필드에 따라 DB INSERT의 type 컬럼을 정확히 설정한다"
    - "잘못된 type 값이나 누락된 필수 필드는 Stage 1에서 즉시 Zod 에러로 거부된다"
    - "Stage 3이 TRANSFER에 SPENDING_LIMIT+WHITELIST, TOKEN_TRANSFER에 ALLOWED_TOKENS, CONTRACT_CALL에 CONTRACT_WHITELIST+METHOD_WHITELIST, APPROVE에 APPROVED_SPENDERS+APPROVE_AMOUNT_LIMIT+APPROVE_TIER_OVERRIDE, BATCH에 evaluateBatch를 적용한다"
    - "BATCH 요청의 Stage 3은 evaluateBatch 2-stage policy를 사용하고 개별 evaluate가 아닌 전용 경로를 탄다"
    - "기존 SendTransactionRequest (type 없는) 후방 호환성이 유지된다"
  artifacts:
    - path: "packages/daemon/src/pipeline/stages.ts"
      provides: "stage1Validate discriminatedUnion 파싱 + stage3Policy type별 정책 필터링"
      contains: "TransactionRequestSchema"
    - path: "packages/daemon/src/pipeline/pipeline.ts"
      provides: "executeSend가 TransactionRequest를 받아 5-type 파이프라인 실행"
      contains: "TransactionRequest"
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "POST /transactions/send가 TransactionRequestSchema로 body 파싱 + type별 DB INSERT"
      contains: "TransactionRequestSchema"
    - path: "packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts"
      provides: "Stage 1 5-type 파싱 + Stage 3 type별 정책 필터링 TDD 테스트"
  key_links:
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "@waiaas/core TransactionRequestSchema"
      via: "import and parse in stage1Validate"
      pattern: "TransactionRequestSchema\\.parse"
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "DatabasePolicyEngine.evaluateBatch"
      via: "stage3Policy calls evaluateBatch for BATCH type"
      pattern: "evaluateBatch"
---

<objective>
Stage 1이 discriminatedUnion 5-type(TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH)을 자동 식별하고, Stage 3이 트랜잭션 type별로 적용 가능한 정책만 필터링하여 평가한다.

Purpose: 파이프라인 입구(Stage 1)와 정책 평가(Stage 3)가 5가지 트랜잭션 타입을 올바르게 처리하여, Phase 76에서 만든 discriminatedUnion 스키마와 Phase 78-80에서 만든 type별 정책 엔진을 파이프라인에 통합한다.
Output: stage1Validate/stage3Policy 확장 + TDD 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/pipeline/pipeline.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/core/src/schemas/transaction.schema.ts
@packages/daemon/src/pipeline/database-policy-engine.ts

# Prior phase summaries
@.planning/phases/76-infra-pipeline-foundation/76-02-SUMMARY.md
@.planning/phases/56-pipeline-integration/56-01-SUMMARY.md
@.planning/phases/80-batch-transactions/80-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED -- Stage 1 discriminatedUnion 파싱 + Stage 3 type별 정책 필터링 실패 테스트</name>
  <files>packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts</files>
  <action>
  새 테스트 파일 `pipeline-stage1-stage3.test.ts` 생성. 기존 pipeline.test.ts 패턴을 참고하여 in-memory SQLite + mock adapter + mock keyStore 환경 구성.

  **Stage 1 테스트 (최소 8개):**
  1. `TRANSFER` type 요청이 Stage 1에서 파싱 성공하고 DB에 type='TRANSFER' INSERT
  2. `TOKEN_TRANSFER` type 요청이 type='TOKEN_TRANSFER'로 INSERT
  3. `CONTRACT_CALL` type 요청이 type='CONTRACT_CALL'로 INSERT
  4. `APPROVE` type 요청이 type='APPROVE'로 INSERT
  5. `BATCH` type 요청이 type='BATCH'로 INSERT
  6. type 필드 누락 시 기존 SendTransactionRequestSchema 후방 호환 (type='TRANSFER' 기본)
  7. 잘못된 type 값 (e.g., 'INVALID') 요청 거부
  8. TOKEN_TRANSFER에 token 객체 누락 시 Zod 에러 거부

  **Stage 3 테스트 (최소 6개):**
  1. TOKEN_TRANSFER 요청에 ALLOWED_TOKENS 정책이 적용되어 허용/거부
  2. CONTRACT_CALL 요청에 CONTRACT_WHITELIST 정책이 적용되어 허용/거부
  3. APPROVE 요청에 APPROVED_SPENDERS 정책이 적용되어 허용/거부
  4. BATCH 요청에 evaluateBatch가 호출되어 2-stage 정책 평가
  5. TRANSFER 요청에 기존 SPENDING_LIMIT + WHITELIST만 적용 (type별 정책 미적용)
  6. 올바른 TransactionParam 형태(tokenAddress, contractAddress, selector, spenderAddress, approveAmount)가 정책 엔진에 전달되는지 검증

  PipelineContext의 `request` 필드가 `TransactionRequest | SendTransactionRequest` 유니온이 될 것이므로, 테스트에서 type별 request 객체를 구성.

  모든 테스트는 현재 코드(stage1은 SendTransactionRequestSchema만 파싱, stage3은 type='TRANSFER' 하드코딩)에 대해 FAIL해야 한다.

  테스트 커밋: `test(81-01): add failing tests for Stage 1 discriminatedUnion + Stage 3 type-based policy`
  </action>
  <verify>
  `pnpm vitest run packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts` -- 모든 신규 테스트 FAIL (RED)
  기존 테스트 통과 확인: `pnpm vitest run packages/daemon/src/__tests__/pipeline.test.ts` (기존 테스트 깨짐 없음)
  </verify>
  <done>14+ 신규 테스트가 모두 FAIL하고, 기존 pipeline 테스트는 PASS</done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN -- Stage 1 discriminatedUnion 파싱 + Stage 3 type별 정책 필터링 구현</name>
  <files>
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/pipeline/pipeline.ts
    packages/daemon/src/api/routes/transactions.ts
  </files>
  <action>
  **Stage 1 (stage1Validate) 수정 -- stages.ts:**

  1. `PipelineContext.request` 타입을 `SendTransactionRequest | TransactionRequest`로 확장 (또는 `TransactionRequest`로 변경하되 후방 호환 유지)
  2. stage1Validate에서:
     - `request`에 `type` 필드가 있으면 `TransactionRequestSchema.parse(request)` 사용
     - `type` 필드가 없으면 기존 `SendTransactionRequestSchema.parse(request)` (후방 호환)
     - 파싱된 결과의 `type`으로 DB INSERT의 `type` 컬럼 설정 (없으면 'TRANSFER' 기본)
  3. DB INSERT 시 type 필드를 동적으로 설정:
     ```typescript
     type: ('type' in ctx.request && ctx.request.type) ? ctx.request.type : 'TRANSFER',
     ```
  4. TX_REQUESTED 알림에 type 정보 포함

  **Stage 3 (stage3Policy) 수정 -- stages.ts:**

  1. request에서 type 판별: `const txType = ('type' in ctx.request && ctx.request.type) || 'TRANSFER'`
  2. type별 TransactionParam 구성:
     - `TRANSFER`: `{ type: 'TRANSFER', amount, toAddress, chain }`
     - `TOKEN_TRANSFER`: `{ type: 'TOKEN_TRANSFER', amount, toAddress, chain, tokenAddress: request.token.address }`
     - `CONTRACT_CALL`: `{ type: 'CONTRACT_CALL', amount: '0', toAddress: request.to, chain, contractAddress: request.to, selector: request.calldata?.slice(0,10) }`
     - `APPROVE`: `{ type: 'APPROVE', amount: request.amount, toAddress: request.spender, chain, spenderAddress: request.spender, approveAmount: request.amount }`
     - `BATCH`: evaluateBatch 전용 경로로 분기
  3. BATCH 처리:
     - classifyInstruction으로 각 instruction의 type 판별 (Phase 80 패턴 재활용하지 않고 DatabasePolicyEngine.evaluateBatch에 위임)
     - instructions 배열을 TransactionParam[] 형태로 변환하여 evaluateBatch 호출
     - evaluateBatch 결과를 evaluation으로 사용
  4. evaluateAndReserve도 type별 TransactionParam을 올바르게 전달

  **Pipeline 수정 -- pipeline.ts:**

  1. `executeSend` 메서드의 `request` 파라미터를 `SendTransactionRequest | TransactionRequest`로 확장
  2. import에 `TransactionRequest`, `TransactionRequestSchema` 추가

  **Route 수정 -- transactions.ts:**

  1. POST /transactions/send의 body 파싱에서 `TransactionRequestSchema` 또는 기존 `SendTransactionRequestSchema` 둘 다 지원
  2. request body에 `type` 필드가 있으면 discriminatedUnion으로 파싱
  3. Stage 1 인라인(route handler)의 DB INSERT에서도 type 동적 설정
  4. PipelineContext에 전달하는 request가 올바른 type 정보 포함

  **후방 호환성 규칙:**
  - type 필드 없는 `{ to, amount }` 요청은 기존처럼 TRANSFER로 처리
  - 기존 SDK/MCP 코드가 수정 없이 동작해야 함
  - SendTransactionRequestSchema는 제거하지 않음

  구현 커밋: `feat(81-01): implement Stage 1 discriminatedUnion parsing + Stage 3 type-based policy routing`
  </action>
  <verify>
  `pnpm vitest run packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts` -- 모든 신규 테스트 PASS (GREEN)
  `pnpm vitest run packages/daemon/` -- 전체 daemon 테스트 통과 (기존 테스트 회귀 없음)
  `pnpm turbo build` -- 빌드 성공
  </verify>
  <done>
  Stage 1이 5-type discriminatedUnion을 파싱하고 DB에 올바른 type INSERT.
  Stage 3이 type별로 TransactionParam을 구성하여 적절한 정책 평가 수행.
  BATCH는 evaluateBatch 전용 경로.
  기존 SendTransactionRequest 후방 호환 유지.
  14+ 테스트 PASS, 기존 테스트 회귀 없음.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts` -- 14+ 테스트 PASS
2. `pnpm vitest run packages/daemon/` -- 전체 daemon 테스트 PASS (회귀 없음)
3. `pnpm turbo build` -- 전체 빌드 성공
4. Stage 1: TransactionRequestSchema.parse 호출하여 5-type 자동 식별 확인
5. Stage 3: type별 TransactionParam 구성 + BATCH는 evaluateBatch 호출 확인
</verification>

<success_criteria>
- Stage 1이 TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH 5가지 type을 자동 식별
- 잘못된 type이나 누락 필드는 Stage 1에서 즉시 거부
- Stage 3이 type별 적용 가능 정책만 필터링 (TOKEN_TRANSFER에 ALLOWED_TOKENS 등)
- BATCH는 evaluateBatch 2-stage 정책 평가
- 기존 SendTransactionRequest 후방 호환 유지
- 14+ TDD 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/81-pipeline-integration-stage5/81-01-SUMMARY.md`
</output>
