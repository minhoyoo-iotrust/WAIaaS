---
phase: 183-menu-page-restructure
plan: 03
type: execute
wave: 2
depends_on: ["183-01"]
files_modified:
  - packages/admin/src/pages/system.tsx
  - packages/admin/src/pages/wallets.tsx
  - packages/admin/src/pages/sessions.tsx
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/pages/notifications.tsx
  - packages/admin/src/components/layout.tsx
autonomous: true
requirements: [SYS-01, SYS-02, TAB-02, TAB-03, TAB-04, TAB-05]

must_haves:
  truths:
    - "System page renders at #/system with API Keys, Oracle, Display Currency, Global IP Rate Limit, Log Level, Danger Zone sections"
    - "System page API Keys, Display Currency, Log Level, Danger Zone work identically to Settings page"
    - "Wallets page shows 4 tabs: Wallets, RPC Endpoints, Balance Monitoring, WalletConnect"
    - "Sessions page shows 2 tabs: Sessions, Settings"
    - "Policies page shows 2 tabs: Policies, Defaults"
    - "Notifications page shows 3 tabs: Channels & Logs, Telegram Users, Settings"
    - "All new tab content (non-primary tabs) shows stub/placeholder content"
    - "Breadcrumb is integrated into all 5 tabbed pages"
  artifacts:
    - path: "packages/admin/src/pages/system.tsx"
      provides: "System page with full functionality"
      min_lines: 150
    - path: "packages/admin/src/pages/wallets.tsx"
      provides: "Wallets page with 4-tab TabNav"
      contains: "TabNav"
    - path: "packages/admin/src/pages/sessions.tsx"
      provides: "Sessions page with 2-tab TabNav"
      contains: "TabNav"
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "Policies page with 2-tab TabNav"
      contains: "TabNav"
    - path: "packages/admin/src/pages/notifications.tsx"
      provides: "Notifications page with 3-tab TabNav"
      contains: "TabNav"
  key_links:
    - from: "packages/admin/src/pages/system.tsx"
      to: "packages/admin/src/utils/settings-helpers.ts"
      via: "import shared types and helpers"
      pattern: "import.*settings-helpers"
    - from: "packages/admin/src/pages/system.tsx"
      to: "/v1/admin/settings"
      via: "apiGet/apiPut for settings"
      pattern: "API\\.ADMIN_SETTINGS"
    - from: "packages/admin/src/pages/system.tsx"
      to: "/v1/admin/api-keys"
      via: "apiGet for API keys"
      pattern: "API\\.ADMIN_API_KEYS"
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "packages/admin/src/components/tab-nav.tsx"
      via: "TabNav import"
      pattern: "import.*TabNav"
    - from: "packages/admin/src/components/layout.tsx"
      to: "packages/admin/src/pages/system.tsx"
      via: "import SystemPage"
      pattern: "import SystemPage"
---

<objective>
Create the System page with full functionality (API Keys, Oracle, Display Currency, Global IP Rate Limit, Log Level, Danger Zone), and add TabNav + Breadcrumb to existing Wallets/Sessions/Policies/Notifications pages with stub content for new tabs.

Purpose: Complete the Phase 183 restructuring. System page provides runtime configuration previously in Settings. Existing pages gain tab structure for Phase 184 settings distribution.
Output: New system.tsx, updated 4 existing pages with TabNav, layout.tsx wired to SystemPage.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/183-menu-page-restructure/183-01-SUMMARY.md
@packages/admin/src/pages/settings.tsx
@packages/admin/src/utils/settings-helpers.ts
@packages/admin/src/components/layout.tsx
@packages/admin/src/components/tab-nav.tsx
@packages/admin/src/components/breadcrumb.tsx
@packages/admin/src/pages/wallets.tsx
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/pages/policies.tsx
@packages/admin/src/pages/notifications.tsx
@packages/admin/src/api/endpoints.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create System page with API Keys, Oracle, Display, Rate Limit, Log Level, Danger Zone</name>
  <files>packages/admin/src/pages/system.tsx, packages/admin/src/components/layout.tsx</files>
  <action>
Create `packages/admin/src/pages/system.tsx` with full functionality (NO tabs -- single-content page per milestone doc).

**Imports needed:**
- `useSignal` from `@preact/signals`
- `useEffect` from `preact/hooks`
- `apiGet, apiPost, apiPut, apiDelete, ApiError` from `../api/client`
- `API` from `../api/endpoints`
- `FormField, Button, Badge` from `../components/form`
- `CurrencySelect` from `../components/currency-select`
- `Modal` from `../components/modal`
- `showToast` from `../components/toast`
- `getErrorMessage` from `../utils/error-messages`
- Types from `../utils/settings-helpers`: `SettingsData, ApiKeyEntry, keyToLabel, getEffectiveValue, getEffectiveBoolValue, isCredentialConfigured`

**State signals:**
- Settings state: `settings`, `dirty`, `saving`, `loading` (same pattern as settings.tsx)
- API Keys state: `apiKeys`, `apiKeysLoading`, `apiKeyEditing`, `apiKeyInput`, `apiKeySaving`
- Shutdown state: `shutdownModal`, `shutdownLoading`, `shutdownConfirmText`, `isShutdown`

**Data fetching:**
- `fetchSettings()`: apiGet(API.ADMIN_SETTINGS) -> settings.value
- `fetchApiKeys()`: apiGet(API.ADMIN_API_KEYS) -> apiKeys.value
- useEffect on mount: call both

**Settings helpers (local wrappers around pure functions from settings-helpers.ts):**
```ts
const ev = (cat: string, key: string) => getEffectiveValue(settings.value, dirty.value, cat, key);
const ebv = (cat: string, key: string) => getEffectiveBoolValue(settings.value, dirty.value, cat, key);
const icc = (cat: string, key: string) => isCredentialConfigured(settings.value, dirty.value, cat, key);
```

**handleFieldChange**: same pattern as settings.tsx
**handleSave**: Filter dirty entries to only system-relevant categories: `display.*`, `daemon.*`, `security.rate_limit_global_ip_rpm`, `oracle.*`. Send via apiPut(API.ADMIN_SETTINGS).
**handleDiscard**: Reset dirty to {}

**Sections to render (in order, each as a settings-category div):**

1. **API Keys Section** -- Copy ApiKeysSection from settings.tsx lines 865-933 exactly. Same handlers: handleSaveApiKey, handleDeleteApiKey, fetchApiKeys. Same JSX structure.

2. **Oracle Section** -- NEW section rendering oracle.cross_validation_threshold:
   ```tsx
   <div class="settings-category">
     <div class="settings-category-header">
       <h3>Oracle</h3>
       <p class="settings-description">Price oracle configuration for cross-validation</p>
     </div>
     <div class="settings-category-body">
       <div class="settings-fields-grid">
         <FormField
           label="Cross Validation Threshold (%)"
           name="oracle.cross_validation_threshold"
           type="number"
           value={Number(ev('oracle', 'cross_validation_threshold')) || 5}
           onChange={(v) => handleFieldChange('oracle.cross_validation_threshold', v)}
           min={0}
           max={100}
         />
       </div>
       <div class="settings-info-box">
         Maximum allowed deviation between price sources before flagging a discrepancy. Default is 5%.
       </div>
     </div>
   </div>
   ```

3. **Display Currency Section** -- Copy DisplaySettings from settings.tsx lines 834-859 exactly. Uses CurrencySelect component.

4. **Global IP Rate Limit Section** -- Extract the single field from SecuritySettings:
   ```tsx
   <div class="settings-category">
     <div class="settings-category-header">
       <h3>Global IP Rate Limit</h3>
       <p class="settings-description">Maximum API requests per minute from a single IP address</p>
     </div>
     <div class="settings-category-body">
       <div class="settings-fields-grid">
         <FormField
           label={keyToLabel('rate_limit_global_ip_rpm')}
           name="security.rate_limit_global_ip_rpm"
           type="number"
           value={Number(ev('security', 'rate_limit_global_ip_rpm')) || 0}
           onChange={(v) => handleFieldChange('security.rate_limit_global_ip_rpm', v)}
           min={10}
         />
       </div>
     </div>
   </div>
   ```

5. **Log Level Section** -- Copy DaemonSettings from settings.tsx lines 939-965 exactly. Select with debug/info/warn/error options.

6. **Danger Zone Section** -- Copy from settings.tsx lines 1234-1244 (JSX) + 1263-1292 (modal) + 409-423 (handleShutdown). Includes shutdown button, confirmation modal with "type SHUTDOWN" input.

**Save bar**: Show at top when dirty count > 0 (same as settings.tsx lines 1100-1112). Only show for settings-type fields (not API keys or shutdown).

**Shutdown overlay**: Show when `isShutdown.value` is true (same as settings.tsx lines 1092-1097).

**After creating system.tsx, update layout.tsx:**
1. Add import: `import SystemPage from '../pages/system';`
2. Remove the `SystemPagePlaceholder` function.
3. In PageRouter, replace `<SystemPagePlaceholder />` with `<SystemPage />`.
  </action>
  <verify>
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/admin` passes.
    Grep system.tsx for "API Keys", "Oracle", "Display", "Global IP Rate Limit", "Log Level", "Danger Zone" section headings.
  </verify>
  <done>
    System page renders all 6 sections with full functionality.
    API Keys CRUD works, Display Currency select works, Log Level select works.
    Shutdown button and confirmation modal work.
    Oracle section renders cross_validation_threshold field.
    Global IP Rate Limit renders the single field.
    Save bar appears when settings are modified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TabNav + Breadcrumb to Wallets, Sessions, Policies, Notifications pages</name>
  <files>packages/admin/src/pages/wallets.tsx, packages/admin/src/pages/sessions.tsx, packages/admin/src/pages/policies.tsx, packages/admin/src/pages/notifications.tsx</files>
  <action>
Add TabNav and Breadcrumb to 4 existing pages. For each page, the PRIMARY tab shows existing content unchanged, and NEW tabs show placeholder/stub content. Phase 184 will fill in the stub content.

**Common pattern for each page:**
```tsx
import { TabNav } from '../components/tab-nav';
import { Breadcrumb } from '../components/breadcrumb';
```

Add `const activeTab = useSignal('primary-key');` at top of component.
Wrap existing JSX content in a conditional: `{activeTab.value === 'primary-key' && (<existing content>)}`.
Add stub for each new tab: `{activeTab.value === 'new-tab' && (<div class="empty-state"><p>Description will be available here.</p></div>)}`.

---

**1. Wallets page (wallets.tsx):**

Wallets has a special sub-route pattern: `WalletListView` vs `WalletDetailView`. The tabs should ONLY appear on the list view, not the detail view.

Tab definitions:
```ts
const WALLETS_TABS = [
  { key: 'wallets', label: 'Wallets' },
  { key: 'rpc', label: 'RPC Endpoints' },
  { key: 'monitoring', label: 'Balance Monitoring' },
  { key: 'walletconnect', label: 'WalletConnect' },
];
```

In the `WalletsPage` default export function (line 984):
- Add `const activeTab = useSignal('wallets');`
- When walletId exists (detail view), render WalletDetailView as before (no tabs).
- When no walletId (list view), render with tabs:
  ```tsx
  <>
    <Breadcrumb
      pageName="Wallets"
      tabName={WALLETS_TABS.find(t => t.key === activeTab.value)?.label ?? ''}
      onPageClick={() => { activeTab.value = 'wallets'; }}
    />
    <TabNav tabs={WALLETS_TABS} activeTab={activeTab.value} onTabChange={(k) => { activeTab.value = k; }} />
    {activeTab.value === 'wallets' && <WalletListView />}
    {activeTab.value === 'rpc' && <div class="empty-state"><p>RPC Endpoints settings will be available here.</p></div>}
    {activeTab.value === 'monitoring' && <div class="empty-state"><p>Balance Monitoring settings will be available here.</p></div>}
    {activeTab.value === 'walletconnect' && <div class="empty-state"><p>WalletConnect settings will be available here.</p></div>}
  </>
  ```

NOTE: The existing `WalletListView` returns `<div class="page">...</div>`. The wrapper now provides the page structure, so either:
(a) Move the page div to the WalletsPage wrapper and remove from WalletListView, OR
(b) Keep WalletListView's page div and don't add another one.
Option (b) is simpler -- just render WalletListView as-is. The Breadcrumb and TabNav go outside/above the WalletListView.

Actually, looking at the structure: WalletsPage renders either WalletDetailView or WalletListView. Both have `<div class="page">`. The tabs and breadcrumb need to be INSIDE a page div. Best approach:
- In WalletsPage (list view), wrap everything in `<div class="page">`, and remove `<div class="page">` from WalletListView's return (change to a fragment or plain div without class).
- In WalletDetailView, keep `<div class="page">` as-is.

Alternative simpler approach: Keep WalletListView as-is, and just render `<>` (fragment) around everything in WalletsPage for list view. The WalletListView already has `<div class="page">` -- put Breadcrumb + TabNav before WalletListView's own content. This means modifying WalletListView to accept and render Breadcrumb + TabNav at top.

SIMPLEST approach: Modify `WalletsPage` export to handle tabs at the top level:
```tsx
export default function WalletsPage() {
  const path = currentPath.value;
  const walletId = path.startsWith('/wallets/') ? path.slice('/wallets/'.length) : null;

  if (walletId) {
    return <WalletDetailView id={walletId} />;
  }

  // List view with tabs
  return <WalletListWithTabs />;
}
```

Create `WalletListWithTabs` that renders the Breadcrumb, TabNav, then conditionally WalletListView (existing) or stubs. Modify `WalletListView` to NOT return `<div class="page">` -- instead return a fragment. Move the `<div class="page">` to `WalletListWithTabs` wrapper.

---

**2. Sessions page (sessions.tsx):**

Tab definitions:
```ts
const SESSIONS_TABS = [
  { key: 'sessions', label: 'Sessions' },
  { key: 'settings', label: 'Settings' },
];
```

The entire current content of `SessionsPage` becomes the "sessions" tab content. Restructure:
- Add `activeTab` signal at top
- Add Breadcrumb and TabNav before the content
- Wrap existing return content in `{activeTab.value === 'sessions' && (...)}`
- Add settings stub: `{activeTab.value === 'settings' && (<div class="empty-state"><p>Session settings will be available here.</p></div>)}`

The existing `<div class="page">` wrapper stays. Put Breadcrumb + TabNav at top inside the page div.

---

**3. Policies page (policies.tsx):**

Tab definitions:
```ts
const POLICIES_TABS = [
  { key: 'policies', label: 'Policies' },
  { key: 'defaults', label: 'Defaults' },
];
```

Same pattern as Sessions. Wrap existing content in policies tab conditional. Add defaults stub.

---

**4. Notifications page (notifications.tsx):**

SPECIAL: Already has inline tab-nav using `useSignal<NotifTab>('channels')` and inline buttons. Replace with TabNav component.

Tab definitions (REPLACE existing NotifTab type):
```ts
type NotifTab = 'channels' | 'telegram' | 'settings';

const NOTIFICATIONS_TABS = [
  { key: 'channels', label: 'Channels & Logs' },
  { key: 'telegram', label: 'Telegram Users' },
  { key: 'settings', label: 'Settings' },
];
```

Changes:
- Keep existing `activeTab` signal but change type to `NotifTab` (add 'settings' to union)
- Remove the inline tab-nav div (lines 192-206): the `<div class="tab-nav" style=...>` with two `<button>` elements
- Replace with:
  ```tsx
  <Breadcrumb
    pageName="Notifications"
    tabName={NOTIFICATIONS_TABS.find(t => t.key === activeTab.value)?.label ?? ''}
    onPageClick={() => { activeTab.value = 'channels'; }}
  />
  <TabNav
    tabs={NOTIFICATIONS_TABS}
    activeTab={activeTab.value}
    onTabChange={(key) => { activeTab.value = key as NotifTab; }}
  />
  ```
- Add settings tab stub: `{activeTab.value === 'settings' && (<div class="empty-state"><p>Notification settings will be available here.</p></div>)}`
- Keep the existing channels and telegram tab content exactly as-is

**For all 4 pages**: Add the required imports at the top:
```tsx
import { TabNav } from '../components/tab-nav';
import { Breadcrumb } from '../components/breadcrumb';
```
  </action>
  <verify>
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/admin` passes.
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run test --filter=@waiaas/admin` -- existing tests still pass (may need minor adjustments if tests check DOM structure).
    Grep each modified page for "TabNav" and "Breadcrumb" imports.
  </verify>
  <done>
    Wallets page shows 4 tabs, detail view unchanged.
    Sessions page shows 2 tabs.
    Policies page shows 2 tabs.
    Notifications page shows 3 tabs (replacing inline tab-nav).
    All new tabs show stub/placeholder content.
    Breadcrumb shows "[Page] > [Tab]" on all 5 tabbed pages.
    Existing functionality unchanged in primary tabs.
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo run typecheck --filter=@waiaas/admin` passes
- `pnpm turbo run test --filter=@waiaas/admin` passes (adjust tests if needed for DOM changes)
- system.tsx renders 6 sections: API Keys, Oracle, Display Currency, Global IP Rate Limit, Log Level, Danger Zone
- layout.tsx imports and routes SystemPage at /system
- wallets.tsx has 4-tab TabNav (wallets, rpc, monitoring, walletconnect)
- sessions.tsx has 2-tab TabNav (sessions, settings)
- policies.tsx has 2-tab TabNav (policies, defaults)
- notifications.tsx has 3-tab TabNav (channels, telegram, settings) replacing inline tabs
- All 5 tabbed pages render Breadcrumb component
</verification>

<success_criteria>
1. System page at #/system shows all 6 sections with working functionality
2. API Keys CRUD, Display Currency select, Log Level select, Shutdown modal all work
3. Oracle section renders cross_validation_threshold field
4. Wallets shows 4 tabs, Sessions 2 tabs, Policies 2 tabs, Notifications 3 tabs
5. New tabs show stub content (actual settings distribution in Phase 184)
6. Notifications inline tabs replaced with TabNav component
7. Breadcrumb integrated into all 5 tabbed pages
8. All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/183-menu-page-restructure/183-03-SUMMARY.md`
</output>
