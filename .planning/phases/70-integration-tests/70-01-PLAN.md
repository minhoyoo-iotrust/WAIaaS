---
phase: 70-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/vitest.config.ts
  - packages/admin/package.json
  - packages/admin/src/__tests__/setup.ts
  - packages/admin/src/__tests__/auth.test.tsx
  - packages/admin/src/__tests__/utils.test.ts
  - packages/daemon/src/__tests__/admin-serving.test.ts
autonomous: true

must_haves:
  truths:
    - "Login component renders a password input and submit button, successful login sets masterPassword signal and navigates to #/dashboard"
    - "Login with wrong password shows 'Invalid master password' error message"
    - "Inactivity timer fires logout after adminTimeout seconds, clearing masterPassword signal"
    - "Logout clears masterPassword signal and redirects to #/login"
    - "Daemon serves SPA index.html at GET /admin/ when admin_ui=true"
    - "Daemon returns 404 for GET /admin/ when admin_ui=false"
    - "CSP header includes script-src 'self' on /admin/* responses"
    - "Kill switch guard bypasses /admin and /admin/* paths"
  artifacts:
    - path: "packages/admin/vitest.config.ts"
      provides: "Vitest config for Preact + JSDOM testing"
    - path: "packages/admin/src/__tests__/setup.ts"
      provides: "JSDOM setup with fetch mock and DOM stubs"
    - path: "packages/admin/src/__tests__/auth.test.tsx"
      provides: "4 auth tests (login success/fail, timeout, logout)"
    - path: "packages/admin/src/__tests__/utils.test.ts"
      provides: "Error messages and format utility tests"
    - path: "packages/daemon/src/__tests__/admin-serving.test.ts"
      provides: "4 security+serving tests (SPA load, admin_ui=false, CSP, kill switch bypass)"
  key_links:
    - from: "packages/admin/src/__tests__/auth.test.tsx"
      to: "packages/admin/src/auth/store.ts"
      via: "import { login, logout, masterPassword, isAuthenticated, adminTimeout }"
      pattern: "masterPassword\\.value"
    - from: "packages/daemon/src/__tests__/admin-serving.test.ts"
      to: "packages/daemon/src/api/server.ts"
      via: "createApp({ config }) + app.request('/admin/')"
      pattern: "createApp.*admin_ui"
---

<objective>
Set up Vitest + @testing-library/preact test infrastructure for the admin package and implement 8 tests: 4 auth flow tests (login success, login failure, inactivity timeout, logout) plus 4 daemon-side security/serving tests (SPA load, admin_ui=false 404, CSP header, kill switch bypass).

Purpose: Establish the test foundation and verify the most critical security surface -- authentication and server hardening -- before testing page functionality.

Output: vitest.config.ts, test setup file, 4 admin auth tests, utility tests, 4 daemon serving tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files under test
@packages/admin/src/auth/store.ts
@packages/admin/src/auth/login.tsx
@packages/admin/src/api/client.ts
@packages/admin/src/api/endpoints.ts
@packages/admin/src/app.tsx
@packages/admin/src/utils/error-messages.ts
@packages/admin/src/utils/format.ts
@packages/admin/package.json
@packages/admin/tsconfig.json
@packages/admin/vite.config.ts

# Daemon files for security/serving tests
@packages/daemon/src/api/server.ts
@packages/daemon/src/api/middleware/csp.ts
@packages/daemon/src/api/middleware/kill-switch-guard.ts
@packages/daemon/vitest.config.ts

# Existing test pattern reference
@packages/daemon/src/__tests__/api-admin-endpoints.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Vitest test infrastructure for @waiaas/admin + implement auth tests + utility tests</name>
  <files>
    packages/admin/vitest.config.ts
    packages/admin/package.json
    packages/admin/src/__tests__/setup.ts
    packages/admin/src/__tests__/auth.test.tsx
    packages/admin/src/__tests__/utils.test.ts
  </files>
  <action>
**1. Add test devDependencies to packages/admin/package.json:**

Add to devDependencies:
- `"vitest": "^3.0.0"` (matches project's existing vitest)
- `"@testing-library/preact": "^3.2.0"` (Preact-specific testing library)
- `"jsdom": "^26.0.0"` (JSDOM environment for Vitest)

Add test script:
```json
"test": "vitest run"
```

Run `pnpm install` after editing package.json.

**2. Create packages/admin/vitest.config.ts:**

```typescript
import { defineConfig } from 'vitest/config';
import preact from '@preact/preset-vite';

export default defineConfig({
  plugins: [preact()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/__tests__/setup.ts'],
    passWithNoTests: true,
  },
});
```

The `preact()` plugin is needed so JSX transforms work in test files (same as vite.config.ts). `globals: true` enables `describe/it/expect` without import. JSDOM provides DOM APIs.

**3. Create packages/admin/src/__tests__/setup.ts:**

This file sets up the JSDOM environment for Preact tests:

```typescript
import { vi, afterEach } from 'vitest';

// Mock location.hash for router tests
Object.defineProperty(window, 'location', {
  value: {
    ...window.location,
    hash: '#/login',
    assign: vi.fn(),
    replace: vi.fn(),
    reload: vi.fn(),
  },
  writable: true,
  configurable: true,
});

// Mock global fetch
globalThis.fetch = vi.fn();

// Clean up after each test
afterEach(() => {
  vi.restoreAllMocks();
  document.body.innerHTML = '';
});
```

**4. Create packages/admin/src/__tests__/auth.test.tsx:**

This file tests the auth store (login/logout/timeout) and the login component behavior.

4 tests:

(a) **Login success**: Test the `login()` function from store.ts.
- Call `login('test-password', 600)`
- Verify `masterPassword.value` === 'test-password'
- Verify `isAuthenticated.value` === true
- Verify `adminTimeout.value` === 600
- Verify `location.hash` === '#/dashboard'

(b) **Login failure (wrong password)**: Test the Login component's fetch error path.
- Mock `fetch` to return `{ status: 401, ok: false }`
- Render `<Login />` using @testing-library/preact
- Find the password input, type a value, click submit
- Wait for the error message 'Invalid master password' to appear
- Verify `masterPassword.value` is still null (not authenticated)

(c) **Inactivity timeout**: Test the inactivity timer.
- Use `vi.useFakeTimers()`
- Call `login('test-pw', 5)` (5 second timeout)
- Verify `isAuthenticated.value` === true
- Advance timers by 5000ms via `vi.advanceTimersByTime(5000)`
- Verify `masterPassword.value` === null (logged out)
- Verify `location.hash` === '#/login'
- Call `vi.useRealTimers()` in cleanup

(d) **Logout**: Test the `logout()` function.
- Call `login('test-pw')` first
- Verify `isAuthenticated.value` === true
- Call `logout()`
- Verify `masterPassword.value` === null
- Verify `isAuthenticated.value` === false
- Verify `location.hash` === '#/login'

IMPORTANT: Between tests, reset the auth store signals. After each test, call `logout()` to clear state. Since module-level signals persist between tests, ensure each test starts from a clean state by calling `masterPassword.value = null` in beforeEach or by calling logout().

For test (b), the Login component uses direct `fetch()` (not apiCall), so mock global fetch. The component renders a form with `type="password"` input and a submit button "Sign in". Use `screen.getByPlaceholderText('Master password')` to find the input and `screen.getByRole('button', { name: /sign in/i })` for the button. Use `fireEvent.input()` to set the password and `fireEvent.submit()` on the form. Wait for error text with `waitFor()` or `findByText()`.

**5. Create packages/admin/src/__tests__/utils.test.ts:**

Test error-messages.ts and format.ts utilities (these count toward the test total and are useful validation):

```typescript
import { describe, it, expect } from 'vitest';
import { getErrorMessage } from '../utils/error-messages';
import { formatUptime, formatDate, formatAddress } from '../utils/format';

describe('getErrorMessage', () => {
  it('should return mapped message for known code', () => {
    expect(getErrorMessage('INVALID_MASTER_PASSWORD')).toBe('Invalid master password. Please try again.');
    expect(getErrorMessage('KILL_SWITCH_ACTIVE')).toBe('Kill switch is active. All operations are suspended.');
  });

  it('should return fallback for unknown code', () => {
    expect(getErrorMessage('UNKNOWN_CODE_XYZ')).toBe('An error occurred (UNKNOWN_CODE_XYZ).');
  });
});

describe('formatUptime', () => {
  it('should format days/hours/minutes', () => {
    expect(formatUptime(90061)).toBe('1d 1h 1m');
    expect(formatUptime(3660)).toBe('1h 1m');
    expect(formatUptime(120)).toBe('2m');
    expect(formatUptime(0)).toBe('0m');
  });
});

describe('formatDate', () => {
  it('should format unix timestamp to YYYY-MM-DD HH:mm', () => {
    const result = formatDate(1707609600); // 2024-02-11 in UTC
    expect(result).toMatch(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/);
  });
});

describe('formatAddress', () => {
  it('should truncate long addresses', () => {
    expect(formatAddress('abcdefghijklmnop')).toBe('abcd..mnop');
  });
  it('should return short addresses unchanged', () => {
    expect(formatAddress('short')).toBe('short');
  });
});
```
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin test` and verify:
- All 4 auth tests pass (login success, login failure, inactivity timeout, logout)
- All utility tests pass (error messages, formatUptime, formatDate, formatAddress)
- No test failures or import errors
  </verify>
  <done>
4 auth tests + utility tests pass in packages/admin. Vitest infrastructure (config, setup, JSDOM) is operational for Preact component testing. @testing-library/preact renders and queries Login component correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 4 security + serving tests in daemon package</name>
  <files>packages/daemon/src/__tests__/admin-serving.test.ts</files>
  <action>
Create `packages/daemon/src/__tests__/admin-serving.test.ts` with 4 tests.

These tests use the daemon's existing test pattern: create an in-memory app via `createApp(deps)` and test with `app.request()`. No real static files needed -- we test server behavior (middleware, route registration, headers).

**Key pattern from existing tests (api-admin-endpoints.test.ts):**
- Import `createApp` from `../api/server.js`
- Create mock config with `admin_ui: true/false`
- Use `app.request('/admin/', { headers: { Host: '127.0.0.1:3100' } })`

**Test 1: SPA load -- GET /admin/ returns 200 when admin_ui=true**

Create app with `config.daemon.admin_ui = true`. Call `app.request('/admin/')`. The response may be 404 (static files don't exist in test env) but the route MUST be registered (not a middleware 404). Actually, since static files won't exist in the test environment, the serveStatic will return 404. The key test is that when `admin_ui=true`, the route is registered -- verify that CSP header is set (which proves the /admin/* middleware chain executed). An alternative approach: test that `app.request('/admin/')` returns a response (any status, even 404 from missing file) but with CSP header, proving the route exists.

Better approach: Test that when admin_ui=true, the request to `/admin/` goes through the CSP middleware (header present). When admin_ui=false, no routes are registered and we get the Hono default 404 (no CSP header).

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { createApp } from '../api/server.js';
import { createDatabase, pushSchema } from '../infrastructure/database/index.js';
import type { DatabaseConnection } from '../infrastructure/database/index.js';
import type { DaemonConfig } from '../infrastructure/config/loader.js';

function mockConfig(overrides: Partial<DaemonConfig['daemon']> = {}): DaemonConfig {
  return {
    daemon: {
      port: 3100, hostname: '127.0.0.1', log_level: 'info', log_file: 'logs/daemon.log',
      log_max_size: '50MB', log_max_files: 5, pid_file: 'daemon.pid', shutdown_timeout: 30,
      dev_mode: false, admin_ui: true, admin_timeout: 900, ...overrides,
    },
    keystore: { argon2_memory: 65536, argon2_time: 3, argon2_parallelism: 4, backup_on_rotate: true },
    database: { path: ':memory:', wal_checkpoint_interval: 300, busy_timeout: 5000, cache_size: 64000, mmap_size: 268435456 },
    rpc: {
      solana_mainnet: '', solana_devnet: '', solana_testnet: '',
      solana_ws_mainnet: '', solana_ws_devnet: '', ethereum_mainnet: '', ethereum_sepolia: '',
    },
    notifications: {
      enabled: false, min_channels: 2, health_check_interval: 300, log_retention_days: 30,
      dedup_ttl: 300, telegram_bot_token: '', telegram_chat_id: '', discord_webhook_url: '',
      ntfy_server: 'https://ntfy.sh', ntfy_topic: '', locale: 'en' as const, rate_limit_rpm: 20,
    },
    security: {
      session_ttl: 86400, jwt_secret: '', max_sessions_per_agent: 5, max_pending_tx: 10,
      nonce_storage: 'memory' as const, nonce_cache_max: 1000, nonce_cache_ttl: 300,
      rate_limit_global_ip_rpm: 1000, rate_limit_session_rpm: 300, rate_limit_tx_rpm: 10,
      cors_origins: ['http://localhost:3100'], auto_stop_consecutive_failures_threshold: 3,
      policy_defaults_delay_seconds: 300, policy_defaults_approval_timeout: 3600,
      kill_switch_recovery_cooldown: 1800, kill_switch_max_recovery_attempts: 3,
    },
    walletconnect: { project_id: '' },
  };
}

const HOST = '127.0.0.1:3100';
```

Test structure:

```typescript
describe('Admin UI serving', () => {
  let conn: DatabaseConnection;

  beforeEach(() => {
    conn = createDatabase(':memory:');
    pushSchema(conn.sqlite);
  });

  afterEach(() => {
    conn.sqlite.close();
  });

  it('should register /admin/* routes when admin_ui=true (CSP header present)', async () => {
    const app = createApp({ db: conn.db, sqlite: conn.sqlite, config: mockConfig({ admin_ui: true }) });
    const res = await app.request('/admin/test.js', { headers: { Host: HOST } });
    // Static file won't exist, but CSP middleware runs because /admin/* route is registered
    const csp = res.headers.get('Content-Security-Policy');
    expect(csp).toContain("script-src 'self'");
  });

  it('should return 404 without CSP when admin_ui=false', async () => {
    const app = createApp({ db: conn.db, sqlite: conn.sqlite, config: mockConfig({ admin_ui: false }) });
    const res = await app.request('/admin/index.html', { headers: { Host: HOST } });
    expect(res.status).toBe(404);
    const csp = res.headers.get('Content-Security-Policy');
    expect(csp).toBeNull();
  });
});

describe('CSP header', () => {
  let conn: DatabaseConnection;

  beforeEach(() => {
    conn = createDatabase(':memory:');
    pushSchema(conn.sqlite);
  });

  afterEach(() => {
    conn.sqlite.close();
  });

  it('should include strict CSP directives on /admin/* responses', async () => {
    const app = createApp({ db: conn.db, sqlite: conn.sqlite, config: mockConfig() });
    const res = await app.request('/admin/test.css', { headers: { Host: HOST } });
    const csp = res.headers.get('Content-Security-Policy');
    expect(csp).toBeTruthy();
    expect(csp).toContain("default-src 'none'");
    expect(csp).toContain("script-src 'self'");
    expect(csp).toContain("style-src 'self' 'unsafe-inline'");
    expect(csp).toContain("connect-src 'self'");
  });
});

describe('Kill switch bypass', () => {
  let conn: DatabaseConnection;

  beforeEach(() => {
    conn = createDatabase(':memory:');
    pushSchema(conn.sqlite);
  });

  afterEach(() => {
    conn.sqlite.close();
  });

  it('should bypass kill switch for /admin/* paths', async () => {
    const app = createApp({
      db: conn.db,
      sqlite: conn.sqlite,
      config: mockConfig(),
      getKillSwitchState: () => 'ACTIVATED',
    });

    // /admin/ should NOT be blocked by kill switch (CSP header proves /admin/* middleware runs)
    const adminRes = await app.request('/admin/test.js', { headers: { Host: HOST } });
    // Should not be 409 (kill switch error)
    expect(adminRes.status).not.toBe(409);

    // /health should bypass kill switch too
    const healthRes = await app.request('/health', { headers: { Host: HOST } });
    expect(healthRes.status).toBe(200);

    // But regular API routes SHOULD be blocked
    const agentRes = await app.request('/v1/agents', { headers: { Host: HOST } });
    expect(agentRes.status).toBe(409);
  });
});
```

IMPORTANT: The `admin_ui: false` test verifies that NO /admin/* routes are registered at all. When `admin_ui=false`, the entire `if (deps.config?.daemon?.admin_ui !== false)` block is skipped, so /admin/* returns Hono's default 404 without CSP headers.

For Kill Switch bypass: with `getKillSwitchState: () => 'ACTIVATED'`, regular routes return 409, but /admin/* and /health bypass the guard. The /admin/* request will get a file-not-found response (404 from serveStatic), but NOT a 409 from kill switch guard.
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --testPathPattern admin-serving` and verify all 4 tests pass:
1. admin_ui=true registers /admin/* routes (CSP present)
2. admin_ui=false returns 404 without CSP
3. CSP header contains strict directives
4. Kill switch bypasses /admin/* paths
  </verify>
  <done>
4 security/serving tests pass in daemon package. SPA route registration, admin_ui toggle, CSP headers, and kill switch bypass all verified.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm --filter @waiaas/admin test` -- all auth (4) + utility tests pass
2. Run `pnpm --filter @waiaas/daemon test -- --testPathPattern admin-serving` -- all 4 security/serving tests pass
3. No import errors or configuration issues
4. The test infrastructure (vitest.config.ts, setup.ts) is ready for Plan 70-02 page tests
</verification>

<success_criteria>
- 4 auth tests pass: login success, login failure, inactivity timeout, logout
- 4 security/serving tests pass: SPA load, admin_ui=false 404, CSP header, kill switch bypass
- vitest.config.ts and setup.ts established for @waiaas/admin Preact testing
- Test infrastructure reusable for Plan 70-02 page tests
</success_criteria>

<output>
After completion, create `.planning/phases/70-integration-tests/70-01-SUMMARY.md`
</output>
