---
phase: 94-design-docs-verification
plan: 02
type: execute
wave: 2
depends_on: ["94-01"]
files_modified:
  - packages/core/src/interfaces/IPolicyEngine.ts
  - packages/daemon/src/pipeline/database-policy-engine.ts
  - packages/daemon/src/workflow/owner-state.ts
  - packages/daemon/src/__tests__/owner-auth-siwe.test.ts
  - packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts
  - packages/daemon/src/__tests__/owner-auth.test.ts
  - packages/daemon/src/__tests__/api-agents.test.ts
  - packages/daemon/src/__tests__/api-admin-endpoints.test.ts
  - packages/daemon/src/__tests__/api-new-endpoints.test.ts
autonomous: true

must_haves:
  truths:
    - "grep -r 'agentId' packages/ returns only intentional occurrences (migration-runner.test.ts + built assets)"
    - "IPolicyEngine.evaluate() parameter is walletId, not agentId"
    - "owner-state.ts uses walletId/WalletOwnerFields/getWalletRow naming"
    - "pnpm test passes with 1,313+ tests (no regressions from renames)"
    - "GET /doc OpenAPI spec has 0 agentId fields and walletId fields are present"
  artifacts:
    - path: "packages/core/src/interfaces/IPolicyEngine.ts"
      provides: "IPolicyEngine with walletId parameter"
      contains: "walletId"
    - path: "packages/daemon/src/workflow/owner-state.ts"
      provides: "Owner state with wallet terminology"
      contains: "WalletOwnerFields"
    - path: "packages/daemon/src/pipeline/database-policy-engine.ts"
      provides: "Database policy engine with walletId parameters"
      contains: "walletId"
  key_links:
    - from: "packages/core/src/interfaces/IPolicyEngine.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "implements IPolicyEngine.evaluate(walletId)"
      pattern: "evaluate\\(walletId"
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "policies.walletId column reference"
      pattern: "policies\\.walletId"
---

<objective>
Fix remaining agentId code references in packages/, run full grep verification sweep, execute complete test suite, and validate OpenAPI spec -- achieving the v1.4.2 zero-residual-agent goal.

Purpose: Phases 89-93 renamed the vast majority of agent->wallet references but left some intentional gaps (IPolicyEngine interface, owner-state.ts internal naming, test comments). This plan closes those gaps and performs the final verification required by VERIFY-01/02/03.

Output: Clean grep results, all tests passing, OpenAPI spec confirmed.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/94-design-docs-verification/94-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix remaining agentId code references in source and test files</name>
  <files>
    packages/core/src/interfaces/IPolicyEngine.ts
    packages/daemon/src/pipeline/database-policy-engine.ts
    packages/daemon/src/workflow/owner-state.ts
    packages/daemon/src/__tests__/owner-auth-siwe.test.ts
    packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts
    packages/daemon/src/__tests__/owner-auth.test.ts
    packages/daemon/src/__tests__/api-agents.test.ts
    packages/daemon/src/__tests__/api-admin-endpoints.test.ts
    packages/daemon/src/__tests__/api-new-endpoints.test.ts
  </files>
  <action>
    **1. IPolicyEngine.ts** (packages/core/src/interfaces/IPolicyEngine.ts):
    - Rename parameter `agentId: string` -> `walletId: string` in `evaluate()` method signature

    **2. database-policy-engine.ts** (packages/daemon/src/pipeline/database-policy-engine.ts):
    - Rename ALL `agentId` parameter names -> `walletId` in:
      - `evaluate(agentId, ...)` -> `evaluate(walletId, ...)`
      - `evaluateSync(agentId, ...)` -> `evaluateSync(walletId, ...)`
      - `evaluateRateLimit(agentId, ...)` -> `evaluateRateLimit(walletId, ...)`
      - All internal references to `agentId` variable -> `walletId`
    - Update JSDoc: `@param agentId` -> `@param walletId`, "Agent whose policies" -> "Wallet whose policies", "The agent whose policies" -> "The wallet whose policies"

    **3. owner-state.ts** (packages/daemon/src/workflow/owner-state.ts):
    - Rename type: `AgentOwnerFields` -> `WalletOwnerFields`
    - Rename type: `AgentRow` -> `WalletRow`
    - Rename method: `getAgentRow` -> `getWalletRow`
    - Rename all parameter names: `agentId` -> `walletId` (in setOwner, removeOwner, markOwnerVerified, getWalletRow)
    - Rename local variables: `agent` -> `wallet` (the row variable in setOwner/removeOwner/markOwnerVerified)
    - Update function signature: `resolveOwnerState(agent: AgentOwnerFields)` -> `resolveOwnerState(wallet: WalletOwnerFields)`
    - Update function signature: `downgradeIfNoOwner(agent: AgentOwnerFields, ...)` -> `downgradeIfNoOwner(wallet: WalletOwnerFields, ...)`
    - Update all `agent.ownerAddress`, `agent.ownerVerified`, `agent.owner_address`, `agent.owner_verified` -> `wallet.*`
    - Update JSDoc comments: "agent fields" -> "wallet fields", "@param agent" -> "@param wallet", "Agent ID" -> "Wallet ID"
    - Update error message: "No owner address registered for this agent" -> "No owner address registered for this wallet"
    - Update file-level docstring: "Manages the Owner lifecycle for agents" -> "Manages the Owner lifecycle for wallets"
    - Update "determine state from agent fields" -> "determine state from wallet fields"

    **4. Test file comment/string updates** (fix remaining "agent" in test descriptions and comments that refer to the managed entity, NOT AI agent concept):
    - `owner-auth-siwe.test.ts`: "EVM agent" -> "EVM wallet" in test descriptions and comments where it refers to the managed entity. "Seed a test agent" -> "Seed a test wallet". "Seed an agent for setOwner tests" -> "Seed a wallet for setOwner tests".
    - `evm-lifecycle-e2e.test.ts`: "Create EVM agent" -> "Create EVM wallet" in test descriptions and comments. "Solana agent" -> "Solana wallet". "EVM agent" -> "EVM wallet". Variable name `agent` -> `wallet` where it holds the API response representing the wallet entity.
    - `owner-auth.test.ts`: "agent does not exist" -> "wallet does not exist" in test descriptions. "agent has no owner" -> "wallet has no owner". "Seed a test agent" -> "Seed a test wallet". `nonexistent-agent-id` -> `nonexistent-wallet-id`.
    - `api-admin-endpoints.test.ts`: "Update agent name" -> "Update wallet name" in comments. "Terminate agent" -> "Terminate wallet". `'test-agent'` -> `'test-wallet'` default param.
    - `api-new-endpoints.test.ts`: `'test-agent'` -> `'test-wallet'` default param. `'agent-2'` -> `'wallet-2'`.
    - `api-agents.test.ts`: Check for remaining `agent` references in test descriptions/comments and rename entity references.

    **5. Check callers of renamed exports:**
    - After renaming `AgentOwnerFields` -> `WalletOwnerFields`, grep for any imports of `AgentOwnerFields` in other files and update them.
    - After renaming `downgradeIfNoOwner` param from `agent` to `wallet`, check callers pass correctly (the parameter rename is internal so callers are unaffected).
    - After renaming `resolveOwnerState` param from `agent` to `wallet`, check callers pass correctly.
    - Run `tsc --noEmit` to confirm all TypeScript compiles.

    **6. Do NOT modify:**
    - `migration-runner.test.ts` -- intentionally tests v3 migration DDL with old agent_id column names
    - Built admin assets in `packages/daemon/public/admin/assets/` -- these are compiled output; they will be regenerated on next admin build
    - Comments that refer to "AI agent" as the conceptual actor (e.g., "EVM agent with SIWE owner-auth" test name is about testing the flow, can be renamed to "EVM wallet with SIWE owner-auth")
  </action>
  <verify>
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx tsc --noEmit` -- must pass with 0 errors.
    Run: `grep -rn 'agentId\|AgentOwnerFields\|AgentRow\|getAgentRow\|AgentSchema\|AgentStatusEnum\|agentService\|AGENT_NOT_FOUND\|AGENT_SUSPENDED\|AGENT_TERMINATED' packages/core/src/ packages/daemon/src/ packages/mcp/src/ packages/cli/src/ packages/sdk/src/ --include='*.ts' | grep -v migration-runner | grep -v node_modules` -- should return 0 lines.
  </verify>
  <done>All remaining agentId code references in packages/ source and test files are renamed to walletId. TypeScript compiles cleanly. Only migration-runner.test.ts and built admin assets retain intentional agent references.</done>
</task>

<task type="auto">
  <name>Task 2: Full verification sweep -- grep, tests, OpenAPI spec</name>
  <files></files>
  <action>
    **Step 1: Comprehensive grep sweep (VERIFY-01)**

    Run the following grep commands and document results:

    ```bash
    # Code identifier grep across all packages (excluding intentional)
    grep -rn '\bagentId\b' packages/ --include='*.ts' --include='*.tsx' | grep -v migration-runner | grep -v node_modules | grep -v 'public/admin/assets'

    # DB column reference grep
    grep -rn '\bagent_id\b' packages/ --include='*.ts' --include='*.tsx' | grep -v migration-runner | grep -v node_modules

    # Error code grep
    grep -rn 'AGENT_NOT_FOUND\|AGENT_SUSPENDED\|AGENT_TERMINATED' packages/ --include='*.ts' --include='*.tsx' | grep -v migration-runner | grep -v node_modules

    # API path grep
    grep -rn '/v1/agents' packages/ --include='*.ts' --include='*.tsx' | grep -v migration-runner | grep -v node_modules

    # Type name grep
    grep -rn 'AgentSchema\|AgentStatusEnum\|AgentContext\|AgentOwnerFields' packages/ --include='*.ts' --include='*.tsx' | grep -v migration-runner | grep -v node_modules
    ```

    All commands should return 0 lines. If any return results, fix them before proceeding.

    **Step 2: Full test suite (VERIFY-02)**

    Run `pnpm test` from the project root. All 1,313+ tests must pass. Known pre-existing failures:
    - `lifecycle.test.ts` may be flaky (pre-existing)
    - `e2e-errors.test.ts` may fail (OpenAPIHono side effect, pre-existing)

    If any NEW failures occur (tests that were passing before this plan), investigate and fix.

    **Step 3: OpenAPI spec validation (VERIFY-03)**

    Start the daemon in dev mode (or use the existing test infrastructure) to check the OpenAPI spec:

    ```bash
    # If daemon can be started:
    # curl http://127.0.0.1:3100/doc | jq . | grep -i agentId
    # Should return 0 results

    # Alternative: grep the OpenAPI schema source files directly
    grep -rn 'agentId' packages/daemon/src/api/ --include='*.ts' | grep -v test | grep -v __tests__
    ```

    The OpenAPI schema is generated from Zod schemas via OpenAPIHono. Since Phase 90 renamed all Zod schemas to use walletId, the OpenAPI output should already be correct. Verify by checking the route definitions and schema references.

    **Step 4: Rebuild admin assets**

    Run `pnpm --filter @waiaas/admin build` to regenerate compiled admin assets with wallet terminology. This replaces the stale `packages/daemon/public/admin/assets/` files that still contain "agent" references from pre-rename builds.

    **Step 5: Final comprehensive grep (docs + packages)**

    ```bash
    grep -rn '\bagentId\b\|\bagent_id\b\|AgentSchema\|/v1/agents\|AGENT_NOT_FOUND' docs/ README.md packages/ --include='*.ts' --include='*.tsx' --include='*.md' | grep -v migration-runner | grep -v node_modules | grep -v 'public/admin/assets' | grep -v '.planning/'
    ```

    This final sweep confirms zero unintentional agent references across the entire codebase.
  </action>
  <verify>
    1. All grep commands in Step 1 return 0 results
    2. `pnpm test` passes (no new failures)
    3. OpenAPI schema source has 0 agentId references
    4. Admin build completes successfully
    5. Final comprehensive grep returns 0 results (excluding migration-runner.test.ts and .planning/)
  </verify>
  <done>VERIFY-01: grep sweep confirms 0 unintentional agent references. VERIFY-02: pnpm test passes with 1,313+ tests. VERIFY-03: OpenAPI spec uses walletId exclusively. v1.4.2 terminology rename is complete.</done>
</task>

</tasks>

<verification>
1. `grep -rn '\bagentId\b' packages/ --include='*.ts' | grep -v migration-runner | grep -v node_modules | grep -v 'public/admin/assets'` returns 0 lines
2. `grep -rn '\bagentId\b\|/v1/agents\|AGENT_NOT_FOUND' docs/ README.md` returns 0 lines
3. `pnpm test` passes (1,313+ tests, no new failures)
4. `grep -rn 'agentId' packages/daemon/src/api/ --include='*.ts' | grep -v test` returns 0 lines (OpenAPI clean)
5. Admin assets rebuilt with wallet terminology
</verification>

<success_criteria>
- VERIFY-01: grep sweep 0 unintentional agent code references in packages/
- VERIFY-02: pnpm test all passing (1,313+ tests)
- VERIFY-03: OpenAPI spec agentId 0 occurrences, walletId present
- IPolicyEngine, database-policy-engine, owner-state all use walletId
- Admin assets rebuilt
- v1.4.2 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/94-design-docs-verification/94-02-SUMMARY.md`
</output>
