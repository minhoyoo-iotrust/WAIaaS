---
phase: 67-auth-api-client-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/auth/store.ts
  - packages/admin/src/auth/login.tsx
  - packages/admin/src/api/client.ts
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/app.tsx
  - packages/admin/src/styles/global.css
  - packages/admin/vite.config.ts
autonomous: true

must_haves:
  truths:
    - "Master password input form renders and submits to GET /v1/admin/status with X-Master-Password header"
    - "Successful login stores password in signal and redirects to #/dashboard"
    - "Failed login shows 'Invalid master password' error message"
    - "15-minute (configurable) inactivity auto-logout clears auth and redirects to #/login"
    - "API client auto-injects X-Master-Password header and handles 401 with auto-logout"
    - "Network errors produce 'Cannot connect to daemon' message"
    - "App component shows Login when not authenticated and delegates to Layout when authenticated"
    - "Daemon shutdown signal shows shutdown overlay with highest priority"
  artifacts:
    - path: "packages/admin/src/auth/store.ts"
      provides: "Auth signals, login/logout/resetInactivityTimer functions, inactivity tracking"
      exports: ["masterPassword", "isAuthenticated", "adminTimeout", "daemonShutdown", "login", "logout", "resetInactivityTimer"]
    - path: "packages/admin/src/auth/login.tsx"
      provides: "Login form component with password input, error display, loading state"
      exports: ["Login"]
    - path: "packages/admin/src/api/client.ts"
      provides: "apiCall fetch wrapper with auth header injection, timeout, error parsing, 401 handling"
      exports: ["apiCall", "apiGet", "apiPost", "apiPut", "apiDelete", "ApiError"]
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "API endpoint path constants"
      exports: ["API"]
    - path: "packages/admin/src/app.tsx"
      provides: "Root component with auth guard (shutdown > login > layout)"
      exports: ["App"]
  key_links:
    - from: "packages/admin/src/auth/login.tsx"
      to: "packages/admin/src/api/client.ts"
      via: "apiGet(API.ADMIN_STATUS) call on form submit"
      pattern: "apiGet.*ADMIN_STATUS"
    - from: "packages/admin/src/api/client.ts"
      to: "packages/admin/src/auth/store.ts"
      via: "reads masterPassword signal for header, calls logout() on 401, resetInactivityTimer() on success"
      pattern: "masterPassword\\.value|logout\\(\\)|resetInactivityTimer"
    - from: "packages/admin/src/app.tsx"
      to: "packages/admin/src/auth/store.ts"
      via: "reads isAuthenticated and daemonShutdown signals for conditional rendering"
      pattern: "isAuthenticated|daemonShutdown"
---

<objective>
Implement masterAuth login flow, @preact/signals-based auth store with inactivity timeout, and API client fetch wrapper for the Admin Web UI.

Purpose: Users must authenticate with the master password before accessing any admin functionality. The auth store manages session state with automatic logout on inactivity. The API client ensures all requests carry authentication and handles errors consistently.

Output: Working login screen, auth state management, and type-safe API client ready for all page implementations in Phase 68-69.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-infra-build-pipeline/66-01-SUMMARY.md
@.planning/phases/66-infra-build-pipeline/66-02-SUMMARY.md

# Existing admin files to modify
@packages/admin/src/app.tsx
@packages/admin/src/main.tsx
@packages/admin/src/styles/global.css
@packages/admin/vite.config.ts
@packages/admin/package.json
@packages/admin/tsconfig.json

# Error codes from core (for error message context)
@packages/core/src/errors/error-codes.ts

# Daemon API schemas (response shapes)
@packages/daemon/src/api/routes/openapi-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Auth Store + API Client + Endpoints</name>
  <files>
    packages/admin/src/auth/store.ts
    packages/admin/src/api/client.ts
    packages/admin/src/api/endpoints.ts
    packages/admin/src/styles/global.css
    packages/admin/vite.config.ts
  </files>
  <action>
**1. Create `packages/admin/src/api/endpoints.ts`:**

```typescript
export const API = {
  ADMIN_STATUS: '/v1/admin/status',
  ADMIN_KILL_SWITCH: '/v1/admin/kill-switch',
  ADMIN_RECOVER: '/v1/admin/recover',
  ADMIN_SHUTDOWN: '/v1/admin/shutdown',
  ADMIN_ROTATE_SECRET: '/v1/admin/rotate-secret',
  AGENTS: '/v1/agents',
  AGENT: (id: string) => `/v1/agents/${id}`,
  SESSIONS: '/v1/sessions',
  SESSION: (id: string) => `/v1/sessions/${id}`,
  POLICIES: '/v1/policies',
  POLICY: (id: string) => `/v1/policies/${id}`,
} as const;
```

**2. Create `packages/admin/src/auth/store.ts`:**

Use `@preact/signals` (already installed as devDependency):

```typescript
import { signal, computed } from '@preact/signals';
```

Signals:
- `masterPassword = signal<string | null>(null)` — stores the plaintext password for X-Master-Password header injection
- `isAuthenticated = computed(() => masterPassword.value !== null)` — derived boolean
- `adminTimeout = signal<number>(900)` — seconds, updated from server on login success
- `daemonShutdown = signal<boolean>(false)` — for shutdown overlay priority

Functions:
- `login(password: string, serverTimeout?: number)`: Sets masterPassword.value = password. If serverTimeout provided, sets adminTimeout.value = serverTimeout. Starts inactivity timer. Redirects via `location.hash = '#/dashboard'`.
- `logout()`: Sets masterPassword.value = null. Clears inactivity timer. Redirects via `location.hash = '#/login'`.
- `resetInactivityTimer()`: Clears existing timer, sets new `setTimeout(logout, adminTimeout.value * 1000)`.

Inactivity tracking:
- Module-level `let inactivityTimer: ReturnType<typeof setTimeout> | null = null`
- `startInactivityTracking()`: Add event listeners for `mousemove`, `keydown`, `click` on `document` that call `resetInactivityTimer()`. Use `{ passive: true }` for performance. Call `resetInactivityTimer()` to start the first timer.
- `stopInactivityTracking()`: Remove event listeners, clear timer.
- `login()` calls `startInactivityTracking()`.
- `logout()` calls `stopInactivityTracking()`.

**3. Create `packages/admin/src/api/client.ts`:**

```typescript
import { masterPassword, logout, resetInactivityTimer } from '../auth/store';
```

`ApiError` class:
```typescript
export class ApiError extends Error {
  constructor(
    public readonly status: number,
    public readonly code: string,
    public readonly serverMessage: string,
  ) {
    super(`[${status}] ${code}: ${serverMessage}`);
    this.name = 'ApiError';
  }
}
```

`apiCall<T>(path: string, options?: RequestInit): Promise<T>`:
- Build headers: `{ 'Content-Type': 'application/json' }`
- If `masterPassword.value` is not null, add `'X-Master-Password': masterPassword.value`
- Merge with options.headers
- Call `fetch(path, { ...options, headers, signal: AbortSignal.timeout(10_000) })`
- Wrap in try/catch for network errors:
  - `catch` block: If error.name === 'AbortError' or 'TimeoutError', throw `new ApiError(0, 'TIMEOUT', 'Request timed out')`. Otherwise throw `new ApiError(0, 'NETWORK_ERROR', 'Cannot connect to daemon')`.
- Response handling:
  - If `response.status === 401`: call `logout()`, throw `new ApiError(401, 'INVALID_MASTER_PASSWORD', 'Authentication failed')`
  - If `!response.ok`: Parse body as JSON, extract `code` and `message` fields. throw `new ApiError(response.status, body.code ?? 'UNKNOWN', body.message ?? 'Unknown error')`
  - On success: call `resetInactivityTimer()`, return `await response.json() as T`

Convenience helpers:
```typescript
export const apiGet = <T>(path: string) => apiCall<T>(path, { method: 'GET' });
export const apiPost = <T>(path: string, body?: unknown) =>
  apiCall<T>(path, { method: 'POST', body: body ? JSON.stringify(body) : undefined });
export const apiPut = <T>(path: string, body?: unknown) =>
  apiCall<T>(path, { method: 'PUT', body: body ? JSON.stringify(body) : undefined });
export const apiDelete = <T>(path: string) => apiCall<T>(path, { method: 'DELETE' });
```

**4. Update `packages/admin/src/styles/global.css`:**

Replace the dark theme CSS variables with the light theme design token set from design doc 67 section 9.2:

```css
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --color-primary: #2563eb;
  --color-primary-hover: #1d4ed8;
  --color-primary-light: #eff6ff;
  --color-bg: #ffffff;
  --color-bg-secondary: #f8fafc;
  --color-bg-tertiary: #f1f5f9;
  --color-border: #e2e8f0;
  --color-text: #0f172a;
  --color-text-secondary: #64748b;
  --color-text-muted: #94a3b8;
  --color-success: #16a34a;
  --color-success-bg: #f0fdf4;
  --color-warning: #d97706;
  --color-warning-bg: #fffbeb;
  --color-danger: #dc2626;
  --color-danger-bg: #fef2f2;
  --color-info: #2563eb;
  --color-info-bg: #eff6ff;
  --color-tier-instant: #16a34a;
  --color-tier-delay: #d97706;
  --color-tier-blocked: #dc2626;
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-6: 1.5rem;
  --space-8: 2rem;
  --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --font-size-xs: 0.75rem;
  --font-size-sm: 0.875rem;
  --font-size-base: 1rem;
  --font-size-lg: 1.125rem;
  --font-size-xl: 1.25rem;
  --font-size-2xl: 1.5rem;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  --line-height: 1.5;
  --radius-sm: 0.25rem;
  --radius-md: 0.375rem;
  --radius-lg: 0.5rem;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --sidebar-width: 220px;
  --header-height: 56px;
  --content-max-width: 1200px;
}

body {
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  line-height: var(--line-height);
  background: var(--color-bg);
  color: var(--color-text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  color: var(--color-primary);
  text-decoration: none;
}

button {
  cursor: pointer;
  font-family: inherit;
}

input, select, textarea {
  font-family: inherit;
  font-size: inherit;
}
```

**5. Update `packages/admin/vite.config.ts`:**

Add dev server proxy so `/v1` API calls route to the daemon during development:

```typescript
import { defineConfig } from 'vite';
import preact from '@preact/preset-vite';

export default defineConfig({
  plugins: [preact()],
  build: {
    outDir: 'dist',
    modulePreload: { polyfill: false },
    target: 'es2022',
    sourcemap: false,
  },
  base: '/admin/',
  server: {
    proxy: {
      '/v1': {
        target: 'http://127.0.0.1:3100',
        changeOrigin: true,
      },
    },
  },
});
```
  </action>
  <verify>
1. `pnpm --filter @waiaas/admin build` completes without errors (TypeScript compilation via Vite succeeds with new files)
2. Verify files exist: `ls packages/admin/src/auth/store.ts packages/admin/src/api/client.ts packages/admin/src/api/endpoints.ts`
3. Check global.css has light theme: `grep 'color-primary: #2563eb' packages/admin/src/styles/global.css`
4. Check vite proxy config: `grep 'proxy' packages/admin/vite.config.ts`
  </verify>
  <done>Auth store exports masterPassword/isAuthenticated/adminTimeout/daemonShutdown signals and login/logout/resetInactivityTimer functions. API client exports apiCall/apiGet/apiPost/apiPut/apiDelete with X-Master-Password injection, 10s timeout, 401 auto-logout. Endpoints constant maps all API paths. CSS variables updated to light theme. Vite proxy configured for dev.</done>
</task>

<task type="auto">
  <name>Task 2: Create Login Component + App Auth Guard</name>
  <files>
    packages/admin/src/auth/login.tsx
    packages/admin/src/app.tsx
  </files>
  <action>
**1. Create `packages/admin/src/auth/login.tsx`:**

Login component — a centered card with WAIaaS branding, password input, and submit button:

```tsx
import { signal } from '@preact/signals';
import { login, adminTimeout } from './store';
import { apiGet } from '../api/client';
import { API } from '../api/endpoints';
import { ApiError } from '../api/client';
```

Component-level signals (local to module, not exported):
- `password = signal('')` — input value
- `error = signal<string | null>(null)` — error message display
- `loading = signal(false)` — loading state for button

`Login` component:
- Renders a centered login form (flex center, max-width ~360px card).
- Title: "WAIaaS Admin"
- Subtitle: "Enter master password to continue"
- Password input field: `type="password"`, `placeholder="Master password"`, `autofocus`
- Submit button: "Sign in" (or "Signing in..." when loading)
- Error message display below button (red text, hidden when null)

Form submit handler (`handleSubmit`):
1. `e.preventDefault()`
2. Set `loading.value = true`, `error.value = null`
3. Try: `const data = await apiGet<{ adminTimeout: number }>(API.ADMIN_STATUS)` — pass X-Master-Password via temporary store injection:
   - IMPORTANT: Before calling apiGet, we need the password in the store so apiCall can read it. BUT we don't want to fully "log in" yet. So: temporarily set `masterPassword` value for the request, then check response.
   - Better approach: Call fetch directly in login to avoid circular dependency. Or: the login function should do its own fetch.
   - **Chosen approach**: Use `apiCall` but manually set password first. If the call succeeds, call `login()`. If it fails, clear it.

   Actually, simplest correct approach for login:
   ```typescript
   const handleSubmit = async (e: Event) => {
     e.preventDefault();
     if (!password.value.trim()) return;
     loading.value = true;
     error.value = null;
     try {
       const res = await fetch(API.ADMIN_STATUS, {
         headers: { 'X-Master-Password': password.value },
         signal: AbortSignal.timeout(10_000),
       });
       if (res.status === 401) {
         error.value = 'Invalid master password';
         return;
       }
       if (!res.ok) {
         error.value = 'Cannot connect to daemon';
         return;
       }
       const data = await res.json();
       login(password.value, data.adminTimeout);
     } catch {
       error.value = 'Cannot connect to daemon';
     } finally {
       loading.value = false;
     }
   };
   ```

Styles (inline or CSS module — use inline style objects for simplicity since no CSS modules configured):
- Login wrapper: `display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--color-bg-secondary);`
- Card: `background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-8); width: 100%; max-width: 360px; box-shadow: var(--shadow-md);`
- Title: `font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); text-align: center; margin-bottom: var(--space-1);`
- Subtitle: `font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center; margin-bottom: var(--space-6);`
- Input: `width: 100%; padding: var(--space-2) var(--space-3); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: var(--font-size-base); outline: none;` Focus: `border-color: var(--color-primary);`
- Button: `width: 100%; padding: var(--space-2) var(--space-4); background: var(--color-primary); color: white; border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: var(--font-weight-medium); margin-top: var(--space-4);` Hover: `background: var(--color-primary-hover);` Disabled: `opacity: 0.6; cursor: not-allowed;`
- Error: `color: var(--color-danger); font-size: var(--font-size-sm); text-align: center; margin-top: var(--space-3);`

Use a `<style>` tag in the component file or create a scoped CSS approach. Recommended: Use a dedicated CSS file `packages/admin/src/auth/login.css` imported in the component. Alternatively, since there's no CSS module setup, use className-based styling in global.css. **Best approach for simplicity**: create inline style constants as objects in the component file, since Preact supports `style` prop with objects.

**2. Update `packages/admin/src/app.tsx`:**

Replace placeholder with auth guard logic per design doc 67 section 8.6:

```tsx
import { isAuthenticated, daemonShutdown } from './auth/store';
import { Login } from './auth/login';
```

App component:
```tsx
export function App() {
  // Priority: shutdown overlay > login > authenticated layout
  if (daemonShutdown.value) {
    return <ShutdownOverlay />;
  }
  if (!isAuthenticated.value) {
    return <Login />;
  }
  // Phase 67-02 will add Layout+Router here
  // For now, render a placeholder that proves auth works
  return (
    <div>
      <h1>Authenticated</h1>
      <p>Layout component coming in Plan 67-02</p>
    </div>
  );
}
```

`ShutdownOverlay` (inline in app.tsx or separate — keep inline for now):
- Full-screen overlay with centered message
- "Daemon Shutting Down" title
- "The daemon is shutting down. Please wait or restart." message
- Style: `position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); color: white; z-index: 9999;`

**NOTE on preact-router**: Do NOT add router to app.tsx in this plan. The router will be added in Plan 67-02 when Layout component is created. For now, app.tsx just handles the auth guard (shutdown > login > placeholder for authenticated content).
  </action>
  <verify>
1. `pnpm --filter @waiaas/admin build` completes without errors
2. Verify login component: `grep 'handleSubmit' packages/admin/src/auth/login.tsx`
3. Verify app auth guard: `grep 'isAuthenticated' packages/admin/src/app.tsx && grep 'daemonShutdown' packages/admin/src/app.tsx`
4. Verify ShutdownOverlay: `grep 'ShutdownOverlay' packages/admin/src/app.tsx`
5. Build output should include all new modules in the bundle
  </verify>
  <done>Login component renders password form, validates against GET /v1/admin/status, shows error on failure, calls login() on success redirecting to dashboard. App.tsx implements auth guard: daemonShutdown -> ShutdownOverlay, !isAuthenticated -> Login, else -> placeholder (Layout pending 67-02). Vite build succeeds with all new files bundled.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin build` succeeds — all new TypeScript files compile and bundle
2. All new files exist in correct locations:
   - `packages/admin/src/auth/store.ts` — exports masterPassword, isAuthenticated, adminTimeout, daemonShutdown, login, logout, resetInactivityTimer
   - `packages/admin/src/auth/login.tsx` — exports Login component
   - `packages/admin/src/api/client.ts` — exports apiCall, apiGet, apiPost, apiPut, apiDelete, ApiError
   - `packages/admin/src/api/endpoints.ts` — exports API constant
3. `packages/admin/src/app.tsx` — auth guard renders Login or ShutdownOverlay or placeholder based on signals
4. `packages/admin/src/styles/global.css` — has light theme CSS variables (--color-primary: #2563eb, --color-bg: #ffffff)
5. `packages/admin/vite.config.ts` — has /v1 proxy to 127.0.0.1:3100
6. Existing daemon tests still pass: `pnpm --filter @waiaas/daemon test` (pre-existing failures excluded)
</verification>

<success_criteria>
- Auth store manages masterPassword signal, provides login/logout functions, tracks inactivity with configurable timeout
- Login form submits to GET /v1/admin/status, handles 200 (login + redirect), 401 (error message), network error (error message)
- API client wraps fetch with X-Master-Password header injection, 10s timeout, 401 auto-logout, error code parsing
- App component implements shutdown > login > authenticated priority rendering
- CSS variables updated from dark to light theme per design doc 67 section 9.2
- Vite dev proxy configured for /v1 -> daemon
- Build succeeds with all new modules bundled
</success_criteria>

<output>
After completion, create `.planning/phases/67-auth-api-client-components/67-01-SUMMARY.md`
</output>
