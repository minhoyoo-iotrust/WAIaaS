---
phase: 36-토큰-파일-인프라-알림-이벤트
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/35-notification-architecture.md
  - .planning/deliverables/53-session-renewal-protocol.md
  - objectives/v0.9-session-management-automation.md
autonomous: true

must_haves:
  truths:
    - "SESSION_EXPIRING_SOON 이벤트의 발생 조건(만료 24h 전 OR 잔여 갱신 3회 이하), 심각도(WARNING), 알림 내용(세션ID, 에이전트명, 만료시각, 잔여횟수)이 설계 문서에 정의되어 있다"
    - "NotificationEventType이 16개에서 17개로 확장되어 SESSION_EXPIRING_SOON이 추가되어 있다"
    - "데몬 측 SessionService.renewSession() 내 만료 임박 판단 로직(remainingRenewals <= 3 OR timeToExpiry <= 86400초)이 정의되어 있다"
    - "중복 알림 방지 메커니즘(notification_log 테이블 조회)이 정의되어 있다"
    - "갱신 실패 경로(403 RENEWAL_LIMIT_REACHED, SESSION_LIFETIME_EXCEEDED)에서의 보완 알림 트리거가 정의되어 있다"
  artifacts:
    - path: ".planning/deliverables/35-notification-architecture.md"
      provides: "SESSION_EXPIRING_SOON 이벤트 타입 + 알림 호출 포인트 + 메시지 스키마"
      contains: "SESSION_EXPIRING_SOON"
    - path: ".planning/deliverables/53-session-renewal-protocol.md"
      provides: "갱신 응답 후 만료 임박 판단 로직 + 실패 경로 보완 알림"
      contains: "SESSION_EXPIRING_SOON"
    - path: "objectives/v0.9-session-management-automation.md"
      provides: "NOTI-01, NOTI-02 설계 완료 상태"
      contains: "SESSION_EXPIRING_SOON"
  key_links:
    - from: "35-notification-architecture.md"
      to: "53-session-renewal-protocol.md"
      via: "SESSION_EXPIRING_SOON 이벤트가 갱신 API 응답 처리 시 트리거됨"
      pattern: "SESSION_EXPIRING_SOON"
    - from: "53-session-renewal-protocol.md"
      to: "35-notification-architecture.md"
      via: "notification_log 테이블로 중복 알림 방지"
      pattern: "notification_log"
---

<objective>
Phase 36의 Plan 02: SESSION_EXPIRING_SOON 알림 이벤트를 설계하고, 데몬 측 만료 임박 판단 로직을 정의한다.

Purpose: 세션 만료 사전 알림은 Owner가 예방적으로 대응(새 세션 생성 또는 갱신)할 수 있게 하여, 에이전트 서비스 중단을 방지한다. 기존 16개 NotificationEventType에 17번째 이벤트를 추가하고, 데몬 SessionService의 갱신 로직에 트리거 조건을 삽입하는 설계를 완료한다.
Output: (1) 35-notification-architecture.md에 SESSION_EXPIRING_SOON 이벤트 추가, (2) 53-session-renewal-protocol.md에 만료 임박 판단 로직 추가, (3) v0.9 objectives에 NOTI-01, NOTI-02 설계 완료 반영
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-토큰-파일-인프라-알림-이벤트/36-RESEARCH.md
@.planning/deliverables/35-notification-architecture.md
@.planning/deliverables/53-session-renewal-protocol.md
@.planning/deliverables/30-session-token-protocol.md
@objectives/v0.9-session-management-automation.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 35-notification-architecture.md에 SESSION_EXPIRING_SOON 이벤트 추가</name>
  <files>.planning/deliverables/35-notification-architecture.md</files>
  <action>
35-notification-architecture.md를 수정하여 SESSION_EXPIRING_SOON 이벤트를 추가한다. 다음 3개 영역을 수정:

**1. NotificationEventType 열거형 확장 (16 -> 17):**

기존 세션 관련 이벤트 그룹(`SESSION_CREATED`, `SESSION_REVOKED`, `SESSION_RENEWED`, `SESSION_RENEWAL_REJECTED`)에 `SESSION_EXPIRING_SOON`을 추가한다:

```typescript
// ── 세션 관련 (5개, 기존 4 + v0.9 추가 1) ──
SESSION_CREATED: 'SESSION_CREATED',
SESSION_REVOKED: 'SESSION_REVOKED',
SESSION_RENEWED: 'SESSION_RENEWED',
SESSION_RENEWAL_REJECTED: 'SESSION_RENEWAL_REJECTED',
SESSION_EXPIRING_SOON: 'SESSION_EXPIRING_SOON',   // [v0.9] 만료 임박 알림
```

문서 상단 요약이나 개요에서 "16개 NotificationEventType"을 "17개"로 업데이트한다 (해당 표현이 있는 모든 위치).

**2. 이벤트 심각도 + 전송 방식 테이블 업데이트:**

이벤트 심각도 테이블(이벤트별 severity와 전송 방식을 정리한 테이블)에 SESSION_EXPIRING_SOON 행을 추가:

| 이벤트 | 심각도 | 전송 방식 | 설명 |
|--------|:------:|----------|------|
| SESSION_EXPIRING_SOON | WARNING | notify() (표준) | [v0.9] 세션 만료 임박 — Owner 행동 필요 |

심각도 WARNING 근거: Owner의 사전 대응이 필요하지만, 즉시 위험은 아님. TX_APPROVAL_REQUEST와 동일 레벨.

**3. 알림 호출 포인트 테이블 (섹션 1.5) 업데이트:**

기존 알림 호출 포인트 테이블 마지막에 새 행 추가:

| 호출 포인트 | 이벤트 | 전송 방식 | 트리거 위치 |
|------------|--------|----------|------------|
| [v0.9] 세션 갱신 후 만료 임박 판단 | SESSION_EXPIRING_SOON | notify() (표준) | SessionService.renewSession() 200 OK 후 + 403 에러 경로 보완 |

**4. SESSION_EXPIRING_SOON 알림 데이터 스키마 추가:**

메시지 포맷/스키마 관련 섹션에 다음 Zod 스키마를 추가:

```typescript
// [v0.9] SESSION_EXPIRING_SOON 알림 데이터
export const SessionExpiringSoonDataSchema = z.object({
  sessionId: z.string().uuid(),            // 세션 UUID v7
  agentName: z.string(),                   // 에이전트 이름 (표시용)
  expiresAt: z.number().int(),             // 절대 만료 시각 (epoch seconds)
  remainingRenewals: z.number().int(),     // 잔여 갱신 횟수
})
```

**5. 중복 알림 방지 메커니즘 명시:**

SESSION_EXPIRING_SOON은 갱신 조건 충족 후 매 갱신마다 반복 트리거될 수 있으므로, 중복 방지 로직을 명시한다. 기존 `notification_log` 테이블을 활용:

```
중복 방지: notification_log 테이블 조회
- 조건: event = 'SESSION_EXPIRING_SOON' AND reference_id = sessionId AND status = 'sent'
- 이미 발송된 기록이 있으면 알림 스킵
- 인덱스: (event, reference_id) 복합 인덱스 추천 (기존 인덱스 활용 또는 v0.9 추가)
- 근거: DB 스키마 변경 최소화, 기존 알림 로그 인프라 활용, 데몬 재시작에도 상태 유지
```

대안(세션 테이블 expiring_notified_at 컬럼, 인메모리 Set)은 이 문서에 "대안으로 고려되었으나 채택하지 않음" 형태로 간략 기술한다.

모든 추가 내용에 `[v0.9]` 태그를 부여한다.
  </action>
  <verify>
35-notification-architecture.md에서 다음을 확인:
1. SESSION_EXPIRING_SOON이 NotificationEventType에 포함되어 있는지 grep
2. "17개" 또는 이벤트 수 업데이트가 반영되어 있는지 확인
3. 알림 호출 포인트 테이블에 SESSION_EXPIRING_SOON 행이 있는지 확인
4. SessionExpiringSoonDataSchema가 정의되어 있는지 확인
5. notification_log 기반 중복 방지 메커니즘이 기술되어 있는지 확인
6. [v0.9] 태그가 새 콘텐츠에 포함되어 있는지 확인
  </verify>
  <done>
35-notification-architecture.md에 (1) SESSION_EXPIRING_SOON이 17번째 이벤트로 추가, (2) 심각도 WARNING + notify() 전송 방식 정의, (3) 알림 호출 포인트에 SessionService.renewSession() 트리거 추가, (4) SessionExpiringSoonDataSchema Zod 스키마 정의, (5) notification_log 기반 중복 알림 방지 메커니즘 명시가 완료되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 53-session-renewal-protocol.md에 만료 임박 판단 로직 추가</name>
  <files>
.planning/deliverables/53-session-renewal-protocol.md
objectives/v0.9-session-management-automation.md
  </files>
  <action>
두 파일을 수정한다:

**파일 1: 53-session-renewal-protocol.md**

갱신 프로토콜 문서에 v0.9 만료 임박 판단 로직을 추가한다. 기존 갱신 시퀀스에 알림 트리거 단계를 삽입:

(a) **갱신 성공 경로에 알림 판단 추가:**

기존 갱신 성공 시퀀스(Guard 1-3 통과 -> 토큰 회전 -> DB 업데이트 -> 200 OK) 사이에 알림 판단 단계를 삽입. 시퀀스 다이어그램이 있다면 해당 위치에, 텍스트 설명이면 적절한 위치에 추가:

```
[기존] Guard 1-3 통과 -> 토큰 회전 -> DB renewal_count++
[v0.9 추가] -> 만료 임박 판단:
  remainingRenewals = maxRenewals - renewalCount
  timeToExpiry = absoluteExpiresAt - now (epoch seconds)
  EXPIRING_THRESHOLD_SECONDS = 86400 (24시간)
  RENEWAL_THRESHOLD = 3 (잔여 3회 이하)

  if (remainingRenewals <= RENEWAL_THRESHOLD OR timeToExpiry <= EXPIRING_THRESHOLD_SECONDS):
    notification_log에서 중복 확인 (event='SESSION_EXPIRING_SOON', reference_id=sessionId)
    중복이 아니면: notificationService.notify(SESSION_EXPIRING_SOON, {
      sessionId, agentName, expiresAt: absoluteExpiresAt, remainingRenewals
    })
[기존] -> 200 OK 응답
```

(b) **갱신 실패 경로에 보완 알림 추가:**

403 RENEWAL_LIMIT_REACHED (Guard 1 실패)와 403 SESSION_LIFETIME_EXCEEDED (Guard 2 실패) 에러 경로에서도 SESSION_EXPIRING_SOON 알림이 이전에 발송되지 않았을 경우 보완 발송하는 로직을 추가:

```
[v0.9 추가] Guard 1 실패 (RENEWAL_LIMIT_REACHED):
  -> notification_log 중복 확인
  -> 미발송이면: notify(SESSION_EXPIRING_SOON, { remainingRenewals: 0, ... })
  -> 403 응답

[v0.9 추가] Guard 2 실패 (SESSION_LIFETIME_EXCEEDED):
  -> notification_log 중복 확인
  -> 미발송이면: notify(SESSION_EXPIRING_SOON, { timeToExpiry <= 0, ... })
  -> 403 응답
```

근거: 이전 갱신에서 알림이 발송되었어야 하지만, 데몬 재시작이나 타이밍 이슈로 놓쳤을 수 있다. 보완 트리거로 Owner에게 최소 1회 알림을 보장한다.

(c) **shouldNotifyExpiringSession 판단 함수 설계:**

```typescript
// [v0.9] 만료 임박 판단 순수 함수
function shouldNotifyExpiringSession(
  remainingRenewals: number,
  absoluteExpiresAt: number,   // epoch seconds
  nowEpochSeconds: number,
): boolean {
  const EXPIRING_THRESHOLD_SECONDS = 24 * 60 * 60  // 24시간
  const RENEWAL_THRESHOLD = 3
  const timeToExpiry = absoluteExpiresAt - nowEpochSeconds
  return remainingRenewals <= RENEWAL_THRESHOLD
    || timeToExpiry <= EXPIRING_THRESHOLD_SECONDS
}
```

이 함수는 순수 함수로, 부수 효과 없이 판단만 수행한다. 알림 발송(notify)과 중복 확인(notification_log 조회)은 호출부(SessionService)에서 처리한다.

(d) **갱신 API 응답의 알림 연관 설명:**

갱신 API 200 OK 응답의 `renewalCount`와 `maxRenewals` 필드가 클라이언트(MCP SessionManager)에게도 잔여 횟수 정보를 제공하지만, 알림 트리거는 데몬 측에서 자동으로 수행됨을 명시. MCP 측에서 별도로 알림을 보내지 않는다.

모든 추가 내용에 `[v0.9]` 태그를 부여한다.

**파일 2: objectives/v0.9-session-management-automation.md**

v0.9 objectives 문서에 NOTI-01, NOTI-02 설계 완료 상태를 반영한다:
- NOTI-01 관련 내용에 설계 완료 표시
- NOTI-02 관련 내용에 설계 완료 표시
- 핵심 설계 결정 요약: 데몬 측 자동 판단, notification_log 중복 방지, 갱신 성공+실패 양쪽 경로 트리거, shouldNotifyExpiringSession 순수 함수
- 설계 문서 위치: 35-notification-architecture.md + 53-session-renewal-protocol.md
  </action>
  <verify>
53-session-renewal-protocol.md에서 다음을 확인:
1. SESSION_EXPIRING_SOON 문자열이 포함되어 있는지 grep
2. shouldNotifyExpiringSession 함수 정의가 있는지 확인
3. 갱신 실패 경로(403)에서의 보완 알림 트리거가 기술되어 있는지 확인
4. notification_log 중복 확인 로직이 있는지 확인
5. [v0.9] 태그가 새 콘텐츠에 포함되어 있는지 확인

objectives/v0.9-session-management-automation.md에서:
6. NOTI-01, NOTI-02 설계 완료 표시가 있는지 확인
  </verify>
  <done>
53-session-renewal-protocol.md에 (1) 갱신 성공 경로의 만료 임박 판단 단계, (2) 갱신 실패 경로의 보완 알림 트리거, (3) shouldNotifyExpiringSession 순수 함수 설계, (4) notification_log 중복 확인 로직이 추가되어 있다. objectives/v0.9에 NOTI-01, NOTI-02 설계 완료 상태가 반영되어 있다.
  </done>
</task>

</tasks>

<verification>
Phase 36 Success Criteria 중 Plan 02가 담당하는 항목:
1. [SC-3] SESSION_EXPIRING_SOON 이벤트의 발생 조건(만료 24h 전 OR 잔여 갱신 3회 이하), 심각도(WARNING), 알림 내용(세션ID, 에이전트명, 만료시각, 잔여횟수)이 정의되어 있다 -> 35-notification-architecture.md 확인
2. [SC-4] 데몬 측 만료 임박 판단 로직(갱신 API 응답 처리 시 잔여 횟수/절대 만료 체크, 알림 트리거)이 설계 문서에 정의되어 있다 -> 53-session-renewal-protocol.md 확인
</verification>

<success_criteria>
- 35-notification-architecture.md에 SESSION_EXPIRING_SOON이 17번째 이벤트로 등록됨
- 심각도 WARNING, 전송 방식 notify() (표준)이 정의됨
- 발생 조건: 절대 수명 만료 24시간 전 OR 잔여 갱신 3회 이하 (OR 논리)
- 알림 데이터: sessionId, agentName, expiresAt, remainingRenewals (Zod 스키마)
- notification_log 기반 중복 알림 방지 메커니즘이 정의됨
- 53-session-renewal-protocol.md에 갱신 성공/실패 양 경로의 알림 트리거가 정의됨
- shouldNotifyExpiringSession 순수 함수의 시그니처, 상수, 로직이 정의됨
- v0.9 objectives에 NOTI-01, NOTI-02 설계 완료 상태가 반영됨
</success_criteria>

<output>
After completion, create `.planning/phases/36-토큰-파일-인프라-알림-이벤트/36-02-SUMMARY.md`
</output>
