---
phase: 51-cli-e2e-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/package.json
  - packages/cli/src/index.ts
  - packages/cli/src/commands/init.ts
  - packages/cli/src/commands/start.ts
  - packages/cli/src/commands/stop.ts
  - packages/cli/src/commands/status.ts
  - packages/cli/src/utils/data-dir.ts
  - packages/cli/src/utils/password.ts
  - packages/cli/src/__tests__/cli-commands.test.ts
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "`waiaas init` creates data directory, config.toml, and keystore/ directory"
    - "`waiaas start` prompts for master password (or reads from env), starts daemon, health checks until ready"
    - "`waiaas stop` reads PID file, sends SIGTERM, waits for process exit"
    - "`waiaas status` reports running/stopped with port number"
    - "All 4 commands accept --data-dir option (default ~/.waiaas/)"
  artifacts:
    - path: "packages/cli/src/index.ts"
      provides: "CLI entry point with commander program and 4 subcommands"
      contains: "program.command"
    - path: "packages/cli/src/commands/init.ts"
      provides: "init command handler"
      contains: "mkdirSync"
    - path: "packages/cli/src/commands/start.ts"
      provides: "start command handler with password prompt and health check"
      contains: "startDaemon"
    - path: "packages/cli/src/commands/stop.ts"
      provides: "stop command handler with PID file + SIGTERM"
      contains: "process.kill"
    - path: "packages/cli/src/commands/status.ts"
      provides: "status command handler with PID check + health probe"
      contains: "running"
  key_links:
    - from: "packages/cli/src/commands/start.ts"
      to: "packages/daemon/src/index.ts"
      via: "import { startDaemon } from '@waiaas/daemon'"
      pattern: "startDaemon"
    - from: "packages/cli/src/commands/init.ts"
      to: "packages/daemon/src/infrastructure/config/loader.ts"
      via: "DaemonConfigSchema defaults for config.toml generation"
      pattern: "config\\.toml"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/bin/waiaas"
      via: "bin entry imports dist/index.js"
      pattern: "commander"
---

<objective>
Implement the 4 CLI commands (init, start, stop, status) for the @waiaas/cli package using commander.js. This gives users the ability to bootstrap, run, manage, and monitor the WAIaaS daemon entirely from the terminal.

Purpose: Complete the CLI layer so the full user journey (init -> start -> use API -> stop) is possible from a single `waiaas` binary.
Output: 4 functional CLI commands with unit tests, resolving TD-10 (CLI framework = commander).
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-api-solana-pipeline/50-03-SUMMARY.md
@.planning/phases/49-daemon-infra/49-03-SUMMARY.md

# Key source files
@packages/daemon/src/index.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/infrastructure/config/loader.ts
@packages/cli/package.json
@packages/cli/src/index.ts
@packages/cli/bin/waiaas
@packages/cli/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI framework setup + 4 commands (init, start, stop, status)</name>
  <files>
    packages/cli/package.json
    packages/cli/src/index.ts
    packages/cli/src/commands/init.ts
    packages/cli/src/commands/start.ts
    packages/cli/src/commands/stop.ts
    packages/cli/src/commands/status.ts
    packages/cli/src/utils/data-dir.ts
    packages/cli/src/utils/password.ts
    pnpm-lock.yaml
  </files>
  <action>
    **TD-10 Decision: Use `commander` ^13.x** -- lightweight, stable, ESM-native, well-documented. 4 commands is within commander's sweet spot. Install: `pnpm add commander --filter=@waiaas/cli`.

    **packages/cli/src/utils/data-dir.ts** -- shared utility:
    - `resolveDataDir(opts?: { dataDir?: string }): string` -- returns `opts.dataDir ?? process.env.WAIAAS_DATA_DIR ?? path.join(os.homedir(), '.waiaas')`
    - Export as named export

    **packages/cli/src/utils/password.ts** -- password resolution:
    - `resolvePassword(): Promise<string>` -- checks:
      1. `process.env.WAIAAS_MASTER_PASSWORD` -- return directly if set
      2. `process.env.WAIAAS_MASTER_PASSWORD_FILE` -- read file content, trim
      3. Interactive: use Node.js readline with `process.stdin` / `process.stdout`, input masked (set terminal raw mode or use `\x1B[8m` ANSI hide). Prompt "Master password: ", read line, return trimmed.
    - For v1.1 simplicity, the interactive prompt does NOT need confirmation (that is for init in v1.2+). Just a single password read.
    - Validate: minimum 1 character (v1.1 does not enforce 12-char minimum -- that is a v1.2 concern when init is fully spec'd)

    **packages/cli/src/commands/init.ts** -- `initCommand(dataDir: string): Promise<void>`:
    - Create data directory: `mkdirSync(dataDir, { recursive: true })` with mode 0o700
    - Create subdirectories: `keystore/`, `data/`, `logs/`, `backups/`
    - Generate default `config.toml`: write a minimal TOML file with comments:
      ```toml
      # WAIaaS Daemon Configuration
      # See documentation for all available options

      [daemon]
      port = 3100
      hostname = "127.0.0.1"

      [database]
      path = "data/waiaas.db"
      ```
      Use `writeFileSync(path.join(dataDir, 'config.toml'), content, { mode: 0o644 })`. Skip if file already exists (idempotent).
    - Print success message with created paths
    - Print "Next: waiaas start" hint
    - If data dir already exists and config.toml already exists, print "Already initialized" and exit 0 (idempotent)

    **packages/cli/src/commands/start.ts** -- `startCommand(dataDir: string): Promise<void>`:
    - Check if already running: read PID file (`{dataDir}/daemon.pid`). If exists and `process.kill(pid, 0)` succeeds, print "Daemon already running (PID: {pid})" and exit 1.
    - Resolve password via `resolvePassword()`
    - Call `startDaemon(dataDir, password)` from `@waiaas/daemon` -- this is an in-process start (the daemon runs in the CLI process)
    - After startDaemon resolves, print: `WAIaaS daemon started on 127.0.0.1:3100 (PID: {process.pid})`
    - The process stays alive (signal handlers from registerSignalHandlers keep it running)
    - On startup error, print error message to stderr and exit 1

    **packages/cli/src/commands/stop.ts** -- `stopCommand(dataDir: string): Promise<void>`:
    - Read PID file: `{dataDir}/daemon.pid` -- if not exists, print "Daemon is not running" and exit 0
    - Parse PID as integer
    - Check if process alive: `process.kill(pid, 0)` -- if throws (ESRCH), print "Daemon is not running (stale PID file)", delete PID file, exit 0
    - Send SIGTERM: `process.kill(pid, 'SIGTERM')`
    - Poll every 500ms for up to 10s: check if PID file deleted or process no longer alive
    - On success: print "Daemon stopped"
    - On timeout: print "Daemon did not stop within 10s, sending SIGKILL", then `process.kill(pid, 'SIGKILL')`, print "Daemon killed"

    **packages/cli/src/commands/status.ts** -- `statusCommand(dataDir: string): Promise<void>`:
    - Read PID file: `{dataDir}/daemon.pid`
    - If no PID file: print "Status: stopped" and exit 0
    - If PID file exists, check process alive via `process.kill(pid, 0)`
    - If alive, try health check: `fetch('http://127.0.0.1:{port}/health')` where port comes from config.toml (load via `loadConfig(dataDir)` if config exists, default 3100)
    - If health check 200: print "Status: running (PID: {pid}, Port: {port})"
    - If health check fails but process alive: print "Status: starting (PID: {pid})"
    - If process not alive: print "Status: stopped (stale PID file)", clean up PID file

    **packages/cli/src/index.ts** -- CLI entry point:
    ```typescript
    import { Command } from 'commander';
    import { initCommand } from './commands/init.js';
    import { startCommand } from './commands/start.js';
    import { stopCommand } from './commands/stop.js';
    import { statusCommand } from './commands/status.js';
    import { resolveDataDir } from './utils/data-dir.js';

    const program = new Command();

    program
      .name('waiaas')
      .description('WAIaaS - AI Agent Wallet-as-a-Service')
      .version('0.0.0');

    program
      .command('init')
      .description('Initialize WAIaaS data directory')
      .option('--data-dir <path>', 'Data directory path')
      .action(async (opts) => {
        const dataDir = resolveDataDir(opts);
        await initCommand(dataDir);
      });

    program
      .command('start')
      .description('Start the WAIaaS daemon')
      .option('--data-dir <path>', 'Data directory path')
      .action(async (opts) => {
        const dataDir = resolveDataDir(opts);
        await startCommand(dataDir);
      });

    program
      .command('stop')
      .description('Stop the WAIaaS daemon')
      .option('--data-dir <path>', 'Data directory path')
      .action(async (opts) => {
        const dataDir = resolveDataDir(opts);
        await stopCommand(dataDir);
      });

    program
      .command('status')
      .description('Check WAIaaS daemon status')
      .option('--data-dir <path>', 'Data directory path')
      .action(async (opts) => {
        const dataDir = resolveDataDir(opts);
        await statusCommand(dataDir);
      });

    program.parseAsync(process.argv).catch((err) => {
      console.error(err.message);
      process.exit(1);
    });
    ```

    **packages/cli/package.json** -- add `commander` dependency:
    ```json
    "dependencies": {
      "@waiaas/core": "workspace:*",
      "@waiaas/daemon": "workspace:*",
      "commander": "^13.0.0"
    }
    ```

    Run `pnpm install --filter=@waiaas/cli` then `pnpm build --filter=@waiaas/cli` to verify compilation.
  </action>
  <verify>
    - `pnpm build --filter=@waiaas/cli` succeeds
    - `pnpm typecheck --filter=@waiaas/cli` succeeds
    - `node packages/cli/dist/index.js --help` shows 4 commands (init, start, stop, status)
    - `node packages/cli/dist/index.js init --help` shows --data-dir option
  </verify>
  <done>
    4 CLI commands (init, start, stop, status) are implemented with shared --data-dir option and password resolution. CLI builds and shows help text. TD-10 resolved as commander ^13.x.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI command unit tests</name>
  <files>
    packages/cli/src/__tests__/cli-commands.test.ts
  </files>
  <action>
    Write Vitest unit tests for CLI commands. These are NOT E2E tests (those are Plan 51-02). These test individual command functions with mocked dependencies.

    **packages/cli/src/__tests__/cli-commands.test.ts**:

    Use `vi.mock` to mock `@waiaas/daemon` (startDaemon), `node:fs` (readFileSync, writeFileSync, mkdirSync, existsSync, unlinkSync), `node:child_process`, and fetch.

    Test groups:

    **resolveDataDir tests (3):**
    - Returns --data-dir option when provided
    - Returns WAIAAS_DATA_DIR env when set (no --data-dir)
    - Returns ~/.waiaas/ default when neither provided

    **initCommand tests (4):**
    - Creates data directory + subdirectories + config.toml when none exist
    - Skips config.toml creation if already exists (idempotent)
    - Creates directory with 0o700 permissions
    - Generated config.toml contains [daemon] and [database] sections

    **startCommand tests (3):**
    - Calls startDaemon with dataDir and password
    - Exits with error if daemon already running (PID file exists, process alive)
    - Prints error and exits 1 on startDaemon failure

    **stopCommand tests (4):**
    - Reads PID file, sends SIGTERM to running process
    - Prints "not running" if no PID file
    - Cleans up stale PID file when process not alive (ESRCH)
    - Sends SIGKILL after timeout (mock setTimeout/polling)

    **statusCommand tests (3):**
    - Reports "running" when PID file exists and health check succeeds
    - Reports "stopped" when no PID file
    - Reports "stopped (stale PID)" when PID file exists but process not alive

    Total: ~17 tests. Use `tmpdir` for data directory isolation. Mock `process.kill` for PID checks. Mock `fetch` for health checks.

    Run `pnpm test --filter=@waiaas/cli` to verify.
  </action>
  <verify>
    - `pnpm test --filter=@waiaas/cli` passes all tests
    - `pnpm test` from root passes (all packages including cli)
    - No existing tests broken
  </verify>
  <done>
    17+ CLI unit tests pass covering all 4 commands + utility functions. Total test count increases from 167 to ~184.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds across all packages
2. `pnpm test` passes all tests (existing 167 + new CLI tests)
3. `pnpm lint` passes
4. `node packages/cli/dist/index.js --help` displays 4 commands
5. `node packages/cli/dist/index.js init --data-dir /tmp/waiaas-test` creates directory structure
</verification>

<success_criteria>
- CLI package builds and links correctly in monorepo
- 4 commands (init, start, stop, status) accept --data-dir flag
- init creates data dir + config.toml + keystore/
- start calls startDaemon from @waiaas/daemon
- stop reads PID + sends SIGTERM
- status reports running/stopped with port
- 17+ unit tests pass
- TD-10 resolved: commander ^13.x
</success_criteria>

<output>
After completion, create `.planning/phases/51-cli-e2e-integration/51-01-SUMMARY.md`
</output>
