---
phase: 27-daemon-security-foundation
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - .planning/deliverables/29-api-framework-design.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/36-killswitch-autostop-evm.md
  - .planning/deliverables/52-auth-model-redesign.md
  - .planning/deliverables/24-monorepo-data-directory.md
autonomous: true

must_haves:
  truths:
    - "미들웨어 순서가 9단계에서 10단계로 변경되어 #3.5 globalRateLimit(IP 1000/min)과 #9 sessionRateLimit(세션 300/min, tx 10/min)이 분리되었다"
    - "미인증 공격자가 대량 요청으로 인증 사용자의 세션별 rate limit을 소진할 수 없다"
    - "killSwitchGuard 허용 엔드포인트가 4개(health/status/recover/kill-switch)로 확정되고 HTTP 503 SYSTEM_LOCKED 응답이 정의되었다"
    - "recover 경로가 /v1/admin/recover로 통일되었다"
  artifacts:
    - path: ".planning/deliverables/29-api-framework-design.md"
      provides: "10단계 미들웨어 순서, globalRateLimit + sessionRateLimit 분리 설계, registerMiddleware 갱신"
      contains: "globalRateLimit"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "미들웨어 순서 갱신, killSwitchGuard 503 응답, SYSTEM_LOCKED 에러 코드"
      contains: "SYSTEM_LOCKED"
    - path: ".planning/deliverables/36-killswitch-autostop-evm.md"
      provides: "ACTIVATED 상태 허용 목록 4개, HTTP 503"
      contains: "KILL_SWITCH_ALLOWED_PATHS"
    - path: ".planning/deliverables/52-auth-model-redesign.md"
      provides: "killSwitchGuard 허용 목록 갱신, recover 경로 변경"
      contains: "/v1/admin/recover"
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "rate_limit_global_ip_rpm 설정 추가"
      contains: "rate_limit_global_ip_rpm"
  key_links:
    - from: "29-api-framework-design.md (#3.5 globalRateLimit)"
      to: "37-rest-api-complete-spec.md (미들웨어 순서)"
      via: "두 문서의 미들웨어 순서/번호가 동일해야 함"
      pattern: "globalRateLimit.*#3\\.5|#3\\.5.*globalRateLimit"
    - from: "36-killswitch-autostop-evm.md (허용 목록)"
      to: "52-auth-model-redesign.md (killSwitchGuard)"
      via: "두 문서의 허용 경로 목록이 동일해야 함"
      pattern: "/v1/admin/recover"
    - from: "24-monorepo-data-directory.md (rate_limit_global_ip_rpm)"
      to: "29-api-framework-design.md (globalRateLimit config)"
      via: "config 키명이 코드에서 참조하는 이름과 동일"
      pattern: "rate_limit_global_ip_rpm"
---

<objective>
Rate Limiter를 2단계(globalRateLimit + sessionRateLimit)로 분리하고 killSwitchGuard 허용 엔드포인트를 4개로 확정한다.

Purpose: DAEMON-03(미인증 공격자의 인증 사용자 rate limit 소진) + DAEMON-04(killSwitchGuard 불완전 허용 목록, 부적절한 401 응답) 해소. 미들웨어 순서 재정의로 보안 계층 분리를 확립한다.
Output: 29-api-framework-design.md, 37-rest-api-complete-spec.md, 36-killswitch-autostop-evm.md, 52-auth-model-redesign.md, 24-monorepo-data-directory.md 수정
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-daemon-security-foundation/27-RESEARCH.md

@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/36-killswitch-autostop-evm.md
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/24-monorepo-data-directory.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rate Limiter 2단계 분리 (DAEMON-03)</name>
  <files>
    .planning/deliverables/29-api-framework-design.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/24-monorepo-data-directory.md
  </files>
  <action>
**29-api-framework-design.md 수정:**

1. 섹션 2.1 (미들웨어 실행 순서)에 [v0.7 보완] 태그와 함께 9단계를 10단계로 변경:
   ```
   #1 requestId -> #2 requestLogger -> #3 shutdownGuard -> #3.5 globalRateLimit(IP, 1000/min)
   -> #4 secureHeaders -> #5 hostValidation -> #6 cors -> #7 killSwitchGuard
   -> #8 authRouter -> #9 sessionRateLimit(session 300/min, tx 10/min)
   ```
   - 기존 #7 rateLimiter 삭제, #3.5 globalRateLimit + #9 sessionRateLimit로 분리
   - killSwitchGuard #8->#7, authRouter #9->#8로 이동
   - 각 미들웨어의 목적과 키 방식을 표로 정리

2. 섹션 2.2 (미들웨어 등록 코드) `registerMiddleware()` 함수 갱신:
   - shutdownGuard 직후 `globalRateLimitMiddleware({ maxRpm: config.security.rate_limit_global_ip_rpm, windowMs: 60_000 })` 추가
   - 기존 rateLimiter 미들웨어 호출 삭제
   - authRouter 직후 `sessionRateLimitMiddleware({ sessionRpm: config.security.rate_limit_session_rpm, txRpm: config.security.rate_limit_tx_rpm })` 추가
   - TypeScript 코드 예시 포함 (27-RESEARCH.md의 코드 예시 참조)

3. 섹션 7 (Rate Limiter) 전면 재구성 [v0.7 보완]:
   - 기존 3-level(global/session/tx) 구조를 2-stage(globalRateLimit/sessionRateLimit) 구조로 변경
   - Stage 1 globalRateLimit:
     - 키: c.req.header('x-forwarded-for') || c.env.incoming.socket.remoteAddress || '127.0.0.1'
     - 한도: rate_limit_global_ip_rpm (기본 1000)
     - 저장소: lru-cache (IP별 timestamp 배열)
     - 위치: #3.5 (shutdownGuard 직후, 인증 전)
     - 목적: "절대 상한(absolute ceiling). localhost에서는 IP='127.0.0.1' 고정이므로 사실상 전체 요청 속도 상한. Docker 0.0.0.0 바인딩 시 실제 IP 분리 가능."
   - Stage 2 sessionRateLimit:
     - 키: sessionId (c.get('session').id) 또는 authType=master인 경우 'master'
     - 한도: session 300 req/min, tx 엔드포인트 10 req/min
     - 저장소: lru-cache (sessionId별 timestamp 배열)
     - 위치: #9 (authRouter 직후, 인증 완료 후)
     - 목적: "인증된 사용자별 세분화 제한. 미인증 요청은 Stage 1에서만 제한됨."
   - 엔드포인트별 오버라이드는 Stage 2에서만 적용
   - 429 응답: Retry-After 헤더 포함, Stage별 구분 가능한 에러 메시지

**37-rest-api-complete-spec.md 수정:**

1. 섹션 4.1 (미들웨어 순서)에 [v0.7 보완] 태그:
   - 9단계 -> 10단계 순서로 갱신 (29-api-framework-design.md와 동일한 순서)
   - 기존 #7 rateLimiter -> #3.5 globalRateLimit + #9 sessionRateLimit 변경 반영
   - killSwitchGuard, authRouter 번호 변경 반영

**24-monorepo-data-directory.md 수정:**

1. config.toml [security] 섹션에 [v0.7 보완]:
   - 기존 `rate_limit_global_rpm = 100`을 `rate_limit_global_ip_rpm = 1000`으로 이름/값 변경
   - 주석: "# [v0.7 보완] 기존 rate_limit_global_rpm 폐기. IP 기반 DoS 방어 상한. localhost에서는 absolute ceiling."
   - 기존 `rate_limit_session_rpm = 300`, `rate_limit_tx_rpm = 10`은 유지 (sessionRateLimit으로 이동됨을 주석으로 명시)

모든 수정에 `[v0.7 보완]` 태그를 붙여 추적 가능하게 한다.
  </action>
  <verify>
1. 29-api-framework-design.md에서 "globalRateLimit" 검색 -> 존재 (미들웨어 순서 + 등록 코드 + Rate Limiter 섹션)
2. 29-api-framework-design.md에서 "sessionRateLimit" 검색 -> 존재
3. 29-api-framework-design.md에서 "#3.5" 검색 -> 존재
4. 37-rest-api-complete-spec.md에서 "globalRateLimit" 검색 -> 존재
5. 24-monorepo-data-directory.md에서 "rate_limit_global_ip_rpm" 검색 -> 존재
  </verify>
  <done>
Rate Limiter가 2단계(#3.5 globalRateLimit IP 1000/min + #9 sessionRateLimit session 300/min)로 분리되어 3개 문서에 반영 완료. 미인증 공격자가 인증 사용자의 rate limit을 소진할 수 없는 구조 확립.
  </done>
</task>

<task type="auto">
  <name>Task 2: killSwitchGuard 허용 목록 확정 + 503 응답 (DAEMON-04)</name>
  <files>
    .planning/deliverables/36-killswitch-autostop-evm.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/52-auth-model-redesign.md
  </files>
  <action>
**36-killswitch-autostop-evm.md 수정:**

1. 섹션 2.4 (ACTIVATED 상태 API 동작)에 [v0.7 보완] 태그와 함께:
   - 허용 목록 3개 -> 4개로 확장:
     ```typescript
     const KILL_SWITCH_ALLOWED_PATHS = [
       { method: 'GET',  path: '/v1/health' },              // 헬스체크 (무인증)
       { method: 'GET',  path: '/v1/admin/status' },        // 상태 확인 (masterAuth)
       { method: 'POST', path: '/v1/admin/recover' },       // 복구 (dualAuth: ownerAuth + masterAuth)
       { method: 'GET',  path: '/v1/admin/kill-switch' },   // Kill Switch 상태 조회 (masterAuth) [v0.7 신규]
     ]
     ```
   - 중요 경로 변경: 기존 `/v1/owner/recover`가 있었다면 `/v1/admin/recover`로 변경. 이유: objectives v0.7에서 확정. dualAuth(ownerAuth + masterAuth)가 적용되는 복구 경로는 admin 도메인이 적절 (Kill Switch는 시스템 수준 비상 기능).
   - HTTP 상태 코드 변경: 401 -> 503 Service Unavailable
   - 응답 본문: `{ error: { code: 'SYSTEM_LOCKED', message: 'System is in kill switch mode.', hint: 'Use POST /v1/admin/recover to restore normal operation.', details: { activatedAt, reason }, requestId } }`
   - 에러 코드 테이블에 SYSTEM_LOCKED (503) 추가

**37-rest-api-complete-spec.md 수정:**

1. 섹션 4.2 (killSwitchGuard 동작) 또는 해당 위치에 [v0.7 보완]:
   - 허용 목록 4개로 갱신 (36-killswitch와 동일)
   - SYSTEM_LOCKED 503 응답 스펙 추가
   - 에러 코드 테이블에 SYSTEM_LOCKED 추가: `{ code: 'SYSTEM_LOCKED', status: 503, message: 'System is in kill switch mode.', retryable: false }`
   - recover 경로를 `/v1/admin/recover`로 표기 (기존 `/v1/owner/recover`에서 변경)

**52-auth-model-redesign.md 수정:**

1. 섹션 7.4 (killSwitchGuard 허용 목록) 또는 해당 위치에 [v0.7 보완]:
   - 허용 목록 4개로 갱신
   - recover 경로 변경 반영: `/v1/owner/recover` -> `/v1/admin/recover`
   - 변경 사유 주석: "[v0.7 보완] Kill Switch 복구는 시스템 수준 비상 기능이므로 admin 도메인으로 이동. dualAuth(ownerAuth + masterAuth) 인증은 유지."
   - 이 경로 변경이 다른 섹션(recover 관련)에도 영향을 미치면 해당 부분도 함께 갱신

모든 수정에 `[v0.7 보완]` 태그를 붙여 추적 가능하게 한다.
  </action>
  <verify>
1. 36-killswitch-autostop-evm.md에서 "KILL_SWITCH_ALLOWED_PATHS" 또는 허용 목록 4개 항목 검색 -> 4개 존재
2. 36-killswitch-autostop-evm.md에서 "503" 검색 -> 존재
3. 36-killswitch-autostop-evm.md에서 "SYSTEM_LOCKED" 검색 -> 존재
4. 37-rest-api-complete-spec.md에서 "SYSTEM_LOCKED" 검색 -> 존재
5. 52-auth-model-redesign.md에서 "/v1/admin/recover" 검색 -> 존재
6. 3개 문서의 허용 목록이 동일한 4개 경로를 포함하는지 확인
  </verify>
  <done>
killSwitchGuard 허용 엔드포인트가 4개(health/status/recover/kill-switch)로 확정. HTTP 503 SYSTEM_LOCKED 응답 정의 완료. recover 경로가 /v1/admin/recover로 3개 문서에서 통일.
  </done>
</task>

</tasks>

<verification>
1. DAEMON-03 검증: 29-api-framework-design.md에 10단계 미들웨어 순서 + globalRateLimit/sessionRateLimit 2단계 설계 존재
2. DAEMON-04 검증: 36-killswitch, 37-rest-api, 52-auth 3개 문서에서 killSwitchGuard 허용 목록 4개가 동일
3. 크로스 문서 정합성: 미들웨어 순서(29-api + 37-rest-api 동일), 허용 목록(36 + 37 + 52 동일), config 키(24-monorepo + 29-api 동일)
4. recover 경로가 /v1/admin/recover로 모든 관련 문서에서 통일
</verification>

<success_criteria>
- Rate Limiter가 2단계(globalRateLimit #3.5 + sessionRateLimit #9)로 분리되어 미인증/인증 공격 벡터가 분리됨
- killSwitchGuard 허용 목록 4개 확정, HTTP 503 SYSTEM_LOCKED 응답 정의
- recover 경로 /v1/admin/recover 통일
- 5개 문서 모두 [v0.7 보완] 태그로 추적 가능
</success_criteria>

<output>
After completion, create `.planning/phases/27-daemon-security-foundation/27-02-SUMMARY.md`
</output>
