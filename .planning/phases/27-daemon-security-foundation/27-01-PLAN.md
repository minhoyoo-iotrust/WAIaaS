---
phase: 27-daemon-security-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/30-session-token-protocol.md
  - .planning/deliverables/28-daemon-lifecycle-cli.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/24-monorepo-data-directory.md
autonomous: true

must_haves:
  truths:
    - "JWT Secret 변경 시 current/previous dual-key 구조로 5분 전환 윈도우가 존재하여 기존 세션이 즉시 무효화되지 않는다"
    - "데몬 인스턴스 잠금이 flock 기반(fd 유지)으로 전환되어 PID 파일의 check-then-act 경쟁 조건이 제거되었다"
    - "waiaas secret rotate CLI 명령과 POST /v1/admin/rotate-secret API가 정의되었다"
    - "데몬 시작 시 rotatedAt 확인하여 5분 초과 시 previous 즉시 삭제하는 초기화 로직이 명시되었다"
  artifacts:
    - path: ".planning/deliverables/30-session-token-protocol.md"
      provides: "JwtSecretManager 인터페이스, dual-key 검증 순서, system_state 저장, 5분 전환 윈도우"
      contains: "JwtSecretManager"
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "flock 기반 daemon.lock 잠금, Graceful Shutdown closeSync(lockFd), waiaas secret rotate CLI"
      contains: "daemon.lock"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "POST /v1/admin/rotate-secret 엔드포인트"
      contains: "rotate-secret"
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "security.jwt_secret 초기값 전용 명시"
      contains: "jwt_secret"
  key_links:
    - from: "30-session-token-protocol.md (JwtSecretManager)"
      to: "28-daemon-lifecycle-cli.md (waiaas secret rotate)"
      via: "CLI가 rotateJwtSecret() 호출하여 system_state 갱신"
      pattern: "rotateJwtSecret|SECRET_ROTATED"
    - from: "37-rest-api-complete-spec.md (rotate-secret API)"
      to: "30-session-token-protocol.md (JwtSecretManager)"
      via: "API 엔드포인트가 동일한 rotateJwtSecret() 호출"
      pattern: "rotate-secret.*masterAuth"
    - from: "28-daemon-lifecycle-cli.md (acquireDaemonLock)"
      to: "28-daemon-lifecycle-cli.md (finalCleanup)"
      via: "lockFd가 시작 시 획득되어 종료 시 closeSync로 해제"
      pattern: "acquireDaemonLock|closeSync.*lockFd"
---

<objective>
JWT Secret dual-key rotation 메커니즘과 flock 기반 데몬 인스턴스 잠금을 기존 설계 문서에 [v0.7 보완] 태그로 추가한다.

Purpose: DAEMON-01(JWT Secret 변경 시 모든 세션 즉시 무효화) + DAEMON-02(PID 파일 TOCTOU 경쟁 조건) 해소. 데몬의 두 가지 CRITICAL 보안 장애 요소를 제거하여 구현 시 경쟁 조건 없이 동작하는 설계를 확보한다.
Output: 30-session-token-protocol.md, 28-daemon-lifecycle-cli.md, 37-rest-api-complete-spec.md, 24-monorepo-data-directory.md 수정
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-daemon-security-foundation/27-RESEARCH.md

@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/28-daemon-lifecycle-cli.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/24-monorepo-data-directory.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: JWT Secret dual-key rotation 설계 보완 (DAEMON-01)</name>
  <files>
    .planning/deliverables/30-session-token-protocol.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/24-monorepo-data-directory.md
  </files>
  <action>
**30-session-token-protocol.md 수정:**

1. 섹션 2.7 (JWT Secret 관리)에 [v0.7 보완] 태그와 함께 다음 추가:
   - `JwtSecretManager` 인터페이스 정의: `{ current: Uint8Array, previous?: Uint8Array, rotatedAt?: number }`
   - JWT 검증 순서: try current -> catch시 previous 존재 + rotatedAt 5분 이내이면 previous 시도 -> 둘 다 실패시 에러
   - system_state 테이블 키-값 3개: `jwt_secret_current` (hex), `jwt_secret_previous` (hex|null), `jwt_secret_rotated_at` (epoch ms|null)
   - `rotateJwtSecret()` 함수 스펙: BEGIN IMMEDIATE 트랜잭션으로 current->previous 이동 + 새 secret 생성 + audit_log SECRET_ROTATED
   - 데몬 시작 초기화: system_state에서 rotatedAt 확인, 5분 경과 시 previous 즉시 null 설정 + audit_log PREVIOUS_SECRET_EXPIRED

2. 섹션 2.7.5 (Secret 변경의 영향) 수정:
   - 기존 "즉시 무효화" 설명을 "5분 전환 윈도우" 설명으로 교체
   - 전환 윈도우 5분은 고정값(config 불가), 자동 로테이션 미지원(운영자 명시적 실행만)
   - config.toml의 `security.jwt_secret`은 `waiaas init` 시 초기값으로만 사용, 이후 DB(system_state)에서 관리됨을 명시

**37-rest-api-complete-spec.md 수정:**

1. Admin API 섹션에 `POST /v1/admin/rotate-secret` 엔드포인트 추가:
   - 인증: masterAuth explicit (X-Master-Password 헤더)
   - 요청 본문: 없음
   - 응답 200: `{ previousExpiry: ISO8601 }` (5분 후 시각)
   - 응답 429: 이전 로테이션 후 5분 미경과 시 거부 (연속 로테이션 방지)
   - audit_log: SECRET_ROTATED 이벤트

**24-monorepo-data-directory.md 수정:**

1. config.toml [security] 섹션에서 `jwt_secret` 항목에 [v0.7 보완] 주석 추가:
   - "초기값 전용. waiaas init 시 32바이트 랜덤 생성하여 config에 기록. 이후 DB system_state에서 관리. waiaas secret rotate 시 config.toml은 갱신하지 않음."

모든 수정에 `[v0.7 보완]` 태그를 붙여 추적 가능하게 한다.
  </action>
  <verify>
1. 30-session-token-protocol.md에서 "JwtSecretManager" 문자열 검색 -> 존재
2. 30-session-token-protocol.md에서 "rotateJwtSecret" 문자열 검색 -> 존재
3. 30-session-token-protocol.md에서 "5분 전환 윈도우" 또는 "TRANSITION_WINDOW" 검색 -> 존재
4. 37-rest-api-complete-spec.md에서 "rotate-secret" 검색 -> 존재
5. 24-monorepo-data-directory.md에서 "초기값 전용" 검색 -> 존재
  </verify>
  <done>
JWT Secret dual-key rotation 메커니즘이 30-session-token-protocol.md에 완전히 정의되고, rotate API/CLI가 37-rest-api/28-daemon에 추가되고, config.toml 초기값 역할이 24-monorepo에 명시됨
  </done>
</task>

<task type="auto">
  <name>Task 2: flock 기반 데몬 인스턴스 잠금 전환 (DAEMON-02)</name>
  <files>
    .planning/deliverables/28-daemon-lifecycle-cli.md
  </files>
  <action>
**28-daemon-lifecycle-cli.md 수정:**

1. 섹션 2.2 Step 1 (환경 검증)에 [v0.7 보완] 태그와 함께:
   - 기존 PID 파일 기반 `isProcessRunning(pid)` 감지 로직을 **flock 기반 잠금으로 교체**
   - `acquireDaemonLock(dataDir)` 함수 스펙:
     - `lockPath = path.join(dataDir, 'daemon.lock')`
     - `openSync(lockPath, 'w')` (O_WRONLY | O_CREAT | O_TRUNC)
     - flock exclusive non-blocking 시도 (fs-ext `flockSync(fd, 'exnb')` 또는 Node.js 네이티브 대안)
     - 성공: fd 반환 (데몬 수명 동안 유지), lock 파일에 PID 기록 (`writeSync(fd, String(process.pid))`)
     - 실패(EWOULDBLOCK/EAGAIN): `closeSync(fd)` 후 `DaemonError('ALREADY_RUNNING', ...)` throw
   - Windows fallback: HTTP 포트 바인딩 자체가 단일 인스턴스 보장 (127.0.0.1:3100 bind 실패 = 이미 실행 중). Windows에서는 flock 미사용, 포트 바인딩으로 대체.
   - 기존 PID 파일 감지 코드는 삭제하지 않고, "PID 파일은 status 명령의 보조 정보로만 사용" 주석으로 역할 변경 명시

2. 섹션 3 (종료 시퀀스) Graceful Shutdown Step 10에 [v0.7 보완] 추가:
   - 기존 `unlinkSync(pidPath)` 직전에 `closeSync(lockFd)` 추가
   - 순서: db.close() -> closeSync(lockFd) -> unlinkSync(pidPath)
   - 주석: "closeSync는 명시적 정리. OS가 프로세스 종료 시 자동 해제하므로 비정상 종료에도 안전"

3. 섹션 5 (프로세스 관리)에 [v0.7 보완]:
   - PID 파일(daemon.pid) 스펙을 "보조 정보" 등급으로 격하
   - daemon.lock 파일 스펙 추가: 경로 `~/.waiaas/daemon.lock`, fd 유지 기반 잠금, 내용물은 PID (보조 정보)
   - status 명령의 프로세스 확인 순서: (1) daemon.lock fd 잠금 시도 -> (2) 실패 시 lock 파일 내 PID로 health check 호출 -> (3) 성공 시 running, 실패 시 stale

4. CLI 커맨드 섹션에 `waiaas secret rotate` 추가:
   - 설명: "JWT Secret을 로테이션합니다. 기존 세션은 5분간 유효합니다."
   - 동작: HTTP POST /v1/admin/rotate-secret 호출 (masterAuth 필요)
   - 출력: "Secret rotated. Previous secret expires at: {ISO8601}"

모든 수정에 `[v0.7 보완]` 태그를 붙여 추적 가능하게 한다.
  </action>
  <verify>
1. 28-daemon-lifecycle-cli.md에서 "acquireDaemonLock" 검색 -> 존재
2. 28-daemon-lifecycle-cli.md에서 "daemon.lock" 검색 -> 존재
3. 28-daemon-lifecycle-cli.md에서 "closeSync(lockFd)" 검색 -> 존재
4. 28-daemon-lifecycle-cli.md에서 "waiaas secret rotate" 검색 -> 존재
5. 28-daemon-lifecycle-cli.md에서 "보조 정보" 검색 -> PID 파일 관련 컨텍스트에서 존재
  </verify>
  <done>
데몬 인스턴스 잠금이 PID 파일에서 flock/fd 기반으로 전환 완료. PID 파일은 보조 정보로 격하. Graceful Shutdown에 lockFd 해제 추가. waiaas secret rotate CLI 정의 완료.
  </done>
</task>

</tasks>

<verification>
1. DAEMON-01 검증: 30-session-token-protocol.md에 JwtSecretManager 인터페이스 + dual-key 검증 로직 + 5분 전환 윈도우 + rotateJwtSecret() 존재
2. DAEMON-02 검증: 28-daemon-lifecycle-cli.md에 acquireDaemonLock() + daemon.lock + closeSync(lockFd) + Windows fallback 존재
3. 크로스 문서 정합성: rotate-secret API(37-rest-api) <-> rotateJwtSecret(30-session) <-> waiaas secret rotate CLI(28-daemon) 3자 연결 확인
4. config.toml(24-monorepo) jwt_secret 초기값 전용 명시 확인
</verification>

<success_criteria>
- JWT Secret dual-key rotation이 JwtSecretManager 인터페이스, system_state 저장, 5분 윈도우, CLI/API로 완전히 정의됨
- flock 기반 인스턴스 잠금이 acquireDaemonLock, daemon.lock, Windows fallback, Graceful Shutdown으로 완전히 정의됨
- 4개 문서 모두 [v0.7 보완] 태그로 추적 가능
</success_criteria>

<output>
After completion, create `.planning/phases/27-daemon-security-foundation/27-01-SUMMARY.md`
</output>
