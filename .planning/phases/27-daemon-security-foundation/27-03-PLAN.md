---
phase: 27-daemon-security-foundation
plan: 03
type: execute
wave: 3
depends_on: ["27-02"]
files_modified:
  - .planning/deliverables/34-owner-wallet-connection.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/52-auth-model-redesign.md
  - .planning/deliverables/30-session-token-protocol.md
  - .planning/deliverables/24-monorepo-data-directory.md
  - .planning/deliverables/25-sqlite-schema.md
autonomous: true

must_haves:
  truths:
    - "Master Password 인증이 전체 시스템에서 Argon2id로 통일되고 SHA-256 해시 전송이 폐기되었다"
    - "X-Master-Password-Hash 헤더가 X-Master-Password(평문, localhost only)로 변경되었다"
    - "데몬 시작 시 Argon2id 해시를 메모리 캐시하여 API 요청 시 빠른 검증이 가능하다"
    - "config.toml에 nonce_storage 옵션(memory|sqlite)이 추가되고 INonceStore 인터페이스가 정의되었다"
    - "nonces 테이블 DDL이 25-sqlite-schema.md에 추가되었다"
  artifacts:
    - path: ".planning/deliverables/34-owner-wallet-connection.md"
      provides: "CLI kill-switch 인증 Argon2id 전환, X-Master-Password 평문"
      contains: "X-Master-Password"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "Admin API 인증 헤더 변경, Argon2id 검증 명시"
      contains: "X-Master-Password"
    - path: ".planning/deliverables/52-auth-model-redesign.md"
      provides: "masterAuth explicit Argon2id 확인/보강, 해시 메모리 캐시 명시"
      contains: "argon2.verify"
    - path: ".planning/deliverables/30-session-token-protocol.md"
      provides: "INonceStore 인터페이스, MemoryNonceStore/SqliteNonceStore 옵션"
      contains: "INonceStore"
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "nonce_storage 설정 옵션"
      contains: "nonce_storage"
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "nonces 테이블 DDL"
      contains: "CREATE TABLE.*nonces"
  key_links:
    - from: "34-owner-wallet-connection.md (X-Master-Password)"
      to: "52-auth-model-redesign.md (masterAuth explicit)"
      via: "CLI kill-switch가 masterAuth 미들웨어를 통해 검증"
      pattern: "X-Master-Password.*Argon2id|argon2\\.verify"
    - from: "37-rest-api-complete-spec.md (Admin API 인증)"
      to: "52-auth-model-redesign.md (masterAuth explicit)"
      via: "Admin API 헤더 명세가 masterAuth 구현과 일치"
      pattern: "X-Master-Password"
    - from: "30-session-token-protocol.md (INonceStore)"
      to: "25-sqlite-schema.md (nonces 테이블)"
      via: "SqliteNonceStore가 nonces 테이블을 사용"
      pattern: "INonceStore|nonces"
    - from: "24-monorepo-data-directory.md (nonce_storage)"
      to: "30-session-token-protocol.md (INonceStore)"
      via: "config 값에 따라 MemoryNonceStore 또는 SqliteNonceStore 생성"
      pattern: "nonce_storage"
---

<objective>
Master Password 인증을 Argon2id로 통일하고, 단일 인스턴스 보강을 위한 SQLite nonce 저장 옵션을 추가한다.

Purpose: DAEMON-05(SHA-256과 Argon2id 보안 수준 불일치) + DAEMON-06(인메모리 nonce 캐시의 다중 인스턴스 취약점) 해소. 전체 인증 체계의 보안 수준을 통일하고 2차 방어 옵션을 확보한다.
Output: 34-owner-wallet-connection.md, 37-rest-api-complete-spec.md, 52-auth-model-redesign.md, 30-session-token-protocol.md, 24-monorepo-data-directory.md, 25-sqlite-schema.md 수정
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-daemon-security-foundation/27-RESEARCH.md

@.planning/deliverables/34-owner-wallet-connection.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/24-monorepo-data-directory.md
@.planning/deliverables/25-sqlite-schema.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Master Password Argon2id 통일 (DAEMON-05)</name>
  <files>
    .planning/deliverables/34-owner-wallet-connection.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/52-auth-model-redesign.md
  </files>
  <action>
**34-owner-wallet-connection.md 수정:**

1. 섹션 8.3 (CLI kill-switch 인증) 또는 해당 위치에 [v0.7 보완] 태그:
   - 기존 SHA-256 해시 전송 방식 삭제/교체
   - 변경 내용:
     - 헤더: `X-Master-Password-Hash` -> `X-Master-Password` (평문)
     - CLI가 사용자에게 패스워드를 프롬프트로 받아 HTTP 헤더에 평문으로 전송
     - 보안 근거: "localhost only 통신이므로 네트워크 스니핑 위험 없음. SHA-256 클라이언트 해싱은 보안 이점이 없고(해시가 사실상 비밀번호 역할), Argon2id 서버 검증으로 통일하는 것이 보안 수준 일관성 확보"
     - 서버 측: `argon2.verify(cachedHash, password)` 실행. cachedHash는 데몬 시작 시 메모리에 캐시된 Argon2id 해시.
   - 기존 SHA-256 관련 코드/설명에 DEPRECATED 또는 삭제 처리

**37-rest-api-complete-spec.md 수정:**

1. 섹션 3.3 (Admin API 인증) 또는 해당 위치에 [v0.7 보완]:
   - `X-Master-Password-Hash` -> `X-Master-Password` 헤더명 변경
   - 설명: "Master Password 평문. localhost only 통신. 서버에서 Argon2id 검증."
   - 모든 masterAuth 관련 엔드포인트 설명에서 헤더명 갱신
   - 인증 실패 시 응답: 401 `{ error: { code: 'AUTH_INVALID_MASTER_PASSWORD', message: '...' } }`

**52-auth-model-redesign.md 수정:**

1. 섹션 3.1 (masterAuth explicit) 또는 해당 위치에 [v0.7 보완]:
   - 이미 Argon2id 기반으로 설계되어 있으므로, 다음을 확인/보강:
     - `verifyPassword()` 콜백이 `argon2.verify(cachedHash, inputPassword)`를 사용함을 명시
     - 해시 메모리 캐시 메커니즘 추가: "데몬 시작 시 키스토어 잠금 해제에 성공한 마스터 패스워드로 `argon2.hash(password, { type: argon2id })` 실행하여 메모리에 캐시. API 요청 시 `argon2.verify(cachedHash, inputPassword)`로 빠른 검증 (~50ms vs Argon2id 풀 실행 ~1-3s)."
     - 주의: "cachedHash는 Argon2id 인코딩 문자열 ($argon2id$v=19$m=...,t=...,p=...$salt$hash). argon2.verify()는 인코딩 문자열에 내장된 salt/params를 자동으로 사용하므로 별도 salt 관리 불필요."
   - 헤더명 변경 반영: X-Master-Password-Hash -> X-Master-Password
   - SHA-256 관련 언급이 있으면 삭제/교체

모든 수정에 `[v0.7 보완]` 태그를 붙여 추적 가능하게 한다.
  </action>
  <verify>
1. 34-owner-wallet-connection.md에서 "X-Master-Password" 검색 -> 존재 (X-Master-Password-Hash가 아닌)
2. 34-owner-wallet-connection.md에서 "SHA-256" 검색 -> 없거나 DEPRECATED 표기
3. 37-rest-api-complete-spec.md에서 "X-Master-Password" 검색 -> 존재 (Hash 접미사 없이)
4. 52-auth-model-redesign.md에서 "argon2.verify" 또는 "cachedHash" 검색 -> 존재
5. 52-auth-model-redesign.md에서 "메모리 캐시" 또는 "memory cache" 검색 -> 존재
  </verify>
  <done>
Master Password 인증이 전체 시스템에서 Argon2id로 통일. X-Master-Password-Hash 폐기, X-Master-Password(평문) 전환 완료. 메모리 캐시 메커니즘 정의 완료.
  </done>
</task>

<task type="auto">
  <name>Task 2: SQLite nonce 저장 옵션 (DAEMON-06)</name>
  <files>
    .planning/deliverables/30-session-token-protocol.md
    .planning/deliverables/24-monorepo-data-directory.md
    .planning/deliverables/25-sqlite-schema.md
  </files>
  <action>
**30-session-token-protocol.md 수정:**

1. 섹션 4.2 (nonce 저장소) 또는 해당 위치에 [v0.7 보완] 태그와 함께:
   - INonceStore 인터페이스 정의:
     ```typescript
     interface INonceStore {
       /** nonce 사용 등록. 이미 존재하면 false 반환 (replay 감지) */
       consume(nonce: string, expiresAt: number): boolean
       /** 만료된 nonce 정리 */
       cleanup(): void
     }
     ```
   - MemoryNonceStore 구현 스펙 (기존 LRU 캐시 기반):
     - `lru-cache` 사용, max 1000, TTL 5분
     - 기존 동작과 동일, INonceStore 인터페이스 준수
   - SqliteNonceStore 구현 스펙:
     - nonces 테이블에 INSERT OR IGNORE + rowsAffected 확인 패턴
     - consume(): `INSERT OR IGNORE INTO nonces (nonce, created_at, expires_at) VALUES (?, ?, ?)` -> rowsAffected === 1이면 true(신규), 0이면 false(replay)
     - cleanup(): `DELETE FROM nonces WHERE expires_at < ?` (현재 시각보다 작은 것 삭제)
     - 만료 nonce 정리: 데몬 시작 시 1회 + BackgroundWorkers에 1시간 주기 태스크 추가
   - 팩토리 패턴: `createNonceStore(config.security.nonce_storage)` -> 'memory'면 MemoryNonceStore, 'sqlite'면 SqliteNonceStore 반환
   - 성능 주의사항: "SQLite nonce 저장은 선택적 2차 방어. flock이 단일 인스턴스를 보장하므로 대부분의 경우 memory로 충분. SQLite 사용 시 INSERT ~100-500us 오버헤드 발생."

**24-monorepo-data-directory.md 수정:**

1. config.toml [security] 섹션에 [v0.7 보완]:
   - `nonce_storage = "memory"` 옵션 추가 (기본값)
   - 주석: `# "memory" = 인메모리 LRU (기본, 빠름), "sqlite" = SQLite 저장 (2차 방어, 프로세스 재시작 시에도 replay 방지)`
   - 타입: `"memory" | "sqlite"`

**25-sqlite-schema.md 수정:**

1. nonces 테이블 DDL 추가 [v0.7 보완]:
   ```sql
   -- [v0.7 보완] 선택적 nonce 저장소 (config: security.nonce_storage = "sqlite")
   CREATE TABLE IF NOT EXISTS nonces (
     nonce TEXT PRIMARY KEY,
     created_at INTEGER NOT NULL,
     expires_at INTEGER NOT NULL
   );

   CREATE INDEX idx_nonces_expires_at ON nonces(expires_at);
   ```
   - 이 테이블은 `nonce_storage = "sqlite"` 설정 시에만 생성됨을 명시
   - ERD 또는 테이블 목록에 nonces 추가 (선택적 테이블로 표기)
   - 컬럼 설명: nonce(TEXT PK, ownerAuth nonce 값), created_at(INTEGER, Unix epoch 초), expires_at(INTEGER, Unix epoch 초, TTL 5분)

모든 수정에 `[v0.7 보완]` 태그를 붙여 추적 가능하게 한다.
  </action>
  <verify>
1. 30-session-token-protocol.md에서 "INonceStore" 검색 -> 존재
2. 30-session-token-protocol.md에서 "SqliteNonceStore" 검색 -> 존재
3. 30-session-token-protocol.md에서 "MemoryNonceStore" 검색 -> 존재
4. 24-monorepo-data-directory.md에서 "nonce_storage" 검색 -> 존재
5. 25-sqlite-schema.md에서 "nonces" 테이블 DDL 검색 -> 존재
6. 25-sqlite-schema.md에서 "idx_nonces_expires_at" 인덱스 검색 -> 존재
  </verify>
  <done>
INonceStore 인터페이스와 Memory/SQLite 2종 구현 스펙 정의 완료. nonces 테이블 DDL 추가 완료. config.toml nonce_storage 옵션 추가 완료.
  </done>
</task>

</tasks>

<verification>
1. DAEMON-05 검증: 34-owner-wallet-connection + 37-rest-api + 52-auth-model 3개 문서에서 X-Master-Password(평문) + Argon2id 검증으로 통일
2. DAEMON-06 검증: 30-session-token-protocol에 INonceStore + 2종 구현, 24-monorepo에 nonce_storage 옵션, 25-sqlite에 nonces DDL 존재
3. 크로스 문서 정합성: 헤더명(34 + 37 + 52 동일), nonce 인터페이스(30) <-> config(24) <-> DDL(25) 연결
4. SHA-256 해시 전송 관련 내용이 모든 문서에서 폐기/삭제 확인
</verification>

<success_criteria>
- Master Password 인증이 SHA-256에서 Argon2id로 전환되고 X-Master-Password 헤더로 통일됨
- 해시 메모리 캐시 메커니즘으로 API 응답 지연 방지 설계 포함
- INonceStore 인터페이스와 Memory/SQLite 2종 구현 스펙 정의됨
- nonces 테이블 DDL이 선택적 테이블로 25-sqlite-schema.md에 추가됨
- 6개 문서 모두 [v0.7 보완] 태그로 추적 가능
</success_criteria>

<output>
After completion, create `.planning/phases/27-daemon-security-foundation/27-03-SUMMARY.md`
</output>
