---
phase: 85-db-migration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/__tests__/migration-runner.test.ts
  - packages/daemon/src/__tests__/database.test.ts
autonomous: true

must_haves:
  truths:
    - "v1 DB로 데몬 시작 시 schema_version 2로 자동 마이그레이션되고 기존 에이전트 데이터가 유지된다"
    - "managesOwnTransaction=true인 마이그레이션이 자체 PRAGMA foreign_keys=OFF + BEGIN/COMMIT을 관리한다"
    - "마이그레이션 후 sqlite.pragma('foreign_key_check') 결과가 빈 배열이다"
    - "EVM 네트워크(ethereum-mainnet 등)로 agents INSERT가 CHECK 통과한다"
    - "기존 Solana 에이전트(network='mainnet'/'devnet'/'testnet')가 마이그레이션 후 그대로 유지된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "Migration.managesOwnTransaction flag, v2 migration in MIGRATIONS[], runMigrations managesOwnTransaction 분기"
      exports: ["Migration", "MIGRATIONS", "runMigrations", "pushSchema"]
    - path: "packages/daemon/src/__tests__/migration-runner.test.ts"
      provides: "v2 마이그레이션 TDD 테스트: 데이터 보존, CHECK 확장, FK 검증, managesOwnTransaction"
      min_lines: 80
    - path: "packages/daemon/src/__tests__/database.test.ts"
      provides: "EVM 네트워크 CHECK 테스트 추가"
      contains: "ethereum-mainnet"
  key_links:
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "@waiaas/core NETWORK_TYPES"
      via: "import { NETWORK_TYPES } from '@waiaas/core'"
      pattern: "NETWORK_TYPES"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "schema_version table"
      via: "INSERT version 2 after successful migration"
      pattern: "schema_version"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "agents table network CHECK"
      via: "12-step table recreation with expanded CHECK"
      pattern: "CREATE TABLE agents_new"
---

<objective>
schema_version 2 마이그레이션으로 agents 테이블의 network CHECK 제약을 EVM 네트워크 포함으로 확장한다.

Purpose: v1.4.1에서 chain='ethereum' 에이전트를 DB에 저장하려면 agents.network CHECK 제약이 EVM 네트워크 값('ethereum-mainnet', 'ethereum-sepolia' 등)을 허용해야 한다. SQLite는 ALTER TABLE로 CHECK를 수정할 수 없으므로 12-step 테이블 재생성 패턴이 필요하다. 이 과정에서 PRAGMA foreign_keys=OFF가 필요하므로 Migration 인터페이스에 managesOwnTransaction 플래그를 추가하여 러너가 자체 트랜잭션/PRAGMA 관리를 위임한다.

Output: Migration.managesOwnTransaction, v2 migration, 확장된 CHECK 제약, TDD 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/connection.ts
@packages/daemon/src/__tests__/migration-runner.test.ts
@packages/daemon/src/__tests__/database.test.ts
@packages/core/src/enums/chain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED -- managesOwnTransaction 분기 + v2 마이그레이션 테스트</name>
  <files>packages/daemon/src/__tests__/migration-runner.test.ts</files>
  <action>
migration-runner.test.ts에 새로운 describe 블록을 추가한다. 기존 테스트는 유지.

**테스트 1: "managesOwnTransaction migration should manage its own PRAGMA and transaction"**
- managesOwnTransaction=true인 Migration을 만들어서 runMigrations에 전달
- up() 함수 내부에서 sqlite.pragma('foreign_keys') 값이 0(OFF)인지 확인
- 마이그레이션 후 sqlite.pragma('foreign_keys') 값이 1(ON)로 복원되었는지 확인
- schema_version에 해당 버전이 기록되었는지 확인

**테스트 2: "v2 migration should preserve existing Solana agents"**
- pushSchema(sqlite)로 v1 DB 생성 (beforeEach에서 이미 됨)
- Solana 에이전트 3개 INSERT (network='mainnet', 'devnet', 'testnet')
- v2 마이그레이션 실행
- 3개 에이전트가 모두 SELECT로 조회되고 모든 필드가 동일한지 확인

**테스트 3: "v2 migration should expand network CHECK to accept EVM networks"**
- pushSchema + v2 마이그레이션 실행
- chain='ethereum', network='ethereum-mainnet' 에이전트 INSERT 성공 확인
- chain='ethereum', network='polygon-amoy' INSERT 성공 확인
- chain='ethereum', network='invalid-network' INSERT 시 CHECK 에러 확인

**테스트 4: "v2 migration should pass foreign_key_check"**
- pushSchema, Solana 에이전트 + 세션 + 트랜잭션 INSERT
- v2 마이그레이션 실행
- `sqlite.pragma('foreign_key_check')` 결과가 빈 배열인지 확인
- 세션과 트랜잭션이 에이전트 FK로 여전히 연결되어 있는지 확인

**테스트 5: "managesOwnTransaction migration failure should still allow retry"**
- managesOwnTransaction=true이고 up()에서 예외를 던지는 마이그레이션 작성
- runMigrations 호출이 에러를 던지는지 확인
- schema_version에 해당 버전이 기록되지 않았는지 확인
- sqlite.pragma('foreign_keys') 값이 1로 복원되었는지 확인

모든 테스트는 아직 구현이 없으므로 FAIL해야 한다. `npm test -- migration-runner` 실행하여 RED 상태 확인.
  </action>
  <verify>cd packages/daemon && npx vitest run src/__tests__/migration-runner.test.ts 2>&1 | grep -E "FAIL|fail|Tests"</verify>
  <done>5개 새 테스트가 모두 FAIL (RED 상태)</done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN -- Migration.managesOwnTransaction + v2 마이그레이션 구현</name>
  <files>packages/daemon/src/infrastructure/database/migrate.ts, packages/daemon/src/__tests__/database.test.ts</files>
  <action>
**migrate.ts 변경 1: Migration 인터페이스 확장**

Migration 인터페이스에 optional `managesOwnTransaction?: boolean` 필드 추가.
- JSDoc: "true이면 runMigrations가 BEGIN/COMMIT을 감싸지 않고 up() 함수가 자체적으로 PRAGMA foreign_keys=OFF + BEGIN/COMMIT을 관리한다. 테이블 재생성(12-step) 등 foreign_keys를 비활성화해야 하는 마이그레이션에 사용."

**migrate.ts 변경 2: runMigrations() 분기 로직**

기존 `for (const migration of sorted)` 루프 내부에서:

```typescript
if (migration.managesOwnTransaction) {
  // Migration manages its own PRAGMA + transaction
  try {
    migration.up(sqlite);
    // Record successful migration (up() must commit its own transaction)
    sqlite
      .prepare('INSERT INTO schema_version (version, applied_at, description) VALUES (?, ?, ?)')
      .run(migration.version, Math.floor(Date.now() / 1000), migration.description);
    applied++;
  } catch (err) {
    // Ensure foreign_keys is restored even on failure
    try { sqlite.pragma('foreign_keys = ON'); } catch { /* best effort */ }
    throw new Error(`Migration v${migration.version} (${migration.description}) failed: ${err instanceof Error ? err.message : String(err)}`);
  }
} else {
  // Existing BEGIN/COMMIT wrapper (unchanged)
  sqlite.exec('BEGIN');
  try { ... } catch { ... }
}
```

**migrate.ts 변경 3: v2 마이그레이션 등록**

MIGRATIONS 배열에 v2 마이그레이션 추가:

```typescript
import { CHAIN_TYPES, NETWORK_TYPES, AGENT_STATUSES } from '@waiaas/core';

MIGRATIONS.push({
  version: 2,
  description: 'Expand agents network CHECK to include EVM networks',
  managesOwnTransaction: true,
  up: (sqlite) => {
    // SQLite 12-step table recreation
    // Step 1: Disable foreign keys
    sqlite.pragma('foreign_keys = OFF');

    // Step 2: Begin transaction
    sqlite.exec('BEGIN');

    try {
      // Step 3: Create new agents table with expanded CHECK
      sqlite.exec(`CREATE TABLE agents_new (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        chain TEXT NOT NULL CHECK (chain IN (${inList(CHAIN_TYPES)})),
        network TEXT NOT NULL CHECK (network IN (${inList(NETWORK_TYPES)})),
        public_key TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'CREATING' CHECK (status IN (${inList(AGENT_STATUSES)})),
        owner_address TEXT,
        owner_verified INTEGER NOT NULL DEFAULT 0 CHECK (owner_verified IN (0, 1)),
        created_at INTEGER NOT NULL,
        updated_at INTEGER NOT NULL,
        suspended_at INTEGER,
        suspension_reason TEXT
      )`);

      // Step 4: Copy existing data
      sqlite.exec(`INSERT INTO agents_new SELECT * FROM agents`);

      // Step 5: Drop old table
      sqlite.exec('DROP TABLE agents');

      // Step 6: Rename new table
      sqlite.exec('ALTER TABLE agents_new RENAME TO agents');

      // Step 7: Recreate indexes
      sqlite.exec('CREATE UNIQUE INDEX IF NOT EXISTS idx_agents_public_key ON agents(public_key)');
      sqlite.exec('CREATE INDEX IF NOT EXISTS idx_agents_status ON agents(status)');
      sqlite.exec('CREATE INDEX IF NOT EXISTS idx_agents_chain_network ON agents(chain, network)');
      sqlite.exec('CREATE INDEX IF NOT EXISTS idx_agents_owner_address ON agents(owner_address)');

      // Step 8: Commit
      sqlite.exec('COMMIT');
    } catch (err) {
      sqlite.exec('ROLLBACK');
      sqlite.pragma('foreign_keys = ON');
      throw err;
    }

    // Step 9: Re-enable foreign keys
    sqlite.pragma('foreign_keys = ON');

    // Step 10: Verify FK integrity
    const fkErrors = sqlite.pragma('foreign_key_check') as unknown[];
    if (fkErrors.length > 0) {
      throw new Error(`FK integrity check failed after v2 migration: ${JSON.stringify(fkErrors)}`);
    }
  },
});
```

IMPORTANT: `inList` 유틸리티 함수는 이미 migrate.ts 상단에 존재. CHAIN_TYPES, AGENT_STATUSES도 이미 import되어 있음. 추가 import 불필요.

**database.test.ts 변경:**

CHECK constraints > agents describe에 EVM 네트워크 테스트 추가:

```typescript
it('should accept valid EVM network ethereum-mainnet', () => {
  expect(() => {
    sqlite.prepare(
      `INSERT INTO agents (id, name, chain, network, public_key, status, owner_verified, created_at, updated_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    ).run(generateId(), 'EVM Agent', 'ethereum', 'ethereum-mainnet', 'pubkey-evm1', 'CREATING', 0, ts, ts);
  }).not.toThrow();
});

it('should accept valid EVM network polygon-amoy', () => {
  expect(() => {
    sqlite.prepare(
      `INSERT INTO agents (id, name, chain, network, public_key, status, owner_verified, created_at, updated_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    ).run(generateId(), 'EVM Agent', 'ethereum', 'polygon-amoy', 'pubkey-evm2', 'CREATING', 0, ts, ts);
  }).not.toThrow();
});
```

`npx vitest run` 실행하여 GREEN 상태 확인.
  </action>
  <verify>cd packages/daemon && npx vitest run src/__tests__/migration-runner.test.ts src/__tests__/database.test.ts 2>&1 | grep -E "Tests|PASS|FAIL"</verify>
  <done>모든 기존 + 신규 테스트 PASS (GREEN 상태), v2 마이그레이션이 기존 데이터 보존하며 EVM 네트워크 CHECK 확장 완료</done>
</task>

</tasks>

<verification>
1. `cd packages/daemon && npx vitest run` -- 전체 daemon 테스트 통과
2. `cd packages/daemon && npx vitest run src/__tests__/migration-runner.test.ts` -- 마이그레이션 테스트 전수 통과
3. `cd packages/daemon && npx vitest run src/__tests__/database.test.ts` -- DB 테스트 전수 통과 (EVM CHECK 포함)
4. 모노레포 빌드: `npm run build` -- 빌드 에러 없음
</verification>

<success_criteria>
- Migration 인터페이스에 managesOwnTransaction?: boolean 필드가 존재한다
- MIGRATIONS 배열에 version=2 마이그레이션이 등록되어 있다
- v2 마이그레이션이 PRAGMA foreign_keys=OFF + 12-step 테이블 재생성으로 agents.network CHECK를 확장한다
- 기존 Solana 에이전트 데이터가 마이그레이션 후 100% 보존된다
- 마이그레이션 후 foreign_key_check가 빈 배열을 반환한다
- EVM 네트워크(ethereum-mainnet, polygon-amoy 등)로 agents INSERT가 성공한다
- 기존 테스트가 회귀 없이 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/85-db-migration/85-01-SUMMARY.md`
</output>
