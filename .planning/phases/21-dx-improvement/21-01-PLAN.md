---
phase: 21-dx-improvement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/54-cli-flow-redesign.md
autonomous: true

must_haves:
  truths:
    - "waiaas init이 순수 인프라 초기화(디렉토리 + DB + 키스토어)만 수행하며, 에이전트 생성과 Owner 등록이 제거되어 있다"
    - "waiaas agent create --owner <address>로 에이전트 생성 시 Owner 주소가 NOT NULL로 등록되며, 서명이 불필요하다"
    - "waiaas session create가 masterAuth(implicit)만으로 동작하며, 출력 포맷(token/json/env)이 정의되어 있다"
    - "--quickstart 플래그로 init부터 세션 토큰 발급까지 단일 커맨드로 완료되는 4단계 오케스트레이션이 정의되어 있다"
    - "--dev 모드에서 고정 패스워드 'waiaas-dev'로 데몬이 시작되며, 보안 경고 메커니즘이 정의되어 있다"
    - "CLI 커맨드 전체 요약표(v0.5)가 존재하며, 각 커맨드의 인증 수준과 옵션이 명세되어 있다"
  artifacts:
    - path: ".planning/deliverables/54-cli-flow-redesign.md"
      provides: "CLI 플로우 재설계 SSoT 문서 (DX-01~05)"
      contains: "waiaas init"
  key_links:
    - from: "54-cli-flow-redesign.md"
      to: "52-auth-model-redesign.md"
      via: "masterAuth implicit/explicit, agents.owner_address NOT NULL 참조"
    - from: "54-cli-flow-redesign.md"
      to: "28-daemon-lifecycle-cli.md"
      via: "기존 CLI 플로우 대체 (v0.2 -> v0.5)"
    - from: "54-cli-flow-redesign.md"
      to: "53-session-renewal-protocol.md"
      via: "session create 출력에 갱신 정보 포함"
---

<objective>
CLI 플로우 재설계 문서(54-cli-flow-redesign.md)를 신규 작성한다. v0.2의 init 4단계를 v0.5의 2단계로 간소화하고, agent create --owner, session create, --quickstart, --dev 모드를 정의한다.

Purpose: DX-01(init 순수 인프라), DX-02(agent create --owner), DX-03(session create masterAuth), DX-04(--quickstart), DX-05(--dev 모드) 5개 요구사항을 단일 SSoT 문서에서 해결한다.
Output: 54-cli-flow-redesign.md (신규)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research (CLI 패턴 전체 설계 결정)
@.planning/phases/21-dx-improvement/21-RESEARCH.md

# 참조 문서 (인증 모델, 기존 CLI, 세션 프로토콜)
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/28-daemon-lifecycle-cli.md
@.planning/deliverables/53-session-renewal-protocol.md
@.planning/deliverables/24-monorepo-data-directory.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 54-cli-flow-redesign.md 신규 작성 -- 섹션 1~5 (init, agent create, session create)</name>
  <files>.planning/deliverables/54-cli-flow-redesign.md</files>
  <action>
CLI 플로우 재설계 SSoT 문서를 신규 작성한다. 기존 프로젝트 문서 스타일(한글, 마크다운, 섹션 번호)을 따른다. 이 Task에서 섹션 1~5를 작성한다.

**섹션 1: 개요**
- 문서 목적: v0.5 CLI 플로우 재설계 정의 (DX-01~05)
- 참조 문서: 28-daemon-lifecycle-cli.md, 52-auth-model-redesign.md, 53-session-renewal-protocol.md, 24-monorepo-data-directory.md
- v0.2 -> v0.5 변경 요약표:
  | 영역 | v0.2 | v0.5 | 변경 근거 |
  | init | 4단계 (PW+Agent+Noti+Owner) | 2단계 (PW+Infra) | DX-01: 관심사 분리 |
  | 에이전트 생성 | init 내 선택적 | agent create --owner | DX-02: Owner 주소 필수 |
  | 세션 생성 | ownerAuth (SIWS/SIWE) | masterAuth (implicit) | DX-03: 서명 제거 |
  | 빠른 시작 | 없음 | --quickstart | DX-04: 단일 커맨드 |
  | 개발 모드 | 없음 | --dev | DX-05: 프롬프트 없이 시작 |

**섹션 2: waiaas init 재설계 (DX-01)**
- 2.1 v0.5 init 플로우 (2단계):
  - Step 1: 마스터 패스워드 설정 (대화형: stdin 프롬프트, 비대화형: WAIAAS_MASTER_PASSWORD env 또는 --password-file)
  - Step 2: 인프라 초기화 (디렉토리 ~/.waiaas/, config.toml, SQLite DB, 키스토어)
  - 출력: "WAIaaS initialized. Next: waiaas agent create --owner <addr>"
- 2.2 init 옵션 테이블:
  | 옵션 | 타입 | 기본값 | 설명 |
  | --data-dir | string | ~/.waiaas | 데이터 디렉토리 경로 |
  | --password-file | string | - | 패스워드 파일 경로 (비대화형) |
  | --quickstart | flag | false | 통합 빠른 시작 (섹션 6) |
  | --force | flag | false | 기존 초기화 덮어쓰기 |
- 2.3 에러 처리:
  - INIT_ALREADY_EXISTS: "이미 초기화됨. --force로 재초기화 가능"
  - INIT_PASSWORD_TOO_WEAK: "패스워드가 8자 미만. 더 강한 패스워드를 사용하세요"
  - INIT_DIR_PERMISSION: "디렉토리 생성 권한 없음"
- 2.4 v0.2 대비 제거된 단계 명시:
  - Step 2 (에이전트 생성) -> waiaas agent create로 분리
  - Step 3 (알림 채널) -> 별도 설정으로 위임 (init과 무관)
  - Step 4 (Owner 지갑 등록) -> waiaas agent create --owner로 통합
- 2.5 패스워드 해석 우선순위 (28-daemon-lifecycle-cli.md 준수):
  (1) WAIAAS_MASTER_PASSWORD 환경변수
  (2) --password-file 파일
  (3) stdin 대화형 프롬프트 (TTY 감지)

**섹션 3: waiaas agent create --owner (DX-02)**
- 3.1 커맨드 인터페이스:
  ```
  waiaas agent create [options]

  필수 옵션:
    --owner <address>    Owner 지갑 주소 (Solana base58 또는 EVM 0x...)

  선택 옵션:
    --name <name>        에이전트 이름 (기본: agent-{timestamp})
    --chain <chain>      체인 (solana|ethereum, 기본: solana)
    --network <network>  네트워크 (mainnet|devnet|testnet, 기본: devnet)
  ```
- 3.2 동작 설명:
  - 데몬이 실행 중이어야 함 (HTTP API 호출)
  - POST /v1/agents 호출 (masterAuth implicit -- localhost이므로 추가 인증 불필요)
  - agents.owner_address = --owner 값 (NOT NULL, 52-auth-model-redesign.md)
  - 서명 불필요: Owner 주소는 단순 문자열 등록 (masterAuth implicit 범위)
  - 에이전트 키 생성 + 키스토어 암호화 저장은 데몬 내부 처리
- 3.3 출력 예시:
  ```
  Agent 'my-bot' created successfully.
    Address: 7xKXtg2CnYd9Jf...
    Chain:   solana (devnet)
    Owner:   FPr3Mz...

  Next: waiaas session create --agent my-bot
  ```
- 3.4 에러 처리:
  - DAEMON_NOT_RUNNING: "데몬이 실행 중이 아닙니다. waiaas start를 먼저 실행하세요" (hint 포함)
  - AGENT_NAME_DUPLICATE: "동일 이름의 에이전트가 존재합니다"
  - INVALID_OWNER_ADDRESS: "유효하지 않은 Owner 주소 형식입니다"
  - OWNER_REQUIRED: "--owner <address>가 필수입니다. Owner 지갑 주소를 제공하세요"

**섹션 4: waiaas session create (DX-03)**
- 4.1 커맨드 인터페이스:
  ```
  waiaas session create [options]

  필수 옵션:
    --agent <name|id>    대상 에이전트

  선택 옵션:
    --expires-in <sec>   만료 시간 초 (기본: 86400 = 24시간, 범위: 300~604800)
    --max-amount <amt>   세션 내 최대 거래 금액 (SOL/ETH)
    --max-txs <count>    세션 내 최대 거래 횟수
    --output <format>    출력 형식: token(기본)|json|env
  ```
- 4.2 동작 설명:
  - POST /v1/sessions 호출 (masterAuth implicit)
  - 52-auth-model-redesign.md 섹션 4.2 #9에서 ownerAuth -> masterAuth(implicit) 변경 확정
  - 추가 인증 불필요: 데몬이 localhost에서 구동 중이면 세션 생성 가능
- 4.3 출력 포맷:
  - token (기본): 세션 토큰 문자열만 출력 (파이프 친화)
    ```
    wai_sess_eyJhbGciOiJIUzI1NiIs...
    ```
  - json: JSON 객체 출력
    ```json
    {
      "sessionId": "...",
      "token": "wai_sess_...",
      "expiresAt": "2026-02-08T12:00:00Z",
      "agent": { "name": "my-bot", "address": "7xKXtg2..." }
    }
    ```
  - env: 환경변수 설정 형식
    ```
    export WAIAAS_SESSION_TOKEN=wai_sess_eyJhbGciOiJIUzI1NiIs...
    ```
- 4.4 사용 패턴:
  ```bash
  # 직접 사용
  TOKEN=$(waiaas session create --agent my-bot)

  # eval 패턴
  eval $(waiaas session create --agent my-bot --output env)
  ```

**섹션 5: CLI 커맨드 전체 요약표 (v0.5)**
- v0.5 CLI 커맨드 전체 목록 (28-daemon-lifecycle-cli.md의 기존 커맨드 + v0.5 신규/변경):
  | 커맨드 | 인증 | 설명 | v0.5 변경 |
  | waiaas init | 없음 (최초) | 인프라 초기화 | v0.5 간소화 |
  | waiaas start | masterPW | 데몬 시작 | --dev 추가 |
  | waiaas stop | 없음 (signal) | 데몬 종료 | 변경 없음 |
  | waiaas status | 없음 | 데몬 상태 | 변경 없음 |
  | waiaas agent create | masterAuth(i) | 에이전트 생성 | v0.5 신규 |
  | waiaas agent list | masterAuth(i) | 에이전트 목록 | 변경 없음 |
  | waiaas session create | masterAuth(i) | 세션 생성 | v0.5 변경 |
  | waiaas session list | masterAuth(i) | 세션 목록 | 변경 없음 |
  - 각 커맨드의 종료 코드 (28-daemon-lifecycle-cli.md 섹션 5 참조: 0-5)
  </action>
  <verify>
문서 내용 확인:
- "waiaas init" 섹션에 2단계만 정의 (4단계 아님)
- "waiaas agent create --owner" 커맨드가 정의됨
- "masterAuth" 키워드가 session create에 존재
- 출력 포맷 3가지 (token/json/env)가 정의됨
- CLI 커맨드 전체 요약표 존재
- 섹션 1~5 모두 존재
  </verify>
  <done>
54-cli-flow-redesign.md 섹션 1~5가 작성되어 있고, init 2단계 간소화, agent create --owner 분리, session create masterAuth(implicit) 기반이 정의되어 있으며, CLI 전체 요약표가 포함되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 54-cli-flow-redesign.md 섹션 6~8 (--quickstart, --dev, 부록)</name>
  <files>.planning/deliverables/54-cli-flow-redesign.md</files>
  <action>
Task 1에서 생성한 54-cli-flow-redesign.md에 섹션 6~8을 추가한다.

**섹션 6: waiaas init --quickstart (DX-04)**
- 6.1 통합 플로우 (4단계 오케스트레이션):
  ```bash
  waiaas init --quickstart \
    --agent-name my-bot \
    --chain solana \
    --network devnet \
    --owner <owner_address>
  ```
  - Stage 1: waiaas init (인프라 초기화 + 마스터 패스워드 자동 생성)
  - Stage 2: waiaas start (데몬 foreground 시작, 백그라운드 대기)
  - Stage 3: waiaas agent create --owner <addr> (에이전트 생성)
  - Stage 4: waiaas session create --agent <name> (세션 토큰 발급)
- 6.2 --quickstart 필수 옵션:
  | 옵션 | 타입 | 설명 |
  | --owner <address> | string | Owner 지갑 주소 (필수) |
  | --agent-name <name> | string | 에이전트 이름 (기본: agent-{timestamp}) |
  | --chain <chain> | string | 체인 (기본: solana) |
  | --network <network> | string | 네트워크 (기본: devnet) |
- 6.3 마스터 패스워드 자동 생성:
  - 32바이트 랜덤 생성 (crypto.randomBytes(32).toString('base64url'))
  - 파일 저장: ~/.waiaas/.master-password (mode 0o600)
  - 화면 출력: "Master password saved to ~/.waiaas/.master-password"
  - WAIAAS_MASTER_PASSWORD 환경변수가 설정되어 있으면 해당 값 사용 (자동 생성 스킵)
- 6.4 출력 예시:
  ```
  [1/4] Initializing WAIaaS...
        Master password saved to ~/.waiaas/.master-password
  [2/4] Starting daemon...
        Daemon running at http://127.0.0.1:3100
  [3/4] Creating agent 'my-bot'...
        Agent address: 7xKXtg2CnYd9Jf...
  [4/4] Creating session...

  Session token:
  wai_sess_eyJhbGciOiJIUzI1NiIs...

  Quick start:
    export WAIAAS_SESSION_TOKEN=wai_sess_eyJhbGciOiJIUzI1NiIs...
  ```
- 6.5 에러 롤백:
  - Stage N 실패 시 이전 Stage 정리 (Stage 2 실패 -> Stage 1 결과 유지, Stage 3 실패 -> 데몬 중지)
  - 각 Stage 실패 시 에러 메시지에 수동 재개 안내: "Stage 3 failed. Resume manually: waiaas agent create --owner <addr>"
- 6.6 비대화형 통합 예시:
  ```bash
  # CI/CD 또는 스크립트에서
  WAIAAS_MASTER_PASSWORD=my-secret waiaas init --quickstart \
    --owner FPr3Mz... --agent-name ci-bot

  # Docker entrypoint에서
  waiaas init --quickstart \
    --password-file /run/secrets/master-password \
    --owner ${OWNER_ADDRESS} --agent-name ${AGENT_NAME}
  ```

**섹션 7: waiaas start --dev (DX-05)**
- 7.1 동작 정의:
  - 고정 마스터 패스워드: "waiaas-dev" (하드코딩)
  - 키스토어 잠금 해제: dev 패스워드로 자동 해제 (프롬프트 없음)
  - 로그 레벨: debug 자동 설정 (config.toml 설정 무시)
  - 데이터 디렉토리: 기존 --data-dir 그대로 사용
- 7.2 보안 경고 메커니즘 (3가지):
  (1) 시작 배너:
  ```
  ╔══════════════════════════════════════════╗
  ║  ⚠ DEV MODE - NOT FOR PRODUCTION USE ⚠  ║
  ║  Master password: waiaas-dev (fixed)     ║
  ╚══════════════════════════════════════════╝
  ```
  (2) 매 HTTP 응답에 X-WAIaaS-Dev-Mode: true 헤더 추가
  (3) 감사 로그(audit_log)에 dev_mode=true 기록
- 7.3 config.toml 영구 설정:
  ```toml
  [daemon]
  dev_mode = true  # --dev와 동등
  ```
  - 우선순위: --dev 플래그 > config.toml dev_mode > 기본(false)
  - dev_mode=true 시 WAIAAS_MASTER_PASSWORD 환경변수보다 "waiaas-dev" 패스워드가 우선
- 7.4 --dev와 --quickstart 조합:
  ```bash
  waiaas init --quickstart --dev \
    --owner <addr> --agent-name dev-bot

  # 동작:
  # 1. init: 패스워드 "waiaas-dev"로 초기화
  # 2. start --dev: 프롬프트 없이 시작
  # 3. agent create: 에이전트 생성
  # 4. session create: 토큰 발급
  ```
- 7.5 --dev 모드 제약:
  - --expose와 조합 금지: --dev + --expose는 에러 (보안 위험)
  - 프로덕션 감지 방안: 향후 구현 Phase에서 NODE_ENV=production 시 --dev 경고 강화

**섹션 8: v0.2 -> v0.5 마이그레이션 가이드 (기존 사용자)**
- 8.1 변경 영향:
  - waiaas init: 에이전트/Owner 단계 제거됨 -> 별도 커맨드 필요
  - 세션 생성: SIWS/SIWE 서명 불필요 -> masterAuth(implicit) 전환
  - Owner 등록: config.toml [owner] 제거 -> agent create --owner로 이동
- 8.2 마이그레이션 안내:
  기존 v0.2 사용자는 52-auth-model-redesign.md 섹션 8 (6단계 마이그레이션 전략) 참조
  </action>
  <verify>
문서 내용 확인:
- "--quickstart" 플래그가 4단계 오케스트레이션으로 정의됨
- 마스터 패스워드 자동 생성 방식이 정의됨 (randomBytes + base64url)
- "--dev" 플래그가 정의됨
- "waiaas-dev" 고정 패스워드가 명시됨
- 보안 경고 메커니즘 3가지가 정의됨
- 섹션 6~8 모두 존재
  </verify>
  <done>
54-cli-flow-redesign.md가 8개 섹션으로 완성되어 있고, --quickstart 4단계 오케스트레이션(init->start->agent->session), --dev 모드(고정 패스워드 + 3가지 보안 경고), v0.2->v0.5 마이그레이션 가이드가 포함되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 54-cli-flow-redesign.md가 8개 섹션으로 존재
2. waiaas init이 2단계(PW + Infra)로 간소화됨 (DX-01)
3. waiaas agent create --owner가 정의됨 (DX-02)
4. waiaas session create가 masterAuth(implicit)로 정의됨 (DX-03)
5. --quickstart 4단계 오케스트레이션이 정의됨 (DX-04)
6. --dev 모드가 고정 패스워드 + 보안 경고로 정의됨 (DX-05)
7. CLI 커맨드 전체 요약표가 v0.5 반영
8. 52-auth-model-redesign.md, 28-daemon-lifecycle-cli.md 참조 일관성
</verification>

<success_criteria>
- DX-01, DX-02, DX-03, DX-04, DX-05 5개 요구사항이 단일 SSoT 문서에서 해결
- 54-cli-flow-redesign.md가 CLI 플로우의 SSoT 역할 수행
- 기존 28-daemon-lifecycle-cli.md의 v0.2 플로우와 명확히 구분되는 v0.5 정의
</success_criteria>

<output>
After completion, create `.planning/phases/21-dx-improvement/21-01-SUMMARY.md`
</output>
