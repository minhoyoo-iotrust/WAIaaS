---
phase: 21-dx-improvement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/55-dx-improvement-spec.md
autonomous: true

must_haves:
  truths:
    - "에러 응답에 hint 필드(optional string)가 추가되어 있고, 주요 에러 코드별 hint 맵이 정의되어 있다"
    - "MCP 데몬 내장 옵션 3가지(A: Streamable HTTP, B: 별도 stdio, C: 하이브리드)가 비교되어 있고, B 채택 + 근거가 명시되어 있다"
    - "원격 에이전트 접근 가이드에 SSH 터널(추천), VPN, --expose(위험성 문서화) 3가지 방법이 작성되어 있다"
    - "hint 필드가 ErrorResponseSchema의 backward-compatible 확장으로 정의되어 있다"
    - "SDK/MCP에서 hint를 LLM에 전달하는 통합 패턴이 정의되어 있다"
  artifacts:
    - path: ".planning/deliverables/55-dx-improvement-spec.md"
      provides: "DX 개선 스펙 SSoT 문서 (DX-06~08)"
      contains: "hint"
  key_links:
    - from: "55-dx-improvement-spec.md"
      to: "29-api-framework-design.md"
      via: "ErrorResponseSchema hint 필드 확장"
    - from: "55-dx-improvement-spec.md"
      to: "38-sdk-mcp-interface.md"
      via: "MCP 내장 옵션 검토, SDK hint 통합"
    - from: "55-dx-improvement-spec.md"
      to: "24-monorepo-data-directory.md"
      via: "localhost 바인딩 정책 + --expose 보안 참조"
---

<objective>
DX 개선 스펙 문서(55-dx-improvement-spec.md)를 신규 작성한다. hint 필드 에러 응답 설계, MCP 데몬 내장 옵션 검토, 원격 에이전트 접근 가이드를 정의한다.

Purpose: DX-06(hint 필드), DX-07(MCP 내장 옵션 검토), DX-08(원격 접근 가이드) 3개 요구사항을 단일 SSoT 문서에서 해결한다.
Output: 55-dx-improvement-spec.md (신규)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research (DX 개선 설계 결정)
@.planning/phases/21-dx-improvement/21-RESEARCH.md

# 참조 문서 (에러 응답, MCP, 네트워크)
@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/38-sdk-mcp-interface.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/24-monorepo-data-directory.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 55-dx-improvement-spec.md 섹션 1~2 (개요 + hint 필드)</name>
  <files>.planning/deliverables/55-dx-improvement-spec.md</files>
  <action>
DX 개선 스펙 SSoT 문서를 신규 작성한다. 기존 프로젝트 문서 스타일(한글, 마크다운, 섹션 번호)을 따른다. 이 Task에서 섹션 1~2를 작성한다.

**섹션 1: 개요**
- 문서 목적: v0.5 DX 개선 스펙 정의 (DX-06~08)
- 참조 문서: 29-api-framework-design.md, 38-sdk-mcp-interface.md, 37-rest-api-complete-spec.md, 24-monorepo-data-directory.md
- 요구사항 매핑:
  | 요구사항 | 섹션 | 내용 |
  | DX-06 | 2 | hint 필드 에러 응답 |
  | DX-07 | 3 | MCP 데몬 내장 옵션 검토 |
  | DX-08 | 4 | 원격 에이전트 접근 가이드 |

**섹션 2: hint 필드 에러 응답 (DX-06)**
- 2.1 ErrorResponseSchema 확장:
  - 기존 필드: code, message, details, requestId, retryable
  - 추가 필드: hint (z.string().optional())
  - Zod 정의 코드 예시 (21-RESEARCH.md Code Example 3 참조)
  - backward-compatible: hint는 optional이므로 기존 클라이언트에 영향 없음
  - OpenAPI 어노테이션: description, example 포함

- 2.2 주요 에러 코드별 hint 맵:
  37-rest-api-complete-spec.md의 7개 도메인 36개 에러 코드에서 hint가 유용한 코드를 선별하여 맵 작성.
  최소 20개 이상의 에러 코드에 hint 맵을 정의한다. 각 hint는 "다음에 무엇을 해야 하는가"를 안내.

  예시 (도메인별):
  | 도메인 | 에러 코드 | hint |
  |--------|----------|------|
  | AUTH | MASTER_PASSWORD_REQUIRED | "X-Master-Password 헤더에 마스터 패스워드를 포함하세요" |
  | AUTH | SESSION_EXPIRED | "waiaas session create --agent <name>으로 새 세션을 발급하세요" |
  | AUTH | SESSION_REVOKED | "Owner가 세션을 폐기했습니다. 새 세션을 발급하세요" |
  | AGENT | AGENT_NOT_FOUND | "waiaas agent list로 사용 가능한 에이전트를 확인하세요" |
  | TX | INSUFFICIENT_BALANCE | "에이전트 지갑에 {chain} 토큰을 입금하세요. 주소: {address}" |
  | TX | AMOUNT_EXCEEDS_SESSION | "세션 제약을 초과했습니다. 새 세션을 발급하거나 제약을 조정하세요" |
  | POLICY | APPROVAL_REQUIRED | "Owner의 승인이 필요합니다. 승인 대기 중입니다." |
  | POLICY | DELAY_IN_PROGRESS | "{remainingSeconds}초 후 거래가 실행됩니다" |
  | SESSION | RENEWAL_LIMIT_REACHED | "최대 갱신 횟수에 도달했습니다. 새 세션을 발급하세요" |
  | SESSION | RENEWAL_TOO_EARLY | "갱신 가능 시점까지 {remainingSeconds}초 남았습니다" |
  | SYSTEM | KILL_SWITCH_ACTIVE | "Kill Switch가 활성화되어 있습니다. Owner의 복구가 필요합니다" |
  | SYSTEM | DAEMON_SHUTTING_DOWN | "데몬이 종료 중입니다. 잠시 후 다시 시도하세요" |

  **hint 동적 변수 패턴:**
  - hint 문자열에 {variable} 템플릿 사용
  - 변수는 에러의 details 객체에서 추출
  - 구현 시 간단한 string replace: hint.replace('{address}', details.address)

- 2.3 SDK/MCP 통합 패턴:
  - TS SDK: error.hint 속성으로 노출. SDK 사용자가 LLM에 hint를 context로 전달 가능.
    ```typescript
    try {
      await client.transactions.create(...)
    } catch (e) {
      if (e instanceof WAIaaSError && e.hint) {
        // LLM에 hint를 전달하여 자율 판단
        llm.addContext(`Action needed: ${e.hint}`)
      }
    }
    ```
  - MCP: tool 실행 에러 시 content에 hint 포함. 에이전트가 hint를 읽고 다음 행동 결정.
    ```json
    {
      "content": [
        { "type": "text", "text": "Error: INSUFFICIENT_BALANCE" },
        { "type": "text", "text": "Hint: 에이전트 지갑에 SOL을 입금하세요. 주소: 7xKXtg2..." }
      ],
      "isError": true
    }
    ```
  - Python SDK: error.hint 속성 동일 패턴
  </action>
  <verify>
문서 내용 확인:
- "hint" 필드가 ErrorResponseSchema 확장으로 정의됨
- 에러 코드별 hint 맵이 최소 20개 이상 존재
- SDK/MCP 통합 패턴이 코드 예시와 함께 정의됨
- backward-compatible 명시
- 섹션 1~2 모두 존재
  </verify>
  <done>
55-dx-improvement-spec.md 섹션 1~2가 작성되어 있고, hint 필드 ErrorResponseSchema 확장, 20개+ 에러 코드별 hint 맵, SDK/MCP 통합 패턴이 정의되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 55-dx-improvement-spec.md 섹션 3~4 (MCP 검토 + 원격 접근)</name>
  <files>.planning/deliverables/55-dx-improvement-spec.md</files>
  <action>
Task 1에서 생성한 55-dx-improvement-spec.md에 섹션 3~4를 추가한다.

**섹션 3: MCP 데몬 내장 옵션 검토 (DX-07)**
- 3.1 검토 배경:
  - 현재 아키텍처: @waiaas/mcp 별도 패키지, stdio transport, WAIAAS_SESSION_TOKEN env
  - 검토 동기: 세션 토큰 수동 전달의 불편함, 프로세스 관리 복잡성
  - 38-sdk-mcp-interface.md 섹션 5 참조

- 3.2 옵션 A: 데몬 내장 MCP (Streamable HTTP) -- 기각
  - 설명: waiaas start --mcp로 데몬이 HTTP API(3100) + MCP Streamable HTTP(3101) 동시 서빙
  - 장점: 세션 토큰 전달 불필요, 단일 프로세스 관리
  - 단점:
    - Streamable HTTP transport는 MCP spec 2025-03-26에서 도입, SDK 안정성 미검증
    - Claude Desktop 등 주요 MCP 호스트가 stdio를 기본으로 사용
    - 데몬 프로세스 비대화 (HTTP 서버 + MCP 서버 동시 운영)
  - 기각 근거: MCP 호스트 생태계가 stdio 기반이며, Streamable HTTP 지원이 보편화되지 않음

- 3.3 옵션 B: 현행 유지 (별도 stdio 프로세스) -- 채택
  - 설명: @waiaas/mcp가 독립 프로세스로 stdio transport 사용
  - 장점:
    - MCP 호스트(Claude Desktop, Cursor, Windsurf)의 표준 배포 패턴
    - 이미 38-sdk-mcp-interface.md에서 설계 완료
    - 프로세스 격리 (데몬 크래시가 MCP에 영향 없음)
  - 단점: 세션 토큰 수동 설정 필요 (WAIAAS_SESSION_TOKEN env)
  - 채택 근거: 안정성, 호환성, 기존 설계 활용
  - 세션 토큰 불편함 완화 방안:
    - waiaas session create --output env 활용 (54-cli-flow-redesign.md)
    - Claude Desktop claude_desktop_config.json 설정 예시 제공
    - MCP 서버 시작 시 자동 세션 갱신 검토 (미래 확장)

- 3.4 옵션 C: 하이브리드 (--mcp-stdio) -- 미래 확장으로 정의
  - 설명: waiaas start --mcp-stdio로 데몬이 stdin/stdout을 MCP JSON-RPC로 사용
  - 장점: 세션 토큰 불필요, Claude Desktop에서 데몬을 직접 MCP 서버로 사용
  - 단점:
    - stdout이 MCP 프로토콜에 점유되어 일반 로그 출력 불가 -> stderr 리다이렉트 필요
    - foreground 전용 (--daemon과 조합 불가)
  - 미래 확장: SDK v2 안정화 후 검토 (예상 2026 Q2 이후)
  - 조건: --mcp-stdio 모드에서 console.log -> stderr, 로그 파일만 사용
  - claude_desktop_config.json 예시:
    ```json
    {
      "mcpServers": {
        "waiaas": {
          "command": "waiaas",
          "args": ["start", "--mcp-stdio"],
          "env": { "WAIAAS_DATA_DIR": "~/.waiaas" }
        }
      }
    }
    ```

- 3.5 결론 및 마이그레이션 경로:
  - 현재: 옵션 B (별도 stdio) 유지
  - 단기 (v0.5~v0.6): 옵션 B + 세션 토큰 자동화 개선
  - 중기 (v0.7+): 옵션 C 검토 (MCP SDK v2 안정화 기준)
  - 장기: Streamable HTTP 보편화 시 옵션 A 재검토

**섹션 4: 원격 에이전트 접근 가이드 (DX-08)**
- 4.1 배경:
  - 데몬이 127.0.0.1에만 바인딩 (z.literal('127.0.0.1'), CORE-01)
  - 원격 서버에서 실행 시 접근 방법 필요
  - 보안 원칙: localhost 바인딩은 보안 모델의 핵심 (masterAuth implicit의 전제)

- 4.2 SSH 터널 (추천):
  - 설명: SSH 포트 포워딩으로 원격 데몬에 로컬처럼 접근
  - 설정:
    ```bash
    # 원격 서버에서 데몬 실행
    ssh remote-server "waiaas start --daemon"

    # 로컬에서 터널 생성
    ssh -L 3100:127.0.0.1:3100 user@remote-server -N

    # 로컬에서 접근 (localhost로 인식)
    curl http://127.0.0.1:3100/v1/status
    waiaas session create --agent my-bot  # CLI도 그대로 사용
    ```
  - 장점: 추가 인프라 불필요, SSH 인증 재사용, 트래픽 암호화, masterAuth implicit 유지
  - 자동화: ~/.ssh/config에 LocalForward 설정, autossh로 영구 터널
  - MCP 원격 사용:
    ```bash
    # SSH 터널 유지 상태에서 로컬 MCP 서버가 원격 데몬에 연결
    WAIAAS_SESSION_TOKEN=... npx waiaas-mcp
    ```

- 4.3 VPN (WireGuard):
  - 설명: VPN 네트워크 내에서 SSH 터널과 유사하게 포트 포워딩
  - 적합 시나리오: 팀 환경, 여러 서비스를 VPN 내에서 운영
  - 설정 개요:
    - WireGuard 피어 간 터널 구성
    - SSH 포트 포워딩과 동일하게 로컬 3100 -> 원격 127.0.0.1:3100 매핑
    - 또는 VPN 네트워크 IP에서 SSH 터널 생성
  - 주의: 데몬은 여전히 127.0.0.1에 바인딩 (VPN IP에 직접 바인딩하지 않음)

- 4.4 --expose 플래그 (향후 Phase, 위험성 문서화):
  - 설명: waiaas start --expose <bind-address>로 외부 인터페이스에 바인딩
  - 예시: waiaas start --expose 0.0.0.0 또는 waiaas start --expose 10.0.0.0/24
  - 보안 위험:
    - localhost 보안 모델 붕괴: masterAuth implicit 사용 불가
    - 모든 엔드포인트에 masterAuth explicit (X-Master-Password 헤더) 필수
    - 네트워크 스니핑 위험: TLS 없이 패스워드가 평문 전송
    - 권장하지 않음: SSH 터널이 더 안전하고 설정이 간단
  - 미래 구현 시 요구사항:
    - --expose 사용 시 masterAuth implicit 자동 비활성화
    - TLS 인증서 설정 필수 (또는 --expose --tls-cert/--tls-key)
    - mTLS 도입 검토 (클라이언트 인증서)
    - 시작 시 대형 보안 경고 출력
  - Phase 21 범위: 스펙 정의 + 위험성 문서화만. 구현은 미래 Phase.

- 4.5 보안 고려사항 요약:
  | 방법 | 보안 수준 | masterAuth implicit | 추가 설정 | 권장도 |
  |------|----------|-------------------|----------|--------|
  | SSH 터널 | 높음 | 유지 | SSH 키 | 권장 |
  | VPN | 높음 | 유지 (터널 경유) | WireGuard 설정 | 적합 시 권장 |
  | --expose | 낮음 | 비활성화 필요 | TLS/mTLS | 비권장 |
  </action>
  <verify>
문서 내용 확인:
- MCP 옵션 A/B/C 3가지가 비교됨
- 옵션 B "채택" + 근거가 명시됨
- SSH 터널 설정 예시가 존재
- VPN 가이드가 존재
- --expose 위험성이 문서화됨
- 보안 고려사항 요약 테이블 존재
- 섹션 3~4 모두 존재
  </verify>
  <done>
55-dx-improvement-spec.md가 4개 섹션으로 완성되어 있고, hint 필드 에러 응답(20개+ hint 맵), MCP 3가지 옵션 비교(B 채택), 원격 접근 가이드(SSH 추천 + VPN + --expose 위험성)가 포함되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 55-dx-improvement-spec.md가 4개 섹션으로 존재
2. hint 필드가 ErrorResponseSchema 확장으로 정의됨 (DX-06)
3. 에러 코드별 hint 맵이 20개 이상 정의됨
4. MCP 옵션 A 기각 + B 채택 + C 미래 확장 (DX-07)
5. SSH 터널 추천 + VPN 가이드 + --expose 위험성 문서화 (DX-08)
6. SDK/MCP 통합 패턴이 코드 예시와 함께 정의됨
7. 29-api-framework-design.md, 38-sdk-mcp-interface.md 참조 일관성
</verification>

<success_criteria>
- DX-06, DX-07, DX-08 3개 요구사항이 단일 SSoT 문서에서 해결
- 55-dx-improvement-spec.md가 DX 개선의 SSoT 역할 수행
- MCP 내장 옵션에 대해 명확한 채택/기각 판단과 근거가 제공됨
</success_criteria>

<output>
After completion, create `.planning/phases/21-dx-improvement/21-02-SUMMARY.md`
</output>
