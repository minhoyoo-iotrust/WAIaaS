---
phase: 21-dx-improvement
plan: 03
type: execute
wave: 2
depends_on: [21-01, 21-02]
files_modified:
  - .planning/deliverables/28-daemon-lifecycle-cli.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/40-telegram-bot-docker.md
autonomous: true

must_haves:
  truths:
    - "28-daemon-lifecycle-cli.md에 v0.5 CLI 변경(init 간소화, agent create --owner, session create, --quickstart, --dev)이 반영되어 있다"
    - "37-rest-api-complete-spec.md 섹션 5-9 엔드포인트 상세가 v0.5 인증 맵에 맞게 업데이트되어 있다"
    - "37-rest-api-complete-spec.md에 hint 필드가 에러 응답 스키마에 추가되어 있다"
    - "40-telegram-bot-docker.md에 v0.5 인증 모델(3-tier 참조)과 Docker --dev 모드 주의사항이 반영되어 있다"
  artifacts:
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "v0.5 CLI 플로우 반영 (init, agent create, session create, --quickstart, --dev)"
      contains: "agent create"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "섹션 5-9 v0.5 엔드포인트 상세, hint 필드"
      contains: "hint"
    - path: ".planning/deliverables/40-telegram-bot-docker.md"
      provides: "v0.5 인증 모델 참조, Docker --dev 주의사항"
      contains: "masterAuth"
  key_links:
    - from: "28-daemon-lifecycle-cli.md"
      to: "54-cli-flow-redesign.md"
      via: "v0.5 CLI 변경 상세 위임"
    - from: "37-rest-api-complete-spec.md"
      to: "55-dx-improvement-spec.md"
      via: "hint 필드 상세 위임"
    - from: "37-rest-api-complete-spec.md"
      to: "52-auth-model-redesign.md"
      via: "섹션 5-9 인증 맵 참조"
    - from: "40-telegram-bot-docker.md"
      to: "52-auth-model-redesign.md"
      via: "3-tier 인증 모델 참조"
---

<objective>
중규모 기존 설계 문서 3개(28-daemon-lifecycle-cli.md, 37-rest-api-complete-spec.md, 40-telegram-bot-docker.md)에 v0.5 변경사항을 반영한다. 21-01(CLI 플로우)과 21-02(DX 개선)에서 생성한 신규 문서를 기반으로 기존 문서를 업데이트한다.

Purpose: Phase 21 Success Criteria #5 ("v0.5에서 변경된 인증 모델, Owner 주소 모델, 세션 갱신이 기존 설계 문서에 일관되게 반영")의 중규모 변경 3건을 해결한다. 37-rest-api-complete-spec.md의 Phase 19에서 위임된 섹션 5-9 업데이트도 이 Plan에서 완료한다.
Output: 28-daemon-lifecycle-cli.md (수정), 37-rest-api-complete-spec.md (수정), 40-telegram-bot-docker.md (수정)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 21 Plan 01-02 결과
@.planning/phases/21-dx-improvement/21-01-SUMMARY.md
@.planning/phases/21-dx-improvement/21-02-SUMMARY.md

# 신규 SSoT 문서 (21-01, 21-02에서 생성)
@.planning/deliverables/54-cli-flow-redesign.md
@.planning/deliverables/55-dx-improvement-spec.md

# 참조 문서 (인증 모델, 세션 갱신)
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/53-session-renewal-protocol.md

# 수정 대상 문서
@.planning/deliverables/28-daemon-lifecycle-cli.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/40-telegram-bot-docker.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 28-daemon-lifecycle-cli.md v0.5 CLI 변경 반영</name>
  <files>.planning/deliverables/28-daemon-lifecycle-cli.md</files>
  <action>
28-daemon-lifecycle-cli.md에 v0.5 CLI 변경사항을 반영한다. 19-03의 패턴을 따라 기존 구조 유지 + "(v0.5 변경)" 인라인 마킹.

**변경 1: 섹션 6.1 waiaas init -- v0.5 간소화 반영**
- 현재: 4단계 (Step 1 PW + Step 2 Agent + Step 3 Noti + Step 4 Owner)
- v0.5: 2단계 (Step 1 PW + Step 2 Infra)
- 기존 Step 2, 3, 4에 "(v0.5 제거)" 마킹 추가
- v0.5 init 플로우 설명 추가: "54-cli-flow-redesign.md 섹션 2 참조"
- --quickstart, --force 옵션 추가: "54-cli-flow-redesign.md 섹션 6 참조"

**변경 2: 섹션 6 CLI 커맨드 -- agent create, session create 추가**
- 기존 커맨드 (init, start, stop, status) 유지
- v0.5 신규/변경 커맨드 추가 (각각 간략 설명 + 상세 위임):
  - waiaas agent create --owner <address>: 에이전트 생성 + Owner 주소 등록. 상세: 54-cli-flow-redesign.md 섹션 3
  - waiaas agent list: 에이전트 목록 조회
  - waiaas session create --agent <name>: 세션 토큰 발급 (masterAuth implicit). 상세: 54-cli-flow-redesign.md 섹션 4
  - waiaas session list: 세션 목록 조회

**변경 3: 섹션 4 waiaas start -- --dev 플래그 추가**
- 기존 --daemon, --port, --host 옵션 유지
- --dev 옵션 추가: "고정 패스워드('waiaas-dev')로 프롬프트 없이 시작. 상세: 54-cli-flow-redesign.md 섹션 7"
- dev_mode 시작 배너 설명 추가
- 보안 경고: "--dev는 개발 환경 전용. --expose와 조합 금지."

**변경 4: 섹션 3 config.toml -- dev_mode 설정 추가**
- [daemon] 섹션에 dev_mode 설정 추가:
  ```toml
  [daemon]
  dev_mode = false  # (v0.5 추가) --dev와 동등. true 시 고정 패스워드 사용.
  ```

**변경 5: 참조 문서 섹션 업데이트**
- 문서 상단 참조 문서 목록에 추가:
  - 52-auth-model-redesign.md (3-tier 인증 모델)
  - 54-cli-flow-redesign.md (v0.5 CLI 플로우 재설계)

**주의사항:**
- 기존 내용을 삭제하지 않는다. 확장/추가/마킹만 한다.
- 28 문서는 데몬 라이프사이클과 CLI의 SSoT이므로, 54 문서와의 책임 경계 명시: 28 = 데몬 프로세스 관리 + CLI 인터페이스 목록, 54 = CLI 플로우 상세 + DX 설계
  </action>
  <verify>
문서 내용 확인:
- "agent create" 커맨드가 존재
- "session create" 커맨드가 존재
- "--dev" 옵션이 start에 존재
- init 섹션에 "(v0.5 제거)" 또는 "(v0.5 변경)" 마킹 존재
- "54-cli-flow-redesign.md" 참조가 존재
- 기존 init/start/stop/status 내용 유지
  </verify>
  <done>
28-daemon-lifecycle-cli.md에 v0.5 CLI 변경이 반영되어 있다: init 간소화(4->2단계), agent create --owner 추가, session create 추가, --dev 플래그 추가, config.toml dev_mode 추가. 54-cli-flow-redesign.md 상세 위임 참조가 포함되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 37-rest-api-complete-spec.md 섹션 5-9 업데이트 + hint 필드 반영</name>
  <files>.planning/deliverables/37-rest-api-complete-spec.md</files>
  <action>
37-rest-api-complete-spec.md에 Phase 19에서 위임된 섹션 5-9 엔드포인트 상세 업데이트와 hint 필드를 반영한다.

**변경 1: 에러 응답 스키마에 hint 필드 추가**
- 섹션 4 (에러 응답) 또는 해당 위치의 ErrorResponseSchema에 hint 필드 추가:
  ```
  hint: string (optional) -- 다음 행동을 안내하는 actionable 메시지 (v0.5 추가)
  ```
- "(v0.5 추가) 상세: 55-dx-improvement-spec.md 섹션 2 참조"

**변경 2: 에러 코드 테이블에 hint 열 추가 (선택적)**
- 기존 에러 코드 테이블(7 도메인 36+ 코드)에 hint 열을 추가하거나,
- 또는 "hint 맵은 55-dx-improvement-spec.md 섹션 2.2 참조" 위임 링크 추가
- 판단: 테이블이 이미 넓으면 위임 링크가 적절. 55 문서가 hint의 SSoT.

**변경 3: 섹션 5-9 엔드포인트 상세 v0.5 인증 반영**
- 19-03에서 "섹션 5-9는 Phase 21 위임"된 항목. 52-auth-model-redesign.md 섹션 4.2의 인증 맵을 기반으로 업데이트.
- 섹션 5 (Agent Management API) 엔드포인트 인증:
  - POST /v1/agents: masterAuth(implicit) -- "(v0.5 변경: ownerAuth -> masterAuth(implicit))"
  - GET /v1/agents: masterAuth(implicit)
  - GET /v1/agents/:id: masterAuth(implicit)
  - PUT /v1/agents/:id: masterAuth(implicit)
  - DELETE /v1/agents/:id: masterAuth(implicit)
  - POST /v1/agents/:id 에 ownerAddress 필수 필드 반영 (52 문서 참조)
- 섹션 6 (Session API -- Agent) 엔드포인트 인증:
  - POST /v1/sessions: masterAuth(implicit) -- "(v0.5 변경: ownerAuth -> masterAuth(implicit))"
  - GET /v1/sessions: masterAuth(implicit)
  - GET /v1/sessions/:id: masterAuth(implicit) 또는 sessionAuth
  - DELETE /v1/sessions/:id: masterAuth(implicit) -- "(v0.5 변경: 세션 폐기 + 갱신 거부)"
  - PUT /v1/sessions/:id/renew: sessionAuth -- "(Phase 20 추가)"
- 섹션 7 (Transaction API) 엔드포인트 인증:
  - POST /v1/transactions: sessionAuth
  - GET /v1/transactions: sessionAuth
  - GET /v1/transactions/:id: sessionAuth
  - POST /v1/owner/approve/:txId: ownerAuth -- "(유지: 거래 승인)"
  - POST /v1/owner/reject/:txId: masterAuth(implicit) -- "(v0.5 변경)"
- 섹션 8 (Owner API) 엔드포인트 인증:
  - POST /v1/owner/recover: ownerAuth -- "(유지: Kill Switch 복구)"
  - POST /v1/owner/kill-switch: masterAuth(implicit) -- "(v0.5 변경: 발동은 masterAuth)"
  - GET /v1/owner/status: masterAuth(implicit)
  - GET /v1/owner/sessions: masterAuth(implicit)
  - DELETE /v1/owner/sessions/:id: masterAuth(implicit)
  - GET /v1/owner/settings: masterAuth(implicit)
  - PUT /v1/owner/settings: masterAuth(implicit)
- 섹션 9 (Admin API) 엔드포인트 인증:
  - GET /v1/admin/health: 없음 (public)
  - POST /v1/admin/shutdown: masterAuth(explicit)
  - GET /v1/admin/audit-log: masterAuth(implicit)
  - GET /v1/admin/config: masterAuth(implicit)
  - PUT /v1/admin/config: masterAuth(explicit) -- "(v0.5 변경: 설정 변경은 explicit)"
- 각 엔드포인트에 변경 사유 간략 기술 + 52-auth-model-redesign.md 참조 링크

**변경 4: 참조 문서 업데이트**
- 문서 상단 참조 목록에 55-dx-improvement-spec.md 추가

**주의사항:**
- 기존 엔드포인트 스펙(경로, 메서드, 요청/응답 스키마)은 변경하지 않는다. 인증 수단만 업데이트.
- 이미 Phase 19-20에서 변경된 섹션 1-4는 다시 수정하지 않는다.
- 에러 코드 RENEWAL_* 시리즈는 20-02에서 이미 추가됨. 중복 추가하지 않는다.
  </action>
  <verify>
37-rest-api-complete-spec.md 확인:
- "hint" 필드가 에러 응답 스키마에 존재
- 섹션 5-9 각 엔드포인트의 인증이 52-auth-model-redesign.md와 일치
- "(v0.5 변경)" 마킹이 변경된 엔드포인트에 존재
- ownerAuth가 approve/:txId와 recover에만 적용
- "55-dx-improvement-spec.md" 참조 존재
  </verify>
  <done>
37-rest-api-complete-spec.md에 hint 필드가 에러 응답에 추가되어 있고, 섹션 5-9 전체 엔드포인트의 인증이 v0.5 맵에 맞게 업데이트되어 있으며, ownerAuth가 approve/:txId와 recover 2곳에만 한정되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 3: 40-telegram-bot-docker.md v0.5 인증 모델 반영</name>
  <files>.planning/deliverables/40-telegram-bot-docker.md</files>
  <action>
40-telegram-bot-docker.md에 v0.5 인증 모델 변경과 Docker --dev 모드 주의사항을 반영한다.

**변경 1: 인증 모델 참조 업데이트**
- 현재: 2-Tier auth (Tier 1 chatId, Tier 2 ownerAuth)로 설명
- v0.5: 3-tier 인증 모델 참조 추가
  - Tier 1 chatId (읽기 전용): 변경 없음
  - Tier 2: "(v0.5 변경) ownerAuth -> masterAuth(implicit)로 대부분 변경. ownerAuth는 거래 승인과 Kill Switch 복구에만 한정. 상세: 52-auth-model-redesign.md 참조"
- ownerAuth가 필요한 봇 커맨드 업데이트:
  - /approve: ownerAuth 유지 (거래 승인)
  - /recover: ownerAuth 유지 (Kill Switch 복구)
  - 나머지 커맨드: masterAuth(implicit) -- 봇이 localhost에서 데몬 API 호출하므로 추가 인증 불필요

**변경 2: Docker 환경에서 --dev 모드 주의사항**
- Docker Compose 예시에 --dev 관련 주의사항 추가:
  ```yaml
  # WARNING: --dev 모드는 개발/테스트 환경에서만 사용
  # 프로덕션 Docker 배포에서는 절대 사용 금지
  services:
    waiaas:
      command: ["waiaas", "start"]  # --dev 사용 금지
      environment:
        - WAIAAS_MASTER_PASSWORD_FILE=/run/secrets/master-password
  ```
- dev_mode=true가 Docker 환경에서 위험한 이유: 고정 패스워드가 이미지에 포함됨
- Docker 테스트 환경 예시 (--dev 허용):
  ```yaml
  # 테스트/개발용 Docker Compose
  services:
    waiaas-dev:
      command: ["waiaas", "start", "--dev"]
      # --dev는 테스트 환경에서만 사용
  ```

**변경 3: 세션 토큰 관리 v0.5 반영**
- 봇의 세션 토큰 관리 설명 업데이트:
  - v0.2: 봇 시작 시 ownerAuth로 세션 생성
  - v0.5: 봇 시작 시 masterAuth(implicit)로 세션 생성 -- 서명 불필요
  - 세션 갱신: 53-session-renewal-protocol.md 참조 (봇이 PUT /v1/sessions/:id/renew 호출 가능)

**변경 4: 참조 문서 업데이트**
- 문서 상단 참조 목록에 추가:
  - 52-auth-model-redesign.md (3-tier 인증 모델)
  - 54-cli-flow-redesign.md (--dev 모드 상세)
  - 53-session-renewal-protocol.md (세션 갱신)

**주의사항:**
- 기존 Long Polling 아키텍처, Docker 배포 설정, 보안 모델은 변경하지 않는다.
- 인증 모델 참조만 업데이트하고, 봇의 핵심 기능에는 영향 없음.
  </action>
  <verify>
문서 내용 확인:
- "masterAuth" 키워드가 인증 설명에 존재
- "52-auth-model-redesign.md" 참조 존재
- Docker --dev 주의사항이 존재
- ownerAuth가 /approve, /recover에만 명시
- 세션 갱신 참조 존재
  </verify>
  <done>
40-telegram-bot-docker.md에 v0.5 인증 모델(3-tier 참조, ownerAuth 2곳 한정)이 반영되어 있고, Docker --dev 모드 주의사항과 세션 갱신 참조가 추가되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 28-daemon-lifecycle-cli.md에 v0.5 CLI 변경 5건 반영 확인
2. 37-rest-api-complete-spec.md에 hint 필드 + 섹션 5-9 인증 업데이트 확인
3. 40-telegram-bot-docker.md에 v0.5 인증 + Docker --dev 주의사항 확인
4. 52-auth-model-redesign.md의 인증 맵과 3개 문서의 인증 기술이 일치
5. 기존 내용 보존 확인 (삭제 없이 확장/마킹만)
</verification>

<success_criteria>
- Phase 21 중규모 변경 3건 완료
- 37-rest-api-complete-spec.md 섹션 5-9 위임 항목 해소 (19-03 결정 D2)
- hint 필드가 API 스펙에 공식 반영
- 3개 문서 모두 v0.5 인증 모델과 일관
</success_criteria>

<output>
After completion, create `.planning/phases/21-dx-improvement/21-03-SUMMARY.md`
</output>
