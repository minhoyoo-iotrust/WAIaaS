---
phase: 21-dx-improvement
plan: 04
type: execute
wave: 2
depends_on: [21-01, 21-02]
files_modified:
  - .planning/deliverables/24-monorepo-data-directory.md
  - .planning/deliverables/29-api-framework-design.md
  - .planning/deliverables/38-sdk-mcp-interface.md
  - .planning/deliverables/39-tauri-desktop-architecture.md
  - .planning/deliverables/33-time-lock-approval-mechanism.md
  - .planning/deliverables/36-killswitch-autostop-evm.md
autonomous: true

must_haves:
  truths:
    - "24-monorepo-data-directory.md에 --dev mode config.toml 설정과 --quickstart 관련 디렉토리 변경이 반영되어 있다"
    - "29-api-framework-design.md에 ErrorResponseSchema hint 필드와 authRouter 참조가 추가되어 있다"
    - "38-sdk-mcp-interface.md에 MCP 내장 옵션 검토 결과, v0.5 인증 변경, 세션 갱신 API가 반영되어 있다"
    - "39-tauri-desktop-architecture.md에 v0.5 인증 모델과 Setup Wizard init 플로우 변경이 반영되어 있다"
    - "33, 36 문서에 v0.5 인증 모델 변경 참조 노트가 추가되어 있다"
  artifacts:
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "dev_mode config, .master-password 파일 설명"
      contains: "dev_mode"
    - path: ".planning/deliverables/29-api-framework-design.md"
      provides: "ErrorResponseSchema hint, authRouter 참조"
      contains: "hint"
    - path: ".planning/deliverables/38-sdk-mcp-interface.md"
      provides: "MCP 검토 결과, v0.5 인증, 세션 갱신 API"
      contains: "55-dx-improvement-spec.md"
    - path: ".planning/deliverables/39-tauri-desktop-architecture.md"
      provides: "v0.5 인증 참조, Setup Wizard 변경"
      contains: "52-auth-model-redesign.md"
    - path: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      provides: "v0.5 인증 변경 참조 노트"
      contains: "52-auth-model-redesign.md"
    - path: ".planning/deliverables/36-killswitch-autostop-evm.md"
      provides: "v0.5 인증 변경 참조 노트"
      contains: "52-auth-model-redesign.md"
  key_links:
    - from: "29-api-framework-design.md"
      to: "55-dx-improvement-spec.md"
      via: "hint 필드 상세 참조"
    - from: "38-sdk-mcp-interface.md"
      to: "55-dx-improvement-spec.md"
      via: "MCP 내장 옵션 검토 결과 참조"
    - from: "39-tauri-desktop-architecture.md"
      to: "54-cli-flow-redesign.md"
      via: "Setup Wizard init 플로우 참조"
---

<objective>
소규모 기존 설계 문서 4개(24, 29, 38, 39) + 참조 노트 문서 2개(33, 36)에 v0.5 변경사항을 반영하고, 전체 설계 문서 통합 일관성을 검증한다.

Purpose: Phase 21 Success Criteria #5의 소규모 변경과 통합 일관성 검증을 완료하여 v0.5 마일스톤의 설계 문서 정합성을 확보한다.
Output: 6개 문서 소규모 수정
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 21 Plan 01-02 결과
@.planning/phases/21-dx-improvement/21-01-SUMMARY.md
@.planning/phases/21-dx-improvement/21-02-SUMMARY.md

# 신규 SSoT 문서
@.planning/deliverables/54-cli-flow-redesign.md
@.planning/deliverables/55-dx-improvement-spec.md

# 참조 문서
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/53-session-renewal-protocol.md

# 수정 대상 문서
@.planning/deliverables/24-monorepo-data-directory.md
@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/38-sdk-mcp-interface.md
@.planning/deliverables/39-tauri-desktop-architecture.md
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/deliverables/36-killswitch-autostop-evm.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 24, 29 문서 소규모 업데이트</name>
  <files>
.planning/deliverables/24-monorepo-data-directory.md
.planning/deliverables/29-api-framework-design.md
  </files>
  <action>
2개 문서에 v0.5 소규모 변경을 반영한다.

**=== 24-monorepo-data-directory.md 변경 ===**

**변경 1: config.toml [daemon] 섹션에 dev_mode 추가**
- 기존 [daemon] 섹션에 1개 키 추가:
  ```toml
  [daemon]
  dev_mode = false  # (v0.5 추가) --dev 모드 영구 설정. true 시 고정 패스워드 'waiaas-dev' 사용.
  ```
- "(v0.5 추가)" 마킹

**변경 2: ~/.waiaas/ 디렉토리 구조에 .master-password 파일 설명 추가**
- --quickstart 시 자동 생성되는 파일:
  ```
  ~/.waiaas/
    config.toml
    waiaas.db
    keystore/
    .master-password  # (v0.5 추가) --quickstart 시 자동 생성. mode 0o600.
  ```
- 파일 설명: "마스터 패스워드 파일. --quickstart로 자동 생성되거나, --password-file로 참조됨. 파일 권한 0o600 필수."

**변경 3: 참조 문서 업데이트**
- 54-cli-flow-redesign.md 참조 추가

**=== 29-api-framework-design.md 변경 ===**

**변경 4: ErrorResponseSchema에 hint 필드 추가**
- 기존 ErrorResponseSchema 정의 위치에 hint 필드 추가:
  ```typescript
  hint: z.string().optional()  // (v0.5 추가) actionable guidance
  ```
- 설명: "다음 행동을 안내하는 선택적 문자열. AI 에이전트가 에러 복구 판단에 활용. 상세: 55-dx-improvement-spec.md 섹션 2 참조"

**변경 5: 미들웨어 체인에 authRouter 참조 추가**
- 기존 미들웨어 순서 (ID -> Log -> ShutdownGuard -> SecureHeaders -> Host -> CORS -> Rate -> Auth) 중 Auth 부분에:
  - "(v0.5 변경) Auth 단계가 authRouter 통합 디스패처로 변경됨. masterAuth(implicit/explicit), ownerAuth, sessionAuth를 경로별로 자동 분기. 상세: 52-auth-model-redesign.md 섹션 5 참조"
- 기존 내용 삭제 없이 v0.5 변경 사항 추가

**변경 6: 참조 문서 업데이트**
- 52-auth-model-redesign.md, 55-dx-improvement-spec.md 참조 추가
  </action>
  <verify>
24-monorepo-data-directory.md 확인:
- "dev_mode" 키가 config.toml [daemon] 섹션에 존재
- ".master-password" 파일이 디렉토리 구조에 존재

29-api-framework-design.md 확인:
- "hint" 필드가 ErrorResponseSchema에 존재
- "authRouter" 참조가 미들웨어 설명에 존재
- "52-auth-model-redesign.md" 참조 존재
  </verify>
  <done>
24-monorepo-data-directory.md에 dev_mode config와 .master-password 파일이 추가되어 있고, 29-api-framework-design.md에 hint 필드와 authRouter 참조가 추가되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 38, 39 문서 소규모 업데이트 + 33, 36 참조 노트 추가</name>
  <files>
.planning/deliverables/38-sdk-mcp-interface.md
.planning/deliverables/39-tauri-desktop-architecture.md
.planning/deliverables/33-time-lock-approval-mechanism.md
.planning/deliverables/36-killswitch-autostop-evm.md
  </files>
  <action>
4개 문서에 v0.5 소규모 변경을 반영한다.

**=== 38-sdk-mcp-interface.md 변경 ===**

**변경 1: MCP 내장 옵션 검토 결과 기록**
- MCP Server 섹션(섹션 5)에 v0.5 검토 결과 추가:
  - "(v0.5 검토) MCP 데몬 내장 옵션(Streamable HTTP, 하이브리드 stdio)을 검토하였으나, 현행 별도 stdio 프로세스를 유지하기로 결정. 근거: MCP 호스트 생태계가 stdio 기반이며 안정성 확보. 상세: 55-dx-improvement-spec.md 섹션 3 참조"

**변경 2: v0.5 인증 모델 변경 반영**
- TS SDK Owner 관련 메서드 업데이트:
  - "(v0.5 변경) 대부분 Owner 메서드의 인증이 ownerAuth -> masterAuth(implicit)로 변경. signMessage 콜백은 approve, recover에만 필요. 상세: 52-auth-model-redesign.md 참조"
- MCP tools 인증 설명 업데이트:
  - "(v0.5 변경) MCP tool 호출은 WAIAAS_SESSION_TOKEN(sessionAuth) 사용. 세션 생성은 masterAuth(implicit)."

**변경 3: 세션 갱신 API 추가**
- TS SDK 메서드 목록에 추가:
  - `client.sessions.renew(sessionId)` -- 세션 갱신 (sessionAuth). 53-session-renewal-protocol.md 참조.
- MCP tools에 세션 갱신 추가 고려:
  - "(v0.5 참고) 에이전트가 세션 갱신을 자율적으로 수행 가능. MCP tool에 renew-session 추가 검토 가능 (미래 확장)."

**변경 4: 참조 문서 업데이트**
- 52-auth-model-redesign.md, 53-session-renewal-protocol.md, 55-dx-improvement-spec.md 참조 추가

**=== 39-tauri-desktop-architecture.md 변경 ===**

**변경 5: v0.5 인증 모델 참조 업데이트**
- 인증 관련 설명에 v0.5 변경 반영:
  - "(v0.5 변경) 데스크톱 앱에서 데몬 API 호출 시 masterAuth(implicit) 사용 (localhost). Owner 관련 기능(거래 승인, Kill Switch 복구)만 ownerAuth(WalletConnect/수동 서명) 필요. 상세: 52-auth-model-redesign.md 참조"

**변경 6: Setup Wizard init 플로우 변경 반영**
- Setup Wizard 5-step 중 init 관련 단계 업데이트:
  - "(v0.5 변경) waiaas init이 순수 인프라 초기화로 간소화. 에이전트 생성과 Owner 등록은 별도 단계(agent create)로 분리. Setup Wizard의 단계도 이에 맞게 재구성. 상세: 54-cli-flow-redesign.md 참조"
- Wizard 단계 예시 업데이트:
  - Step 1: 마스터 패스워드 설정
  - Step 2: 인프라 초기화 (자동)
  - Step 3: 에이전트 생성 + Owner 주소 입력
  - Step 4: 세션 토큰 발급
  - Step 5: 완료 (대시보드로 이동)

**변경 7: 참조 문서 업데이트**
- 52-auth-model-redesign.md, 54-cli-flow-redesign.md 참조 추가

**=== 33-time-lock-approval-mechanism.md 참조 노트 ===**

**변경 8: v0.5 인증 변경 참조 노트 추가**
- 문서 상단 또는 APPROVAL 섹션에 참조 노트 추가:
  - "> **v0.5 인증 모델 변경:** APPROVAL 티어 거래 승인의 인증이 v0.5에서 재정의되었습니다. ownerAuth는 거래 승인(approve)에 유지되며, 거래 거부(reject)는 masterAuth(implicit)로 변경되었습니다. 상세: 52-auth-model-redesign.md 참조"
- DELAY Worker 관련: Owner 취소가 masterAuth(implicit)로 변경된 점 기록

**=== 36-killswitch-autostop-evm.md 참조 노트 ===**

**변경 9: v0.5 인증 변경 참조 노트 추가**
- Kill Switch 섹션에 참조 노트 추가:
  - "> **v0.5 인증 모델 변경:** Kill Switch 발동(activate)의 인증이 masterAuth(implicit)로 변경되었으며, 복구(recover)만 ownerAuth를 유지합니다. 상세: 52-auth-model-redesign.md 참조"
- AutoStopEngine: 변경 없음 (이벤트 기반, 인증 무관)

**주의사항:**
- 모든 문서에서 기존 내용 삭제 없이 추가/마킹만 수행
- 33, 36은 참조 노트만 추가 (인라인 코드 수정 없음)
  </action>
  <verify>
38-sdk-mcp-interface.md 확인:
- MCP 내장 옵션 검토 결과가 존재
- "55-dx-improvement-spec.md" 참조 존재
- 세션 갱신 API 추가가 존재

39-tauri-desktop-architecture.md 확인:
- "masterAuth(implicit)" 참조 존재
- Setup Wizard 변경이 존재
- "54-cli-flow-redesign.md" 참조 존재

33-time-lock-approval-mechanism.md 확인:
- v0.5 인증 참조 노트 존재
- "52-auth-model-redesign.md" 참조 존재

36-killswitch-autostop-evm.md 확인:
- v0.5 인증 참조 노트 존재
- "52-auth-model-redesign.md" 참조 존재
  </verify>
  <done>
38-sdk-mcp-interface.md에 MCP 검토 결과/인증 변경/세션 갱신이 반영되어 있고, 39-tauri-desktop-architecture.md에 인증 모델/Setup Wizard 변경이 반영되어 있으며, 33/36 문서에 v0.5 인증 변경 참조 노트가 추가되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 3: v0.5 설계 문서 통합 일관성 검증 체크리스트</name>
  <files>
.planning/deliverables/54-cli-flow-redesign.md
  </files>
  <action>
54-cli-flow-redesign.md의 마지막에 부록으로 "v0.5 설계 문서 통합 검증 체크리스트"를 추가한다. 이 체크리스트는 Phase 21 완료 후 검증에 사용된다.

**부록 A: v0.5 설계 문서 통합 검증 체크리스트**

핵심 용어별 전수 검증 항목:

**1. masterAuth (implicit/explicit)**
- [ ] 52-auth-model-redesign.md: 정의 SSoT (섹션 3.1)
- [ ] 37-rest-api-complete-spec.md: 31+1 엔드포인트 인증 맵 일치
- [ ] 28-daemon-lifecycle-cli.md: CLI 커맨드 인증 수준 일치
- [ ] 29-api-framework-design.md: authRouter 참조 존재
- [ ] 40-telegram-bot-docker.md: Tier 2 인증 업데이트
- [ ] 54-cli-flow-redesign.md: session create가 masterAuth(implicit)

**2. ownerAuth (2곳 한정)**
- [ ] 52-auth-model-redesign.md: approve_tx + recover만 (섹션 4.2)
- [ ] 37-rest-api-complete-spec.md: ownerAuth가 2개 엔드포인트만
- [ ] 34-owner-wallet-connection.md: WalletConnect 선택적 참조
- [ ] 33-time-lock-approval-mechanism.md: approve는 ownerAuth 유지 참조 노트
- [ ] 36-killswitch-autostop-evm.md: recover는 ownerAuth 유지 참조 노트

**3. agents.owner_address NOT NULL**
- [ ] 52-auth-model-redesign.md: agents 테이블 변경 정의
- [ ] 25-sqlite-schema.md: owner_address 컬럼 추가 (Phase 19 완료)
- [ ] 54-cli-flow-redesign.md: --owner 필수 옵션
- [ ] 37-rest-api-complete-spec.md: POST /v1/agents에 ownerAddress 필수

**4. 세션 갱신 프로토콜**
- [ ] 53-session-renewal-protocol.md: SSoT (8개 섹션)
- [ ] 30-session-token-protocol.md: SessionConstraints 확장 (Phase 20 완료)
- [ ] 25-sqlite-schema.md: sessions 테이블 갱신 컬럼 (Phase 20 완료)
- [ ] 37-rest-api-complete-spec.md: PUT /v1/sessions/:id/renew (Phase 20 완료)
- [ ] 35-notification-architecture.md: SESSION_RENEWED/REJECTED (Phase 20 완료)
- [ ] 38-sdk-mcp-interface.md: sessions.renew() 메서드 추가

**5. hint 필드**
- [ ] 55-dx-improvement-spec.md: 정의 SSoT (섹션 2)
- [ ] 29-api-framework-design.md: ErrorResponseSchema 확장
- [ ] 37-rest-api-complete-spec.md: 에러 응답에 hint 추가

**6. CLI 플로우 (init/agent create/session create/--quickstart/--dev)**
- [ ] 54-cli-flow-redesign.md: SSoT (8개 섹션)
- [ ] 28-daemon-lifecycle-cli.md: v0.5 변경 반영
- [ ] 24-monorepo-data-directory.md: dev_mode config + .master-password
- [ ] 39-tauri-desktop-architecture.md: Setup Wizard 변경

이 체크리스트를 54-cli-flow-redesign.md의 부록으로 추가하여, 검증 단계에서 사용 가능하도록 한다.
  </action>
  <verify>
54-cli-flow-redesign.md에 부록 A 체크리스트 존재 확인:
- 6개 핵심 용어 카테고리
- 각 카테고리별 문서 참조 체크 항목
- 모든 v0.5 변경 대상 문서(11개+)가 커버됨
  </verify>
  <done>
v0.5 설계 문서 통합 검증 체크리스트가 54-cli-flow-redesign.md 부록 A로 존재하며, 6개 핵심 용어별 전수 검증 항목이 17개 문서 참조를 커버하고 있다.
  </done>
</task>

</tasks>

<verification>
1. 24-monorepo-data-directory.md에 dev_mode + .master-password 반영 확인
2. 29-api-framework-design.md에 hint 필드 + authRouter 참조 확인
3. 38-sdk-mcp-interface.md에 MCP 검토 + 인증 변경 + 갱신 API 확인
4. 39-tauri-desktop-architecture.md에 인증 참조 + Wizard 변경 확인
5. 33, 36 문서에 v0.5 인증 참조 노트 확인
6. 통합 체크리스트가 6개 핵심 용어를 커버
7. 11개+ 설계 문서 전체의 v0.5 용어 일관성 확인
</verification>

<success_criteria>
- Phase 21 소규모 변경 4건 + 참조 노트 2건 완료
- v0.5 설계 문서 통합 검증 체크리스트 존재
- Phase 21 Success Criteria #5 ("11개 설계 문서 일관성") 달성을 위한 최종 검증 가능 상태
</success_criteria>

<output>
After completion, create `.planning/phases/21-dx-improvement/21-04-SUMMARY.md`
</output>
