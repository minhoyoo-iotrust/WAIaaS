---
phase: 136-cumulative-spending-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/core/src/schemas/policy.schema.ts
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/pipeline/database-policy-engine.ts
  - packages/daemon/src/__tests__/migration-chain.test.ts
  - packages/daemon/src/__tests__/migration-runner.test.ts
autonomous: true

must_haves:
  truths:
    - "transactions 테이블에 amount_usd REAL과 reserved_amount_usd REAL 컬럼이 존재한다"
    - "LATEST_SCHEMA_VERSION이 13이고, v12 DB에서 v13 마이그레이션이 성공한다"
    - "fresh DB pushSchema 시 amount_usd/reserved_amount_usd 컬럼이 포함된다"
    - "SpendingLimitRulesSchema에 daily_limit_usd/monthly_limit_usd optional 필드가 존재한다"
    - "Stage 3에서 priceResult 성공 시 evaluateAndReserve 내부에서 amount_usd/reserved_amount_usd가 UPDATE된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v13 마이그레이션 (ALTER TABLE ADD COLUMN amount_usd, reserved_amount_usd)"
      contains: "version: 13"
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "transactions 테이블 Drizzle 스키마에 amountUsd, reservedAmountUsd 컬럼"
      contains: "amountUsd"
    - path: "packages/core/src/schemas/policy.schema.ts"
      provides: "SpendingLimitRulesSchema에 daily_limit_usd, monthly_limit_usd 필드"
      contains: "daily_limit_usd"
    - path: "packages/daemon/src/pipeline/database-policy-engine.ts"
      provides: "evaluateAndReserve 내 amount_usd/reserved_amount_usd UPDATE 쿼리"
      contains: "amount_usd"
  key_links:
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "usdAmount 파라미터를 evaluateAndReserve에 전달"
      pattern: "evaluateAndReserve.*usdAmount"
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "amount_usd/reserved_amount_usd 컬럼에 UPDATE"
      pattern: "UPDATE transactions SET amount_usd"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "v13 마이그레이션이 schema.ts Drizzle 정의와 동기"
      pattern: "LATEST_SCHEMA_VERSION = 13"
---

<objective>
DB v13 마이그레이션으로 transactions 테이블에 amount_usd/reserved_amount_usd 컬럼을 추가하고, SpendingLimitRulesSchema에 누적 한도 필드를 확장하며, evaluateAndReserve에서 USD 금액을 DB에 기록하는 기반을 구축한다.

Purpose: Phase 136 Plan 02의 누적 집계 쿼리가 SUM(amount_usd)로 동작하려면 먼저 트랜잭션별 USD 금액이 DB에 기록되어야 한다. 이 플랜은 DB 스키마 + Zod 스키마 + USD 기록 로직의 기반을 한 번에 구축한다.
Output: DB v13 마이그레이션, 확장된 Drizzle/Zod 스키마, evaluateAndReserve 내 amount_usd 기록 로직
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.5.3-usd-policy-enhancement.md
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/core/src/schemas/policy.schema.ts
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/__tests__/migration-chain.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB v13 마이그레이션 + Drizzle 스키마 + SpendingLimitRulesSchema 확장</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/infrastructure/database/schema.ts
    packages/core/src/schemas/policy.schema.ts
  </files>
  <action>
1. **migrate.ts -- v13 마이그레이션 추가:**
   - LATEST_SCHEMA_VERSION을 12에서 13으로 변경한다.
   - MIGRATIONS 배열에 version: 13 마이그레이션을 push한다.
   - 이 마이그레이션은 단순 ALTER TABLE ADD COLUMN이므로 `managesOwnTransaction: false`로 한다 (표준 트랜잭션 래핑).
   - SQL:
     ```sql
     ALTER TABLE transactions ADD COLUMN amount_usd REAL;
     ALTER TABLE transactions ADD COLUMN reserved_amount_usd REAL;
     ```
   - description: `'Add amount_usd and reserved_amount_usd columns to transactions'`
   - getCreateTableStatements()의 transactions DDL에도 `amount_usd REAL,`과 `reserved_amount_usd REAL,`을 `reserved_amount TEXT,` 행 다음에 추가한다. (fresh DB와 migrated DB 동기 보장)

2. **schema.ts -- Drizzle 스키마에 컬럼 추가:**
   - transactions 테이블의 `reservedAmount` 행 다음에 2개 컬럼 추가:
     ```ts
     amountUsd: real('amount_usd'),
     reservedAmountUsd: real('reserved_amount_usd'),
     ```
   - drizzle-orm/sqlite-core에서 `real` 타입을 import한다 (기존 import에 추가).
   - 두 컬럼 모두 nullable (INSERT 시점에는 값 없음, Stage 3에서 UPDATE).

3. **policy.schema.ts -- SpendingLimitRulesSchema에 누적 한도 필드 추가:**
   - `delay_seconds` 행 다음에 2개 필드 추가:
     ```ts
     /** 24시간 롤링 윈도우 내 누적 USD 지출 상한 (optional, 미설정 시 누적 한도 없음) */
     daily_limit_usd: z.number().positive().optional(),
     /** 30일 롤링 윈도우 내 누적 USD 지출 상한 */
     monthly_limit_usd: z.number().positive().optional(),
     ```
   - `.positive()`를 사용한다 (0은 의미 없고, 비활성화는 필드 미설정으로 처리).
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/core --filter=daemon` 성공
    - migrate.ts에서 `LATEST_SCHEMA_VERSION === 13` 확인
    - schema.ts에서 `amountUsd`와 `reservedAmountUsd` 컬럼 확인
    - policy.schema.ts에서 `daily_limit_usd`와 `monthly_limit_usd` 필드 확인
  </verify>
  <done>
    - DB v13 마이그레이션이 amount_usd/reserved_amount_usd 두 컬럼을 ALTER TABLE로 추가한다
    - LATEST_SCHEMA_VERSION이 13이고, fresh DDL에도 두 컬럼이 포함된다
    - SpendingLimitRulesSchema에 daily_limit_usd/monthly_limit_usd optional 필드가 존재한다
    - 빌드가 성공한다
  </done>
</task>

<task type="auto">
  <name>Task 2: evaluateAndReserve에서 amount_usd/reserved_amount_usd DB 기록 + 마이그레이션 테스트</name>
  <files>
    packages/daemon/src/pipeline/database-policy-engine.ts
    packages/daemon/src/__tests__/migration-chain.test.ts
    packages/daemon/src/__tests__/migration-runner.test.ts
  </files>
  <action>
1. **database-policy-engine.ts -- evaluateAndReserve 내 amount_usd 기록:**
   - evaluateAndReserve() 메서드의 BEGIN IMMEDIATE 트랜잭션 내부에서, 기존 `UPDATE transactions SET reserved_amount = ? WHERE id = ?` 쿼리 (라인 570-574)를 확장한다.
   - usdAmount가 전달된 경우, 같은 UPDATE에서 amount_usd와 reserved_amount_usd도 함께 기록한다:
     ```ts
     // Set reserved_amount on the transaction row + USD amounts if available
     if (usdAmount !== undefined) {
       sqlite
         .prepare(
           `UPDATE transactions SET reserved_amount = ?, amount_usd = ?, reserved_amount_usd = ? WHERE id = ?`,
         )
         .run(transaction.amount, usdAmount, usdAmount, txId);
     } else {
       sqlite
         .prepare(
           `UPDATE transactions SET reserved_amount = ? WHERE id = ?`,
         )
         .run(transaction.amount, txId);
     }
     ```
   - usdAmount가 undefined인 경우(오라클 비가용)는 기존 동작 그대로 reserved_amount만 기록한다. amount_usd/reserved_amount_usd는 NULL로 남는다.
   - 핵심: amount_usd와 reserved_amount_usd에 동일 값 기록. amount_usd는 확정 기록용(CONFIRMED 후에도 유지), reserved_amount_usd는 대기 상태 누적 집계용(완료/실패 시 releaseReservation에서 클리어).

2. **database-policy-engine.ts -- releaseReservation 확장:**
   - 기존 `UPDATE transactions SET reserved_amount = NULL WHERE id = ?`에 reserved_amount_usd도 NULL로 클리어:
     ```ts
     this.sqlite
       .prepare('UPDATE transactions SET reserved_amount = NULL, reserved_amount_usd = NULL WHERE id = ?')
       .run(txId);
     ```

3. **database-policy-engine.ts -- approval-workflow.ts 패턴 확인:**
   - approval-workflow.ts의 approve(), reject(), processExpiredApprovals() 메서드에서도 `reserved_amount = NULL`을 설정하는 곳이 있다 (라인 172, 222, 262). 이 파일은 이 플랜에서 수정하지 않는다 -- Plan 02에서 reserved_amount_usd NULL 클리어를 통합한다. 대신 database-policy-engine.ts의 releaseReservation만 수정한다.
   - **중요**: approval-workflow.ts에서 reserved_amount = NULL하는 3곳도 reserved_amount_usd = NULL을 추가해야 한다. 이 파일은 Plan 02의 범위에 포함한다 (approval-workflow.ts 수정).

4. **migration-chain.test.ts -- v13 마이그레이션 체인 테스트:**
   - 기존 테스트 패턴을 따라 v13 관련 테스트를 추가한다:
     - T-12: v12 DB -> pushSchema 성공 (v13 마이그레이션 적용)
     - T-13: v13 적용 후 amount_usd, reserved_amount_usd 컬럼 존재 확인 (PRAGMA table_info)
     - T-14: amount_usd/reserved_amount_usd에 REAL 값 INSERT/SELECT 가능 확인
     - T-15: 기존 트랜잭션 데이터가 마이그레이션 후 보존됨 (amount_usd는 NULL)
   - 기존 createV1SchemaDatabase() 패턴 활용. v12 스키마 스냅샷 함수 createV12SchemaDatabase() 추가 필요 시 v9 패턴(createV9SchemaDatabase 등)을 참조.

5. **migration-runner.test.ts -- 스키마 스냅샷 픽스처 갱신:**
   - LATEST_SCHEMA_VERSION 관련 assertion이 있다면 12 -> 13으로 업데이트.
   - transactions 테이블 DDL에 amount_usd, reserved_amount_usd 컬럼이 포함되어야 한다면 업데이트.
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run --reporter=verbose packages/daemon/src/__tests__/migration-chain.test.ts packages/daemon/src/__tests__/migration-runner.test.ts` 모든 테스트 통과
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run --reporter=verbose packages/daemon/src/__tests__/policy-engine.test.ts` 기존 정책 엔진 테스트 통과 (regression 없음)
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=daemon` 성공
  </verify>
  <done>
    - evaluateAndReserve에서 usdAmount 전달 시 amount_usd/reserved_amount_usd가 트랜잭션 행에 기록된다
    - releaseReservation에서 reserved_amount_usd도 NULL로 클리어된다
    - v13 마이그레이션 체인 테스트가 통과한다 (컬럼 존재, 데이터 보존, REAL 값 기록)
    - 기존 정책 엔진 테스트에 regression이 없다
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` -- core, daemon 빌드 성공
2. `npx vitest run packages/daemon/src/__tests__/migration-chain.test.ts` -- v13 마이그레이션 테스트 통과
3. `npx vitest run packages/daemon/src/__tests__/migration-runner.test.ts` -- 마이그레이션 러너 테스트 통과
4. `npx vitest run packages/daemon/src/__tests__/policy-engine.test.ts` -- 기존 정책 엔진 regression 없음
5. LATEST_SCHEMA_VERSION === 13
6. SpendingLimitRulesSchema.parse({ ..., daily_limit_usd: 500, monthly_limit_usd: 5000 }) 성공
</verification>

<success_criteria>
- CUMUL-01: transactions 테이블에 amount_usd/reserved_amount_usd 컬럼 추가, DB v13 마이그레이션 성공
- CUMUL-02: evaluateAndReserve에서 usdAmount가 amount_usd/reserved_amount_usd로 기록됨
- CUMUL-03: SpendingLimitRulesSchema에 daily_limit_usd/monthly_limit_usd 필드 추가, Zod 검증 동작
- 모든 기존 테스트 통과 (regression 없음)
</success_criteria>

<output>
After completion, create `.planning/phases/136-cumulative-spending-engine/136-01-SUMMARY.md`
</output>
