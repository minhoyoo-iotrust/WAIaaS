---
phase: 237-admin-ui-token-limits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/components/policy-forms/spending-limit-form.tsx
  - packages/admin/src/components/policy-forms/index.tsx
  - packages/admin/src/pages/policies.tsx
autonomous: true
requirements: [ADMN-01, ADMN-02, ADMN-04, ADMN-06]

must_haves:
  truths:
    - "USD Tiers section renders at the top of the Spending Limit form"
    - "Token-Specific Limits section shows native token fields with correct symbol for the policy network"
    - "Native token symbol displays SOL for Solana networks, ETH for Ethereum/Arbitrum/Optimism/Base, POL for Polygon"
    - "Raw fields are not required when creating a new policy -- form can be submitted with USD or token_limits only"
    - "The network value is passed from the policy form context to SpendingLimitForm"
  artifacts:
    - path: "packages/admin/src/components/policy-forms/spending-limit-form.tsx"
      provides: "Restructured form with USD top, Token-Specific Limits with native token, Cumulative, Legacy, delay_seconds"
      min_lines: 120
    - path: "packages/admin/src/components/policy-forms/index.tsx"
      provides: "Extended PolicyFormProps with optional network field, PolicyFormRouter passes network"
      exports: ["PolicyFormProps", "PolicyFormRouter"]
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "Updated validateRules making raw fields optional, network passed to PolicyFormRouter"
      contains: "validateRules"
  key_links:
    - from: "packages/admin/src/pages/policies.tsx"
      to: "PolicyFormRouter"
      via: "network prop from formNetwork/editPolicy.network"
      pattern: "network=.*formNetwork|editPolicy.*network"
    - from: "packages/admin/src/components/policy-forms/index.tsx"
      to: "SpendingLimitForm"
      via: "network prop forwarding"
      pattern: "network.*network"
    - from: "packages/admin/src/components/policy-forms/spending-limit-form.tsx"
      to: "rules.token_limits"
      via: "onChange callback constructing token_limits record"
      pattern: "token_limits"
---

<objective>
Restructure SpendingLimitForm layout: USD Tiers at top, Token-Specific Limits section with native token editing, pass network to form for symbol display, and make raw fields optional in validation.

Purpose: ADMN-01 (USD top), ADMN-02 (native token limits), ADMN-04 (network-aware native symbol), ADMN-06 (raw optional)
Output: Restructured spending-limit-form.tsx, updated PolicyFormProps with network, updated validateRules
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/235-schema-zod-ssot/235-01-SUMMARY.md
@packages/admin/src/components/policy-forms/spending-limit-form.tsx
@packages/admin/src/components/policy-forms/index.tsx
@packages/admin/src/pages/policies.tsx
@packages/admin/src/components/form.tsx
@packages/admin/src/components/dynamic-row-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend PolicyFormProps with network + pass network through PolicyFormRouter and policies.tsx</name>
  <files>
    packages/admin/src/components/policy-forms/index.tsx
    packages/admin/src/pages/policies.tsx
  </files>
  <action>
1. In `packages/admin/src/components/policy-forms/index.tsx`:
   - Add `network?: string` to `PolicyFormProps` interface (optional so other forms are unaffected)
   - Update `PolicyFormRouter` function signature to accept `network` from the destructured props
   - Pass `network` to `SpendingLimitForm` in the SPENDING_LIMIT case: `<SpendingLimitForm rules={rules} onChange={onChange} errors={errors} network={network} />`

2. In `packages/admin/src/pages/policies.tsx`:
   - In the CREATE form section (around line 777), add `network={formNetwork.value}` to the `<PolicyFormRouter>` call
   - In the EDIT modal section (around line 859), add `network={editPolicy.value?.network ?? ''}` to the `<PolicyFormRouter>` call
   - The re-validate `onChange` callbacks already handle the rules object updates; no changes needed there

3. Update `validateRules` in `policies.tsx` for SPENDING_LIMIT case:
   - Remove the 3 mandatory checks for `instant_max`, `notify_max`, `delay_max` (lines 85-90)
   - Replace with: if any raw field IS provided, validate it (positive integer regex). But do NOT require them.
   - Add new validation: at least one of (raw fields, USD fields, or token_limits) must be present. If none, set `errors.__form = 'At least one of USD limits, token limits, or raw limits required'`
   - Validate token_limits entries if present: for each entry, instant_max/notify_max/delay_max must be valid non-negative decimal strings (regex `/^\d+(\.\d+)?$/`)
   - Keep existing delay_seconds, daily_limit_usd, monthly_limit_usd validation unchanged

4. Update `DEFAULT_RULES.SPENDING_LIMIT` in `policies.tsx`:
   - Remove `instant_max`, `notify_max`, `delay_max` from default rules (new policies should not require raw fields)
   - Keep `delay_seconds: 300` and `approval_timeout: 3600`
   - Result: `SPENDING_LIMIT: { delay_seconds: 300, approval_timeout: 3600 }`
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=admin` and confirm no type errors. Verify that PolicyFormProps now has `network?: string` and PolicyFormRouter passes it through.
  </verify>
  <done>PolicyFormProps has optional network field. PolicyFormRouter passes network to SpendingLimitForm. Both create and edit forms supply network value. validateRules no longer requires raw fields -- accepts USD-only or token_limits-only policies. DEFAULT_RULES.SPENDING_LIMIT has no raw fields.</done>
</task>

<task type="auto">
  <name>Task 2: Restructure SpendingLimitForm with USD top, native token limits, and network-aware symbol</name>
  <files>
    packages/admin/src/components/policy-forms/spending-limit-form.tsx
  </files>
  <action>
Rewrite `spending-limit-form.tsx` with the following section layout:

**Props:** Accept `{ rules, onChange, errors, network }` from PolicyFormProps (network is optional string).

**Helper: NETWORK_NATIVE_SYMBOL map** (inline constant in the file):
```typescript
const NETWORK_NATIVE_SYMBOL: Record<string, string> = {
  'mainnet': 'SOL', 'devnet': 'SOL', 'testnet': 'SOL',
  'ethereum-mainnet': 'ETH', 'ethereum-sepolia': 'ETH',
  'polygon-mainnet': 'POL', 'polygon-amoy': 'POL',
  'arbitrum-mainnet': 'ETH', 'arbitrum-sepolia': 'ETH',
  'optimism-mainnet': 'ETH', 'optimism-sepolia': 'ETH',
  'base-mainnet': 'ETH', 'base-sepolia': 'ETH',
};
```

**Helper function getNativeSymbol(network?: string):** Returns `NETWORK_NATIVE_SYMBOL[network]` or `'Native'` as fallback when network is empty/unknown.

**Helper: token_limits read/write:**
- Read: `const tokenLimits = (rules.token_limits as Record<string, { instant_max: string; notify_max: string; delay_max: string }>) || {}`
- Write: update `rules.token_limits` via `onChange({ ...rules, token_limits: { ...tokenLimits, [key]: updatedEntry } })`, and delete key when removing

**Section 1: "USD Amount Tiers"** (ADMN-01: render FIRST)
- h4: "USD Amount Tiers"
- 3 FormFields: instant_max_usd, notify_max_usd, delay_max_usd (same as current, type=number, optional, use handleUsdChange)

**Section 2: "Token-Specific Limits"** (ADMN-02, ADMN-04)
- h4: "Token-Specific Limits"
- Sub-heading: "Native Token ({symbol})" where symbol comes from getNativeSymbol(network)
- 3 FormFields for native token limits reading from `tokenLimits['native']`:
  - Label: "Instant Max ({symbol})" with name "native_instant_max"
  - Label: "Notify Max ({symbol})" with name "native_notify_max"
  - Label: "Delay Max ({symbol})" with name "native_delay_max"
  - type="text", placeholder="e.g. 0.5" (human-readable decimal)
  - Values read from tokenLimits['native']?.instant_max etc., default to ''
  - onChange: update the 'native' entry in token_limits. If all 3 fields are empty, delete the 'native' key from token_limits. If any field has a value, all 3 must be present in the token_limits record (set empty ones to '0').
- Description text under native fields: "Human-readable amounts (e.g., 0.5 SOL, not lamports/wei)"
- A placeholder `div` with comment `{/* CAIP-19 token rows injected by Plan 237-02 */}` where the "+ Add Token Limit" dynamic list will be added in plan 02

**Section 3: "Cumulative USD Limits (Optional)"**
- Same as current: daily_limit_usd, monthly_limit_usd (no changes)

**Section 4: "Legacy Raw Tiers (Deprecated)"** (ADMN-05 partial setup, ADMN-06)
- h4 containing: "Legacy Raw Tiers" + a span with class "badge badge-warning" containing "Deprecated"
- p description: "Raw tiers use lamports/wei units and apply uniformly to all tokens. Use USD Tiers or Token-Specific Limits instead."
- 3 FormFields: instant_max, notify_max, delay_max (same as current but NOT required -- remove `required` prop)
- Keep handleChange for these fields (string values)

**Section 5: delay_seconds** (same as current, required, min 60)

**Key implementation details:**
- handleUsdChange stays the same (delete key on empty)
- handleChange stays the same (string passthrough)
- New handleNativeTokenChange function:
  ```typescript
  const handleNativeTokenChange = (field: 'instant_max' | 'notify_max' | 'delay_max') => (v: string | number | boolean) => {
    const strVal = String(v);
    const current = tokenLimits['native'] || { instant_max: '', notify_max: '', delay_max: '' };
    const updated = { ...current, [field]: strVal };
    // If all empty, remove native entry
    if (!updated.instant_max && !updated.notify_max && !updated.delay_max) {
      const next = { ...tokenLimits };
      delete next['native'];
      onChange({ ...rules, token_limits: Object.keys(next).length > 0 ? next : undefined });
    } else {
      onChange({ ...rules, token_limits: { ...tokenLimits, native: updated } });
    }
  };
  ```
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=admin`. Visually verify by running `pnpm --filter admin dev` and navigating to Policies page, click "Create Policy" with SPENDING_LIMIT type:
1. USD Tiers section appears first
2. Token-Specific Limits section shows native token fields with symbol label
3. Cumulative USD section appears third
4. Legacy section shows deprecated badge
5. delay_seconds at bottom
6. Can create a policy with only USD fields (no raw fields needed)
  </verify>
  <done>
SpendingLimitForm renders 5 sections in order: USD Tiers (top), Token-Specific Limits (with native token and network-aware symbol), Cumulative USD, Legacy Raw (deprecated badge, optional fields), delay_seconds. Native symbol correctly shows SOL/ETH/POL based on policy network. Raw fields are optional -- form submits without them.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=admin` passes with no errors
2. `pnpm turbo run lint --filter=admin` passes
3. SpendingLimitForm renders USD section first (ADMN-01)
4. Native token section shows correct symbol per network (ADMN-04)
5. Raw fields section shows deprecated badge (ADMN-05 partial)
6. Policy can be created without raw fields (ADMN-06)
7. Native token limits write to rules.token_limits['native'] correctly (ADMN-02)
</verification>

<success_criteria>
- USD Tiers renders at top of SpendingLimitForm
- Token-Specific Limits section has native token fields with SOL/ETH/POL label based on network
- Legacy Raw Tiers section has deprecated warning and optional fields
- PolicyFormRouter passes network to SpendingLimitForm
- validateRules accepts policies without raw fields
- token_limits['native'] is correctly constructed from native token form fields
</success_criteria>

<output>
After completion, create `.planning/phases/237-admin-ui-token-limits/237-01-SUMMARY.md`
</output>
