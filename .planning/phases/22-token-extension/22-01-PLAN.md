---
phase: 22-token-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/56-token-transfer-extension-spec.md
autonomous: true

must_haves:
  truths:
    - "TransferRequest에 token? 필드가 정의되어 있고, undefined일 때 네이티브 전송으로 하위 호환된다"
    - "SolanaAdapter에서 SPL 토큰 전송 트랜잭션 빌드 로직이 Token Program/Token-2022 분기를 포함하여 바이트 수준까지 명세되어 있다"
    - "EvmAdapter에서 ERC-20 토큰 전송 트랜잭션 빌드 로직이 simulateContract + encodeFunctionData 기반으로 명세되어 있다"
    - "ALLOWED_TOKENS 정책 규칙이 에이전트별 토큰 화이트리스트를 검증하고, 미등록 토큰 전송을 거부하는 로직이 명세되어 있다"
    - "TOKEN_TRANSFER의 기본 보안 티어가 NOTIFY로 설정되어 있고, Phase 24 USD 정책 통합 전까지의 과도기 전략이 명세되어 있다"
    - "파이프라인 Stage 1의 token 필드 기반 분기와 서비스 레이어의 REST API -> TransferRequest 변환 로직이 명세되어 있다"
  artifacts:
    - path: "docs/56-token-transfer-extension-spec.md"
      provides: "CHAIN-EXT-01 토큰 전송 확장 스펙"
      contains: "TransferRequest, ALLOWED_TOKENS, buildSplTokenTransfer, buildErc20Transfer"
  key_links:
    - from: "docs/56-token-transfer-extension-spec.md"
      to: "docs/27-chain-adapter-interface.md"
      via: "TransferRequest.token 필드 확장, IChainAdapter 타입 변경"
    - from: "docs/56-token-transfer-extension-spec.md"
      to: "docs/33-time-lock-approval-mechanism.md"
      via: "ALLOWED_TOKENS PolicyType 추가, DatabasePolicyEngine 토큰 검증 로직"
    - from: "docs/56-token-transfer-extension-spec.md"
      to: "docs/31-solana-adapter-detail.md"
      via: "buildSplTokenTransfer 정식 스펙, Token-2022 분기"
    - from: "docs/56-token-transfer-extension-spec.md"
      to: "docs/37-rest-api-complete-spec.md"
      via: "POST /v1/transactions/send tokenMint 정식 지원, 서비스 레이어 매핑"
---

<objective>
SPL/ERC-20 토큰 전송을 지원하기 위한 IChainAdapter 타입 확장, 체인별 빌드 로직, ALLOWED_TOKENS 정책, 파이프라인 통합을 설계한다.

Purpose: 에이전트가 네이티브 토큰뿐 아니라 SPL/ERC-20 토큰을 전송할 수 있도록 하되, 에이전트별 허용 토큰 정책으로 보안을 유지한다. v0.2 예비 설계(buildSplTokenTransfer, TransferRequestSchema의 tokenMint)를 정식 스펙으로 승격하고, 누락된 EVM 빌드 로직과 ALLOWED_TOKENS 정책을 채운다.
Output: `docs/56-token-transfer-extension-spec.md` (CHAIN-EXT-01 산출물)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-token-extension/22-RESEARCH.md

# 핵심 참조 문서 (기존 설계)
@docs/27-chain-adapter-interface.md          -- IChainAdapter 13 메서드, TransferRequest, BalanceInfo
@docs/31-solana-adapter-detail.md            -- SolanaAdapter, buildSplTokenTransfer 예비 설계 (섹션 5.2)
@docs/36-killswitch-autostop-evm.md          -- EvmAdapterStub 13 메서드, viem 타입
@docs/33-time-lock-approval-mechanism.md     -- DatabasePolicyEngine, PolicyType 4개, PolicyRuleSchema
@docs/32-transaction-pipeline-api.md         -- 6-stage 파이프라인, Stage 1 type 분기
@docs/37-rest-api-complete-spec.md           -- TransferRequestSchema (type/tokenMint 이미 포함)
@docs/25-sqlite-schema.md                   -- policies 테이블, transactions.type
@docs/45-enum-unified-mapping.md             -- PolicyType, TransactionType Enum SSoT
</context>

<tasks>

<task type="auto">
  <name>Task 1: TransferRequest 타입 확장 + 체인별 빌드 로직 명세</name>
  <files>docs/56-token-transfer-extension-spec.md</files>
  <action>
`docs/56-token-transfer-extension-spec.md` 파일을 생성한다. 문서 ID: CHAIN-EXT-01. 전체 문서를 한글로 작성한다.

**섹션 1: 개요**
- 문서 목적, 범위 (Phase 22 TOKEN-01, TOKEN-02 커버리지), v0.2 예비 설계 승격 배경
- 핵심 원칙: 하위 호환 (token=undefined → 네이티브), IChainAdapter 저수준 유지, 정책 엔진 독립

**섹션 2: TransferRequest 타입 확장**
- 기존 TransferRequest (from/to/amount/memo?)에 `token?` 필드 추가
- `token` 타입 정의: `{ address: string, decimals: number, symbol: string }`
- `token: undefined` → 네이티브 전송 (기존 로직 무변경)
- `token: { address, decimals, symbol }` → 토큰 전송 (SPL/ERC-20)
- REST API의 `type`/`tokenMint` → TransferRequest.token 변환 로직 (서비스 레이어)
  - tokenMint → 토큰 메타데이터 조회 (decimals, symbol) → token 객체 구성
  - 메타데이터 조회 소스: Solana는 mint account, EVM은 readContract
- Zod 스키마: TransferRequestSchema (IChainAdapter 수준), TokenInfoSchema
- 기존 문서 변경 영향: 27-chain-adapter-interface.md 섹션 2.3 수정 대상

**섹션 3: Solana SPL 토큰 전송 빌드 로직**
- 31-solana-adapter-detail.md 섹션 5.2의 예비 설계를 정식 승격
- `buildSplTokenTransfer()` 전체 명세:
  1. mint account의 owner 필드로 Token Program vs Token-2022 판별
  2. `findAssociatedTokenPda()` -- 발신자/수신자 ATA 계산 (올바른 tokenProgram 전달)
  3. `getAccountInfo()` -- 수신자 ATA 존재 확인
  4. ATA 미존재 시 `getCreateAssociatedTokenAccountInstruction()` 선행
  5. `getTransferCheckedInstruction()` 사용 (decimals 검증 포함, getTransferInstruction보다 안전)
  6. Compute Unit 조정: SPL 전송은 ~450 CU (기본 200K CU limit 내)
- Token-2022 호환성 전략:
  - 기본 transfer: Token Program과 동일한 transferChecked instruction 사용 (tokenProgram만 다름)
  - TransferFee 확장: mint account에서 TransferFee extension 감지 → 감지 시 거부 (UNSUPPORTED_TOKEN_EXTENSION 에러)
  - ConfidentialTransfer 등 기타 확장: 동일하게 감지→거부
- `buildTransaction()` 분기 로직:
  - `if (request.token)` → `buildSplTokenTransfer()` 호출
  - `else` → 기존 `buildNativeTransfer()` (변경 없음)
- 에러 매핑: SPL 전송 특유 에러 코드 (INSUFFICIENT_TOKEN_BALANCE, ATA_CREATION_FAILED, UNSUPPORTED_TOKEN_EXTENSION, INVALID_TOKEN_MINT)
- 코드 수준 의사코드 (TypeScript, @solana/kit + @solana-program/token 기준)

**섹션 4: EVM ERC-20 토큰 전송 빌드 로직**
- 36-killswitch-autostop-evm.md의 EvmAdapterStub을 실 구현 수준으로 확장
- `buildErc20Transfer()` 전체 명세:
  1. ERC-20 표준 ABI 정의 (transfer, balanceOf, decimals, symbol)
  2. `simulateContract()` -- 전송 가능 여부 사전 검증 (USDT 비표준 대응)
  3. `encodeFunctionData()` -- calldata 인코딩
  4. `prepareTransactionRequest()` -- 트랜잭션 빌드 (to=컨트랙트, value=0n, data=calldata)
  5. gas 추정: `estimateGas()` (ERC-20 transfer ~65,000 gas vs 네이티브 ~21,000)
- `buildTransaction()` 분기 로직: Solana와 동일 패턴
- 에러 매핑: ERC-20 특유 에러 코드 (INSUFFICIENT_TOKEN_BALANCE, ERC20_TRANSFER_FAILED, SIMULATION_FAILED)
- 코드 수준 의사코드 (TypeScript, viem 기준)

**섹션 5: 파이프라인 통합**
- 6단계 파이프라인 구조 변경 없음 (핵심 원칙)
- Stage 1 (Build) type 분기 확장:
  - 서비스 레이어에서 REST API 요청 → TransferRequest 변환 시 token 객체 구성
  - `request.token` 유무로 buildTransaction 내부 분기
- Stage 2 (Simulate): 변경 없음 (SPL/ERC-20도 동일하게 시뮬레이션)
- Stage 3 (Policy): ALLOWED_TOKENS 검증 추가 (섹션 6에서 상세)
- transactions 테이블: type='TOKEN_TRANSFER' 사용 정식화
- REST API `POST /v1/transactions/send` 확장: tokenMint 필드 정식 지원 명세 (기존 스키마에 이미 존재)

**문서 양식:** 기존 docs/ 내 설계 문서와 동일한 마크다운 양식. 섹션 번호, TypeScript 의사코드, 표, Zod 스키마 포함.
  </action>
  <verify>
파일 존재 확인: `ls docs/56-token-transfer-extension-spec.md`
필수 키워드 존재 확인 (grep):
- "TransferRequest" + "token?" 필드 정의
- "buildSplTokenTransfer" 전체 명세
- "buildErc20Transfer" 전체 명세
- "Token-2022" 호환성 전략
- "TOKEN_TRANSFER" 파이프라인 통합
- 최소 5개 섹션 (개요, TransferRequest, Solana SPL, EVM ERC-20, 파이프라인)
  </verify>
  <done>
TransferRequest.token 필드가 정의되어 있고, Solana SPL (Token Program + Token-2022 분기) 및 EVM ERC-20 빌드 로직이 코드 수준 의사코드로 명세되어 있으며, 파이프라인 Stage 1-3 통합이 설계되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: ALLOWED_TOKENS 정책 + TOKEN_TRANSFER 보안 티어 명세</name>
  <files>docs/56-token-transfer-extension-spec.md</files>
  <action>
Task 1에서 생성한 `docs/56-token-transfer-extension-spec.md`에 다음 섹션을 추가한다.

**섹션 6: ALLOWED_TOKENS 정책 규칙**
- PolicyType Enum 확장: 기존 4개 + 'ALLOWED_TOKENS' = 5개
  - 기존: SPENDING_LIMIT, WHITELIST, TIME_RESTRICTION, RATE_LIMIT
  - 추가: ALLOWED_TOKENS
- ALLOWED_TOKENS vs WHITELIST 구분:
  - WHITELIST: 수신 주소 화이트리스트 (어디로 보낼 수 있는지)
  - ALLOWED_TOKENS: 토큰 종류 화이트리스트 (무엇을 보낼 수 있는지)
  - 직교하는 정책 -- 둘 다 적용 가능
- AllowedTokensRuleSchema (Zod):
  ```
  allowed_tokens: [{ address, symbol, decimals, chain }]
  allow_native: boolean (default: true)
  unknown_token_action: 'DENY' | 'WARN' (default: 'DENY')
  ```
- DatabasePolicyEngine 토큰 검증 로직 (Stage 3 확장):
  1. 토큰 전송 요청 수신 (request.token이 존재)
  2. 에이전트의 ALLOWED_TOKENS 정책 조회
  3. 정책 미설정 시: 네이티브만 허용 (토큰 전송 거부)
  4. 정책 설정 시: allowed_tokens 목록에서 address + chain 매칭
  5. 미등록 토큰: unknown_token_action에 따라 DENY 또는 WARN
  6. DENY → POLICY_VIOLATION 에러, WARN → 전송 허용 + 알림 발송
- 네이티브 전송과의 관계: request.token이 undefined면 ALLOWED_TOKENS 정책 적용 안 함 (하위 호환)
- policies 테이블 CHECK 제약 수정: type IN ('SPENDING_LIMIT', 'WHITELIST', 'TIME_RESTRICTION', 'RATE_LIMIT', 'ALLOWED_TOKENS')
- 45-enum-unified-mapping.md PolicyType 확장 명세

**섹션 7: TOKEN_TRANSFER 보안 티어 전략**
- v0.6 핵심 결정 반영: USD 기준 정책 평가는 Phase 24
- Phase 22-23 과도기 전략:
  - TOKEN_TRANSFER의 기본 티어: NOTIFY (INSTANT보다 한 단계 높은 안전 마진)
  - SPENDING_LIMIT은 TOKEN_TRANSFER에 적용하지 않음 (금액 비교 불가)
  - ALLOWED_TOKENS + WHITELIST + TIME_RESTRICTION + RATE_LIMIT만 적용
- Phase 24 통합 후:
  - IPriceOracle로 토큰 → USD 변환
  - USD 금액 기준으로 SPENDING_LIMIT 적용 (네이티브와 동일 티어 분류)
  - TOKEN_TRANSFER의 기본 티어 제거 (USD 기준 동적 분류)
- 보안 모델 다이어그램: 네이티브 전송 vs 토큰 전송의 정책 평가 경로 차이

**섹션 8: 에러 코드 통합**
- 기존 29-api-framework-design.md의 에러 코드 체계에 토큰 관련 에러 추가
- TOKEN 도메인 에러 코드 (TOKEN-xxx):
  - TOKEN-001: INVALID_TOKEN_MINT (유효하지 않은 토큰 민트/컨트랙트 주소)
  - TOKEN-002: INSUFFICIENT_TOKEN_BALANCE (토큰 잔액 부족)
  - TOKEN-003: TOKEN_NOT_ALLOWED (ALLOWED_TOKENS 정책 위반)
  - TOKEN-004: ATA_CREATION_FAILED (Solana ATA 생성 실패)
  - TOKEN-005: UNSUPPORTED_TOKEN_EXTENSION (Token-2022 확장 미지원)
  - TOKEN-006: ERC20_TRANSFER_FAILED (ERC-20 transfer 함수 실패)
  - TOKEN-007: ERC20_SIMULATION_FAILED (ERC-20 시뮬레이션 실패)
  - TOKEN-008: TOKEN_METADATA_FETCH_FAILED (토큰 메타데이터 조회 실패)

**섹션 9: 기존 문서 변경 요약**
- Phase 25에서 반영할 기존 문서 변경 목록 (이 문서로 인한 변경):
  - 27-chain-adapter-interface.md: TransferRequest.token, 에러 코드
  - 31-solana-adapter-detail.md: buildSplTokenTransfer 정식화, Token-2022
  - 36-killswitch-autostop-evm.md: buildErc20Transfer 실 구현 노트
  - 33-time-lock-approval-mechanism.md: ALLOWED_TOKENS PolicyType, 검증 로직
  - 25-sqlite-schema.md: policies CHECK 제약
  - 37-rest-api-complete-spec.md: tokenMint 정식 지원
  - 45-enum-unified-mapping.md: PolicyType 확장
  - 32-transaction-pipeline-api.md: Stage 1 분기, Stage 3 토큰 검증
- 각 변경에 대해 "무엇을, 어디서, 왜" 형태로 요약 (Phase 25 실행자가 바로 반영 가능하도록)

**문서 총량 목표:** ~800-1200줄 (기존 v0.2 설계 문서 수준)
  </action>
  <verify>
필수 키워드 존재 확인 (grep):
- "ALLOWED_TOKENS" 정책 규칙 정의
- "AllowedTokensRuleSchema" Zod 스키마
- "DatabasePolicyEngine" 토큰 검증 로직
- "NOTIFY" 기본 티어
- "TOKEN-001" ~ "TOKEN-008" 에러 코드
- 기존 문서 변경 요약 테이블
- 최소 9개 섹션 완성
  </verify>
  <done>
ALLOWED_TOKENS 정책 규칙이 Zod 스키마와 DatabasePolicyEngine 검증 로직으로 명세되어 있고, TOKEN_TRANSFER의 기본 NOTIFY 티어 전략이 Phase 24 통합 계획과 함께 명세되어 있으며, 에러 코드 8개와 기존 문서 변경 요약이 포함되어 있다.
  </done>
</task>

</tasks>

<verification>
1. `docs/56-token-transfer-extension-spec.md` 파일이 존재하고 9개 섹션을 포함한다
2. TOKEN-01 커버리지: TransferRequest.token 필드 정의 + undefined 하위 호환
3. TOKEN-02 커버리지: ALLOWED_TOKENS 정책 규칙 + DatabasePolicyEngine 검증 로직 + 미등록 토큰 거부
4. Solana SPL 빌드 로직이 Token Program + Token-2022 분기를 포함한다
5. EVM ERC-20 빌드 로직이 simulateContract + encodeFunctionData 기반이다
6. 파이프라인 통합이 6단계 구조 변경 없이 기존 위에 적층된다
7. 기존 문서 변경 요약이 Phase 25 실행자를 위해 명세되어 있다
</verification>

<success_criteria>
- docs/56-token-transfer-extension-spec.md가 CHAIN-EXT-01 산출물로서 완성
- TOKEN-01 (TransferRequest.token), TOKEN-02 (ALLOWED_TOKENS) 요구사항 충족
- SPL/ERC-20 빌드 로직이 바이트 수준 의사코드로 명세
- 정책 평가 경로가 네이티브/토큰 분기로 명확히 구분
</success_criteria>

<output>
After completion, create `.planning/phases/22-token-extension/22-01-SUMMARY.md`
</output>
