---
phase: 22-token-extension
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/57-asset-query-fee-estimation-spec.md
autonomous: true

must_haves:
  truths:
    - "getAssets()가 IChainAdapter의 14번째 메서드로 정의되어 있고, AssetInfo 스키마가 네이티브/SPL/ERC-20 토큰을 모두 표현한다"
    - "Solana getAssets() 구현이 getBalance + getTokenAccountsByOwner (Token Program + Token-2022) 기반으로 명세되어 있다"
    - "EVM getAssets() 구현이 ALLOWED_TOKENS 기반 보수적 조회로 명세되어 있고, 외부 인덱서 의존이 없다"
    - "REST API GET /v1/wallet/assets 엔드포인트가 응답 스키마와 함께 명세되어 있다"
    - "Solana SPL 수수료 추정이 ATA 생성 비용(동적 조회)과 Compute Unit 증가를 포함한다"
    - "EVM ERC-20 수수료 추정이 estimateGas() + estimateFeesPerGas() 기반으로 명세되어 있다"
    - "SPL/ERC-20 토큰 전송의 테스트 레벨, Mock 경계, 보안 시나리오가 정의되어 있다"
  artifacts:
    - path: "docs/57-asset-query-fee-estimation-spec.md"
      provides: "CHAIN-EXT-02 자산 조회 + 수수료 추정 스펙"
      contains: "getAssets, AssetInfo, estimateFee, GET /v1/wallet/assets, 테스트 시나리오"
  key_links:
    - from: "docs/57-asset-query-fee-estimation-spec.md"
      to: "docs/27-chain-adapter-interface.md"
      via: "getAssets() 14번째 메서드 복원, AssetInfo 타입 추가"
    - from: "docs/57-asset-query-fee-estimation-spec.md"
      to: "docs/31-solana-adapter-detail.md"
      via: "getAssets() Solana 구현, estimateFee ATA 비용 포함"
    - from: "docs/57-asset-query-fee-estimation-spec.md"
      to: "docs/37-rest-api-complete-spec.md"
      via: "GET /v1/wallet/assets 엔드포인트 추가"
    - from: "docs/57-asset-query-fee-estimation-spec.md"
      to: "docs/56-token-transfer-extension-spec.md"
      via: "ALLOWED_TOKENS 정책 기반 EVM 토큰 조회, TransferRequest.token 참조"
---

<objective>
에이전트 보유 자산 조회(getAssets), 토큰 전송 수수료 추정(estimateFee 확장), 토큰 전송 테스트 시나리오를 설계한다.

Purpose: 에이전트가 보유한 모든 토큰(네이티브 + SPL/ERC-20)을 조회하고, 토큰 전송 전 정확한 수수료를 예측할 수 있도록 한다. 또한 SPL/ERC-20 토큰 전송의 테스트 전략을 정의하여 Phase 25 통합 테스트의 기초를 놓는다.
Output: `docs/57-asset-query-fee-estimation-spec.md` (CHAIN-EXT-02 산출물)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-token-extension/22-RESEARCH.md

# 핵심 참조 문서 (기존 설계)
@docs/27-chain-adapter-interface.md          -- IChainAdapter 13 메서드, BalanceInfo
@docs/31-solana-adapter-detail.md            -- SolanaAdapter, estimateFee 현재 설계
@docs/36-killswitch-autostop-evm.md          -- EvmAdapterStub, estimateFee stub
@docs/37-rest-api-complete-spec.md           -- 31 endpoints, v0.3 확장으로 GET /v1/wallet/tokens 예약
@docs/41-test-architecture-coverage-spec.md  -- v0.4 테스트 프레임워크, 6 test levels, Mock 경계
@docs/42-security-scenario-test-spec.md      -- 71 보안 시나리오, 3-layer security
@docs/43-solana-test-environment-spec.md     -- Solana 3-stage 테스트 환경

# 22-01 산출물 (병렬 실행이지만 독립 참조 가능)
# 참고: 22-01과 병렬 실행되므로 22-01 산출물이 아직 없을 수 있다.
# 이 경우 22-RESEARCH.md의 TransferRequest.token, ALLOWED_TOKENS 정의를 참조한다.
</context>

<tasks>

<task type="auto">
  <name>Task 1: getAssets() 인터페이스 + 체인별 구현 + REST API 설계</name>
  <files>docs/57-asset-query-fee-estimation-spec.md</files>
  <action>
`docs/57-asset-query-fee-estimation-spec.md` 파일을 생성한다. 문서 ID: CHAIN-EXT-02. 전체 문서를 한글로 작성한다.

**섹션 1: 개요**
- 문서 목적, 범위 (Phase 22 TOKEN-03, TOKEN-04, TOKEN-05 커버리지)
- v0.1에서 제거된 getAssets() 복원 배경 (27-chain-adapter-interface.md 1.1절 "v0.3 이연")
- 핵심 원칙: Self-Hosted 원칙 (외부 인덱서 의존 최소화), ALLOWED_TOKENS 기반 보수적 조회

**섹션 2: AssetInfo 스키마**
- AssetInfo 인터페이스 정의:
  ```typescript
  interface AssetInfo {
    tokenAddress: string   // 토큰 민트/컨트랙트 주소. 네이티브면 'native'
    symbol: string         // 토큰 심볼 (예: SOL, USDC, ETH)
    name: string           // 토큰 이름 (예: Solana, USD Coin)
    decimals: number       // 소수점 자릿수
    balance: bigint        // 잔액 (최소 단위)
    logoUri?: string       // 로고 URI (선택)
    type: 'native' | 'spl' | 'erc20'  // 토큰 유형
  }
  ```
- AssetInfoSchema (Zod): REST API 응답용
  - balance를 string으로 직렬화 (bigint JSON 미지원)
  - type을 z.enum(['native', 'spl', 'erc20'])으로
- v0.1 Asset 타입과의 차이점 대조표:
  - v0.1: `{ identifier: AssetIdentifier, balance: Balance }` → v0.2 패턴에 맞게 flat 구조로
  - tokenAddress가 v0.1의 AssetIdentifier.contractAddress + tokenId를 대체

**섹션 3: IChainAdapter.getAssets() 인터페이스**
- 14번째 메서드 시그니처: `getAssets(address: string): Promise<AssetInfo[]>`
- 반환 순서: 네이티브 토큰 첫 번째, 이후 토큰 잔액 내림차순
- 에러 처리: RPC 실패 시 빈 배열이 아닌 에러 throw (일부 토큰 조회 실패는 해당 항목 skip + 경고 로그)
- EvmAdapterStub: getAssets() 추가 (all throw CHAIN_NOT_SUPPORTED → 실 구현 시 ALLOWED_TOKENS 기반)

**섹션 4: Solana getAssets() 구현 설계**
- 구현 알고리즘:
  1. `getBalance(address)` → 네이티브 SOL AssetInfo
  2. `rpc.getTokenAccountsByOwner(address, { programId: TOKEN_PROGRAM_ID }, { encoding: 'jsonParsed' })` → SPL 토큰 계정
  3. `rpc.getTokenAccountsByOwner(address, { programId: TOKEN_2022_PROGRAM_ID }, { encoding: 'jsonParsed' })` → Token-2022 토큰 계정
  4. 각 토큰 계정에서 mint, amount, decimals 추출 (jsonParsed 인코딩 활용)
  5. 잔액 0인 토큰 계정은 제외 (close되지 않은 빈 ATA)
  6. 토큰 메타데이터(symbol, name): mint address에서 Metaplex Token Metadata 조회 또는 로컬 레지스트리 fallback
- 토큰 메타데이터 전략:
  - (1순위) known_tokens 로컬 레지스트리 (config.toml [tokens.solana] 섹션) → RPC 호출 0회
  - (2순위) Metaplex Token Metadata Program 조회 → 1 RPC 호출/토큰
  - (3순위) 미확인 토큰: symbol='UNKNOWN', name='Unknown Token ({mint 주소 앞 8자})'
- 성능 고려: getTokenAccountsByOwner는 단일 RPC 호출로 모든 토큰 계정 반환 (효율적)
- 코드 수준 의사코드 (TypeScript, @solana/kit 기준)

**섹션 5: EVM getAssets() 구현 설계**
- ALLOWED_TOKENS 기반 보수적 조회 (Self-Hosted 원칙):
  1. `getBalance(address)` → 네이티브 ETH AssetInfo
  2. ALLOWED_TOKENS 정책에서 해당 에이전트의 EVM 토큰 목록 로드
  3. 각 토큰에 대해 `readContract({ functionName: 'balanceOf', args: [address] })` 호출
  4. 잔액 > 0인 토큰만 결과에 포함
  5. multicall 최적화: `publicClient.multicall()` 으로 N개 토큰 잔액을 1 RPC 호출로 조회
- known_tokens 레지스트리 (config.toml [tokens.ethereum] 섹션):
  - 기본 포함: USDC, USDT, WETH, DAI (메이저 토큰)
  - 사용자 추가 가능
  - ALLOWED_TOKENS 미설정 시 known_tokens만 조회
- 외부 인덱서 선택적 지원 (향후 확장):
  - 설계 수준에서 ITokenDiscovery 인터페이스 정의 (getAssets에서 사용)
  - 기본 구현: AllowedTokensDiscovery (ALLOWED_TOKENS 기반)
  - 향후: AlchemyDiscovery, MoralisDiscovery (외부 인덱서 플러그인)
- 코드 수준 의사코드 (TypeScript, viem 기준)

**섹션 6: REST API 엔드포인트**
- `GET /v1/wallet/assets` 엔드포인트 설계:
  - Path: GET /v1/wallet/assets
  - Auth: sessionAuth 필수
  - Query params: chain? (필터링), include_zero? (기본 false)
  - Response 200:
    ```json
    {
      "assets": [
        { "tokenAddress": "native", "symbol": "SOL", "name": "Solana", "decimals": 9, "balance": "1500000000", "type": "native" },
        { "tokenAddress": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v", "symbol": "USDC", "name": "USD Coin", "decimals": 6, "balance": "50000000", "type": "spl" }
      ],
      "chain": "solana",
      "timestamp": "2026-02-07T12:00:00Z"
    }
    ```
  - Response Zod 스키마: AssetsResponseSchema
  - 에러: 401 UNAUTHORIZED, 500 RPC_ERROR
- 37-rest-api-complete-spec.md 변경: 기존 v0.3 예약 `GET /v1/wallet/tokens` → `GET /v1/wallet/assets`로 확정 (tokens보다 assets가 네이티브+토큰 모두 포괄)

**문서 양식:** 기존 docs/ 내 설계 문서와 동일한 마크다운 양식.
  </action>
  <verify>
파일 존재 확인: `ls docs/57-asset-query-fee-estimation-spec.md`
필수 키워드 존재 확인 (grep):
- "AssetInfo" 인터페이스 정의
- "getAssets" 메서드 시그니처
- "getTokenAccountsByOwner" Solana 구현
- "ALLOWED_TOKENS 기반" EVM 구현
- "GET /v1/wallet/assets" REST API
- "multicall" 최적화
- 최소 6개 섹션 (개요, AssetInfo, getAssets 인터페이스, Solana, EVM, REST API)
  </verify>
  <done>
getAssets()가 IChainAdapter 14번째 메서드로 정의되어 있고, Solana (Token Program + Token-2022 조회) 및 EVM (ALLOWED_TOKENS 기반 보수적 조회 + multicall 최적화) 구현이 명세되어 있으며, GET /v1/wallet/assets REST API가 응답 스키마와 함께 설계되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 수수료 추정 확장 + 테스트 시나리오 정의</name>
  <files>docs/57-asset-query-fee-estimation-spec.md</files>
  <action>
Task 1에서 생성한 `docs/57-asset-query-fee-estimation-spec.md`에 다음 섹션을 추가한다.

**섹션 7: 토큰 전송 수수료 추정 확장**
- 기존 estimateFee() 인터페이스 확장 (변경 최소화):
  - 기존: `estimateFee(request: TransferRequest): Promise<FeeEstimate>`
  - FeeEstimate 확장:
    ```typescript
    interface FeeEstimate {
      baseFee: bigint          // 기본 수수료 (lamports/wei)
      priorityFee: bigint      // 우선순위 수수료
      total: bigint            // baseFee + priorityFee + ataCreationCost
      /** 토큰 전송 시에만 존재 */
      ataCreationCost?: bigint // Solana ATA 생성 비용 (수신자 ATA 미존재 시)
      /** 수수료 통화 */
      feeCurrency: 'SOL' | 'ETH'  // 수수료는 항상 네이티브 토큰으로 지불
    }
    ```
- Solana SPL 수수료 추정 상세:
  1. 기본 수수료: 5,000 lamports (서명 1개 기준)
  2. 우선순위 수수료: `getRecentPrioritizationFees()` RPC 중앙값 기반
  3. ATA 생성 비용: 수신자 ATA 미존재 시 `getMinimumBalanceForRentExemption(165)` RPC 조회 (현재 ~2,039,280 lamports, 동적)
  4. 발신자 ATA: 이미 존재한다고 가정 (토큰 보유 중이므로)
  5. Compute Unit: SPL 전송 ~450 CU (기본 200K limit 내, 추가 비용 없음)
  6. 총 수수료: baseFee + priorityFee + ataCreationCost
  7. SOL 잔액 부족 시: INSUFFICIENT_BALANCE 에러에 "SOL needed for token transfer fee" 명시
- EVM ERC-20 수수료 추정 상세:
  1. Gas 추정: `estimateGas({ to: contractAddress, data: transferCalldata, account: from })`
     - ERC-20 transfer: ~65,000 gas (네이티브 21,000 대비 3x)
     - 일부 토큰 (USDT 등): ~100,000 gas (비표준 구현)
  2. Fee Per Gas: `estimateFeesPerGas()` → maxFeePerGas, maxPriorityFeePerGas (EIP-1559)
  3. 총 수수료: gasLimit * maxFeePerGas (wei)
  4. feeCurrency: 'ETH' (ERC-20 전송 수수료는 ETH로 지불)
- 수수료 비교 테이블 (네이티브 vs 토큰):
  | | Solana 네이티브 | Solana SPL | EVM 네이티브 | EVM ERC-20 |
  |---|---|---|---|---|
  | 기본 수수료 | 5,000 lam | 5,000 lam | ~21K gas | ~65K gas |
  | ATA 비용 | N/A | 0 or ~2M lam | N/A | N/A |
  | 수수료 통화 | SOL | SOL | ETH | ETH |

**섹션 8: 토큰 전송 테스트 시나리오 (TOKEN-05)**
- v0.4 테스트 프레임워크 (41-test-architecture-coverage-spec.md) 기반 확장
- 테스트 레벨별 시나리오:

  **Level 1: Unit Tests (Mock 의존성)**
  - TransferRequest.token 파싱: 유효한 토큰 필드, undefined 하위 호환, 잘못된 주소 형식
  - ALLOWED_TOKENS 정책 검증: 허용 토큰, 미등록 토큰 거부, 정책 미설정 시 기본 동작
  - AllowedTokensRuleSchema Zod 검증: 유효/무효 rules JSON
  - FeeEstimate 계산: ATA 생성 포함/미포함, ERC-20 gas 추정
  - AssetInfo 직렬화: bigint → string 변환, type enum 검증

  **Level 2: Integration Tests (Local DB + Mock RPC)**
  - SPL 토큰 전송 파이프라인: Mock SolanaAdapter → buildSplTokenTransfer → 성공/실패
  - ERC-20 토큰 전송 파이프라인: Mock EvmAdapter → buildErc20Transfer → 성공/실패
  - ALLOWED_TOKENS 정책 DB 라운드트립: 정책 생성 → 검증 → 정책 변경 → 재검증
  - getAssets() 통합: Mock RPC → AssetInfo 목록 → REST API 응답

  **Level 3: Solana Validator Tests (solana-test-validator)**
  - SPL 토큰 민팅 → ATA 생성 → 전송 → 잔액 확인
  - Token-2022 토큰 전송 (기본 transfer)
  - ATA 미존재 수신자로 전송 (ATA 자동 생성 확인)
  - 잔액 부족 전송 시도 → 에러 확인

  **Level 4: EVM Local Tests (Hardhat/Anvil)**
  - ERC-20 배포 → transfer → balanceOf 확인
  - USDT-like 비표준 ERC-20 transfer 시뮬레이션
  - gas 추정 정확도 (estimateGas vs 실제 gas used)
  - 잔액 부족 시뮬레이션 실패 확인

  **보안 시나리오 (42-security-scenario-test-spec.md 확장):**
  - SEC-TOKEN-01: 미등록 토큰 전송 시도 → ALLOWED_TOKENS 정책 거부
  - SEC-TOKEN-02: 악성 토큰 민트/컨트랙트 주소 → 검증 실패
  - SEC-TOKEN-03: Token-2022 TransferFee 확장 토큰 → 감지 후 거부
  - SEC-TOKEN-04: ERC-20 approve 위장 (transfer 함수 시그니처 조작) → 시뮬레이션에서 감지
  - SEC-TOKEN-05: SOL/ETH 잔액 0에서 토큰 전송 시도 → 수수료 부족 사전 차단
  - SEC-TOKEN-06: decimals 불일치 공격 (잘못된 decimals로 전송 시도) → transferChecked에서 거부
  - SEC-TOKEN-07: 매우 큰 토큰 금액 전송 (uint256 최대값) → overflow 방지
  - SEC-TOKEN-08: 동일 주소로 자기 전송 → 정책 또는 어댑터에서 감지

- Mock 경계 정의:
  - MockSolanaRpc: getTokenAccountsByOwner, getAccountInfo (ATA 확인), getMinimumBalanceForRentExemption
  - MockEvmClient: readContract (balanceOf, decimals, symbol), simulateContract, estimateGas
  - MockPolicyEngine: ALLOWED_TOKENS 정책 반환 (허용/거부/미설정)

**섹션 9: 기존 문서 변경 요약**
- Phase 25에서 반영할 기존 문서 변경 목록 (이 문서로 인한 변경):
  - 27-chain-adapter-interface.md: getAssets() 14번째 메서드, AssetInfo 타입, FeeEstimate 확장
  - 31-solana-adapter-detail.md: getAssets() Solana 구현, estimateFee ATA 비용
  - 36-killswitch-autostop-evm.md: getAssets() stub, estimateFee ERC-20 gas
  - 37-rest-api-complete-spec.md: GET /v1/wallet/assets 엔드포인트
  - 41-test-architecture-coverage-spec.md: Mock 경계 추가 (MockSolanaRpc SPL, MockEvmClient ERC-20)
  - 42-security-scenario-test-spec.md: SEC-TOKEN-01~08 보안 시나리오
  - 43-solana-test-environment-spec.md: SPL 토큰 테스트 시나리오 (validator)

**문서 총량 목표:** ~700-1000줄
  </action>
  <verify>
필수 키워드 존재 확인 (grep):
- "FeeEstimate" 확장 인터페이스
- "ataCreationCost" 필드
- "getMinimumBalanceForRentExemption" 동적 조회
- "estimateGas" EVM ERC-20
- "SEC-TOKEN-01" ~ "SEC-TOKEN-08" 보안 시나리오
- "MockSolanaRpc", "MockEvmClient" Mock 경계
- "Level 1" ~ "Level 4" 테스트 레벨
- 총 9개 섹션 완성
  </verify>
  <done>
FeeEstimate가 ATA 생성 비용과 ERC-20 gas 추정을 포함하도록 확장되어 있고, 테스트 레벨 4개 + 보안 시나리오 8개 + Mock 경계 3개가 정의되어 있으며, 기존 문서 변경 요약이 포함되어 있다.
  </done>
</task>

</tasks>

<verification>
1. `docs/57-asset-query-fee-estimation-spec.md` 파일이 존재하고 9개 섹션을 포함한다
2. TOKEN-03 커버리지: getAssets() 인터페이스 + AssetInfo 스키마 + Solana/EVM 구현
3. TOKEN-04 커버리지: estimateFee 확장 (ATA 비용 동적, ERC-20 gas)
4. TOKEN-05 커버리지: 테스트 레벨 4개, 보안 시나리오 8개, Mock 경계 3개
5. REST API GET /v1/wallet/assets가 응답 스키마와 함께 명세되어 있다
6. EVM getAssets()가 외부 인덱서 없이 ALLOWED_TOKENS 기반으로 동작한다
7. 기존 문서 변경 요약이 Phase 25 실행자를 위해 명세되어 있다
</verification>

<success_criteria>
- docs/57-asset-query-fee-estimation-spec.md가 CHAIN-EXT-02 산출물로서 완성
- TOKEN-03 (getAssets), TOKEN-04 (수수료 추정), TOKEN-05 (테스트 시나리오) 요구사항 충족
- Solana/EVM 자산 조회가 Self-Hosted 원칙에 부합 (외부 인덱서 의존 없음)
- 테스트 시나리오가 v0.4 프레임워크와 일관된 구조
</success_criteria>

<output>
After completion, create `.planning/phases/22-token-extension/22-02-SUMMARY.md`
</output>
