---
phase: 121-mcp-stability
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/index.ts
  - packages/mcp/src/__tests__/shutdown.test.ts
autonomous: true

must_haves:
  truths:
    - "Claude Desktop 종료 시 stdin이 닫히면 MCP 서버가 5초 내 자동 종료된다"
    - "SIGTERM 수신 시 3초 타임아웃 후 process.exit(0)으로 강제 종료된다"
    - "shutdown()이 여러 번 호출되어도 에러 없이 한 번만 실행된다"
  artifacts:
    - path: "packages/mcp/src/index.ts"
      provides: "MCP graceful shutdown + stdin 감지"
      contains: "process.stdin.on"
    - path: "packages/mcp/src/__tests__/shutdown.test.ts"
      provides: "shutdown 동작 테스트"
      contains: "describe.*shutdown"
  key_links:
    - from: "packages/mcp/src/index.ts"
      to: "process.stdin"
      via: "end/close event listener"
      pattern: "process\\.stdin\\.on\\(['\"](?:end|close)"
    - from: "packages/mcp/src/index.ts"
      to: "process.exit"
      via: "setTimeout force exit"
      pattern: "setTimeout.*process\\.exit"
---

<objective>
MCP 서버 프로세스가 클라이언트 종료 시 고아로 잔류하지 않도록 graceful shutdown + stdin 종료 감지를 구현한다.

Purpose: Claude Desktop 종료 시 MCP 서버가 고아 프로세스로 남아 메모리를 점유하는 BUG-020 해결. stdio transport 기반 MCP 프로토콜에서 클라이언트 연결 해제를 안정적으로 감지하여 자체 종료한다.

Output: 수정된 `packages/mcp/src/index.ts` + `packages/mcp/src/__tests__/shutdown.test.ts`
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/mcp/src/index.ts
@packages/mcp/src/session-manager.ts
@packages/mcp/src/__tests__/server.test.ts
@objectives/issues/v1.4.5-020-mcp-orphan-process-on-client-exit.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD — shutdown 동작 테스트 + 구현</name>
  <files>
    packages/mcp/src/__tests__/shutdown.test.ts
    packages/mcp/src/index.ts
  </files>
  <action>
**RED phase: `packages/mcp/src/__tests__/shutdown.test.ts` 테스트 파일 생성**

`packages/mcp/src/index.ts`의 shutdown 로직을 테스트하는 유닛 테스트를 작성한다. index.ts의 `main()` 함수를 직접 테스트하는 것이 아니라, shutdown 로직을 `createShutdownHandler()` 팩토리로 추출하여 테스트 가능하게 만든다.

**1단계: index.ts에서 shutdown 로직 추출 — `createShutdownHandler()` 함수**

`packages/mcp/src/index.ts`에서 shutdown 관련 로직을 export 가능한 함수로 추출한다:

```typescript
export interface ShutdownDeps {
  sessionManager: { dispose(): void };
  server: { close(): Promise<void> };
  exit?: (code: number) => void;  // DI for testing, default process.exit
}

/**
 * Create an idempotent shutdown handler with force-exit timeout.
 * MCPS-02: 3s timeout for graceful shutdown.
 * MCPS-03: Multiple calls are safe (once guard).
 */
export function createShutdownHandler(
  deps: ShutdownDeps,
  opts: { forceTimeoutMs?: number } = {},
): () => void {
  const forceTimeout = opts.forceTimeoutMs ?? 3_000;
  const exitFn = deps.exit ?? process.exit;
  let shuttingDown = false;

  return () => {
    if (shuttingDown) return;  // MCPS-03: idempotent
    shuttingDown = true;
    console.error('[waiaas-mcp] shutting down');
    deps.sessionManager.dispose();
    void deps.server.close();
    // MCPS-02: force exit after timeout
    setTimeout(() => {
      console.error('[waiaas-mcp] force exit after timeout');
      exitFn(0);
    }, forceTimeout).unref();
  };
}
```

**2단계: stdin 종료 감지 + 시그널 핸들러 등록 — `registerShutdownListeners()`**

```typescript
/**
 * Register stdin close + signal handlers for graceful shutdown.
 * MCPS-01: stdin end/close -> shutdown within 5s.
 * MCPS-02: SIGTERM -> shutdown with 3s force timeout.
 */
export function registerShutdownListeners(shutdown: () => void): void {
  process.stdin.on('end', () => {
    console.error('[waiaas-mcp] stdin closed (client disconnected), shutting down');
    shutdown();
  });
  // 'close' fires after 'end' in some edge cases (e.g., pipe broken)
  process.stdin.on('close', () => {
    console.error('[waiaas-mcp] stdin close event, shutting down');
    shutdown();
  });
  process.on('SIGTERM', () => {
    console.error('[waiaas-mcp] SIGTERM received');
    shutdown();
  });
  process.on('SIGINT', () => {
    shutdown();
  });
}
```

**3단계: main() 함수 리팩터링**

기존 inline SIGTERM/SIGINT 핸들러를 제거하고 `createShutdownHandler()` + `registerShutdownListeners()`를 사용한다:

```typescript
async function main(): Promise<void> {
  // ... (기존 sessionManager, apiClient, server, transport 생성 코드 유지)

  const shutdown = createShutdownHandler({ sessionManager, server });
  registerShutdownListeners(shutdown);

  await server.connect(transport);
  console.error('[waiaas-mcp] Server started on stdio transport');
  await sessionManager.start();
}
```

**테스트 케이스 (`shutdown.test.ts`):**

(a) `createShutdownHandler` 테스트:
- `shutdown()` 호출 시 `sessionManager.dispose()`와 `server.close()`가 호출된다
- `shutdown()` 호출 후 `forceTimeoutMs` 이후 `exit(0)`이 호출된다 (vi.useFakeTimers + vi.advanceTimersByTime)
- `shutdown()` 두 번 호출 시 `dispose()`가 한 번만 호출된다 (MCPS-03)

(b) `registerShutdownListeners` 테스트:
- `process.stdin` emit 'end' → shutdown 콜백이 호출된다
- `process.stdin` emit 'close' → shutdown 콜백이 호출된다
- NOTE: process.on('SIGTERM') 테스트는 프로세스 종료 위험이 있어 source code assertion으로 대체 (server.test.ts BUG-011 패턴 참조)

(c) 통합 소스 검증:
- index.ts 소스에 `registerShutdownListeners`가 포함되어 있다
- index.ts 소스에 `createShutdownHandler`가 포함되어 있다
- index.ts 소스에 기존 inline `process.on('SIGTERM'` 패턴이 없다

**GREEN phase:** 위 추출 및 리팩터링 구현. 모든 테스트 통과 확인.

**REFACTOR phase:** 불필요한 코드 제거, 주석 정리.

중요 제약:
- `console.error` 만 사용 (stdout은 stdio JSON-RPC 전용, SMGI-D04)
- `setTimeout().unref()` 사용하여 타이머가 프로세스 종료를 차단하지 않도록
- `server.connect(transport)` 이전에 shutdown 핸들러 등록 (stdin이 즉시 닫힐 수 있음)
- 기존 `server.connect()` → `sessionManager.start()` 순서 유지 (BUG-011)
  </action>
  <verify>
```bash
cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/mcp/src/__tests__/shutdown.test.ts --reporter=verbose
cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/mcp/src/__tests__/server.test.ts --reporter=verbose
```

기존 MCP 테스트도 회귀 확인:
```bash
cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/mcp --reporter=verbose
```
  </verify>
  <done>
- createShutdownHandler()가 idempotent하게 동작하고 forceTimeout 후 exit 호출
- registerShutdownListeners()가 stdin end/close + SIGTERM/SIGINT에 shutdown 콜백 등록
- shutdown 두 번 호출 시 dispose() 한 번만 실행 (MCPS-03)
- index.ts에 기존 inline 시그널 핸들러 제거되고 새 함수 사용
- 기존 MCP 테스트 전체 통과 (회귀 없음)
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/mcp` — 전체 MCP 패키지 테스트 통과
2. shutdown.test.ts에서 MCPS-01(stdin 감지), MCPS-02(force timeout), MCPS-03(중복 호출 안전) 검증
3. index.ts 소스에 `registerShutdownListeners` + `createShutdownHandler` 존재, 기존 inline SIGTERM/SIGINT 핸들러 없음
4. server.test.ts BUG-011 init order 테스트 통과 (회귀 없음)
</verification>

<success_criteria>
- [ ] stdin end/close 이벤트 발생 시 shutdown() 호출 확인 (MCPS-01)
- [ ] shutdown() 호출 시 3초 후 process.exit(0) 강제 종료 확인 (MCPS-02)
- [ ] shutdown() 중복 호출 시 dispose() 1회만 실행 확인 (MCPS-03)
- [ ] 기존 MCP 테스트 전체 통과 (회귀 없음)
- [ ] index.ts에서 createShutdownHandler + registerShutdownListeners 사용
</success_criteria>

<output>
After completion, create `.planning/phases/121-mcp-stability/121-01-SUMMARY.md`
</output>
