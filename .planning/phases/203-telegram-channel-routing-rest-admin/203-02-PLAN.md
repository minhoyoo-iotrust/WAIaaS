---
phase: 203-telegram-channel-routing-rest-admin
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/wallets.ts
  - packages/daemon/src/__tests__/wallets-api.test.ts
autonomous: true
requirements: [WALLET-04, WALLET-05]

must_haves:
  truths:
    - "PUT /v1/wallets/:id/owner request can include optional approval_method field"
    - "Valid approval_method values (sdk_ntfy, sdk_telegram, walletconnect, telegram_bot, rest) are saved to wallets.owner_approval_method column"
    - "Sending approval_method: null clears the column to NULL (reverts to Auto/global fallback)"
    - "Invalid approval_method values return 400 error"
    - "Omitting approval_method field preserves existing value unchanged"
  artifacts:
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "SetOwnerRequestSchema with nullable+optional approval_method field"
      contains: "approval_method"
    - path: "packages/daemon/src/api/routes/wallets.ts"
      provides: "PUT /wallets/:id/owner handler saves approval_method to DB"
      contains: "ownerApprovalMethod"
    - path: "packages/daemon/src/__tests__/wallets-api.test.ts"
      provides: "Tests for approval_method validation and persistence"
      min_lines: 30
  key_links:
    - from: "packages/daemon/src/api/routes/openapi-schemas.ts"
      to: "packages/core/src/schemas/signing-protocol.ts"
      via: "imports ApprovalMethodSchema for validation"
      pattern: "ApprovalMethodSchema"
    - from: "packages/daemon/src/api/routes/wallets.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "sets wallets.ownerApprovalMethod in DB update"
      pattern: "ownerApprovalMethod"
---

<objective>
PUT /v1/wallets/:id/owner REST API에 approval_method 필드를 추가하여 지갑별 Owner 승인 방법을 설정하고, 유효하지 않은 값에 대해 400 에러를 반환

Purpose: 지갑별로 서로 다른 승인 채널을 설정할 수 있게 하여 ApprovalChannelRouter가 라우팅에 사용할 데이터 저장 경로를 제공
Output: SetOwnerRequestSchema 확장 + wallets.ts 핸들러 수정 + 검증 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/routes/wallets.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/core/src/schemas/signing-protocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SetOwnerRequestSchema 확장 + PUT /wallets/:id/owner 핸들러 수정</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/wallets.ts
  </files>
  <action>
**Part A: Extend SetOwnerRequestSchema in openapi-schemas.ts**

Modify `SetOwnerRequestSchema` in `packages/daemon/src/api/routes/openapi-schemas.ts`:

Current:
```ts
export const SetOwnerRequestSchema = z
  .object({
    owner_address: z.string().min(1),
  })
  .openapi('SetOwnerRequest');
```

Change to:
```ts
import { ApprovalMethodSchema } from '@waiaas/core';

export const SetOwnerRequestSchema = z
  .object({
    owner_address: z.string().min(1),
    approval_method: ApprovalMethodSchema.nullable().optional(),
  })
  .openapi('SetOwnerRequest');
```

**CRITICAL: Use `.nullable().optional()` (not just `.optional()`).** This allows three states:
- Field omitted (`undefined`) -> existing value preserved, no DB update
- Field present as `null` -> clears column to NULL (reverts to Auto/global fallback)
- Field present as valid string -> saves the value to DB

Invalid strings get automatic 400 from Zod validation via OpenAPI validation hook.

**Part B: Update PUT /wallets/:id/owner handler in wallets.ts**

In the `setOwnerRoute` handler within `walletCrudRoutes()`:

1. After parsing body (`const body = c.req.valid('json');`), check if `approval_method` was explicitly provided in the request body. Use `body.approval_method !== undefined` to distinguish "omitted" from "explicitly set to null":
   ```ts
   // Only update approval_method when explicitly provided in request body
   if (body.approval_method !== undefined) {
     const approvalMethod = body.approval_method; // string | null
     deps.sqlite.prepare(
       'UPDATE wallets SET owner_approval_method = ? WHERE id = ?'
     ).run(approvalMethod, walletId);
   }
   ```

   **CRITICAL: Check `body.approval_method !== undefined` (not `!== null`).** When:
   - `approval_method` is omitted from JSON -> `body.approval_method` is `undefined` -> skip DB update (preserve existing value)
   - `approval_method` is `null` -> `body.approval_method` is `null` -> update DB to NULL (clear to Auto)
   - `approval_method` is `"sdk_ntfy"` -> `body.approval_method` is `"sdk_ntfy"` -> update DB to "sdk_ntfy"

2. In the response JSON, add `approvalMethod` field by reading from the updated wallet:
   ```ts
   const updated = await deps.db.select().from(wallets).where(eq(wallets.id, walletId)).get();
   ```
   Add to the response object: `approvalMethod: updated!.ownerApprovalMethod ?? null`

3. Also update the `WalletOwnerResponseSchema` in openapi-schemas.ts to include the new field:
   ```ts
   approvalMethod: z.string().nullable().optional(),
   ```

4. Also update the `WalletDetailResponseSchema` to include `approvalMethod` for the GET /wallets/:id endpoint so Admin UI can read it:
   ```ts
   approvalMethod: z.string().nullable().optional(),
   ```

5. Update the GET /wallets/:id handler to return `approvalMethod: wallet.ownerApprovalMethod ?? null`.
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/daemon` passes.
  </verify>
  <done>SetOwnerRequestSchema accepts `.nullable().optional()` approval_method (Zod-validated against APPROVAL_METHODS), PUT handler checks `!== undefined` to distinguish omitted vs null vs valid string, response includes approvalMethod field, GET /wallets/:id also returns approvalMethod</done>
</task>

<task type="auto">
  <name>Task 2: approval_method 검증 테스트</name>
  <files>
    packages/daemon/src/__tests__/wallets-api.test.ts
  </files>
  <action>
Add test cases to the existing `packages/daemon/src/__tests__/wallets-api.test.ts` (or create if it doesn't exist -- check first with `ls`). If the file doesn't exist, find the existing wallets route test file pattern.

Test cases to add (in a new `describe('PUT /wallets/:id/owner approval_method')` block):

1. **Valid approval_method**: PUT with `{ owner_address: "0x...", approval_method: "sdk_ntfy" }` returns 200 and response includes `approvalMethod: "sdk_ntfy"`.
2. **All 5 valid values**: Test each of `sdk_ntfy`, `sdk_telegram`, `walletconnect`, `telegram_bot`, `rest` -- all return 200.
3. **Invalid approval_method**: PUT with `{ owner_address: "0x...", approval_method: "invalid" }` returns 400 (Zod validation error from OpenAPI hook).
4. **Omitted approval_method**: PUT with `{ owner_address: "0x..." }` returns 200 and preserves existing behavior (no error, existing approvalMethod unchanged).
5. **Explicit null clears to Auto**: PUT with `{ owner_address: "0x...", approval_method: null }` returns 200 and response includes `approvalMethod: null` (column cleared to NULL).
6. **approval_method persisted**: After setting approval_method, GET /wallets/:id returns the stored approvalMethod value.
7. **Null after set clears**: Set approval_method to "sdk_ntfy", then PUT with `approval_method: null`, verify GET returns `approvalMethod: null`.

Use the existing test pattern in the codebase (createTestApp, in-memory SQLite, etc.). If no existing wallets-api test file, create one following the pattern from other API test files (e.g., `packages/daemon/src/__tests__/actions-api.test.ts` or similar).
  </action>
  <verify>
`pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern="wallets-api|wallet.*approval" --no-coverage` passes.
  </verify>
  <done>7+ test cases verify approval_method validation (valid values accepted, invalid rejected with 400, omission preserves existing value, explicit null clears to Auto, persistence via GET)</done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` -- no type errors
2. `pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern="wallets" --no-coverage` -- all wallet-related tests pass
3. `curl` equivalent: PUT /v1/wallets/:id/owner with `approval_method: "invalid"` returns 400
4. `curl` equivalent: PUT /v1/wallets/:id/owner with `approval_method: null` returns 200 and clears to Auto
</verification>

<success_criteria>
- SetOwnerRequestSchema accepts `.nullable().optional()` approval_method with Zod enum validation
- Invalid approval_method returns 400 automatically via OpenAPI validation hook
- Valid approval_method is saved to wallets.owner_approval_method column
- Explicit null clears column to NULL (Auto/global fallback)
- Omitted approval_method preserves existing value unchanged
- GET /wallets/:id response includes approvalMethod field
- 7+ test cases pass
</success_criteria>

<output>
After completion, create `.planning/phases/203-telegram-channel-routing-rest-admin/203-02-SUMMARY.md`
</output>
