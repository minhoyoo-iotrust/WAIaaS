---
phase: 203-telegram-channel-routing-rest-admin
plan: 04
type: execute
wave: 2
depends_on: [203-02]
files_modified:
  - packages/admin/src/pages/wallets.tsx
autonomous: true
requirements: [WALLET-06, WALLET-07]

must_haves:
  truths:
    - "Admin UI 지갑 상세 페이지에서 Owner 승인 방법을 라디오 버튼으로 선택할 수 있다"
    - "선택 변경 시 PUT /v1/wallets/:id/owner API를 호출하여 approval_method를 저장한다"
    - "Auto 선택 시 approval_method: null을 전송하여 기존 값을 초기화한다"
    - "미구성 인프라(예: signing SDK 미활성 + sdk_ntfy) 선택 시 경고 메시지를 표시한다"
  artifacts:
    - path: "packages/admin/src/pages/wallets.tsx"
      provides: "Owner Approval Method 라디오 선택 UI + 인프라 경고"
      contains: "approval_method"
  key_links:
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "packages/admin/src/api/endpoints.ts"
      via: "PUT WALLET_OWNER endpoint with approval_method"
      pattern: "WALLET_OWNER.*approval_method"
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "packages/admin/src/api/client.ts"
      via: "apiPut for saving approval method"
      pattern: "apiPut.*approval_method"
---

<objective>
Admin UI 지갑 상세 페이지에 Owner 승인 방법 라디오 선택 UI를 추가하고, 미구성 인프라 선택 시 경고를 표시

Purpose: Admin이 지갑별로 Owner 승인 방법을 시각적으로 설정/변경할 수 있게 하여, ApprovalChannelRouter의 라우팅 대상을 관리
Output: WalletDetailView 컴포넌트에 승인 방법 라디오 선택 섹션 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/admin/src/pages/wallets.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/components/form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: WalletDetail 타입 + 데이터 로드 확장</name>
  <files>
    packages/admin/src/pages/wallets.tsx
  </files>
  <action>
Modify `packages/admin/src/pages/wallets.tsx`:

1. **Extend WalletDetail interface**: Add `approvalMethod: string | null;` field.

2. **Add settings signal**: In `WalletDetailView`, add a signal to hold relevant settings for infrastructure availability detection:
   ```ts
   const approvalSettings = useSignal<{
     signingEnabled: boolean;
     telegramEnabled: boolean;
     telegramBotConfigured: boolean;
     wcConfigured: boolean;
   } | null>(null);
   ```

3. **Fetch settings on mount**: Add a `fetchApprovalSettings` function that calls `apiGet(API.ADMIN_SETTINGS)` and extracts:
   - `signingEnabled`: `settings.signing_sdk?.enabled?.value === 'true'`
   - `telegramEnabled`: `settings.telegram?.enabled?.value === 'true'`
   - `telegramBotConfigured`: `settings.telegram?.bot_token?.value` is non-empty (may be masked, check if present)
   - `wcConfigured`: `settings.walletconnect?.project_id?.value` is non-empty

   **CRITICAL: Do NOT check `notifications.ntfy_topic` for sdk_ntfy availability.** The ntfy_topic setting is for the notification system, not for the signing SDK channel. NtfySigningChannel uses `signing_sdk.ntfy_request_topic_prefix` which is internal. The correct availability check for sdk_ntfy is `signing_sdk.enabled === 'true'` (same as sdk_telegram). If signing SDK is enabled, ntfy channel is available.

   Call this in the existing `useEffect` alongside `fetchWallet()`.

4. **Add approval method change handler**:
   ```ts
   const handleApprovalMethodChange = async (method: string | null) => {
     try {
       await apiPut(API.WALLET_OWNER(id), {
         owner_address: wallet.value!.ownerAddress!,
         approval_method: method ?? null,
       });
       await fetchWallet();
       showToast('success', 'Approval method updated');
     } catch (err) {
       const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
       showToast('error', getErrorMessage(e.code, e.serverMessage));
     }
   };
   ```

   **CRITICAL: Use `method ?? null` (not `method || undefined`).** When the user selects "Auto", `method` is `null`. The handler MUST send `approval_method: null` in the JSON body so the backend clears the column to NULL. Using `|| undefined` would omit the field entirely, leaving the existing value unchanged (which is wrong -- Auto should clear the setting). The backend (Plan 02) uses `.nullable().optional()` and checks `!== undefined` to distinguish omitted vs explicit null.

   Note: The PUT /wallets/:id/owner endpoint requires `owner_address`. Re-send the existing owner_address along with the new approval_method. This handler should only be visible when an owner is already set (ownerState !== 'NONE').
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/admin` passes.
  </verify>
  <done>WalletDetail interface includes approvalMethod, settings availability signals loaded (using signing_sdk.enabled for SDK channels), change handler sends explicit null for Auto option via `method ?? null`</done>
</task>

<task type="auto">
  <name>Task 2: 승인 방법 라디오 선택 UI + 인프라 경고 렌더링</name>
  <files>
    packages/admin/src/pages/wallets.tsx
  </files>
  <action>
In `WalletDetailView`, add a new section in the "Owner Wallet" area (after the owner address/state display, before the WalletConnect section).

**Render condition**: Only show when `wallet.value.ownerState !== 'NONE'` (owner must be set to configure approval method).

**Section structure:**

```tsx
<div style={{ marginTop: 'var(--space-4)', paddingTop: 'var(--space-3)', borderTop: '1px solid var(--color-border)' }}>
  <h4 style={{ marginBottom: 'var(--space-2)', fontSize: '0.9rem' }}>Approval Method</h4>
  <p style={{ color: 'var(--color-text-secondary)', fontSize: '0.85rem', marginBottom: 'var(--space-3)' }}>
    Choose how transaction approvals are delivered to the owner.
    Leave as "Auto (Global Fallback)" to use the system-wide priority.
  </p>
  {/* Radio options */}
  <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--space-2)' }}>
    {APPROVAL_OPTIONS.map(opt => (
      <label key={opt.value ?? 'auto'} style={{
        display: 'flex', alignItems: 'flex-start', gap: 'var(--space-2)',
        padding: 'var(--space-2) var(--space-3)',
        background: wallet.value?.approvalMethod === opt.value ? 'var(--color-bg-secondary)' : 'transparent',
        borderRadius: 'var(--radius-md)',
        cursor: 'pointer',
      }}>
        <input
          type="radio"
          name="approval_method"
          value={opt.value ?? ''}
          checked={wallet.value?.approvalMethod === opt.value}
          onChange={() => handleApprovalMethodChange(opt.value)}
          style={{ marginTop: '2px' }}
        />
        <div>
          <div style={{ fontWeight: 500, fontSize: '0.9rem' }}>{opt.label}</div>
          <div style={{ color: 'var(--color-text-secondary)', fontSize: '0.8rem' }}>{opt.description}</div>
          {/* Infrastructure warning (WALLET-07) */}
          {opt.warning && opt.warningCondition?.(approvalSettings.value) && (
            <div style={{
              marginTop: 'var(--space-1)',
              padding: 'var(--space-1) var(--space-2)',
              background: 'var(--color-warning-bg, #fff3cd)',
              border: '1px solid var(--color-warning-border, #ffc107)',
              borderRadius: 'var(--radius-sm)',
              fontSize: '0.75rem',
              color: 'var(--color-warning-text, #856404)',
            }}>
              {opt.warning}
            </div>
          )}
        </div>
      </label>
    ))}
  </div>
</div>
```

**APPROVAL_OPTIONS constant** (define before the component or at module level):

```ts
const APPROVAL_OPTIONS: Array<{
  value: string | null;
  label: string;
  description: string;
  warning?: string;
  warningCondition?: (settings: typeof approvalSettings.value) => boolean;
}> = [
  {
    value: null,
    label: 'Auto (Global Fallback)',
    description: 'System decides based on configured channels: SDK ntfy > SDK Telegram > WalletConnect > Telegram Bot > REST',
  },
  {
    value: 'sdk_ntfy',
    label: 'SDK via ntfy',
    description: 'Push notifications via ntfy server to wallet app',
    warning: 'Signing SDK is not enabled. Go to System > Signing SDK settings.',
    warningCondition: (s) => !s?.signingEnabled,
  },
  {
    value: 'sdk_telegram',
    label: 'SDK via Telegram',
    description: 'Send sign request to Telegram with universal link',
    warning: 'Signing SDK or Telegram bot is not enabled. Check System > Signing SDK and Telegram settings.',
    warningCondition: (s) => !s?.signingEnabled || !s?.telegramEnabled || !s?.telegramBotConfigured,
  },
  {
    value: 'walletconnect',
    label: 'WalletConnect',
    description: 'Approve via connected WalletConnect wallet (D\'CENT, MetaMask, etc.)',
    warning: 'WalletConnect project ID is not configured. Go to Wallets > WalletConnect tab.',
    warningCondition: (s) => !s?.wcConfigured,
  },
  {
    value: 'telegram_bot',
    label: 'Telegram Bot',
    description: 'Approve/reject via Telegram bot /approve and /reject commands',
    warning: 'Telegram bot is not enabled. Go to System > Telegram settings.',
    warningCondition: (s) => !s?.telegramEnabled || !s?.telegramBotConfigured,
  },
  {
    value: 'rest',
    label: 'REST API',
    description: 'Manual approval via REST API endpoints (POST /approve, /reject)',
  },
];
```

**Key changes from original plan:**
- `sdk_ntfy` warning checks `!s?.signingEnabled` (not `!s?.ntfyConfigured`) because NtfySigningChannel availability depends on `signing_sdk.enabled`, not the notification ntfy_topic setting.
- `sdk_telegram` warning also checks `!s?.signingEnabled` in addition to telegram availability.
- The `ntfyConfigured` field is removed from `approvalSettings` signal since it was checking the wrong setting.
  </action>
  <verify>
`pnpm turbo run build --filter=@waiaas/admin` succeeds (Vite build).
`pnpm turbo run typecheck --filter=@waiaas/admin` passes.
Visual check: The Admin wallet detail page shows radio buttons for approval method selection.
  </verify>
  <done>Admin UI shows 6 radio options (Auto + 5 methods) in wallet detail page, infrastructure warnings correctly check signing_sdk.enabled for SDK channels (not ntfy_topic), selection triggers PUT API with explicit null for Auto option</done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/admin` -- no type errors
2. `pnpm turbo run build --filter=@waiaas/admin` -- Vite build succeeds
3. Visual: Navigate to wallet detail page, see "Approval Method" section with radio buttons
4. Infrastructure warning visible when selecting sdk_ntfy without signing SDK enabled
5. Selecting "Auto" sends approval_method: null (not undefined) to clear existing setting
</verification>

<success_criteria>
- Wallet detail page shows 6 radio options for approval method (including Auto fallback)
- Selecting an option calls PUT /v1/wallets/:id/owner with approval_method
- Selecting Auto sends explicit null to clear approval_method (reverts to global fallback)
- Unconfigured infrastructure shows yellow warning banner (WALLET-07)
- SDK channel warnings correctly check signing_sdk.enabled (not notifications.ntfy_topic)
- Type check and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/203-telegram-channel-routing-rest-admin/203-04-SUMMARY.md`
</output>
