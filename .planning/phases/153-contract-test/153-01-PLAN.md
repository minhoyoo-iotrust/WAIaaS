---
phase: 153-contract-test
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/__tests__/contracts/chain-adapter.contract.ts
  - packages/core/src/__tests__/contracts/chain-adapter-mock.contract.test.ts
  - packages/adapters/solana/src/__tests__/contracts/chain-adapter-solana.contract.test.ts
  - packages/adapters/evm/src/__tests__/contracts/chain-adapter-evm.contract.test.ts
autonomous: true

must_haves:
  truths:
    - "MockChainAdapter와 SolanaAdapter가 동일한 Contract Test 공유 스위트를 통과한다"
    - "MockChainAdapter와 EvmAdapter가 동일한 Contract Test 공유 스위트를 통과한다 (buildBatch -> BATCH_NOT_SUPPORTED)"
    - "Contract Test 실패 시 어떤 메서드가 어떻게 다른지 명확한 에러 메시지가 출력된다"
  artifacts:
    - path: "packages/core/src/__tests__/contracts/chain-adapter.contract.ts"
      provides: "IChainAdapter 22 메서드 공유 Contract Test 스위트 팩토리 함수"
      exports: ["chainAdapterContractTests"]
    - path: "packages/core/src/__tests__/contracts/chain-adapter-mock.contract.test.ts"
      provides: "MockChainAdapter Contract Test 실행"
      contains: "chainAdapterContractTests"
    - path: "packages/adapters/solana/src/__tests__/contracts/chain-adapter-solana.contract.test.ts"
      provides: "SolanaAdapter Contract Test 실행 (mock RPC 기반)"
      contains: "chainAdapterContractTests"
    - path: "packages/adapters/evm/src/__tests__/contracts/chain-adapter-evm.contract.test.ts"
      provides: "EvmAdapter Contract Test 실행 (BATCH_NOT_SUPPORTED 포함)"
      contains: "chainAdapterContractTests"
  key_links:
    - from: "chain-adapter.contract.ts"
      to: "IChainAdapter"
      via: "import type"
      pattern: "import.*IChainAdapter"
    - from: "chain-adapter-mock.contract.test.ts"
      to: "chain-adapter.contract.ts"
      via: "chainAdapterContractTests factory"
      pattern: "chainAdapterContractTests"
    - from: "chain-adapter-solana.contract.test.ts"
      to: "chain-adapter.contract.ts"
      via: "chainAdapterContractTests factory"
      pattern: "chainAdapterContractTests"
    - from: "chain-adapter-evm.contract.test.ts"
      to: "chain-adapter.contract.ts"
      via: "chainAdapterContractTests factory"
      pattern: "chainAdapterContractTests"
---

<objective>
IChainAdapter 22 메서드에 대한 Contract Test 공유 스위트를 작성하고, MockChainAdapter / SolanaAdapter / EvmAdapter 세 구현체가 모두 동일한 계약을 통과하도록 검증한다.

Purpose: Mock이 실제 구현과 동일한 동작을 보장해야 Mock 기반 Unit 테스트 결과를 신뢰할 수 있다. Contract Test 패턴으로 Mock-실제 구현 동작 일치를 보장한다.
Output: 공유 Contract Test 스위트 1개 + 실행 테스트 3개 (Mock, Solana, EVM)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/core/src/__tests__/chain-adapter-interface.test.ts
@packages/cli/src/__tests__/helpers/daemon-harness.ts (기존 MockChainAdapter -- 22개 중 10개만 구현)
@packages/adapters/solana/src/adapter.ts
@packages/adapters/evm/src/adapter.ts
@docs/v0.4/42-mock-boundaries-interfaces-contracts.md (섹션 5 Contract Test 전략)
</context>

<tasks>

<task type="auto">
  <name>Task 1: IChainAdapter Contract Test 공유 스위트 + MockChainAdapter 완전 구현</name>
  <files>
    packages/core/src/__tests__/contracts/chain-adapter.contract.ts
    packages/core/src/__tests__/contracts/chain-adapter-mock.contract.test.ts
  </files>
  <action>
**1. Contract Test 공유 스위트 작성 (`chain-adapter.contract.ts`)**

`chainAdapterContractTests(factory, options)` 팩토리 함수를 작성한다. factory는 `() => IChainAdapter | Promise<IChainAdapter>`이고, options는 테스트 동작을 제어한다.

```typescript
interface ChainAdapterContractOptions {
  /** SolanaAdapter는 'solana', EvmAdapter는 'ethereum' */
  expectedChain: ChainType;
  /** 테스트에 사용할 유효 주소 */
  validAddress: string;
  /** EVM인 경우 buildBatch가 BATCH_NOT_SUPPORTED를 throw해야 함 */
  batchNotSupported?: boolean;
  /** connect에 필요한 RPC URL (실제 어댑터용). 미제공 시 connect 관련 테스트 skip */
  rpcUrl?: string;
  /** 테스트에 사용할 개인키 (signTransaction용) */
  privateKey?: Uint8Array;
}
```

22개 메서드를 아래 카테고리별로 검증한다. 모든 테스트는 **반환 타입 형태(shape) 검증**에 초점을 맞춘다 (값이 아닌 구조):

**readonly 프로퍼티 (2):**
- `chain`이 유효한 ChainType('solana' | 'ethereum')이어야 한다
- `network`가 유효한 NetworkType이어야 한다

**Connection 4개 (connect, disconnect, isConnected, getHealth):**
- isConnected()는 boolean을 반환해야 한다
- connect() 호출 후 isConnected()는 true여야 한다 (rpcUrl 제공 시)
- getHealth()는 HealthInfo 형태 `{ healthy: boolean, latencyMs: number }` 반환
- disconnect() 후 isConnected()는 false여야 한다

**Balance 1개 (getBalance):**
- getBalance(validAddress)는 BalanceInfo 형태 `{ address: string, balance: bigint, decimals: number, symbol: string }` 반환

**Pipeline 4개 (buildTransaction, simulateTransaction, signTransaction, submitTransaction):**
- buildTransaction(request)은 UnsignedTransaction 형태 `{ chain: ChainType, serialized: Uint8Array, estimatedFee: bigint, metadata: object }` 반환
- simulateTransaction(tx)은 SimulationResult 형태 `{ success: boolean, logs: string[] }` 반환
- signTransaction(tx, privateKey)은 Uint8Array 반환, length > 0
- submitTransaction(signedTx)은 SubmitResult 형태 `{ txHash: string, status: string }` 반환

**Confirmation 1개 (waitForConfirmation):**
- waitForConfirmation(txHash)은 SubmitResult 형태 반환

**Asset 1개 (getAssets):**
- getAssets(address)는 AssetInfo[] 반환 (배열), 각 요소에 `{ mint, symbol, balance, decimals, isNative }` 존재

**Fee 1개 (estimateFee):**
- estimateFee(request)는 FeeEstimate 형태 `{ fee: bigint }` 반환

**Token 2개 (buildTokenTransfer, getTokenInfo):**
- buildTokenTransfer(params)은 UnsignedTransaction 반환
- getTokenInfo(address)은 TokenInfo 형태 `{ address, symbol, name, decimals }` 반환

**Contract 2개 (buildContractCall, buildApprove):**
- buildContractCall(params)은 UnsignedTransaction 반환
- buildApprove(params)은 UnsignedTransaction 반환

**Batch 1개 (buildBatch):**
- options.batchNotSupported가 true면: buildBatch(params)가 `BATCH_NOT_SUPPORTED` 에러를 throw
- 그 외: buildBatch(params)은 UnsignedTransaction 반환

**Utility 3개 (getTransactionFee, getCurrentNonce, sweepAll):**
- getTransactionFee(tx)은 bigint 반환
- getCurrentNonce(address)은 number 반환 (Solana의 경우 0)
- sweepAll(from, to, key)은 SweepResult 형태 `{ total, succeeded, failed, results }` 반환

**Sign-only 2개 (parseTransaction, signExternalTransaction):**
- parseTransaction(rawTx)은 ParsedTransaction 형태 `{ operations: ParsedOperation[], rawTx: string }` 반환
- signExternalTransaction(rawTx, key)은 SignedTransaction 형태 `{ signedTransaction: string }` 반환

**에러 메시지 형식:**
각 테스트의 assertion 실패 시 "IChainAdapter.methodName: 설명" 형식으로 커스텀 에러 메시지를 포함한다. 예: `expect(typeof result.balance).toBe('bigint', 'IChainAdapter.getBalance: balance must be bigint')`

**주요 설계 결정:**
- 공유 스위트는 rpcUrl 제공 여부에 따라 네트워크 의존 테스트를 `describe.skipIf`로 처리한다
- Mock 전용 테스트(canned response 값 검증)는 공유 스위트에 포함하지 않는다
- 모든 테스트는 반환 타입 형태(shape)만 검증하고 구체적 값은 검증하지 않는다 (Mock의 고정값과 실제 RPC 반환값이 다르므로)

**2. MockChainAdapter 완전 구현 (22개 메서드)**

기존 `packages/cli/src/__tests__/helpers/daemon-harness.ts`의 MockChainAdapter는 10개 메서드만 구현되어 있다. 이를 참고하되, Contract Test 전용으로 `chain-adapter-mock.contract.test.ts` 파일 내에 완전한 22-메서드 MockChainAdapter를 인라인으로 구현한다 (daemon-harness의 기존 코드는 수정하지 않는다).

누락된 12개 메서드의 Mock 반환값:
- `getAssets(address)` -> `[{ mint: 'native', symbol: 'SOL', name: 'Solana', balance: 1_000_000_000n, decimals: 9, isNative: true }]`
- `estimateFee(request)` -> `{ fee: 5000n }`
- `buildTokenTransfer(params)` -> 동일한 UnsignedTransaction 형태
- `getTokenInfo(tokenAddress)` -> `{ address: tokenAddress, symbol: 'USDC', name: 'USD Coin', decimals: 6 }`
- `buildContractCall(params)` -> 동일한 UnsignedTransaction 형태
- `buildApprove(params)` -> 동일한 UnsignedTransaction 형태
- `buildBatch(params)` -> 동일한 UnsignedTransaction 형태 (Solana mock이므로 지원)
- `getTransactionFee(tx)` -> `5000n`
- `getCurrentNonce(address)` -> `0`
- `sweepAll(from, to, key)` -> `{ total: 1, succeeded: 1, failed: 0, results: [{ mint: 'native', txHash: 'mock-sweep-tx', amount: 1_000_000_000n }] }`

**3. MockChainAdapter Contract Test 실행 (`chain-adapter-mock.contract.test.ts`)**

```typescript
describe('CT-1/CT-2: MockChainAdapter Contract Tests', () => {
  chainAdapterContractTests(
    () => new ContractTestMockChainAdapter('solana', 'devnet'),
    {
      expectedChain: 'solana',
      validAddress: 'So11111111111111111111111111111112',
      batchNotSupported: false,
      privateKey: new Uint8Array(64).fill(0x42),
    }
  );
});
```
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/core/src/__tests__/contracts/chain-adapter-mock.contract.test.ts` -- 모든 테스트 통과
  </verify>
  <done>
IChainAdapter 22 메서드 공유 Contract Test 스위트가 작성되고, MockChainAdapter가 모든 테스트를 통과한다. 실패 시 "IChainAdapter.methodName: 설명" 형식의 명확한 에러 메시지가 출력된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: SolanaAdapter + EvmAdapter Contract Test 실행</name>
  <files>
    packages/adapters/solana/src/__tests__/contracts/chain-adapter-solana.contract.test.ts
    packages/adapters/evm/src/__tests__/contracts/chain-adapter-evm.contract.test.ts
  </files>
  <action>
**1. SolanaAdapter Contract Test (`chain-adapter-solana.contract.test.ts`)**

SolanaAdapter는 실제 RPC 없이도 반환 타입 형태를 검증할 수 있는 방법이 필요하다. `@solana/kit`의 mock RPC transport 또는 msw를 사용하여 최소한의 RPC 응답을 모킹한다.

접근 방식: SolanaAdapter를 인스턴스화하고, `connect()` 단계에서 mock RPC를 사용한다. 실제 RPC가 없는 환경(CI)에서도 실행 가능해야 하므로:

- SolanaAdapter 생성 시 `new SolanaAdapter('devnet')` 또는 `new SolanaAdapter('testnet')` 사용
- `connect()`에 mock RPC URL을 전달하되, 내부적으로 RPC 호출이 필요한 메서드(getBalance, buildTransaction 등)는 msw로 Solana RPC JSON-RPC 응답을 모킹한다
- 또는 SolanaAdapter의 constructor가 허용하는 범위에서 mock transport를 주입한다

SolanaAdapter의 실제 구현을 확인하여 어떤 RPC 호출이 필요한지 파악하고, 최소한의 msw handler를 설정한다. `getLatestBlockhash`, `getBalance`, `simulateTransaction`, `sendTransaction`, `getSignatureStatuses` 등의 JSON-RPC 메서드에 대한 canned response를 반환하는 msw handler를 설정한다.

```typescript
import { setupServer } from 'msw/node';
import { http, HttpResponse } from 'msw';
import { chainAdapterContractTests } from '@waiaas/core/src/__tests__/contracts/chain-adapter.contract.js';
import { SolanaAdapter } from '../../adapter.js';

// Solana JSON-RPC mock handlers
const MOCK_RPC_URL = 'http://localhost:18899';
const solanaRpcHandlers = [
  http.post(MOCK_RPC_URL, async ({ request }) => {
    const body = await request.json() as { method: string };
    switch (body.method) {
      case 'getLatestBlockhash':
        return HttpResponse.json({ result: { value: { blockhash: 'mock-blockhash-...', lastValidBlockHeight: 200 }, context: { slot: 100 } } });
      case 'getBalance':
        return HttpResponse.json({ result: { value: 1_000_000_000, context: { slot: 100 } } });
      // ... 최소한의 핸들러
    }
  }),
];

const server = setupServer(...solanaRpcHandlers);

describe('CT-1: SolanaAdapter Contract Tests', () => {
  beforeAll(() => server.listen({ onUnhandledRequest: 'warn' }));
  afterAll(() => server.close());

  chainAdapterContractTests(
    async () => {
      const adapter = new SolanaAdapter('devnet');
      await adapter.connect(MOCK_RPC_URL);
      return adapter;
    },
    {
      expectedChain: 'solana',
      validAddress: 'So11111111111111111111111111111112',
      batchNotSupported: false,
      rpcUrl: MOCK_RPC_URL,
      privateKey: new Uint8Array(64).fill(0x42),
    }
  );
});
```

주의: SolanaAdapter의 일부 메서드(buildTransaction 등)가 RPC 호출 체인이 복잡한 경우, 해당 테스트를 `test.skip`으로 표시하고 "Level 2 Local Validator에서 검증 예정"이라는 주석을 남긴다. Contract Test의 핵심은 반환 타입 형태 검증이므로, 모든 RPC 의존 메서드를 완벽히 모킹할 필요는 없다.

**실용적 접근:** SolanaAdapter의 복잡한 RPC 의존성 때문에 모든 22개 메서드를 msw로 모킹하기 어려운 경우:
- 연결/상태 검증 (connect, disconnect, isConnected, getHealth): msw로 모킹 가능
- getBalance, getAssets: msw로 모킹 가능
- Pipeline (build/simulate/sign/submit): 복잡한 RPC 체인 -> 가능한 범위까지 모킹하되, 실패 시 skip 처리
- 핵심: **같은 공유 스위트를 실행**한다는 사실 자체가 Contract Test의 가치. 일부 테스트가 skip되더라도 구조적 동일성은 보장된다.

**2. EvmAdapter Contract Test (`chain-adapter-evm.contract.test.ts`)**

EvmAdapter는 viem 2.x 기반이므로 msw로 Ethereum JSON-RPC를 모킹한다.

```typescript
import { setupServer } from 'msw/node';
import { http, HttpResponse } from 'msw';
import { chainAdapterContractTests } from '@waiaas/core/src/__tests__/contracts/chain-adapter.contract.js';
import { EvmAdapter } from '../../adapter.js';

const MOCK_RPC_URL = 'http://localhost:18545';
const evmRpcHandlers = [
  http.post(MOCK_RPC_URL, async ({ request }) => {
    const body = await request.json() as { method: string; id: number };
    switch (body.method) {
      case 'eth_chainId':
        return HttpResponse.json({ jsonrpc: '2.0', id: body.id, result: '0xaa36a7' }); // Sepolia
      case 'eth_blockNumber':
        return HttpResponse.json({ jsonrpc: '2.0', id: body.id, result: '0x100' });
      case 'eth_getBalance':
        return HttpResponse.json({ jsonrpc: '2.0', id: body.id, result: '0xDE0B6B3A7640000' }); // 1 ETH
      // ... 최소 핸들러
    }
  }),
];

const server = setupServer(...evmRpcHandlers);

describe('CT-2: EvmAdapter Contract Tests', () => {
  beforeAll(() => server.listen({ onUnhandledRequest: 'warn' }));
  afterAll(() => server.close());

  chainAdapterContractTests(
    async () => {
      const adapter = new EvmAdapter('sepolia');
      await adapter.connect(MOCK_RPC_URL);
      return adapter;
    },
    {
      expectedChain: 'ethereum',
      validAddress: '0x1234567890abcdef1234567890abcdef12345678',
      batchNotSupported: true, // EVM은 buildBatch -> BATCH_NOT_SUPPORTED throw
      rpcUrl: MOCK_RPC_URL,
      privateKey: new Uint8Array(32).fill(0x42), // EVM은 32바이트 private key
    }
  );
});
```

핵심: `batchNotSupported: true`로 설정하여 buildBatch 테스트에서 BATCH_NOT_SUPPORTED 에러 throw를 검증한다.

**디렉토리 생성:**
- `packages/adapters/solana/src/__tests__/contracts/` 디렉토리 생성
- `packages/adapters/evm/src/__tests__/contracts/` 디렉토리 생성
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/adapters/solana/src/__tests__/contracts/ && pnpm vitest run packages/adapters/evm/src/__tests__/contracts/` -- 모든 테스트 통과 (skip된 항목은 warn으로 표시)
  </verify>
  <done>
SolanaAdapter와 EvmAdapter가 MockChainAdapter와 동일한 Contract Test 공유 스위트를 실행하여 22 메서드 형태 동일성이 검증된다. EvmAdapter의 buildBatch는 BATCH_NOT_SUPPORTED를 올바르게 throw한다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/core/src/__tests__/contracts/` -- MockChainAdapter Contract Test 통과
2. `pnpm vitest run packages/adapters/solana/src/__tests__/contracts/` -- SolanaAdapter Contract Test 통과
3. `pnpm vitest run packages/adapters/evm/src/__tests__/contracts/` -- EvmAdapter Contract Test 통과
4. 세 테스트 파일 모두 동일한 `chainAdapterContractTests` 공유 스위트를 import하여 실행
5. EvmAdapter에서 buildBatch 호출 시 `BATCH_NOT_SUPPORTED` 에러 발생
</verification>

<success_criteria>
- CTST-01: MockChainAdapter vs SolanaAdapter 22 메서드 동작 동일성 검증 완료
- CTST-02: MockChainAdapter vs EvmAdapter 22 메서드 동작 동일성 검증 완료 (buildBatch -> BATCH_NOT_SUPPORTED)
- 모든 Contract Test 실패 시 "IChainAdapter.methodName: 설명" 형태의 명확한 에러 메시지 출력
</success_criteria>

<output>
After completion, create `.planning/phases/153-contract-test/153-01-SUMMARY.md`
</output>
