---
phase: 57-integration-tests
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts
  - packages/daemon/src/__tests__/workflow-owner-e2e.test.ts
autonomous: true

must_haves:
  truths:
    - "Session create -> use -> renew -> use renewed -> revoke -> rejection is tested end-to-end"
    - "DELAY queue -> timer expire -> auto-execute -> CONFIRMED is tested end-to-end"
    - "APPROVAL request -> owner approve -> CONFIRMED is tested end-to-end"
    - "APPROVAL request -> owner reject -> CANCELLED is tested end-to-end"
    - "APPROVAL request -> timeout -> EXPIRED is tested end-to-end"
    - "Owner NONE -> GRACE -> LOCKED transition with downgrade is tested end-to-end"
  artifacts:
    - path: "packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts"
      provides: "Full session lifecycle + DELAY/APPROVAL workflow E2E tests"
    - path: "packages/daemon/src/__tests__/workflow-owner-e2e.test.ts"
      provides: "Owner state transition + approval/reject/cancel API E2E tests"
  key_links:
    - from: "packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts"
      to: "packages/daemon/src/api/server.ts"
      via: "createApp with full deps (session + workflow)"
      pattern: "createApp.*jwtSecretManager.*approvalWorkflow.*delayQueue"
    - from: "packages/daemon/src/__tests__/workflow-owner-e2e.test.ts"
      to: "packages/daemon/src/workflow/owner-state.ts"
      via: "OwnerLifecycleService API-level integration"
      pattern: "ownerLifecycle.*setOwner.*markOwnerVerified"
---

<objective>
Create end-to-end integration tests that span multiple components: session lifecycle from creation to revocation, DELAY/APPROVAL workflow through the API, and Owner state transitions with downgrade verification.

Purpose: Ensure TEST-03 (session lifecycle), TEST-04 (DELAY/APPROVAL workflow), and TEST-05 (Owner state transitions) requirements are verified at the API integration level, not just unit level.
Output: Two comprehensive E2E test files that exercise the full stack through Hono app.request().
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-integration-tests/57-01-SUMMARY.md
@packages/daemon/src/__tests__/api-sessions.test.ts
@packages/daemon/src/__tests__/api-session-renewal.test.ts
@packages/daemon/src/__tests__/delay-queue.test.ts
@packages/daemon/src/__tests__/approval-workflow.test.ts
@packages/daemon/src/__tests__/owner-state.test.ts
@packages/daemon/src/__tests__/pipeline-stage4.test.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/workflow/delay-queue.ts
@packages/daemon/src/workflow/approval-workflow.ts
@packages/daemon/src/workflow/owner-state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Session lifecycle + DELAY/APPROVAL workflow E2E test</name>
  <files>
    packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts
  </files>
  <action>
Create a comprehensive E2E test file that exercises the full session and workflow lifecycle using Hono `app.request()` with `createApp()` full-deps pattern (same as api-sessions.test.ts but with workflow deps).

**Test harness setup:**
- In-memory SQLite + Drizzle + pushSchema
- JwtSecretManager initialized
- Argon2id password hash for masterAuth
- DatabasePolicyEngine with sqlite for TOCTOU-safe evaluation
- DelayQueue and ApprovalWorkflow instances
- OwnerLifecycleService instance
- `createApp()` with ALL deps: db, jwtSecretManager, masterPasswordHash, config (with policy_defaults), policyEngine, delayQueue, approvalWorkflow, ownerLifecycle, sqlite
- Use `vi.useFakeTimers()` for controlled time advancement
- Seed a test agent with owner address (for APPROVAL tests)

**Test: Session lifecycle (TEST-03)**

`describe('Session Lifecycle E2E')`:
1. `it('full lifecycle: create -> use for wallet call -> renew -> use renewed token -> revoke -> rejection')`:
   - POST /v1/sessions with masterAuth -> 201, get token
   - GET /v1/wallet/address with Bearer token -> 200 (proves session works)
   - Advance time past 50% TTL
   - PUT /v1/sessions/:id/renew with Bearer token -> 200, get new token
   - GET /v1/wallet/address with NEW token -> 200 (proves renewed session works)
   - DELETE /v1/sessions/:id with masterAuth -> 200
   - GET /v1/wallet/address with renewed token -> 401 SESSION_REVOKED

NOTE: For wallet routes to work, the test needs a keyStore mock AND an adapter mock. Since this is an API-level test, inject MockChainAdapter and a minimal keyStore mock into createApp deps. Use the existing mock patterns from pipeline tests.

**Test: DELAY workflow E2E (TEST-04)**

`describe('DELAY Workflow E2E')`:
2. `it('DELAY: send -> QUEUED status -> wait for processExpired -> CONFIRMED')`:
   - Create agent + session + SPENDING_LIMIT policy (amount triggers DELAY tier)
   - POST /v1/transactions/send with Bearer token and amount in DELAY range -> 201, status PENDING
   - Wait for async pipeline to set QUEUED status (poll GET /v1/transactions/:id or check DB directly)
   - Manually call `delayQueue.processExpired()` (simulate BackgroundWorker tick) after advancing time past delay
   - Verify transaction transitions to EXECUTING then CONFIRMED
3. `it('DELAY: send -> QUEUED -> cancel before expiry -> CANCELLED')`:
   - Same setup as above
   - POST /v1/transactions/:id/cancel with Bearer token -> 200
   - Verify status is CANCELLED

**Test: APPROVAL workflow E2E (TEST-04)**

`describe('APPROVAL Workflow E2E')`:
4. `it('APPROVAL: send -> QUEUED -> owner approves -> CONFIRMED')`:
   - Create agent with owner address (GRACE state) + SPENDING_LIMIT policy (amount triggers APPROVAL)
   - POST /v1/transactions/send -> 201
   - Verify QUEUED status + pending_approvals record in DB
   - POST /v1/transactions/:id/approve with ownerAuth headers (Ed25519 sig using sodium-native) -> 200
   - Verify transaction transitions to EXECUTING then CONFIRMED (or verify via processExpired/manual stage5 call)
5. `it('APPROVAL: send -> QUEUED -> owner rejects -> CANCELLED')`:
   - Same as above but POST /v1/transactions/:id/reject with ownerAuth -> 200
   - Verify CANCELLED status
6. `it('APPROVAL: send -> QUEUED -> timeout -> EXPIRED')`:
   - Same setup with short timeout (policyTimeoutSeconds = 1 or set via DB)
   - Call `approvalWorkflow.processExpiredApprovals(now)` after advancing time
   - Verify EXPIRED status

IMPORTANT: For APPROVAL tests involving ownerAuth, you need to create Ed25519 keypairs using sodium-native (same pattern as owner-auth.test.ts). The agent must have an owner_address matching the test keypair. Use the same base58 encode helper.

For the DELAY and APPROVAL tests, since the pipeline runs async (fire-and-forget from POST /transactions/send), you may need to either:
- Poll GET /v1/transactions/:id until status changes
- Or check DB state directly after a small delay
- Or call workflow methods directly after the API call
The test should verify the DB state transitions explicitly.
  </action>
  <verify>
Run `npx vitest run packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts` -- all tests pass.
  </verify>
  <done>
Session lifecycle: create -> use -> renew -> use -> revoke -> rejection verified in a single test. DELAY: send -> QUEUED -> processExpired -> CONFIRMED + cancel path verified. APPROVAL: approve/reject/timeout all verified with ownerAuth Ed25519 signatures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Owner state transition + downgrade E2E test</name>
  <files>
    packages/daemon/src/__tests__/workflow-owner-e2e.test.ts
  </files>
  <action>
Create E2E tests verifying Owner state transitions through the API and the APPROVAL -> DELAY downgrade at the API level.

**Test harness setup:**
Same as Task 1 (createApp with full deps, in-memory SQLite, JwtSecretManager, PolicyEngine, DelayQueue, ApprovalWorkflow, OwnerLifecycleService).
Need Ed25519 keypair generation helpers (sodium-native, same as owner-auth.test.ts).

**Test: Owner state transitions (TEST-05)**

`describe('Owner State Transitions E2E')`:

1. `it('NONE -> GRACE: PUT /v1/agents/:id/owner sets owner address')`:
   - Create agent (no owner, NONE state)
   - PUT /v1/agents/:id/owner with masterAuth + body `{ address: ownerKeypair.address }` -> 200
   - GET /v1/agents/:id -> verify ownerAddress is set, ownerState = 'GRACE'

2. `it('GRACE -> LOCKED: ownerAuth action triggers markOwnerVerified')`:
   - Create agent with owner address but ownerVerified=false (GRACE)
   - Perform any ownerAuth-protected action (e.g., POST /v1/transactions/:id/approve or POST /v1/transactions/:id/reject with ownerAuth headers)
   - Verify agent ownerVerified becomes true (LOCKED state) in DB
   - Alternatively: if no APPROVAL tx exists, use a direct API call that triggers ownerAuth middleware (the test can check the DB directly after ownerAuth succeeds)

3. `it('LOCKED: PUT /v1/agents/:id/owner returns 409 OWNER_ALREADY_CONNECTED')`:
   - Create agent in LOCKED state (ownerAddress set, ownerVerified=true)
   - PUT /v1/agents/:id/owner with masterAuth + new address -> 409
   - Verify error code is OWNER_ALREADY_CONNECTED

4. `it('GRACE: owner can be changed before verification')`:
   - Create agent with owner address (GRACE)
   - PUT /v1/agents/:id/owner with masterAuth + different address -> 200
   - Verify ownerAddress updated to new address

5. `it('NONE: owner can be removed (no-op)')`:
   - Create agent without owner (NONE)
   - DELETE /v1/agents/:id/owner with masterAuth -> 200 (no-op)

**Test: APPROVAL -> DELAY downgrade (TEST-05)**

`describe('APPROVAL -> DELAY Downgrade E2E')`:

6. `it('APPROVAL downgraded to DELAY when no owner is connected')`:
   - Create agent WITHOUT owner address (NONE state)
   - Create SPENDING_LIMIT policy where the test amount triggers APPROVAL tier
   - POST /v1/transactions/send with session token and high amount -> 201
   - Wait for async pipeline to process
   - Verify transaction in DB: tier should be 'DELAY' (not 'APPROVAL'), status should be QUEUED
   - Optionally verify metadata contains downgrade event

7. `it('APPROVAL NOT downgraded when owner IS connected')`:
   - Create agent WITH owner address (GRACE or LOCKED state)
   - Same SPENDING_LIMIT policy and high amount
   - POST /v1/transactions/send -> 201
   - Verify transaction in DB: tier should be 'APPROVAL', status should be QUEUED
   - Verify pending_approvals record exists

**Implementation notes:**
- Use `createApp()` with `ownerLifecycle` dep for owner API routes
- For ownerAuth tests, import sodium-native via createRequire (same pattern as owner-auth.test.ts)
- Base58 encode helper inline (same as owner-auth.test.ts)
- Agent creation via direct DB insert (not API) to control initial state precisely
- Session creation via API (POST /v1/sessions with masterAuth) for realistic flow
- The `adapter` and `keyStore` mocks are needed for transaction pipeline
  </action>
  <verify>
Run `npx vitest run packages/daemon/src/__tests__/workflow-owner-e2e.test.ts` -- all tests pass.
  </verify>
  <done>
Owner NONE -> GRACE -> LOCKED transitions verified via API. LOCKED 409 rejection verified. GRACE -> change allowed verified. APPROVAL -> DELAY downgrade when no owner verified. APPROVAL kept when owner exists verified. All pass at API integration level.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (0 failures), total test count >= 455
2. Session lifecycle E2E covers full create -> use -> renew -> revoke -> rejection flow
3. DELAY E2E covers send -> QUEUED -> processExpired -> CONFIRMED + cancel path
4. APPROVAL E2E covers send -> QUEUED -> approve/reject/timeout
5. Owner E2E covers NONE -> GRACE -> LOCKED + downgrade
6. No regressions in existing tests
</verification>

<success_criteria>
- TEST-03 fully verified: session create -> use -> renew -> revoke lifecycle in single E2E test
- TEST-04 fully verified: DELAY auto-execute + cancel; APPROVAL approve + reject + timeout -- all at API level
- TEST-05 fully verified: Owner NONE -> GRACE -> LOCKED transitions + APPROVAL -> DELAY downgrade at API level
- Total test count >= 455 with 0 failures
- All 5 Phase 57 requirements (TEST-01 through TEST-05) covered
</success_criteria>

<output>
After completion, create `.planning/phases/57-integration-tests/57-02-SUMMARY.md`
</output>
