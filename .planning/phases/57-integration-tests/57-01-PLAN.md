---
phase: 57-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/auth-coverage-audit.test.ts
  - packages/daemon/src/__tests__/policy-engine-coverage-audit.test.ts
  - packages/cli/src/__tests__/helpers/daemon-harness.ts
  - packages/cli/src/__tests__/e2e-agent-wallet.test.ts
  - packages/cli/src/__tests__/e2e-transaction.test.ts
autonomous: true

must_haves:
  truths:
    - "All 3 auth middlewares have valid/invalid/expired test cases verified"
    - "DatabasePolicyEngine 4-tier + priority + TOCTOU tests all pass"
    - "CLI E2E tests (e2e-agent-wallet, e2e-transaction) pass with sessionAuth-aware harness"
  artifacts:
    - path: "packages/daemon/src/__tests__/auth-coverage-audit.test.ts"
      provides: "Gap tests for edge cases not covered by existing auth middleware tests"
    - path: "packages/daemon/src/__tests__/policy-engine-coverage-audit.test.ts"
      provides: "Gap tests for edge cases not covered by existing policy engine tests"
    - path: "packages/cli/src/__tests__/helpers/daemon-harness.ts"
      provides: "Updated E2E harness with jwtSecretManager, masterPasswordHash, sessionAuth support"
  key_links:
    - from: "packages/cli/src/__tests__/helpers/daemon-harness.ts"
      to: "packages/daemon/src/api/server.ts"
      via: "createApp({ jwtSecretManager, masterPasswordHash })"
      pattern: "createApp.*jwtSecretManager.*masterPasswordHash"
---

<objective>
Audit existing auth and policy engine unit tests for coverage gaps, add missing edge-case tests, and fix the CLI E2E test harness to work with the v1.2 auth system.

Purpose: Ensure TEST-01 (auth middleware) and TEST-02 (policy engine) requirements are fully covered, and fix the 3 pre-existing CLI E2E test failures caused by the sessionAuth integration gap in the E2E harness.
Output: Patched CLI E2E harness, gap-closure tests for auth/policy, all CLI E2E tests passing.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/daemon/src/__tests__/session-auth.test.ts
@packages/daemon/src/__tests__/master-auth.test.ts
@packages/daemon/src/__tests__/owner-auth.test.ts
@packages/daemon/src/__tests__/database-policy-engine.test.ts
@packages/cli/src/__tests__/helpers/daemon-harness.ts
@packages/cli/src/__tests__/e2e-agent-wallet.test.ts
@packages/cli/src/__tests__/e2e-transaction.test.ts
@packages/daemon/src/api/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CLI E2E harness for v1.2 auth + fix E2E tests</name>
  <files>
    packages/cli/src/__tests__/helpers/daemon-harness.ts
    packages/cli/src/__tests__/e2e-agent-wallet.test.ts
    packages/cli/src/__tests__/e2e-transaction.test.ts
  </files>
  <action>
The `startTestDaemonWithAdapter` function in daemon-harness.ts creates a server via `createApp()` but does NOT provide `jwtSecretManager` or `masterPasswordHash`, which are now required by the v1.2 auth middleware. This causes all protected routes to fail.

Fix daemon-harness.ts `startTestDaemonWithAdapter`:
1. Import `JwtSecretManager` from `@waiaas/daemon`
2. Import `argon2` for password hashing
3. After database init, create and initialize a `JwtSecretManager(db)` instance
4. Hash the masterPassword using `argon2.hash(masterPassword, { type: argon2.argon2id, memoryCost: 4096, timeCost: 2, parallelism: 1 })`
5. Pass both `jwtSecretManager` and `masterPasswordHash` to `createApp()`
6. Expose `masterPassword` on the ManualHarness type so E2E tests can construct auth headers

Update ManualHarness interface to include `masterPassword: string`.

Fix e2e-agent-wallet.test.ts:
- E-05 (POST /v1/agents): Add `X-Master-Password` header (masterAuth required for agent creation)
- E-06 (GET /v1/wallet/address): Since wallet routes require sessionAuth (not X-Agent-Id fallback per decision [52-02]), the test must first create a session, then use the JWT token. Add a helper function `createTestSession` that:
  1. POST /v1/sessions with masterAuth + agentId to get a JWT token
  2. Use `Authorization: Bearer {token}` for wallet/transaction endpoints
- E-07 (GET /v1/wallet/balance): Same as E-06, use session token instead of X-Agent-Id header.

Fix e2e-transaction.test.ts:
- E-08 (POST /v1/transactions/send): Replace `X-Agent-Id` header with `Authorization: Bearer {token}` from session
- E-09 (GET /v1/transactions/:id): Replace `X-Agent-Id` with session token auth
- Add session creation in beforeAll after agent creation

Important: The harness currently uses `masterPassword` string in createApp deps -- but auth middleware uses `masterPasswordHash`. The fix must hash the password and pass both `masterPasswordHash` (for auth) AND `masterPassword` (for keystore -- already done).
  </action>
  <verify>
Run `npx vitest run packages/cli/src/__tests__/e2e-agent-wallet.test.ts packages/cli/src/__tests__/e2e-transaction.test.ts` -- all 5 E2E tests (E-05 through E-09) pass.
  </verify>
  <done>
CLI E2E harness provides jwtSecretManager + masterPasswordHash to createApp, all E2E tests use proper auth headers (masterAuth for admin, sessionAuth for wallet/tx), 5 CLI E2E tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit and add gap-closure tests for auth + policy engine</name>
  <files>
    packages/daemon/src/__tests__/auth-coverage-audit.test.ts
    packages/daemon/src/__tests__/policy-engine-coverage-audit.test.ts
  </files>
  <action>
**Auth coverage audit** -- existing tests cover the main paths well. Add edge-case gap tests in a NEW file `auth-coverage-audit.test.ts`:

1. **sessionAuth edge cases** (not covered by existing 8 tests):
   - Session exists but DB `expires_at` is in the past (JWT is valid but session expired in DB) -> should return 401
   - Multiple sequential requests with the same valid token -> should all succeed (no one-time-use)
   - Token with valid JWT structure but unknown session ID -> SESSION_NOT_FOUND

2. **masterAuth edge cases** (existing 3 tests cover core paths; add):
   - Empty string X-Master-Password header -> 401
   - Very long password string -> 401 (not crash)

3. **ownerAuth edge cases** (existing 6 tests cover core paths; add):
   - Missing only X-Owner-Signature (other headers present) -> 401
   - Empty X-Owner-Message -> 401

**Policy engine coverage audit** -- existing 17 tests are thorough. Add edge-case gap tests in a NEW file `policy-engine-coverage-audit.test.ts`:

1. **Boundary value tests** (not explicitly tested):
   - Amount exactly equal to instant_max -> should be INSTANT (<=, not <)
   - Amount exactly equal to notify_max -> should be NOTIFY
   - Amount exactly equal to delay_max -> should be DELAY

2. **Multiple policy types combined**:
   - WHITELIST + SPENDING_LIMIT together: whitelisted address with high amount -> WHITELIST allows, SPENDING_LIMIT determines tier
   - WHITELIST + SPENDING_LIMIT: non-whitelisted address -> denied regardless of amount

3. **Edge case: zero amount transaction**:
   - Amount = '0' -> should be INSTANT (below all thresholds)

Both test files should follow the same pattern as existing tests (in-memory SQLite, beforeEach/afterEach setup/teardown).
  </action>
  <verify>
Run `npx vitest run packages/daemon/src/__tests__/auth-coverage-audit.test.ts packages/daemon/src/__tests__/policy-engine-coverage-audit.test.ts` -- all new gap tests pass.
  </verify>
  <done>
Auth middleware gap tests cover: session DB expiry, repeated valid requests, empty/long passwords, partial owner headers. Policy engine gap tests cover: boundary values at exact thresholds, combined policy types, zero amount. All pass.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (0 failures), test count increases by ~15-20 over previous 423 passing
2. CLI E2E tests (e2e-agent-wallet, e2e-transaction) pass with auth headers
3. No regressions in existing 423 passing tests
</verification>

<success_criteria>
- TEST-01 fully verified: all 3 auth middlewares have valid/invalid/expired/edge cases tested
- TEST-02 fully verified: 4-tier classification, priority, TOCTOU, boundary values tested
- CLI E2E harness fixed: jwtSecretManager + masterPasswordHash injected, auth headers in requests
- All 5 CLI E2E tests (E-05 to E-09) pass
- Total test count >= 440 with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/57-integration-tests/57-01-SUMMARY.md`
</output>
