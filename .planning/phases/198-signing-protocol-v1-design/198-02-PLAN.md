---
phase: 198-signing-protocol-v1-design
plan: 02
type: execute
wave: 2
depends_on:
  - 198-01
files_modified:
  - internal/design/73-signing-protocol-v1.md
autonomous: true
requirements:
  - PROTO-03
  - PROTO-04

must_haves:
  truths:
    - "ntfy 요청 토픽(waiaas-sign-{walletId})과 응답 토픽(waiaas-response-{requestId})의 네이밍 규칙이 확정되어 있다"
    - "ntfy 보안 모델(requestId UUID v7 기반 1회용 토픽, 만료 정책, self-hosted 옵션)이 명시되어 있다"
    - "ntfy 채널의 E2E 플로우(데몬 publish → 지갑 앱 수신 → 서명 → 응답 publish → 데몬 subscribe)가 단계별로 확정되어 있다"
    - "Telegram 인라인 버튼(유니버셜 링크 포함)과 공유 인텐트 응답(/sign_response) 플로우가 확정되어 있다"
    - "Telegram PC 시나리오(웹페이지 QR 코드 → 모바일 스캔)와 모바일 시나리오(유니버셜 링크 → 앱 직접 열림)가 모두 확정되어 있다"
    - "요청 만료 정책(기본 30분, expiresAt 기반)과 만료 후 처리(SIGN_REQUEST_EXPIRED 에러)가 명시되어 있다"
  artifacts:
    - path: "internal/design/73-signing-protocol-v1.md"
      provides: "Signing Protocol v1 설계서 — 전체 완성본"
      contains: "ntfy 채널 프로토콜"
  key_links:
    - from: "internal/design/73-signing-protocol-v1.md"
      to: "internal/objectives/m26-01-wallet-signing-sdk.md"
      via: "E2E 플로우 formalization"
      pattern: "waiaas-sign-|waiaas-response-|sign_response"
---

<objective>
doc 73의 나머지 섹션(ntfy 채널 프로토콜, Telegram 채널 프로토콜, 만료/재시도 정책, 보안 모델, 에러 코드, 기술 결정 요약)을 완성하여 설계 문서를 확정한다.

Purpose: ntfy와 Telegram 전송 채널의 상세 프로토콜과 보안 모델을 확정하여, m26-01 구현 시 NtfySigningChannel/TelegramSigningChannel 컴포넌트의 입력으로 사용할 수 있게 한다.
Output: `internal/design/73-signing-protocol-v1.md` 완성본 (Section 7-12 추가)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/objectives/m26-00-wallet-sdk-design.md
@internal/objectives/m26-01-wallet-signing-sdk.md
@.planning/phases/198-signing-protocol-v1-design/198-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ntfy 채널 프로토콜 + Telegram 채널 프로토콜 섹션 작성</name>
  <files>internal/design/73-signing-protocol-v1.md</files>
  <action>
Plan 01에서 생성한 doc 73의 Section 7~8 자리(주석으로 비워둔 부분)를 채운다.

**Section 7: ntfy 채널 프로토콜**

7.1 토픽 네이밍 규칙:
- 요청 토픽: `waiaas-sign-{walletId}` — 데몬이 서명 요청을 publish, 지갑 앱이 subscribe
- 응답 토픽: `waiaas-response-{requestId}` — 지갑 앱이 서명 응답을 publish, 데몬이 subscribe
- walletId: 지갑 UUID (DB PK)
- requestId: 요청별 UUID v7 (1회용, 추측 불가)

7.2 요청 publish 프로토콜:
- HTTP 메서드: `POST https://{ntfy_server}/{topic}`
- Content-Type: `application/json`
- ntfy 헤더: `Title: WAIaaS Sign Request`, `Priority: 5` (urgent), `Tags: waiaas,sign`
- Body: SignRequest JSON
- ntfy Actions 헤더: `view, 지갑에서 승인하기, {universalLinkUrl}` — 모바일 알림에 액션 버튼 표시

7.3 응답 subscribe 프로토콜:
- 데몬이 `GET https://{ntfy_server}/{responseTopic}/sse` 로 SSE 구독 시작
- 구독 시작 시점: SignRequest publish 직후
- 구독 종료 조건: (1) SignResponse 수신 (2) expiresAt 도달 (3) 에러 발생
- SSE 메시지 수신 시: base64url 디코딩 → JSON 파싱 → SignResponse Zod 검증

7.4 응답 publish (지갑 앱 측):
- HTTP 메서드: `POST https://{ntfy_server}/{responseTopic}`
- Body: base64url(JSON.stringify(SignResponse))
- 1회 publish 후 토픽 사용 종료

7.5 E2E 시퀀스 다이어그램:
- m26-01의 "ntfy 직접 푸시 모델" E2E 플로우를 5단계로 정리
- 각 단계별 HTTP 요청/응답 상세 포함

7.6 self-hosted ntfy 지원:
- SignRequest.responseChannel.serverUrl 필드로 self-hosted URL 전달
- 기본값: https://ntfy.sh (공개 서버)
- 데몬의 기존 `[notifications] ntfy_server` 설정과 공유

**Section 8: Telegram 채널 프로토콜**

8.1 요청 전송 (Bot API):
- `sendMessage` API로 Owner chatId에 메시지 전송
- 메시지 본문: 트랜잭션 요약 (To, Amount, Type, Network)
- InlineKeyboardMarkup: `[{ text: "지갑에서 승인하기", url: universalLinkUrl }]`
- 유니버셜 링크 URL은 Section 6의 구조를 따름

8.2 모바일 시나리오:
- Owner가 Telegram 알림 탭 → 인라인 버튼 탭 → 유니버셜 링크 → 지갑 앱 열림
- 지갑 앱에서 SignRequest 파싱 → 서명 UI → 승인/거부
- 응답: Telegram 공유 인텐트 → WAIaaS Bot 채팅으로 `/sign_response {base64url(SignResponse)}` 전송
- Owner는 Telegram 전환 후 [보내기] 1탭

8.3 PC 시나리오:
- Owner가 PC Telegram 데스크탑에서 인라인 버튼 클릭 → 브라우저에서 지갑 웹페이지 열림
- 지갑 웹페이지: SignRequest 표시 + QR 코드 생성 (QR 내용 = 동일 유니버셜 링크 URL)
- Owner가 모바일로 QR 스캔 → 지갑 앱 열림 → 서명 → 응답 전송 (모바일 시나리오와 동일)

8.4 응답 수신 (Bot Long Polling):
- 기존 Telegram Bot의 Long Polling 핸들러에 `/sign_response` 명령어 추가
- 메시지 파싱: `/sign_response {base64url}` → base64url 디코딩 → SignResponse 검증
- chatId로 Owner 식별 + signerAddress로 이중 확인

8.5 Telegram 공유 인텐트 URL 구조:
- Android: `tg://msg?text=/sign_response {base64url}&to={botUsername}`
- iOS: `https://t.me/{botUsername}?text=/sign_response {base64url}`
- fallback: clipboard에 복사 후 사용자가 수동 붙여넣기 안내

8.6 E2E 시퀀스 다이어그램:
- m26-01의 "Telegram 메신저 모델" E2E 플로우를 5단계로 정리
  </action>
  <verify>Section 7(ntfy)과 Section 8(Telegram)이 모두 작성되어 있고, 토픽 네이밍, HTTP 메서드, 헤더, E2E 플로우가 구체적으로 명시되어 있는지 확인</verify>
  <done>ntfy 요청/응답 토픽 프로토콜과 Telegram 인라인 버튼 + 공유 인텐트 응답 플로우가 PC/모바일 양쪽 시나리오에서 확정되어 있다</done>
</task>

<task type="auto">
  <name>Task 2: 만료 정책 + 보안 모델 + 에러 코드 + 기술 결정 요약 작성</name>
  <files>internal/design/73-signing-protocol-v1.md</files>
  <action>
doc 73의 Section 9~12를 작성하여 문서를 완성한다. 그리고 Plan 01에서 남겨둔 `<!-- Plan 02에서 작성 -->` 주석을 모두 제거한다.

**Section 9: 요청 만료 + 재시도 정책**
- 기본 만료 시간: 30분 (SettingsService `signing_sdk.request_expiry_min`)
- expiresAt 계산: `new Date(Date.now() + expiryMin * 60 * 1000).toISOString()`
- 만료 확인 시점: (1) 데몬이 SignResponse 수신 시, (2) ntfy SSE 구독 타임아웃 시
- 만료 후 처리:
  - 데몬: SignResponse 수신해도 SIGN_REQUEST_EXPIRED 에러 → 트랜잭션 상태 유지 (PENDING_APPROVAL)
  - 지갑 앱: expiresAt 확인 → 만료 시 서명 UI 비활성 + 안내 메시지
- 재시도 정책:
  - 자동 재시도 없음 (1회성 요청 원칙)
  - 만료 후 새 트랜잭션은 새 SignRequest 생성 (새 requestId)
  - Admin이 PENDING_APPROVAL 트랜잭션을 수동 재승인 요청 가능 (기존 approve API)

**Section 10: 보안 모델**
10.1 위협 분석:
- 토픽 스니핑: 공격자가 요청 토픽(waiaas-sign-{walletId})을 구독하여 서명 요청 엿보기
  - 대응: walletId는 UUID v7 (추측 어려움). 요청 자체는 공개 데이터 (서명 능력 없으면 무해)
- 위조 응답: 공격자가 응답 토픽에 가짜 SignResponse publish
  - 대응: signerAddress 서명 검증 (ownerAuth: Ed25519/SIWE). Owner 개인키 없이는 유효한 서명 생성 불가
- 리플레이 공격: 과거 SignResponse를 재전송
  - 대응: requestId 매칭 (1회용). 이미 처리된 requestId는 거부. expiresAt 확인
- 중간자 공격: ntfy 서버와의 통신 가로채기
  - 대응: HTTPS 강제. self-hosted ntfy 사용 시 TLS 인증서 필수

10.2 ntfy 토픽 보안:
- 응답 토픽: `waiaas-response-{requestId}` — UUID v7 기반으로 추측 불가 (122비트 엔트로피)
- 요청 토픽: `waiaas-sign-{walletId}` — walletId는 UUID v7이지만 장기 사용. self-hosted ntfy 사용 시 토픽 인증(Authorization 헤더) 추가 가능
- ntfy 서버 신뢰: 공개 ntfy.sh 사용 시 ntfy 운영자 신뢰 필요. 민감 환경에서는 self-hosted 권장

10.3 서명 검증 플로우:
- ownerAuth 재사용 (v1.2에서 구현 완료)
- EVM: ethers.verifyMessage(message, signature) === ownerAddress
- Solana: nacl.sign.detached.verify(message, signature, publicKey)
- 검증 실패 시: INVALID_SIGNATURE 에러, 트랜잭션 상태 변경 없음

10.4 향후 보안 강화 옵션 (범위 외):
- ntfy 토픽 인증 (Authorization 헤더 기반)
- E2E 암호화 (SignRequest/SignResponse를 Owner 공개키로 암호화)
- 응답 토픽 TTL (ntfy 서버 설정으로 자동 삭제)

**Section 11: 에러 코드**
기존 WAIaaS 에러 코드 체계(ChainError → WAIaaSError 변환)에 서명 프로토콜 에러를 추가한다:

| 에러 코드 | HTTP | 설명 |
|-----------|------|------|
| SIGN_REQUEST_EXPIRED | 408 | 서명 요청 만료 (expiresAt 초과) |
| SIGN_REQUEST_NOT_FOUND | 404 | requestId에 해당하는 요청 없음 |
| SIGN_REQUEST_ALREADY_PROCESSED | 409 | 이미 처리된 서명 요청 |
| INVALID_SIGN_RESPONSE | 400 | SignResponse Zod 검증 실패 |
| INVALID_SIGNATURE | 401 | 서명 검증 실패 (ownerAuth) |
| SIGNER_ADDRESS_MISMATCH | 403 | signerAddress와 Owner 등록 주소 불일치 |
| SIGNING_SDK_DISABLED | 403 | signing_sdk.enabled = false |
| WALLET_NOT_REGISTERED | 404 | WalletLinkRegistry에 등록되지 않은 지갑 |

**Section 12: 기술 결정 요약**
m26-01의 기술 결정 사항 표(11개)를 그대로 포함한다. 각 결정에 대해:
- 결정 번호, 항목, 선택지, 결정 근거

마지막으로 문서 하단에 메타데이터를 추가한다:
```
---
*문서 번호: 73*
*생성일: 2026-02-19*
*선행 문서: 35(알림 아키텍처), 34(Owner 지갑 연결), 37(REST API)*
*관련 마일스톤: m26-00(설계), m26-01(구현)*
*범위: WAIaaS Signing Protocol v1 스키마 + 전송 채널 + 보안 모델*
```
  </action>
  <verify>Section 9~12가 모두 작성되어 있고, `<!-- Plan 02에서 작성 -->` 주석이 남아있지 않으며, 에러 코드 표와 기술 결정 요약이 포함되어 있는지 확인. 전체 문서가 12개 섹션 완성본인지 확인</verify>
  <done>doc 73이 12개 섹션 완성본으로, ntfy/Telegram 채널 프로토콜, 만료 정책, 보안 모델, 에러 코드가 모두 확정되어 있다. Signing Protocol v1 설계서가 m26-01 구현의 입력으로 사용 가능한 상태이다</done>
</task>

</tasks>

<verification>
- [ ] Section 7~12가 모두 작성되어 있다
- [ ] `<!-- Plan 02에서 작성 -->` 주석이 모두 제거되어 있다
- [ ] ntfy 요청 토픽(waiaas-sign-{walletId}) 네이밍이 명시되어 있다
- [ ] ntfy 응답 토픽(waiaas-response-{requestId}) 네이밍이 명시되어 있다
- [ ] ntfy publish/subscribe HTTP 메서드와 헤더가 명시되어 있다
- [ ] Telegram 인라인 버튼 구조(InlineKeyboardMarkup)가 명시되어 있다
- [ ] Telegram PC 시나리오(QR 코드)가 명시되어 있다
- [ ] Telegram 모바일 시나리오(유니버셜 링크)가 명시되어 있다
- [ ] 공유 인텐트 URL(Android/iOS)이 명시되어 있다
- [ ] 만료 정책(30분 기본, expiresAt)이 명시되어 있다
- [ ] 보안 위협 분석(토픽 스니핑, 위조 응답, 리플레이, 중간자)이 포함되어 있다
- [ ] 에러 코드 8개가 표로 정리되어 있다
- [ ] 기술 결정 요약(11개 결정)이 포함되어 있다
- [ ] 문서 하단 메타데이터가 포함되어 있다
</verification>

<success_criteria>
PROTO-03 완료: ntfy 요청/응답 토픽 네이밍 규칙과 보안 모델(requestId 기반 1회용 토픽, 만료 정책)이 확정됨
PROTO-04 완료: Telegram 인라인 버튼 + 공유 인텐트 응답 플로우가 PC/모바일 양쪽 시나리오에서 확정됨
전체 문서 완성: doc 73이 12개 섹션 완성본으로, Phase 199/200/201의 입력으로 사용 가능
</success_criteria>

<output>
After completion, create `.planning/phases/198-signing-protocol-v1-design/198-02-SUMMARY.md`
</output>
