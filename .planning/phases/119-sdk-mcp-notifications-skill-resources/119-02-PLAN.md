---
phase: 119-sdk-mcp-notifications-skill-resources
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/errors/error-codes.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/daemon/src/api/routes/skills.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/server.ts
  - packages/mcp/src/resources/skills.ts
  - packages/mcp/src/server.ts
  - packages/mcp/src/__tests__/server.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /v1/skills/transactions가 200 + {name, content} JSON을 반환한다"
    - "GET /v1/skills/invalid가 404 SKILL_NOT_FOUND 에러를 반환한다"
    - "GET /v1/skills/:name은 인증 없이 접근 가능하다 (public)"
    - "MCP resources/list에 waiaas://skills/{name} URI로 5개 스킬이 나열된다"
    - "MCP resources/read로 waiaas://skills/transactions를 조회하면 text/markdown 내용이 반환된다"
  artifacts:
    - path: "packages/daemon/src/api/routes/skills.ts"
      provides: "GET /v1/skills/:name 라우트"
      contains: "skillsRoutes"
    - path: "packages/mcp/src/resources/skills.ts"
      provides: "waiaas://skills/{name} ResourceTemplate 리소스"
      contains: "registerSkillResources"
  key_links:
    - from: "packages/mcp/src/resources/skills.ts"
      to: "/v1/skills/{name}"
      via: "apiClient.get"
      pattern: "apiClient\\.get.*skills"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/skills.ts"
      via: "skillsRoutes() 등록"
      pattern: "skillsRoutes"
    - from: "packages/mcp/src/server.ts"
      to: "packages/mcp/src/resources/skills.ts"
      via: "registerSkillResources import + 호출"
      pattern: "registerSkillResources"
---

<objective>
MCP 스킬 리소스 시스템을 구현하여 AI 에이전트가 waiaas://skills/{name} URI로 5개 API 스킬 파일(quickstart, wallet, transactions, policies, admin)을 in-context로 참조할 수 있게 한다.

Purpose: AI 에이전트가 MCP resources/list + resources/read로 WAIaaS API 문서를 자체 참조
Output: daemon GET /v1/skills/:name 엔드포인트 (public) + MCP ResourceTemplate 리소스 5개
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/routes/utils.ts
@packages/daemon/src/api/routes/index.ts
@packages/daemon/src/api/server.ts
@packages/mcp/src/resources/system-status.ts
@packages/mcp/src/server.ts
@packages/mcp/src/api-client.ts
@packages/core/src/errors/error-codes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SKILL_NOT_FOUND 에러 코드 + GET /v1/skills/:name 라우트</name>
  <files>
    packages/core/src/errors/error-codes.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/daemon/src/api/routes/skills.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
**에러 코드 추가** (`packages/core/src/errors/error-codes.ts`):
- `SKILL_NOT_FOUND` 에러 코드 추가 (기존 `RESOURCE_NOT_FOUND`가 없으므로 도메인 특화 코드 사용)
- SYSTEM 도메인 뒤에 추가: `{ code: 'SKILL_NOT_FOUND', domain: 'SYSTEM', httpStatus: 404, retryable: false, message: 'Skill not found' }`

**i18n 에러 메시지** (`packages/core/src/i18n/en.ts`, `ko.ts`):
- en.ts errors에 `SKILL_NOT_FOUND: 'Skill not found'` 추가
- ko.ts errors에 `SKILL_NOT_FOUND: '스킬을 찾을 수 없습니다'` 추가
- 에러 코드 수가 73 -> 74로 증가하면 Messages 인터페이스의 Record<ErrorCode, string>이 자동 검증

**스킬 라우트** (`packages/daemon/src/api/routes/skills.ts` -- NEW):
- `utils.ts` 패턴을 정확히 따르되 DB/adapter 의존성 없음 (stateless 파일 서빙)
- `import { readFileSync, existsSync } from 'node:fs'` + `import { resolve } from 'node:path'`
- `SKILLS_DIR = resolve(process.cwd(), 'skills')` (process.cwd() 기반 -- 로컬 데몬은 프로젝트 루트에서 실행)
- `VALID_SKILLS = ['quickstart', 'wallet', 'transactions', 'policies', 'admin'] as const`
- `createRoute({ method: 'get', path: '/skills/{name}', tags: ['Skills'], summary: 'Get skill file content', ... })`
- request params: `z.object({ name: z.string() })`
- 200 response: `z.object({ name: z.string(), content: z.string() })`
- error responses: `buildErrorResponses(['SKILL_NOT_FOUND'])`
- handler: name이 VALID_SKILLS에 없으면 `throw new WAIaaSError('SKILL_NOT_FOUND', { message: "Skill '${name}' not found" })`
- 파일이 없으면 동일 에러 (existsSync 체크)
- 정상: `readFileSync(filePath, 'utf-8')` -> `c.json({ name, content }, 200)`
- `export function skillsRoutes(): OpenAPIHono { ... }` (utils 패턴과 동일)

**routes/index.ts**:
- `export { skillsRoutes } from './skills.js';` 추가

**server.ts 등록**:
- `import { skillsRoutes } from './routes/skills.js';` 추가
- nonceRoutes() 등록 바로 뒤 (public 라우트 영역)에 `app.route('/v1', skillsRoutes());` 추가
- 주의: skillsRoutes는 인증 불필요 (nonce/health와 동일한 public 라우트). sessionAuth `/v1/utils/*` 패턴에 매칭되지 않도록 `/v1/skills/*`는 별도 경로이므로 문제 없음.
  </action>
  <verify>
    cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run build --filter=@waiaas/core --filter=@waiaas/daemon 2>&1 | tail -5
  </verify>
  <done>
    GET /v1/skills/:name 라우트가 인증 없이 5개 스킬 파일을 JSON으로 서빙한다. SKILL_NOT_FOUND 에러 코드가 @waiaas/core에 등록되고 i18n 메시지 동기화 완료. 빌드 성공.
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP 스킬 리소스 (ResourceTemplate) + 테스트</name>
  <files>
    packages/mcp/src/resources/skills.ts
    packages/mcp/src/server.ts
    packages/mcp/src/__tests__/server.test.ts
  </files>
  <action>
**MCP 스킬 리소스** (`packages/mcp/src/resources/skills.ts` -- NEW):
- `import { ResourceTemplate } from '@modelcontextprotocol/sdk/server/mcp.js'`
- `import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'`
- `import { type ApiClient, toResourceResult } from '../api-client.js'`
- `import { type WalletContext, withWalletPrefix } from '../server.js'`
- `SKILL_NAMES = ['quickstart', 'wallet', 'transactions', 'policies', 'admin'] as const`
- `export function registerSkillResources(server: McpServer, apiClient: ApiClient, walletContext?: WalletContext): void { ... }`
- ResourceTemplate 생성: `new ResourceTemplate('waiaas://skills/{name}', { list: async () => ({ resources: SKILL_NAMES.map(name => ({ uri: 'waiaas://skills/${name}', name: '${name} skill', description: withWalletPrefix('API reference: ${name}', walletContext?.walletName), mimeType: 'text/markdown' })) }) })`
- `server.resource('API Skills', skillTemplate, { description: withWalletPrefix('WAIaaS API skill reference files', walletContext?.walletName), mimeType: 'text/markdown' }, async (uri, { name }) => { ... })`
- handler: `const result = await apiClient.get('/v1/skills/${name as string}')`
- result가 ok이면: `{ contents: [{ uri: uri.href, text: (result.data as { content: string }).content, mimeType: 'text/markdown' }] }`
- result가 에러이면: `toResourceResult(uri.href, result)` (기존 system-status 패턴)

**MCP server.ts 등록**:
- `import { registerSkillResources } from './resources/skills.js';` 추가
- `registerSystemStatus` 뒤에 `registerSkillResources(server, apiClient, walletContext);` 호출
- 주석 갱신: "Register 3 resources" -> "Register 4 resource groups (3 static + 1 template)"

**MCP 테스트** (`packages/mcp/src/__tests__/server.test.ts`):
- `mockResource.toHaveBeenCalledTimes(3)` -> `toHaveBeenCalledTimes(4)` 갱신
- 기존 리소스 3개 + skills ResourceTemplate 1개 = 4회 resource() 호출
- 리소스 description 프리픽스 테스트도 4개 리소스에 대해 검증
  </action>
  <verify>
    cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run build --filter=@waiaas/mcp 2>&1 | tail -5
    npx vitest run packages/mcp/src/__tests__/server.test.ts --reporter=verbose 2>&1 | tail -20
  </verify>
  <done>
    MCP resources/list에 waiaas://skills/{name} URI로 5개 스킬이 나열되고, resources/read로 text/markdown 내용을 조회할 수 있다. server.test.ts에서 4개 리소스 그룹 등록 검증. 빌드 + 테스트 통과.
  </done>
</task>

</tasks>

<verification>
- `npx turbo run build --filter=@waiaas/core --filter=@waiaas/daemon --filter=@waiaas/mcp` 성공
- `npx vitest run packages/mcp/src/__tests__/server.test.ts` 통과 (13 tools, 4 resource groups)
- grep 확인: `skillsRoutes` in server.ts, `registerSkillResources` in server.ts, `SKILL_NOT_FOUND` in error-codes.ts
- GET /v1/skills/transactions가 200 반환하는지 통합 테스트 또는 수동 확인
</verification>

<success_criteria>
1. GET /v1/skills/:name이 5개 유효 스킬에 대해 200 + {name, content} JSON을 반환하고, 유효하지 않은 이름에 404 SKILL_NOT_FOUND를 반환한다
2. skills 라우트는 인증 없이 접근 가능하다 (public)
3. MCP ResourceTemplate이 waiaas://skills/{name} URI 패턴으로 5개 스킬을 list하고 read할 수 있다
4. 빌드 성공 + 모든 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/119-sdk-mcp-notifications-skill-resources/119-02-SUMMARY.md`
</output>
