---
phase: 119-sdk-mcp-notifications-skill-resources
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/pipeline/stages.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - skills/transactions.skill.md
autonomous: true

must_haves:
  truths:
    - "POLICY_VIOLATION 알림 vars에 policyType, tokenAddress, contractAddress, adminLink 필드가 포함된다"
    - "i18n POLICY_VIOLATION 템플릿이 policyType과 adminLink를 포함한다"
    - "transactions.skill.md에 POST /v1/transactions/sign 섹션이 존재한다"
    - "transactions.skill.md에 sign-only API 요청/응답 예제와 에러 코드가 포함된다"
  artifacts:
    - path: "packages/daemon/src/pipeline/stages.ts"
      provides: "extractPolicyType 헬퍼 + POLICY_VIOLATION notify vars 확장"
      contains: "extractPolicyType"
    - path: "skills/transactions.skill.md"
      provides: "sign-only API 문서화 섹션"
      contains: "/v1/transactions/sign"
  key_links:
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "packages/core/src/i18n/en.ts"
      via: "notify vars -> template interpolation"
      pattern: "policyType.*tokenAddress.*contractAddress.*adminLink"
---

<objective>
POLICY_VIOLATION 알림을 보강하여 contractAddress, tokenAddress, policyType, adminLink 필드를 포함시키고, transactions.skill.md를 sign-only API + calldata encoding 내용으로 업데이트한다.

Purpose: 정책 거부 시 관리자가 즉시 원인을 파악하고 Admin UI로 이동할 수 있게 하며, AI 에이전트가 최신 API 문서를 참조할 수 있게 함
Output: stages.ts 알림 vars 확장, i18n 템플릿 업데이트, transactions.skill.md 업데이트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/pipeline/stages.ts
@packages/core/src/i18n/en.ts
@packages/core/src/i18n/ko.ts
@skills/transactions.skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: POLICY_VIOLATION 알림 보강 (extractPolicyType + notify vars 확장)</name>
  <files>
    packages/daemon/src/pipeline/stages.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
  </files>
  <action>
**extractPolicyType 헬퍼 추가** (`packages/daemon/src/pipeline/stages.ts`):
- 파일 내 private 함수로 추가 (export하지 않음), stage3Policy 근처
- `function extractPolicyType(reason: string | undefined): string`
- 매핑 규칙:
  - `'not in allowed list'` 또는 `'Token transfer not allowed'` -> `'ALLOWED_TOKENS'`
  - `'not whitelisted'` 또는 `'Contract calls disabled'` -> `'CONTRACT_WHITELIST'`
  - `'Method not whitelisted'` -> `'METHOD_WHITELIST'`
  - `'not in approved list'` 또는 `'Token approvals disabled'` -> `'APPROVED_SPENDERS'`
  - `'not in whitelist'` 또는 `'not in allowed addresses'` -> `'WHITELIST'`
  - `'not in allowed networks'` -> `'ALLOWED_NETWORKS'`
  - `'exceeds limit'` 또는 `'Unlimited token approval'` -> `'APPROVE_AMOUNT_LIMIT'`
  - `'Spending limit'` -> `'SPENDING_LIMIT'`
  - 매칭 없음 -> `''` (빈 문자열)

**POLICY_VIOLATION notify vars 확장** (stages.ts L292-297):
- 기존:
  ```
  void ctx.notificationService?.notify('POLICY_VIOLATION', ctx.walletId, {
    reason: evaluation.reason ?? 'Policy denied',
    amount: getRequestAmount(ctx.request),
    to: getRequestTo(ctx.request),
  }, { txId: ctx.txId });
  ```
- 보강:
  ```
  void ctx.notificationService?.notify('POLICY_VIOLATION', ctx.walletId, {
    reason: evaluation.reason ?? 'Policy denied',
    amount: getRequestAmount(ctx.request),
    to: getRequestTo(ctx.request),
    policyType: extractPolicyType(evaluation.reason),
    tokenAddress: ctx.request.tokenAddress ?? '',
    contractAddress: ctx.request.contractAddress ?? '',
    adminLink: '/admin/policies',
  }, { txId: ctx.txId });
  ```
- `ctx.request`는 `TransactionParam` 타입으로 `tokenAddress`, `contractAddress` 필드가 존재 (undefined이면 빈 문자열)

**i18n 템플릿 업데이트**:
- `en.ts` POLICY_VIOLATION:
  - 현재: `body: 'Wallet {walletId} policy violation: {reason}'`
  - 변경: `body: 'Wallet {walletId} policy violation: {reason}. Policy: {policyType}. Manage: {adminLink}'`
  - 주의: tokenAddress/contractAddress는 body에 포함하지 않음 (빈 값일 경우 어색한 출력 방지). 이 필드들은 vars로 전달되어 notification payload의 metadata로 사용됨.
- `ko.ts` POLICY_VIOLATION:
  - 현재: `body: '지갑 {walletId} 정책 위반: {reason}'`
  - 변경: `body: '지갑 {walletId} 정책 위반: {reason}. 정책: {policyType}. 관리: {adminLink}'`
  </action>
  <verify>
    cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run build --filter=@waiaas/core --filter=@waiaas/daemon 2>&1 | tail -5
    npx vitest run packages/daemon/src/__tests__/pipeline-stages.test.ts --reporter=verbose 2>&1 | tail -20
  </verify>
  <done>
    POLICY_VIOLATION 알림에 policyType, tokenAddress, contractAddress, adminLink vars가 포함된다. i18n 템플릿에 policyType + adminLink가 표시된다. 빌드 + 기존 테스트 통과.
  </done>
</task>

<task type="auto">
  <name>Task 2: transactions.skill.md 업데이트 (sign-only API 섹션)</name>
  <files>
    skills/transactions.skill.md
  </files>
  <action>
**transactions.skill.md 업데이트**:
- 기존 encode-calldata 섹션(Phase 118에서 추가됨) 앞에 sign-only API 섹션을 추가

추가할 내용 (새 섹션):

```markdown
## Sign External Transaction (sign-only)

외부 dApp이 빌드한 unsigned 트랜잭션을 정책 평가 후 서명하여 반환합니다. 블록체인에 제출하지 않습니다.

### POST /v1/transactions/sign

**Request Body:**
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| transaction | string | Yes | Unsigned transaction (base64 for Solana, 0x-hex for EVM) |
| network | string | No | Target network (defaults to wallet default) |

**Response (200):**
| Field | Type | Description |
|-------|------|-------------|
| id | string | Transaction record ID |
| signedTransaction | string | Signed transaction bytes (same encoding as input) |
| txHash | string/null | Transaction hash (null if not computable before submission) |
| operations | array | Parsed operations from the unsigned tx |
| policyResult | object | { tier: string } - policy evaluation tier |

**Operations object:**
| Field | Type | Description |
|-------|------|-------------|
| type | string | NATIVE_TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, UNKNOWN |
| to | string/null | Destination address |
| amount | string/null | Amount in smallest unit |
| token | string/null | Token address (for TOKEN_TRANSFER/APPROVE) |

**Example (Solana):**
```json
POST /v1/transactions/sign
{
  "transaction": "AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABhbG9uZQ=="
}
```

**Example (EVM):**
```json
POST /v1/transactions/sign
{
  "transaction": "0x02f86c0180843b9aca00850ba43b7400825208940x...",
  "network": "polygon-mainnet"
}
```

**Error Codes:**
| Code | Status | Description |
|------|--------|-------------|
| INVALID_TRANSACTION | 400 | Raw transaction parsing failed |
| WALLET_NOT_SIGNER | 400 | Wallet is not a signer in the transaction |
| CHAIN_ID_MISMATCH | 400 | Transaction chain ID doesn't match network |
| POLICY_DENIED | 403 | Policy evaluation denied one or more operations |
| UNSUPPORTED_TX_TYPE | 400 | Transaction type not supported |

**SDK Usage:**
- TypeScript: `await client.signTransaction({ transaction: '...', network: 'polygon-mainnet' })`
- Python: `await client.sign_transaction('...', network='polygon-mainnet')`
- MCP tool: `sign_transaction` with `transaction` + optional `network`

**Notes:**
- DELAY/APPROVAL tier 정책에 해당하는 요청은 즉시 거부됩니다 (동기 API 비호환)
- 서명 결과는 transactions 테이블에 type='SIGN', status='SIGNED'로 기록됩니다
- reserved_amount에 누적되어 SPENDING_LIMIT 이중 지출이 방지됩니다
```

- 섹션 번호를 기존 문서 흐름에 맞게 조정 (encode-calldata가 섹션 10이면 sign-only는 섹션 9로 삽입하거나, 기존 번호 뒤에 추가)
- 문서 상단의 목차/summary가 있으면 sign-only 항목 추가
  </action>
  <verify>
    grep -c "transactions/sign" skills/transactions.skill.md
    grep -c "signTransaction" skills/transactions.skill.md
    grep -c "sign_transaction" skills/transactions.skill.md
  </verify>
  <done>
    transactions.skill.md에 sign-only API 섹션이 추가되어 요청/응답/에러 코드/SDK 사용법이 문서화된다. sign-only와 encode-calldata 모두 포함.
  </done>
</task>

</tasks>

<verification>
- `npx turbo run build --filter=@waiaas/core --filter=@waiaas/daemon` 성공
- stages.ts에 `extractPolicyType` 함수 존재 + `policyType`, `tokenAddress`, `contractAddress`, `adminLink` vars 포함
- en.ts/ko.ts POLICY_VIOLATION body에 `{policyType}` + `{adminLink}` 존재
- transactions.skill.md에 `/v1/transactions/sign` 섹션 존재
</verification>

<success_criteria>
1. POLICY_VIOLATION 알림 vars에 policyType, tokenAddress, contractAddress, adminLink가 포함된다
2. i18n 템플릿이 policyType + adminLink를 표시한다
3. transactions.skill.md에 sign-only API 요청/응답/에러 코드/SDK 사용법이 문서화된다
4. 빌드 성공 + 기존 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/119-sdk-mcp-notifications-skill-resources/119-03-SUMMARY.md`
</output>
