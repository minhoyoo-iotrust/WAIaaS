---
phase: 55-workflow-owner-state
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/workflow/approval-workflow.ts
  - packages/daemon/src/__tests__/approval-workflow.test.ts
  - packages/daemon/src/workflow/index.ts
autonomous: true

must_haves:
  truths:
    - "APPROVAL tier transaction creates a pending_approvals record with expiresAt"
    - "Owner can approve a pending APPROVAL transaction via approve(txId, signature)"
    - "Owner can reject a pending APPROVAL transaction via reject(txId)"
    - "Expired APPROVAL transactions are auto-expired by processExpiredApprovals()"
    - "Approval timeout follows 3-level priority: policy-specific > config > 3600s hardcoded"
  artifacts:
    - path: "packages/daemon/src/workflow/approval-workflow.ts"
      provides: "ApprovalWorkflow class with requestApproval(), approve(), reject(), processExpiredApprovals()"
      exports: ["ApprovalWorkflow"]
    - path: "packages/daemon/src/__tests__/approval-workflow.test.ts"
      provides: "TDD tests for approval workflow"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/workflow/approval-workflow.ts"
      to: "pending_approvals table"
      via: "Drizzle ORM queries"
      pattern: "pendingApprovals"
    - from: "packages/daemon/src/workflow/approval-workflow.ts"
      to: "transactions table"
      via: "Status transition on approve/reject/expire"
      pattern: "transactions.*status"
---

<objective>
Implement the ApprovalWorkflow service that manages APPROVAL tier transactions: create pending approval, approve with owner signature, reject, and auto-expire on timeout.

Purpose: APPROVAL is the highest security tier -- large transactions require explicit Owner sign-off before execution, providing human oversight over AI agent spending.

Output: ApprovalWorkflow class with requestApproval(), approve(), reject(), processExpiredApprovals() + TDD tests
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/infrastructure/database/schema.ts -- pending_approvals table with requiredBy, expiresAt, approvedAt, rejectedAt, ownerSignature
@packages/daemon/src/infrastructure/database/migrate.ts -- pending_approvals DDL
@packages/core/src/errors/error-codes.ts -- APPROVAL_TIMEOUT, APPROVAL_NOT_FOUND, TX_NOT_FOUND, TX_ALREADY_PROCESSED
@packages/daemon/src/infrastructure/config/loader.ts -- security.policy_defaults_approval_timeout (default 3600)
@packages/daemon/src/pipeline/database-policy-engine.ts -- evaluateAndReserve returns tier APPROVAL
</context>

<feature>
  <name>ApprovalWorkflow: APPROVAL tier Owner sign-off management</name>
  <files>
    packages/daemon/src/workflow/approval-workflow.ts
    packages/daemon/src/__tests__/approval-workflow.test.ts
    packages/daemon/src/workflow/index.ts
  </files>
  <behavior>
    ApprovalWorkflow manages APPROVAL tier transactions through their approval lifecycle.

    **Constructor:**
    - Takes { db, sqlite, config: { policy_defaults_approval_timeout: number } }
    - The sqlite instance is needed for BEGIN IMMEDIATE on approve/reject

    **requestApproval(txId, options?):**
    - Sets transaction status to 'QUEUED' (reusing QUEUED for pending-approval state)
    - Creates a pending_approvals row:
      - id: generateId()
      - txId: the transaction
      - requiredBy: current time (who requested -- agentId from tx)
      - expiresAt: now + resolveTimeout(options?.policyTimeoutSeconds)
      - createdAt: now
    - resolveTimeout priority (3-level):
      1. options.policyTimeoutSeconds (policy-specific approval_timeout from rules)
      2. config.policy_defaults_approval_timeout (global config)
      3. 3600 (hardcoded fallback)
    - Returns { approvalId, expiresAt }

    **approve(txId, ownerSignature):**
    - Finds pending_approvals WHERE txId = ? AND approvedAt IS NULL AND rejectedAt IS NULL
    - If not found: throws APPROVAL_NOT_FOUND
    - Checks expiresAt > now (not expired)
    - If expired: throws APPROVAL_TIMEOUT
    - Sets approvedAt = now, ownerSignature = signature
    - Sets transaction status to 'EXECUTING' (ready for pipeline stages 5-6)
    - Uses BEGIN IMMEDIATE for atomic approve
    - Clears reserved_amount on the transaction (reservation served its purpose)
    - Returns { txId, approvedAt }

    **reject(txId):**
    - Finds pending_approvals WHERE txId = ? AND approvedAt IS NULL AND rejectedAt IS NULL
    - If not found: throws APPROVAL_NOT_FOUND
    - Sets rejectedAt = now
    - Sets transaction status to 'CANCELLED'
    - Clears reserved_amount
    - Uses BEGIN IMMEDIATE
    - Returns { txId, rejectedAt }

    **processExpiredApprovals(now):**
    - Queries pending_approvals WHERE expiresAt <= now AND approvedAt IS NULL AND rejectedAt IS NULL
    - For each: sets transaction status to 'EXPIRED', clears reserved_amount
    - Does NOT set rejectedAt (expired != rejected)
    - Returns count of expired approvals
    - Uses BEGIN IMMEDIATE

    Test cases (TDD RED first):
    - requestApproval creates pending_approvals record + QUEUED status
    - requestApproval uses policy-specific timeout when provided
    - requestApproval uses config timeout when no policy timeout
    - requestApproval uses 3600 hardcoded when config is undefined
    - approve on valid pending sets EXECUTING + approvedAt + ownerSignature
    - approve on expired throws APPROVAL_TIMEOUT
    - approve on non-existent throws APPROVAL_NOT_FOUND
    - reject on valid pending sets CANCELLED + rejectedAt
    - reject on non-existent throws APPROVAL_NOT_FOUND
    - processExpiredApprovals expires timed-out approvals
    - processExpiredApprovals ignores non-expired approvals
    - approve/reject clear reserved_amount on transaction
  </behavior>
  <implementation>
    1. Write approval-workflow.test.ts with RED tests using in-memory SQLite + Drizzle (same pattern as database-policy-engine.test.ts and delay-queue.test.ts)
    2. Implement ApprovalWorkflow class in approval-workflow.ts:
       - Constructor: { db, sqlite, config }
       - requestApproval: INSERT pending_approvals + UPDATE transactions status
       - approve: BEGIN IMMEDIATE, validate pending, set approvedAt + EXECUTING
       - reject: BEGIN IMMEDIATE, validate pending, set rejectedAt + CANCELLED
       - processExpiredApprovals: BEGIN IMMEDIATE, batch expire
       - Private resolveTimeout(policyTimeout?) helper
    3. Update workflow/index.ts barrel to export ApprovalWorkflow
    4. Run tests GREEN
    5. Refactor if needed
  </implementation>
</feature>

<verification>
1. `pnpm --filter @waiaas/daemon test -- --run packages/daemon/src/__tests__/approval-workflow.test.ts` -- all tests pass
2. `pnpm typecheck` -- no TS errors
3. At least 12 test cases covering request, approve, reject, expire, timeout priority, edge cases
</verification>

<success_criteria>
- ApprovalWorkflow class exists with requestApproval(), approve(), reject(), processExpiredApprovals()
- All TDD tests pass (12+ test cases)
- pending_approvals table correctly tracks approval lifecycle
- Timeout resolution follows 3-level priority (policy > config > 3600s)
- approve() atomically transitions to EXECUTING, reject() to CANCELLED
- Expired approvals are batch-expired with reserved_amount cleanup
- BEGIN IMMEDIATE prevents concurrent approve/reject races
</success_criteria>

<output>
After completion, create `.planning/phases/55-workflow-owner-state/55-02-SUMMARY.md`
</output>
