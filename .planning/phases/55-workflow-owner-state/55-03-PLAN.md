---
phase: 55-workflow-owner-state
plan: 03
type: tdd
wave: 2
depends_on: ["55-01", "55-02"]
files_modified:
  - packages/daemon/src/workflow/owner-state.ts
  - packages/daemon/src/__tests__/owner-state.test.ts
  - packages/daemon/src/workflow/index.ts
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/server.ts
autonomous: true

must_haves:
  truths:
    - "resolveOwnerState() returns NONE when ownerAddress is null"
    - "resolveOwnerState() returns GRACE when ownerAddress is set but ownerVerified is false"
    - "resolveOwnerState() returns LOCKED when ownerAddress is set and ownerVerified is true"
    - "PUT /v1/agents/:id/owner sets ownerAddress (masterAuth, NONE -> GRACE transition)"
    - "GRACE state allows owner change/removal with masterAuth only"
    - "LOCKED state requires ownerAuth + masterAuth for owner change, removal blocked"
    - "APPROVAL tier auto-downgrades to DELAY when Owner is NONE, emitting TX_DOWNGRADED_DELAY event"
    - "POST /v1/transactions/:id/approve and /reject routes exist with ownerAuth"
    - "POST /v1/transactions/:id/cancel route exists for DELAY cancellation"
  artifacts:
    - path: "packages/daemon/src/workflow/owner-state.ts"
      provides: "resolveOwnerState() pure function + OwnerLifecycleService"
      exports: ["resolveOwnerState", "OwnerLifecycleService", "OwnerState"]
    - path: "packages/daemon/src/__tests__/owner-state.test.ts"
      provides: "TDD tests for owner state machine and downgrade logic"
      min_lines: 80
    - path: "packages/daemon/src/api/routes/agents.ts"
      provides: "PUT /v1/agents/:id/owner endpoint"
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "POST /transactions/:id/approve, /reject, /cancel endpoints"
  key_links:
    - from: "packages/daemon/src/workflow/owner-state.ts"
      to: "agents table ownerAddress + ownerVerified"
      via: "resolveOwnerState reads agent record"
      pattern: "ownerAddress.*ownerVerified"
    - from: "packages/daemon/src/api/routes/transactions.ts"
      to: "packages/daemon/src/workflow/approval-workflow.ts"
      via: "approve/reject/cancel route handlers call workflow methods"
      pattern: "approvalWorkflow\\.approve|delayQueue\\.cancel"
    - from: "packages/daemon/src/workflow/owner-state.ts"
      to: "APPROVAL -> DELAY downgrade"
      via: "downgradeIfNoOwner checks resolveOwnerState"
      pattern: "TX_DOWNGRADED_DELAY"
---

<objective>
Implement the Owner 3-State state machine (NONE/GRACE/LOCKED), Owner registration API, APPROVAL->DELAY downgrade logic, and transaction approve/reject/cancel API routes.

Purpose: The Owner state machine controls security escalation -- agents start without an owner (NONE), get one registered (GRACE), and once verified it locks (LOCKED). Without an owner, APPROVAL-tier transactions downgrade to DELAY to maintain usability.

Output: resolveOwnerState() function, OwnerLifecycleService, Owner registration API, tx approve/reject/cancel routes, downgrade logic + TDD tests
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/55-workflow-owner-state/55-01-SUMMARY.md -- DelayQueue from plan 01
@.planning/phases/55-workflow-owner-state/55-02-SUMMARY.md -- ApprovalWorkflow from plan 02

@packages/daemon/src/infrastructure/database/schema.ts -- agents table with ownerAddress, ownerVerified columns
@packages/daemon/src/api/routes/agents.ts -- existing POST /agents, needs PUT /agents/:id/owner
@packages/daemon/src/api/routes/transactions.ts -- existing POST /transactions/send, needs approve/reject/cancel
@packages/daemon/src/api/server.ts -- createApp with auth middleware registration
@packages/daemon/src/api/middleware/owner-auth.ts -- createOwnerAuth middleware (Ed25519)
@packages/core/src/errors/error-codes.ts -- OWNER_* codes, APPROVAL_*, TX_ALREADY_PROCESSED
</context>

<feature>
  <name>Owner 3-State Machine + Downgrade + Transaction Approve/Reject/Cancel API</name>
  <files>
    packages/daemon/src/workflow/owner-state.ts
    packages/daemon/src/__tests__/owner-state.test.ts
    packages/daemon/src/workflow/index.ts
    packages/daemon/src/api/routes/agents.ts
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/api/server.ts
  </files>
  <behavior>
    **1. resolveOwnerState(agent) pure function:**
    - Input: { ownerAddress: string | null, ownerVerified: boolean }
    - Returns: 'NONE' | 'GRACE' | 'LOCKED'
    - Logic:
      - ownerAddress is null -> NONE
      - ownerAddress set, ownerVerified false -> GRACE
      - ownerAddress set, ownerVerified true -> LOCKED
    - Pure function, no DB access, no side effects

    **2. OwnerLifecycleService:**
    - Constructor: { db, sqlite }
    - setOwner(agentId, ownerAddress): Updates agent ownerAddress, sets ownerVerified = false
      - If current state is LOCKED: throws OWNER_ALREADY_CONNECTED (change requires ownerAuth -- handled by middleware)
      - If NONE or GRACE: sets ownerAddress, ownerVerified = false, updatedAt = now
    - removeOwner(agentId):
      - If LOCKED: throws OWNER_ALREADY_CONNECTED ("Owner removal blocked in LOCKED state")
      - If NONE: no-op (already no owner)
      - If GRACE: clears ownerAddress, ownerVerified = false, updatedAt = now
    - markOwnerVerified(agentId): Sets ownerVerified = true (GRACE -> LOCKED)
      - Called when ownerAuth middleware succeeds on any ownerAuth-protected route
      - If already LOCKED: no-op
      - If NONE: throws OWNER_NOT_CONNECTED

    **3. downgradeIfNoOwner(agentId, tier, db):**
    - If tier is 'APPROVAL' and resolveOwnerState(agent) is 'NONE':
      - Returns { tier: 'DELAY', downgraded: true }
      - The caller should log a TX_DOWNGRADED_DELAY audit event
    - Otherwise returns { tier, downgraded: false }

    **4. PUT /v1/agents/:id/owner (masterAuth):**
    - Body: { owner_address: string }
    - Calls setOwner(agentId, ownerAddress)
    - Returns 200 with updated agent JSON
    - If LOCKED state, requires ownerAuth additionally (middleware layering):
      - Route checks resolveOwnerState first
      - If LOCKED: responds 409 OWNER_ALREADY_CONNECTED with message "Use ownerAuth to change owner in LOCKED state"

    **5. POST /v1/transactions/:id/approve (ownerAuth):**
    - Requires ownerAuth headers (X-Owner-Signature, X-Owner-Message, X-Owner-Address)
    - Calls approvalWorkflow.approve(txId, signature)
    - Also calls markOwnerVerified(agentId) -- ownerAuth success triggers GRACE->LOCKED
    - Returns 200 { id, status: 'EXECUTING', approvedAt }

    **6. POST /v1/transactions/:id/reject (ownerAuth):**
    - Requires ownerAuth headers
    - Calls approvalWorkflow.reject(txId)
    - Also calls markOwnerVerified(agentId)
    - Returns 200 { id, status: 'CANCELLED', rejectedAt }

    **7. POST /v1/transactions/:id/cancel (sessionAuth -- agent can cancel own DELAY tx):**
    - Requires sessionAuth (agent cancels its own delayed transaction)
    - Calls delayQueue.cancelDelay(txId)
    - Verifies the tx belongs to the session's agent (agentId match)
    - Returns 200 { id, status: 'CANCELLED' }

    Test cases (TDD):
    - resolveOwnerState returns NONE for null ownerAddress
    - resolveOwnerState returns GRACE for ownerAddress set, ownerVerified false
    - resolveOwnerState returns LOCKED for ownerAddress set, ownerVerified true
    - setOwner in NONE state sets ownerAddress
    - setOwner in GRACE state updates ownerAddress (change allowed)
    - setOwner in LOCKED state throws OWNER_ALREADY_CONNECTED
    - removeOwner in GRACE state clears ownerAddress
    - removeOwner in LOCKED state throws OWNER_ALREADY_CONNECTED
    - markOwnerVerified in GRACE transitions to LOCKED
    - markOwnerVerified in LOCKED is no-op
    - markOwnerVerified in NONE throws OWNER_NOT_CONNECTED
    - downgradeIfNoOwner downgrades APPROVAL to DELAY when NONE
    - downgradeIfNoOwner keeps APPROVAL when GRACE or LOCKED
    - downgradeIfNoOwner keeps DELAY/INSTANT/NOTIFY unchanged regardless of state
  </behavior>
  <implementation>
    1. Write owner-state.test.ts with RED tests for resolveOwnerState, OwnerLifecycleService, downgradeIfNoOwner
    2. Implement owner-state.ts:
       - OwnerState type = 'NONE' | 'GRACE' | 'LOCKED'
       - resolveOwnerState() pure function
       - OwnerLifecycleService class with setOwner/removeOwner/markOwnerVerified
       - downgradeIfNoOwner() function
    3. Run owner-state tests GREEN
    4. Add PUT /agents/:id/owner to agents.ts:
       - Parse body { owner_address }
       - Call ownerLifecycle.setOwner()
       - Return updated agent
    5. Add POST /transactions/:id/approve, /reject, /cancel to transactions.ts:
       - approve/reject: validate ownerAuth (middleware), call workflow
       - cancel: validate sessionAuth (middleware), call delayQueue.cancelDelay
       - approve/reject also markOwnerVerified
    6. Update server.ts:
       - Register ownerAuth middleware for /v1/transactions/:id/approve and /v1/transactions/:id/reject
       - Register sessionAuth for /v1/transactions/:id/cancel (already covered by /v1/transactions/*)
       - Wire DelayQueue and ApprovalWorkflow into transaction route deps
    7. Run all daemon tests to verify no regressions
  </implementation>
</feature>

<verification>
1. `pnpm --filter @waiaas/daemon test -- --run packages/daemon/src/__tests__/owner-state.test.ts` -- all tests pass
2. `pnpm --filter @waiaas/daemon test` -- all daemon tests pass (no regressions)
3. `pnpm typecheck` -- no TS errors
4. At least 14 test cases covering state machine, lifecycle operations, downgrade, edge cases
</verification>

<success_criteria>
- resolveOwnerState() correctly classifies NONE/GRACE/LOCKED from agent fields
- OwnerLifecycleService enforces state transition rules (LOCKED blocks change/removal)
- downgradeIfNoOwner() returns DELAY when APPROVAL + NONE state
- PUT /agents/:id/owner registers owner with masterAuth
- POST /transactions/:id/approve and /reject work with ownerAuth
- POST /transactions/:id/cancel works with sessionAuth for DELAY transactions
- ownerAuth success triggers markOwnerVerified (GRACE -> LOCKED auto-transition)
- All daemon tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/55-workflow-owner-state/55-03-SUMMARY.md`
</output>
