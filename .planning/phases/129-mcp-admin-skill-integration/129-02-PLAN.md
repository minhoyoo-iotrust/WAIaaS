---
phase: 129-mcp-admin-skill-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/admin.skill.md
  - skills/actions.skill.md
autonomous: true

must_haves:
  truths:
    - "admin.skill.md에 oracle-status, api-keys 엔드포인트가 문서화되어 있다"
    - "actions.skill.md가 Action Provider REST API를 문서화하여 AI 에이전트가 즉시 사용 가능하다"
    - "Skill 파일 버전이 1.5.0으로 업데이트되어 v1.5 엔드포인트 반영을 명시한다"
  artifacts:
    - path: "skills/admin.skill.md"
      provides: "Admin API 문서 (v1.5.0 -- oracle-status + api-keys 섹션 추가)"
      contains: "oracle-status"
    - path: "skills/actions.skill.md"
      provides: "Action Provider REST API 문서 (신규 생성)"
      contains: "actions/providers"
  key_links:
    - from: "skills/admin.skill.md"
      to: "GET /v1/admin/oracle-status"
      via: "curl 예시 + 응답 스키마 문서화"
      pattern: "oracle-status"
    - from: "skills/admin.skill.md"
      to: "GET/PUT/DELETE /v1/admin/api-keys"
      via: "curl 예시 + 응답 스키마 문서화"
      pattern: "api-keys"
    - from: "skills/actions.skill.md"
      to: "GET /v1/actions/providers"
      via: "curl 예시 + 응답 스키마 문서화"
      pattern: "actions/providers"
    - from: "skills/actions.skill.md"
      to: "POST /v1/actions/:provider/:action"
      via: "curl 예시 + 요청/응답 스키마 문서화"
      pattern: "actions/.*/"
---

<objective>
admin.skill.md + actions.skill.md 작성/동기화 (SKIL-01, SKIL-02)

Purpose: Phase 126-128에서 추가된 엔드포인트를 Skill 파일로 문서화하여 AI 에이전트가 curl 명령으로 즉시 참조/실행할 수 있게 한다. CLAUDE.md 규칙 "REST API, SDK, MCP 인터페이스가 변경되면 skills/ 파일도 반드시 함께 업데이트한다"를 준수한다.
Output: skills/admin.skill.md (수정 -- v1.5.0), skills/actions.skill.md (신규)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@skills/admin.skill.md
@skills/transactions.skill.md
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/actions.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: admin.skill.md에 oracle-status + api-keys 섹션 추가</name>
  <files>skills/admin.skill.md</files>
  <action>
`skills/admin.skill.md`를 수정한다.

**A. Frontmatter 업데이트:**
- `version: "1.4.8"` -> `version: "1.5.0"`
- `description`에 "oracle status, API key management" 추가: `"Admin API: daemon status, kill switch, notifications, settings management, JWT rotation, shutdown, oracle status, API key management"`
- `tags`에 `oracle`, `defi` 추가

**B. 섹션 6 이전에 새로운 섹션 2개 추가:**

기존 섹션 5 (Common Workflows) 이후, 기존 섹션 6 (Error Reference) 이전에 삽입. 기존 섹션 번호를 조정:
- 기존 5. Common Workflows -> 그대로
- 새 6. Oracle Status (v1.5)
- 새 7. API Key Management (v1.5)
- 기존 6. Error Reference -> 8. Error Reference
- 기존 7. Related Skill Files -> 9. Related Skill Files

**C. 섹션 6. Oracle Status:**

```markdown
## 6. Oracle Status (v1.5)

Price oracle cache statistics, source availability, and cross-validation configuration.

### GET /v1/admin/oracle-status -- Oracle Status

Returns cache hit/miss stats, Pyth and CoinGecko source availability, and cross-validation settings.

\```bash
curl -s http://localhost:3100/v1/admin/oracle-status \
  -H 'X-Master-Password: <password>'
\```

**Response (200):**
\```json
{
  "cache": {
    "hits": 142,
    "misses": 23,
    "staleHits": 5,
    "size": 38,
    "evictions": 0
  },
  "sources": {
    "pyth": {
      "available": true,
      "baseUrl": "https://hermes.pyth.network"
    },
    "coingecko": {
      "available": true,
      "apiKeyConfigured": true
    }
  },
  "crossValidation": {
    "enabled": true,
    "threshold": 5
  }
}
\```

| Field | Type | Description |
| ----- | ---- | ----------- |
| `cache.hits` | integer | Cache hit count. |
| `cache.misses` | integer | Cache miss count. |
| `cache.staleHits` | integer | Stale cache fallback count. |
| `cache.size` | integer | Current cache entry count. |
| `cache.evictions` | integer | LRU eviction count. |
| `sources.pyth.available` | boolean | Pyth Hermes oracle available. |
| `sources.pyth.baseUrl` | string | Pyth Hermes API base URL. |
| `sources.coingecko.available` | boolean | CoinGecko oracle available. |
| `sources.coingecko.apiKeyConfigured` | boolean | CoinGecko API key configured. |
| `crossValidation.enabled` | boolean | Cross-validation enabled (requires CoinGecko). |
| `crossValidation.threshold` | number | Max price deviation percentage before STALE. |
```

**D. 섹션 7. API Key Management:**

```markdown
## 7. API Key Management (v1.5)

Manage API keys for Action Providers. Keys are encrypted at rest in the database.

### GET /v1/admin/api-keys -- List API Key Status

Returns per-provider API key status. Key values are masked.

\```bash
curl -s http://localhost:3100/v1/admin/api-keys \
  -H 'X-Master-Password: <password>'
\```

**Response (200):**
\```json
{
  "keys": [
    {
      "providerName": "jupiter",
      "hasKey": true,
      "maskedKey": "ju...er",
      "requiresApiKey": true,
      "updatedAt": "2026-02-15T10:30:00.000Z"
    },
    {
      "providerName": "raydium",
      "hasKey": false,
      "maskedKey": null,
      "requiresApiKey": false,
      "updatedAt": null
    }
  ]
}
\```

| Field | Type | Description |
| ----- | ---- | ----------- |
| `providerName` | string | Action provider name. |
| `hasKey` | boolean | Whether an API key is set. |
| `maskedKey` | string\|null | Masked key (first 2 + last 2 chars), or null. |
| `requiresApiKey` | boolean | Provider requires API key to function. |
| `updatedAt` | string\|null | ISO 8601 timestamp of last update, or null. |

### PUT /v1/admin/api-keys/:provider -- Set/Update API Key

Set or update the API key for a specific provider.

\```bash
curl -s -X PUT http://localhost:3100/v1/admin/api-keys/jupiter \
  -H 'Content-Type: application/json' \
  -H 'X-Master-Password: <password>' \
  -d '{"apiKey": "your-api-key-here"}'
\```

**Response (200):**
\```json
{
  "success": true,
  "providerName": "jupiter"
}
\```

### DELETE /v1/admin/api-keys/:provider -- Delete API Key

Delete the API key for a specific provider.

\```bash
curl -s -X DELETE http://localhost:3100/v1/admin/api-keys/jupiter \
  -H 'X-Master-Password: <password>'
\```

**Response (200):**
\```json
{
  "success": true
}
\```

If no key exists for the provider, returns 404 `ACTION_NOT_FOUND`.
```

**E. Error Reference 섹션 업데이트:**

Error Reference 테이블에 새 에러 코드 추가:
- `API_KEY_REQUIRED` | 403 | Action provider requires API key not yet configured.
- `ACTION_NOT_FOUND` | 404 | Action provider or API key not found.

**F. Related Skill Files 섹션에 actions.skill.md 추가:**
`- **actions.skill.md** -- Action Provider REST API (DeFi actions)`

**주의사항:**
- Skill 파일은 AI 에이전트용 API 레퍼런스. 내부 구현(파이프라인, DB 스키마, 암호화 방식 등)은 설명하지 않는다.
- curl 예시의 base URL은 `http://localhost:3100`으로 통일.
- 모든 API Keys/Oracle Status 엔드포인트는 masterAuth (`X-Master-Password` 헤더) 필요.
  </action>
  <verify>
1. `skills/admin.skill.md` 파일에 `oracle-status` 문자열이 포함됨
2. `skills/admin.skill.md` 파일에 `api-keys` 문자열이 포함됨
3. `skills/admin.skill.md` frontmatter version이 `1.5.0`
4. 파일의 마크다운 구조가 유효 (섹션 번호 연속, 코드 블록 열림/닫힘 매칭)
  </verify>
  <done>
- admin.skill.md v1.5.0으로 업데이트
- oracle-status 섹션에 GET /v1/admin/oracle-status 문서화 (cache stats + source status + cross-validation)
- api-keys 섹션에 GET/PUT/DELETE /v1/admin/api-keys 3개 엔드포인트 문서화
- SKIL-01 요구사항 충족
  </done>
</task>

<task type="auto">
  <name>Task 2: actions.skill.md 신규 생성</name>
  <files>skills/actions.skill.md</files>
  <action>
`skills/actions.skill.md`를 신규 생성한다. 기존 transactions.skill.md의 포맷(YAML frontmatter + 섹션별 curl 예시 + 에러 레퍼런스)을 따른다.

**전체 파일 구조:**

```markdown
---
name: "WAIaaS Actions"
description: "Action Provider framework: list providers, execute DeFi actions through the 6-stage transaction pipeline"
category: "api"
tags: [wallet, blockchain, defi, actions, waiass]
version: "1.5.0"
dispatch:
  kind: "tool"
  allowedCommands: ["curl"]
---

# WAIaaS Actions

Action Provider framework for executing DeFi protocol actions (swaps, staking, liquidity) through the WAIaaS transaction pipeline. Actions are resolved by registered providers and executed as CONTRACT_CALL transactions through the existing 6-stage pipeline with full policy evaluation.

## Base URL / Authentication

```
http://localhost:3100
```

All action endpoints require **sessionAuth** via `Authorization: Bearer <token>` header.

```
Authorization: Bearer wai_sess_eyJ...
```

## 1. List Action Providers

### GET /v1/actions/providers -- List Registered Providers

Returns all registered action providers with their actions and API key status.

\```bash
curl -s http://localhost:3100/v1/actions/providers \
  -H 'Authorization: Bearer wai_sess_eyJ...'
\```

**Response (200):**
\```json
{
  "providers": [
    {
      "name": "jupiter",
      "description": "Jupiter DEX aggregator for Solana token swaps",
      "version": "1.0.0",
      "chains": ["solana"],
      "mcpExpose": true,
      "requiresApiKey": true,
      "hasApiKey": true,
      "actions": [
        {
          "name": "swap",
          "description": "Swap tokens via Jupiter aggregator",
          "chain": "solana",
          "riskLevel": "medium",
          "defaultTier": "NOTIFY"
        }
      ]
    }
  ]
}
\```

| Field | Type | Description |
| ----- | ---- | ----------- |
| `name` | string | Provider identifier. |
| `description` | string | Human-readable provider description. |
| `version` | string | Provider version (semver). |
| `chains` | string[] | Supported blockchain chains. |
| `mcpExpose` | boolean | Whether actions are exposed as MCP tools. |
| `requiresApiKey` | boolean | Whether provider needs an API key to function. |
| `hasApiKey` | boolean | Whether API key is currently configured. |
| `actions` | array | Available actions for this provider. |
| `actions[].name` | string | Action identifier. |
| `actions[].description` | string | What the action does. |
| `actions[].chain` | string | Target blockchain. |
| `actions[].riskLevel` | string | Risk level: "low", "medium", "high". |
| `actions[].defaultTier` | string | Default policy tier: "INSTANT", "NOTIFY", "DELAY", "APPROVAL". |

## 2. Execute Action

### POST /v1/actions/:provider/:action -- Execute Provider Action

Resolve action parameters into a ContractCallRequest and execute through the 6-stage transaction pipeline. Returns immediately with transaction ID.

\```bash
curl -s -X POST http://localhost:3100/v1/actions/jupiter/swap \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer wai_sess_eyJ...' \
  -d '{
    "params": {
      "inputMint": "So11111111111111111111111111111111111111112",
      "outputMint": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
      "amount": "1000000000",
      "slippageBps": 50
    },
    "network": "devnet"
  }'
\```

**Parameters:**

| Parameter | Type | Required | Description |
| --------- | ---- | -------- | ----------- |
| `params` | object | No | Action-specific parameters as key-value pairs. Varies per provider/action. |
| `network` | string | No | Target network. Defaults to wallet's default network. |

**Response (201):**
\```json
{
  "id": "01958f3c-9999-7000-8000-abcdef999999",
  "status": "PENDING"
}
\```

The transaction follows the standard lifecycle (PENDING -> QUEUED -> CONFIRMED/FAILED). Query status with `GET /v1/transactions/{id}`.

**Prerequisites:**

1. The resolved contract address must be whitelisted via a **CONTRACT_WHITELIST** policy.
2. If the provider requires an API key (`requiresApiKey: true`), the key must be configured via Admin API Keys.
3. The provider must be registered (loaded from `~/.waiaas/actions/`).

## 3. MCP Integration

When a provider has `mcpExpose: true`, its actions are automatically registered as MCP tools with the naming pattern `action_{provider}_{action}`. This allows AI agents to execute DeFi actions directly via MCP without knowing the REST API.

**Example MCP tool:** `action_jupiter_swap` -- calls `POST /v1/actions/jupiter/swap` under the hood.

MCP tool parameters match the REST API: `params` (optional object) and `network` (optional string).

## 4. Common Workflows

### Execute a token swap

1. Check available providers:
\```bash
curl -s http://localhost:3100/v1/actions/providers \
  -H 'Authorization: Bearer wai_sess_eyJ...'
\```

2. Ensure CONTRACT_WHITELIST policy includes the DEX contract:
\```bash
curl -s -X POST http://localhost:3100/v1/policies \
  -H 'Content-Type: application/json' \
  -H 'X-Master-Password: <password>' \
  -d '{
    "walletId": "<wallet-id>",
    "type": "CONTRACT_WHITELIST",
    "rules": {"addresses": ["<dex-contract-address>"]},
    "priority": 0,
    "enabled": true
  }'
\```

3. Execute the swap action:
\```bash
curl -s -X POST http://localhost:3100/v1/actions/jupiter/swap \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer wai_sess_eyJ...' \
  -d '{"params": {"inputMint": "So111...", "outputMint": "EPjF...", "amount": "1000000000"}}'
\```

4. Check transaction status:
\```bash
curl -s http://localhost:3100/v1/transactions/<tx-id> \
  -H 'Authorization: Bearer wai_sess_eyJ...'
\```

### Set up provider API key (Admin)

\```bash
curl -s -X PUT http://localhost:3100/v1/admin/api-keys/jupiter \
  -H 'Content-Type: application/json' \
  -H 'X-Master-Password: <password>' \
  -d '{"apiKey": "your-jupiter-api-key"}'
\```

## 5. Error Reference

| Code | HTTP | Description | Recovery |
|------|------|-------------|----------|
| `ACTION_NOT_FOUND` | 404 | Provider or action not registered. | Check available providers with GET /v1/actions/providers. |
| `API_KEY_REQUIRED` | 403 | Provider requires API key not configured. | Set API key via PUT /v1/admin/api-keys/:provider. |
| `ACTION_VALIDATION_FAILED` | 400 | Input parameters failed validation. | Check params format in provider docs. |
| `ACTION_RESOLVE_FAILED` | 502 | Provider's resolve() call failed. | Check provider logs, verify params. |
| `ACTION_RETURN_INVALID` | 500 | Provider returned invalid ContractCallRequest. | Report to provider maintainer. |
| `CONTRACT_NOT_WHITELISTED` | 403 | Resolved contract not in whitelist. | Add contract to CONTRACT_WHITELIST policy. |
| `POLICY_VIOLATION` | 403 | Transaction blocked by policy. | Check policies with GET /v1/policies. |

## 6. Related Skill Files

- **admin.skill.md** -- API key management, oracle status, daemon admin
- **transactions.skill.md** -- 5-type transaction reference (actions execute as CONTRACT_CALL)
- **policies.skill.md** -- Policy management (CONTRACT_WHITELIST required for actions)
- **wallet.skill.md** -- Wallet CRUD, sessions, assets
```

**주의사항:**
- 내부 구현 상세 (파이프라인 스테이지, DB 스키마, Zod 검증 등)는 포함하지 않는다.
- curl 예시의 provider/action 이름은 실제 프로바이더가 아닌 예시용 (jupiter/swap). 이는 프로바이더가 ESM 플러그인으로 등록되므로 실제 이름은 다를 수 있음을 AI 에이전트가 이해하도록 GET /v1/actions/providers를 먼저 호출하라고 안내.
- frontmatter의 dispatch.kind, allowedCommands는 기존 skill 파일과 동일 패턴.
  </action>
  <verify>
1. `skills/actions.skill.md` 파일이 존재하고 YAML frontmatter가 유효
2. 파일에 `GET /v1/actions/providers` 문서가 포함됨
3. 파일에 `POST /v1/actions/:provider/:action` 문서가 포함됨
4. frontmatter version이 `1.5.0`
5. Error Reference 테이블에 7개 에러 코드 포함
  </verify>
  <done>
- actions.skill.md가 신규 생성되어 Action Provider REST API를 완전히 문서화
- GET /v1/actions/providers + POST /v1/actions/:provider/:action 2개 엔드포인트 문서화
- MCP 통합 안내 (action_{provider}_{action} 도구명 패턴)
- Common Workflows (토큰 스왑, API 키 설정)
- 에러 레퍼런스 7개 코드 포함
- SKIL-02 요구사항 충족
  </done>
</task>

</tasks>

<verification>
1. `skills/admin.skill.md`에 oracle-status + api-keys 섹션이 존재하고 version 1.5.0
2. `skills/actions.skill.md`가 신규 생성되어 providers + execute 엔드포인트 문서화
3. **SKIL-01**: admin.skill.md에 oracle-status (cache/sources/crossValidation) + api-keys (GET/PUT/DELETE) 문서화
4. **SKIL-02**: actions.skill.md가 Action Provider REST API를 AI 에이전트 참조용으로 문서화
5. 모든 curl 예시가 실행 가능한 형식 (base URL, 헤더, body 포함)
</verification>

<success_criteria>
- admin.skill.md v1.5.0으로 업데이트, oracle-status + api-keys 4개 엔드포인트 문서화
- actions.skill.md 신규 생성, providers + execute 2개 엔드포인트 + 에러 레퍼런스 문서화
- SKIL-01, SKIL-02 요구사항 충족
- 기존 skill 파일 포맷 (YAML frontmatter + curl 예시 + 에러 테이블) 준수
</success_criteria>

<output>
After completion, create `.planning/phases/129-mcp-admin-skill-integration/129-02-SUMMARY.md`
</output>
