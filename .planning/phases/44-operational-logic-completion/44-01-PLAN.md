---
phase: 44-operational-logic-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/28-daemon-lifecycle-cli.md
autonomous: true

must_haves:
  truths:
    - "28-daemon §2에 7단계 시작 절차 각각에 타임아웃(5~30초)과 fail-fast/soft 정책이 테이블로 존재한다"
    - "전체 90초 상한이 명시되어 있고 초과 시 강제 종료 동작이 기술되어 있다"
    - "Step 4(어댑터)만 fail-soft이고 나머지 필수 단계는 fail-fast임이 명확하다"
    - "v0.10 objectives D-1의 6단계와 28-daemon의 7단계 간 매핑이 명시되어 있다"
  artifacts:
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "시작 단계별 타임아웃 + fail-fast/soft 정책 테이블"
      contains: "전체 시작 시간 상한: 90초"
  key_links:
    - from: "28-daemon §2 타임아웃 테이블"
      to: "v0.10 objectives D-1"
      via: "6단계 -> 7단계 매핑 주석"
      pattern: "DAEMON_STARTUP_TIMEOUT"
---

<objective>
28-daemon-lifecycle-cli.md §2에 7단계 시작 절차별 타임아웃과 fail-fast/soft 정책을 테이블로 추가하고, 전체 90초 상한을 명시한다.

Purpose: 구현자가 데몬 시작 시 각 단계의 타임아웃과 실패 처리 방식을 추측 없이 구현할 수 있도록 한다.
Output: 28-daemon-lifecycle-cli.md에 타임아웃 테이블 + AbortController 기반 전체 상한 의사코드 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/deliverables/28-daemon-lifecycle-cli.md
@objectives/v0.10-pre-implementation-design-completion.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 28-daemon §2에 시작 단계별 타임아웃 테이블 + 전체 90초 상한 추가</name>
  <files>.planning/deliverables/28-daemon-lifecycle-cli.md</files>
  <action>
28-daemon-lifecycle-cli.md §2 "시작 시퀀스"에 새로운 하위 섹션 "### 2.8 시작 단계별 타임아웃 + fail-fast/soft 정책 [v0.10]"을 추가한다. 기존 §2.7 (또는 마지막 하위 섹션) 직후에 삽입한다. 기존 Step 1~7 구조를 변경하지 않는다.

추가할 내용:

1. **타임아웃 테이블** -- 28-daemon의 기존 Step 1~7 번호 체계를 유지하면서 v0.10 objectives D-1의 6단계 매핑을 비고란에 명시:

| Step | 작업 | 타임아웃 | 실패 정책 | 에러 코드 | v0.10 D-1 매핑 | 비고 |
|------|------|---------|----------|----------|--------------|------|
| 1 | 환경 검증 (flock + config.toml + Zod) | **5초** | fail-fast | DAEMON_ALREADY_RUNNING / CONFIG_LOAD_ERROR | D-1 Step 1+2 | flock 획득(5초) + TOML 파싱 + Zod 검증 포함 |
| 2 | DB 초기화 (better-sqlite3 + PRAGMA + migrate) | **30초** | fail-fast | DB_MIGRATION_TIMEOUT | D-1 Step 3 | 대규모 마이그레이션 시 시간 소요 가능 |
| 3 | 키스토어 잠금 해제 (Argon2id + AES-GCM) | **30초** | fail-fast | KEYSTORE_UNLOCK_TIMEOUT | D-1 Step 4 | Argon2id ~1-3초 + 다수 에이전트 키 복호화 |
| 4 | 어댑터 초기화 (RPC connect + healthCheck) | **10초/체인** | **fail-soft** | 경고 로그 + 체인 비활성화 | D-1 Step 5 | 해당 체인 비활성화, 데몬은 계속 시작 |
| 5 | HTTP 서버 시작 (Hono serve 127.0.0.1) | **5초** | fail-fast | PORT_BIND_ERROR | D-1 Step 6 | 포트 충돌(EADDRINUSE) 포함 |
| 6 | 백그라운드 워커 시작 | 타임아웃 없음 | fail-soft | - | (D-1 범위 외) | 비동기 시작, 개별 실패 시 다음 주기 재시도 |
| 7 | PID 파일 기록 + Ready 메시지 | 타임아웃 없음 | fail-fast | - | (D-1 범위 외) | 파일 I/O 즉시 완료 |

2. **전체 시작 시간 상한 (90초)** -- AbortController 기반 전체 타임아웃 래퍼 의사코드:

```typescript
// packages/daemon/src/lifecycle/daemon.ts (v0.10 타임아웃 래퍼)
async function startDaemon(options: StartOptions): Promise<void> {
  const STARTUP_TIMEOUT_MS = 90_000  // 전체 90초 상한
  const ac = new AbortController()
  const timer = setTimeout(() => ac.abort(), STARTUP_TIMEOUT_MS)

  try {
    // Step 1~7 순차 실행 (각 단계는 개별 타임아웃 보유)
    const config = await withTimeout(validateEnvironment(options), 5_000, 'CONFIG_LOAD_ERROR')
    // ... (각 단계에 AbortSignal.timeout(ms) 적용)

    if (ac.signal.aborted) {
      throw new DaemonError('DAEMON_STARTUP_TIMEOUT',
        `Daemon startup exceeded ${STARTUP_TIMEOUT_MS / 1000}s limit`)
    }
  } finally {
    clearTimeout(timer)
  }
}

function withTimeout<T>(promise: Promise<T>, ms: number, errorCode: string): Promise<T> {
  return Promise.race([
    promise,
    new Promise<never>((_, reject) =>
      setTimeout(() => reject(new DaemonError(errorCode, `Timeout after ${ms}ms`)), ms)
    ),
  ])
}
```

3. **Step 6/7이 타임아웃 대상에서 제외되는 이유** -- 설명 문단:
- Step 6(워커): setInterval 기반 비동기 시작. 등록 자체는 즉시 완료되며, 개별 워커의 첫 실행 실패는 다음 주기에 재시도
- Step 7(PID/Ready): 파일 I/O(writeFileSync)로 즉시 완료. 실패 시 즉시 에러

4. **fail-soft 동작 상세** -- Step 4에 대한 추가 설명:
- 체인별 독립 타임아웃 (10초/체인). 한 체인 실패가 다른 체인에 영향 안 줌
- 실패한 체인의 에이전트 요청은 503 SERVICE_UNAVAILABLE 반환
- 어댑터는 자체적으로 재연결 시도 (기존 §2.4 healthCheck 로직)

주의: v0.10 objectives D-1은 6단계(Step 1-2를 하나로, Step 6-7 제외)로 기술하지만, 28-daemon의 기존 7단계 구조를 유지한다. "v0.10 D-1 매핑" 컬럼으로 대응 관계를 명시하여 혼동을 방지한다.
  </action>
  <verify>
28-daemon-lifecycle-cli.md에서 다음을 확인:
1. "### 2.8" 또는 적절한 하위 섹션 번호로 타임아웃 테이블이 존재
2. 테이블에 7개 Step 모두 포함 (타임아웃 있는 5개 + 없는 2개)
3. "전체 시작 시간 상한: 90초" 문구 존재
4. AbortController 기반 의사코드 존재
5. "v0.10 D-1 매핑" 컬럼이 테이블에 존재
6. fail-soft 동작 상세 설명 존재
  </verify>
  <done>
28-daemon §2에 7단계 각각의 타임아웃(5~30초)과 fail-fast/soft 정책이 테이블로 정의되어 있고, 전체 90초 상한이 AbortController 의사코드와 함께 명시되어 있다. v0.10 D-1과의 매핑이 명확하다.
  </done>
</task>

</tasks>

<verification>
1. grep "타임아웃" .planning/deliverables/28-daemon-lifecycle-cli.md -- 타임아웃 테이블 관련 텍스트 존재
2. grep "90초" .planning/deliverables/28-daemon-lifecycle-cli.md -- 전체 상한 명시
3. grep "fail-soft" .planning/deliverables/28-daemon-lifecycle-cli.md -- fail-soft 정책 구분
4. grep "DAEMON_STARTUP_TIMEOUT" .planning/deliverables/28-daemon-lifecycle-cli.md -- 전체 타임아웃 에러 코드
5. grep "D-1" .planning/deliverables/28-daemon-lifecycle-cli.md -- v0.10 매핑 존재
</verification>

<success_criteria>
- 28-daemon §2에 시작 단계별 타임아웃 + fail-fast/soft 정책 테이블이 존재한다
- 전체 90초 상한이 AbortController 의사코드와 함께 명시되어 있다
- v0.10 objectives D-1의 6단계와 28-daemon의 7단계 간 매핑이 명확하다
- Step 4만 fail-soft이고 나머지 필수 단계는 fail-fast임이 테이블에서 즉시 식별 가능하다
</success_criteria>

<output>
After completion, create `.planning/phases/44-operational-logic-completion/44-01-SUMMARY.md`
</output>
