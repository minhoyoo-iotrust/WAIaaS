---
phase: 101-settings-api-hot-reload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/admin-settings-api.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /v1/admin/settings returns all settings grouped by category with credential values masked as boolean"
    - "PUT /v1/admin/settings accepts partial key-value updates, persists to DB, and returns updated settings"
    - "POST /v1/admin/settings/test-rpc connects to a given RPC URL and reports success/failure"
    - "All three endpoints require masterAuth (401 without valid credentials)"
    - "Unknown setting keys in PUT body are rejected with 400"
  artifacts:
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "3 new settings endpoints in adminRoutes"
      contains: "settingsGetRoute|settingsPutRoute|testRpcRoute"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "Zod schemas for settings API request/response"
      contains: "SettingsResponseSchema|SettingsUpdateRequestSchema|TestRpcRequestSchema"
    - path: "packages/daemon/src/__tests__/admin-settings-api.test.ts"
      provides: "Tests for settings API endpoints"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      via: "settingsService.getAllMasked() and settingsService.setMany()"
      pattern: "settingsService\\.(getAllMasked|setMany|set)"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/admin.ts"
      via: "settingsService passed through AdminRouteDeps"
      pattern: "settingsService"
---

<objective>
Implement GET /v1/admin/settings, PUT /v1/admin/settings, and POST /v1/admin/settings/test-rpc REST endpoints for admin settings management.

Purpose: Expose SettingsService (Phase 100) to the Admin UI and API consumers. The GET endpoint returns all settings with masked credentials, PUT updates settings and triggers hot-reload (wired in Plan 02), and test-rpc validates RPC connectivity before committing a URL change.

Output: 3 new admin endpoints, OpenAPI schemas, masterAuth integration, comprehensive tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/100-settings-infra/100-01-SUMMARY.md
@.planning/phases/100-settings-infra/100-02-SUMMARY.md
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/infrastructure/settings/settings-service.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings API endpoints + OpenAPI schemas</name>
  <files>
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
**1. OpenAPI schemas** (openapi-schemas.ts):

Add 4 new schemas:

```typescript
// Settings GET response: category-grouped with masked credentials
export const SettingsResponseSchema = z.object({
  notifications: z.record(z.union([z.string(), z.boolean()])),
  rpc: z.record(z.union([z.string(), z.boolean()])),
  security: z.record(z.union([z.string(), z.boolean()])),
  daemon: z.record(z.union([z.string(), z.boolean()])),
  walletconnect: z.record(z.union([z.string(), z.boolean()])),
}).openapi('SettingsResponse');

// Settings PUT request: flat key-value pairs
export const SettingsUpdateRequestSchema = z.object({
  settings: z.array(z.object({
    key: z.string(),
    value: z.string(),
  })).min(1),
}).openapi('SettingsUpdateRequest');

// Settings PUT response: updated masked settings
export const SettingsUpdateResponseSchema = z.object({
  updated: z.number().int(),
  settings: SettingsResponseSchema,
}).openapi('SettingsUpdateResponse');

// Test RPC request + response
export const TestRpcRequestSchema = z.object({
  url: z.string().url(),
  chain: z.enum(['solana', 'ethereum']).optional().default('ethereum'),
}).openapi('TestRpcRequest');

export const TestRpcResponseSchema = z.object({
  success: z.boolean(),
  latencyMs: z.number().optional(),
  error: z.string().optional(),
  chainId: z.string().optional(),
  blockNumber: z.number().optional(),
}).openapi('TestRpcResponse');
```

**2. AdminRouteDeps** (admin.ts):

Add `settingsService` to the `AdminRouteDeps` interface:
```typescript
settingsService?: SettingsService;
```
Import SettingsService type from `../../infrastructure/settings/index.js`.

Add an `onSettingsChanged` optional callback to AdminRouteDeps:
```typescript
onSettingsChanged?: (changedKeys: string[]) => void;
```

**3. Route definitions** (admin.ts):

Add 3 route definitions using the `createRoute` pattern already established:

- `settingsGetRoute`: GET /admin/settings, tags ['Admin'], response 200 with SettingsResponseSchema
- `settingsPutRoute`: PUT /admin/settings, tags ['Admin'], request body SettingsUpdateRequestSchema, response 200 with SettingsUpdateResponseSchema, error 400 (ACTION_VALIDATION_FAILED for unknown keys)
- `testRpcRoute`: POST /admin/settings/test-rpc, tags ['Admin'], request body TestRpcRequestSchema, response 200 with TestRpcResponseSchema

**4. Route handlers** (admin.ts):

**GET /admin/settings handler:**
- If `!deps.settingsService`, return empty object with 5 empty category objects
- Call `deps.settingsService.getAllMasked()` and return the result directly
- The returned data is already category-grouped with credentials masked as boolean

**PUT /admin/settings handler:**
- Validate request body with SettingsUpdateRequestSchema
- For each entry in `settings` array, validate that key exists in SETTING_DEFINITIONS (import `getSettingDefinition` from settings module). If any unknown key, throw WAIaaSError('ACTION_VALIDATION_FAILED', { message: `Unknown setting key: ${key}` })
- Call `deps.settingsService.setMany(entries)` to persist all values
- If `deps.onSettingsChanged`, call it with the array of changed keys
- Return `{ updated: entries.length, settings: deps.settingsService.getAllMasked() }`

**POST /admin/settings/test-rpc handler:**
- Extract `url` and `chain` from request body
- Perform an RPC connectivity test:
  - For `chain === 'ethereum'`: Use `fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ jsonrpc: '2.0', method: 'eth_blockNumber', params: [], id: 1 }) })` with AbortSignal.timeout(5000). Parse result; on success return `{ success: true, latencyMs, blockNumber }`. On error return `{ success: false, error: message }`.
  - For `chain === 'solana'`: Use `fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ jsonrpc: '2.0', method: 'getBlockHeight', params: [], id: 1 }) })` with AbortSignal.timeout(5000). Parse result; on success return `{ success: true, latencyMs, blockNumber }`. On error return `{ success: false, error: message }`.
- Measure latency with `performance.now()` before/after the fetch call
- Always return 200 (even on RPC failure -- the response body indicates success/failure)

**5. Server wiring** (server.ts):

In `createApp()`, add to CreateAppDeps interface:
```typescript
settingsService?: SettingsService;
onSettingsChanged?: (changedKeys: string[]) => void;
```
Import SettingsService type.

In the admin routes section, pass `settingsService: deps.settingsService` and `onSettingsChanged: deps.onSettingsChanged` to `adminRoutes()`.

Add masterAuth for the new settings routes:
```typescript
app.use('/v1/admin/settings', masterAuthForAdmin);
app.use('/v1/admin/settings/*', masterAuthForAdmin);
```
Add this inside the existing `if (deps.masterPasswordHash !== undefined)` block that handles admin auth, right after the `/v1/admin/notifications/*` line.

**6. Barrel export** (routes/index.ts):

No changes needed -- AdminRouteDeps already exported. But ensure any new types needed are accessible.

**Important patterns to follow:**
- Use `openApiValidationHook` for the router (already established)
- All endpoints use OpenAPI `createRoute` + `router.openapi()` pattern
- Timestamps in epoch seconds (Math.floor(Date.now() / 1000))
- Error handling via WAIaaSError throw (caught by errorHandler middleware)
  </action>
  <verify>
    - `npx tsc --noEmit -p packages/daemon/tsconfig.json` passes
    - No import errors in the modified files
    - Review admin.ts has 12 route handlers (9 existing + 3 new)
  </verify>
  <done>
    GET /admin/settings, PUT /admin/settings, POST /admin/settings/test-rpc route definitions and handlers exist with proper OpenAPI schemas, AdminRouteDeps includes settingsService, CreateAppDeps includes settingsService, and masterAuth is wired for all 3 new routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings API tests + daemon.ts wiring</name>
  <files>
    packages/daemon/src/__tests__/admin-settings-api.test.ts
    packages/daemon/src/lifecycle/daemon.ts
  </files>
  <action>
**1. daemon.ts wiring:**

In Step 5 (HTTP server), pass `settingsService` to createApp:
```typescript
settingsService: this._settingsService ?? undefined,
```
Add it in the `createApp({...})` call object, after `notificationService`.

Also add `onSettingsChanged` callback (placeholder for Plan 02 hot-reload):
```typescript
onSettingsChanged: undefined, // Wired in Phase 101-02 for hot-reload
```

**2. Test file** (admin-settings-api.test.ts):

Create a comprehensive test suite following the existing test patterns (see `admin-notification-api.test.ts` for reference pattern). Use `createApp()` directly with mock deps.

**Setup:**
- Import `createApp` from `../api/server.js`
- Import `createDatabase, pushSchema` from infrastructure
- Import `SettingsService, SETTING_DEFINITIONS` from settings module
- Create in-memory SQLite DB for each test with `createDatabase(':memory:')`
- Create SettingsService instance with test DB, mock config, and test master password
- Create app via `createApp({ db, settingsService, masterPasswordHash })` (pre-hash with argon2)
- Use `app.request()` for testing (Hono test pattern)
- Add masterAuth header: `Authorization: Bearer <masterPassword>` base64 encoded

**Test cases (aim for ~15 tests):**

GET /v1/admin/settings:
1. Returns 200 with all 5 categories (notifications, rpc, security, daemon, walletconnect)
2. Returns default values when no DB entries exist
3. Returns masked boolean for credential keys (telegram_bot_token, discord_webhook_url)
4. Returns actual values for non-credential keys
5. Returns 401 without masterAuth header

PUT /v1/admin/settings:
6. Returns 200 and updates a single non-credential setting (e.g., daemon.log_level = 'debug')
7. Returns 200 and updates multiple settings in one request
8. Returns 400 for unknown setting key
9. Persists credential values encrypted in DB (set telegram_bot_token, verify DB value is encrypted)
10. Returns updated masked settings in response body
11. Returns 401 without masterAuth header

POST /v1/admin/settings/test-rpc:
12. Returns 200 with success:false for unreachable URL (use http://127.0.0.1:1 to get connection refused)
13. Returns 200 with success:false for invalid URL
14. Returns 401 without masterAuth header

**Testing pattern:**
```typescript
const res = await app.request('/v1/admin/settings', {
  method: 'GET',
  headers: { Authorization: `Bearer ${Buffer.from(masterPassword).toString('base64')}` },
});
expect(res.status).toBe(200);
const body = await res.json();
```

Use `describe('Settings API')` with nested `describe` blocks for each endpoint.
  </action>
  <verify>
    - `npx vitest run packages/daemon/src/__tests__/admin-settings-api.test.ts` all tests pass
    - `npx tsc --noEmit -p packages/daemon/tsconfig.json` passes
  </verify>
  <done>
    Test file covers GET/PUT/POST settings endpoints with 12+ tests including auth checks, default values, credential masking, persistence, validation errors, and RPC test. daemon.ts passes settingsService to createApp.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/daemon/tsconfig.json` -- TypeScript compilation
2. `npx vitest run packages/daemon/src/__tests__/admin-settings-api.test.ts` -- New test suite passes
3. `npx vitest run packages/daemon/src/__tests__/` -- Existing tests not broken
4. Verify GET /admin/settings returns 5 categories with masked credentials
5. Verify PUT /admin/settings rejects unknown keys with 400
6. Verify POST /admin/settings/test-rpc returns structured success/failure
</verification>

<success_criteria>
- 3 new REST endpoints operational: GET, PUT, POST under /v1/admin/settings
- All endpoints require masterAuth (401 without)
- GET returns category-grouped settings with credential masking (boolean)
- PUT validates keys against SETTING_DEFINITIONS, persists to DB, returns updated state
- POST test-rpc performs actual HTTP call to test RPC connectivity
- 12+ tests passing in new test file
- Existing tests unbroken
</success_criteria>

<output>
After completion, create `.planning/phases/101-settings-api-hot-reload/101-01-SUMMARY.md`
</output>
