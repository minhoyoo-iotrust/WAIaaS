---
phase: 142-balance-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/enums/notification.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/daemon/src/services/monitoring/balance-monitor-service.ts
  - packages/daemon/src/__tests__/balance-monitor-service.test.ts
autonomous: true

must_haves:
  truths:
    - "BalanceMonitorService가 주기적으로 모든 활성 월렛의 네이티브 토큰 잔액을 체크한다"
    - "잔액이 체인별 임계값(SOL 0.01, ETH 0.005) 이하이면 LOW_BALANCE 알림이 발송된다"
    - "NotificationEventType에 LOW_BALANCE가 추가되고 en/ko 메시지 템플릿이 제공된다"
  artifacts:
    - path: "packages/daemon/src/services/monitoring/balance-monitor-service.ts"
      provides: "BalanceMonitorService 주기적 잔액 체크 + LOW_BALANCE 알림"
      exports: ["BalanceMonitorService", "BalanceMonitorConfig", "DEFAULT_BALANCE_MONITOR_CONFIG"]
    - path: "packages/core/src/enums/notification.ts"
      provides: "LOW_BALANCE NotificationEventType"
      contains: "LOW_BALANCE"
    - path: "packages/core/src/i18n/en.ts"
      provides: "LOW_BALANCE 영문 알림 템플릿"
      contains: "LOW_BALANCE"
    - path: "packages/core/src/i18n/ko.ts"
      provides: "LOW_BALANCE 한글 알림 템플릿"
      contains: "LOW_BALANCE"
    - path: "packages/daemon/src/__tests__/balance-monitor-service.test.ts"
      provides: "BalanceMonitorService 단위 테스트"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/services/monitoring/balance-monitor-service.ts"
      to: "packages/daemon/src/notifications/notification-service.ts"
      via: "notificationService.notify('LOW_BALANCE', ...)"
      pattern: "notify.*LOW_BALANCE"
    - from: "packages/daemon/src/services/monitoring/balance-monitor-service.ts"
      to: "IChainAdapter.getBalance()"
      via: "AdapterPool.resolve() -> adapter.getBalance()"
      pattern: "adapter\\.getBalance"
---

<objective>
BalanceMonitorService 코어 구현 + LOW_BALANCE 이벤트/알림 인프라

Purpose: 월렛 가스비가 부족해지기 전에 사용자가 사전 알림을 받아 자금을 충전할 수 있도록, 주기적 잔액 체크 서비스와 LOW_BALANCE 알림 인프라를 구현한다.
Output: BalanceMonitorService (setInterval 기반 주기적 체크), LOW_BALANCE NotificationEventType, en/ko i18n 템플릿, 단위 테스트
</objective>

<execution_context>
@.planning/phases/142-balance-monitoring/142-01-PLAN.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md (BMON-01 ~ BMON-06)
@.planning/phases/141-autostop-engine/141-02-SUMMARY.md

@packages/daemon/src/services/autostop-service.ts (서비스 구조 패턴)
@packages/daemon/src/services/autostop-rules.ts (순수 인메모리 규칙 패턴)
@packages/core/src/enums/notification.ts (NotificationEventType 배열)
@packages/core/src/i18n/en.ts (i18n 알림 템플릿 패턴)
@packages/core/src/i18n/ko.ts (i18n 알림 템플릿 패턴)
@packages/daemon/src/notifications/notification-service.ts (notify 호출 패턴)
@packages/daemon/src/notifications/templates/message-templates.ts (메시지 보간 패턴)
@packages/daemon/src/__tests__/autostop-service.test.ts (테스트 DB 생성 패턴)
@packages/core/src/interfaces/chain-adapter.types.ts (BalanceInfo 인터페이스)
</context>

<tasks>

<task type="auto">
  <name>Task 1: LOW_BALANCE NotificationEventType + i18n 템플릿</name>
  <files>
    packages/core/src/enums/notification.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
  </files>
  <action>
1. `packages/core/src/enums/notification.ts` -- NOTIFICATION_EVENT_TYPES 배열에 `'LOW_BALANCE'` 추가 (24번째 이벤트, CUMULATIVE_LIMIT_WARNING 다음).

2. `packages/core/src/i18n/en.ts` -- notifications 객체에 LOW_BALANCE 추가:
```typescript
LOW_BALANCE: { title: 'Low Balance Alert', body: 'Wallet {walletId} balance low: {balance} {currency}. Threshold: {threshold} {currency}. Please top up.' },
```

3. `packages/core/src/i18n/ko.ts` -- notifications 객체에 LOW_BALANCE 추가:
```typescript
LOW_BALANCE: { title: '잔액 부족 알림', body: '월렛 {walletId} 잔액 부족: {balance} {currency}. 임계값: {threshold} {currency}. 자금을 충전해주세요.' },
```

Messages 인터페이스의 `notifications: Record<NotificationEventType, { title: string; body: string }>` 타입이 자동으로 새 키를 요구하므로, 두 locale 파일 모두에 추가하지 않으면 TypeScript 컴파일 에러가 발생한다.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build` 성공 (타입 체크 포함).
`grep -c LOW_BALANCE packages/core/src/enums/notification.ts` = 1.
`grep -c LOW_BALANCE packages/core/src/i18n/en.ts` >= 1.
`grep -c LOW_BALANCE packages/core/src/i18n/ko.ts` >= 1.
  </verify>
  <done>
NOTIFICATION_EVENT_TYPES에 LOW_BALANCE가 24번째 이벤트로 추가되고, en/ko 양쪽에 {walletId}/{balance}/{currency}/{threshold} 변수를 사용하는 알림 템플릿이 정의된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: BalanceMonitorService 코어 + 단위 테스트</name>
  <files>
    packages/daemon/src/services/monitoring/balance-monitor-service.ts
    packages/daemon/src/__tests__/balance-monitor-service.test.ts
  </files>
  <action>
**BalanceMonitorService** (`packages/daemon/src/services/monitoring/balance-monitor-service.ts`):

AutoStopService 패턴을 따르되, 이벤트 구독 대신 setInterval 기반 주기적 체크를 수행한다.

```typescript
// BalanceMonitorConfig 인터페이스
export interface BalanceMonitorConfig {
  checkIntervalSec: number;          // default 300 (5분)
  lowBalanceThresholdSol: number;    // default 0.01 (SOL)
  lowBalanceThresholdEth: number;    // default 0.005 (ETH)
  cooldownHours: number;             // default 24 (중복 알림 방지)
  enabled: boolean;                  // default true
}

export const DEFAULT_BALANCE_MONITOR_CONFIG: BalanceMonitorConfig = {
  checkIntervalSec: 300,
  lowBalanceThresholdSol: 0.01,
  lowBalanceThresholdEth: 0.005,
  cooldownHours: 24,
  enabled: true,
};
```

Constructor 패턴 (AutoStopService와 동일 DI 스타일):
```typescript
constructor(opts: {
  sqlite: Database;
  adapterPool: AdapterPool;
  config: DaemonConfig;       // RPC URL 해석용
  notificationService?: NotificationService;
  monitorConfig?: Partial<BalanceMonitorConfig>;
})
```

**핵심 메서드:**

1. `start()`: `if (!this.config.enabled) return;` setInterval로 `checkAllWallets()` 등록.

2. `stop()`: clearInterval.

3. `checkAllWallets()`: (private)
   - better-sqlite3 직접 SQL로 ACTIVE 월렛 전체 조회: `SELECT id, chain, environment, default_network, public_key FROM wallets WHERE status = 'ACTIVE'`
   - 각 월렛에 대해:
     a. `resolveRpcUrl()` + `adapterPool.resolve()` 로 어댑터 얻기
     b. `adapter.getBalance(publicKey)` 호출
     c. BalanceInfo.balance (bigint lamports/wei)를 decimal로 변환: `Number(balance) / 10 ** decimals`
     d. 체인별 임계값 비교: solana -> lowBalanceThresholdSol, ethereum -> lowBalanceThresholdEth
     e. 임계값 이하이면 `shouldNotify()` 확인 후 `notifyLowBalance()` 호출
   - 개별 월렛 체크 실패 시 try/catch로 격리 (한 월렛 실패가 전체 체크를 중단하면 안 됨)

4. `shouldNotify(walletId: string)`: (private) 중복 알림 방지 로직
   - `lastNotified` Map<string, { timestamp: number; wasLow: boolean }> 인메모리 관리
   - 24시간 이내에 이미 알림을 보냈으면 false 반환
   - 잔액이 회복(임계값 초과)된 후 다시 하락하면 새 알림 허용 (BMON-04)

5. `notifyLowBalance(walletId, balance, currency, threshold)`: (private)
   - `notificationService?.notify('LOW_BALANCE', walletId, { walletId, balance: String(balance), currency, threshold: String(threshold) })`
   - fire-and-forget (void this.notificationService?.notify(...))
   - `lastNotified` 맵 갱신

6. `markRecovered(walletId: string)`: (private) 잔액 회복 시 호출
   - lastNotified 맵에서 wasLow = false로 설정 (24시간 쿨다운 리셋은 하지 않음, 단 회복 후 재하락 시 새 알림 허용)

7. `updateConfig(config: Partial<BalanceMonitorConfig>)`: 런타임 설정 변경 (AutoStopService.updateConfig 패턴)
   - checkIntervalSec 변경 시 타이머 재시작
   - 다른 값은 즉시 반영

8. `getStatus()`: 모니터링/디버깅용 상태 반환
   ```typescript
   { enabled: boolean; config: BalanceMonitorConfig; trackedWallets: number; }
   ```

**주의사항:**
- AdapterPool.resolve()는 async이므로 checkAllWallets는 async 메서드
- setInterval 콜백에서 `void this.checkAllWallets()` 호출
- 체인별 임계값 매핑: `this.getThreshold(chain)` 헬퍼 -- 'solana' -> lowBalanceThresholdSol, 'ethereum' -> lowBalanceThresholdEth
- getDefaultNetwork import: `@waiaas/core`의 getDefaultNetwork를 사용하여 default_network가 null인 월렛의 네트워크 해석
- import 경로: `import { resolveRpcUrl } from '../../infrastructure/adapter-pool.js'`

**단위 테스트** (`packages/daemon/src/__tests__/balance-monitor-service.test.ts`):

autostop-service.test.ts 패턴을 따름. in-memory SQLite + mock AdapterPool + mock NotificationService.

테스트 케이스:
1. **BMON-01**: 활성 월렛 잔액 체크 -- mock adapter.getBalance가 호출되는지 확인
2. **BMON-02 SOL**: SOL 잔액 0.005 (임계값 0.01 이하) -> LOW_BALANCE notify 호출
3. **BMON-02 ETH**: ETH 잔액 0.003 (임계값 0.005 이하) -> LOW_BALANCE notify 호출
4. **임계값 이상**: SOL 잔액 1.0 -> notify 미호출
5. **BMON-03 중복 방지**: 첫 번째 체크에서 알림 후, 두 번째 체크에서 미발송 (24시간 이내)
6. **BMON-04 회복 후 재하락**: 임계값 이하 -> 알림 -> 임계값 초과(회복) -> 임계값 이하 -> 새 알림
7. **disabled**: config.enabled=false -> start() 시 타이머 미등록
8. **stop()**: clearInterval 호출 확인
9. **개별 월렛 실패 격리**: adapter.getBalance 실패 월렛이 있어도 나머지 월렛은 정상 체크
10. **updateConfig**: 임계값 런타임 변경 반영

mock 패턴:
```typescript
const mockAdapter = {
  getBalance: vi.fn().mockResolvedValue({
    address: 'testAddr',
    balance: 5_000_000n, // 0.005 SOL (9 decimals)
    decimals: 9,
    symbol: 'SOL',
  }),
};

const mockAdapterPool = {
  resolve: vi.fn().mockResolvedValue(mockAdapter),
};

const mockNotificationService = {
  notify: vi.fn().mockResolvedValue(undefined),
};
```

DB 테이블 생성: autostop-service.test.ts의 createTestDb 패턴과 동일하게 wallets 테이블 생성.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/balance-monitor-service.test.ts` 전체 통과.
`pnpm --filter @waiaas/daemon build` 성공 (타입 체크).
  </verify>
  <done>
BalanceMonitorService가 주기적으로 활성 월렛의 네이티브 토큰 잔액을 체크하고, 체인별 임계값 이하이면 LOW_BALANCE 알림을 발송하며, 24시간 중복 방지 + 잔액 회복 후 재하락 알림이 동작한다. 10개 이상 테스트 통과.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core build` -- LOW_BALANCE 타입 추가 후 빌드 성공
2. `pnpm --filter @waiaas/daemon build` -- BalanceMonitorService 빌드 성공
3. `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/balance-monitor-service.test.ts` -- 전체 통과
4. `grep LOW_BALANCE packages/core/src/enums/notification.ts` -- 존재 확인
5. `grep LOW_BALANCE packages/core/src/i18n/en.ts` -- 존재 확인
6. `grep LOW_BALANCE packages/core/src/i18n/ko.ts` -- 존재 확인
</verification>

<success_criteria>
- LOW_BALANCE NotificationEventType이 추가되고 en/ko 템플릿이 정의됨
- BalanceMonitorService가 setInterval 기반으로 활성 월렛 잔액을 주기적 체크
- 체인별 임계값(SOL 0.01, ETH 0.005) 비교 후 LOW_BALANCE 알림 발송
- 24시간 중복 알림 방지 + 잔액 회복 후 재하락 시 새 알림 발송
- 개별 월렛 체크 실패가 전체 체크를 중단하지 않음
- 10개 이상 단위 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/142-balance-monitoring/142-01-SUMMARY.md`
</output>
