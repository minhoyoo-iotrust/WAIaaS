---
phase: 135-7type-forms-vis-edit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/components/policy-forms/allowed-tokens-form.tsx
  - packages/admin/src/components/policy-forms/contract-whitelist-form.tsx
  - packages/admin/src/components/policy-forms/method-whitelist-form.tsx
  - packages/admin/src/components/policy-forms/approved-spenders-form.tsx
  - packages/admin/src/components/policy-forms/time-restriction-form.tsx
  - packages/admin/src/components/policy-forms/allowed-networks-form.tsx
  - packages/admin/src/components/policy-forms/x402-allowed-domains-form.tsx
  - packages/admin/src/components/policy-forms/index.tsx
  - packages/admin/src/pages/policies.tsx
autonomous: true

must_haves:
  truths:
    - "ALLOWED_TOKENS 타입 선택 시 토큰 동적 행 폼이 렌더링된다 (address, symbol, chain 셀렉트)"
    - "CONTRACT_WHITELIST 타입 선택 시 컨트랙트 동적 행 폼이 렌더링된다 (address, name, chain 셀렉트)"
    - "METHOD_WHITELIST 타입 선택 시 2단계 중첩 동적 행 폼이 렌더링된다 (contractAddress + selectors[])"
    - "APPROVED_SPENDERS 타입 선택 시 spender 동적 행 폼이 렌더링된다 (address, name, maxAmount)"
    - "TIME_RESTRICTION 타입 선택 시 시간 범위 셀렉트 + 요일 체크박스 7개가 렌더링된다"
    - "ALLOWED_NETWORKS 타입 선택 시 네트워크 동적 행 폼이 렌더링된다 (network 셀렉트, name 텍스트)"
    - "X402_ALLOWED_DOMAINS 타입 선택 시 도메인 패턴 동적 행 폼이 렌더링된다"
    - "7개 타입 모두 validateRules 클라이언트 유효성 검증이 동작한다"
  artifacts:
    - path: "packages/admin/src/components/policy-forms/allowed-tokens-form.tsx"
      provides: "ALLOWED_TOKENS 전용 폼 컴포넌트"
      min_lines: 30
    - path: "packages/admin/src/components/policy-forms/contract-whitelist-form.tsx"
      provides: "CONTRACT_WHITELIST 전용 폼 컴포넌트"
      min_lines: 30
    - path: "packages/admin/src/components/policy-forms/method-whitelist-form.tsx"
      provides: "METHOD_WHITELIST 전용 폼 컴포넌트 (2단계 중첩)"
      min_lines: 50
    - path: "packages/admin/src/components/policy-forms/approved-spenders-form.tsx"
      provides: "APPROVED_SPENDERS 전용 폼 컴포넌트"
      min_lines: 30
    - path: "packages/admin/src/components/policy-forms/time-restriction-form.tsx"
      provides: "TIME_RESTRICTION 전용 폼 컴포넌트"
      min_lines: 40
    - path: "packages/admin/src/components/policy-forms/allowed-networks-form.tsx"
      provides: "ALLOWED_NETWORKS 전용 폼 컴포넌트"
      min_lines: 30
    - path: "packages/admin/src/components/policy-forms/x402-allowed-domains-form.tsx"
      provides: "X402_ALLOWED_DOMAINS 전용 폼 컴포넌트"
      min_lines: 20
    - path: "packages/admin/src/components/policy-forms/index.tsx"
      provides: "PolicyFormRouter 12개 타입 전체 분기"
      exports: ["PolicyFormRouter", "PolicyFormProps"]
  key_links:
    - from: "packages/admin/src/components/policy-forms/index.tsx"
      to: "7개 신규 폼 컴포넌트"
      via: "switch/case import"
      pattern: "case 'ALLOWED_TOKENS'|case 'CONTRACT_WHITELIST'|case 'METHOD_WHITELIST'"
    - from: "packages/admin/src/pages/policies.tsx"
      to: "validateRules 함수"
      via: "7개 타입 유효성 검증 분기"
      pattern: "else if.*type.*===.*'ALLOWED_TOKENS'"
---

<objective>
7개 나머지 정책 타입(ALLOWED_TOKENS, CONTRACT_WHITELIST, METHOD_WHITELIST, APPROVED_SPENDERS, TIME_RESTRICTION, ALLOWED_NETWORKS, X402_ALLOWED_DOMAINS)의 전용 폼 컴포넌트를 구현하고 PolicyFormRouter에 통합한다.

Purpose: Phase 134에서 5개 타입 전용 폼을 완성했으므로, 나머지 7개 타입의 전용 폼을 추가하여 12개 PolicyType 모두가 JSON 입력 없이 구조화된 폼으로 정책을 생성할 수 있게 한다.
Output: 7개 신규 폼 컴포넌트 파일 + PolicyFormRouter 12-type 분기 완성 + validateRules 7-type 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/134-form-infra-5type-forms/134-01-SUMMARY.md
@.planning/phases/134-form-infra-5type-forms/134-02-SUMMARY.md

@packages/admin/src/components/policy-forms/index.tsx
@packages/admin/src/components/policy-forms/whitelist-form.tsx
@packages/admin/src/components/policy-forms/spending-limit-form.tsx
@packages/admin/src/components/dynamic-row-list.tsx
@packages/admin/src/pages/policies.tsx
@packages/core/src/schemas/policy.schema.ts
@packages/core/src/enums/chain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 7개 타입 전용 폼 컴포넌트 + PolicyFormRouter 12-type 통합</name>
  <files>
    packages/admin/src/components/policy-forms/allowed-tokens-form.tsx
    packages/admin/src/components/policy-forms/contract-whitelist-form.tsx
    packages/admin/src/components/policy-forms/method-whitelist-form.tsx
    packages/admin/src/components/policy-forms/approved-spenders-form.tsx
    packages/admin/src/components/policy-forms/time-restriction-form.tsx
    packages/admin/src/components/policy-forms/allowed-networks-form.tsx
    packages/admin/src/components/policy-forms/x402-allowed-domains-form.tsx
    packages/admin/src/components/policy-forms/index.tsx
  </files>
  <action>
Phase 134에서 확립된 패턴(PolicyFormProps 인터페이스, DynamicRowList, FormField)을 따라 7개 폼 컴포넌트를 생성한다.

**AllowedTokensForm** (PFORM-05):
- DynamicRowList 기반, 행 타입: `{address: string, symbol: string, chain: string}`
- 각 행에 address(텍스트, required), symbol(텍스트, optional), chain(셀렉트: '', 'solana', 'ethereum' -- 빈값=전체)
- renderRow에서 3개 필드를 가로 배치 (dynamic-row-fields flex)
- onChange에서 rules.tokens 배열 갱신
- Zod 스키마 참고: `AllowedTokensRulesSchema` -- tokens[].address min(1), symbol optional, chain ChainTypeEnum optional

**ContractWhitelistForm** (PFORM-06):
- DynamicRowList 기반, 행 타입: `{address: string, name: string, chain: string}`
- 각 행에 address(텍스트, required), name(텍스트, optional), chain(셀렉트: '', 'solana', 'ethereum')
- onChange에서 rules.contracts 배열 갱신
- Zod: `ContractWhitelistRulesSchema` -- contracts[].address min(1), name optional, chain optional

**MethodWhitelistForm** (PFORM-07):
- 2단계 중첩 구조: 외부 DynamicRowList로 method 엔트리 관리 (contractAddress + selectors[])
- 각 method 행 내부에 contractAddress 텍스트 + selectors용 내부 DynamicRowList (문자열 배열)
- renderRow 내부에서 selectors 행 추가/삭제를 독립적으로 처리
- 외부 행 타입: `{contractAddress: string, selectors: string[]}`
- onChange에서 rules.methods 배열 갱신
- Zod: `MethodWhitelistRulesSchema` -- methods[].contractAddress min(1), selectors[] min(1)

**ApprovedSpendersForm** (PFORM-08):
- DynamicRowList 기반, 행 타입: `{address: string, name: string, maxAmount: string}`
- 각 행에 address(텍스트, required), name(텍스트, optional), maxAmount(텍스트, optional -- "Leave empty for unlimited")
- maxAmount가 빈 값이면 해당 필드를 객체에서 제거 (Zod optional 매칭)
- Zod: `ApprovedSpendersRulesSchema` -- spenders[].address min(1), name optional, maxAmount regex(/^\d+$/) optional

**TimeRestrictionForm** (PFORM-03):
- DynamicRowList 사용하지 않음 -- 고정 구조
- allowed_hours: start(셀렉트 0-23), end(셀렉트 1-24) -- 두 개의 FormField type="select"
- allowed_days: 7개 체크박스 (Sun=0, Mon=1, Tue=2, Wed=3, Thu=4, Fri=5, Sat=6) -- 라벨과 함께 가로 배치
- 체크박스 checked 시 allowed_days 배열에 해당 숫자 추가, unchecked 시 제거
- Zod: `TimeRestrictionRulesSchema` -- allowed_hours.start 0-23, end 1-24, allowed_days[] 0-6 min(1)

**AllowedNetworksForm** (PFORM-11):
- DynamicRowList 기반, 행 타입: `{network: string, name: string}`
- network: FormField type="select" -- NETWORK_TYPES 배열에서 옵션 생성 (mainnet, devnet, testnet, ethereum-mainnet, ethereum-sepolia, polygon-mainnet, polygon-amoy, arbitrum-mainnet, arbitrum-sepolia, optimism-mainnet, optimism-sepolia, base-mainnet, base-sepolia)
- 하드코딩으로 옵션 배열 정의 (NETWORK_TYPES를 admin에서 import할 수 없으므로 -- core는 Node.js 전용)
- name: 텍스트(optional)
- Zod: `AllowedNetworksRulesSchema` -- networks[].network NetworkTypeEnum, name optional

**X402AllowedDomainsForm** (PFORM-12):
- DynamicRowList 기반, 행 타입: string (단일 문자열 배열)
- WhitelistForm과 동일 패턴 -- domain 텍스트 입력, placeholder "e.g. api.example.com or *.service.io"
- Zod: `X402AllowedDomainsRulesSchema` -- domains[] min(1), 각 문자열 min(1)

**PolicyFormRouter (index.tsx) 업데이트:**
- 7개 새 컴포넌트 import 추가
- switch/case에 7개 case 추가 (ALLOWED_TOKENS, CONTRACT_WHITELIST, METHOD_WHITELIST, APPROVED_SPENDERS, TIME_RESTRICTION, ALLOWED_NETWORKS, X402_ALLOWED_DOMAINS)
- default 폴백의 placeholder 문구 유지 (향후 새 타입 대비)
- JSDoc 주석 업데이트: "12 core types with dedicated forms"

chain 셀렉트 옵션은 ALLOWED_TOKENS/CONTRACT_WHITELIST 모두에서 사용하므로, 각 폼 내부에 `const CHAIN_OPTIONS = [{label: 'All Chains', value: ''}, {label: 'Solana', value: 'solana'}, {label: 'Ethereum', value: 'ethereum'}]` 로컬 상수로 정의한다.

NETWORK_OPTIONS는 AllowedNetworksForm 내부에 `const NETWORK_OPTIONS = [{label: 'mainnet', value: 'mainnet'}, {label: 'devnet', value: 'devnet'}, ...]` 형태로 하드코딩한다 (13개 네트워크).
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter admin build` 성공 확인. 12개 타입 모두 PolicyFormRouter에서 import되고 switch/case 처리되는지 grep으로 확인: `grep -c "case '" packages/admin/src/components/policy-forms/index.tsx` -- 12 이상이어야 함.
  </verify>
  <done>7개 신규 폼 컴포넌트 파일이 생성되고, PolicyFormRouter가 12개 타입 전체를 전용 폼으로 라우팅하며, Admin 빌드가 성공한다.</done>
</task>

<task type="auto">
  <name>Task 2: validateRules 7-type 유효성 검증 추가</name>
  <files>
    packages/admin/src/pages/policies.tsx
  </files>
  <action>
policies.tsx의 `validateRules` 함수에 7개 타입의 클라이언트 유효성 검증 로직을 추가한다.

**ALLOWED_TOKENS 검증:**
- tokens 배열 길이 0이면 `errors.tokens = 'At least one token required'`
- 각 token의 address가 빈 값이면 `errors['tokens.{i}.address'] = 'Address required'`

**CONTRACT_WHITELIST 검증:**
- contracts 배열 길이 0이면 `errors.contracts = 'At least one contract required'`
- 각 contract의 address가 빈 값이면 `errors['contracts.{i}.address'] = 'Address required'`

**METHOD_WHITELIST 검증:**
- methods 배열 길이 0이면 `errors.methods = 'At least one method entry required'`
- 각 method의 contractAddress가 빈 값이면 `errors['methods.{i}.contractAddress'] = 'Contract address required'`
- 각 method의 selectors 배열 길이 0이면 `errors['methods.{i}.selectors'] = 'At least one selector required'`
- 각 selector가 빈 값이면 `errors['methods.{i}.selectors.{j}'] = 'Selector required'`

**APPROVED_SPENDERS 검증:**
- spenders 배열 길이 0이면 `errors.spenders = 'At least one spender required'`
- 각 spender의 address가 빈 값이면 `errors['spenders.{i}.address'] = 'Address required'`
- maxAmount가 비어있지 않고 /^\d+$/ 매칭 실패하면 `errors['spenders.{i}.maxAmount'] = 'Must be a positive integer'`

**TIME_RESTRICTION 검증:**
- allowed_days 배열 길이 0이면 `errors.allowed_days = 'At least one day required'`
- allowed_hours.start >= allowed_hours.end이면 `errors.allowed_hours = 'Start must be before end'`
- (start/end 범위는 셀렉트이므로 기본적으로 유효하지만 로직상 start < end 체크)

**ALLOWED_NETWORKS 검증:**
- networks 배열 길이 0이면 `errors.networks = 'At least one network required'`
- 각 network의 network 필드가 빈 값이면 `errors['networks.{i}.network'] = 'Network required'`

**X402_ALLOWED_DOMAINS 검증:**
- domains 배열 길이 0이면 `errors.domains = 'At least one domain required'`
- 각 domain이 빈 값이면 `errors['domains.{i}'] = 'Domain required'`

기존 5개 타입 검증 로직은 그대로 유지. else if 체인으로 7개 추가.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter admin build` 성공. `grep -c "else if" packages/admin/src/pages/policies.tsx` 에서 validateRules 내 분기 수 확인 (11개 이상 -- APPROVE_TIER_OVERRIDE는 검증 없으므로 SPENDING_LIMIT if + 나머지 11개 else if).
  </verify>
  <done>validateRules 함수가 12개 타입 전체(APPROVE_TIER_OVERRIDE 제외)의 클라이언트 유효성 검증을 수행하고, 빌드가 성공한다.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter admin build` -- Admin 빌드 성공
2. `grep -c "case '" packages/admin/src/components/policy-forms/index.tsx` -- 12개 case 확인
3. 7개 신규 폼 파일 존재 확인: `ls packages/admin/src/components/policy-forms/` -- 12개 폼 + index.tsx = 13 파일
4. validateRules에서 ALLOWED_TOKENS, CONTRACT_WHITELIST, METHOD_WHITELIST, APPROVED_SPENDERS, TIME_RESTRICTION, ALLOWED_NETWORKS, X402_ALLOWED_DOMAINS 검증 분기가 존재하는지 grep 확인
</verification>

<success_criteria>
- 12개 PolicyType 모두 PolicyFormRouter에서 전용 폼으로 렌더링 (JSON 폴백 사용 타입 0개)
- 7개 신규 폼 컴포넌트가 Zod 스키마 구조와 일치하는 필드를 제공
- DynamicRowList 기반 폼에서 행 추가/삭제가 동작
- METHOD_WHITELIST 2단계 중첩(contract -> selectors)이 독립적으로 행 추가/삭제 가능
- TIME_RESTRICTION 요일 체크박스 7개 + 시간 범위 셀렉트가 동작
- validateRules가 7개 새 타입의 필수 필드/배열 길이를 검증
- Admin 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/135-7type-forms-vis-edit/135-01-SUMMARY.md`
</output>
