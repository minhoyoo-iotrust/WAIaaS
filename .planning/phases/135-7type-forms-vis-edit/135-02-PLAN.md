---
phase: 135-7type-forms-vis-edit
plan: 02
type: execute
wave: 2
depends_on: ["135-01"]
files_modified:
  - packages/admin/src/components/policy-rules-summary.tsx
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/styles/global.css
  - packages/admin/src/__tests__/policy-forms.test.tsx
autonomous: true

must_haves:
  truths:
    - "ALLOWED_TOKENS 목록에서 토큰 심볼이 배지 목록으로 표시된다 (예: LINK, USDC)"
    - "RATE_LIMIT 목록에서 '100 req / 1h' 형식으로 표시된다"
    - "나머지 10개 타입도 각각 의미 있는 시각화로 표시된다 (JSON 원문 아님)"
    - "기존 정책 수정 클릭 시 전용 폼에 현재 rules 값이 프리필된다"
    - "수정 후 저장 시 PUT /v1/policies/{id} API 호출이 올바르게 발생한다"
    - "7-type 폼 렌더링/유효성/생성/수정 통합 테스트가 통과한다"
  artifacts:
    - path: "packages/admin/src/components/policy-rules-summary.tsx"
      provides: "12-type 목록 시각화 컴포넌트"
      min_lines: 80
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "수정 모달 전용 폼 프리필/저장 통합"
    - path: "packages/admin/src/__tests__/policy-forms.test.tsx"
      provides: "7-type 추가 + 시각화 + 수정 통합 테스트"
      min_lines: 400
  key_links:
    - from: "packages/admin/src/components/policy-rules-summary.tsx"
      to: "packages/admin/src/pages/policies.tsx"
      via: "policyColumns rules render에서 PolicyRulesSummary 호출"
      pattern: "PolicyRulesSummary"
    - from: "packages/admin/src/pages/policies.tsx"
      to: "PolicyFormRouter"
      via: "수정 모달에서 PolicyFormRouter + 프리필 rules 전달"
      pattern: "editRulesObj|PolicyFormRouter"
    - from: "packages/admin/src/pages/policies.tsx"
      to: "/v1/policies/{id}"
      via: "handleEdit에서 PUT API 호출"
      pattern: "apiPut.*POLICY"
---

<objective>
PolicyRulesSummary 12-type 목록 시각화 컴포넌트를 생성하고, 수정 모달에 전용 폼 프리필/저장을 통합하며, 7-type 폼 + 시각화 + 수정 흐름의 통합 테스트를 작성한다.

Purpose: 정책 목록에서 각 타입별 의미 있는 요약 정보를 표시하고(JSON 원문 대신), 기존 정책을 수정할 때 전용 폼에 현재값이 프리필되어 직관적인 수정 경험을 제공한다.
Output: PolicyRulesSummary 컴포넌트, 수정 모달 전용 폼 통합, 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/135-7type-forms-vis-edit/135-01-SUMMARY.md

@packages/admin/src/pages/policies.tsx
@packages/admin/src/components/policy-forms/index.tsx
@packages/admin/src/components/form.tsx
@packages/admin/src/styles/global.css
@packages/admin/src/__tests__/policy-forms.test.tsx
@objectives/v1.5.2-admin-policy-form-ux.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: PolicyRulesSummary 12-type 시각화 + 수정 모달 전용 폼 프리필/저장 통합</name>
  <files>
    packages/admin/src/components/policy-rules-summary.tsx
    packages/admin/src/pages/policies.tsx
    packages/admin/src/styles/global.css
  </files>
  <action>
**PolicyRulesSummary 컴포넌트 생성** (`packages/admin/src/components/policy-rules-summary.tsx`):

12개 타입별 시각화를 반환하는 컴포넌트. props: `{type: string, rules: Record<string, unknown>}`. Badge 컴포넌트를 import하여 배지 표시에 사용.

타입별 렌더링:

1. **SPENDING_LIMIT**: 기존 TierVisualization을 policies.tsx에서 이 파일로 이동. `formatNumber` 헬퍼도 함께 이동 (policies.tsx에서는 PolicyRulesSummary import로 대체).

2. **ALLOWED_TOKENS** (VIS-01): `rules.tokens` 배열에서 symbol 추출, Badge variant="info"로 각 심볼 표시. 예: `<Badge variant="info">LINK</Badge> <Badge variant="info">USDC</Badge>`. symbol이 없으면 address 앞 8자 축약으로 표시.

3. **RATE_LIMIT** (VIS-02): `rules.max_requests` / `rules.window_seconds` 파싱. window_seconds를 사람 읽기 좋은 형식으로 변환: 3600=1h, 60=1m, 86400=1d, 그 외 Xs. 출력: `<span class="rules-vis-text">{max_requests} req / {humanWindow}</span>`

4. **WHITELIST** (VIS-03): `rules.allowed_addresses` 배열 길이를 Badge로 표시: `<Badge variant="neutral">{n} addresses</Badge>`

5. **TIME_RESTRICTION** (VIS-03): `rules.allowed_days` 배열을 요일 약어로 변환 (0=Sun, 1=Mon, ..., 6=Sat). 연속 범위면 축약 (예: [1,2,3,4,5] -> "Mon-Fri"). `rules.allowed_hours.start`-`rules.allowed_hours.end` 2자리 형식. 출력: `<span class="rules-vis-text">Mon-Fri 09:00-18:00</span>`

6. **CONTRACT_WHITELIST** (VIS-03): contracts 배열에서 name이 있으면 name, 없으면 address 앞 8자. Badge variant="neutral"로 각 항목 표시. 3개 초과시 처음 3개 + "+N more".

7. **METHOD_WHITELIST** (VIS-03): methods 배열에서 컨트랙트 수와 총 메서드 수 계산. 출력: `<Badge variant="neutral">{contractCount} contracts, {selectorCount} methods</Badge>`

8. **APPROVED_SPENDERS** (VIS-03): spenders 배열 길이를 Badge로 표시: `<Badge variant="neutral">{n} spenders</Badge>`

9. **APPROVE_AMOUNT_LIMIT** (VIS-03): maxAmount가 있으면 `<span class="rules-vis-text">Max: {formatNumber(maxAmount)}</span>`, blockUnlimited이면 ` + Block unlimited` 추가. maxAmount 없고 blockUnlimited이면 "Block unlimited only".

10. **APPROVE_TIER_OVERRIDE** (VIS-03): tier를 색상 배지로 표시. INSTANT=success, NOTIFY=info, DELAY=warning, APPROVAL=danger. `<Badge variant={tierColor}>{tier}</Badge>`

11. **ALLOWED_NETWORKS** (VIS-03): networks 배열에서 각 network를 Badge variant="info"로 표시. 3개 초과시 처음 3개 + "+N more".

12. **X402_ALLOWED_DOMAINS** (VIS-03): domains 배열을 Badge variant="neutral"로 표시. 3개 초과시 처음 3개 + "+N more".

default: 기존 JSON 축약 표시 유지 (폴백).

CSS 클래스: `.rules-vis-text` (font-size: xs, color: text-secondary), `.rules-vis-badges` (display: flex, flex-wrap: wrap, gap: 4px) -- global.css에 추가.

**policies.tsx 수정 -- 목록 시각화 교체:**

- policyColumns의 `rules` 렌더에서 TierVisualization + JSON 축약 로직을 `<PolicyRulesSummary type={p.type} rules={p.rules} />`로 교체
- TierVisualization과 formatNumber 함수를 policies.tsx에서 제거 (policy-rules-summary.tsx로 이동했으므로)
- PolicyRulesSummary를 import

**policies.tsx 수정 -- 수정 모달 전용 폼 프리필/저장 통합** (EDIT-01, EDIT-02):

현재 수정 모달은 JSON textarea만 사용. 이를 전용 폼으로 교체:

1. 새 시그널 추가:
   - `editRulesObj = useSignal<Record<string, unknown>>({})` -- 수정 폼의 구조화된 rules
   - `editJsonMode = useSignal(false)` -- 수정 모달 JSON 토글
   - `editFormErrors = useSignal<Record<string, string>>({})` -- 수정 폼 에러

2. `openEdit` 함수 수정:
   - `editRulesObj.value = { ...policy.rules }` -- 현재 rules를 프리필 (EDIT-01)
   - `editJsonMode.value = false` -- 기본 폼 모드
   - `editFormErrors.value = {}`

3. `handleEdit` 함수 수정:
   - editJsonMode이면 기존 JSON.parse 사용
   - 아니면 editRulesObj에서 validateRules 실행, 에러 있으면 editFormErrors에 설정하고 리턴
   - 에러 없으면 editRulesObj.value를 parsedRules로 사용
   - PUT API 호출은 기존과 동일 (EDIT-02)

4. 수정 모달 UI 수정:
   - "Type: {label}" readonly 표시 아래에 JSON 토글 버튼 추가
   - editJsonMode이면 기존 JSON textarea
   - 아니면 `<PolicyFormRouter type={editPolicy.value.type} rules={editRulesObj.value} onChange={(r) => { editRulesObj.value = r; if (Object.keys(editFormErrors.value).length > 0) editFormErrors.value = validateRules(editPolicy.value.type, r); }} errors={editFormErrors.value} />`
   - JSON 토글 핸들러: form->json 시 editRules.value = JSON.stringify(editRulesObj.value, null, 2), json->form 시 editRulesObj.value = JSON.parse(editRules.value)
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter admin build` 성공. `grep -c "PolicyRulesSummary" packages/admin/src/pages/policies.tsx` >= 1. `grep "editRulesObj" packages/admin/src/pages/policies.tsx | head -3` 으로 수정 프리필 시그널 존재 확인.
  </verify>
  <done>PolicyRulesSummary가 12개 타입 모두에 대해 의미 있는 시각화를 렌더링하고, 수정 모달에서 전용 폼 프리필 + JSON 토글 + validateRules 검증 + PUT API 저장이 동작하며, Admin 빌드가 성공한다.</done>
</task>

<task type="auto">
  <name>Task 2: 7-type 폼 렌더링 + 시각화 + 수정 프리필 통합 테스트</name>
  <files>
    packages/admin/src/__tests__/policy-forms.test.tsx
  </files>
  <action>
기존 10개 테스트(Phase 134)를 유지하면서, 7-type 폼 + 시각화 + 수정 프리필 테스트를 추가한다.

**기존 테스트 유지 (10개):**
- renders SPENDING_LIMIT form fields by default
- switches to WHITELIST form when type is changed
- switches to RATE_LIMIT form and shows correct fields
- toggles between JSON mode and structured form
- DynamicRowList: adds and removes address rows in WHITELIST
- creates SPENDING_LIMIT policy with correct rules via API
- validates SPENDING_LIMIT: shows error for empty instant_max
- validates WHITELIST: shows error for empty address list
- validates RATE_LIMIT: shows error for invalid max_requests
- creates APPROVE_TIER_OVERRIDE with correct tier value

**신규 테스트 추가 (~10-12개):**

`describe('7-type form rendering')` 블록:

1. **ALLOWED_TOKENS 폼 렌더링 + 행 추가**: 타입 변경 -> + Add Token 버튼 표시 -> 클릭 -> address/symbol 필드 표시 assert

2. **CONTRACT_WHITELIST 폼 렌더링**: 타입 변경 -> + Add Contract 버튼 표시 assert

3. **METHOD_WHITELIST 2단계 중첩 렌더링**: 타입 변경 -> + Add Method Entry 버튼 표시 -> 클릭 -> Contract Address 필드 + Add Selector 버튼 표시 assert

4. **TIME_RESTRICTION 요일 체크박스 렌더링**: 타입 변경 -> 7개 요일 체크박스(Sun, Mon, ..., Sat) + Start/End 시간 셀렉트 표시 assert

5. **ALLOWED_NETWORKS 폼 렌더링**: 타입 변경 -> + Add Network 버튼 표시 assert

6. **X402_ALLOWED_DOMAINS 폼 렌더링**: 타입 변경 -> + Add Domain 버튼 표시 assert

`describe('7-type validation')` 블록:

7. **ALLOWED_TOKENS 빈 목록 검증**: tokens 0개 상태에서 Create -> "At least one token required" 에러 assert

8. **TIME_RESTRICTION 요일 미선택 검증**: 모든 요일 체크 해제 -> Create -> "At least one day required" 에러 assert

`describe('PolicyRulesSummary visualization')` 블록:

9. **ALLOWED_TOKENS 심볼 배지 표시**: policies 목록에 ALLOWED_TOKENS 정책(tokens: [{address:'0x...', symbol:'LINK'}, {symbol:'USDC'}]) -> 'LINK', 'USDC' 텍스트 렌더링 assert

10. **RATE_LIMIT "100 req / 1h" 표시**: policies 목록에 RATE_LIMIT 정책({max_requests:100, window_seconds:3600}) -> "100 req / 1h" 텍스트 assert

`describe('Edit modal - form prefill')` 블록:

11. **수정 프리필 테스트**: SPENDING_LIMIT 정책 Edit 클릭 -> 폼에 기존 instant_max 값이 표시 assert (EDIT-01)

12. **수정 저장 API 호출 테스트**: 수정 모달에서 값 변경 후 Save -> apiPut 호출 검증 (EDIT-02). apiPut이 올바른 URL과 body로 호출되는지 assert.

**테스트 구현 패턴:**
- 기존 `renderAndOpenForm()` 헬퍼 재사용
- mockPolicies에 ALLOWED_TOKENS, RATE_LIMIT 정책 추가 (시각화 테스트용)
- Edit 테스트: apiPut mock 추가 필요
- 각 테스트에서 apiGet mock을 적절히 설정 (wallets + policies)

**총 테스트 수: ~20-22개 (기존 10 + 신규 ~10-12)**
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter admin test -- --run src/__tests__/policy-forms.test.tsx` 전체 통과. 테스트 수 20개 이상 확인.
  </verify>
  <done>기존 10개 + 신규 10-12개 = 총 20개 이상 통합 테스트가 통과하고, 7-type 폼 렌더링/유효성 검증/시각화/수정 프리필/저장 흐름이 테스트로 검증된다.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter admin build` -- Admin 빌드 성공
2. `pnpm --filter admin test -- --run src/__tests__/policy-forms.test.tsx` -- 20개+ 테스트 전체 통과
3. PolicyRulesSummary가 policies.tsx에서 사용되고, 12개 타입 모두 시각화 분기 존재
4. 수정 모달에서 PolicyFormRouter가 사용되고, editRulesObj 프리필 + PUT API 호출 확인
5. SPENDING_LIMIT TierVisualization이 PolicyRulesSummary 내부로 이동 확인
</verification>

<success_criteria>
- PolicyRulesSummary가 12개 타입 모두에 대해 의미 있는 시각화를 제공 (SPENDING_LIMIT=tier bars, ALLOWED_TOKENS=심볼 배지, RATE_LIMIT=req/time 형식 등)
- 수정 모달에서 기존 rules가 전용 폼에 프리필되고, JSON 토글도 가능
- 수정 저장 시 올바른 PUT API 호출이 발생
- 20개 이상 통합 테스트 전체 통과
- 기존 10개 테스트가 깨지지 않음
- Admin 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/135-7type-forms-vis-edit/135-02-SUMMARY.md`
</output>
