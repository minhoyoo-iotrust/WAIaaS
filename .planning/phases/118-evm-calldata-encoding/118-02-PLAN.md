---
phase: 118-evm-calldata-encoding
plan: 02
type: execute
wave: 2
depends_on: ["118-01"]
files_modified:
  - packages/sdk/src/types.ts
  - packages/sdk/src/client.ts
  - packages/mcp/src/tools/encode-calldata.ts
  - packages/mcp/src/server.ts
  - python-sdk/waiaas/models.py
  - python-sdk/waiaas/client.py
  - skills/transactions.skill.md
autonomous: true

must_haves:
  truths:
    - "TS SDK client.encodeCalldata({ abi, functionName, args }) calls POST /v1/utils/encode-calldata and returns typed EncodeCalldataResponse"
    - "Python SDK client.encode_calldata(abi, function_name, args) calls POST /v1/utils/encode-calldata and returns EncodeCalldataResponse model"
    - "MCP encode_calldata tool sends abi + functionName + args to the REST API and returns formatted result"
    - "transactions.skill.md documents the encode-calldata endpoint with request/response examples"
  artifacts:
    - path: "packages/sdk/src/client.ts"
      provides: "encodeCalldata() method"
      contains: "encodeCalldata"
    - path: "packages/mcp/src/tools/encode-calldata.ts"
      provides: "registerEncodeCalldata function"
      exports: ["registerEncodeCalldata"]
    - path: "packages/mcp/src/server.ts"
      provides: "encode_calldata tool registration"
      contains: "registerEncodeCalldata"
    - path: "python-sdk/waiaas/client.py"
      provides: "encode_calldata() method"
      contains: "encode_calldata"
    - path: "python-sdk/waiaas/models.py"
      provides: "EncodeCalldataRequest, EncodeCalldataResponse models"
      contains: "EncodeCalldataResponse"
    - path: "skills/transactions.skill.md"
      provides: "encode-calldata documentation section"
      contains: "encode-calldata"
  key_links:
    - from: "packages/sdk/src/client.ts"
      to: "/v1/utils/encode-calldata"
      via: "this.http.post"
      pattern: "/v1/utils/encode-calldata"
    - from: "packages/mcp/src/tools/encode-calldata.ts"
      to: "/v1/utils/encode-calldata"
      via: "apiClient.post"
      pattern: "/v1/utils/encode-calldata"
    - from: "python-sdk/waiaas/client.py"
      to: "/v1/utils/encode-calldata"
      via: "self._request"
      pattern: "/v1/utils/encode-calldata"
    - from: "packages/mcp/src/server.ts"
      to: "packages/mcp/src/tools/encode-calldata.ts"
      via: "import { registerEncodeCalldata }"
      pattern: "registerEncodeCalldata"
---

<objective>
Add encodeCalldata/encode_calldata to TS SDK, Python SDK, and MCP tools, all calling the REST endpoint from Plan 118-01. Update transactions.skill.md with encode-calldata documentation.

Purpose: AI agents interact through SDK or MCP, not raw HTTP. This plan ensures all three client interfaces expose the encoding utility. The skill file update ensures MCP-connected agents have documentation context.
Output: TS SDK method, Python SDK method, MCP tool, updated skill file.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/118-evm-calldata-encoding/118-RESEARCH.md
@.planning/phases/118-evm-calldata-encoding/118-01-SUMMARY.md

@packages/sdk/src/client.ts
@packages/sdk/src/types.ts
@packages/mcp/src/server.ts
@packages/mcp/src/tools/call-contract.ts
@python-sdk/waiaas/client.py
@python-sdk/waiaas/models.py
@skills/transactions.skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TS SDK encodeCalldata + MCP encode_calldata tool</name>
  <files>
    packages/sdk/src/types.ts
    packages/sdk/src/client.ts
    packages/mcp/src/tools/encode-calldata.ts
    packages/mcp/src/server.ts
  </files>
  <action>
1. **Add types to packages/sdk/src/types.ts** at the end (before any closing export, in a new "Utils" section):
```typescript
// ---------------------------------------------------------------------------
// Utils Responses
// ---------------------------------------------------------------------------

export interface EncodeCalldataParams {
  /** ABI fragment array (JSON objects) */
  abi: Record<string, unknown>[];
  /** Function name to encode */
  functionName: string;
  /** Function arguments (optional, defaults to []) */
  args?: unknown[];
}

export interface EncodeCalldataResponse {
  /** Hex-encoded calldata (0x-prefixed) */
  calldata: string;
  /** Function selector (first 4 bytes, 0x-prefixed) */
  selector: string;
  /** Encoded function name */
  functionName: string;
}
```

2. **Add encodeCalldata method to packages/sdk/src/client.ts:**

Add `EncodeCalldataParams` and `EncodeCalldataResponse` to the import from `./types.js`.

Add the method after `renewSession()` (before `extractSessionId()`), in a new section:
```typescript
// --- Utils ---
async encodeCalldata(params: EncodeCalldataParams): Promise<EncodeCalldataResponse> {
  return withRetry(
    () => this.http.post<EncodeCalldataResponse>(
      '/v1/utils/encode-calldata',
      params,
      this.authHeaders(),
    ),
    this.retryOptions,
  );
}
```

3. **Create packages/mcp/src/tools/encode-calldata.ts** following call-contract.ts pattern:
```typescript
/**
 * encode_calldata tool: Encode EVM function call into calldata hex.
 *
 * Wraps POST /v1/utils/encode-calldata. AI agents provide ABI fragment,
 * function name, and arguments to get hex-encoded calldata for use
 * with call_contract's calldata parameter.
 */

import { z } from 'zod';
import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { type ApiClient, toToolResult } from '../api-client.js';
import { type WalletContext, withWalletPrefix } from '../server.js';

export function registerEncodeCalldata(
  server: McpServer,
  apiClient: ApiClient,
  walletContext?: WalletContext,
): void {
  server.tool(
    'encode_calldata',
    withWalletPrefix(
      'Encode EVM function call into calldata hex. Provide ABI fragment array, function name, and arguments. Returns hex calldata and function selector for use with call_contract.',
      walletContext?.walletName,
    ),
    {
      abi: z.array(z.record(z.unknown())).describe('ABI fragment array for the function (JSON array of objects)'),
      functionName: z.string().describe('Function name to encode (e.g., "transfer", "approve")'),
      args: z.array(z.any()).optional().describe('Function arguments array (e.g., ["0xAddress", "1000000"]). Omit for zero-arg functions.'),
    },
    async (args) => {
      const result = await apiClient.post('/v1/utils/encode-calldata', {
        abi: args.abi,
        functionName: args.functionName,
        args: args.args ?? [],
      });
      return toToolResult(result);
    },
  );
}
```

4. **Register tool in packages/mcp/src/server.ts:**

Add import at the top alongside other tool imports:
```typescript
import { registerEncodeCalldata } from './tools/encode-calldata.js';
```

Add registration call after `registerGetWalletInfo(server, apiClient, walletContext);` (last tool registration):
```typescript
registerEncodeCalldata(server, apiClient, walletContext);
```

Update the comment above the tool registrations from "Register 11 tools" to "Register 12 tools".
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/sdk --filter=@waiaas/mcp` to verify both packages compile. Run `npx turbo test --filter=@waiaas/sdk --filter=@waiaas/mcp` to check no regressions.
  </verify>
  <done>
TS SDK has `encodeCalldata()` method with `EncodeCalldataParams`/`EncodeCalldataResponse` types. MCP has `encode_calldata` tool registered in server.ts (12 tools total). Both packages build without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Python SDK encode_calldata + skill file update</name>
  <files>
    python-sdk/waiaas/models.py
    python-sdk/waiaas/client.py
    skills/transactions.skill.md
  </files>
  <action>
1. **Add Pydantic models to python-sdk/waiaas/models.py** at the end of the file, in a new "Utils" section:
```python
# ---------------------------------------------------------------------------
# Utils models
# ---------------------------------------------------------------------------


class EncodeCalldataRequest(BaseModel):
    abi: list[dict[str, Any]] = Field(description="ABI fragment array")
    function_name: str = Field(alias="functionName", description="Function name to encode")
    args: list[Any] = Field(default_factory=list, description="Function arguments")

    model_config = {"populate_by_name": True}


class EncodeCalldataResponse(BaseModel):
    calldata: str = Field(description="Hex-encoded calldata (0x-prefixed)")
    selector: str = Field(description="Function selector (first 4 bytes)")
    function_name: str = Field(alias="functionName", description="Encoded function name")

    model_config = {"populate_by_name": True}
```

2. **Add encode_calldata method to python-sdk/waiaas/client.py:**

Add `EncodeCalldataRequest` and `EncodeCalldataResponse` to the import from `waiaas.models`.

Add the method after the last existing method (before `close` or at the end of the public API section), in a "Utils API" section:
```python
# -----------------------------------------------------------------
# Utils API
# -----------------------------------------------------------------

async def encode_calldata(
    self,
    abi: list[dict[str, Any]],
    function_name: str,
    args: Optional[list[Any]] = None,
) -> EncodeCalldataResponse:
    """POST /v1/utils/encode-calldata -- Encode EVM function call into calldata hex.

    Args:
        abi: ABI fragment array (JSON objects).
        function_name: Function name to encode (e.g., "transfer").
        args: Function arguments (defaults to empty list for zero-arg functions).

    Returns:
        EncodeCalldataResponse with calldata hex, selector, and functionName.
    """
    request = EncodeCalldataRequest(
        abi=abi, function_name=function_name, args=args or []
    )
    body = request.model_dump(exclude_none=True, by_alias=True)
    resp = await self._request("POST", "/v1/utils/encode-calldata", json_body=body)
    return EncodeCalldataResponse.model_validate(resp.json())
```

3. **Update skills/transactions.skill.md** to add encode-calldata section. Add a new top-level section at the end of the file (or before any closing section), titled "## 7. Encode Calldata (EVM Utility)":

```markdown
## 7. Encode Calldata (EVM Utility)

Encode an EVM function call into hex calldata. This utility helps construct the `calldata` parameter for `CONTRACT_CALL` transactions without needing an ABI encoding library.

### POST /v1/utils/encode-calldata

**Auth:** sessionAuth (Bearer token)

**Request:**
```json
{
  "abi": [
    {
      "type": "function",
      "name": "transfer",
      "inputs": [
        { "name": "to", "type": "address" },
        { "name": "amount", "type": "uint256" }
      ],
      "outputs": [{ "name": "", "type": "bool" }],
      "stateMutability": "nonpayable"
    }
  ],
  "functionName": "transfer",
  "args": ["0xRecipientAddress", "1000000"]
}
```

**Response (200):**
```json
{
  "calldata": "0xa9059cbb000000000000000000000000recipientaddress0000000000000000000000000000000000000000000000000000000000000f4240",
  "selector": "0xa9059cbb",
  "functionName": "transfer"
}
```

**Errors:**
- `400 ABI_ENCODING_FAILED` -- Function not found in ABI, or argument type mismatch.

**Usage with CONTRACT_CALL:**
1. Encode calldata: `POST /v1/utils/encode-calldata`
2. Send contract call: `POST /v1/transactions/send` with `type: "CONTRACT_CALL"`, `to: contractAddress`, `calldata: encodedHex`

**SDK:**
- TypeScript: `client.encodeCalldata({ abi, functionName, args })`
- Python: `await client.encode_calldata(abi, function_name, args)`

**MCP Tool:** `encode_calldata` with parameters `abi`, `functionName`, `args`
```

**Note:** Check the existing section numbering in transactions.skill.md and use the next available number. If the last section is "## 6. ...", use "## 7.". If different, adjust accordingly.

**CLAUDE.md compliance:** Per Interface Sync rule, skill file MUST be updated when REST API/SDK/MCP interfaces change. This task satisfies that requirement.
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS/python-sdk && python -c "from waiaas.models import EncodeCalldataRequest, EncodeCalldataResponse; print('OK')"` to verify Python models import correctly. Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/sdk` to verify SDK still builds. Grep transactions.skill.md for "encode-calldata" to confirm documentation added.
  </verify>
  <done>
Python SDK has `encode_calldata()` method with `EncodeCalldataRequest`/`EncodeCalldataResponse` Pydantic models. transactions.skill.md documents the encode-calldata endpoint with request/response examples, SDK references, and MCP tool name.
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build --filter=@waiaas/sdk --filter=@waiaas/mcp` succeeds
2. `npx turbo test --filter=@waiaas/sdk --filter=@waiaas/mcp` passes
3. `python -c "from waiaas.models import EncodeCalldataRequest, EncodeCalldataResponse"` succeeds
4. `grep "encode_calldata" packages/mcp/src/server.ts` shows registration
5. `grep "encodeCalldata" packages/sdk/src/client.ts` shows method
6. `grep "encode_calldata" python-sdk/waiaas/client.py` shows method
7. `grep "encode-calldata" skills/transactions.skill.md` shows documentation
</verification>

<success_criteria>
- TS SDK `encodeCalldata()` calls POST /v1/utils/encode-calldata with typed params/response
- MCP `encode_calldata` tool registered (12 tools total), sends request via ApiClient
- Python SDK `encode_calldata()` calls POST /v1/utils/encode-calldata with Pydantic models
- transactions.skill.md has encode-calldata section with request/response examples
- All three clients pass the same { abi, functionName, args } payload to the REST endpoint
- No regressions in SDK/MCP test suites
</success_criteria>

<output>
After completion, create `.planning/phases/118-evm-calldata-encoding/118-02-SUMMARY.md`
</output>
