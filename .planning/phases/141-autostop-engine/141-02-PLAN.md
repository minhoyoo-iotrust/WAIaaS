---
phase: 141-autostop-engine
plan: 02
type: execute
wave: 2
depends_on: ["141-01"]
files_modified:
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/daemon/src/__tests__/autostop-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "config.toml에 autostop flat key(autostop_consecutive_failures_threshold, autostop_unusual_activity_threshold 등)가 정의되고 Zod 기본값이 적용된다"
    - "Admin Settings에서 autostop 카테고리 설정을 런타임 조회/수정할 수 있다"
    - "AutoStopService가 DaemonLifecycle에서 초기화되고 EventBus와 연결된다"
    - "AutoStop 규칙 트리거 시 AUTOSTOP_TRIGGERED 알림이 i18n(en/ko) 템플릿으로 발송된다"
    - "SettingsService hot-reload 변경 시 AutoStopService.updateConfig()가 호출되어 데몬 재시작 없이 임계값이 조정된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "DaemonConfigSchema에 autostop 섹션 추가"
      contains: "autostop_consecutive_failures_threshold|autostop_unusual_activity_threshold|autostop_idle_timeout_sec"
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "SETTING_DEFINITIONS에 autostop 카테고리 6개 키 추가, SETTING_CATEGORIES에 'autostop' 추가"
      contains: "autostop"
    - path: "packages/daemon/src/lifecycle/daemon.ts"
      provides: "AutoStopService 인스턴스 생성 + start() 호출 + shutdown stop()"
      contains: "AutoStopService"
    - path: "packages/daemon/src/__tests__/autostop-integration.test.ts"
      provides: "설정 관리 + DaemonLifecycle 통합 + 알림 통합 테스트"
  key_links:
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/services/autostop-service.ts"
      via: "AutoStopService 인스턴스 생성 + start()/stop() 호출"
      pattern: "autoStopService\\.start\\(\\)|new AutoStopService"
    - from: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      to: "packages/daemon/src/infrastructure/config/loader.ts"
      via: "configPath가 DaemonConfigSchema 경로와 일치"
      pattern: "configPath.*security\\.autostop"
    - from: "packages/daemon/src/services/autostop-service.ts"
      to: "packages/daemon/src/notifications/notification-service.ts"
      via: "notificationService.notify('AUTO_STOP_TRIGGERED', ...) 호출"
      pattern: "notify\\('AUTO_STOP_TRIGGERED'"
---

<objective>
AutoStop 설정 관리(config.toml + Admin Settings) + DaemonLifecycle 통합 + 알림 통합

Purpose: AutoStop 규칙 임계값을 config.toml flat key와 Admin Settings 런타임 오버라이드로 관리하여 데몬 재시작 없이 조정할 수 있게 한다. AutoStopService를 DaemonLifecycle에 통합하고, 규칙 트리거 시 AUTOSTOP_TRIGGERED 알림을 i18n 템플릿으로 발송한다. AUTO-05, AUTO-06 요구사항 + 전체 통합을 충족한다.

Output: config.toml autostop 키 + Admin Settings autostop 카테고리 + DaemonLifecycle 통합 + i18n 알림 템플릿 + 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md (AUTO-05, AUTO-06)

# 141-01 결과물 (AutoStopService 클래스)
@.planning/phases/141-autostop-engine/141-01-SUMMARY.md
@packages/daemon/src/services/autostop-service.ts
@packages/daemon/src/services/autostop-rules.ts

# 기존 패턴 참조
@packages/daemon/src/infrastructure/config/loader.ts (DaemonConfigSchema)
@packages/daemon/src/infrastructure/settings/setting-keys.ts (SETTING_DEFINITIONS)
@packages/daemon/src/lifecycle/daemon.ts (DaemonLifecycle)
@packages/core/src/i18n/en.ts (notification templates)
@packages/core/src/i18n/ko.ts (notification templates)
@packages/daemon/src/notifications/notification-service.ts (NotificationService)
@packages/daemon/src/infrastructure/settings/hot-reload.ts (SettingsService hot-reload)
</context>

<tasks>

<task type="auto">
  <name>Task 1: config.toml autostop 키 + Admin Settings autostop 카테고리 + i18n 알림 템플릿 업데이트</name>
  <files>
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
  </files>
  <action>
**1. DaemonConfigSchema에 autostop 키 추가 (loader.ts)**

기존 `security` 섹션에 flat key 추가 (CLAUDE.md 중첩 금지 규칙 준수 -- 새 섹션 추가보다 기존 security 섹션 활용이 적절):

```typescript
// 기존 security 섹션 내, 이미 있는 auto_stop_consecutive_failures_threshold 옆에 추가
autostop_consecutive_failures_threshold: z.number().int().min(1).max(50).default(5),
autostop_unusual_activity_threshold: z.number().int().min(5).max(200).default(20),
autostop_unusual_activity_window_sec: z.number().int().min(60).max(3600).default(300),
autostop_idle_timeout_sec: z.number().int().min(300).max(86400).default(3600),
autostop_idle_check_interval_sec: z.number().int().min(10).max(600).default(60),
autostop_enabled: z.boolean().default(true),
```

**중요:** 기존 `auto_stop_consecutive_failures_threshold` (기본값 3)이 이미 있으므로 이것을 `autostop_consecutive_failures_threshold` (기본값 5, AUTO-01 요구사항)으로 교체한다. 기존 키는 제거하거나 주석으로 deprecated 표시한다. 기본값을 5로 변경하는 이유: AUTO-01 명시 "5회 연속 트랜잭션 실패".

KNOWN_SECTIONS는 변경 불필요 (security 섹션 내 flat key이므로).

**2. SETTING_DEFINITIONS에 autostop 카테고리 추가 (setting-keys.ts)**

SETTING_CATEGORIES 배열에 `'autostop'` 추가:
```typescript
export const SETTING_CATEGORIES = [
  'notifications', 'rpc', 'security', 'daemon', 'walletconnect', 'oracle', 'display', 'autostop',
] as const;
```

SETTING_DEFINITIONS에 6개 키 추가:
```typescript
// --- autostop category ---
{ key: 'autostop.consecutive_failures_threshold', category: 'autostop', configPath: 'security.autostop_consecutive_failures_threshold', defaultValue: '5', isCredential: false },
{ key: 'autostop.unusual_activity_threshold', category: 'autostop', configPath: 'security.autostop_unusual_activity_threshold', defaultValue: '20', isCredential: false },
{ key: 'autostop.unusual_activity_window_sec', category: 'autostop', configPath: 'security.autostop_unusual_activity_window_sec', defaultValue: '300', isCredential: false },
{ key: 'autostop.idle_timeout_sec', category: 'autostop', configPath: 'security.autostop_idle_timeout_sec', defaultValue: '3600', isCredential: false },
{ key: 'autostop.idle_check_interval_sec', category: 'autostop', configPath: 'security.autostop_idle_check_interval_sec', defaultValue: '60', isCredential: false },
{ key: 'autostop.enabled', category: 'autostop', configPath: 'security.autostop_enabled', defaultValue: 'true', isCredential: false },
```

참고: configPath는 `security.autostop_*` 형태 (DaemonConfigSchema의 security 섹션 내 flat key 경로).

**3. i18n 알림 템플릿 업데이트 (en.ts, ko.ts)**

기존 AUTO_STOP_TRIGGERED 템플릿이 이미 존재하지만, body가 "Daemon auto-stopped after {failures} consecutive failures"로 CONSECUTIVE_FAILURES만 커버한다. 더 범용적인 메시지로 변경:

en.ts:
```typescript
AUTO_STOP_TRIGGERED: {
  title: 'Auto-Stop Triggered',
  body: 'Wallet {walletId} auto-stopped: {reason}. Rule: {rule}'
},
```

ko.ts:
```typescript
AUTO_STOP_TRIGGERED: {
  title: '자동 정지 발동',
  body: '월렛 {walletId} 자동 정지: {reason}. 규칙: {rule}'
},
```

이렇게 하면 CONSECUTIVE_FAILURES, UNUSUAL_ACTIVITY, MANUAL_TRIGGER 모든 규칙에서 `reason`과 `rule` 변수를 넘겨 구체적인 메시지를 표시할 수 있다.
  </action>
  <verify>
1. `pnpm --filter @waiaas/core build` 성공
2. `pnpm --filter @waiaas/daemon build` 성공
3. `pnpm --filter @waiaas/daemon test -- --reporter=verbose config-loader` 기존 config-loader 테스트 통과
4. `pnpm --filter @waiaas/daemon test -- --reporter=verbose admin-settings` 기존 settings 테스트 통과
  </verify>
  <done>
DaemonConfigSchema에 autostop_* flat key 6개가 추가되고, SETTING_DEFINITIONS에 autostop 카테고리 6개 키가 추가되며, AUTO_STOP_TRIGGERED i18n 템플릿이 범용 규칙별 메시지를 지원하고, 기존 테스트가 통과한다
  </done>
</task>

<task type="auto">
  <name>Task 2: DaemonLifecycle 통합 + hot-reload + 통합 테스트</name>
  <files>
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/__tests__/autostop-integration.test.ts
  </files>
  <action>
**1. DaemonLifecycle에 AutoStopService 인스턴스 통합 (daemon.ts)**

기존 패턴 참조: KillSwitchService는 Step 4c-2에서 생성, NotificationService 초기화 후 재생성.

AutoStopService도 유사한 위치에 추가:
- KillSwitchService, NotificationService 모두 초기화된 후 AutoStopService 생성
- SettingsService에서 autostop 설정 읽어 AutoStopConfig 구성

```typescript
import { AutoStopService, type AutoStopConfig } from '../services/autostop-service.js';
```

DaemonLifecycle 클래스에 `private autoStopService?: AutoStopService;` 필드 추가.

**startup()** 메서드에서 (NotificationService + KillSwitchService 초기화 이후):
```typescript
// Step 4c-3: AutoStop Engine
const autoStopConfig: AutoStopConfig = {
  consecutiveFailuresThreshold: parseInt(settingsService.get('autostop.consecutive_failures_threshold'), 10),
  unusualActivityThreshold: parseInt(settingsService.get('autostop.unusual_activity_threshold'), 10),
  unusualActivityWindowSec: parseInt(settingsService.get('autostop.unusual_activity_window_sec'), 10),
  idleTimeoutSec: parseInt(settingsService.get('autostop.idle_timeout_sec'), 10),
  idleCheckIntervalSec: parseInt(settingsService.get('autostop.idle_check_interval_sec'), 10),
  enabled: settingsService.get('autostop.enabled') === 'true',
};

this.autoStopService = new AutoStopService({
  sqlite: this.sqlite!,
  eventBus: this.eventBus!,
  killSwitchService: this.killSwitchService!,
  notificationService: this.notificationService,
  config: autoStopConfig,
});

if (autoStopConfig.enabled) {
  this.autoStopService.start();
  console.log('[Daemon] AutoStop engine started');
}
```

**shutdown()** 메서드에서 (HTTP 서버 종료 후, EventBus removeAllListeners 전):
```typescript
// Stop AutoStop engine
this.autoStopService?.stop();
```

**hot-reload 통합:**

기존 hot-reload 패턴 확인 필요 (packages/daemon/src/infrastructure/settings/hot-reload.ts). 해당 파일에서 settings 변경 시 콜백 실행하는 패턴이 있을 것이다. AutoStop 관련 키 변경 시 autoStopService.updateConfig() 호출하는 콜백 등록.

hot-reload.ts에서 autostop 키 변경 감지 시:
```typescript
// autostop 카테고리 키 변경 시
if (changedKeys.some(k => k.startsWith('autostop.'))) {
  const newConfig: Partial<AutoStopConfig> = {
    consecutiveFailuresThreshold: parseInt(settingsService.get('autostop.consecutive_failures_threshold'), 10),
    // ... 나머지 키도 동일
  };
  autoStopService?.updateConfig(newConfig);
}
```

구체적인 hot-reload 통합 패턴은 hot-reload.ts 파일의 기존 구현을 읽고 따른다. 기존에 NotificationService의 replaceChannels()이나 updateConfig()를 호출하는 패턴이 있을 것이므로 동일하게 따른다.

**2. 통합 테스트 (autostop-integration.test.ts)**

vitest 테스트 파일 생성. 주요 테스트:

describe('AutoStop config management')
1. "DaemonConfigSchema에 autostop 키가 빈 config에서 기본값 적용" -- z.parse({})로 기본값 확인
2. "config.toml에 설정된 autostop 값이 SettingsService.get()으로 조회됨" -- SettingsService + config 주입 테스트
3. "SettingsService.set()으로 autostop 값 런타임 변경" -- set() 후 get() 확인

describe('AutoStop notification integration')
4. "CONSECUTIVE_FAILURES 트리거 시 AUTO_STOP_TRIGGERED 알림 발송" -- 5회 실패 -> notificationService.notify('AUTO_STOP_TRIGGERED', walletId, { reason, rule }) 호출 확인
5. "UNUSUAL_ACTIVITY 트리거 시 AUTO_STOP_TRIGGERED 알림 발송" -- 20회 빠른 활동 -> 알림 확인
6. "MANUAL_TRIGGER 시 AUTO_STOP_TRIGGERED 알림 발송 + Kill Switch 발동" -- manualTrigger() -> 알림 + KS SUSPENDED 확인

describe('AutoStop enabled/disabled')
7. "enabled=false 시 start() 호출해도 이벤트 구독 안 됨" -- config.enabled=false -> eventBus.listenerCount 0
8. "updateConfig({ enabled: false })로 런타임 비활성화" -- stop() 호출 확인

describe('i18n template')
9. "AUTO_STOP_TRIGGERED en 템플릿에 {walletId}, {reason}, {rule} 변수가 포함됨"
10. "AUTO_STOP_TRIGGERED ko 템플릿에 {walletId}, {reason}, {rule} 변수가 포함됨"

**테스트 셋업:**
- better-sqlite3 in-memory DB
- wallets, sessions, key_value_store, audit_log, settings 테이블 생성
- EventBus 실제 인스턴스
- KillSwitchService 실제 인스턴스
- NotificationService vi.fn() mock
- SettingsService 실제 인스턴스 (settings 테이블 필요)
  </action>
  <verify>
1. `pnpm --filter @waiaas/daemon build` 성공
2. `pnpm --filter @waiaas/daemon test -- --reporter=verbose autostop-integration` 모든 테스트 통과
3. `pnpm --filter @waiaas/daemon test -- --reporter=verbose config-loader` 기존 테스트 통과
4. `pnpm --filter @waiaas/daemon test` 전체 daemon 테스트 실행하여 기존 테스트 깨지지 않음 확인
  </verify>
  <done>
DaemonConfigSchema에 autostop_* 6개 flat key가 Zod 기본값과 함께 추가되고, SETTING_DEFINITIONS에 autostop 카테고리가 등록되어 Admin Settings에서 런타임 조회/수정이 가능하고, DaemonLifecycle에서 AutoStopService가 초기화/시작/종료되며, hot-reload로 데몬 재시작 없이 임계값 조정이 가능하고, AUTO_STOP_TRIGGERED 알림이 i18n 템플릿으로 발송되며, 10개 이상 통합 테스트가 통과한다
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon build` -- 전체 빌드 성공
2. `pnpm --filter @waiaas/daemon test -- --reporter=verbose autostop` -- 모든 autostop 관련 테스트 통과
3. `pnpm --filter @waiaas/daemon test` -- 전체 daemon 테스트에서 기존 테스트 깨지지 않음
4. DaemonConfigSchema에 autostop 키 존재: `z.number().int().min(1).max(50).default(5)` 패턴
5. SETTING_DEFINITIONS에 autostop 카테고리 존재: `category: 'autostop'` 패턴
6. daemon.ts에 AutoStopService 초기화 코드 존재: `new AutoStopService` 패턴
7. i18n en.ts/ko.ts에 AUTO_STOP_TRIGGERED 범용 템플릿 존재
</verification>

<success_criteria>
- config.toml `security.autostop_*` flat key 6개가 Zod 기본값과 함께 정의된다
- SETTING_DEFINITIONS에 autostop 카테고리 6개 키가 등록되어 Admin Settings 런타임 조회/수정이 가능하다
- DaemonLifecycle에서 AutoStopService가 초기화되고 시작/종료된다
- SettingsService hot-reload로 autostop 설정 변경 시 AutoStopService.updateConfig()가 호출된다
- AUTO_STOP_TRIGGERED 알림이 i18n(en/ko) 범용 템플릿으로 발송된다
- 10개 이상 통합 테스트가 통과한다
- 전체 daemon 테스트에서 기존 테스트가 깨지지 않는다
</success_criteria>

<output>
After completion, create `.planning/phases/141-autostop-engine/141-02-SUMMARY.md`
</output>
