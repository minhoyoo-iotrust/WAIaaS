---
phase: 07-session-transaction-protocol-design
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/31-solana-adapter-detail.md
autonomous: true

must_haves:
  truths:
    - "SolanaAdapter가 IChainAdapter 13개 메서드를 모두 구현하는 상세 설계가 완료됨"
    - "@solana/kit pipe 기반 트랜잭션 빌드 패턴이 코드 수준으로 설계됨"
    - "SOL 전송 + SPL 토큰 전송의 instruction 빌드가 각각 설계됨"
    - "시뮬레이션(simulateTransaction)이 실패 시나리오별 에러 처리와 함께 설계됨"
    - "서명(signTransaction)이 sodium guarded memory에서 키를 받아 처리하는 패턴으로 설계됨"
    - "제출(submitTransaction) + 확인 대기(waitForConfirmation)가 blockhash 만료 대응과 함께 설계됨"
    - "RPC 연결 관리(connect/disconnect/getHealth)와 에러 매핑이 설계됨"
  artifacts:
    - path: ".planning/deliverables/31-solana-adapter-detail.md"
      provides: "Solana Adapter 상세 설계 -- @solana/kit 기반 13개 메서드 구현 명세"
      contains: "SolanaAdapter"
  key_links:
    - from: "31-solana-adapter-detail.md"
      to: "27-chain-adapter-interface.md"
      via: "IChainAdapter 인터페이스의 Solana 구현체 상세"
      pattern: "IChainAdapter"
    - from: "31-solana-adapter-detail.md"
      to: "26-keystore-spec.md"
      via: "signTransaction에서 sodium guarded memory의 privateKey(Uint8Array) 수신"
      pattern: "signTransaction.*Uint8Array"
---

<objective>
Solana Adapter를 @solana/kit 기반으로 상세 설계한다 -- IChainAdapter 13개 메서드의 Solana-specific 구현을 코드 패턴 수준으로 정의하고, SOL 전송/SPL 토큰 전송 instruction 빌드, 트랜잭션 시뮬레이션, 서명(sodium guarded memory 연동), 제출/확인 대기, RPC 연결 관리, 에러 매핑을 설계한다.

Purpose: Solana는 WAIaaS의 1순위 체인이며, @solana/kit의 pipe 기반 함수형 API는 기존 @solana/web3.js 1.x와 패러다임이 완전히 다르다. 이 상세 설계가 07-03의 트랜잭션 파이프라인 Execute 단계의 구체적 구현 기반이 된다.
Output: 설계 문서 1개 -- 31-solana-adapter-detail.md (CHAIN-02 충족)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-session-transaction-protocol-design/07-RESEARCH.md

# Phase 6 참조 (직접 의존)
@.planning/deliverables/27-chain-adapter-interface.md (CORE-04: IChainAdapter 13 메서드, 공통 타입, AdapterRegistry)
@.planning/deliverables/26-keystore-spec.md (CORE-03: sodium guarded memory, privateKey Uint8Array, signTransaction 연동)
@.planning/deliverables/24-monorepo-data-directory.md (CORE-01: config.toml [adapters.solana] 섹션, packages/adapters/solana 경로)
</context>

<tasks>

<task type="auto">
  <name>Task 1: SolanaAdapter 클래스 구조 + RPC 연결 + 조회 메서드 설계</name>
  <files>.planning/deliverables/31-solana-adapter-detail.md</files>
  <action>
  설계 문서 `31-solana-adapter-detail.md`를 작성한다. 문서 ID는 `CHAIN-SOL`.

  **섹션 1: 문서 개요 + 요구사항 매핑**
  - 문서 ID, 작성일, 상태, 참조 문서 (CORE-04, CORE-03, CORE-01), 요구사항 매핑 (CHAIN-02)
  - @solana/kit (구 @solana/web3.js 2.x) 리브랜딩 이력 및 버전 참고사항
  - CORE-04 IChainAdapter 13개 메서드 목록 + SolanaAdapter에서의 매핑 테이블

  **섹션 2: SolanaAdapter 클래스 구조**
  - 파일 위치: `packages/adapters/solana/src/adapter.ts`
  - 클래스 선언: `class SolanaAdapter implements IChainAdapter`
  - 내부 상태:
    - `rpc: SolanaRpc` (createSolanaRpc로 생성)
    - `rpcSubscriptions: SolanaRpcSubscriptions` (createSolanaRpcSubscriptions)
    - `connected: boolean`
    - `chain: 'solana'` (readonly)
    - `network: NetworkType` (readonly, 'mainnet-beta' | 'devnet' | 'testnet')
  - 생성자: `constructor(config: SolanaAdapterConfig)` -- RPC URL, WebSocket URL, 네트워크 수신
  - config.toml `[adapters.solana]` 섹션과의 매핑:
    ```toml
    [adapters.solana]
    rpc_url = "https://api.mainnet-beta.solana.com"
    ws_url = "wss://api.mainnet-beta.solana.com"
    network = "mainnet-beta"
    commitment = "confirmed"
    ```

  **섹션 3: RPC 연결 관리 (connect / disconnect / isConnected / getHealth)**
  - connect(): createSolanaRpc(rpcUrl) + createSolanaRpcSubscriptions(wsUrl) + getHealth RPC 호출로 연결 확인
  - disconnect(): RPC 구독 정리, connected = false
  - isConnected(): connected 상태 반환
  - getHealth(): rpc.getHealth().send() 호출 -> latency 측정 -> `{ healthy: boolean, latency: number }` 반환
  - 재연결 로직: connect 실패 시 3회 재시도 (1초, 2초, 4초 exponential backoff)
  - CORE-04 결정: 어댑터 초기화 실패 = warn (fail-fast 아님)

  **섹션 4: 조회 메서드 (getBalance / getTransactionStatus / estimateFee)**
  - getBalance(address):
    - rpc.getBalance(address as Address).send()
    - 반환: `{ amount: bigint, decimals: 9, symbol: 'SOL', formatted: string }`
    - SPL 토큰 잔액은 v0.3으로 이연 (현재 네이티브 SOL만)
  - getTransactionStatus(txHash):
    - rpc.getSignatureStatuses([signature]).send()
    - confirmationStatus 매핑: 'processed' | 'confirmed' | 'finalized'
    - 반환: `{ confirmed: boolean, confirmations: number, status: string }`
  - estimateFee(request):
    - base fee: 5000 lamports (Solana 고정 base fee)
    - priority fee: rpc.getRecentPrioritizationFees() 호출 -> 중간값 사용
    - Compute Unit 제한: ComputeBudgetProgram instruction 추가 패턴
    - 반환: `{ estimatedFee: bigint, currency: 'SOL', breakdown: { baseFee, priorityFee } }`
  - 각 메서드의 @solana/kit 구체적 import 경로와 타입 명시

  </action>
  <verify>
  - 31-solana-adapter-detail.md 파일이 존재하고 문서 ID가 CHAIN-SOL
  - SolanaAdapter 클래스 구조가 IChainAdapter implements로 선언됨
  - 13개 메서드 매핑 테이블이 존재
  - connect/disconnect/isConnected/getHealth 4개 메서드의 @solana/kit API 호출이 명시됨
  - getBalance/getTransactionStatus/estimateFee 3개 메서드가 구체적 RPC 호출과 반환 타입으로 설계됨
  </verify>
  <done>SolanaAdapter 클래스 구조, RPC 연결 관리, 조회 메서드가 @solana/kit API 수준으로 설계됨</done>
</task>

<task type="auto">
  <name>Task 2: 트랜잭션 4단계 (build/simulate/sign/submit) + 확인 대기 + 에러 매핑 설계</name>
  <files>.planning/deliverables/31-solana-adapter-detail.md</files>
  <action>
  31-solana-adapter-detail.md에 다음 섹션을 추가한다.

  **섹션 5: buildTransaction -- @solana/kit pipe 기반 트랜잭션 빌드**
  - SOL 전송 (native transfer):
    - `@solana-program/system`의 `getTransferSolInstruction` 사용
    - pipe(createTransactionMessage({ version: 0 }), setFeePayer, setLifetimeUsingBlockhash, appendInstruction)
    - latestBlockhash 조회: rpc.getLatestBlockhash({ commitment: 'confirmed' }).send()
    - Priority Fee instruction 추가: setComputeUnitLimit + setComputeUnitPrice
  - SPL 토큰 전송 (token transfer):
    - `@solana-program/token`의 `getTransferInstruction` 사용
    - Associated Token Account (ATA) 조회/생성 패턴
    - `@solana-program/associated-token-account`의 `getCreateAssociatedTokenAccountInstruction`
  - 반환 타입: UnsignedTransaction (CORE-04 정의)
    - chain: 'solana', serialized: TransactionMessage 직렬화, estimatedFee, expiresAt (blockhash 수명 ~60초), metadata (blockhash, lastValidBlockHeight, version)
  - 코드 패턴: 07-RESEARCH.md Pattern 4의 buildSolTransfer를 발전시킨 완전한 구현

  **섹션 6: simulateTransaction -- 트랜잭션 시뮬레이션**
  - rpc.simulateTransaction(compiledTx, { commitment: 'confirmed' }).send()
  - 시뮬레이션 결과 파싱:
    - 성공: computeUnitsConsumed, 로그 메시지 추출
    - 실패: err 필드에서 에러 코드 추출 (InsufficientFundsForFee, AccountNotFound 등)
  - 반환 타입: SimulationResult (CORE-04 정의)
    - success: boolean, estimatedFee: bigint, logs: string[], error?: string
  - 시뮬레이션은 서명 없이 실행 가능 (replaceRecentBlockhash 옵션)
  - 시뮬레이션 실패 시 에러 매핑 (Solana 에러 코드 -> WAIaaS 에러 코드)

  **섹션 7: signTransaction -- 로컬 서명**
  - CORE-03 키스토어에서 복호화된 privateKey(Uint8Array, 64바이트: seed 32B + pubkey 32B)를 수신
  - @solana/kit의 `signTransactionMessageWithSigners` 또는 수동 서명:
    - KeyPairSigner 생성: createKeyPairSignerFromBytes(privateKey)
    - 또는 수동: signBytes(messageBytes, keypair)로 Ed25519 서명
  - 서명 후 즉시 sodium_memzero(privateKey) -- 호출자(session-service)가 수행
  - 반환: SignedTransaction (Uint8Array, 서명된 트랜잭션 바이트)
  - 서명 실패 시나리오: 키 길이 불일치, 만료된 blockhash (재빌드 필요)

  **섹션 8: submitTransaction -- 트랜잭션 제출**
  - rpc.sendTransaction(signedTx, { encoding: 'base64', skipPreflight: false }).send()
  - 반환 타입: SubmitResult (CORE-04 정의)
    - txHash: string (base58 signature), submittedAt: Date
  - skipPreflight 설정 전략:
    - 기본: false (preflight 시뮬레이션 재실행으로 이중 안전)
    - 시간이 촉박할 때: true (이미 simulateTransaction에서 검증 완료)
  - sendTransaction 에러 처리: AlreadyProcessed (중복 제출), BlockhashNotFound (만료)

  **섹션 9: waitForConfirmation -- 확인 대기**
  - 전략: 폴링 기반 (getSignatureStatuses) + 타임아웃
  - 폴링 간격: 2초, 최대 대기: 60초 (blockhash 수명)
  - 확인 수준: 'confirmed' (기본, ~6.4초) 또는 'finalized' (~12.8초)
    - 기본은 'confirmed' 사용 (빠른 응답). 'finalized'는 대액 거래에서 선택적
  - lastValidBlockHeight 활용: 현재 blockHeight > lastValidBlockHeight이면 만료 판정
  - 반환: `{ confirmed: boolean, confirmations: number, finalizedAt?: Date }`
  - 실패 시: TRANSACTION_NOT_CONFIRMED (타임아웃), TRANSACTION_DROPPED (블록에서 제외)

  **섹션 10: Solana-specific 에러 매핑**
  - Solana RPC 에러 코드 -> WAIaaS ChainError 매핑 테이블:
    | Solana 에러 | WAIaaS 에러 코드 | HTTP 상태 | 설명 |
    | InsufficientFunds | INSUFFICIENT_BALANCE | 400 | 잔액 부족 |
    | AccountNotFound | ACCOUNT_NOT_FOUND | 404 | 계정 미존재 |
    | BlockhashNotFound | BLOCKHASH_EXPIRED | 408 | blockhash 만료 |
    | TransactionError | TRANSACTION_FAILED | 500 | 온체인 실행 실패 |
    | RPC timeout | RPC_TIMEOUT | 503 | RPC 응답 없음 |
  - ChainError 클래스 (CORE-04 정의) 확장: Solana-specific error context 추가
  - 재시도 가능 에러 vs 재시도 불가 에러 분류

  **섹션 11: 성능 및 제약사항**
  - RPC rate limit 대응: 공용 Solana RPC는 40 req/s 제한 -> 사용자가 전용 RPC 설정 권장
  - blockhash 캐싱: 동일 슬롯 내 여러 트랜잭션에 동일 blockhash 재사용 (5초 캐시)
  - Priority Fee 자동 조정: getRecentPrioritizationFees 결과를 30초 캐시
  - Compute Unit 최적화: simulateTransaction 결과의 computeUnitsConsumed * 1.2를 setComputeUnitLimit에 사용
  - 07-RESEARCH.md Pitfall 3 (blockhash 만료) 대응 전략 요약

  </action>
  <verify>
  - buildTransaction이 SOL 전송/SPL 토큰 전송 두 가지 패턴으로 설계됨
  - simulateTransaction이 성공/실패 결과 파싱 로직과 함께 설계됨
  - signTransaction이 sodium guarded memory 64바이트 키 수신 패턴으로 설계됨
  - submitTransaction이 skipPreflight 전략과 에러 처리와 함께 설계됨
  - waitForConfirmation이 폴링 간격/타임아웃/lastValidBlockHeight 활용으로 설계됨
  - Solana 에러 -> WAIaaS 에러 매핑 테이블이 5개 이상 매핑으로 존재
  </verify>
  <done>SolanaAdapter의 트랜잭션 4단계 + 확인 대기 + 에러 매핑이 @solana/kit 코드 수준으로 설계됨. CHAIN-02 요구사항 충족.</done>
</task>

</tasks>

<verification>
1. 31-solana-adapter-detail.md가 .planning/deliverables/에 존재
2. CHAIN-02 (Solana Adapter 완전 구현): IChainAdapter 13개 메서드가 모두 Solana-specific 구현으로 매핑됨
3. @solana/kit의 pipe, createSolanaRpc, createTransactionMessage 등 주요 API가 코드 패턴으로 포함됨
4. SOL 전송 + SPL 토큰 전송 두 가지 트랜잭션 유형이 설계됨
5. CORE-03 키스토어의 sodium guarded memory와 signTransaction 연동이 명시됨
6. blockhash 만료 대응 전략이 문서화됨
</verification>

<success_criteria>
- Solana Adapter 설계 문서가 11개 섹션으로 구성되어 Phase 7 Success Criteria #4를 충족
- IChainAdapter 13개 메서드 모두 @solana/kit 구현 수준으로 설계됨
- CORE-04 공통 타입(TransferRequest, UnsignedTransaction, SimulationResult, SubmitResult)이 Solana 구현으로 매핑됨
</success_criteria>

<output>
After completion, create `.planning/phases/07-session-transaction-protocol-design/07-02-SUMMARY.md`
</output>
