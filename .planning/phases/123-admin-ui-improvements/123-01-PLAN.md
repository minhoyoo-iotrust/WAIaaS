---
phase: 123-admin-ui-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/admin/src/pages/dashboard.tsx
  - packages/admin/src/api/endpoints.ts
autonomous: true

must_haves:
  truths:
    - "대시보드 StatCard(Wallets, Active Sessions)를 클릭하면 해당 페이지로 이동한다"
    - "대시보드에 Policies, Recent Txns (24h), Failed Txns (24h) StatCard가 표시된다"
    - "대시보드에 최근 트랜잭션 5건의 활동 섹션이 표시된다"
    - "Failed Txns 0건이면 success 뱃지, 1건 이상이면 danger 뱃지가 표시된다"
  artifacts:
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "확장된 /admin/status 응답 (policyCount, recentTxCount, failedTxCount, recentTransactions)"
      contains: "policyCount"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "AdminStatusResponseSchema에 추가 필드"
      contains: "policyCount"
    - path: "packages/admin/src/pages/dashboard.tsx"
      provides: "클릭 가능한 StatCard + 추가 카드 + 최근 활동 테이블"
      contains: "href"
  key_links:
    - from: "packages/admin/src/pages/dashboard.tsx"
      to: "/v1/admin/status"
      via: "apiGet in fetchStatus"
      pattern: "apiGet.*ADMIN_STATUS"
    - from: "packages/admin/src/pages/dashboard.tsx"
      to: "#/wallets, #/sessions, #/policies, #/notifications"
      via: "StatCard href prop"
      pattern: "href.*#/"
---

<objective>
대시보드 StatCard에 페이지 링크를 추가하고, Policies/Recent Txns/Failed Txns 카드와 최근 활동 5건 섹션을 구현한다.

Purpose: 관리자가 대시보드에서 시스템 전체 현황을 한눈에 파악하고 상세 페이지로 바로 이동할 수 있다 (ADUI-01, ADUI-02, ADUI-03)
Output: 확장된 admin/status API + 개선된 대시보드 UI
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/admin/src/pages/dashboard.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/components/table.tsx
@packages/admin/src/utils/format.ts
@objectives/issues/v1.4.6-027-admin-dashboard-enhancement.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: /admin/status API 응답 확장 -- 정책 수, 트랜잭션 통계, 최근 활동</name>
  <files>
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
  </files>
  <action>
1. `openapi-schemas.ts`의 `AdminStatusResponseSchema`에 필드 추가:
   - `policyCount: z.number().int()` -- 활성 정책 수
   - `recentTxCount: z.number().int()` -- 24시간 내 트랜잭션 수
   - `failedTxCount: z.number().int()` -- 24시간 내 실패 트랜잭션 수
   - `recentTransactions: z.array(z.object({ id: z.string(), walletId: z.string(), walletName: z.string().nullable(), type: z.string(), status: z.string(), toAddress: z.string().nullable(), amount: z.string().nullable(), network: z.string().nullable(), createdAt: z.number().int().nullable() }))` -- 최근 5건

2. `admin.ts`의 `statusRoute` 핸들러에서 추가 쿼리 수행:
   - `policies` 테이블 import 추가 (`transactions`도 import)
   - `COUNT(*) FROM policies` -> policyCount
   - `COUNT(*) FROM transactions WHERE created_at > (nowSec - 86400)` -> recentTxCount (24h). `created_at`이 Date 객체로 저장되므로 `sql` 템플릿으로 `created_at > datetime(${nowSec - 86400}, 'unixepoch')` 패턴 사용. 또는 `gt(transactions.createdAt, new Date((nowSec - 86400) * 1000))` drizzle API 사용.
   - `COUNT(*) FROM transactions WHERE status = 'FAILED' AND created_at > 24h` -> failedTxCount
   - 최근 트랜잭션 5건 조회: `SELECT t.*, w.name as walletName FROM transactions t LEFT JOIN wallets w ON t.walletId = w.id ORDER BY t.createdAt DESC LIMIT 5`. Drizzle로: `deps.db.select({ id: transactions.id, walletId: transactions.walletId, walletName: wallets.name, type: transactions.type, status: transactions.status, toAddress: transactions.toAddress, amount: transactions.amount, network: transactions.network, createdAt: transactions.createdAt }).from(transactions).leftJoin(wallets, eq(transactions.walletId, wallets.id)).orderBy(desc(transactions.createdAt)).limit(5).all()`
   - `desc` import 추가 from drizzle-orm
   - `transactions` import 추가 from schema
   - createdAt를 epoch seconds로 변환: `tx.createdAt ? Math.floor(tx.createdAt.getTime() / 1000) : null`

3. 기존 응답 필드(status, version, uptime, walletCount, activeSessionCount, killSwitchState, adminTimeout, timestamp)는 그대로 유지. 신규 필드만 추가하여 하위호환 보장.
  </action>
  <verify>
`npm run build -w packages/daemon` 성공. 기존 admin route 테스트 `npm test -- --grep admin` 패스 확인 (기존 필드 유지).
  </verify>
  <done>
GET /v1/admin/status 응답에 policyCount, recentTxCount, failedTxCount, recentTransactions 필드가 포함된다. 기존 필드는 변경 없이 유지된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 대시보드 StatCard 링크 + 추가 카드 + 최근 활동 UI</name>
  <files>
    packages/admin/src/pages/dashboard.tsx
  </files>
  <action>
1. `StatCard` 컴포넌트에 `href?: string` prop 추가:
   - href가 있으면 `<a>` 태그로 감싸고 class에 `stat-card-link` 추가
   - href가 없으면 기존 `<div>` 유지
   - 링크가 있는 카드에 화살표 힌트 표시: label 뒤에 ` ->` 텍스트 또는 CSS로 `::after` 화살표 (간단하게 label 값에 포함하지 말고, href가 있을 때 작은 화살표 span을 stat-label 옆에 추가)

2. `AdminStatus` 인터페이스에 신규 필드 추가:
   ```typescript
   policyCount: number;
   recentTxCount: number;
   failedTxCount: number;
   recentTransactions: Array<{
     id: string; walletId: string; walletName: string | null;
     type: string; status: string; toAddress: string | null;
     amount: string | null; network: string | null; createdAt: number | null;
   }>;
   ```

3. 기존 StatCard 그리드에 href 추가:
   - Wallets -> `#/wallets`
   - Active Sessions -> `#/sessions`
   - Version, Uptime -> href 없음
   - Kill Switch, Status -> href 없음

4. 두 번째 stat-grid 아래에 세 번째 stat-grid 추가:
   - Policies StatCard: `href="#/policies"`, 값은 `data.value?.policyCount?.toString()`
   - Recent Txns (24h) StatCard: href 없음, 값은 `data.value?.recentTxCount?.toString()`
   - Failed Txns (24h) StatCard: href 없음, 값은 `data.value?.failedTxCount?.toString()`, badge: failedTxCount === 0 이면 'success', > 0 이면 'danger'

5. stat-grid 아래에 "Recent Activity" 섹션 추가:
   - `<h3>` 제목 "Recent Activity"
   - Table 컴포넌트 import하여 사용 (`import { Table } from '../components/table'`)
   - Column 정의: Time (createdAt -> formatDate 또는 상대 시간), Wallet (walletName ?? walletId.slice(0,8)), Type, Amount (amount ?? '--'), Status (Badge: CONFIRMED=success, PENDING/QUEUED=warning, FAILED=danger)
   - 데이터: `data.value?.recentTransactions ?? []`
   - emptyMessage: "No recent transactions"
   - 테이블에 loading 상태 적용: `loading={isInitialLoad}`

6. stat-card-link 스타일: CSS 없이 인라인으로 처리. `<a>` 태그에 `class="stat-card stat-card-link"`, `style={{ textDecoration: 'none', color: 'inherit', cursor: 'pointer' }}` 추가. 이 프로젝트는 CSP가 엄격하므로 인라인 스타일이 이미 사용되고 있는 패턴을 따른다. 기존 dashboard.tsx의 스타일 패턴(class 기반 + 인라인 style)을 유지한다.
  </action>
  <verify>
`npm run build -w packages/admin` 성공. 브라우저에서 대시보드 확인: StatCard 클릭으로 페이지 이동, 추가 카드 표시, 최근 활동 테이블 표시.
  </verify>
  <done>
Wallets/Sessions StatCard 클릭 시 해당 페이지로 이동. Policies/Recent Txns/Failed Txns 카드가 올바른 데이터로 표시. 최근 트랜잭션 5건이 테이블로 표시. Failed Txns 0건=success 뱃지, 1건+=danger 뱃지.
  </done>
</task>

</tasks>

<verification>
1. `npm run build -w packages/daemon && npm run build -w packages/admin` -- 전체 빌드 성공
2. `npm test -- --grep admin` -- 기존 admin 테스트 패스 (하위호환)
3. 대시보드 로드 시 policyCount, recentTxCount, failedTxCount가 숫자로 표시
4. Wallets StatCard 클릭 -> #/wallets 페이지 이동
5. Active Sessions StatCard 클릭 -> #/sessions 페이지 이동
6. Policies StatCard 클릭 -> #/policies 페이지 이동
7. Recent Activity 테이블에 최대 5건 표시 (트랜잭션 없으면 빈 상태)
</verification>

<success_criteria>
- ADUI-01: StatCard에서 해당 페이지로 링크 이동이 가능하다
- ADUI-02: 대시보드에 Policies, Recent Txns (24h), Failed Txns (24h) 추가 StatCard가 표시된다
- ADUI-03: 대시보드에 최근 트랜잭션 5건의 활동 섹션이 표시된다
</success_criteria>

<output>
After completion, create `.planning/phases/123-admin-ui-improvements/123-01-SUMMARY.md`
</output>
