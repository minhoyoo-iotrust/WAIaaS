---
phase: 123-admin-ui-improvements
plan: 02
type: execute
wave: 2
depends_on: ["123-01"]
files_modified:
  - packages/daemon/src/api/routes/sessions.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/server.ts
  - packages/admin/src/pages/wallets.tsx
  - packages/admin/src/pages/sessions.tsx
  - packages/admin/src/api/endpoints.ts
autonomous: true

must_haves:
  truths:
    - "월렛 상세 페이지에서 네이티브 + 토큰 잔액을 확인할 수 있다"
    - "월렛 상세 페이지에서 최근 트랜잭션 내역 테이블을 확인할 수 있다"
    - "세션 페이지 진입 시 walletId 선택 없이 전체 세션 목록이 즉시 표시된다"
    - "세션 목록에 walletName 컬럼이 표시된다"
  artifacts:
    - path: "packages/daemon/src/api/routes/sessions.ts"
      provides: "walletId 미지정 시 전체 세션 반환 + walletName JOIN"
      contains: "walletName"
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "GET /admin/wallets/:id/balance + /admin/wallets/:id/transactions"
      contains: "admin/wallets"
    - path: "packages/admin/src/pages/wallets.tsx"
      provides: "Balance 섹션 + Recent Transactions 테이블"
      contains: "fetchBalance"
    - path: "packages/admin/src/pages/sessions.tsx"
      provides: "전체 세션 즉시 조회 + walletName 컬럼"
      contains: "walletName"
  key_links:
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "/v1/admin/wallets/:id/balance, /v1/admin/wallets/:id/transactions"
      via: "apiGet from WalletDetailView"
      pattern: "ADMIN_WALLET_BALANCE|ADMIN_WALLET_TRANSACTIONS"
    - from: "packages/admin/src/pages/sessions.tsx"
      to: "/v1/sessions"
      via: "apiGet without walletId on initial load"
      pattern: "apiGet.*SESSIONS"
    - from: "packages/daemon/src/api/routes/sessions.ts"
      to: "wallets table"
      via: "leftJoin for walletName"
      pattern: "leftJoin.*wallets"
---

<objective>
월렛 상세 페이지에 잔액/트랜잭션 섹션을 추가하고, 세션 페이지에서 전체 세션을 즉시 조회할 수 있게 한다.

Purpose: 관리자가 월렛별 운영 현황(잔액, 트랜잭션)을 Admin UI에서 직접 확인하고, 세션 전체 현황을 한눈에 파악할 수 있다 (ADUI-04, ADUI-05, ADUI-06, ADUI-07)
Output: Admin 월렛 잔액/트랜잭션 API + 월렛 상세 UI + 세션 전체 조회 백엔드/프론트엔드
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/123-admin-ui-improvements/123-01-SUMMARY.md
@packages/daemon/src/api/routes/sessions.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/server.ts
@packages/admin/src/pages/wallets.tsx
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/components/table.tsx
@packages/admin/src/utils/format.ts
@objectives/issues/v1.4.6-024-admin-wallet-balance-transactions.md
@objectives/issues/v1.4.6-026-admin-sessions-list-all.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 세션 전체 조회 API + walletName + 프론트엔드 + Admin 월렛 잔액/트랜잭션 API</name>
  <files>
    packages/daemon/src/api/routes/sessions.ts
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/server.ts
    packages/admin/src/api/endpoints.ts
  </files>
  <action>
**1. 세션 API 수정 (sessions.ts):**

`listSessionsRoute` 핸들러에서 walletId 필수 검증(`if (!walletId) { throw ... }`) 삭제. walletId optional 분기:

```typescript
const conditions = [isNull(sessions.revokedAt)];
if (walletId) {
  conditions.push(eq(sessions.walletId, walletId));
}

const rows = deps.db
  .select({
    id: sessions.id, walletId: sessions.walletId,
    expiresAt: sessions.expiresAt, absoluteExpiresAt: sessions.absoluteExpiresAt,
    createdAt: sessions.createdAt, renewalCount: sessions.renewalCount,
    maxRenewals: sessions.maxRenewals, lastRenewedAt: sessions.lastRenewedAt,
    walletName: wallets.name,
  })
  .from(sessions)
  .leftJoin(wallets, eq(sessions.walletId, wallets.id))
  .where(and(...conditions))
  .orderBy(sql`${sessions.createdAt} DESC`)
  .all();
```

응답 매핑에 `walletName: row.walletName ?? null` 추가.

**2. 스키마 수정 (openapi-schemas.ts):**

`SessionListItemSchema`에 `walletName: z.string().nullable()` 필드 추가.

**3. Admin 월렛 라우트 추가 (admin.ts):**

AdminRouteDeps에 optional 필드 추가:
```typescript
adapterPool?: AdapterPool | null;
daemonConfig?: DaemonConfig;
```

import 추가: `transactions`, `tokenRegistry` from schema, `AdapterPool`, `resolveRpcUrl` from adapter-pool, `resolveNetwork`, `validateNetworkEnvironment` from network-resolver, `gt` from drizzle-orm.

**라우트 A: `GET /admin/wallets/:id/transactions`**
- params: `id: z.string().uuid()`, query: `limit: z.coerce.number().int().min(1).max(100).default(20).optional()`
- DB 쿼리: `transactions` 테이블에서 `walletId = id`, `ORDER BY createdAt DESC`, `LIMIT limit`
- 전체 카운트: `COUNT(*)` 별도 쿼리
- 응답: `{ items: [{ id, type, status, toAddress, amount, network, txHash, createdAt(epoch sec) }], total }`
- createdAt 변환: `tx.createdAt ? Math.floor(tx.createdAt.getTime() / 1000) : null`

**라우트 B: `GET /admin/wallets/:id/balance`**
- params: `id: z.string().uuid()`
- 월렛 조회: `deps.db.select().from(wallets).where(eq(wallets.id, id)).get()`
- 없으면 404 throw
- `adapterPool`이 없으면 `{ native: null, tokens: [] }` 반환
- 있으면:
  - `resolveRpcUrl(deps.daemonConfig!.rpc, wallet.chain, wallet.defaultNetwork!)`
  - `deps.adapterPool.getAdapter(wallet.chain)` -- `connect(rpcUrl)` 호출
  - `adapter.getBalance(wallet.publicKey)` -- BalanceInfo 반환 (balance: bigint, decimals, symbol)
  - 잔액을 사람이 읽을 수 있는 형식으로 변환: `(Number(balanceInfo.balance) / 10 ** balanceInfo.decimals).toString()`
  - 토큰: tokenRegistry에서 해당 network의 토큰 목록 조회 -> `adapter.getAssets(wallet.publicKey)` 호출 (AssetInfo[] 반환)
  - 실패 시 catch -> `{ native: null, tokens: [], error: message }`
- 응답: `{ native: { balance, symbol, network } | null, tokens: [{ symbol, balance, address }], error?: string }`

**4. 서버 연결 (server.ts):**

`adminRoutes({...})` 호출에 `adapterPool: deps.adapterPool ?? null`, `daemonConfig: deps.config` 전달.

**5. 프론트엔드 엔드포인트 (endpoints.ts):**

```typescript
ADMIN_WALLET_BALANCE: (id: string) => `/v1/admin/wallets/${id}/balance`,
ADMIN_WALLET_TRANSACTIONS: (id: string) => `/v1/admin/wallets/${id}/transactions`,
```
  </action>
  <verify>
`npm run build -w packages/daemon` 성공. `npm test -- --grep session` 및 `npm test -- --grep admin` 패스 (기존 동작 유지). `curl http://localhost:21420/v1/sessions -H 'X-Master-Password: ...'` 전체 세션 반환 확인.
  </verify>
  <done>
GET /v1/sessions (walletId 없이) 전체 세션 반환 + walletName 포함. GET /v1/admin/wallets/:id/balance 네이티브+토큰 잔액 반환. GET /v1/admin/wallets/:id/transactions 트랜잭션 목록 반환. 기존 walletId 지정 세션 조회는 동일 동작.
  </done>
</task>

<task type="auto">
  <name>Task 2: 세션 전체 조회 UI + 월렛 상세 잔액/트랜잭션 UI</name>
  <files>
    packages/admin/src/pages/sessions.tsx
    packages/admin/src/pages/wallets.tsx
  </files>
  <action>
**A. 세션 페이지 수정 (sessions.tsx):**

1. `Session` 인터페이스에 `walletName: string | null` 추가.

2. `fetchSessions` 수정 -- `selectedWalletId.value`가 빈 문자열이면 walletId 없이 호출:
   ```typescript
   const url = selectedWalletId.value
     ? `${API.SESSIONS}?walletId=${selectedWalletId.value}`
     : API.SESSIONS;
   const result = await apiGet<Session[]>(url);
   ```
   함수 상단의 `if (!selectedWalletId.value) return;` 삭제.

3. 초기 로드 useEffect 수정 -- 페이지 진입 시 전체 세션 즉시 로드:
   ```typescript
   useEffect(() => {
     fetchWallets();
     fetchSessions(); // walletId 없이 전체 조회
   }, []);
   ```

4. selectedWalletId 변경 useEffect -- 항상 fetchSessions() 호출:
   ```typescript
   useEffect(() => {
     sessions.value = [];
     fetchSessions();
   }, [selectedWalletId.value]);
   ```

5. sessionColumns에 Wallet 컬럼 추가 (ID 다음):
   ```typescript
   { key: 'walletName', header: 'Wallet',
     render: (s) => s.walletName ?? s.walletId.slice(0, 8) + '...' },
   ```

6. 드롭다운 기본 옵션을 `"All Wallets"`로 변경:
   ```html
   <option value="">All Wallets</option>
   ```

7. 렌더링 분기 수정 -- `!selectedWalletId.value` 일 때 EmptyState 대신 Table 표시:
   항상 `<Table>` 렌더링. Create Session 버튼은 `!selectedWalletId.value`이면 disabled 유지.

**B. 월렛 상세 페이지 수정 (wallets.tsx):**

1. 타입 추가:
   ```typescript
   interface WalletBalance {
     native: { balance: string; symbol: string; network: string } | null;
     tokens: Array<{ symbol: string; balance: string; address: string }>;
     error?: string;
   }
   interface WalletTransaction {
     id: string; type: string; status: string; toAddress: string | null;
     amount: string | null; network: string | null; txHash: string | null;
     createdAt: number | null;
   }
   ```

2. `WalletDetailView`에 signal 추가:
   ```typescript
   const balance = useSignal<WalletBalance | null>(null);
   const balanceLoading = useSignal(true);
   const txs = useSignal<WalletTransaction[]>([]);
   const txsLoading = useSignal(true);
   ```

3. fetch 함수:
   ```typescript
   const fetchBalance = async () => {
     balanceLoading.value = true;
     try {
       balance.value = await apiGet<WalletBalance>(API.ADMIN_WALLET_BALANCE(id));
     } catch { balance.value = null; }
     finally { balanceLoading.value = false; }
   };
   const fetchTransactions = async () => {
     txsLoading.value = true;
     try {
       const r = await apiGet<{ items: WalletTransaction[]; total: number }>(
         API.ADMIN_WALLET_TRANSACTIONS(id));
       txs.value = r.items;
     } catch { txs.value = []; }
     finally { txsLoading.value = false; }
   };
   ```

4. useEffect에 추가: `fetchBalance(); fetchTransactions();` (fetchWallet, fetchNetworks와 함께).

5. detail-grid 아래, networks-section 위에 **Balance 섹션** 삽입:
   - `<h3>Balance</h3>`
   - 로딩 중: skeleton
   - native가 있으면: `DetailRow label="Native" value="{balance} {symbol} ({network})"`
   - tokens 있으면: 각 토큰 `DetailRow label={symbol} value={balance}`
   - tokens 없으면: "No tokens registered" 텍스트
   - native가 null이면: "Balance unavailable" 또는 error 메시지 표시

6. networks-section 아래, mcp-setup-section 위에 **Recent Transactions 섹션** 삽입:
   - `<h3>Recent Transactions</h3>`
   - Table 컴포넌트 사용 (이미 import 됨)
   - 컬럼 정의 (txColumns):
     - Time: `(t) => t.createdAt ? formatDate(t.createdAt) : '--'`
     - Type: `(t) => t.type`
     - To: `(t) => t.toAddress ? formatAddress(t.toAddress) : '--'`
     - Amount: `(t) => t.amount ?? '--'`
     - Status: `(t) => <Badge variant={t.status === 'CONFIRMED' ? 'success' : t.status === 'FAILED' ? 'danger' : 'warning'}>{t.status}</Badge>`
     - Network: `(t) => t.network ?? '--'`
   - `loading={txsLoading.value}`
   - `emptyMessage="No transactions yet"`
  </action>
  <verify>
`npm run build -w packages/admin` 성공. 브라우저에서: (1) 세션 페이지 진입 시 전체 세션 즉시 표시 + Wallet 컬럼, (2) 월렛 상세에서 잔액/트랜잭션 표시.
  </verify>
  <done>
세션 페이지 진입 시 전체 세션이 walletName 컬럼과 함께 즉시 표시. 드롭다운으로 월렛별 필터링 가능. 월렛 상세에 네이티브+토큰 잔액과 최근 트랜잭션 테이블이 표시. 빈 상태 적절히 처리.
  </done>
</task>

</tasks>

<verification>
1. `npm run build -w packages/daemon && npm run build -w packages/admin` -- 전체 빌드 성공
2. `npm test -- --grep session` -- 기존 세션 테스트 패스
3. `npm test -- --grep admin` -- 기존 admin 테스트 패스
4. 세션 페이지 진입 시 전체 세션이 테이블에 즉시 표시
5. 세션 테이블에 Wallet 컬럼 표시, 월렛 이름 보임
6. 드롭다운에서 특정 월렛 선택 시 필터링
7. 월렛 상세 페이지에 Balance 섹션 표시 (네이티브 + 토큰)
8. 월렛 상세 페이지에 Recent Transactions 테이블 표시
</verification>

<success_criteria>
- ADUI-04: 월렛 상세 페이지에 네이티브 + 토큰 잔액 섹션이 표시된다
- ADUI-05: 월렛 상세 페이지에 최근 트랜잭션 내역 테이블이 표시된다
- ADUI-06: 세션 페이지 진입 시 전체 세션 목록이 즉시 표시된다
- ADUI-07: 세션 목록에 walletName 컬럼이 표시된다
</success_criteria>

<output>
After completion, create `.planning/phases/123-admin-ui-improvements/123-02-SUMMARY.md`
</output>
