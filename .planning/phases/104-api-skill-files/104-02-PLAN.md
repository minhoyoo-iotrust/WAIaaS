---
phase: 104-api-skill-files
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/policies.skill.md
  - skills/admin.skill.md
  - how-to-test/waiass-api.skill.md
autonomous: true

must_haves:
  truths:
    - "policies.skill.md covers all 10 PolicyTypes with rules schema examples and curl commands"
    - "admin.skill.md covers all 12 admin endpoints (status, kill-switch, notifications, settings, shutdown, rotate-secret)"
    - "how-to-test/waiass-api.skill.md contains a deprecation notice pointing to skills/ directory"
    - "Each skill file has YAML frontmatter, workflow guidance, curl examples, parameter descriptions, and error handling"
  artifacts:
    - path: "skills/policies.skill.md"
      provides: "Complete 10-PolicyType CRUD reference"
      contains: "APPROVE_TIER_OVERRIDE"
    - path: "skills/admin.skill.md"
      provides: "Admin API reference (12 endpoints)"
      contains: "admin/settings"
    - path: "how-to-test/waiass-api.skill.md"
      provides: "Deprecation notice redirecting to skills/"
      contains: "DEPRECATED"
  key_links:
    - from: "skills/policies.skill.md"
      to: "skills/transactions.skill.md"
      via: "cross-reference explaining policy effects on transactions"
      pattern: "transactions.skill.md"
    - from: "skills/admin.skill.md"
      to: "skills/policies.skill.md"
      via: "cross-reference for policy management"
      pattern: "policies.skill.md"
---

<objective>
Create 2 API skill files (policies, admin) and deprecate the old skill file, completing the full 5-file skill set.

Purpose: Complete the skill file suite so AI agents have structured references for all API surface areas. Deprecate the outdated `how-to-test/waiass-api.skill.md` which uses old terminology and lacks 5-type transactions, settings API, and token registry coverage.

Output: 2 new skill files in `skills/` + deprecation of old file.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source of truth for policy and admin routes
@packages/daemon/src/api/routes/policies.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/core/src/schemas/policy.schema.ts
@packages/core/src/enums/policy.ts

# Existing file to deprecate
@how-to-test/waiass-api.skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create policies.skill.md with 10-PolicyType CRUD reference</name>
  <files>skills/policies.skill.md</files>
  <action>
Create `skills/policies.skill.md` with complete policy management reference.

**Frontmatter:**
```yaml
name: "WAIaaS Policies"
description: "Policy engine CRUD: 10 policy types for spending limits, whitelists, time restrictions, rate limits, token/contract/approve controls"
category: "api"
tags: [wallet, blockchain, policies, security, waiass]
version: "1.4.4"
dispatch:
  kind: "tool"
  allowedCommands: ["curl"]
```

**Content sections:**

1. **Overview** - Policy engine enforces rules on wallet operations. Policies can be wallet-specific (walletId) or global (omit walletId). 4-tier system: INSTANT/NOTIFY/DELAY/APPROVAL.

2. **Policy CRUD Endpoints** with full curl examples:
   - `POST /v1/policies` (sessionAuth) -- create policy. Body: `{walletId?, type, rules, priority?, enabled?}`
   - `GET /v1/policies?walletId=<uuid>` (sessionAuth) -- list policies
   - `PUT /v1/policies/{id}` (sessionAuth) -- update rules/priority/enabled
   - `DELETE /v1/policies/{id}` (sessionAuth) -- delete policy

3. **10 Policy Types** with type-specific `rules` schema and curl examples for each:

   **a. SPENDING_LIMIT** - Max spend per period
   ```json
   {"type":"SPENDING_LIMIT","rules":{"maxAmount":"1000000000","period":"daily"}}
   ```
   Period values: "hourly", "daily", "weekly", "monthly"

   **b. WHITELIST** - Allowed recipient addresses
   ```json
   {"type":"WHITELIST","rules":{"addresses":["<addr1>","<addr2>"]}}
   ```

   **c. TIME_RESTRICTION** - Allowed time windows
   ```json
   {"type":"TIME_RESTRICTION","rules":{"allowedHours":{"start":9,"end":17},"timezone":"UTC"}}
   ```

   **d. RATE_LIMIT** - Max transactions per period
   ```json
   {"type":"RATE_LIMIT","rules":{"maxTransactions":10,"period":"hourly"}}
   ```

   **e. ALLOWED_TOKENS** (v1.4) - Token whitelist. **Default deny**: tokens not listed are blocked.
   ```json
   {"type":"ALLOWED_TOKENS","rules":{"tokens":[{"address":"<mint>","symbol":"USDC","chain":"solana"}]}}
   ```

   **f. CONTRACT_WHITELIST** (v1.4) - Contract whitelist. **Default deny**.
   ```json
   {"type":"CONTRACT_WHITELIST","rules":{"contracts":[{"address":"<contract>","name":"Uniswap","chain":"ethereum"}]}}
   ```

   **g. METHOD_WHITELIST** (v1.4) - Allowed contract methods (per contract).
   ```json
   {"type":"METHOD_WHITELIST","rules":{"methods":[{"contractAddress":"<addr>","selectors":["0xa9059cbb","0x095ea7b3"]}]}}
   ```

   **h. APPROVED_SPENDERS** (v1.4) - Allowed spenders for APPROVE transactions. **Default deny**.
   ```json
   {"type":"APPROVED_SPENDERS","rules":{"spenders":[{"address":"<spender>","name":"Uniswap Router","maxAmount":"1000000000"}]}}
   ```

   **i. APPROVE_AMOUNT_LIMIT** (v1.4) - Max approval amount + block unlimited.
   ```json
   {"type":"APPROVE_AMOUNT_LIMIT","rules":{"maxAmount":"1000000000","blockUnlimited":true}}
   ```

   **j. APPROVE_TIER_OVERRIDE** (v1.4) - Force a specific tier for APPROVE transactions.
   ```json
   {"type":"APPROVE_TIER_OVERRIDE","rules":{"tier":"APPROVAL"}}
   ```

4. **Policy Evaluation Flow** - How policies interact with transactions: tier assignment, default deny for ALLOWED_TOKENS/CONTRACT_WHITELIST/APPROVED_SPENDERS, superRefine validation.

5. **Common Workflows**:
   - "Allow USDC token transfers" -- create ALLOWED_TOKENS policy first, then send TOKEN_TRANSFER
   - "Allow Uniswap contract calls" -- create CONTRACT_WHITELIST + METHOD_WHITELIST
   - "Require owner approval for large transfers" -- SPENDING_LIMIT with APPROVAL tier

6. **Error Reference** - POLICY_NOT_FOUND, POLICY_VIOLATION, ACTION_VALIDATION_FAILED
  </action>
  <verify>
File exists at skills/policies.skill.md. Contains YAML frontmatter. Contains all 10 policy types (SPENDING_LIMIT through APPROVE_TIER_OVERRIDE). Contains curl examples for CRUD operations. Mentions "default deny" for ALLOWED_TOKENS, CONTRACT_WHITELIST, APPROVED_SPENDERS.
  </verify>
  <done>
policies.skill.md provides complete reference for all 10 policy types with rules schemas, curl examples, and common workflows showing policy-transaction interaction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin.skill.md and deprecate old skill file</name>
  <files>skills/admin.skill.md, how-to-test/waiass-api.skill.md</files>
  <action>
**File 1: `skills/admin.skill.md`**

Frontmatter: name "WAIaaS Admin", category "api", version "1.4.4", dispatch kind "tool" allowedCommands ["curl"].

Sections:

1. **Overview** - Admin endpoints manage daemon operations. All admin endpoints (except GET /admin/kill-switch) require masterAuth via `X-Master-Password` header.

2. **Daemon Status & Control**:
   - `GET /v1/admin/status` -- daemon health, uptime, version, wallet/session/tx counts
   - `POST /v1/admin/shutdown` -- graceful daemon shutdown (body: `{confirm: "SHUTDOWN"}`)
   - `POST /v1/admin/rotate-secret` -- rotate JWT signing secret. Existing tokens remain valid until expiry.

3. **Kill Switch** (emergency stop):
   - `POST /v1/admin/kill-switch` -- activate. Blocks all transaction endpoints (503). Body: `{reason: "..."}`
   - `GET /v1/admin/kill-switch` -- get current state (public, no auth)
   - `POST /v1/admin/recover` -- deactivate kill switch

4. **Notification Management**:
   - `GET /v1/admin/notifications/status` -- channel status (credentials masked to boolean)
   - `POST /v1/admin/notifications/test` -- send test notification. Body: `{channel: "telegram"|"discord"|"ntfy"}`
   - `GET /v1/admin/notifications/log?page=1&limit=20` -- query notification delivery logs

5. **Settings Management** (v1.4.4):
   - `GET /v1/admin/settings` -- get all settings organized by category (notifications, rpc, security, walletconnect, general). Credentials are masked.
   - `PUT /v1/admin/settings` -- update settings. Body: `{key: value, ...}`. Triggers hot-reload (no daemon restart needed).
     - Notification keys: `notifications_enabled`, `notifications_telegram_bot_token`, `notifications_telegram_chat_id`, `notifications_discord_webhook_url`, `notifications_ntfy_server`, `notifications_ntfy_topic`, `notifications_locale`
     - RPC keys: `rpc_solana_mainnet`, `rpc_solana_devnet`, `rpc_solana_testnet`, `rpc_evm_ethereum_mainnet`, `rpc_evm_ethereum_sepolia`, ... (13 EVM networks)
     - Security keys: `security_session_ttl`, `security_max_sessions_per_wallet`, `security_rate_limit_rpm`, `security_approval_timeout`, `security_delay_seconds`
     - WalletConnect: `walletconnect_project_id`
     - General: `general_log_level`
   - `POST /v1/admin/settings/test-rpc` -- test RPC connectivity. Body: `{url: "https://...", chain: "solana"|"ethereum"}`. Returns `{success: true/false, latencyMs, blockHeight?, error?}`.

6. **Common Workflows**:
   - "Set up Telegram notifications" -- PUT settings with bot_token + chat_id, then POST notifications/test
   - "Change RPC endpoint" -- PUT settings with rpc key, then POST settings/test-rpc to verify
   - "Emergency stop" -- POST kill-switch, investigate, POST recover

7. **Error Reference** - Admin-specific errors (KILL_SWITCH_ACTIVE 503, MASTER_AUTH_REQUIRED 401)

**File 2: Update `how-to-test/waiass-api.skill.md`**

Replace the entire content with a short deprecation notice:

```markdown
---
name: "WAIaaS API (DEPRECATED)"
description: "DEPRECATED -- Use skill files in skills/ directory instead"
category: "api"
tags: [deprecated]
version: "1.4.4"
---

# DEPRECATED

This skill file has been superseded by the focused skill files in the `skills/` directory:

- **skills/quickstart.skill.md** -- End-to-end quickstart workflow
- **skills/wallet.skill.md** -- Wallet CRUD, sessions, assets, tokens, MCP
- **skills/transactions.skill.md** -- 5-type transactions (TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH)
- **skills/policies.skill.md** -- 10 policy types CRUD
- **skills/admin.skill.md** -- Admin API (status, kill-switch, notifications, settings)

Load the relevant skill file for your use case.
```
  </action>
  <verify>
skills/admin.skill.md exists with YAML frontmatter. Contains all 12 admin endpoints (status, shutdown, rotate-secret, kill-switch x3, notifications x3, settings x3). how-to-test/waiass-api.skill.md contains "DEPRECATED" and links to skills/ directory.
  </verify>
  <done>
admin.skill.md provides complete admin API reference. Old skill file is deprecated with clear pointers to the new 5-file set in skills/ directory. All 5 requirements (SKILL-01 through SKILL-05) are satisfied.
  </done>
</task>

</tasks>

<verification>
1. `ls skills/` shows all 5 files: quickstart.skill.md, wallet.skill.md, transactions.skill.md, policies.skill.md, admin.skill.md
2. All 5 files have valid YAML frontmatter
3. `grep -r "DEPRECATED" how-to-test/waiass-api.skill.md` returns matches
4. `grep -r "agentId" skills/` returns 0 hits (must use walletId)
5. policies.skill.md lists all 10 types (SPENDING_LIMIT, WHITELIST, TIME_RESTRICTION, RATE_LIMIT, ALLOWED_TOKENS, CONTRACT_WHITELIST, METHOD_WHITELIST, APPROVED_SPENDERS, APPROVE_AMOUNT_LIMIT, APPROVE_TIER_OVERRIDE)
6. admin.skill.md covers settings management endpoints added in v1.4.4
</verification>

<success_criteria>
- 2 skill files created (policies, admin) completing the 5-file set
- SKILL-04 (policies) and SKILL-05 (admin) requirements satisfied
- Old skill file deprecated with clear migration path
- All 5 skill files use consistent format (YAML frontmatter, curl examples, error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/104-api-skill-files/104-02-SUMMARY.md`
</output>
