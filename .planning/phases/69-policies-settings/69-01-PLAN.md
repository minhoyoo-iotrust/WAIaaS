---
phase: 69-policies-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "User can view a list of all policies (global + agent-specific) in a table"
    - "User can filter policies by selecting an agent from a dropdown (shows agent + global policies)"
    - "User can create a new policy with type dropdown (10 types), optional agent, rules JSON textarea, priority, enabled"
    - "User can edit an existing policy's rules, priority, and enabled state"
    - "User can delete a policy with a confirmation modal"
    - "SPENDING_LIMIT policies display 4-tier colored bars: INSTANT=green, NOTIFY=blue, DELAY=yellow, APPROVAL=red"
  artifacts:
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "Policy CRUD page with tier visualization"
      min_lines: 200
    - path: "packages/admin/src/styles/global.css"
      provides: "Policy page CSS (tier bars, policy form styles)"
      contains: "tier-bar"
  key_links:
    - from: "packages/admin/src/pages/policies.tsx"
      to: "/v1/policies"
      via: "apiGet/apiPost/apiPut/apiDelete with API.POLICIES/POLICY endpoints"
      pattern: "apiGet.*POLICIES|apiPost.*POLICIES|apiPut.*POLICY|apiDelete.*POLICY"
    - from: "packages/admin/src/pages/policies.tsx"
      to: "/v1/agents"
      via: "apiGet for agent dropdown population"
      pattern: "apiGet.*AGENTS"
---

<objective>
Implement the Policies page with full CRUD for 10 policy types, agent-scoped filtering, JSON rules editing, and 4-tier SPENDING_LIMIT visualization.

Purpose: Enable administrators to manage all policy types through the web UI, with visual feedback for spending limit tiers.
Output: Working policies.tsx page and supporting CSS styles.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-dashboard-agents-sessions/68-02-SUMMARY.md
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/pages/agents.tsx
@packages/admin/src/api/client.ts
@packages/admin/src/api/endpoints.ts
@packages/admin/src/components/form.tsx
@packages/admin/src/components/modal.tsx
@packages/admin/src/styles/global.css
@packages/daemon/src/api/routes/policies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Policies page with CRUD and 4-tier visualization</name>
  <files>packages/admin/src/pages/policies.tsx, packages/admin/src/styles/global.css</files>
  <action>
Replace the placeholder policies.tsx with a full Policies page. Follow the exact patterns from sessions.tsx and agents.tsx (useSignal for state, try/catch with ApiError + getErrorMessage for error handling, FormField/Button/Badge/Table/Modal/EmptyState components).

**Interfaces:**
```typescript
interface Agent { id: string; name: string; chain: string; network: string; publicKey: string; status: string; createdAt: number; }

interface Policy {
  id: string;
  agentId: string | null;
  type: string;
  rules: Record<string, unknown>;
  priority: number;
  enabled: boolean;
  createdAt: number;
  updatedAt: number;
}
```

**Constants:**
```typescript
const POLICY_TYPES = [
  { label: 'Spending Limit', value: 'SPENDING_LIMIT' },
  { label: 'Whitelist', value: 'WHITELIST' },
  { label: 'Time Restriction', value: 'TIME_RESTRICTION' },
  { label: 'Rate Limit', value: 'RATE_LIMIT' },
  { label: 'Allowed Tokens', value: 'ALLOWED_TOKENS' },
  { label: 'Contract Whitelist', value: 'CONTRACT_WHITELIST' },
  { label: 'Method Whitelist', value: 'METHOD_WHITELIST' },
  { label: 'Approved Spenders', value: 'APPROVED_SPENDERS' },
  { label: 'Approve Amount Limit', value: 'APPROVE_AMOUNT_LIMIT' },
  { label: 'Approve Tier Override', value: 'APPROVE_TIER_OVERRIDE' },
];
```

**Default rules templates** (pre-populate textarea when type changes):
```typescript
const DEFAULT_RULES: Record<string, unknown> = {
  SPENDING_LIMIT: { instant_max: '1000000', notify_max: '5000000', delay_max: '10000000', delay_seconds: 300, approval_timeout: 3600 },
  WHITELIST: { allowed_addresses: [] },
  TIME_RESTRICTION: { allowed_hours: { start: 0, end: 24 }, allowed_days: [0,1,2,3,4,5,6] },
  RATE_LIMIT: { max_requests: 100, window_seconds: 3600 },
  ALLOWED_TOKENS: { tokens: [] },
  CONTRACT_WHITELIST: { contracts: [] },
  METHOD_WHITELIST: { methods: [] },
  APPROVED_SPENDERS: { spenders: [] },
  APPROVE_AMOUNT_LIMIT: { max_amount: '1000000' },
  APPROVE_TIER_OVERRIDE: { overrides: {} },
};
```

**Page structure:**

1. **Top controls** (like sessions page pattern):
   - Agent dropdown (using `apiGet<{ items: Agent[] }>(API.AGENTS)` to populate, include "All Policies" and "Global Only" options)
   - "Create Policy" button (toggles inline form)

2. **Inline create form** (shown/hidden by showForm signal, uses `inline-form` CSS class):
   - Type: `FormField type="select"` with POLICY_TYPES options
   - Agent: `FormField type="select"` with agents list + "Global (no agent)" option (value="")
   - Rules: `FormField type="textarea"` pre-populated with `JSON.stringify(DEFAULT_RULES[selectedType], null, 2)`. When type changes, update rules textarea with the new default template.
   - Priority: `FormField type="number"` default 0, min=0, max=999
   - Enabled: `FormField type="checkbox"` default true
   - Create/Cancel buttons in `inline-form-actions`

3. **Policy table** with columns:
   - Type: render as Badge (info variant for most, success for SPENDING_LIMIT)
   - Agent: show agent name or "Global" if agentId is null (look up from agents array)
   - Rules: show truncated JSON summary (first 60 chars + "...")
   - Priority: number
   - Enabled: Badge (success "ON" / danger "OFF")
   - Actions: Edit (ghost button) + Delete (danger sm button)

4. **Edit modal** (Modal component):
   - Title: "Edit Policy"
   - Show type as read-only text (type cannot be changed after creation)
   - Rules: textarea (pre-populated with JSON.stringify(policy.rules, null, 2))
   - Priority: number input
   - Enabled: checkbox
   - Confirm/Cancel buttons
   - On confirm: PUT to `API.POLICY(id)` with `{ rules: JSON.parse(rulesText), priority, enabled }`
   - Validate JSON parse before submit; show form error if invalid JSON

5. **Delete modal** (Modal component, danger variant):
   - "Are you sure you want to delete this policy?" with policy type display
   - On confirm: DELETE to `API.POLICY(id)`

6. **SPENDING_LIMIT tier visualization** (TierVisualization component):
   - Rendered inside the Rules column for SPENDING_LIMIT type policies instead of raw JSON
   - Four horizontal colored bars showing the tier thresholds:
     - INSTANT bar: `var(--color-tier-instant)` (#16a34a green) — label "Instant" + value
     - NOTIFY bar: `var(--color-info)` (#2563eb blue) — label "Notify" + value
     - DELAY bar: `var(--color-tier-delay)` (#d97706 yellow) — label "Delay" + value
     - APPROVAL bar: `var(--color-tier-blocked)` (#dc2626 red) — label "Approval" (implied = above delay_max)
   - Each bar width proportional to its max value relative to the largest tier value
   - Values displayed as formatted numbers (e.g., "1,000,000")

**API calls:**
- Fetch agents: `apiGet<{ items: Agent[] }>(API.AGENTS)` on mount
- Fetch policies: `apiGet<Policy[]>(API.POLICIES)` for all, or `apiGet<Policy[]>(`${API.POLICIES}?agentId=${id}`)` when agent selected
- Create: `apiPost(API.POLICIES, { agentId: agentId || undefined, type, rules: JSON.parse(rulesText), priority, enabled })`
- Update: `apiPut(API.POLICY(id), { rules: JSON.parse(rulesText), priority, enabled })`
- Delete: `apiDelete(API.POLICY(id))`

**Error handling:**
- All API calls wrapped in try/catch, catch block uses `instanceof ApiError` check, calls `showToast('error', getErrorMessage(e.code))`
- JSON parse errors in rules textarea show inline form error (not toast)

**Imports** (follow exact pattern from sessions.tsx):
```typescript
import { useSignal } from '@preact/signals';
import { useEffect } from 'preact/hooks';
import { apiGet, apiPost, apiPut, apiDelete, ApiError } from '../api/client';
import { API } from '../api/endpoints';
import { Table } from '../components/table';
import type { Column } from '../components/table';
import { FormField, Button, Badge } from '../components/form';
import { Modal } from '../components/modal';
import { EmptyState } from '../components/empty-state';
import { showToast } from '../components/toast';
import { getErrorMessage } from '../utils/error-messages';
import { formatDate } from '../utils/format';
```

**CSS additions** to global.css (append at end of file):

```css
/* Policies */
.policy-controls {
  display: flex;
  align-items: flex-end;
  gap: var(--space-4);
  margin-bottom: var(--space-4);
}

.policy-filter-select {
  flex: 1;
  max-width: 400px;
}

.policy-filter-select label {
  display: block;
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-text);
  margin-bottom: var(--space-1);
}

.policy-filter-select select {
  width: 100%;
  padding: var(--space-2) var(--space-3);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: var(--font-size-sm);
  background: var(--color-bg);
  color: var(--color-text);
  outline: none;
}

.policy-filter-select select:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 2px var(--color-primary-light);
}

/* Tier Visualization */
.tier-bars {
  display: flex;
  flex-direction: column;
  gap: 3px;
  min-width: 180px;
}

.tier-bar {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  font-size: var(--font-size-xs);
}

.tier-bar-label {
  width: 52px;
  flex-shrink: 0;
  font-weight: var(--font-weight-medium);
}

.tier-bar-track {
  flex: 1;
  height: 6px;
  background: var(--color-bg-tertiary);
  border-radius: 3px;
  overflow: hidden;
}

.tier-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.3s ease;
}

.tier-bar-value {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  min-width: 60px;
  text-align: right;
}

.tier-bar-fill--instant { background: var(--color-tier-instant); }
.tier-bar-fill--notify  { background: var(--color-info); }
.tier-bar-fill--delay   { background: var(--color-tier-delay); }
.tier-bar-fill--approval { background: var(--color-tier-blocked); }

/* Policy rules summary */
.rules-summary {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  max-width: 250px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-family: 'SF Mono', 'Fira Code', monospace;
}

/* Edit modal rules textarea */
.edit-rules-textarea textarea {
  min-height: 120px;
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: var(--font-size-xs);
}

.policy-type-readonly {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
  padding: var(--space-2) 0;
  margin-bottom: var(--space-2);
}
```
  </action>
  <verify>
1. `pnpm --filter @waiaas/admin build` succeeds without errors
2. Verify policies.tsx exports a default function component
3. Verify global.css contains tier-bar, policy-controls, and rules-summary classes
4. Verify all 10 POLICY_TYPES are present in the dropdown options
5. Verify TierVisualization renders 4 bars with correct CSS color classes (instant, notify, delay, approval)
  </verify>
  <done>
Policies page renders with agent filter dropdown, policy table with all columns, inline create form with 10-type dropdown and JSON rules textarea, edit modal, delete modal, and SPENDING_LIMIT 4-tier colored bar visualization (green=INSTANT, blue=NOTIFY, yellow=DELAY, red=APPROVAL).
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin build` succeeds
2. policies.tsx exports default function PoliciesPage
3. All 10 policy types available in create form dropdown
4. Agent dropdown populates from /v1/agents endpoint
5. SPENDING_LIMIT policies show 4-tier colored bars instead of raw JSON
6. Edit modal has read-only type, editable rules/priority/enabled
7. Delete modal shows confirmation before API call
8. Error handling uses getErrorMessage for all API errors
</verification>

<success_criteria>
- Policy CRUD (create, list, edit, delete) works via API endpoints
- 10 policy types selectable in create form dropdown
- Agent filter shows agent-specific + global policies
- SPENDING_LIMIT 4-tier visualization with correct colors (green, blue, yellow, red)
- JSON parse validation prevents invalid rules submission
- All error codes (POLICY_NOT_FOUND, ACTION_VALIDATION_FAILED, AGENT_NOT_FOUND) show user-friendly messages
</success_criteria>

<output>
After completion, create `.planning/phases/69-policies-settings/69-01-SUMMARY.md`
</output>
