---
phase: 69-policies-settings
plan: 02
type: execute
wave: 2
depends_on: [69-01]
files_modified:
  - packages/admin/src/pages/settings.tsx
  - packages/admin/src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "User can see current Kill Switch state (NORMAL or ACTIVATED) and toggle it"
    - "Activating Kill Switch when already active shows KILL_SWITCH_ACTIVE error toast"
    - "Recovering Kill Switch when not active shows KILL_SWITCH_NOT_ACTIVE error toast"
    - "User can rotate JWT secret with a confirmation modal and sees success toast with warning about 5-min old token validity"
    - "User can shut down the daemon with a double-confirmation modal (type 'SHUTDOWN' to confirm)"
    - "ROTATION_TOO_RECENT error shows user-friendly toast when JWT rotation is attempted too soon"
  artifacts:
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "Settings page with Kill Switch, JWT rotation, shutdown"
      min_lines: 150
    - path: "packages/admin/src/styles/global.css"
      provides: "Settings page CSS (settings sections, kill switch toggle)"
      contains: "settings-section"
  key_links:
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/kill-switch"
      via: "apiGet for state, apiPost for activate"
      pattern: "apiGet.*KILL_SWITCH|apiPost.*KILL_SWITCH"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/recover"
      via: "apiPost for deactivate"
      pattern: "apiPost.*RECOVER"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/rotate-secret"
      via: "apiPost for JWT rotation"
      pattern: "apiPost.*ROTATE_SECRET"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/shutdown"
      via: "apiPost for graceful shutdown"
      pattern: "apiPost.*SHUTDOWN"
---

<objective>
Implement the Settings page with Kill Switch toggle, JWT secret rotation with confirmation modal, and daemon shutdown with double-confirmation (type-to-confirm) modal.

Purpose: Give administrators access to critical daemon operations — emergency kill switch, key rotation, and graceful shutdown — with appropriate safety guards.
Output: Working settings.tsx page and supporting CSS styles.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/69-policies-settings/69-01-SUMMARY.md
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/api/client.ts
@packages/admin/src/api/endpoints.ts
@packages/admin/src/components/form.tsx
@packages/admin/src/components/modal.tsx
@packages/admin/src/utils/error-messages.ts
@packages/admin/src/styles/global.css
@packages/daemon/src/api/routes/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Settings page with Kill Switch, JWT rotation, and shutdown</name>
  <files>packages/admin/src/pages/settings.tsx, packages/admin/src/styles/global.css</files>
  <action>
Replace the placeholder settings.tsx with the full Settings page. Follow exact patterns from sessions.tsx (useSignal for state, try/catch with ApiError + getErrorMessage, showToast for feedback).

**Imports:**
```typescript
import { useSignal } from '@preact/signals';
import { useEffect } from 'preact/hooks';
import { apiGet, apiPost, ApiError } from '../api/client';
import { API } from '../api/endpoints';
import { Button, Badge } from '../components/form';
import { Modal } from '../components/modal';
import { showToast } from '../components/toast';
import { getErrorMessage } from '../utils/error-messages';
import { formatDate } from '../utils/format';
```

**Interfaces:**
```typescript
interface KillSwitchState {
  state: string;        // 'NORMAL' | 'ACTIVATED'
  activatedAt: number | null;
  activatedBy: string | null;
}
```

**Page structure — three distinct settings sections:**

### Section 1: Kill Switch
- On mount: `apiGet<KillSwitchState>(API.ADMIN_KILL_SWITCH)` to get current state
- Display: Card with "Kill Switch" title, current state as Badge (success "NORMAL" or danger "ACTIVATED")
- If ACTIVATED: show activatedAt timestamp using formatDate, activatedBy value
- Action button:
  - If state is NORMAL: "Activate Kill Switch" (danger button) — calls `apiPost(API.ADMIN_KILL_SWITCH)`
  - If state is ACTIVATED: "Recover" (primary button) — calls `apiPost(API.ADMIN_RECOVER)`
- No confirmation modal needed for kill switch (it's designed for emergencies)
- On success: show toast "Kill switch activated" or "Kill switch recovered", refetch state
- On error: if `KILL_SWITCH_ACTIVE` or `KILL_SWITCH_NOT_ACTIVE`, show error toast via `getErrorMessage(e.code)`
- Description text: "Emergency stop — suspends all agent operations immediately."

### Section 2: JWT Secret Rotation
- "Rotate JWT Secret" button (secondary variant)
- On click: open confirmation Modal with title "Rotate JWT Secret"
- Modal body: "Are you sure you want to rotate the JWT secret? All existing session tokens will remain valid for 5 more minutes, then expire. Agents will need new sessions."
- Confirm button text: "Rotate" (primary variant)
- On confirm: `apiPost<{ rotatedAt: number; message: string }>(API.ADMIN_ROTATE_SECRET)`
- On success: close modal, show toast "JWT secret rotated. Old tokens valid for 5 minutes."
- On error: `ROTATION_TOO_RECENT` → error toast via getErrorMessage
- Description text: "Invalidate all existing JWT tokens. Old tokens remain valid for 5 minutes."

### Section 3: Daemon Shutdown
- "Shutdown Daemon" button (danger variant)
- On click: open first confirmation Modal with title "Shutdown Daemon"
- Modal body: "This will gracefully stop the daemon process. All active connections will be terminated."
- Modal has a text input: user must type "SHUTDOWN" to enable the confirm button
- Confirm button text: "Shutdown" (danger variant), disabled until input === 'SHUTDOWN'
- On confirm: `apiPost<{ message: string }>(API.ADMIN_SHUTDOWN)`
- On success: show toast "Shutdown initiated", then show a full-page overlay or disable the page (since daemon is going down)
- Description text: "Stop the daemon process. This action cannot be undone remotely."

**Signals (all page-local useSignal):**
- killSwitchState: `useSignal<KillSwitchState | null>(null)`
- ksLoading: `useSignal(true)` (initial fetch loading)
- ksActionLoading: `useSignal(false)` (activate/recover in progress)
- rotateModal: `useSignal(false)`
- rotateLoading: `useSignal(false)`
- shutdownModal: `useSignal(false)`
- shutdownLoading: `useSignal(false)`
- shutdownConfirmText: `useSignal('')` (for type-to-confirm)
- isShutdown: `useSignal(false)` (after shutdown initiated, overlay shown)

**Component structure:**
```tsx
export default function SettingsPage() {
  // signals
  // fetchKillSwitchState()
  // handleKillSwitchToggle()
  // handleRotate()
  // handleShutdown()
  // useEffect(() => fetchKillSwitchState(), [])

  return (
    <div class="page">
      {isShutdown.value && <div class="shutdown-overlay">...</div>}

      <div class="settings-section">
        <div class="settings-section-header">
          <h3>Kill Switch</h3>
          <p class="settings-description">Emergency stop — suspends all agent operations immediately.</p>
        </div>
        <div class="settings-section-body">
          {/* Kill switch state card + action button */}
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-header">
          <h3>JWT Secret Rotation</h3>
          <p class="settings-description">Invalidate all existing JWT tokens. Old tokens remain valid for 5 minutes.</p>
        </div>
        <div class="settings-section-body">
          <Button variant="secondary" onClick={() => { rotateModal.value = true; }}>Rotate JWT Secret</Button>
        </div>
      </div>

      <div class="settings-section settings-section--danger">
        <div class="settings-section-header">
          <h3>Danger Zone</h3>
          <p class="settings-description">Irreversible actions. Proceed with caution.</p>
        </div>
        <div class="settings-section-body">
          <Button variant="danger" onClick={() => { shutdownModal.value = true; }}>Shutdown Daemon</Button>
        </div>
      </div>

      {/* Rotate Modal */}
      {/* Shutdown Modal with type-to-confirm */}
    </div>
  );
}
```

**Shutdown type-to-confirm pattern:**
Inside the shutdown Modal body, render a FormField or plain input where the user types "SHUTDOWN". The confirm button's disabled prop checks `shutdownConfirmText.value !== 'SHUTDOWN'`. Reset shutdownConfirmText to '' when modal closes.

**Post-shutdown overlay:**
When isShutdown is true, render a fixed overlay div (like modal-overlay but permanent) with a message: "Daemon is shutting down..." and a note "You can close this tab." This prevents further actions after shutdown.

**CSS additions** to global.css (append at very end, after the 69-01 additions):

```css
/* Settings */
.settings-section {
  background: var(--color-bg);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  margin-bottom: var(--space-4);
}

.settings-section--danger {
  border-color: var(--color-danger);
}

.settings-section-header {
  margin-bottom: var(--space-4);
}

.settings-section-header h3 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-1);
}

.settings-description {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.settings-section-body {
  display: flex;
  align-items: center;
  gap: var(--space-4);
}

.ks-state-card {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  flex: 1;
}

.ks-state-info {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.shutdown-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 300;
  color: white;
}

.shutdown-overlay h2 {
  font-size: var(--font-size-2xl);
  margin-bottom: var(--space-4);
  color: white;
}

.shutdown-overlay p {
  font-size: var(--font-size-base);
  color: var(--color-text-muted);
}

.shutdown-confirm-input {
  margin-top: var(--space-3);
}

.shutdown-confirm-input label {
  display: block;
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-1);
}

.shutdown-confirm-input input {
  width: 100%;
  padding: var(--space-2) var(--space-3);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: var(--font-size-sm);
  background: var(--color-bg);
  color: var(--color-text);
  outline: none;
}

.shutdown-confirm-input input:focus {
  border-color: var(--color-danger);
  box-shadow: 0 0 0 2px var(--color-danger-bg);
}
```
  </action>
  <verify>
1. `pnpm --filter @waiaas/admin build` succeeds without errors
2. Verify settings.tsx exports a default function component
3. Verify global.css contains settings-section, shutdown-overlay, ks-state-card classes
4. Verify Kill Switch section uses API.ADMIN_KILL_SWITCH and API.ADMIN_RECOVER endpoints
5. Verify JWT rotation uses API.ADMIN_ROTATE_SECRET endpoint
6. Verify Shutdown uses API.ADMIN_SHUTDOWN endpoint
7. Verify shutdown modal has type-to-confirm (disabled button until "SHUTDOWN" typed)
  </verify>
  <done>
Settings page renders three sections: (1) Kill Switch with state display and activate/recover toggle, (2) JWT Secret Rotation with confirmation modal, (3) Danger Zone with daemon shutdown double-confirmation (type "SHUTDOWN" to enable). Error codes KILL_SWITCH_ACTIVE, KILL_SWITCH_NOT_ACTIVE, and ROTATION_TOO_RECENT all show user-friendly toast messages. Post-shutdown overlay prevents further interaction.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin build` succeeds
2. settings.tsx exports default function SettingsPage
3. Kill Switch state fetched on mount via GET /v1/admin/kill-switch
4. Activate calls POST /v1/admin/kill-switch, recover calls POST /v1/admin/recover
5. KILL_SWITCH_ACTIVE error shows "Kill switch is active. All operations are suspended." toast
6. KILL_SWITCH_NOT_ACTIVE error shows "Kill switch is not currently active." toast
7. JWT rotation modal shows warning about 5-min validity window
8. ROTATION_TOO_RECENT error shows user-friendly toast
9. Shutdown requires typing "SHUTDOWN" to enable confirm button
10. Post-shutdown shows overlay preventing further actions
</verification>

<success_criteria>
- Kill Switch toggle works: NORMAL -> activate -> ACTIVATED -> recover -> NORMAL
- Error toasts for KILL_SWITCH_ACTIVE and KILL_SWITCH_NOT_ACTIVE display correctly
- JWT rotation with confirmation modal, success shows rotatedAt message
- ROTATION_TOO_RECENT error handled gracefully
- Shutdown requires type-to-confirm, shows post-shutdown overlay
- All three settings sections render in distinct cards with proper styling
</success_criteria>

<output>
After completion, create `.planning/phases/69-policies-settings/69-02-SUMMARY.md`
</output>
