---
phase: 155-security-test-p1
plan: 02
type: execute
wave: 2
depends_on: ["155-01"]
files_modified:
  - packages/daemon/src/__tests__/security/layer3-killswitch/killswitch-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/keystore-external/keystore-external-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/boundary-chain/boundary-values.security.test.ts
  - packages/daemon/src/__tests__/security/boundary-chain/e2e-attack-chains.security.test.ts
autonomous: true
must_haves:
  truths:
    - "Kill Switch 공격 8건(SEC-03-01~08)이 모두 적절한 상태 전이와 에러 코드로 차단된다"
    - "키스토어+외부 보안 10건(SEC-04-01~06 + EX-01~04)이 모두 방어된다"
    - "경계값 19건(SEC-05 Part 1)이 금액/시간/동시성/세션 한도에서 정확한 +/-1 동작을 보인다"
    - "E2E 연쇄 공격 5건(SEC-05 Part 2)이 Layer 1-2-3 관통 방어를 증명한다"
    - "pnpm test:security 실행으로 71건 보안 시나리오가 전체 통과한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/security/layer3-killswitch/killswitch-attacks.security.test.ts"
      provides: "SEC-03-01~08 Kill Switch 공격 시나리오 8건"
      contains: "ACTIVATED/RECOVERING guard, brute-force lockout, signature forgery, cascade partial failure"
    - path: "packages/daemon/src/__tests__/security/keystore-external/keystore-external-attacks.security.test.ts"
      provides: "SEC-04-01~06 + EX-01~04 키스토어+외부 보안 10건"
      contains: "locked signing, authTag tamper, wrong password, path traversal, memzero, host header, file perms, secret exposure, rate limit"
    - path: "packages/daemon/src/__tests__/security/boundary-chain/boundary-values.security.test.ts"
      provides: "SEC-05 Part 1 경계값 19건 (금액 6 + 시간 8 + TOCTOU 3 + 세션 한도 2)"
      contains: "BigInt boundary +-1 lamport, FakeClock time boundaries, session constraint limits"
    - path: "packages/daemon/src/__tests__/security/boundary-chain/e2e-attack-chains.security.test.ts"
      provides: "SEC-05 Part 2 E2E 연쇄 공격 체인 5건"
      contains: "Chain 1-5: session exhaustion, TOCTOU chain, amount escalation, session hijack+recovery, time-based+consecutive failures"
  key_links:
    - from: "killswitch-attacks.security.test.ts"
      to: "packages/daemon/src/services/kill-switch-service.ts"
      via: "KillSwitchService.activate()/recover() + killSwitchGuard middleware"
      pattern: "killSwitchService|killSwitchGuard"
    - from: "keystore-external-attacks.security.test.ts"
      to: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      via: "KeyStore.sign()/lock()/unlock() + hostGuard middleware"
      pattern: "keyStore\\.sign|keyStore\\.lock|hostGuard"
    - from: "boundary-values.security.test.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "DatabasePolicyEngine.evaluate() with +-1 lamport BigInt amounts"
      pattern: "evaluate.*amount"
    - from: "e2e-attack-chains.security.test.ts"
      to: "packages/daemon/src/pipeline/stages.ts"
      via: "Full pipeline execution with sequential attack steps"
      pattern: "pipeline|txService"
---

<objective>
Kill Switch 공격 8건(SEC-03) + 키스토어/외부 보안 10건(SEC-04) + 경계값 19건 + E2E 연쇄 5건(SEC-05) = 42건 보안 시나리오 테스트 구현

Purpose: 설계 문서 45(Kill Switch), 46(키스토어/외부 보안), 47(경계값/연쇄 공격)의 공격 시나리오를 테스트 코드로 전환하여, 3계층 보안 모델의 Layer 3 + 키스토어 + 계층 간 통합 방어가 증명된 상태를 달성한다.
Output: 4개 테스트 파일 (packages/daemon/src/__tests__/security/)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/155-security-test-p1/155-01-SUMMARY.md
@objectives/v1.7-quality-cicd.md
@docs/v0.4/45-layer3-killswitch-recovery-attacks.md
@docs/v0.4/46-keystore-external-security-scenarios.md
@docs/v0.4/47-boundary-value-chain-scenarios.md
@packages/daemon/src/services/kill-switch-service.ts
@packages/daemon/src/services/autostop-service.ts
@packages/daemon/src/services/autostop-rules.ts
@packages/daemon/src/api/middleware/kill-switch-guard.ts
@packages/daemon/src/api/middleware/host-guard.ts
@packages/daemon/src/api/middleware/session-auth.ts
@packages/daemon/src/api/middleware/owner-auth.ts
@packages/daemon/src/infrastructure/keystore/keystore.ts
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/__tests__/kill-switch-service.test.ts
@packages/daemon/src/__tests__/kill-switch-cascade.test.ts
@packages/daemon/src/__tests__/autostop-service.test.ts
@packages/daemon/src/__tests__/keystore.test.ts
@packages/daemon/src/__tests__/security/helpers/security-test-helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kill Switch 공격 8건(SEC-03) + 키스토어/외부 보안 10건(SEC-04)</name>
  <files>
    packages/daemon/src/__tests__/security/layer3-killswitch/killswitch-attacks.security.test.ts
    packages/daemon/src/__tests__/security/keystore-external/keystore-external-attacks.security.test.ts
  </files>
  <action>
155-01에서 생성한 security-test-helpers.ts를 import하여 재사용한다.

**Part A: SEC-03-01~08 Kill Switch 공격 테스트** (`killswitch-attacks.security.test.ts`)

설계 문서 45의 Given-When-Then을 테스트로 변환한다:

- **SEC-03-01 ACTIVATED 상태 API 접근** (Critical):
  - key_value_store에 kill_switch_state = SUSPENDED (또는 코드베이스의 실제 ACTIVATED 상태값 확인)
  - 유효 세션 토큰으로 GET /v1/wallet/balance -> 401 SYSTEM_LOCKED
  - /health -> 200 OK (허용 목록)
  - /v1/owner/recover -> killSwitchGuard 통과 (이후 ownerAuth 검증)
  - /v1/admin/status -> 200 OK (허용 목록)

- **SEC-03-02 복구 brute-force** (High):
  - KillSwitchService의 recover() 또는 해당 API 엔드포인트 사용
  - 5회 잘못된 마스터 패스워드 -> 1~4회 401, 5회차 429 TOO_MANY_ATTEMPTS
  - lockout 기간(30분) 중 올바른 패스워드도 거부
  - FakeClock으로 30분 경과 후 올바른 패스워드로 복구 성공
  - **주의:** RecoveryAttemptTracker가 존재하는지 확인. 없으면 KillSwitchService 내부의 실패 카운터 메커니즘 확인

- **SEC-03-03 복구 시 Owner 서명 위조** (Critical):
  - 등록된 Owner와 다른 키쌍으로 서명 생성
  - ownerAuth Step 5/6에서 서명자 주소 불일치 -> INVALID_SIGNATURE 또는 OWNER_NOT_FOUND
  - kill_switch_state 변경 없음 확인

- **SEC-03-04 AutoStop CONSECUTIVE_FAILURES** (High):
  - AutoStopService 또는 autostop-rules의 evaluate 함수 직접 호출
  - 3회 연속 TX_FAILED 이벤트 전달 -> SUSPEND_AGENT 결정
  - 정지 후 추가 거래 시도 -> WALLET_SUSPENDED
  - 경계값: 2회 실패 후 성공 1회 -> 카운터 리셋 확인

- **SEC-03-05 Kill Switch 이중 발동** (Medium):
  - 이미 SUSPENDED/ACTIVATED 상태에서 activate() 재호출 -> 409 또는 에러
  - 상태/이유/actor 변경 없음

- **SEC-03-06 복구 후 세션 재사용** (High):
  - Kill Switch 발동 -> 모든 세션 revokedAt 설정
  - Owner dual-auth 복구 -> NORMAL 복귀
  - 이전 토큰으로 접근 -> SESSION_REVOKED (폐기 세션은 복원 안됨)
  - 새 세션 발급 필요

- **SEC-03-07 캐스케이드 부분 실패** (Medium):
  - Step 1-3(원자적 DB 트랜잭션) 성공 후 Step 4(키스토어 잠금) 실패 주입
  - Step 5(알림), Step 6(감사) best-effort 계속 진행 확인
  - system_state는 ACTIVATED 유지
  - **참고:** 기존 kill-switch-cascade.test.ts의 패턴 참고. KeyStore.lock() mock에서 에러 throw

- **SEC-03-08 RECOVERING 상태 API 접근** (High):
  - RECOVERING 상태 직접 설정
  - 일반 API -> 401 SYSTEM_LOCKED (ACTIVATED와 동일)
  - /v1/owner/recover -> killSwitchGuard 통과
  - /health -> 200 OK

**추가: Kill Switch 3-state 전이 검증 (섹션 4.2)**:
- NORMAL에서 recover() -> 409 KILL_SWITCH_NOT_ACTIVE
- RECOVERING에서 activate() -> 409 KILL_SWITCH_ALREADY_ACTIVE

**Part B: SEC-04-01~06 + EX-01~04 키스토어/외부 보안** (`keystore-external-attacks.security.test.ts`)

설계 문서 46의 시나리오를 테스트로 변환한다:

- **SEC-04-01 잠금 상태에서 서명** (Critical, Unit):
  - keyStore.lock() 후 sign() 호출 -> KEYSTORE_NOT_UNLOCKED 에러
  - 기존 keystore.test.ts 패턴 참고. 잠금 후 서명 시도의 에러 메시지 확인

- **SEC-04-02 authTag 변조** (Critical, Integration):
  - tmpdir에 실제 키스토어 파일 생성 -> JSON 읽기 -> crypto.authTag 1바이트 변경 -> 다시 기록
  - unlock() 시도 -> KEYSTORE_CORRUPTED 또는 복호화 실패 에러
  - **주의:** 이 테스트는 실제 sodium-native/argon2 바인딩이 필요하므로 Integration 레벨. 환경에 바인딩이 없으면 describe.skipIf로 건너뛰기

- **SEC-04-03 잘못된 마스터 패스워드** (High, Integration):
  - tmpdir에 "correct-password"로 키스토어 생성 -> "wrong-password"로 unlock -> 에러
  - isUnlocked 여전히 false 확인

- **SEC-04-04 파일 경로 순회** (High, Unit):
  - resolveKeystorePath 또는 해당 함수에 "../../etc/passwd", "wallet\x00.json", "wallet/../../root" 전달
  - UUID v7 형식이 아닌 값 -> INVALID_AGENT_ID 또는 유사 에러
  - 정상 UUID v7 -> 정상 경로 반환

- **SEC-04-05 메모리 클리어** (High, Unit):
  - unlock() 후 내부 keyBuffer 참조 획득 -> lock() -> Buffer가 0으로 채워졌는지 확인
  - keyMap이 비워졌는지 확인
  - **참고:** 내부 구현에 따라 _getKeyBuffer 같은 테스트용 접근자가 필요할 수 있다. 없으면 sign() 실패 + getPublicKey() 실패로 간접 검증

- **SEC-04-06 미존재 에이전트 키** (Medium, Unit):
  - 등록되지 않은 walletId로 getPublicKey()/sign() -> WALLET_NOT_FOUND

- **SEC-04-EX-01 Host 헤더 변조** (High, Integration):
  - Hono test client로 Host: "evil.com" 요청 -> 403 HOST_NOT_ALLOWED
  - Host: "localhost:9999" -> 403
  - Host: "localhost:3100" -> hostGuard 통과
  - Host: "127.0.0.1:3100" -> hostGuard 통과

- **SEC-04-EX-02 키스토어 디렉토리 권한** (High, Unit):
  - tmpdir에 ensureKeystoreDir() 호출 -> mode & 0o777 === 0o700 확인
  - 파일 생성 후 mode & 0o777 === 0o600 확인
  - **주의:** CI에서 root로 실행 시 권한 검증이 다를 수 있으므로 process.getuid() !== 0 조건부

- **SEC-04-EX-03 JWT Secret 노출 방지** (High, Unit):
  - /health, /v1/wallet/balance(401 에러), /v1/admin/status 응답을 JSON.stringify
  - jwt_secret, master_password 등 민감 문자열이 응답에 포함되지 않음 확인 (negative assertion)
  - stack trace 미포함 확인

- **SEC-04-EX-04 Rate Limit 글로벌 한도** (Medium, Integration):
  - Rate Limiter가 구현되어 있으면 3개 세션으로 글로벌 한도 초과 시 429 확인
  - 구현 미확인 시 describe.skip으로 건너뛰기
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/layer3-killswitch/ packages/daemon/src/__tests__/security/keystore-external/ --reporter=verbose` 실행하여 18건 테스트 모두 통과 확인
  </verify>
  <done>
SEC-03-01~08(Kill Switch 8건) + SEC-04-01~06+EX-01~04(키스토어/외부 10건) = 18건 공격 시나리오가 모두 방어됨이 테스트로 증명된 상태.
  </done>
</task>

<task type="auto">
  <name>Task 2: 경계값 19건 + E2E 연쇄 공격 5건 (SEC-05)</name>
  <files>
    packages/daemon/src/__tests__/security/boundary-chain/boundary-values.security.test.ts
    packages/daemon/src/__tests__/security/boundary-chain/e2e-attack-chains.security.test.ts
  </files>
  <action>
155-01의 security-test-helpers.ts와 155-02 Task 1의 패턴을 재사용한다.

**Part A: SEC-05 Part 1 경계값 19건** (`boundary-values.security.test.ts`)

설계 문서 47 Part 1의 모든 경계값 테스트를 구현한다:

**금액 경계 (6건):**
- **SEC-05-A01~03 기본 정책 경계** (1/10/50 SOL):
  - INSTANT/NOTIFY: "999999999"(INSTANT), "1000000000"(INSTANT -- 이하), "1000000001"(NOTIFY)
  - NOTIFY/DELAY: "9999999999"(NOTIFY), "10000000000"(NOTIFY), "10000000001"(DELAY)
  - DELAY/APPROVAL: "49999999999"(DELAY), "50000000000"(DELAY), "50000000001"(APPROVAL)
  - DatabasePolicyEngine.evaluate() 직접 호출 또는 evaluateSpendingLimit
  - BigInt `<=` 비교 검증

- **SEC-05-A04~06 커스텀 정책 경계** (0.1/1/10 SOL):
  - 동일 패턴으로 커스텀 정책의 경계값 확인
  - instant_max="100000000", notify_max="1000000000", delay_max="10000000000"

**시간 경계 (8건):**
- **SEC-05-T01 JWT 만료**: FakeClock/vi.useFakeTimers. exp-1초(유효), exp(유효 -- jose의 <=), exp+1초(TOKEN_EXPIRED)
- **SEC-05-T02 DELAY 쿨다운**: expiresAt-1초(QUEUED), expiresAt(실행), expiresAt+1초(실행)
- **SEC-05-T03 APPROVAL 타임아웃**: timeout-1초(승인 성공), timeout(만료), timeout+1초(승인 거부)
- **SEC-05-T04 세션 최대 수명**: expiresIn=604800(성공), 604801(VALIDATION_ERROR)
- **SEC-05-T05 세션 최소 수명**: expiresIn=299(거부), 300(성공), 301(성공)
- **SEC-05-T06 Blockhash 만료**: MockChainAdapter로 50초 경계 확인 (선택적 -- SolanaAdapter 의존)
- **SEC-05-T07 Nonce TTL**: createNonce() 후 4:59(유효), 5:00(만료), 5:01(만료)
- **SEC-05-T08 ownerAuth timestamp**: signedAt + 4:59(통과), 5:00(거부), 5:01(거부)

**TOCTOU 동시성 (3건):**
- **SEC-05-C01 reserved_amount 경합**: SEC-02-01과 유사하되 경계값에 집중. 남은 한도 2SOL, 동시 각 3SOL
- **SEC-05-C02 세션 usageStats 경합**: maxTransactions=10, totalTx=9, 동시 2건 -> 1성공 1거부
- **SEC-05-C03 BEGIN IMMEDIATE 직렬화**: 5개 동시 거래, 모든 요청 직렬 처리, SQLITE_BUSY 없음

**세션 한도 경계 (2건):**
- **SEC-05-S01 maxAmountPerTx +/-1**: limit-1(허용), limit(허용), limit+1(SESSION_LIMIT_EXCEEDED)
- **SEC-05-S02 maxTotalAmount/maxTransactions +/-1**: 남은 한도-1(허용), 정확히(허용), 남은 한도+1(거부)

**주의:** TOCTOU 테스트(C01~C03)는 실제 SQLite가 필요하므로 tmpdir 사용. 나머지는 in-memory DB 또는 직접 함수 호출. SEC-05-T06 Blockhash 만료는 SolanaAdapter 의존이므로 구현 가능 범위 내에서 작성하되, 불가하면 describe.skip 처리.

**Part B: SEC-05 Part 2 E2E 연쇄 공격 5건** (`e2e-attack-chains.security.test.ts`)

설계 문서 47 Part 2의 5개 공격자 스토리를 단계별로 검증한다. 각 Chain은 describe 블록으로 구성하고, 내부에 Step별 it() 또는 순차 assertion으로 구현:

- **Chain 1: 세션 한도 소진** (Layer 1):
  - 세션 발급 -> 소액 반복(INSTANT) -> 남은 한도 정확히 소진 -> 추가 시도 SESSION_LIMIT_EXCEEDED
  - 반복 190회는 비효율적이므로 usageStats를 직접 조작하여 9.5SOL 사용 상태로 시딩 후 테스트
  - 핵심: 세션 한도가 최대 피해 범위를 결정

- **Chain 2: 정책 우회 + TOCTOU** (Layer 1 -> Layer 2):
  - 실제 SQLite + MockChainAdapter. 2 세션 동시 사용
  - usageStats 8SOL + 동시 각 3SOL -> 최대 1개 성공, DB totalAmount <= 10SOL
  - SEC-02-01과 유사하나 E2E 관점에서 전체 파이프라인 실행

- **Chain 3: 금액 에스컬레이션 -> Kill Switch** (Layer 1 -> 2 -> 3):
  - 소액 5건(INSTANT) -> 15SOL(DELAY) -> FakeClock 15분 -> 55SOL(APPROVAL) -> FakeClock 1시간(만료) -> 재시도 3회 -> AutoStop SUSPEND
  - MockNotificationChannel로 알림 기록 확인
  - **단순화:** 실제 파이프라인 호출이 복잡하면 서비스 레이어 직접 호출로 대체. 핵심은 에스컬레이션 + AutoStop 트리거 검증

- **Chain 4: 세션 탈취 + 복구** (Layer 1 -> 3 -> 복구):
  - Agent A 토큰으로 거래(성공) -> Kill Switch 발동 -> API 차단 확인 -> Owner dual-auth 복구 -> 이전 토큰 SESSION_REVOKED
  - 전체 복구 E2E 흐름 검증

- **Chain 5: 시간 기반 우회 + 연속 실패** (Layer 1 -> 2 -> 3):
  - JWT 만료 1초 전 거래(성공) -> 만료 후 거래(TOKEN_EXPIRED) -> 새 세션 + DELAY -> 한도 초과 반복 3회 -> AutoStop SUSPEND
  - FakeClock으로 전체 타임라인 제어

**주의:** E2E 체인 테스트는 여러 서비스의 통합을 요구하므로 테스트 setup이 복잡하다. 가능한 서비스 레이어를 직접 호출하되, 풀 스택이 어려우면 핵심 시나리오에 집중한다. 각 체인에서 검증해야 할 핵심 assertion을 우선시하고, 전체 파이프라인 E2E가 불가하면 서비스 단위 호출 조합으로 대체.

**각 체인 테스트의 timeout 설정:** `{ timeout: 30_000 }` (TOCTOU + 다중 DB 접근으로 느릴 수 있음)
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/boundary-chain/ --reporter=verbose` -- 24건(경계값 19 + E2E 5) 통과
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/ --reporter=verbose` -- 전체 71건 통과 (155-01의 29건 + 155-02의 42건)
  </verify>
  <done>
경계값 19건(금액 6 + 시간 8 + TOCTOU 3 + 세션 한도 2) + E2E 연쇄 공격 5건 = 24건이 모두 통과. Phase 155 전체 71건 보안 시나리오가 테스트로 증명된 상태.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/daemon/src/__tests__/security/ --reporter=verbose` -- 71건 전체 통과
2. 각 테스트 파일의 describe/it 블록이 SEC-03-NN / SEC-04-NN / SEC-05-XX ID와 매핑
3. 기존 테스트(`pnpm vitest run packages/daemon/`) 회귀 없음
4. 디렉토리 구조가 objectives/v1.7-quality-cicd.md의 구조 명세와 일치:
   - security/layer1-session/ (155-01)
   - security/layer2-policy/ (155-01)
   - security/layer3-killswitch/ (155-02)
   - security/keystore-external/ (155-02)
   - security/boundary-chain/ (155-02)
</verification>

<success_criteria>
- Kill Switch 공격 8건(SEC-03-01~08)이 모두 차단된다
- 키스토어+외부 보안 10건(SEC-04-01~06, EX-01~04)이 모두 방어된다
- 경계값 19건이 +/-1 lamport/초에서 정확한 동작을 보인다
- E2E 연쇄 공격 5건이 Layer 1-2-3 관통 방어를 증명한다
- 전체 71건 보안 시나리오가 pnpm test:security로 통과한다
- security/ 디렉토리 구조가 v1.7 명세와 일치한다
</success_criteria>

<output>
After completion, create `.planning/phases/155-security-test-p1/155-02-SUMMARY.md`
</output>
