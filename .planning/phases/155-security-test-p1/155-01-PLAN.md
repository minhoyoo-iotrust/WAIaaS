---
phase: 155-security-test-p1
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/security/layer1-session/session-auth-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/layer1-session/owner-auth-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/layer2-policy/policy-bypass-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/helpers/security-test-helpers.ts
autonomous: true
must_haves:
  truths:
    - "세션 인증 공격 12건(SEC-01-01~12)이 모두 적절한 에러 코드와 함께 거부된다"
    - "ownerAuth 공격 8건(SEC-01-OA-01~08)이 모두 서명 검증/nonce 검증에서 거부된다"
    - "정책 우회 공격 9건(SEC-02-01~09)이 모두 방어된다 (TOCTOU BEGIN IMMEDIATE 포함)"
    - "pnpm test:security 실행으로 layer1-session + layer2-policy 테스트가 모두 통과한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/security/layer1-session/session-auth-attacks.security.test.ts"
      provides: "SEC-01-01~12 세션 인증 공격 시나리오 12건"
      contains: "JWT forgery, expiry bypass, revoked session, cross-agent hijack, session constraints"
    - path: "packages/daemon/src/__tests__/security/layer1-session/owner-auth-attacks.security.test.ts"
      provides: "SEC-01-OA-01~08 ownerAuth 공격 시나리오 8건"
      contains: "payload parsing, timestamp, nonce replay, signature forgery, owner mismatch, action mismatch, domain binding, full replay"
    - path: "packages/daemon/src/__tests__/security/layer2-policy/policy-bypass-attacks.security.test.ts"
      provides: "SEC-02-01~09 정책 우회 공격 시나리오 9건"
      contains: "TOCTOU concurrent, tier boundary, whitelist case, time restriction, rate limit, delay cooldown, approval timeout, override, default"
    - path: "packages/daemon/src/__tests__/security/helpers/security-test-helpers.ts"
      provides: "보안 테스트 공통 헬퍼 (DB 시딩, 토큰 발급, 앱 생성)"
      exports: ["createSecurityTestApp", "seedSecurityTestData", "signTestToken", "createOwnerPayload"]
  key_links:
    - from: "session-auth-attacks.security.test.ts"
      to: "packages/daemon/src/api/middleware/session-auth.ts"
      via: "Hono app.request() with forged/expired/revoked tokens"
      pattern: "app\\.request.*Authorization"
    - from: "owner-auth-attacks.security.test.ts"
      to: "packages/daemon/src/api/middleware/owner-auth.ts"
      via: "Hono app.request() with crafted ownerSignaturePayload"
      pattern: "app\\.request.*owner"
    - from: "policy-bypass-attacks.security.test.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "DatabasePolicyEngine.evaluate() with boundary amounts + Promise.allSettled for TOCTOU"
      pattern: "evaluate|Promise\\.allSettled"
---

<objective>
세션 인증 공격 20건(SEC-01) + 정책 우회 공격 9건(SEC-02) = 29건 보안 시나리오 테스트 구현

Purpose: 설계 문서 43(Layer 1 세션 인증)과 44(Layer 2 정책 우회)의 공격 시나리오를 테스트 코드로 전환하여, 3계층 보안의 첫 2개 계층이 올바르게 방어됨을 증명한다.
Output: 3개 테스트 파일 + 1개 헬퍼 모듈 (packages/daemon/src/__tests__/security/)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.7-quality-cicd.md
@docs/v0.4/43-layer1-session-auth-attacks.md
@docs/v0.4/44-layer2-policy-bypass-attacks.md
@packages/daemon/src/api/middleware/session-auth.ts
@packages/daemon/src/api/middleware/owner-auth.ts
@packages/daemon/src/api/middleware/kill-switch-guard.ts
@packages/daemon/src/api/middleware/error-handler.ts
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/infrastructure/database/connection.ts
@packages/daemon/src/infrastructure/keystore/keystore.ts
@packages/daemon/src/__tests__/session-auth.test.ts
@packages/daemon/src/__tests__/database-policy-engine.test.ts
@packages/daemon/src/__tests__/kill-switch-service.test.ts
@packages/daemon/src/__tests__/autostop-service.test.ts
@packages/daemon/src/infrastructure/jwt/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 보안 테스트 헬퍼 + 세션 인증 공격 20건 (SEC-01)</name>
  <files>
    packages/daemon/src/__tests__/security/helpers/security-test-helpers.ts
    packages/daemon/src/__tests__/security/layer1-session/session-auth-attacks.security.test.ts
    packages/daemon/src/__tests__/security/layer1-session/owner-auth-attacks.security.test.ts
  </files>
  <action>
**Step 1: 보안 테스트 공통 헬퍼 생성** (`security-test-helpers.ts`)

기존 `session-auth.test.ts`의 패턴을 참고하여 보안 테스트 전용 헬퍼를 생성한다:
- `createSecurityTestApp()`: Hono 앱 + errorHandler + sessionAuth + ownerAuth + kill-switch-guard 미들웨어 체인이 포함된 테스트 앱. 보호 경로(/v1/wallet/balance 등)와 ownerAuth 경로(/v1/owner/approve 등) 포함
- `seedSecurityTestData(sqlite, opts)`: wallets, sessions, policies, key_value_store 테이블에 테스트 데이터 시딩. opts로 revokedAt, walletId, constraints 등 제어
- `signTestToken(jwtManager, overrides)`: JwtPayload를 받아 wai_sess_ 접두사 토큰 생성
- `createOwnerPayload(signer, opts)`: FakeOwnerSigner로 ownerSignaturePayload base64url 생성 (action, nonce, timestamp 포함)
- `createInMemoryDb()`: in-memory SQLite + pushSchema + key_value_store 초기화

기존 `session-auth.test.ts`의 createTestApp/seedTestData 패턴을 따르되, 더 풍부한 시딩(정책, constraints)을 지원한다. `createDatabase(':memory:')` + `pushSchema()` 사용.

**Step 2: SEC-01-01~12 세션 인증 공격 테스트** (`session-auth-attacks.security.test.ts`)

설계 문서 43의 Given-When-Then을 그대로 테스트로 변환한다. 각 describe 블록이 하나의 SEC-01-NN에 대응한다:

- **SEC-01-01 JWT 서명 위조**: jose.SignJWT로 다른 secret("attacker-secret-32bytes")으로 서명한 JWT를 wai_sess_ 접두사 붙여 요청. 401 + code: INVALID_TOKEN 확인
- **SEC-01-02 JWT 만료 우회**: vi.useFakeTimers()로 시간 제어. 만료 시각 정확히/+1초에서 TOKEN_EXPIRED 확인. (주의: jose의 exp 검증은 currentDate 옵션 사용 -- JwtSecretManager.verify가 clockTolerance를 어떻게 설정하는지 확인)
- **SEC-01-03 폐기된 세션**: seedSecurityTestData에서 revokedAt 설정. JWT 유효하지만 DB에서 SESSION_REVOKED
- **SEC-01-04 타 에이전트 세션 탈취**: 2개 wallet 시딩. wallet-A 토큰으로 wallet-B 리소스 접근 시 격리 확인 (walletId 필터 강제)
- **SEC-01-05 단건 한도 초과**: validateSessionConstraints 직접 호출. maxAmountPerTx 경계값 (limit-1, limit, limit+1) BigInt 비교
- **SEC-01-06 누적 한도 초과**: maxTotalAmount + usageStats BigInt 누적 비교
- **SEC-01-07 거래 횟수 초과**: maxTransactions >= 비교 (totalTx=9 허용, totalTx=10 거부)
- **SEC-01-08 허용 작업**: allowedOperations 배열 포함 검사 (BALANCE_CHECK만 허용 시 TRANSFER 거부)
- **SEC-01-09 허용 주소**: allowedDestinations 화이트리스트 (대소문자 구분 -- Solana Base58)
- **SEC-01-10 Nonce Replay**: createNonce() -> verifyAndConsumeNonce 1차 true, 2차 false. TTL 5분 경계 FakeClock 사용
- **SEC-01-11 토큰 접두사 변조**: wai_sess_ 없는 JWT, 잘못된 접두사(wai_live_), Bearer 없는 경우 모두 401
- **SEC-01-12 Authorization 헤더 누락**: 헤더 없음, 빈 헤더, "Bearer " 만 있는 경우 401

추가로 **섹션 4 인증 제외 경로 검증**: /health(200), /doc(200), /v1/nonce(200) 인증 없이 통과, /v1/wallet/balance(401), /v1/transactions(401) 인증 필수.

**Step 3: SEC-01-OA-01~08 ownerAuth 공격 벡터** (`owner-auth-attacks.security.test.ts`)

- **OA-01 페이로드 파싱 오류**: 잘못된 base64url 인코딩, 깨진 JSON
- **OA-02 timestamp 유효성**: FakeClock으로 서명 시각 5분+1초 검증. 4분59초 통과, 5분 거부
- **OA-03 nonce 재사용**: 동일 nonce 2회 사용 -> 2차 INVALID_NONCE
- **OA-04 서명 위조**: 다른 키쌍(seed 0xFF*32)으로 서명 -> INVALID_SIGNATURE
- **OA-05 Owner 주소 불일치**: DB에 등록되지 않은 주소로 서명 -> OWNER_MISMATCH 또는 OWNER_NOT_FOUND
- **OA-06 action 불일치**: approve_tx action 서명으로 /v1/owner/kill-switch 접근 시도
- **OA-07 도메인 바인딩**: SIWS 메시지 domain이 localhost:3100이 아닌 값
- **OA-08 전체 Replay**: 동일 ownerSignaturePayload 재전송 -> nonce 소비 후 2차 거부

ownerAuth 미들웨어가 어떤 식으로 export되는지 확인하고, FakeOwnerSigner가 사용 가능하면 활용한다. 없으면 tweetnacl/sodium-native로 테스트용 Ed25519 키쌍을 직접 생성한다.

**주의사항:**
- 기존 session-auth.test.ts와 중복되지 않도록 주의. 기존 테스트가 커버하는 기본 동작(401 INVALID_TOKEN 등)과 보안 테스트의 차이점은 "공격자 관점"과 "경계값 정밀도"이다
- Vitest 4 문법: describe, it, expect, beforeEach, afterEach, vi 사용
- 파일명 패턴: `*.security.test.ts` (pnpm test:security에서 필터 가능)
- 각 테스트 it() 블록에 SEC-01-NN ID를 주석으로 명시
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/layer1-session/ --reporter=verbose` 실행하여 20건(12 session + 8 ownerAuth) 테스트 모두 통과 확인
  </verify>
  <done>
SEC-01-01~12(세션 인증 12건) + SEC-01-OA-01~08(ownerAuth 8건) = 20건 공격 시나리오가 모두 적절한 에러 코드로 거부됨이 테스트로 증명된 상태. 인증 제외 경로 검증도 포함.
  </done>
</task>

<task type="auto">
  <name>Task 2: 정책 우회 공격 9건 (SEC-02)</name>
  <files>
    packages/daemon/src/__tests__/security/layer2-policy/policy-bypass-attacks.security.test.ts
  </files>
  <action>
설계 문서 44의 Given-When-Then을 테스트로 변환한다. 각 describe 블록이 SEC-02-NN에 대응한다:

**SEC-02-01 TOCTOU 동시 거래 한도 초과** (Critical, Integration 레벨):
- 실제 SQLite DB (in-memory도 WAL 모드가 아니므로 tmpdir 사용). `createDatabase(path)` + pushSchema()
- MockChainAdapter를 사용하여 블록체인 응답을 mock (submitTransaction -> canned txHash)
- 세션 constraints: maxTotalAmount = 10 SOL ("10000000000"), 현재 usageStats totalAmount = 8 SOL
- `Promise.allSettled`로 2개 동시 전송 요청 (각 3 SOL)
- 정확히 1개 fulfilled + 1개 rejected (POLICY_LIMIT_EXCEEDED) 확인
- BEGIN IMMEDIATE 직렬화로 reserved_amount 경합 방어 확인
- **주의:** 단일 스레드 이벤트 루프에서 Promise.allSettled가 실질적 동시성을 만들려면 MockChainAdapter에 약간의 지연(setTimeout)을 넣어야 할 수 있다. 또는 파이프라인 내부의 DB 트랜잭션 단계에서 직렬화를 검증한다.

**SEC-02-02 금액 티어 경계값 조작** (High, Unit):
- DatabasePolicyEngine 또는 evaluateSpendingLimit 직접 호출
- SPENDING_LIMIT 정책: instant_max=1SOL, notify_max=10SOL, delay_max=50SOL
- 경계값 3쌍: 999999999/1000000000/1000000001 (INSTANT/NOTIFY), 9999999999/10000000000/10000000001 (NOTIFY/DELAY), 49999999999/50000000000/50000000001 (DELAY/APPROVAL)
- 모든 비교가 BigInt로 수행됨 확인

**SEC-02-03 WHITELIST 대소문자 우회** (High, Unit):
- EVM 주소: 체크섬 등록("0xAbCdEf...") vs 소문자 요청("0xabcdef...") -> toLowerCase 정규화로 허용
- Solana Base58: 대소문자 변경 시 다른 주소로 판정 -> 거부
- 등록되지 않은 주소 -> 거부

**SEC-02-04 TIME_RESTRICTION 우회** (High, Unit):
- vi.useFakeTimers() 또는 IClock DI로 시간 제어
- allowed_hours: {start:9, end:18}. 17:59:59 허용, 18:00:00 거부

**SEC-02-05 RATE_LIMIT 시간 윈도우 경계** (High, Unit):
- max_tx_per_hour=10, 9건 기존 거래 후 10번째 허용, 11번째 거부
- 1시간 경과 후 윈도우 리셋 확인

**SEC-02-06 DELAY 쿨다운 조기 실행** (High, Unit):
- DelayQueueWorker.poll() 또는 해당 로직 직접 호출
- expiresAt = now + 900초. 899초(실행 안됨), 900초(실행됨) 경계 확인

**SEC-02-07 APPROVAL 타임아웃 후 승인** (High, Unit):
- APPROVAL 거래 expiresAt = now + 3600초
- 3599초(승인 성공), 3601초(만료 후 승인 거부 TX_APPROVAL_TIMEOUT)

**SEC-02-08 정책 에이전트별 오버라이드 우회** (Medium, Unit):
- 글로벌 SPENDING_LIMIT instant_max=10SOL + 지갑별 instant_max=5SOL
- 7 SOL 요청 시 지갑별 정책 적용 -> NOTIFY 티어
- 지갑별 정책 없는 wallet은 글로벌 적용 -> INSTANT 티어

**SEC-02-09 정책 미설정 기본 동작** (Medium, Unit):
- policies 테이블 빈 상태에서 100 SOL 요청 -> INSTANT 반환 (passthrough)

**추가: 정책 평가 순서 검증 (DENY 우선)**:
- WHITELIST 거부 + TIME_RESTRICTION 거부 동시 설정 시 WHITELIST가 먼저 DENY
- 반환된 policyId가 WHITELIST 정책의 것인지 확인

**주의사항:**
- DatabasePolicyEngine의 실제 인터페이스를 확인한다. `evaluate()` 메서드의 시그니처, 반환 타입(PolicyDecision) 참고
- SEC-02-01 TOCTOU는 실제 SQLite가 필요하므로 tmpdir 사용. 나머지는 in-memory SQLite 또는 직접 함수 호출
- vi.useFakeTimers() 대신 IClock DI가 사용 가능하면 DI 패턴을 따른다. 기존 테스트 코드에서 시간 제어 패턴 확인 필요
- 기존 `database-policy-engine.test.ts`의 setup 패턴을 참고하되, 보안 관점의 경계값과 우회 시도에 집중
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/layer2-policy/ --reporter=verbose` 실행하여 9건 테스트 모두 통과 확인
  </verify>
  <done>
SEC-02-01~09(정책 우회 9건)이 모두 방어됨이 테스트로 증명된 상태. TOCTOU BEGIN IMMEDIATE 직렬화, 금액 BigInt 경계값, 시간 경계값 모두 포함.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/layer1-session/ packages/daemon/src/__tests__/security/layer2-policy/ --reporter=verbose` -- 29건 전체 통과
2. 각 테스트 파일의 describe/it 블록이 SEC-01-NN / SEC-01-OA-NN / SEC-02-NN ID와 1:1 매핑
3. 기존 테스트(`pnpm vitest run packages/daemon/`) 회귀 없음
</verification>

<success_criteria>
- 세션 인증 공격 12건(SEC-01-01~12)이 적절한 HTTP 상태 코드 + 에러 코드로 거부된다
- ownerAuth 공격 8건(SEC-01-OA-01~08)이 모두 방어된다
- 정책 우회 공격 9건(SEC-02-01~09)이 모두 방어된다 (TOCTOU + 경계값 + 시간)
- 인증 제외 경로(/health, /doc, /v1/nonce)가 인증 없이 접근 가능하다
- 보안 테스트 공통 헬퍼가 155-02에서도 재사용 가능하다
</success_criteria>

<output>
After completion, create `.planning/phases/155-security-test-p1/155-01-SUMMARY.md`
</output>
