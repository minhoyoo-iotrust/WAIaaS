---
phase: 76-infra-pipeline-foundation
plan: 03
type: execute
wave: 2
depends_on: ["76-01", "76-02"]
files_modified:
  - packages/core/src/interfaces/IChainAdapter.ts
  - packages/core/src/interfaces/chain-adapter.types.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/index.ts
  - packages/core/src/schemas/policy.schema.ts
  - packages/adapters/solana/src/adapter.ts
  - packages/core/src/__tests__/chain-adapter-interface.test.ts
  - packages/core/src/__tests__/policy-superrefine.test.ts
autonomous: true

must_haves:
  truths:
    - "IChainAdapter 인터페이스에 20개 메서드가 선언되어 있다 (기존 11 + 신규 9)"
    - "SolanaAdapter가 20개 메서드를 모두 구현한다 (신규 9개는 throw 'Not implemented' 스텁)"
    - "6개 신규 PolicyType의 정책 생성 시 Zod superRefine이 type별 rules 스키마를 검증한다"
    - "기존 4개 PolicyType(SPENDING_LIMIT/WHITELIST/TIME_RESTRICTION/RATE_LIMIT)의 rules는 기존 자유 형식 유지"
  artifacts:
    - path: "packages/core/src/interfaces/IChainAdapter.ts"
      provides: "IChainAdapter 20 메서드 인터페이스"
      contains: "estimateFee|buildTokenTransfer|buildContractCall|buildApprove|buildBatch|getTransactionFee|getTokenInfo|getCurrentNonce|sweepAll"
    - path: "packages/core/src/interfaces/chain-adapter.types.ts"
      provides: "신규 타입: TokenTransferRequest, ContractCallRequest, ApproveRequest, BatchRequest, FeeEstimate, TokenInfo, SweepResult"
      exports: ["FeeEstimate", "TokenInfo", "SweepResult"]
    - path: "packages/core/src/schemas/policy.schema.ts"
      provides: "CreatePolicyRequestSchema에 superRefine 검증 추가"
      contains: "superRefine"
    - path: "packages/adapters/solana/src/adapter.ts"
      provides: "SolanaAdapter 20 메서드 (11 구현 + 9 스텁)"
      contains: "estimateFee|buildTokenTransfer|buildContractCall|buildApprove|buildBatch"
    - path: "packages/core/src/__tests__/policy-superrefine.test.ts"
      provides: "6개 PolicyType rules 검증 테스트"
      min_lines: 80
  key_links:
    - from: "packages/core/src/interfaces/IChainAdapter.ts"
      to: "packages/core/src/interfaces/chain-adapter.types.ts"
      via: "타입 import (FeeEstimate, TokenInfo, SweepResult 등)"
      pattern: "import.*chain-adapter.types"
    - from: "packages/adapters/solana/src/adapter.ts"
      to: "packages/core/src/interfaces/IChainAdapter.ts"
      via: "implements IChainAdapter"
      pattern: "implements IChainAdapter"
    - from: "packages/core/src/schemas/policy.schema.ts"
      to: "packages/core/src/enums/policy.ts"
      via: "PolicyTypeEnum import for superRefine switch"
      pattern: "PolicyTypeEnum|superRefine"
---

<objective>
IChainAdapter 인터페이스를 11에서 20 메서드로 확장하고 SolanaAdapter에 스텁을 추가하며, 6개 신규 PolicyType의 Zod superRefine 검증을 구현한다.

Purpose: v1.4의 토큰 전송/컨트랙트 호출/Approve/배치 기능이 모두 IChainAdapter의 신규 메서드(buildTokenTransfer, buildContractCall, buildApprove, buildBatch 등)에 의존한다. 또한 6개 신규 PolicyType(ALLOWED_TOKENS~APPROVE_TIER_OVERRIDE)의 정책 생성 시 rules 스키마를 검증해야 잘못된 정책 생성을 방지한다.
Output: IChainAdapter 20 메서드 인터페이스, SolanaAdapter 스텁, 6개 PolicyType superRefine, 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/schemas/policy.schema.ts
@packages/core/src/enums/policy.ts
@packages/adapters/solana/src/adapter.ts
@packages/core/src/index.ts
@objectives/v1.4-token-contract-extension.md

# Prior plan SUMMARYs needed for types created in 76-01 and 76-02
@.planning/phases/76-infra-pipeline-foundation/76-01-SUMMARY.md
@.planning/phases/76-infra-pipeline-foundation/76-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: IChainAdapter 20 메서드 확장 + chain-adapter.types 신규 타입 + SolanaAdapter 스텁</name>
  <files>
    packages/core/src/interfaces/chain-adapter.types.ts
    packages/core/src/interfaces/IChainAdapter.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/index.ts
    packages/adapters/solana/src/adapter.ts
    packages/core/src/__tests__/chain-adapter-interface.test.ts
  </files>
  <action>
**1. chain-adapter.types.ts에 신규 타입 추가:**

```typescript
/** Fee estimation result. */
export interface FeeEstimate {
  /** Estimated fee in smallest unit (lamports/wei). */
  fee: bigint;
  /** Whether an ATA needs to be created (Solana SPL). */
  needsAtaCreation?: boolean;
  /** ATA creation rent cost (Solana SPL). */
  ataRentCost?: bigint;
  /** Breakdown details. */
  details?: Record<string, unknown>;
}

/** Token information. */
export interface TokenInfo {
  /** Token address (mint for Solana, contract for EVM). */
  address: string;
  /** Token symbol. */
  symbol: string;
  /** Token name. */
  name: string;
  /** Decimal places. */
  decimals: number;
  /** Total supply if available. */
  totalSupply?: bigint;
  /** Token program (Solana: Token or Token-2022). */
  programId?: string;
}

/** Sweep result (multi-asset withdrawal). */
export interface SweepResult {
  /** Total number of assets swept. */
  total: number;
  /** Number of successful sweeps. */
  succeeded: number;
  /** Number of failed sweeps. */
  failed: number;
  /** Individual sweep results. */
  results: Array<{
    mint: string;
    txHash?: string;
    error?: string;
    amount: bigint;
  }>;
}

/** Token transfer request for buildTokenTransfer(). */
export interface TokenTransferParams {
  from: string;
  to: string;
  amount: bigint;
  token: { address: string; decimals: number; symbol: string };
  memo?: string;
}

/** Contract call request for buildContractCall(). */
export interface ContractCallParams {
  from: string;
  to: string;  // contract address
  // EVM
  calldata?: string;  // hex-encoded
  abi?: Record<string, unknown>[];
  value?: bigint;
  // Solana
  programId?: string;
  instructionData?: Uint8Array;
  accounts?: Array<{ pubkey: string; isSigner: boolean; isWritable: boolean }>;
}

/** Approve request for buildApprove(). */
export interface ApproveParams {
  from: string;
  spender: string;
  token: { address: string; decimals: number; symbol: string };
  amount: bigint;
}

/** Batch request for buildBatch(). */
export interface BatchParams {
  from: string;
  instructions: Array<TransferRequest | TokenTransferParams | ContractCallParams | ApproveParams>;
}
```

**2. IChainAdapter.ts에 9개 메서드 선언 추가:**

기존 주석 처리된 v1.4 planned methods를 실제 메서드 선언으로 교체:

```typescript
// -- Fee estimation (1) --
/** Estimate fee for a transfer or token transfer. */
estimateFee(request: TransferRequest | TokenTransferParams): Promise<FeeEstimate>;

// -- Token operations (2) --
/** Build token transfer transaction (SPL/ERC-20). */
buildTokenTransfer(request: TokenTransferParams): Promise<UnsignedTransaction>;
/** Get token info by address. */
getTokenInfo(tokenAddress: string): Promise<TokenInfo>;

// -- Contract operations (2) --
/** Build contract call transaction. */
buildContractCall(request: ContractCallParams): Promise<UnsignedTransaction>;
/** Build approve transaction. */
buildApprove(request: ApproveParams): Promise<UnsignedTransaction>;

// -- Batch operations (1) --
/** Build batch transaction (Solana only). Throws BATCH_NOT_SUPPORTED on EVM. */
buildBatch(request: BatchParams): Promise<UnsignedTransaction>;

// -- Utility operations (3) --
/** Get transaction fee from a built transaction. */
getTransactionFee(tx: UnsignedTransaction): Promise<bigint>;
/** Get current nonce for an address (EVM). Returns 0 for Solana. */
getCurrentNonce(address: string): Promise<number>;
/** Sweep all assets from one address to another. */
sweepAll(from: string, to: string, privateKey: Uint8Array): Promise<SweepResult>;
```

**3. interfaces/index.ts에 신규 타입 export 추가:**
FeeEstimate, TokenInfo, SweepResult, TokenTransferParams, ContractCallParams, ApproveParams, BatchParams

**4. core/src/index.ts에 신규 타입 export 추가.**

**5. SolanaAdapter에 9개 메서드 스텁 추가:**

`packages/adapters/solana/src/adapter.ts`에 9개 신규 메서드를 추가한다. 모든 신규 메서드는 `throw new Error('Not implemented: method will be implemented in Phase 78/79/80')` 스텁으로 시작. 이는 타입 검사를 통과하게 하면서 실제 구현은 후속 phase에서 진행.

**6. 인터페이스 검증 테스트:**

`packages/core/src/__tests__/chain-adapter-interface.test.ts` 신규 생성:
- IChainAdapter 인터페이스가 20개 메서드를 가지는지 타입 레벨 검증 (타입 체크만으로 충분하지만, 메서드 이름 목록을 테스트에 문서화)
- SolanaAdapter가 IChainAdapter를 implements하여 타입 에러 없이 인스턴스화되는지 확인 (빌드 성공이 곧 검증이지만 명시적 테스트로 문서화)
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo build` -- 모노레포 전체 빌드 성공 (SolanaAdapter가 IChainAdapter 20 메서드 모두 구현 확인)
`pnpm --filter @waiaas/core test` -- core 패키지 테스트 통과
`pnpm --filter @waiaas/adapter-solana test` -- adapter-solana 패키지 테스트 통과
  </verify>
  <done>
- IChainAdapter에 20개 메서드 선언 (기존 11 + 신규 9)
- chain-adapter.types.ts에 FeeEstimate, TokenInfo, SweepResult, TokenTransferParams, ContractCallParams, ApproveParams, BatchParams 타입 정의
- SolanaAdapter에 9개 스텁 메서드 추가, IChainAdapter 타입 에러 없음
- 전체 모노레포 빌드 성공
  </done>
</task>

<task type="auto">
  <name>Task 2: 6개 PolicyType superRefine 검증 구현 + 테스트</name>
  <files>
    packages/core/src/schemas/policy.schema.ts
    packages/core/src/__tests__/policy-superrefine.test.ts
  </files>
  <action>
**CreatePolicyRequestSchema에 .superRefine() 추가:**

`packages/core/src/schemas/policy.schema.ts`의 CreatePolicyRequestSchema에 `.superRefine()` 체이닝으로 type별 rules 검증을 추가한다.

6개 신규 PolicyType별 rules 스키마:

```typescript
// ALLOWED_TOKENS: rules.tokens 배열 (mint/contract 주소)
const AllowedTokensRulesSchema = z.object({
  tokens: z.array(z.object({
    address: z.string().min(1),
    symbol: z.string().min(1).max(10).optional(),
    chain: ChainTypeEnum.optional(),
  })).min(1, 'At least one token required'),
});

// CONTRACT_WHITELIST: rules.contracts 배열
const ContractWhitelistRulesSchema = z.object({
  contracts: z.array(z.object({
    address: z.string().min(1),
    name: z.string().optional(),
    chain: ChainTypeEnum.optional(),
  })).min(1, 'At least one contract required'),
});

// METHOD_WHITELIST: rules.methods 배열 (contract별 허용 메서드)
const MethodWhitelistRulesSchema = z.object({
  methods: z.array(z.object({
    contractAddress: z.string().min(1),
    selectors: z.array(z.string().min(1)).min(1),  // 4-byte hex selectors (EVM) or method names
  })).min(1, 'At least one method entry required'),
});

// APPROVED_SPENDERS: rules.spenders 배열
const ApprovedSpendersRulesSchema = z.object({
  spenders: z.array(z.object({
    address: z.string().min(1),
    name: z.string().optional(),
    maxAmount: z.string().regex(/^\d+$/).optional(),  // 최대 승인 금액
  })).min(1, 'At least one spender required'),
});

// APPROVE_AMOUNT_LIMIT: rules.maxAmount + rules.blockUnlimited
const ApproveAmountLimitRulesSchema = z.object({
  maxAmount: z.string().regex(/^\d+$/).optional(),
  blockUnlimited: z.boolean().default(true),  // 무제한 approve 차단 (기본 true)
});

// APPROVE_TIER_OVERRIDE: rules.tier (강제 적용 티어)
const ApproveTierOverrideRulesSchema = z.object({
  tier: PolicyTierEnum,  // APPROVAL tier를 기본 강제
});
```

superRefine 로직:
```typescript
export const CreatePolicyRequestSchema = z.object({
  agentId: z.string().uuid().optional(),
  type: PolicyTypeEnum,
  rules: z.record(z.unknown()),
  priority: z.number().int().default(0),
  enabled: z.boolean().default(true),
}).superRefine((data, ctx) => {
  switch (data.type) {
    case 'ALLOWED_TOKENS': {
      const result = AllowedTokensRulesSchema.safeParse(data.rules);
      if (!result.success) {
        result.error.issues.forEach(issue => ctx.addIssue({ ...issue, path: ['rules', ...issue.path] }));
      }
      break;
    }
    case 'CONTRACT_WHITELIST': { ... }
    case 'METHOD_WHITELIST': { ... }
    case 'APPROVED_SPENDERS': { ... }
    case 'APPROVE_AMOUNT_LIMIT': { ... }
    case 'APPROVE_TIER_OVERRIDE': { ... }
    // 기존 4개 타입 (SPENDING_LIMIT, WHITELIST, TIME_RESTRICTION, RATE_LIMIT)은
    // 기존 자유 형식 유지 (superRefine 미적용, 기존 동작 보존)
    default:
      break;
  }
});
```

NOTE: 6개 신규 rules 스키마는 policy.schema.ts 내에 module-level const로 정의한다 (export하지 않음 -- 내부 검증 전용). 향후 재사용 필요 시 export 가능.

**테스트** -- `packages/core/src/__tests__/policy-superrefine.test.ts` 신규 생성:

1. ALLOWED_TOKENS 유효한 rules → 성공
2. ALLOWED_TOKENS 빈 tokens 배열 → ZodError (min 1)
3. ALLOWED_TOKENS tokens 없음 → ZodError
4. CONTRACT_WHITELIST 유효한 rules → 성공
5. CONTRACT_WHITELIST contracts 빈 배열 → ZodError
6. METHOD_WHITELIST 유효한 rules → 성공
7. METHOD_WHITELIST selectors 빈 배열 → ZodError
8. APPROVED_SPENDERS 유효한 rules → 성공
9. APPROVED_SPENDERS spenders 없음 → ZodError
10. APPROVE_AMOUNT_LIMIT blockUnlimited 기본값 true 확인
11. APPROVE_TIER_OVERRIDE 유효한 tier → 성공
12. APPROVE_TIER_OVERRIDE 잘못된 tier → ZodError
13. 기존 SPENDING_LIMIT rules 자유 형식 → 여전히 성공 (하위 호환)
14. 기존 WHITELIST rules 자유 형식 → 여전히 성공 (하위 호환)
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core test` -- core 패키지 전체 테스트 통과 (기존 테스트 + superRefine 테스트)
`pnpm turbo build` -- 모노레포 전체 빌드 성공

추가 검증:
- 기존 정책 생성 API 테스트가 깨지지 않는지 확인: `pnpm --filter @waiaas/daemon test -- policy`
  </verify>
  <done>
- 6개 신규 PolicyType의 superRefine이 type별 rules 스키마를 검증
- 기존 4개 PolicyType(SPENDING_LIMIT/WHITELIST/TIME_RESTRICTION/RATE_LIMIT)은 기존 자유 형식 유지
- policy-superrefine.test.ts에 14건 이상 테스트 통과
- 기존 daemon 정책 테스트 깨지지 않음
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` -- 모노레포 전체 빌드 성공 (IChainAdapter 20 메서드 + SolanaAdapter 스텁)
2. `pnpm --filter @waiaas/core test` -- core 패키지 전체 테스트 통과
3. `pnpm --filter @waiaas/adapter-solana test` -- adapter-solana 테스트 통과
4. `pnpm --filter @waiaas/daemon test` -- daemon 테스트 통과 (기존 정책 테스트 포함)
5. IChainAdapter가 20개 메서드를 선언하고 SolanaAdapter가 모두 구현 (스텁 포함)
6. CreatePolicyRequestSchema.safeParse()로 6개 신규 타입 rules 검증 동작 확인
</verification>

<success_criteria>
- IChainAdapter에 20개 메서드 선언 완료
- SolanaAdapter가 20개 메서드 구현 (신규 9개는 스텁)
- 6개 PolicyType superRefine이 type별 rules 검증
- 기존 4개 PolicyType 하위 호환 유지
- 전체 모노레포 빌드 + 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/76-infra-pipeline-foundation/76-03-SUMMARY.md`
</output>
