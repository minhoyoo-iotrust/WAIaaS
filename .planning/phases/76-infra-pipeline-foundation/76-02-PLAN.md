---
phase: 76-infra-pipeline-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/__tests__/migration-runner.test.ts
  - packages/core/src/schemas/transaction.schema.ts
  - packages/core/src/schemas/index.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/schemas.test.ts
autonomous: true

must_haves:
  truths:
    - "DB 마이그레이션 러너가 schema_version 기반으로 증분 마이그레이션을 순차 실행한다"
    - "이미 적용된 버전은 건너뛰고, 새로운 버전만 실행한다"
    - "마이그레이션 실패 시 해당 마이그레이션이 롤백되고 이후 마이그레이션은 실행되지 않는다"
    - "discriminatedUnion 스키마가 5-type(TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH)을 type 필드로 식별한다"
    - "기존 SendTransactionRequestSchema는 유지되되 TransactionRequestSchema(discriminatedUnion)가 추가된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "runMigrations() 함수 + Migration 인터페이스 + MIGRATIONS 배열"
      exports: ["runMigrations", "Migration", "MIGRATIONS"]
    - path: "packages/daemon/src/__tests__/migration-runner.test.ts"
      provides: "마이그레이션 러너 테스트: 순차 실행, 건너뛰기, 실패 롤백"
      min_lines: 60
    - path: "packages/core/src/schemas/transaction.schema.ts"
      provides: "TransactionRequestSchema (z.discriminatedUnion) + 5개 타입별 스키마"
      exports: ["TransactionRequestSchema", "TransferRequestSchema", "TokenTransferRequestSchema", "ContractCallRequestSchema", "ApproveRequestSchema", "BatchRequestSchema"]
    - path: "packages/core/src/__tests__/schemas.test.ts"
      provides: "discriminatedUnion 5-type 파싱 테스트"
      contains: "discriminatedUnion"
  key_links:
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "schema_version 테이블"
      via: "SELECT max(version) + INSERT version"
      pattern: "schema_version"
    - from: "packages/core/src/schemas/transaction.schema.ts"
      to: "packages/core/src/enums/transaction.ts"
      via: "TransactionTypeEnum import"
      pattern: "TransactionTypeEnum"
---

<objective>
DB 마이그레이션 러너를 구현하고, discriminatedUnion 5-type 트랜잭션 요청 스키마를 정의한다.

Purpose: v1.4부터 DB 스키마 변경 시 ALTER TABLE 증분 마이그레이션이 필수(MIG-01~06 정책). 현재 schema_version 테이블은 존재하나 마이그레이션 러너가 없다. 또한 현재 SendTransactionRequestSchema는 기본 transfer만 지원하므로, 5-type discriminatedUnion으로 확장해야 Stage 1에서 type별 분기가 가능하다.
Output: runMigrations() 함수, 5-type discriminatedUnion 스키마, 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/__tests__/database.test.ts
@packages/core/src/schemas/transaction.schema.ts
@packages/core/src/schemas/index.ts
@packages/core/src/enums/transaction.ts
@packages/core/src/index.ts
@objectives/v1.4-token-contract-extension.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB 마이그레이션 러너 구현 + 테스트</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/__tests__/migration-runner.test.ts
  </files>
  <action>
**마이그레이션 러너 구현** -- `packages/daemon/src/infrastructure/database/migrate.ts` 에 추가:

기존 `pushSchema()` 함수는 그대로 유지 (초기 스키마 생성용). 동일 파일에 마이그레이션 러너를 추가한다.

1. `Migration` 인터페이스 정의:
```typescript
export interface Migration {
  version: number;
  description: string;
  up: (sqlite: Database) => void;  // ALTER TABLE 등 DDL
}
```

2. `MIGRATIONS` 배열 정의 (현재는 비어 있음 -- v1.4에서 실제 마이그레이션 추가 예정):
```typescript
export const MIGRATIONS: Migration[] = [];
// v1.4 마이그레이션은 향후 phase에서 추가
```

3. `runMigrations(sqlite: Database): { applied: number; skipped: number }` 함수:
   - `SELECT MAX(version) FROM schema_version`으로 현재 버전 조회 (없으면 0 아닌 1 -- pushSchema가 version 1을 이미 삽입)
   - MIGRATIONS 배열을 version 오름차순으로 순회
   - 현재 버전보다 높은 migration만 실행
   - 각 마이그레이션을 개별 트랜잭션(BEGIN/COMMIT)으로 실행
   - 성공 시 schema_version에 INSERT (version, applied_at, description)
   - 실패 시 ROLLBACK하고 에러 throw (이후 마이그레이션은 실행하지 않음)
   - `{ applied: N, skipped: M }` 반환

4. `pushSchema()` 끝에서 `runMigrations()` 호출하도록 수정:
```typescript
export function pushSchema(sqlite: Database): void {
  // ... 기존 CREATE TABLE IF NOT EXISTS + indexes ...
  // ... schema_version version 1 insert ...

  // Run incremental migrations
  runMigrations(sqlite);
}
```

**마이그레이션 러너 테스트** -- `packages/daemon/src/__tests__/migration-runner.test.ts` 신규:

1. 빈 MIGRATIONS 배열로 runMigrations 호출 → `{ applied: 0, skipped: 0 }` 반환
2. version 2, 3 마이그레이션 2개를 테스트 전용 배열로 직접 실행:
   - 초기 상태 (version 1만 존재) → version 2, 3 순차 실행 → applied=2
   - 다시 실행 → applied=0, skipped=2 (이미 적용)
3. version 2 실패 케이스: up()에서 에러 throw → version 2 미적용, schema_version에 2 미삽입
4. 마이그레이션 순서 보장: version 3이 version 2보다 먼저 오지 않음 확인

테스트에서는 MIGRATIONS 배열을 직접 인자로 전달하거나, 별도의 `runMigrationsWithList(sqlite, migrations)` 내부 함수를 테스트 가능하게 export한다. (실제 MIGRATIONS 전역 배열은 pushSchema에서 사용.)
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- migration-runner` 실행하여 마이그레이션 러너 테스트 통과.
`pnpm --filter @waiaas/daemon test -- database` 실행하여 기존 database.test.ts도 통과 확인.
  </verify>
  <done>
- runMigrations() 함수가 schema_version 기반 증분 마이그레이션 순차 실행
- 이미 적용된 버전 건너뛰기 동작
- 실패 시 롤백 + 이후 마이그레이션 중단
- pushSchema() 호출 시 자동으로 마이그레이션 실행
- 테스트 4건 이상 통과
  </done>
</task>

<task type="auto">
  <name>Task 2: discriminatedUnion 5-type 트랜잭션 요청 스키마 정의 + 테스트</name>
  <files>
    packages/core/src/schemas/transaction.schema.ts
    packages/core/src/schemas/index.ts
    packages/core/src/index.ts
    packages/core/src/__tests__/schemas.test.ts
  </files>
  <action>
**discriminatedUnion 스키마 정의** -- `packages/core/src/schemas/transaction.schema.ts` 에 추가 (기존 SendTransactionRequestSchema는 하위 호환성을 위해 유지):

1. 5개 타입별 요청 스키마 정의:

```typescript
// Type 1: TRANSFER (기존 SendTransactionRequestSchema 확장)
export const TransferRequestSchema = z.object({
  type: z.literal('TRANSFER'),
  to: z.string().min(1),
  amount: z.string().regex(/^\d+$/, 'amount must be a numeric string (lamports/wei)'),
  memo: z.string().max(256).optional(),
});

// Type 2: TOKEN_TRANSFER
export const TokenTransferRequestSchema = z.object({
  type: z.literal('TOKEN_TRANSFER'),
  to: z.string().min(1),
  amount: z.string().regex(/^\d+$/, 'amount must be a numeric string'),
  token: z.object({
    address: z.string().min(1),  // mint address (SPL) or contract address (ERC-20)
    decimals: z.number().int().min(0).max(18),
    symbol: z.string().min(1).max(10),
  }),
  memo: z.string().max(256).optional(),
});

// Type 3: CONTRACT_CALL
export const ContractCallRequestSchema = z.object({
  type: z.literal('CONTRACT_CALL'),
  to: z.string().min(1),  // 컨트랙트 주소
  // EVM fields
  calldata: z.string().optional(),  // hex-encoded calldata
  abi: z.array(z.record(z.unknown())).optional(),  // ABI fragment
  value: z.string().regex(/^\d+$/).optional(),  // native token value
  // Solana fields
  programId: z.string().optional(),
  instructionData: z.string().optional(),  // base64-encoded
  accounts: z.array(z.object({
    pubkey: z.string(),
    isSigner: z.boolean(),
    isWritable: z.boolean(),
  })).optional(),
});

// Type 4: APPROVE
export const ApproveRequestSchema = z.object({
  type: z.literal('APPROVE'),
  spender: z.string().min(1),  // spender 주소
  token: z.object({
    address: z.string().min(1),
    decimals: z.number().int().min(0).max(18),
    symbol: z.string().min(1).max(10),
  }),
  amount: z.string().regex(/^\d+$/, 'amount must be a numeric string'),
});

// Type 5: BATCH
export const BatchRequestSchema = z.object({
  type: z.literal('BATCH'),
  instructions: z.array(z.union([
    TransferRequestSchema.omit({ type: true }).extend({ type: z.literal('TRANSFER').optional() }),
    TokenTransferRequestSchema.omit({ type: true }).extend({ type: z.literal('TOKEN_TRANSFER').optional() }),
    ContractCallRequestSchema.omit({ type: true }).extend({ type: z.literal('CONTRACT_CALL').optional() }),
    ApproveRequestSchema.omit({ type: true }).extend({ type: z.literal('APPROVE').optional() }),
  ])).min(2, 'Batch requires at least 2 instructions').max(20, 'Batch maximum 20 instructions'),
});
```

NOTE: 위 스키마 구조는 가이드라인이며, 실제 구현 시 Zod 3.x discriminatedUnion API에 맞게 조정한다. `z.discriminatedUnion('type', [...])` 사용.

2. TransactionRequestSchema (discriminatedUnion):
```typescript
export const TransactionRequestSchema = z.discriminatedUnion('type', [
  TransferRequestSchema,
  TokenTransferRequestSchema,
  ContractCallRequestSchema,
  ApproveRequestSchema,
  BatchRequestSchema,
]);
export type TransactionRequest = z.infer<typeof TransactionRequestSchema>;
```

3. 각 타입별 infer type export:
```typescript
export type TransferRequest = z.infer<typeof TransferRequestSchema>;
export type TokenTransferRequest = z.infer<typeof TokenTransferRequestSchema>;
export type ContractCallRequest = z.infer<typeof ContractCallRequestSchema>;
export type ApproveRequest = z.infer<typeof ApproveRequestSchema>;
export type BatchRequest = z.infer<typeof BatchRequestSchema>;
```

4. `packages/core/src/schemas/index.ts` 에 신규 스키마 + 타입 export 추가
5. `packages/core/src/index.ts` 에 신규 스키마 + 타입 export 추가

**기존 SendTransactionRequestSchema 유지**: 하위 호환성을 위해 삭제하지 않음. 기존 코드(pipeline stages.ts 등)가 SendTransactionRequestSchema를 import하고 있으므로, 이 phase에서는 교체하지 않는다. Phase 81에서 Stage 1이 TransactionRequestSchema로 전환.

**테스트** -- `packages/core/src/__tests__/schemas.test.ts` 에 discriminatedUnion 테스트 추가:

1. TRANSFER 파싱: `{ type: 'TRANSFER', to: '...', amount: '1000' }` → 성공, type === 'TRANSFER'
2. TOKEN_TRANSFER 파싱: `{ type: 'TOKEN_TRANSFER', to: '...', amount: '1000', token: { address: '...', decimals: 6, symbol: 'USDC' } }` → 성공
3. CONTRACT_CALL 파싱: `{ type: 'CONTRACT_CALL', to: '...', calldata: '0x...' }` → 성공
4. APPROVE 파싱: `{ type: 'APPROVE', spender: '...', token: { ... }, amount: '1000' }` → 성공
5. BATCH 파싱: `{ type: 'BATCH', instructions: [{ to: '...', amount: '1000' }, { to: '...', amount: '2000' }] }` → 성공
6. 잘못된 type: `{ type: 'INVALID' }` → ZodError
7. BATCH 최소 2개 검증: instructions가 1개 → ZodError
8. BATCH 최대 20개 검증: instructions가 21개 → ZodError
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core test` 실행하여 schemas.test.ts 포함 전체 core 테스트 통과.
`pnpm --filter @waiaas/core build` 실행하여 타입 에러 없이 빌드 성공.
  </verify>
  <done>
- TransactionRequestSchema가 z.discriminatedUnion으로 5-type을 type 필드로 식별
- 5개 타입별 스키마가 각각 독립적으로 export
- 기존 SendTransactionRequestSchema는 유지 (하위 호환)
- schemas.test.ts에 8건 이상 discriminatedUnion 파싱 테스트 통과
- @waiaas/core에서 모든 신규 스키마 + 타입이 export
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core test` -- core 패키지 전체 테스트 통과
2. `pnpm --filter @waiaas/daemon test` -- daemon 패키지 전체 테스트 통과 (마이그레이션 러너 + 기존 테스트)
3. `pnpm turbo build` -- 모노레포 전체 빌드 성공
4. schema_version 테이블 기반 마이그레이션 순차 실행 + 건너뛰기 동작 확인
5. TransactionRequestSchema.parse() 호출 시 5-type 중 올바른 타입으로 파싱 확인
</verification>

<success_criteria>
- runMigrations()가 schema_version 기반 증분 마이그레이션 순차 실행, 건너뛰기, 실패 롤백 동작
- TransactionRequestSchema가 5-type discriminatedUnion으로 동작
- 기존 SendTransactionRequestSchema 하위 호환 유지
- 전체 모노레포 빌드 + 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/76-infra-pipeline-foundation/76-02-SUMMARY.md`
</output>
