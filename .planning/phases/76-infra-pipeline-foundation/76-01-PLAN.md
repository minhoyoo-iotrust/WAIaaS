---
phase: 76-infra-pipeline-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/errors/chain-error.ts
  - packages/core/src/errors/error-codes.ts
  - packages/core/src/errors/index.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/chain-error.test.ts
autonomous: true

must_haves:
  truths:
    - "ChainError 인스턴스는 category(PERMANENT/TRANSIENT/STALE)에서 retryable을 자동 파생한다"
    - "25개 체인 에러 코드가 올바른 카테고리에 매핑된다 (PERMANENT 17, TRANSIENT 4, STALE 4)"
    - "INSUFFICIENT_FOR_FEE 에러 코드가 TX 도메인으로 이동하여 가스비 부족과 전송 금액 부족을 구분한다"
    - "ChainError는 WAIaaSError를 확장하여 기존 에러 처리 인프라와 호환된다"
  artifacts:
    - path: "packages/core/src/errors/chain-error.ts"
      provides: "ChainError 클래스 + ChainErrorCode 타입 + CHAIN_ERROR_CATEGORIES 매핑"
      exports: ["ChainError", "ChainErrorCategory", "ChainErrorCode", "CHAIN_ERROR_CATEGORIES"]
    - path: "packages/core/src/errors/error-codes.ts"
      provides: "INSUFFICIENT_FOR_FEE가 TX 도메인으로 이동된 에러 코드 정의"
      contains: "INSUFFICIENT_FOR_FEE.*domain.*TX"
    - path: "packages/core/src/__tests__/chain-error.test.ts"
      provides: "ChainError TDD 테스트: 카테고리 매핑, retryable 파생, 25개 코드 검증"
      min_lines: 80
  key_links:
    - from: "packages/core/src/errors/chain-error.ts"
      to: "packages/core/src/errors/error-codes.ts"
      via: "ChainErrorCode 타입 참조"
      pattern: "ChainErrorCode"
    - from: "packages/core/src/errors/chain-error.ts"
      to: "packages/core/src/errors/base-error.ts"
      via: "WAIaaSError 확장 (또는 독립 Error 서브클래스)"
      pattern: "extends.*Error"
    - from: "packages/core/src/errors/index.ts"
      to: "packages/core/src/errors/chain-error.ts"
      via: "re-export"
      pattern: "export.*chain-error"
---

<objective>
ChainError 클래스와 3-카테고리(PERMANENT/TRANSIENT/STALE) 시스템을 TDD로 구현하고, INSUFFICIENT_FOR_FEE 에러 코드를 WITHDRAW에서 TX 도메인으로 이동한다.

Purpose: Stage 5 의사코드(CONC-01)가 `err.category` 분기에 전적으로 의존하므로, ChainError 없이는 v1.4 파이프라인 재시도 로직 구현이 불가하다. 또한 DD-04 설계 부채(가스비 부족 vs 전송 금액 부족 구분)를 해소한다.
Output: ChainError 클래스, 25개 에러 코드 카테고리 매핑, INSUFFICIENT_FOR_FEE TX 도메인 이동, 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/core/src/errors/base-error.ts
@packages/core/src/errors/error-codes.ts
@packages/core/src/errors/index.ts
@packages/core/src/index.ts
@packages/core/src/__tests__/errors.test.ts
@objectives/v1.4-token-contract-extension.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ChainError 클래스 + 25개 카테고리 매핑 (TDD RED-GREEN)</name>
  <files>
    packages/core/src/errors/chain-error.ts
    packages/core/src/errors/error-codes.ts
    packages/core/src/errors/index.ts
    packages/core/src/index.ts
    packages/core/src/__tests__/chain-error.test.ts
  </files>
  <action>
**RED phase** -- 테스트 먼저 작성:

`packages/core/src/__tests__/chain-error.test.ts` 에 다음 테스트 작성:

1. ChainError 생성 테스트:
   - `new ChainError('INSUFFICIENT_BALANCE', 'SOLANA')` → `category === 'PERMANENT'`, `retryable === false`
   - `new ChainError('RPC_TIMEOUT', 'SOLANA')` → `category === 'TRANSIENT'`, `retryable === true`
   - `new ChainError('BLOCKHASH_EXPIRED', 'SOLANA')` → `category === 'STALE'`, `retryable === true`
   - ChainError instanceof Error === true
   - `chain` 필드가 생성자 인자와 일치

2. 25개 에러 코드 카테고리 매핑 전수 검증:
   - PERMANENT (17개): INSUFFICIENT_BALANCE, INVALID_ADDRESS, ACCOUNT_NOT_FOUND, CONTRACT_EXECUTION_FAILED, INVALID_INSTRUCTION, PROGRAM_NOT_FOUND, TOKEN_ACCOUNT_NOT_FOUND, INSUFFICIENT_TOKEN_BALANCE, SPENDER_NOT_APPROVED, ATA_CREATION_FAILED, INVALID_PROGRAM_DATA, UNAUTHORIZED_SIGNER, TRANSACTION_TOO_LARGE, DUPLICATE_TRANSACTION, ACCOUNT_ALREADY_EXISTS, INVALID_TOKEN_PROGRAM, INSUFFICIENT_FOR_FEE
   - TRANSIENT (4개): RPC_TIMEOUT, RPC_CONNECTION_ERROR, RATE_LIMITED, NODE_BEHIND
   - STALE (4개): BLOCKHASH_EXPIRED, NONCE_TOO_LOW, NONCE_ALREADY_USED, SLOT_SKIPPED

3. retryable 자동 파생 테스트:
   - PERMANENT → `retryable === false`
   - TRANSIENT → `retryable === true`
   - STALE → `retryable === true`

4. toJSON() 직렬화 테스트: `{ code, message, category, chain, retryable }` 포함 확인

5. optional cause 체이닝 테스트: `new ChainError('RPC_TIMEOUT', 'SOLANA', { cause: originalError })`

**GREEN phase** -- 구현:

`packages/core/src/errors/chain-error.ts` 신규 생성:
```typescript
export type ChainErrorCategory = 'PERMANENT' | 'TRANSIENT' | 'STALE';

// 25개 체인 전용 에러 코드 (기존 ERROR_CODES와는 별도 -- 체인 어댑터 내부용)
export type ChainErrorCode =
  // PERMANENT (17)
  | 'INSUFFICIENT_BALANCE' | 'INVALID_ADDRESS' | 'ACCOUNT_NOT_FOUND'
  | 'CONTRACT_EXECUTION_FAILED' | 'INVALID_INSTRUCTION' | 'PROGRAM_NOT_FOUND'
  | 'TOKEN_ACCOUNT_NOT_FOUND' | 'INSUFFICIENT_TOKEN_BALANCE' | 'SPENDER_NOT_APPROVED'
  | 'ATA_CREATION_FAILED' | 'INVALID_PROGRAM_DATA' | 'UNAUTHORIZED_SIGNER'
  | 'TRANSACTION_TOO_LARGE' | 'DUPLICATE_TRANSACTION' | 'ACCOUNT_ALREADY_EXISTS'
  | 'INVALID_TOKEN_PROGRAM' | 'INSUFFICIENT_FOR_FEE'
  // TRANSIENT (4)
  | 'RPC_TIMEOUT' | 'RPC_CONNECTION_ERROR' | 'RATE_LIMITED' | 'NODE_BEHIND'
  // STALE (4)
  | 'BLOCKHASH_EXPIRED' | 'NONCE_TOO_LOW' | 'NONCE_ALREADY_USED' | 'SLOT_SKIPPED';

export const CHAIN_ERROR_CATEGORIES: Record<ChainErrorCode, ChainErrorCategory> = { ... };
```

ChainError 클래스:
- `extends Error` (WAIaaSError 확장이 아닌 독립 Error 서브클래스 -- ChainError는 체인 어댑터 내부 에러이고 httpStatus가 불필요. Stage 5에서 ChainError를 잡아 WAIaaSError로 변환하는 패턴)
- 생성자: `(code: ChainErrorCode, chain: string, options?: { message?: string; cause?: Error })`
- `category`: `CHAIN_ERROR_CATEGORIES[code]`에서 자동 파생
- `retryable`: `category !== 'PERMANENT'`에서 자동 파생
- `toJSON()`: `{ code, message, category, chain, retryable }` 반환

`packages/core/src/errors/index.ts` 에 ChainError 관련 export 추가.
`packages/core/src/index.ts` 에 ChainError, ChainErrorCategory, ChainErrorCode, CHAIN_ERROR_CATEGORIES export 추가.

**INFRA-05 DD-04 해소**: `packages/core/src/errors/error-codes.ts` 에서 INSUFFICIENT_FOR_FEE의 domain을 'WITHDRAW'에서 'TX'로 변경하고, httpStatus를 500에서 400으로 변경. message는 그대로 유지.

기존 errors.test.ts에 영향 확인: ERROR_CODES 구조 변경이 기존 테스트에 미치는 영향 확인 후 필요시 수정.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core test` 실행하여 chain-error.test.ts 포함 전체 core 테스트 통과 확인.

추가 검증:
- `grep -c 'PERMANENT\|TRANSIENT\|STALE' packages/core/src/errors/chain-error.ts` → 25개 코드가 3개 카테고리에 매핑
- `grep "domain: 'TX'" packages/core/src/errors/error-codes.ts | grep INSUFFICIENT_FOR_FEE` → TX 도메인 이동 확인
  </verify>
  <done>
- ChainError 클래스가 25개 코드를 3-카테고리에 매핑하고 retryable을 자동 파생
- INSUFFICIENT_FOR_FEE가 TX 도메인, httpStatus 400으로 이동
- chain-error.test.ts에 카테고리 전수 검증 + retryable 파생 + toJSON + cause 체이닝 테스트 통과
- 기존 errors.test.ts와 패키지 전체 테스트가 깨지지 않음
- @waiaas/core에서 ChainError, ChainErrorCategory, ChainErrorCode, CHAIN_ERROR_CATEGORIES가 export됨
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core test` -- 전체 core 패키지 테스트 통과
2. `pnpm --filter @waiaas/core build` -- 타입 에러 없이 빌드 성공
3. `pnpm turbo build` -- 모노레포 전체 빌드 성공 (INSUFFICIENT_FOR_FEE 도메인 변경이 하위 패키지에 미치는 영향 확인)
</verification>

<success_criteria>
- ChainError 인스턴스가 category에서 retryable을 자동 파생 (PERMANENT=false, TRANSIENT=true, STALE=true)
- 25개 에러 코드가 3-카테고리에 올바르게 매핑
- INSUFFICIENT_FOR_FEE가 TX 도메인 (httpStatus 400)으로 이동
- 전체 모노레포 빌드 + 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/76-infra-pipeline-foundation/76-01-SUMMARY.md`
</output>
