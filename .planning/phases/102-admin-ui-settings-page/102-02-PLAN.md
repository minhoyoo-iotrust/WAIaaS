---
phase: 102-admin-ui-settings-page
plan: 02
type: execute
wave: 2
depends_on: ["102-01"]
files_modified:
  - packages/admin/src/__tests__/settings.test.tsx
autonomous: true

must_haves:
  truths:
    - "Settings page test suite covers category rendering, save flow, RPC test, notification test"
    - "Credential fields display (configured) placeholder when true from API, empty when false"
    - "Save bar only appears when dirty fields exist"
    - "Tests cover error handling for API failures"
  artifacts:
    - path: "packages/admin/src/__tests__/settings.test.tsx"
      provides: "Comprehensive test suite for settings page"
      contains: "NotificationSettings|RPC|Security|WalletConnect|log_level"
  key_links:
    - from: "packages/admin/src/__tests__/settings.test.tsx"
      to: "packages/admin/src/pages/settings.tsx"
      via: "Preact render + testing-library assertions"
      pattern: "render.*SettingsPage"
---

<objective>
Comprehensive test suite for the settings page covering all 5 category sections, save workflow, RPC connectivity test, notification test, credential masking, and error handling. Replaces the existing 3 minimal tests with thorough coverage.

Purpose: Verify UI behavior for all 33 settings, save/discard flow, test buttons, and edge cases (API errors, empty credentials).
Output: Updated settings.test.tsx with 12+ tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/102-admin-ui-settings-page/102-01-PLAN.md

# Key source files
@packages/admin/src/pages/settings.tsx
@packages/admin/src/__tests__/settings.test.tsx
@packages/admin/src/__tests__/setup.ts
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/components/form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite settings.test.tsx with comprehensive coverage</name>
  <files>
    packages/admin/src/__tests__/settings.test.tsx
  </files>
  <action>
Rewrite `settings.test.tsx` completely. Keep the same mock patterns (vi.mock for api/client, toast, auth/store, error-messages) as existing. Use `@testing-library/preact` with `render`, `screen`, `waitFor`, `fireEvent`, `cleanup`.

**Mock data:**

```ts
const mockSettingsResponse = {
  notifications: {
    enabled: 'false',
    telegram_bot_token: true,      // credential: configured
    telegram_chat_id: '12345',
    discord_webhook_url: false,     // credential: not configured
    ntfy_server: 'https://ntfy.sh',
    ntfy_topic: '',
    locale: 'en',
    rate_limit_rpm: '20',
  },
  rpc: {
    solana_mainnet: 'https://api.mainnet-beta.solana.com',
    solana_devnet: 'https://api.devnet.solana.com',
    solana_testnet: 'https://api.testnet.solana.com',
    evm_ethereum_mainnet: 'https://eth.drpc.org',
    evm_ethereum_sepolia: 'https://sepolia.drpc.org',
    evm_polygon_mainnet: 'https://polygon.drpc.org',
    evm_polygon_amoy: 'https://polygon-amoy.drpc.org',
    evm_arbitrum_mainnet: 'https://arbitrum.drpc.org',
    evm_arbitrum_sepolia: 'https://arbitrum-sepolia.drpc.org',
    evm_optimism_mainnet: 'https://optimism.drpc.org',
    evm_optimism_sepolia: 'https://optimism-sepolia.drpc.org',
    evm_base_mainnet: 'https://base.drpc.org',
    evm_base_sepolia: 'https://base-sepolia.drpc.org',
    evm_default_network: 'ethereum-sepolia',
  },
  security: {
    session_ttl: '86400',
    max_sessions_per_wallet: '5',
    max_pending_tx: '10',
    rate_limit_global_ip_rpm: '1000',
    rate_limit_session_rpm: '300',
    rate_limit_tx_rpm: '10',
    policy_defaults_delay_seconds: '300',
    policy_defaults_approval_timeout: '3600',
  },
  daemon: {
    log_level: 'info',
  },
  walletconnect: {
    project_id: '',
  },
};
```

Also mock kill switch normal response for the existing controls.

**Tests to write:**

1. **"renders all 5 category sections"** -- After loading, check that headings "Notifications", "RPC Endpoints", "Security Parameters", "WalletConnect", "Daemon" are present.

2. **"renders notification fields with credential masking"** -- Verify telegram_bot_token shows "(configured)" placeholder (since it's `true`), discord_webhook_url shows empty (since it's `false`). Verify telegram_chat_id shows '12345'.

3. **"renders RPC endpoint URLs"** -- Verify at least Solana mainnet URL is displayed. Check "Test" buttons exist for RPC fields.

4. **"renders security parameter fields"** -- Verify session TTL field shows '86400'.

5. **"renders WalletConnect section with info box"** -- Check for "WalletConnect" heading and info text about cloud.walletconnect.com.

6. **"renders daemon log_level select"** -- Verify log_level field exists.

7. **"shows save bar when field is modified"** -- Modify a field value (e.g., type into session_ttl), verify save bar appears with text like "unsaved".

8. **"saves settings via PUT and clears dirty state"** -- Modify a field, click Save, verify apiPut called with correct payload. Mock success, verify toast success.

9. **"discards changes on discard click"** -- Modify field, click Discard, verify field reverts to original value and save bar disappears.

10. **"tests RPC connectivity"** -- Find and click a "Test" button next to an RPC field. Verify apiPost called with test-rpc endpoint. Mock success response with latency, verify result badge appears.

11. **"tests notification delivery"** -- Click "Test Notification" button. Verify apiPost called with notifications/test endpoint. Mock success, verify result displayed.

12. **"handles API error on save"** -- Mock apiPut to throw ApiError. Verify error toast shown.

13. **"keeps existing kill switch controls"** -- Verify Kill Switch section still renders (heading present, state badge present).

14. **"keeps existing shutdown controls"** -- Verify "Shutdown Daemon" button present.

**Important implementation notes:**
- The apiGet mock needs to handle two calls on mount: one for kill switch state (existing), one for settings. Use `mockResolvedValueOnce` in order: first for kill switch, then for settings (or check how the component calls them -- both likely in parallel via useEffect).
- Actually, re-check how the rewritten settings.tsx from Plan 01 fetches data. It fetches settings via `apiGet(API.ADMIN_SETTINGS)` and kill switch via `apiGet(API.ADMIN_KILL_SWITCH)`. Mock both.
- Since both fetches happen on mount, mock `apiGet` with conditional logic based on path, or use sequential `mockResolvedValueOnce`. The safer approach: mock `apiGet` as a function that checks the path argument:
  ```ts
  vi.mocked(apiGet).mockImplementation(async (path: string) => {
    if (path === '/v1/admin/kill-switch') return mockKillSwitchNormal;
    if (path === '/v1/admin/settings') return mockSettingsResponse;
    return {};
  });
  ```
  </action>
  <verify>
   - `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/admin/src/__tests__/settings.test.tsx` -- all tests pass
   - At least 12 tests defined and passing
  </verify>
  <done>
   - Settings test suite covers all 5 categories, save/discard flow, RPC test, notification test, credential masking
   - Error handling tested
   - Existing kill switch / shutdown controls tested for continued presence
   - All tests pass with vitest
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix any TypeScript or test issues found during test run</name>
  <files>
    packages/admin/src/pages/settings.tsx
    packages/admin/src/__tests__/settings.test.tsx
  </files>
  <action>
Run the full admin test suite and fix any issues:

1. Run `npx vitest run packages/admin/src/__tests__/` to execute all admin tests
2. If settings.test.tsx fails, analyze errors and fix:
   - Text not found: adjust selectors (check actual rendered text vs expected)
   - Mock ordering: ensure apiGet mock handles both paths correctly
   - Signal reactivity: use `waitFor` for async state updates
   - Form field value access: check how FormField renders values in DOM
3. If settings.tsx has TS errors, fix them (likely type mismatches with signal values)
4. Ensure other admin tests (auth, dashboard, wallets, sessions, policies, notifications) still pass -- no regressions
5. Run `npx tsc --noEmit -p packages/admin/tsconfig.json` for type checking

Fix ANY issues found. This task is a safety net to ensure Plan 01's output + Plan 02 Task 1's tests are fully green.
  </action>
  <verify>
   - `npx vitest run packages/admin/src/__tests__/` -- ALL admin tests pass (not just settings)
   - `npx tsc --noEmit -p packages/admin/tsconfig.json` -- no type errors
  </verify>
  <done>
   - All admin tests pass (including new settings tests + existing auth/dashboard/wallets/sessions/policies/notifications tests)
   - No TypeScript errors
   - No regressions in existing functionality
  </done>
</task>

</tasks>

<verification>
1. `cd packages/admin && npx vitest run src/__tests__/settings.test.tsx` -- all new settings tests pass
2. `cd packages/admin && npx vitest run src/__tests__/` -- all admin tests pass (no regressions)
3. `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors
4. Test count >= 12 for settings page
</verification>

<success_criteria>
- Settings test suite has 12+ test cases covering all 5 categories
- Credential masking behavior tested (boolean -> placeholder display)
- Save/discard workflow tested end-to-end
- RPC test and notification test interactions tested
- Error handling for API failures tested
- All existing admin tests pass without regression
- Zero TypeScript errors in admin package
</success_criteria>

<output>
After completion, create `.planning/phases/102-admin-ui-settings-page/102-02-SUMMARY.md`
</output>
