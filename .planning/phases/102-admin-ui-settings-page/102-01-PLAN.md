---
phase: 102-admin-ui-settings-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/pages/settings.tsx
  - packages/admin/src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "Settings page shows 5 category sections: Notifications, RPC Endpoints, Security, WalletConnect, Daemon"
    - "Admin can edit notification credentials (Telegram bot token, Discord webhook, Ntfy topic) and save"
    - "Admin can edit RPC URLs for Solana 3 networks + EVM 10 networks and save"
    - "Admin can edit security parameters (session_ttl, rate_limit, etc.) and save"
    - "Admin can test individual RPC endpoint connectivity with latency display"
    - "Admin can test notification delivery from the settings page"
    - "Kill switch / JWT rotation / shutdown sections remain functional"
  artifacts:
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "Complete settings page with 5 category sections + existing admin controls"
      contains: "NotificationSettings|RpcSettings|SecuritySettings"
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "Settings API endpoint constants"
      contains: "ADMIN_SETTINGS"
    - path: "packages/admin/src/styles/global.css"
      provides: "CSS for new settings UI sections"
      contains: "settings-category"
  key_links:
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/settings"
      via: "apiGet + apiPut fetch"
      pattern: "apiGet.*ADMIN_SETTINGS|apiPut.*ADMIN_SETTINGS"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/settings/test-rpc"
      via: "apiPost for RPC test"
      pattern: "apiPost.*TEST_RPC"
---

<objective>
Overhaul the Admin Settings page to display and manage all 5 setting categories (notifications, RPC, security, WalletConnect, daemon) fetched from GET /v1/admin/settings, with inline editing, save via PUT, RPC connectivity testing, and notification test send. Existing Kill Switch / JWT Rotation / Shutdown controls remain at the bottom.

Purpose: Admin can visually configure all 33 operational settings without editing config.toml, with changes hot-reloaded immediately.
Output: Complete settings page with 5 category sections + existing admin controls, API endpoints wired, CSS styles added.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/101-settings-api-hot-reload/101-01-SUMMARY.md
@.planning/phases/100-settings-infra/100-02-SUMMARY.md

# Key source files
@packages/admin/src/pages/settings.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/components/form.tsx
@packages/admin/src/components/toast.tsx
@packages/admin/src/components/layout.tsx
@packages/admin/src/styles/global.css
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/api/routes/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: API endpoints + Settings page overhaul with 5 category sections</name>
  <files>
    packages/admin/src/api/endpoints.ts
    packages/admin/src/pages/settings.tsx
  </files>
  <action>
1. **endpoints.ts** -- Add 3 new endpoint constants:
   ```ts
   ADMIN_SETTINGS: '/v1/admin/settings',
   ADMIN_SETTINGS_TEST_RPC: '/v1/admin/settings/test-rpc',
   ADMIN_NOTIFICATIONS_TEST: '/v1/admin/notifications/test',   // already exists, keep it
   ```

2. **settings.tsx** -- Complete rewrite. The page structure:

   **A) State management** (all using `useSignal` from @preact/signals):
   - `settings` signal: holds the fetched settings object `{ notifications, rpc, security, daemon, walletconnect }` where each category is `Record<string, string | boolean>`
   - `dirty` signal: `Record<string, string>` of changed key-value pairs (full setting key like `notifications.telegram_bot_token` -> new value)
   - `saving` signal: boolean
   - `loading` signal: boolean (for initial fetch)
   - `rpcTestResults` signal: `Record<string, { success: boolean; latencyMs: number; blockNumber?: number; error?: string }>` keyed by setting key
   - `rpcTesting` signal: `Record<string, boolean>` keyed by setting key (loading state per RPC field)
   - `notifTestResults` signal: array of `{ channel: string; success: boolean; error?: string }`
   - `notifTesting` signal: boolean
   - Keep existing kill switch, rotate, shutdown signals unchanged.

   **B) Data fetching** -- `fetchSettings()` calls `apiGet(API.ADMIN_SETTINGS)` on mount. Populates `settings` signal. Note: credential fields come back as `true`/`false` (boolean, not the actual value). So for credential fields, display placeholder text "(configured)" if `true`, empty input if `false`.

   **C) Save handler** -- `handleSave()`:
   - Constructs `{ settings: Object.entries(dirty.value).map(([key, value]) => ({ key, value })) }`
   - Calls `apiPut(API.ADMIN_SETTINGS, body)`.
   - On success: clear `dirty`, re-fetch settings, showToast success.
   - On error: showToast error.

   **D) Field change handler** -- `handleFieldChange(key: string, value: string)`:
   - Updates `dirty.value = { ...dirty.value, [key]: value }`
   - For display, compute effective value: `dirty[key] ?? settings[category][shortKey]`

   **E) Category sections** -- Render 5 collapsible/visible sections using sub-components (inline functions):

   **E1) NotificationSettings section:**
   - Title: "Notifications"
   - Description: "Configure notification channels for transaction alerts"
   - Fields (using existing FormField component):
     - `notifications.enabled` -- checkbox
     - `notifications.telegram_bot_token` -- password input (credential: show "(configured)" placeholder if true)
     - `notifications.telegram_chat_id` -- text input
     - `notifications.discord_webhook_url` -- password input (credential)
     - `notifications.ntfy_server` -- text input
     - `notifications.ntfy_topic` -- text input
     - `notifications.locale` -- select with options: [{ label: 'English', value: 'en' }, { label: 'Korean', value: 'ko' }]
     - `notifications.rate_limit_rpm` -- number input (min: 1, max: 1000)
   - "Test Notification" button at bottom: calls `apiPost(API.ADMIN_NOTIFICATIONS_TEST)`, displays results inline per-channel

   **E2) RpcSettings section:**
   - Title: "RPC Endpoints"
   - Description: "Configure blockchain RPC URLs for Solana and EVM networks"
   - Sub-group: **Solana** (3 fields: solana_mainnet, solana_devnet, solana_testnet)
   - Sub-group: **EVM** (10 URL fields + evm_default_network select)
   - Each URL field has a small "Test" button next to it. onClick: calls `apiPost(API.ADMIN_SETTINGS_TEST_RPC, { url: effectiveValue, chain: key.includes('solana') ? 'solana' : 'evm' })`. Shows success/failure badge + latency inline.
   - `rpc.evm_default_network` -- select with options for all EVM networks from SETTING_DEFINITIONS (ethereum-mainnet, ethereum-sepolia, polygon-mainnet, polygon-amoy, arbitrum-mainnet, arbitrum-sepolia, optimism-mainnet, optimism-sepolia, base-mainnet, base-sepolia)

   **E3) SecuritySettings section:**
   - Title: "Security Parameters"
   - Description: "Session, rate limiting, and policy defaults"
   - Fields:
     - `security.session_ttl` -- number input (label: "Session TTL (seconds)", min: 300)
     - `security.max_sessions_per_wallet` -- number (min: 1, max: 100)
     - `security.max_pending_tx` -- number (min: 1, max: 100)
     - `security.rate_limit_global_ip_rpm` -- number (min: 10)
     - `security.rate_limit_session_rpm` -- number (min: 10)
     - `security.rate_limit_tx_rpm` -- number (min: 1)
     - `security.policy_defaults_delay_seconds` -- number (min: 0)
     - `security.policy_defaults_approval_timeout` -- number (min: 60)

   **E4) WalletConnectSettings section:**
   - Title: "WalletConnect"
   - Description: "WalletConnect integration for dApp connections"
   - Fields:
     - `walletconnect.project_id` -- text input
   - Info box below: "Get your project ID from https://cloud.walletconnect.com -- Create a free account and project to obtain your project ID."

   **E5) DaemonSettings section:**
   - Title: "Daemon"
   - Description: "General daemon configuration"
   - Fields:
     - `daemon.log_level` -- select with options: debug, info, warn, error

   **F) Global Save bar** -- A sticky bar at the top (visible only when `dirty` has entries) showing "N unsaved changes" with "Save" and "Discard" buttons.

   **G) Existing sections** -- Keep Kill Switch, JWT Rotation, and Danger Zone (Shutdown) sections at the very bottom, unchanged from current implementation.

   **H) Layout** -- Each settings-section uses the existing `.settings-section` CSS class. Category sections use a new `.settings-category` wrapper with `.settings-category-header` (clickable) and `.settings-category-body`. Fields within use `.settings-fields-grid` for 2-column layout on desktop.

   Important implementation notes:
   - Import `apiGet`, `apiPost`, `apiPut`, `ApiError` from client
   - Import `API` from endpoints
   - Import `FormField`, `Button`, `Badge` from form
   - Import `showToast` from toast
   - Import `getErrorMessage` from error-messages
   - Import `formatDate` from format
   - Use `useSignal` from `@preact/signals` for all local state
   - Use `useEffect` from `preact/hooks` for fetch on mount
   - Keep `Modal` import for shutdown/rotate modals
   - For credential fields (where GET returns boolean true/false): display text "(configured)" if true, empty if false. User can type a new value to overwrite. If user clears it, send empty string to clear credential.
   - The effective display value for a field: `dirty.value[fullKey] !== undefined ? dirty.value[fullKey] : (typeof catValue === 'boolean' ? '' : catValue)` where `catValue` is settings[category][shortKey]
  </action>
  <verify>
   - `npx tsc --noEmit -p packages/admin/tsconfig.json` passes (or Vite build succeeds)
   - Manual check: page has all 5 category sections + existing admin controls
   - File compiles without TS errors
  </verify>
  <done>
   - Settings page renders all 5 categories with input fields matching the 33 SETTING_DEFINITIONS
   - Save/Discard bar appears when fields are modified
   - RPC test buttons call test-rpc endpoint
   - Notification test button calls notifications/test endpoint
   - Kill switch / JWT rotation / shutdown sections remain at bottom
  </done>
</task>

<task type="auto">
  <name>Task 2: CSS styles for settings category sections + RPC test inline results</name>
  <files>
    packages/admin/src/styles/global.css
  </files>
  <action>
Append new CSS rules to the end of `global.css` (before the closing `@media` block or after the notification page styles). Add:

```css
/* Settings Categories */
.settings-save-bar {
  position: sticky;
  top: var(--header-height);
  z-index: 4;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-3) var(--space-4);
  background: var(--color-warning-bg);
  border: 1px solid var(--color-warning);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-4);
  font-size: var(--font-size-sm);
  color: var(--color-text);
}

.settings-save-bar-actions {
  display: flex;
  gap: var(--space-2);
}

.settings-category {
  background: var(--color-bg);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-4);
  overflow: hidden;
}

.settings-category-header {
  padding: var(--space-4) var(--space-6);
  border-bottom: 1px solid var(--color-border);
}

.settings-category-header h3 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-1);
}

.settings-category-body {
  padding: var(--space-4) var(--space-6);
}

.settings-fields-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--space-4);
}

.settings-fields-grid .form-field {
  margin-bottom: 0;
}

.settings-field-full {
  grid-column: 1 / -1;
}

.settings-subgroup {
  margin-bottom: var(--space-4);
}

.settings-subgroup-title {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: var(--space-3);
  padding-bottom: var(--space-2);
  border-bottom: 1px solid var(--color-border);
}

.rpc-field-row {
  display: flex;
  gap: var(--space-2);
  align-items: flex-end;
}

.rpc-field-row .form-field {
  flex: 1;
  margin-bottom: 0;
}

.rpc-test-result {
  display: inline-flex;
  align-items: center;
  gap: var(--space-1);
  font-size: var(--font-size-xs);
  margin-top: var(--space-1);
}

.rpc-test-result--success {
  color: var(--color-success);
}

.rpc-test-result--failure {
  color: var(--color-danger);
}

.settings-info-box {
  padding: var(--space-3) var(--space-4);
  background: var(--color-info-bg);
  border: 1px solid var(--color-info);
  border-radius: var(--radius-md);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-top: var(--space-3);
}

.settings-info-box a {
  color: var(--color-primary);
  text-decoration: underline;
}

.notif-test-section {
  margin-top: var(--space-4);
  padding-top: var(--space-4);
  border-top: 1px solid var(--color-border);
}

.settings-category-actions {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-4);
  padding-top: var(--space-3);
  border-top: 1px solid var(--color-border);
}

@media (max-width: 768px) {
  .settings-fields-grid {
    grid-template-columns: 1fr;
  }
}
```

  </action>
  <verify>
   - `npx vite build` in packages/admin (or `npx tsc --noEmit -p packages/admin/tsconfig.json`)
   - CSS file is well-formed (no syntax errors)
  </verify>
  <done>
   - All settings category CSS classes exist and follow existing design system variables
   - Responsive 2-column -> 1-column grid for fields
   - Sticky save bar styled with warning colors
   - RPC test result inline badges styled
   - Info box for WalletConnect guidance styled
  </done>
</task>

</tasks>

<verification>
1. `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors
2. Settings page renders all 5 category sections with correct field types
3. API endpoints constants reference correct paths matching daemon routes
4. Save bar appears when any field is modified
5. RPC test button sends correct chain type (solana/evm) and shows result
6. Notification test sends and displays per-channel results
7. Existing Kill Switch / JWT Rotation / Shutdown controls remain functional
</verification>

<success_criteria>
- Admin can load Settings page and see all 33 operational settings grouped in 5 categories
- Admin can modify settings, see unsaved changes count, save to persist + hot-reload
- Admin can test individual RPC connections and see latency
- Admin can test notification delivery and see per-channel success/failure
- WalletConnect section shows project ID field with guidance link
- Daemon section shows log_level select
- Existing admin controls (kill switch, rotate, shutdown) remain at page bottom
</success_criteria>

<output>
After completion, create `.planning/phases/102-admin-ui-settings-page/102-01-SUMMARY.md`
</output>
