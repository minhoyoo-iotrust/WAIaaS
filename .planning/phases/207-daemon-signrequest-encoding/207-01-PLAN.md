# Plan 207-01: NtfySigningChannel base64url 인코딩 변경 + wallet-sdk 호환성 검증

## Metadata
- **Phase:** 207
- **Plan:** 01
- **Wave:** 1
- **Depends on:** none
- **Requirements:** ENCODE-01, ENCODE-02, ENCODE-03
- **Files modified:** packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts, packages/daemon/src/__tests__/ntfy-signing-channel.test.ts, packages/wallet-sdk/src/__tests__/channels.test.ts
- **Autonomous:** true

## Goal

NtfySigningChannel의 ntfy publish 형식을 변경하여 SignRequest를 base64url 인코딩하고, displayMessage를 title로 이동한다. wallet-sdk subscribeToRequests()는 이미 base64url 디코딩을 사용하므로 코드 변경 없이 호환성만 검증한다.

## Tasks

<task id="1">
**NtfySigningChannel.publishToNtfy() 메서드 시그니처 변경**

publishToNtfy 메서드가 전체 SignRequest 객체를 받도록 변경:

Before:
```typescript
private async publishToNtfy(ntfyServer: string, requestTopic: string, displayMessage: string, universalLinkUrl: string): Promise<void>
```

After:
```typescript
private async publishToNtfy(ntfyServer: string, requestTopic: string, request: SignRequest, universalLinkUrl: string): Promise<void>
```

ntfy publish body 변경:
```typescript
// Before
const body = JSON.stringify({
  topic: requestTopic,
  message: displayMessage,
  title: 'WAIaaS Sign Request',
  priority: 5,
  tags: ['waiaas', 'sign'],
  actions: [{ action: 'view', label: 'Sign in wallet', url: universalLinkUrl }],
  click: universalLinkUrl,
});

// After
const encoded = Buffer.from(JSON.stringify(request), 'utf-8').toString('base64url');
const body = JSON.stringify({
  topic: requestTopic,
  message: encoded,
  title: request.displayMessage,
  priority: 5,
  tags: ['waiaas', 'sign'],
  actions: [{ action: 'view', label: 'Sign in wallet', url: universalLinkUrl }],
  click: universalLinkUrl,
});
```

sendRequest() 호출부 업데이트:
```typescript
// Before
await this.publishToNtfy(ntfyServer, requestTopic, request.displayMessage, universalLinkUrl);
// After
await this.publishToNtfy(ntfyServer, requestTopic, request, universalLinkUrl);
```

import 추가: `import type { SignRequest } from '@waiaas/core';`
</task>

<task id="2">
**daemon 테스트 업데이트 (ntfy-signing-channel.test.ts)**

publish body 검증 업데이트:
- `publishBody.message`가 base64url 인코딩된 SignRequest인지 검증 (디코딩 후 JSON.parse → requestId 일치)
- `publishBody.title`이 displayMessage 텍스트인지 검증
- 기존 `publishBody.title === 'WAIaaS Sign Request'` 검증 제거
- 기존 `publishBody.message === mockSignRequest.displayMessage` 검증 변경
</task>

<task id="3">
**wallet-sdk 호환성 검증 테스트 추가 (channels.test.ts)**

subscribeToRequests 테스트에 "daemon encodes SignRequest as base64url in message field" 시나리오 추가:
- 이미 base64url(SignRequest) 형식으로 SSE 스트림을 생성하고 있으므로, 기존 테스트가 이미 호환성을 검증
- 기존 테스트 통과 = ENCODE-03 달성
- 명시적으로 "daemon format compatibility" 레이블의 테스트 추가하여 의도를 문서화
</task>

## Verification

1. `pnpm turbo run test --filter=@waiaas/daemon -- --run ntfy-signing-channel` — daemon 테스트 통과
2. `pnpm turbo run test --filter=@waiaas/wallet-sdk -- --run channels` — wallet-sdk 테스트 통과
3. publish body에서 `message` 필드를 base64url 디코딩하면 유효한 SignRequest JSON
4. publish body에서 `title` 필드가 displayMessage 텍스트

## must_haves

- [ ] NtfySigningChannel.publishToNtfy()가 message 필드에 base64url(SignRequest)를 전송
- [ ] NtfySigningChannel.publishToNtfy()가 title 필드에 displayMessage를 설정
- [ ] wallet-sdk subscribeToRequests()가 base64url 인코딩된 메시지를 정상 파싱 (기존 호환)
