---
phase: 167-test-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/security/**/*.security.test.ts
  - packages/daemon/src/__tests__/unit/**/*.test.ts
  - packages/daemon/src/__tests__/integration/**/*.test.ts
autonomous: true
requirements: [TEST-01]

must_haves:
  truths:
    - "보안 공격 시나리오 ~347건이 전수 통과하고 실패 0건이다"
    - "pnpm turbo run test:security 명령이 exit code 0을 반환한다"
    - "16개 보안 테스트 파일 모두 PASS로 리포트된다"
  artifacts:
    - path: "packages/daemon/src/__tests__/security/"
      provides: "16개 보안 테스트 파일 (~347 test cases)"
  key_links:
    - from: "packages/daemon/src/__tests__/security/"
      to: "packages/daemon/src/"
      via: "import of service/route/middleware modules"
      pattern: "import.*from.*\\.\\./"
---

<objective>
보안 공격 시나리오 테스트 ~347건을 전수 실행하고, 실패 건이 있으면 수정하여 전수 통과 상태를 달성한다.

Purpose: v2.0 릴리스 품질 기준의 핵심인 보안 테스트 전수 통과를 보장한다. 16개 파일에 걸친 보안 시나리오(세션 인증 공격, 정책 우회, Kill Switch, x402 결제 공격, 토큰 정책 공격, 컨트랙트 화이트리스트, 오라클 조작, 배치 분할, 승인 공격, 키스토어 외부 공격 등)가 모두 방어되는지 검증한다.
Output: 보안 테스트 전수 통과 (exit code 0)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/daemon/src/__tests__/security/
</context>

<tasks>

<task type="auto">
  <name>Task 1: 보안 테스트 전수 실행 + 실패 건 진단</name>
  <files>packages/daemon/src/__tests__/security/**/*.security.test.ts</files>
  <action>
  1. `pnpm turbo run build` 후 `pnpm turbo run test:security` 실행
  2. 실패 건이 있으면 각 실패의 원인을 진단:
     - import 경로 변경으로 인한 실패 → import 수정
     - API 시그니처 변경으로 인한 실패 → 테스트 업데이트
     - 실제 보안 로직 회귀 → 소스 코드 수정
  3. 실패 건이 0건이면 그대로 통과 확인만 수행
  4. 16개 파일 목록:
     - layer1-session: session-auth-attacks, owner-auth-attacks
     - layer2-policy: policy-bypass-attacks
     - layer3-killswitch: killswitch-attacks
     - extension: token-policy, contract-whitelist, approve, batch-split, chain-error, action-provider, oracle-manipulation, swap-slippage
     - boundary-chain: boundary-values, e2e-attack-chains
     - keystore-external: keystore-external-attacks
     - x402: x402-payment-attacks
  </action>
  <verify>
  `pnpm turbo run test:security` exit code 0, 모든 테스트 PASS
  </verify>
  <done>16개 보안 테스트 파일의 ~347 test cases가 전수 통과하고 실패 0건</done>
</task>

<task type="auto">
  <name>Task 2: 보안 테스트 실패 건 수정 (있을 경우)</name>
  <files>packages/daemon/src/__tests__/security/**/*.security.test.ts</files>
  <action>
  Task 1에서 실패 건이 발견된 경우에만 수행:
  1. 각 실패 건의 root cause를 파악하고 최소 변경으로 수정
  2. 수정 후 전체 보안 테스트 재실행으로 regression 없음 확인
  3. 수정이 다른 단위/통합 테스트에 영향을 주는지 `pnpm turbo run test:unit` 으로 확인
  4. 만약 Task 1에서 모든 테스트가 이미 통과했다면, 이 태스크는 즉시 완료 처리

  **주의**: 보안 로직 자체의 회귀가 발견되면 테스트를 약화시키는 것이 아니라 소스 코드를 수정해야 한다. 테스트가 보안 동작을 올바르게 검증하는 한 테스트를 변경하지 않는다.
  </action>
  <verify>
  `pnpm turbo run test:security` exit code 0
  `pnpm turbo run test:unit` 에서 기존 테스트 regression 없음
  </verify>
  <done>보안 테스트 전수 통과 + 기존 단위 테스트 regression 없음</done>
</task>

</tasks>

<verification>
- `pnpm turbo run test:security` → exit code 0, 16개 파일 전수 PASS
- CI stage2 보안 테스트 step과 동일한 명령으로 로컬에서 통과 확인
</verification>

<success_criteria>
- 보안 공격 시나리오 ~347건이 전수 통과하고, 실패 0건으로 리포트된다
- TEST-01 요구사항 충족
</success_criteria>

<output>
After completion, create `.planning/phases/167-test-gates/167-01-SUMMARY.md`
</output>
