---
phase: 75-admin-notification-api-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/admin-notification-api.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /admin/notifications/status returns channel status without credentials"
    - "POST /admin/notifications/test sends test notification to active channels"
    - "GET /admin/notifications/log returns paginated notification logs"
    - "API responses never include bot tokens, webhook URLs, or other secrets"
  artifacts:
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "3 new admin notification endpoints"
      contains: "notificationsStatusRoute"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "Zod OpenAPI schemas for notification endpoints"
      contains: "NotificationStatusResponseSchema"
    - path: "packages/daemon/src/__tests__/admin-notification-api.test.ts"
      provides: "Tests for notification API endpoints"
  key_links:
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "NotificationService"
      via: "AdminRouteDeps.notificationService"
      pattern: "notificationService"
    - from: "packages/daemon/src/api/server.ts"
      to: "admin.ts notification routes"
      via: "notificationService passthrough in adminRoutes deps"
      pattern: "notificationService.*adminRoutes"
---

<objective>
Add 3 admin notification API endpoints: channel status, test send, and log query.

Purpose: Enable the admin UI (75-02) to display notification channel status, trigger test notifications, and browse notification delivery history -- all without exposing credentials.

Output: 3 new OpenAPIHono routes under /v1/admin/notifications/*, OpenAPI schemas, tests
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/73-notification-log-infra/73-01-SUMMARY.md
@.planning/phases/74-pipeline-event-triggers/74-01-SUMMARY.md
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/notifications/notification-service.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/config/loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: OpenAPI schemas + 3 notification admin endpoints + DI wiring</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
**1. Add OpenAPI Zod schemas in openapi-schemas.ts:**

Add these response schemas (follow existing pattern with z from @hono/zod-openapi):

```typescript
// Notification channel status (no credentials!)
export const NotificationChannelStatusSchema = z.object({
  name: z.string(),           // "telegram" | "discord" | "ntfy"
  enabled: z.boolean(),       // true if channel is configured and active
}).openapi('NotificationChannelStatus');

export const NotificationStatusResponseSchema = z.object({
  enabled: z.boolean(),       // master notifications.enabled flag
  channels: z.array(NotificationChannelStatusSchema),
}).openapi('NotificationStatusResponse');

// Test notification
export const NotificationTestRequestSchema = z.object({
  channel: z.string().optional(),  // specific channel name, or omit for all active
}).openapi('NotificationTestRequest');

export const NotificationTestResponseSchema = z.object({
  results: z.array(z.object({
    channel: z.string(),
    success: z.boolean(),
    error: z.string().optional(),
  })),
}).openapi('NotificationTestResponse');

// Notification log query (paginated)
export const NotificationLogEntrySchema = z.object({
  id: z.string(),
  eventType: z.string(),
  agentId: z.string().nullable(),
  channel: z.string(),
  status: z.string(),
  error: z.string().nullable(),
  createdAt: z.number(),       // epoch seconds
}).openapi('NotificationLogEntry');

export const NotificationLogResponseSchema = z.object({
  logs: z.array(NotificationLogEntrySchema),
  total: z.number(),
  page: z.number(),
  pageSize: z.number(),
}).openapi('NotificationLogResponse');
```

**2. Add 3 notification routes to admin.ts:**

Extend `AdminRouteDeps` interface to add:
- `notificationService?: NotificationService` (import type from notification-service.ts)
- `notificationConfig?: { enabled: boolean; telegram_bot_token: string; telegram_chat_id: string; discord_webhook_url: string; ntfy_topic: string; ntfy_server: string }` (for status check -- but NEVER return these values to the client)

Add 3 route definitions using createRoute():

**GET /admin/notifications/status** (masterAuth):
- Check if notifications are enabled via `deps.notificationConfig?.enabled`
- For each of the 3 channels (telegram, discord, ntfy), report enabled=true if:
  - telegram: notificationConfig has telegram_bot_token AND telegram_chat_id AND notificationService has 'telegram' in getChannelNames()
  - discord: notificationConfig has discord_webhook_url AND notificationService has 'discord' in getChannelNames()
  - ntfy: notificationConfig has ntfy_topic AND notificationService has 'ntfy' in getChannelNames()
- CRITICAL: Never include token/URL/topic values in the response. Only boolean "enabled" status.
- Return NotificationStatusResponseSchema

**POST /admin/notifications/test** (masterAuth):
- Accept optional `{ channel?: string }` body (NotificationTestRequestSchema)
- If channel specified, send test only to that channel; else send to all active
- Use `notificationService.notify('TX_CONFIRMED', 'test-agent', { amount: '0.001', token: 'SOL', to: 'test-address' })` as the test payload (TX_CONFIRMED is a good test event because it's non-critical)
- Actually, better approach: Call channel.send() directly for specific channel testing to get per-channel results. Since NotificationService only exposes notify() which does fallback/broadcast, create a `sendTest()` method on NotificationService that returns per-channel results. Alternative simpler approach: use notify() which logs to notification_logs, then query the log to get results. Simplest approach: Add a `testNotify()` method to NotificationService that sends to specified channels and returns results array.
- For now, the simplest approach that works: Call `notificationService.notify()` with the test event, then immediately query notification_logs for the most recent entries to determine per-channel results. This avoids modifying NotificationService.
- Actually even simpler: Add `getChannels(): INotificationChannel[]` getter to NotificationService. In the route handler, iterate active channels, call `channel.send()` in try/catch, collect results. This keeps it clean.
- Decision: Add `getChannels(): INotificationChannel[]` method to NotificationService. The admin route handler iterates channels (optionally filtered by name), sends a test payload to each, catches errors, returns per-channel success/failure.
- Add `getChannels()` to NotificationService (packages/daemon/src/notifications/notification-service.ts):
  ```typescript
  getChannels(): INotificationChannel[] { return [...this.channels]; }
  ```
- In the route handler, build a test NotificationPayload manually (eventType: 'TX_CONFIRMED' as test, message, agentId: 'admin-test', timestamp), send to each matching channel, collect results.
- Return NotificationTestResponseSchema

**GET /admin/notifications/log** (masterAuth):
- Accept query params: `page` (default 1), `pageSize` (default 20, max 100), `channel` (optional filter), `status` (optional filter)
- Query notification_logs table with Drizzle: order by createdAt DESC, apply filters, LIMIT+OFFSET for pagination
- Also query COUNT(*) for total
- Return NotificationLogResponseSchema with logs array, total, page, pageSize
- Convert createdAt Date to epoch seconds (getTime()/1000) for JSON response

**Add query parameter schemas for the log endpoint:**
```typescript
const notificationLogQuerySchema = z.object({
  page: z.string().optional().transform(v => Math.max(1, parseInt(v ?? '1', 10) || 1)),
  pageSize: z.string().optional().transform(v => Math.min(100, Math.max(1, parseInt(v ?? '20', 10) || 20))),
  channel: z.string().optional(),
  status: z.string().optional(),
});
```
Use Hono's query validation via createRoute request.query definition.

**3. Wire notificationService + notificationConfig to adminRoutes in server.ts:**

In the existing adminRoutes({...}) call in createApp(), add:
- `notificationService: deps.notificationService`
- `notificationConfig: deps.config?.notifications` (pass the raw config section -- admin.ts reads it but never returns credentials)

**4. Add masterAuth middleware for new routes in server.ts:**

In the masterAuth registration section, add:
```typescript
app.use('/v1/admin/notifications/*', masterAuthForAdmin);
```
(Add this alongside the existing /v1/admin/* masterAuth registrations.)
  </action>
  <verify>
- `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/daemon` succeeds
- No TypeScript errors
  </verify>
  <done>
- 3 new endpoints registered: GET /admin/notifications/status, POST /admin/notifications/test, GET /admin/notifications/log
- AdminRouteDeps extended with notificationService and notificationConfig
- NotificationService has getChannels() method
- server.ts passes notificationService and config to adminRoutes
- masterAuth protects all 3 new endpoints
- No credentials (bot tokens, webhook URLs) appear in any API response
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin notification API endpoint tests</name>
  <files>
    packages/daemon/src/__tests__/admin-notification-api.test.ts
  </files>
  <action>
Create test file following existing test patterns (see route-notification.test.ts and the existing admin route tests).

**Test setup:**
- Use vitest (describe, it, expect, vi)
- Create in-memory SQLite DB with Drizzle, run migrations (createMigratedDb pattern from existing tests)
- Import createApp and create test app instance
- Use Hono's app.request() for HTTP testing (not supertest)
- Mock masterAuth by passing masterPasswordHash and including X-Master-Password header

**Tests (aim for 8-10):**

1. **GET /admin/notifications/status returns channel status** - Set up NotificationService with telegram channel, verify response has enabled:true and channels array with telegram enabled
2. **GET /admin/notifications/status returns all channels disabled when no service** - No notificationService, verify enabled:false and all channels show enabled:false
3. **GET /admin/notifications/status never exposes credentials** - Verify response JSON does NOT contain any of: bot_token, webhook_url, ntfy_topic, telegram_bot_token, discord_webhook_url (string search on serialized response)
4. **GET /admin/notifications/status requires masterAuth** - No X-Master-Password header, expect 401
5. **POST /admin/notifications/test sends test to active channels** - Mock channel.send(), verify it's called, response has results array with success:true
6. **POST /admin/notifications/test returns failure for broken channel** - Mock channel.send() to throw, verify results has success:false with error message
7. **POST /admin/notifications/test requires masterAuth** - No auth header, expect 401
8. **GET /admin/notifications/log returns paginated logs** - Insert test notification_logs rows into DB, query with page/pageSize, verify pagination
9. **GET /admin/notifications/log filters by channel** - Insert logs for telegram and discord, filter by channel=telegram, verify only telegram logs returned
10. **GET /admin/notifications/log returns empty when no logs** - Empty DB, verify logs:[], total:0

For the NotificationService mock in tests: Create a real NotificationService instance and add mock channels (objects implementing INotificationChannel with vi.fn() for send).

For the test DB: Use the same in-memory SQLite setup pattern as notification-log.test.ts (drizzle(new Database(':memory:')) + run migration DDL).
  </action>
  <verify>
- `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/daemon/src/__tests__/admin-notification-api.test.ts` -- all tests pass
- `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo test --filter=@waiaas/daemon` -- no regressions
  </verify>
  <done>
- 8-10 tests covering all 3 notification admin endpoints
- Tests verify credential masking (no tokens/URLs in responses)
- Tests verify masterAuth protection
- Tests verify pagination, filtering, and empty states
- All existing daemon tests continue passing
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` -- full monorepo builds without errors
2. `npx turbo test --filter=@waiaas/daemon` -- all daemon tests pass (existing + new)
3. Manual: `curl http://localhost:7420/v1/admin/notifications/status -H 'X-Master-Password: ...'` returns channel status without credentials
4. Manual: `curl http://localhost:7420/doc` shows new endpoints in OpenAPI spec
</verification>

<success_criteria>
- 3 new admin notification endpoints functional
- OpenAPI schemas registered and visible in /doc
- No credentials leaked in any response
- All masterAuth-protected endpoints return 401 without auth
- Paginated log query works with offset/limit
- 8+ new tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/75-admin-notification-api-ui/75-01-SUMMARY.md`
</output>
