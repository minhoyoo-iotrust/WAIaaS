---
phase: 75-admin-notification-api-ui
plan: 02
type: execute
wave: 2
depends_on: ["75-01"]
files_modified:
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/pages/notifications.tsx
  - packages/admin/src/components/layout.tsx
  - packages/admin/src/styles/global.css
  - packages/admin/src/__tests__/notifications.test.tsx
autonomous: true

must_haves:
  truths:
    - "Admin UI displays Telegram/Discord/Ntfy channel status (connected/not configured)"
    - "Admin UI sends test notification to active channels and shows result"
    - "Admin UI shows paginated notification delivery log table"
    - "Admin UI displays config.toml settings change guidance"
  artifacts:
    - path: "packages/admin/src/pages/notifications.tsx"
      provides: "Notifications page with channel status, test send, log table, config guidance"
      min_lines: 100
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "API endpoint constants for notification routes"
      contains: "ADMIN_NOTIFICATIONS_STATUS"
    - path: "packages/admin/src/components/layout.tsx"
      provides: "Navigation link for Notifications page"
      contains: "notifications"
    - path: "packages/admin/src/__tests__/notifications.test.tsx"
      provides: "UI tests for notifications page"
  key_links:
    - from: "packages/admin/src/pages/notifications.tsx"
      to: "/v1/admin/notifications/status"
      via: "apiGet(API.ADMIN_NOTIFICATIONS_STATUS)"
      pattern: "apiGet.*ADMIN_NOTIFICATIONS"
    - from: "packages/admin/src/components/layout.tsx"
      to: "packages/admin/src/pages/notifications.tsx"
      via: "hash router"
      pattern: "notifications"
---

<objective>
Add Notifications page to admin UI with channel status cards, test send button, delivery log table, and config.toml guidance.

Purpose: Give administrators a browser-based view into notification system health, ability to verify channel connectivity via test sends, and browse delivery history -- all without needing CLI access.

Output: Notifications page (Preact), nav link, CSS, endpoint constants, tests
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/75-admin-notification-api-ui/75-01-SUMMARY.md
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/components/layout.tsx
@packages/admin/src/components/table.tsx
@packages/admin/src/components/form.tsx
@packages/admin/src/components/toast.tsx
@packages/admin/src/pages/settings.tsx
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/styles/global.css
@packages/admin/src/__tests__/settings.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notifications page + nav integration + endpoint constants + CSS</name>
  <files>
    packages/admin/src/api/endpoints.ts
    packages/admin/src/pages/notifications.tsx
    packages/admin/src/components/layout.tsx
    packages/admin/src/styles/global.css
  </files>
  <action>
**1. Add endpoint constants in endpoints.ts:**

```typescript
ADMIN_NOTIFICATIONS_STATUS: '/v1/admin/notifications/status',
ADMIN_NOTIFICATIONS_TEST: '/v1/admin/notifications/test',
ADMIN_NOTIFICATIONS_LOG: '/v1/admin/notifications/log',
```

**2. Add nav link in layout.tsx:**

Add to `NAV_ITEMS` array (between Policies and Settings):
```typescript
{ path: '/notifications', label: 'Notifications' },
```

Add to `PAGE_TITLES`:
```typescript
'/notifications': 'Notifications',
```

Add to `PageRouter()`:
```typescript
if (path === '/notifications') return <NotificationsPage />;
```

Import NotificationsPage:
```typescript
import NotificationsPage from '../pages/notifications';
```

**3. Create notifications.tsx page:**

Follow the pattern from settings.tsx (useSignal for state, useEffect for fetch, apiGet/apiPost, showToast, Badge/Button).

**Interfaces:**
```typescript
interface ChannelStatus {
  name: string;
  enabled: boolean;
}

interface NotificationStatus {
  enabled: boolean;
  channels: ChannelStatus[];
}

interface TestResult {
  channel: string;
  success: boolean;
  error?: string;
}

interface NotificationLogEntry {
  id: string;
  eventType: string;
  agentId: string | null;
  channel: string;
  status: string;
  error: string | null;
  createdAt: number;
}

interface NotificationLogResponse {
  logs: NotificationLogEntry[];
  total: number;
  page: number;
  pageSize: number;
}
```

**Page structure (4 sections):**

**Section 1: Channel Status Cards**
- Fetch GET /admin/notifications/status on mount
- Show 3 cards (telegram, discord, ntfy) each with:
  - Channel name (capitalized)
  - Badge: "Connected" (variant=success) if enabled, "Not Configured" (variant=neutral) if not
- If master enabled=false, show info banner: "Notifications are disabled. Set notifications.enabled = true in config.toml"
- Use the stat-card CSS pattern from dashboard.tsx (3-column grid)

**Section 2: Test Notification**
- "Send Test" button (disabled if no channels are enabled)
- On click: POST /admin/notifications/test with empty body (tests all active channels)
- Show results inline: for each channel, show success (green check) or failure (red x + error message)
- Use loading state while sending
- Show toast on completion ("Test sent successfully" or "Some channels failed")

**Section 3: Delivery Log Table**
- Fetch GET /admin/notifications/log?page=1&pageSize=20 on mount
- Use the Table component from components/table.tsx
- Columns: Event Type, Agent ID, Channel, Status (Badge: sent=success, failed=danger), Time (formatDate)
- Pagination: Previous/Next buttons, page X of Y display
- Auto-refresh every 30 seconds (like dashboard pattern)
- Page size: 20

**Section 4: Configuration Guidance (read-only info box)**
- Gray info box at the bottom:
  ```
  Notification channels are configured via config.toml. To add or modify channels:

  [notifications]
  enabled = true
  telegram_bot_token = "your-bot-token"
  telegram_chat_id = "your-chat-id"
  discord_webhook_url = "https://discord.com/api/webhooks/..."
  ntfy_topic = "your-topic"

  Restart the daemon after changing notification settings.
  ```
- Style this as an info callout box (light blue background, border)

**State management:**
- Use useSignal for all state (Preact signals pattern, not useState)
- isInitialLoad pattern for skeleton (same as dashboard)
- Separate loading states for status fetch, test send, and log fetch

**4. Add CSS in global.css:**

Add notification page styles:
```css
/* Notification page */
.channel-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); margin-bottom: var(--space-6); }
.channel-card { padding: var(--space-4); border: 1px solid var(--color-border); border-radius: var(--radius-lg); background: var(--color-bg); }
.channel-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); }
.channel-card-name { font-weight: var(--font-weight-semibold); font-size: var(--font-size-base); text-transform: capitalize; }

.test-results { margin-top: var(--space-4); }
.test-result-item { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) 0; }
.test-result-success { color: var(--color-success); }
.test-result-failure { color: var(--color-danger); }

.config-guidance { margin-top: var(--space-6); padding: var(--space-4); background: var(--color-info-bg); border: 1px solid var(--color-info); border-radius: var(--radius-md); font-size: var(--font-size-sm); }
.config-guidance pre { margin-top: var(--space-2); padding: var(--space-3); background: var(--color-bg-tertiary); border-radius: var(--radius-sm); font-family: monospace; font-size: var(--font-size-xs); overflow-x: auto; white-space: pre; }
.config-guidance p { color: var(--color-text-secondary); margin-bottom: var(--space-2); }

.pagination { display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-4); }
.pagination-info { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.pagination-buttons { display: flex; gap: var(--space-2); }

.notif-disabled-banner { padding: var(--space-3) var(--space-4); background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md); margin-bottom: var(--space-4); font-size: var(--font-size-sm); color: var(--color-text); }
```

Responsive: At small widths, channel-grid becomes single column:
```css
@media (max-width: 768px) {
  .channel-grid { grid-template-columns: 1fr; }
}
```
  </action>
  <verify>
- `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/admin` succeeds
- No TypeScript errors
  </verify>
  <done>
- Notifications page renders 4 sections: channel status, test send, delivery log, config guidance
- Nav sidebar includes "Notifications" link between "Policies" and "Settings"
- Table component reused for log display with pagination
- Badge shows connected/not-configured status per channel
- config.toml guidance section visible with example configuration
- CSS responsive grid for channel cards
  </done>
</task>

<task type="auto">
  <name>Task 2: Notifications page UI tests</name>
  <files>
    packages/admin/src/__tests__/notifications.test.tsx
  </files>
  <action>
Create test file following the established pattern from settings.test.tsx:

**Mock setup (copy from settings.test.tsx pattern):**
```typescript
vi.mock('../api/client', () => ({
  apiGet: vi.fn(),
  apiPost: vi.fn(),
  apiPut: vi.fn(),
  apiDelete: vi.fn(),
  ApiError: class ApiError extends Error { ... },
  apiCall: vi.fn(),
}));
vi.mock('../components/toast', () => ({ showToast: vi.fn(), ToastContainer: () => null }));
vi.mock('../auth/store', () => ({
  masterPassword: { value: 'test-pw' },
  isAuthenticated: { value: true },
  adminTimeout: { value: 900 },
  daemonShutdown: { value: false },
  login: vi.fn(), logout: vi.fn(), resetInactivityTimer: vi.fn(),
}));
vi.mock('../utils/error-messages', () => ({ getErrorMessage: (code: string) => `Error: ${code}` }));
```

**Mock data:**
```typescript
const mockStatus = {
  enabled: true,
  channels: [
    { name: 'telegram', enabled: true },
    { name: 'discord', enabled: false },
    { name: 'ntfy', enabled: true },
  ],
};

const mockLogs = {
  logs: [
    { id: '1', eventType: 'TX_CONFIRMED', agentId: 'agent-1', channel: 'telegram', status: 'sent', error: null, createdAt: 1707609600 },
    { id: '2', eventType: 'TX_FAILED', agentId: 'agent-2', channel: 'discord', status: 'failed', error: 'Webhook error', createdAt: 1707609500 },
  ],
  total: 2,
  page: 1,
  pageSize: 20,
};
```

**Tests (6-8):**

1. **Displays channel status cards** - Mock apiGet to return mockStatus for status + mockLogs for log, render page, verify "telegram" card shows "Connected" badge, "discord" shows "Not Configured"
2. **Displays disabled banner when notifications disabled** - Mock status with enabled:false, verify warning banner text about config.toml
3. **Send Test button triggers POST and shows results** - Mock apiGet for status (with enabled channels) + logs, click "Send Test", verify apiPost called with /admin/notifications/test, mock success response, verify success result displayed
4. **Displays notification log table** - Mock status + logs, verify table shows TX_CONFIRMED, TX_FAILED rows with correct channel and status badges
5. **Pagination controls work** - Mock logs with total:25, verify "Page 1 of 2" text, click Next, verify apiGet called with page=2
6. **Shows config.toml guidance section** - Verify page contains "config.toml" text and example configuration snippet
7. **Send Test disabled when no channels active** - Mock status with all channels disabled, verify Send Test button is disabled
8. **Shows error message for failed test channels** - Mock test POST to return results with success:false + error, verify error message displayed

Each test: render -> waitFor -> assert. Follow cleanup pattern (afterEach cleanup + clearAllMocks).

Note: The apiGet mock needs to handle both status and log fetches. Use mockImplementation that checks the URL path to return appropriate data, or use mockResolvedValueOnce in sequence (status is fetched first, then logs).
  </action>
  <verify>
- `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/admin/src/__tests__/notifications.test.tsx` -- all tests pass
- `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo test --filter=@waiaas/admin` -- no regressions
  </verify>
  <done>
- 6-8 tests covering all 4 notification page sections
- Tests verify channel status display (connected vs not configured)
- Tests verify test send flow (button click -> API call -> results)
- Tests verify log table rendering with pagination
- Tests verify config.toml guidance is visible
- All existing admin tests continue passing
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` -- full monorepo builds without errors
2. `npx turbo test --filter=@waiaas/admin` -- all admin tests pass (existing + new)
3. Manual: Open http://localhost:7420/admin/ -- Notifications nav link visible, page loads with channel cards
4. Manual: Channel status shows connected/not-configured badges matching config.toml settings
5. Manual: config.toml guidance section visible with example configuration
</verification>

<success_criteria>
- Notifications page accessible via sidebar navigation
- Channel status cards display for all 3 channels
- Test send button works for active channels
- Delivery log table with pagination
- config.toml guidance section present
- 6+ new UI tests passing
- No regressions in existing admin tests
</success_criteria>

<output>
After completion, create `.planning/phases/75-admin-notification-api-ui/75-02-SUMMARY.md`
</output>
