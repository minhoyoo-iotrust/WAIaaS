---
phase: 23-transaction-type-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/58-contract-call-spec.md
autonomous: true

must_haves:
  truths:
    - "ContractCallRequest 인터페이스가 EVM calldata(0x hex)와 Solana programId+instructionData(Base64)+accounts를 모두 표현할 수 있다"
    - "CONTRACT_WHITELIST 정책이 기본 전면 거부(opt-in)로 동작하고, 미설정 시 CONTRACT_CALL 자체를 거부한다"
    - "METHOD_WHITELIST 정책이 4바이트 function selector 기반으로 허용된 메서드만 통과시킨다"
    - "파이프라인 Stage 1-5에 CONTRACT_CALL/APPROVE/BATCH type 분기가 설계되어 있다"
    - "transactions 테이블에 TransactionType Enum(5개), 감사 컬럼(contract_address, method_signature, token_address, spender_address), 인덱스가 명세되어 있다"
    - "POST /v1/transactions/send가 z.discriminatedUnion('type', [...])으로 다형적 요청을 수신한다"
    - "에러 코드 10개가 정의되어 있고, CONTRACT_CALL 보안 테스트 시나리오가 명세되어 있다"
  artifacts:
    - path: "docs/58-contract-call-spec.md"
      provides: "CHAIN-EXT-03 컨트랙트 호출 스펙 + 파이프라인/DB/REST 크로스커팅 확장"
      contains: "ContractCallRequest"
  key_links:
    - from: "docs/58-contract-call-spec.md"
      to: "docs/32-transaction-pipeline-api.md"
      via: "Stage 1 type 분기, Stage 2 allowedContracts, Stage 3 CONTRACT_WHITELIST/METHOD_WHITELIST"
    - from: "docs/58-contract-call-spec.md"
      to: "docs/25-sqlite-schema.md"
      via: "TransactionType Enum 5개 + 감사 컬럼 4개"
    - from: "docs/58-contract-call-spec.md"
      to: "docs/37-rest-api-complete-spec.md"
      via: "discriminatedUnion 다형적 요청, 에러 코드 10개"
---

<objective>
ContractCallRequest 인터페이스와 화이트리스트 정책(CONTRACT_WHITELIST, METHOD_WHITELIST)을 설계하고, 3가지 새 트랜잭션 타입(CONTRACT_CALL, APPROVE, BATCH)을 수용하는 파이프라인/DB/REST API 크로스커팅 확장을 정의한다.

Purpose: Phase 23의 3가지 트랜잭션 타입은 모두 파이프라인 Stage 1 type 분기, DB TransactionType Enum 확장, REST API 다형적 요청이라는 공통 기반이 필요하다. 이 플랜이 그 기반을 ContractCallRequest와 함께 정의하여 23-02(Approve)와 23-03(Batch)가 독립적으로 확장할 수 있게 한다.
Output: docs/58-contract-call-spec.md (CHAIN-EXT-03)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-transaction-type-extension/23-RESEARCH.md
@docs/56-token-transfer-extension-spec.md
@docs/27-chain-adapter-interface.md
@docs/32-transaction-pipeline-api.md
@docs/33-time-lock-approval-mechanism.md
@docs/25-sqlite-schema.md
@docs/37-rest-api-complete-spec.md
@docs/45-enum-unified-mapping.md
@docs/31-solana-adapter-detail.md
@docs/36-killswitch-autostop-evm.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ContractCallRequest 인터페이스 + 화이트리스트 정책 + 체인별 빌드 로직 설계</name>
  <files>docs/58-contract-call-spec.md</files>
  <action>
docs/58-contract-call-spec.md 파일을 생성한다. 한글로 작성하며, 다음 섹션을 포함한다:

**섹션 1: 개요** (~50줄)
- 문서 메타데이터: 문서 ID(CHAIN-EXT-03), 작성일, Phase 23, 참조 문서 목록
- 요구사항 매핑: CONTRACT-01~05 + APPROVE/BATCH 크로스커팅 참조
- 핵심 설계 원칙 5개: (1) 기본 전면 거부 (opt-in), (2) IChainAdapter 저수준 유지, (3) 6단계 파이프라인 구조 변경 없음, (4) 서비스 레이어 type 분기, (5) Phase 22 패턴 계승 (token? -> type 분기)
- v0.6 핵심 결정 인용: "임의 컨트랙트 호출은 기본 거부 (opt-in 화이트리스트)"

**섹션 2: ContractCallRequest 인터페이스** (~120줄)
- TypeScript 인터페이스 정의:
  ```typescript
  interface ContractCallRequest {
    from: string           // 에이전트 주소
    to: string             // 컨트랙트/프로그램 주소
    value?: bigint         // 네이티브 토큰 첨부량 (기본 0n)
    // EVM 전용
    calldata?: string      // ABI 인코딩된 호출 데이터 (0x hex)
    abi?: object[]         // 선택적 ABI (METHOD_WHITELIST 검증, 감사 로그)
    // Solana 전용
    programId?: string     // 프로그램 주소 (Base58)
    instructionData?: string  // Base64 인코딩된 instruction data
    accounts?: AccountMetaInput[]  // 계정 메타 목록
  }

  interface AccountMetaInput {
    address: string        // 계정 주소
    isSigner: boolean      // 서명자 여부
    isWritable: boolean    // 쓰기 가능 여부
  }
  ```
- EVM vs Solana 필수 필드 표:
  - EVM: to(컨트랙트), calldata(필수, 빈 calldata 금지), value(선택), abi(선택)
  - Solana: to(= programId와 동일), programId, instructionData(필수), accounts(필수)
- Zod 스키마 정의 (ContractCallRequestSchema):
  - `.refine()` 으로 EVM/Solana 필수 필드 교차 검증
  - calldata 빈 값('0x') 거부 (fallback 트리거 방지)
- TransferRequest와의 시맨틱 차이 비교 표

**섹션 3: 체인별 빌드 로직** (~150줄)
- EVM ContractCall 빌드:
  - calldata가 제공된 경우: viem의 `writeContract()` 또는 `sendTransaction({ data: calldata })`
  - abi + functionName 제공된 경우: viem `encodeFunctionData()` -> calldata 생성
  - value > 0인 경우: payable 함수 호출, value를 tx에 첨부
  - 시뮬레이션: `eth_call` 또는 `simulateContract()` (Stage 4에서 수행)
  - gas 추정: `estimateContractGas()` 사용, 결과 * 1.2 상한
- Solana ContractCall 빌드:
  - @solana/kit pipe 패턴으로 instruction 구성
  - AccountMetaInput -> AccountRole 변환 (isSigner + isWritable -> writable_signer/writable/readonly_signer/readonly)
  - instructionData: Base64 -> Uint8Array 디코딩
  - compute unit 추정: simulateTransaction() CU 소비량 확인
- 서비스 레이어 분기 pseudo-code: request.type === 'CONTRACT_CALL' -> buildContractCall()
- IChainAdapter 인터페이스 변경 논의: 기존 buildTransaction()에 유니온 입력 또는 서비스 레이어에서 별도 호출. **결정: 서비스 레이어에서 type별 빌드 함수 호출. IChainAdapter는 buildTransaction(TransferRequest | ContractCallRequest) 유니온 확장.** IChainAdapter 인터페이스는 Phase 25에서 정식 반영.

**섹션 4: CONTRACT_WHITELIST 정책 규칙** (~100줄)
- PolicyType: 'CONTRACT_WHITELIST' 추가 (총 6개째)
- Zod 스키마: ContractWhitelistRuleSchema
  ```typescript
  {
    allowed_contracts: Array<{
      address: string      // 컨트랙트/프로그램 주소
      label?: string       // 사람 가독 라벨 (감사 로그용)
      chain?: ChainType    // 해당 체인 (미지정 시 모든 체인)
    }>
  }
  ```
- 평가 로직 pseudo-code:
  1. CONTRACT_WHITELIST 정책이 에이전트에 없으면 -> DENY (CONTRACT_CALL_DISABLED)
  2. allowed_contracts가 빈 배열이면 -> DENY (CONTRACT_NOT_WHITELISTED)
  3. request.to가 allowed_contracts[].address에 없으면 -> DENY (CONTRACT_NOT_WHITELISTED)
  4. chain 필드가 지정되어 있고 현재 체인과 다르면 -> DENY
  5. 통과 -> ALLOW, 다음 정책 평가 진행
- 보안 근거: v0.6 핵심 결정 "기본 전면 거부" + 23-RESEARCH.md Pitfall 2

**섹션 5: METHOD_WHITELIST 정책 규칙** (~100줄)
- PolicyType: 'METHOD_WHITELIST' 추가 (총 7개째)
- Zod 스키마: MethodWhitelistRuleSchema
  ```typescript
  {
    contract_methods: Array<{
      contract_address: string   // 컨트랙트 주소
      allowed_selectors?: string[]  // 4바이트 function selector (0x + 8 hex)
      allowed_signatures?: string[] // 사람 가독 시그니처 (예: 'transfer(address,uint256)')
    }>
  }
  ```
- 평가 로직:
  1. METHOD_WHITELIST 정책이 없으면 -> 해당 컨트랙트의 모든 메서드 허용 (CONTRACT_WHITELIST만으로 충분)
  2. contract_methods에 해당 contract_address 항목이 없으면 -> 모든 메서드 허용
  3. 항목이 있으면 calldata 첫 4바이트(selector) 추출
  4. allowed_selectors에 selector가 없으면 -> DENY (METHOD_NOT_WHITELISTED)
  5. allowed_signatures가 있으면 부가 검증 (감사 로그에 시그니처 기록)
- EVM selector 추출: `calldata.slice(0, 10)` (0x + 8 hex chars)
- Solana 대응: Solana 프로그램은 표준화된 selector 규약이 없으므로, 23-RESEARCH.md에 따라 METHOD_WHITELIST는 EVM 전용. Solana CONTRACT_CALL은 CONTRACT_WHITELIST만 적용.

**섹션 6: 파이프라인 확장 (Stage 1-5)** (~200줄) -- 크로스커팅 (APPROVE, BATCH 포함)
- **Stage 1 (RECEIVE) 확장:**
  - TransactionSendRequestSchema = z.discriminatedUnion('type', [...]) 5가지 variant
  - TRANSFER, TOKEN_TRANSFER (Phase 22), CONTRACT_CALL, APPROVE, BATCH (Phase 23)
  - 각 variant의 필수/선택 필드 명세
  - type별 Zod 스키마 정의 (ContractCallVariant, ApproveVariant, BatchVariant)

- **Stage 2 (SESSION VALIDATE) 확장:**
  - SessionConstraints.allowedOperations 확장: CONTRACT_CALL, APPROVE, BATCH 추가
  - 신규 세션 제약 필드:
    - allowedContracts?: string[] -- CONTRACT_CALL에서 이 세션이 호출 가능한 컨트랙트 목록
    - allowedSpenders?: string[] -- APPROVE에서 이 세션이 승인 가능한 spender 목록
  - 검증 로직: allowedContracts가 설정되어 있으면 request.to가 목록에 포함되는지 확인

- **Stage 3 (POLICY CHECK) 확장:**
  - DatabasePolicyEngine.evaluate() 입력 확장:
    ```typescript
    interface PolicyEvaluationInput {
      type: TransactionType           // Phase 23 확장
      amount: bigint
      to: string
      chain: ChainType
      contractAddress?: string        // CONTRACT_CALL 전용
      methodSignature?: string        // CONTRACT_CALL 전용 (EVM selector)
      spender?: string                // APPROVE 전용
      approveAmount?: bigint          // APPROVE 전용
      tokenAddress?: string           // TOKEN_TRANSFER, APPROVE 전용
      batchTotalAmount?: bigint       // BATCH 전용 (합산 금액)
      batchInstructions?: Array<{...}>  // BATCH 전용 (개별 정책 평가용)
    }
    ```
  - 평가 순서 (11단계): 기존 6단계 + 5단계 추가
    1. 에이전트별 + 글로벌 활성 정책 로드
    2. WHITELIST 평가
    3. TIME_RESTRICTION 평가
    4. RATE_LIMIT 평가
    5. ALLOWED_TOKENS 평가 (TOKEN_TRANSFER, APPROVE 시)
    6. CONTRACT_WHITELIST 평가 (CONTRACT_CALL 시)
    7. METHOD_WHITELIST 평가 (CONTRACT_CALL 시, EVM 전용)
    8. APPROVED_SPENDERS 평가 (APPROVE 시) -- 23-02에서 상세 설계
    9. APPROVE_AMOUNT_LIMIT 평가 (APPROVE 시) -- 23-02에서 상세 설계
    10. APPROVE_TIER_OVERRIDE 평가 (APPROVE 시) -- 23-02에서 상세 설계
    11. SPENDING_LIMIT 평가 -> 4-티어 분류 (BATCH는 batchTotalAmount)
  - DENY 우선 원칙: 어떤 단계에서든 DENY가 나오면 즉시 반환
  - type별 적용 정책 매트릭스 표

- **Stage 4 (TIER CLASSIFY) 확장:**
  - CONTRACT_CALL 기본 티어: APPROVAL (보수적, Owner 승인 필수)
  - value > 0인 CONTRACT_CALL: value를 SPENDING_LIMIT에 반영
  - APPROVE 티어: APPROVE_TIER_OVERRIDE로 독립 결정 (23-02에서 상세)
  - BATCH 티어: 개별 instruction 금액 합산으로 결정

- **Stage 5 (EXECUTE) 확장:**
  - type 분기 pseudo-code:
    ```
    switch (request.type) {
      case 'TRANSFER': adapter.buildTransaction(transferRequest)
      case 'TOKEN_TRANSFER': adapter.buildTransaction(transferRequest) // token 분기
      case 'CONTRACT_CALL': adapter.buildContractCall(contractCallRequest)
      case 'APPROVE': adapter.buildApprove(approveRequest) // 23-02
      case 'BATCH': adapter.buildBatch(batchRequest) // 23-03
    }
    ```

**섹션 7: DB 스키마 확장** (~100줄) -- 크로스커팅
- TransactionType Enum 정식화 (5개 값):
  - TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH
  - Zod Enum 스키마 + Drizzle text column CHECK 제약
- PolicyType Enum 확장 (총 10개):
  - 기존 5개 + CONTRACT_WHITELIST, METHOD_WHITELIST, APPROVED_SPENDERS, APPROVE_AMOUNT_LIMIT, APPROVE_TIER_OVERRIDE
- 감사 컬럼 4개 추가:
  - contract_address TEXT -- CONTRACT_CALL/APPROVE: 컨트랙트/토큰 주소
  - method_signature TEXT -- CONTRACT_CALL: 함수 시그니처
  - token_address TEXT -- TOKEN_TRANSFER/APPROVE: 토큰 주소
  - spender_address TEXT -- APPROVE: spender 주소
- Drizzle ORM 확장 코드 (transactions 테이블)
- 인덱스: idx_transactions_contract_address, idx_transactions_spender_address
- 마이그레이션 전략: Drizzle push 기반, CHECK 제약은 SQLite 테이블 재생성

**섹션 8: REST API 확장** (~100줄) -- 크로스커팅
- POST /v1/transactions/send 스키마 확장:
  - TransactionSendRequestSchema = z.discriminatedUnion('type', [5개 variant])
  - 각 variant 상세 Zod 스키마
- 에러 코드 10개 추가 (37-rest-api-complete-spec.md 확장):
  - CONTRACT_NOT_WHITELISTED (403), METHOD_NOT_WHITELISTED (403)
  - SPENDER_NOT_APPROVED (403), APPROVE_AMOUNT_EXCEEDED (403), UNLIMITED_APPROVE_BLOCKED (403)
  - BATCH_NOT_SUPPORTED (400), BATCH_SIZE_EXCEEDED (400), BATCH_POLICY_VIOLATION (403)
  - CONTRACT_CALL_DISABLED (403), APPROVE_DISABLED (403)
- 응답 스키마: 기존 TransactionResponse 재사용 (id, status, tier, txHash)

**섹션 9: CONTRACT_CALL 보안 가이드라인 + 테스트 시나리오** (~100줄)
- 보안 위험 매트릭스 (5개 위험 + 완화 방안) -- 23-RESEARCH.md 참조
- 테스트 레벨:
  - Level 1 (Unit): ContractCallRequest Zod 검증, selector 추출, 정책 평가 로직
  - Level 2 (Integration): 파이프라인 Stage 1-5 통합 (Mock Adapter)
  - Level 3 (Chain Mock): EVM Hardhat/Anvil 임의 컨트랙트 배포 + 호출
  - Level 4 (Security): 비화이트리스트 컨트랙트, 비화이트리스트 메서드, calldata 없는 호출, 과도한 value 첨부
- Mock 경계: IChainAdapter.buildContractCall, DatabasePolicyEngine.evaluate, RPC client
- 시나리오 12개 이상 (정상 2, 정책 거부 5, 에러 3, 보안 2)

**섹션 10: 기존 문서 영향 분석** (~50줄)
- Phase 25에서 수정이 필요한 기존 문서 목록 + 변경 범위:
  - 27-chain-adapter: buildTransaction 유니온 확장, buildContractCall 추가
  - 25-sqlite-schema: TransactionType CHECK, 감사 컬럼 4개
  - 32-transaction-pipeline: Stage 1-5 확장 반영
  - 33-time-lock: PolicyType 10개, evaluate() 11단계
  - 37-rest-api: discriminatedUnion 요청, 에러 코드 10개
  - 45-enum: TransactionType 5개, PolicyType 10개

문서 총 분량 목표: 약 1000-1200줄 (56-token-transfer-extension-spec.md 대비 비슷한 깊이).
문서 작성 언어: 한글.
코드 블록 내 주석은 한글.
  </action>
  <verify>
- docs/58-contract-call-spec.md 파일이 존재한다
- 파일 분량이 900줄 이상이다 (`wc -l docs/58-contract-call-spec.md`)
- ContractCallRequest 인터페이스가 정의되어 있다 (grep 'ContractCallRequest')
- CONTRACT_WHITELIST, METHOD_WHITELIST 정책 스키마가 정의되어 있다
- TransactionSendRequestSchema discriminatedUnion이 정의되어 있다
- TransactionType 5개 값이 열거되어 있다
- PolicyType 10개 값이 열거되어 있다
- 감사 컬럼 4개(contract_address, method_signature, token_address, spender_address)가 명세되어 있다
- 에러 코드 10개가 정의되어 있다
- 테스트 시나리오가 12개 이상 정의되어 있다
  </verify>
  <done>
CONTRACT-01(ContractCallRequest), CONTRACT-02(화이트리스트 정책), CONTRACT-03(파이프라인 확장), CONTRACT-04(DB 스키마 확장), CONTRACT-05(테스트 시나리오)가 모두 커버되고, APPROVE/BATCH를 위한 크로스커팅 기반(파이프라인 Stage 1-5 분기, DB Enum, REST API 다형적 요청, 에러 코드)이 정의되어 있다.
  </done>
</task>

</tasks>

<verification>
1. docs/58-contract-call-spec.md 파일 존재 및 분량 확인 (900줄+)
2. 요구사항 커버리지 확인:
   - CONTRACT-01: ContractCallRequest 인터페이스 (섹션 2)
   - CONTRACT-02: CONTRACT_WHITELIST + METHOD_WHITELIST (섹션 4, 5)
   - CONTRACT-03: 파이프라인 Stage 1-5 확장 (섹션 6)
   - CONTRACT-04: TransactionType Enum + 감사 컬럼 (섹션 7)
   - CONTRACT-05: 테스트 시나리오 (섹션 9)
3. 크로스커팅 확장 확인:
   - Stage 1 discriminatedUnion에 5개 type이 있다
   - Stage 2 allowedContracts/allowedSpenders가 있다
   - Stage 3 evaluate() 11단계 순서가 있다
   - DB TransactionType 5개 값이 있다
   - PolicyType 10개 값이 있다
   - 에러 코드 10개가 있다
4. 23-02, 23-03이 참조할 확장 포인트가 명시되어 있다 ("23-02에서 상세 설계", "23-03에서 상세 설계")
</verification>

<success_criteria>
- CHAIN-EXT-03 문서가 ContractCallRequest의 EVM calldata와 Solana programId+accounts를 모두 표현한다
- CONTRACT_WHITELIST가 기본 전면 거부로 동작한다 (정책 미설정 시 CONTRACT_CALL_DISABLED)
- METHOD_WHITELIST가 4바이트 selector 기반으로 EVM 메서드를 필터링한다
- 파이프라인 확장 설계가 TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH 5가지 type 분기를 포함한다
- DB 스키마 확장이 TransactionType 5개 + PolicyType 10개 + 감사 컬럼 4개를 명세한다
- REST API 확장이 discriminatedUnion 5개 variant + 에러 코드 10개를 정의한다
- 보안 테스트 시나리오 12개+와 Mock 경계가 정의되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/23-transaction-type-extension/23-01-SUMMARY.md`
</output>
