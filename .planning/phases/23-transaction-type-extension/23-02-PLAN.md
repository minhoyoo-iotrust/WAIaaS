---
phase: 23-transaction-type-extension
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - docs/59-approve-management-spec.md
autonomous: true

must_haves:
  truths:
    - "ApproveRequest가 ContractCallRequest와 독립된 타입으로 존재하고, EVM ERC-20 approve와 Solana SPL ApproveChecked를 모두 표현할 수 있다"
    - "APPROVED_SPENDERS 정책이 기본 전면 거부(opt-in)로 동작하고, 미설정 시 APPROVE 자체를 거부한다"
    - "APPROVE_AMOUNT_LIMIT 정책이 무제한 approve(uint256.max, u64.max)를 감지하여 차단한다"
    - "APPROVE_TIER_OVERRIDE 정책이 SPENDING_LIMIT과 독립적으로 approve 보안 티어를 결정한다 (기본 APPROVAL)"
    - "EVM approve race condition 방지를 위해 어댑터가 approve(0) -> approve(new) 패턴을 자동 처리한다"
    - "Solana SPL 단일 delegate 제약이 문서화되고, 기존 delegate 경고 로직이 설계되어 있다"
    - "APPROVE 보안 테스트 시나리오가 무제한 approve, 비허가 spender, race condition 등을 포함한다"
  artifacts:
    - path: "docs/59-approve-management-spec.md"
      provides: "CHAIN-EXT-04 Approve 관리 스펙"
      contains: "ApproveRequest"
  key_links:
    - from: "docs/59-approve-management-spec.md"
      to: "docs/58-contract-call-spec.md"
      via: "Stage 3 APPROVED_SPENDERS/APPROVE_AMOUNT_LIMIT/APPROVE_TIER_OVERRIDE 평가 (23-01에서 순서 8-10 정의)"
    - from: "docs/59-approve-management-spec.md"
      to: "docs/33-time-lock-approval-mechanism.md"
      via: "PolicyType 3개 추가 (APPROVED_SPENDERS, APPROVE_AMOUNT_LIMIT, APPROVE_TIER_OVERRIDE)"
---

<objective>
ApproveRequest 인터페이스를 독립 타입으로 설계하고, 3가지 approve 전용 정책(APPROVED_SPENDERS, APPROVE_AMOUNT_LIMIT, APPROVE_TIER_OVERRIDE)으로 무제한 approve를 차단하며, EVM/Solana 체인별 approve 빌드 로직과 보안 패턴을 정의한다.

Purpose: 토큰 approve는 "자금 전송"이 아니라 "전송 권한 위임"이며, 일단 승인되면 spender가 에이전트 모르게 토큰을 가져갈 수 있다. 이 위험을 반영하여 approve를 ContractCall과 독립된 정책 카테고리로 관리한다.
Output: docs/59-approve-management-spec.md (CHAIN-EXT-04)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-transaction-type-extension/23-RESEARCH.md
@.planning/phases/23-transaction-type-extension/23-01-SUMMARY.md
@docs/58-contract-call-spec.md
@docs/56-token-transfer-extension-spec.md
@docs/33-time-lock-approval-mechanism.md
@docs/31-solana-adapter-detail.md
@docs/36-killswitch-autostop-evm.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ApproveRequest 인터페이스 + approve 정책 3종 + 체인별 빌드 로직 설계</name>
  <files>docs/59-approve-management-spec.md</files>
  <action>
docs/59-approve-management-spec.md 파일을 생성한다. 한글로 작성하며, 다음 섹션을 포함한다:

**섹션 1: 개요** (~40줄)
- 문서 메타데이터: 문서 ID(CHAIN-EXT-04), 작성일, Phase 23, 참조 문서 목록 (CHAIN-EXT-03 포함)
- 요구사항 매핑: APPROVE-01, APPROVE-02, APPROVE-03
- 핵심 설계 원칙: (1) approve는 독립 정책 카테고리, (2) 기본 전면 거부, (3) 무제한 approve 차단, (4) Owner 승인 기본 강제
- v0.6 핵심 결정 인용: "approve는 독립 정책 카테고리 (전송보다 위험한 권한 위임)"
- CHAIN-EXT-03 크로스커팅 참조: 파이프라인 Stage 3 순서 8-10, DB spender_address/token_address, REST API APPROVE variant

**섹션 2: ApproveRequest 인터페이스** (~100줄)
- TypeScript 인터페이스 정의:
  ```typescript
  interface ApproveRequest {
    from: string         // 토큰 소유자 (에이전트 주소)
    spender: string      // 위임 대상 주소 (컨트랙트/EOA)
    token: TokenInfo     // 토큰 정보 (CHAIN-EXT-01 TokenInfo 재사용)
    amount: bigint       // 승인 금액 (토큰 최소 단위)
  }
  ```
- ContractCallRequest와의 분리 근거:
  - approve는 "실행"이 아니라 "권한 위임" -- 별도 정책 카테고리 필요
  - amount의 의미가 다름: 전송할 금액이 아니라 위임할 한도
  - 보안 모델이 근본적으로 다름: approve 후 spender가 언제든 탈취 가능
- Zod 스키마 정의 (ApproveRequestSchema)
- ApproveRequest와 TokenInfo의 관계도

**섹션 3: EVM ERC-20 approve 빌드 로직** (~120줄)
- 표준 approve(spender, amount) 호출:
  - viem `encodeFunctionData()` 로 calldata 생성
  - ERC-20 approve ABI 정의 (표준 2-파라미터)
- Race condition 방지 -- approve(0) -> approve(new) 2단계:
  - **Step 1:** 현재 allowance 조회 (eth_call `allowance(owner, spender)`)
  - **Step 2:** allowance > 0이면 approve(spender, 0) 먼저 실행
  - **Step 3:** approve(spender, newAmount) 실행
  - **결정:** 어댑터에서 자동 처리. 에이전트에게 race condition 지식 요구하지 않음.
  - 2-step approve의 트랜잭션 ID 연결 (metadata에 관련 tx 참조)
- 무제한 approve 감지:
  - MAX_UINT256 = 2^256 - 1 (= type(uint256).max)
  - 임계값: MAX_UINT256 / 2 이상이면 "무제한"으로 간주
  - block_unlimited=true 시 무조건 DENY
- gas 추정: `estimateContractGas()` for approve call

**섹션 4: Solana SPL ApproveChecked 빌드 로직** (~120줄)
- `getApproveCheckedInstruction()` 호출:
  - account: 에이전트의 ATA (findAssociatedTokenPda로 계산)
  - mint: 토큰 민트 주소
  - delegate: spender 주소
  - owner: 에이전트 주소
  - amount: 승인 금액 (토큰 최소 단위)
  - decimals: 토큰 소수점 (온체인 검증)
  - tokenProgram: Token Program 또는 Token-2022 (CHAIN-EXT-01 로직 재사용)
- 단일 delegate 제약:
  - SPL Token은 토큰 계정당 하나의 delegate만 허용
  - 새 approve는 기존 delegate를 덮어씀
  - **경고 로직:** approve 전 현재 delegate 조회 (getAccount -> delegate 필드)
  - 기존 delegate가 있으면: 응답에 `previousDelegate` 정보 포함 + 감사 로그 기록
- Solana 무제한 approve 감지:
  - MAX_U64 = 2^64 - 1 (= u64::MAX)
  - 임계값: MAX_U64 / 2 이상이면 "무제한"으로 간주
- Revoke instruction: delegate를 제거하는 별도 instruction (향후 확장 포인트)
- Token-2022 approve 호환성: 기본 approve는 호환, 확장(CPI Guard 등) 감지 시 경고

**섹션 5: APPROVED_SPENDERS 정책 규칙** (~80줄)
- PolicyType: 'APPROVED_SPENDERS' (총 8개째)
- Zod 스키마: ApprovedSpendersRuleSchema
  ```typescript
  {
    allowed_spenders: Array<{
      address: string      // spender 주소
      label?: string       // 라벨 (예: 'Uniswap V3 Router')
      chain?: ChainType    // 해당 체인
    }>
  }
  ```
- 평가 로직 pseudo-code:
  1. APPROVED_SPENDERS 정책이 에이전트에 없으면 -> DENY (APPROVE_DISABLED)
  2. allowed_spenders가 빈 배열이면 -> DENY (SPENDER_NOT_APPROVED)
  3. request.spender가 allowed_spenders[].address에 없으면 -> DENY (SPENDER_NOT_APPROVED)
  4. chain 필드 교차 검증
  5. 통과 -> ALLOW

**섹션 6: APPROVE_AMOUNT_LIMIT 정책 규칙** (~80줄)
- PolicyType: 'APPROVE_AMOUNT_LIMIT' (총 9개째)
- Zod 스키마: ApproveAmountLimitRuleSchema
  ```typescript
  {
    max_approve_amount: string        // 최대 승인 금액 (토큰 최소 단위 문자열)
    unlimited_threshold?: string      // 무제한 감지 임계값
    block_unlimited: boolean          // 무제한 차단 여부 (기본 true)
  }
  ```
- 평가 로직:
  1. block_unlimited=true이고 amount >= unlimited_threshold -> DENY (UNLIMITED_APPROVE_BLOCKED)
  2. amount > max_approve_amount -> DENY (APPROVE_AMOUNT_EXCEEDED)
  3. 통과 -> ALLOW
- unlimited_threshold 기본값: EVM = (2^256-1)/2, Solana = (2^64-1)/2
- Phase 24 USD 통합 시 max_approve_amount를 USD 기준으로 전환 가능 (확장 포인트)

**섹션 7: APPROVE_TIER_OVERRIDE 정책 규칙** (~80줄)
- PolicyType: 'APPROVE_TIER_OVERRIDE' (총 10개째)
- Zod 스키마: ApproveTierOverrideRuleSchema
  ```typescript
  {
    default_tier: SecurityTier         // 기본 'APPROVAL' (Owner 승인 필수)
    amount_tiers?: Array<{
      max_amount: string               // 이 금액 이하면 해당 tier 적용
      tier: SecurityTier
    }>
  }
  ```
- 평가 로직:
  1. APPROVE_TIER_OVERRIDE 정책이 없으면 -> 기본 APPROVAL 티어 (보수적)
  2. amount_tiers가 있으면 금액에 매칭되는 티어 선택
  3. 매칭 없으면 default_tier 적용
  4. SPENDING_LIMIT 평가와 독립 -- APPROVE는 "권한 위임"이므로 전송 한도와 별개
- 예시 설정:
  - 소액 approve (< 100 USDC): NOTIFY
  - 중액 approve (< 1000 USDC): DELAY
  - 대액 approve (>= 1000 USDC): APPROVAL

**섹션 8: 감사 로그 확장** (~60줄)
- transactions 테이블 활용 (CHAIN-EXT-03 섹션 7에서 정의한 컬럼):
  - type: 'APPROVE'
  - contract_address: 토큰 컨트랙트/민트 주소
  - method_signature: 'approve(address,uint256)' (EVM) 또는 'ApproveChecked' (Solana)
  - token_address: 토큰 주소
  - spender_address: spender 주소
  - amount: 승인 금액
- approve 이력 추적 쿼리 예시
- revoke 이벤트 감사 (향후 확장)

**섹션 9: 보안 위험 매트릭스 + 테스트 시나리오** (~100줄)
- APPROVE 보안 위험 매트릭스 (5개 위험 + 완화 방안) -- 23-RESEARCH.md 참조
- 테스트 레벨:
  - Level 1 (Unit): ApproveRequest Zod 검증, 무제한 감지, 정책 평가 로직
  - Level 2 (Integration): 파이프라인 approve 흐름 (Mock Adapter)
  - Level 3 (Chain Mock): EVM Hardhat ERC-20 배포 + approve + allowance 확인
  - Level 4 (Security): 무제한 approve 차단, 비허가 spender, race condition, 단일 delegate 경고
- Mock 경계: IChainAdapter.buildApprove, DatabasePolicyEngine.evaluate, ERC-20 allowance 조회
- 시나리오 15개 이상:
  - 정상: EVM approve, Solana approve, 소액 approve (2-3)
  - 정책 거부: 비허가 spender, 금액 초과, 무제한 차단, APPROVE_DISABLED (4-5)
  - 보안: race condition 자동 처리, 단일 delegate 경고, 잔여 allowance (3-4)
  - 에러: 잘못된 토큰 주소, ATA 미존재, 잔액 부족 (2-3)

문서 총 분량 목표: 약 800-1000줄.
문서 작성 언어: 한글.
코드 블록 내 주석은 한글.
  </action>
  <verify>
- docs/59-approve-management-spec.md 파일이 존재한다
- 파일 분량이 750줄 이상이다 (`wc -l docs/59-approve-management-spec.md`)
- ApproveRequest 인터페이스가 정의되어 있다 (grep 'ApproveRequest')
- APPROVED_SPENDERS, APPROVE_AMOUNT_LIMIT, APPROVE_TIER_OVERRIDE 정책 스키마가 각각 정의되어 있다
- EVM approve(0)->approve(new) race condition 자동 처리가 설계되어 있다
- Solana 단일 delegate 제약 + 경고 로직이 설계되어 있다
- 무제한 approve 감지 로직(EVM uint256.max, Solana u64.max)이 있다
- 테스트 시나리오가 15개 이상 정의되어 있다
  </verify>
  <done>
APPROVE-01(독립 ApproveRequest), APPROVE-02(3가지 approve 정책), APPROVE-03(테스트 시나리오)가 모두 커버되고, EVM race condition 자동 처리와 Solana 단일 delegate 제약이 설계되어 있다.
  </done>
</task>

</tasks>

<verification>
1. docs/59-approve-management-spec.md 파일 존재 및 분량 확인 (750줄+)
2. 요구사항 커버리지 확인:
   - APPROVE-01: ApproveRequest 독립 타입 (섹션 2)
   - APPROVE-02: APPROVED_SPENDERS + APPROVE_AMOUNT_LIMIT + APPROVE_TIER_OVERRIDE (섹션 5, 6, 7)
   - APPROVE-03: 테스트 시나리오 (섹션 9)
3. CHAIN-EXT-03 참조 확인:
   - Stage 3 순서 8-10을 참조하며 상세 설계로 확장
   - DB 감사 컬럼(spender_address, token_address) 활용
   - REST API APPROVE variant 참조
4. 보안 패턴 확인:
   - EVM approve(0)->approve(new) 자동 처리
   - 무제한 approve 차단 (block_unlimited)
   - Solana 단일 delegate 경고
</verification>

<success_criteria>
- ApproveRequest가 ContractCallRequest와 독립된 타입으로 EVM/Solana approve를 모두 표현한다
- 3가지 approve 정책이 무제한 approve를 차단하고, 기본 APPROVAL 티어를 강제한다
- EVM race condition 방지가 어댑터 자동 처리로 설계되어 있다
- Solana 단일 delegate 제약과 경고 로직이 명세되어 있다
- 보안 테스트 시나리오 15개+와 Mock 경계가 정의되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/23-transaction-type-extension/23-02-SUMMARY.md`
</output>
