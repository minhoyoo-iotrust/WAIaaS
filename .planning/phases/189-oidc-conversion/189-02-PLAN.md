---
phase: 189-oidc-conversion
plan: 02
type: execute
wave: 2
depends_on: [189-01]
files_modified: [.github/workflows/release.yml]
autonomous: true
requirements: [OIDC-02, OIDC-03, OIDC-04, OIDC-05]

must_haves:
  truths:
    - "deploy 잡이 id-token: write 퍼미션을 갖는다"
    - "deploy 잡에서 NODE_AUTH_TOKEN 환경변수와 Setup npmrc 스텝이 제거되었다"
    - "deploy 잡이 npm publish --provenance --access public으로 패키지를 발행한다"
    - "pre-release 버전은 --tag rc 플래그를 포함한다"
    - "publish-check 잡은 기존 pnpm publish --dry-run을 그대로 유지한다"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "OIDC-based deploy job with provenance"
      contains: "id-token: write"
  key_links:
    - from: "deploy job permissions block"
      to: "GitHub Actions OIDC provider"
      via: "id-token: write permission"
      pattern: "id-token: write"
    - from: "npm publish --provenance"
      to: "npmjs.com Trusted Publisher config"
      via: "OIDC token exchange"
      pattern: "npm publish --provenance --access public"
---

<objective>
release.yml deploy 잡을 OIDC 인증 + provenance 서명 방식으로 전환한다.

Purpose: Phase 189-01에서 npmjs.com에 Trusted Publisher가 등록된 상태에서, 실제 워크플로가 OIDC 토큰을 사용하여 인증하고 provenance 배지를 확보하도록 release.yml을 수정한다. NODE_AUTH_TOKEN 기반 인증을 제거하여 OIDC 자동 감지가 동작하도록 한다.
Output: OIDC 인증 + provenance 서명이 적용된 release.yml deploy 잡
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/189-oidc-conversion/189-RESEARCH.md
@.planning/phases/189-oidc-conversion/189-01-SUMMARY.md
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: deploy 잡 OIDC 전환 (permissions + npmrc 제거 + npm publish --provenance)</name>
  <files>.github/workflows/release.yml</files>
  <action>
release.yml의 deploy 잡을 다음과 같이 수정한다. 정확한 diff를 아래에 명시한다.

**변경 1: deploy 잡에 permissions 블록 추가 (OIDC-02)**

`environment: production` 아래에 job-level permissions 블록을 추가한다:
```yaml
  deploy:
    runs-on: ubuntu-latest
    needs: [test, chain-integration, platform, publish-check, docker-publish]
    if: github.event_name == 'release'
    environment: production
    permissions:
      contents: read
      id-token: write
```
- `id-token: write`는 GitHub Actions가 OIDC 토큰을 발급하도록 허용
- `contents: read`는 checkout에 필요
- job-level로 설정하여 다른 잡에는 영향 없음

**변경 2: "Setup npmrc" 스텝 전체 삭제 (OIDC-03)**

아래 스텝을 완전히 제거한다:
```yaml
      - name: Setup npmrc
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```
이유: NODE_AUTH_TOKEN이 있으면 npm이 OIDC 대신 토큰 인증을 사용한다.

**변경 3: publish 스텝을 npm publish --provenance로 교체 (OIDC-04)**

기존 `pnpm publish` 스텝을 아래로 교체한다:
```yaml
      - name: Publish packages
        run: |
          PACKAGES=(
            packages/core
            packages/daemon
            packages/cli
            packages/sdk
            packages/mcp
            packages/skills
            packages/adapters/solana
            packages/adapters/evm
          )
          for pkg_path in "${PACKAGES[@]}"; do
            echo "--- Publishing $pkg_path ---"
            cd "$pkg_path"
            PKG_VERSION=$(node -p "require('./package.json').version")
            if [[ "$PKG_VERSION" == *-* ]]; then
              npm publish --provenance --access public --tag rc 2>&1
            else
              npm publish --provenance --access public 2>&1
            fi
            cd "$GITHUB_WORKSPACE"
          done
```
핵심 변경:
- 스텝 이름: `pnpm publish` -> `Publish packages`
- 명령어: `pnpm publish --access public --no-git-checks` -> `npm publish --provenance --access public`
- pre-release: `--tag rc` 유지
- `--no-git-checks` 제거 (npm publish에서는 불필요)
- `env: NODE_AUTH_TOKEN` 블록 완전 제거 (OIDC-03)

**변경 4: Deploy summary 업데이트**

Deploy summary의 npm 라인을 변경:
```yaml
          echo "- **npm:** 8 packages published with OIDC provenance" >> $GITHUB_STEP_SUMMARY
```

**변경 5: 주석 업데이트**

deploy 잡의 주석을 업데이트:
```yaml
  # Gate 2: Manual approval deploy -- npm publish with OIDC + provenance
```

**publish-check 잡은 변경하지 않는다 (OIDC-05)**
publish-check 잡의 `pnpm publish --dry-run --no-git-checks`는 그대로 유지한다.
dry-run에서는 OIDC 토큰 교환이 발생하지 않으므로 --provenance 불필요하다.
  </action>
  <verify>
1. release.yml의 deploy 잡에서 다음을 확인:
   - `permissions:` 블록에 `id-token: write`와 `contents: read`가 있다
   - `Setup npmrc` 스텝이 없다
   - `NODE_AUTH_TOKEN` 문자열이 deploy 잡 내에 없다
   - `npm publish --provenance --access public`이 있다
   - pre-release 분기에 `--tag rc`가 있다
2. publish-check 잡에서 다음을 확인:
   - `pnpm publish --dry-run --no-git-checks`가 그대로 있다
   - `--provenance`가 없다
3. YAML 문법 확인: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"`
  </verify>
  <done>
- deploy 잡이 permissions: { contents: read, id-token: write }를 갖는다
- deploy 잡에서 Setup npmrc 스텝과 NODE_AUTH_TOKEN이 제거되었다
- deploy 잡이 npm publish --provenance --access public으로 발행한다 (pre-release 시 --tag rc 포함)
- publish-check 잡은 기존 pnpm publish --dry-run --no-git-checks를 그대로 유지한다
- YAML 문법이 유효하다
  </done>
</task>

</tasks>

<verification>
1. `grep -n "id-token: write" .github/workflows/release.yml` -- deploy 잡에 존재
2. `grep -n "NODE_AUTH_TOKEN" .github/workflows/release.yml` -- deploy 잡 내에 없음 (publish-check에도 없음)
3. `grep -n "Setup npmrc" .github/workflows/release.yml` -- 결과 없음
4. `grep -n "npm publish --provenance" .github/workflows/release.yml` -- deploy 잡에 존재
5. `grep -n "pnpm publish --dry-run" .github/workflows/release.yml` -- publish-check 잡에 존재
6. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"` -- YAML 유효
</verification>

<success_criteria>
1. deploy 잡이 `id-token: write` + `contents: read` 퍼미션을 갖는다
2. deploy 잡에서 Setup npmrc 스텝과 NODE_AUTH_TOKEN 환경변수가 완전 제거되었다
3. deploy 잡이 `npm publish --provenance --access public`으로 패키지를 발행한다 (pre-release 시 `--tag rc` 포함)
4. publish-check 잡은 `pnpm publish --dry-run --no-git-checks`를 그대로 유지한다 (`--provenance` 없음)
5. YAML 문법이 유효하다
</success_criteria>

<output>
After completion, create `.planning/phases/189-oidc-conversion/189-02-SUMMARY.md`
</output>
