---
phase: 158-platform-test
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/__tests__/platform/init.platform.test.ts
  - packages/cli/src/__tests__/platform/start-stop.platform.test.ts
  - packages/cli/src/__tests__/platform/status.platform.test.ts
  - packages/cli/src/__tests__/platform/signal.platform.test.ts
  - packages/cli/src/__tests__/platform/e2e-flow.platform.test.ts
autonomous: true

must_haves:
  truths:
    - "waiaas init이 데이터 디렉토리 + 하위 디렉토리 4개 + config.toml을 0o700 퍼미션으로 생성한다"
    - "waiaas start가 PID 파일을 기록하고, 중복 실행 시 에러로 종료한다"
    - "waiaas stop이 SIGTERM 전송 후 프로세스 종료를 확인하고, 타임아웃 시 SIGKILL을 보낸다"
    - "waiaas status가 running/starting/stopped 3가지 상태를 정확하게 보고한다"
    - "SIGINT/SIGTERM 수신 시 10-step 그레이스풀 셧다운이 완료되고, 종료 코드 0으로 정상 종료한다"
    - "init -> start -> status -> stop E2E 전체 플로우가 정상 동작한다"
  artifacts:
    - path: "packages/cli/src/__tests__/platform/init.platform.test.ts"
      provides: "PLAT-01 init 4건 테스트"
      min_lines: 80
    - path: "packages/cli/src/__tests__/platform/start-stop.platform.test.ts"
      provides: "PLAT-01 start 6건 + stop 5건 + exit codes 6건 테스트"
      min_lines: 300
    - path: "packages/cli/src/__tests__/platform/status.platform.test.ts"
      provides: "PLAT-01 status 3건 + Windows 2건 테스트"
      min_lines: 100
    - path: "packages/cli/src/__tests__/platform/signal.platform.test.ts"
      provides: "PLAT-01 signal handling 5건 테스트"
      min_lines: 120
    - path: "packages/cli/src/__tests__/platform/e2e-flow.platform.test.ts"
      provides: "PLAT-01 E2E 1건 전체 플로우 테스트"
      min_lines: 60
  key_links:
    - from: "start-stop.platform.test.ts"
      to: "packages/cli/src/commands/start.ts"
      via: "startCommand() 호출 + PID 파일 검증"
      pattern: "startCommand|daemon\\.pid"
    - from: "signal.platform.test.ts"
      to: "packages/daemon/src/lifecycle/signal-handler.ts"
      via: "registerSignalHandlers() + daemon.shutdown()"
      pattern: "SIGINT|SIGTERM|shutdown"
    - from: "e2e-flow.platform.test.ts"
      to: "packages/cli/src/commands"
      via: "init -> start -> status -> stop 순차 호출"
      pattern: "initCommand.*startCommand.*statusCommand.*stopCommand"
---

<objective>
CLI Daemon 플랫폼 테스트 32건을 작성하여 init/start/stop/status/signal/exit codes/E2E 전체 배포 품질을 검증한다.

Purpose: CLI 데몬의 프로세스 라이프사이클(PID 관리, 시그널 핸들링, 그레이스풀 셧다운, 종료 코드)이 프로덕션 환경에서 안정적으로 동작함을 증명한다.
Output: 5개 플랫폼 테스트 파일 (packages/cli/src/__tests__/platform/)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@objectives/v1.7-quality-cicd.md (Section 5: 플랫폼 테스트 - CLI Daemon 32건)
@packages/cli/src/commands/init.ts
@packages/cli/src/commands/start.ts
@packages/cli/src/commands/stop.ts
@packages/cli/src/commands/status.ts
@packages/cli/src/index.ts
@packages/daemon/src/lifecycle/daemon.ts (DaemonLifecycle 6-step start + 10-step shutdown)
@packages/daemon/src/lifecycle/signal-handler.ts (registerSignalHandlers)
@packages/daemon/src/lifecycle/workers.ts (BackgroundWorkers)
@packages/cli/src/__tests__/helpers/daemon-harness.ts (initTestDataDir, startTestDaemon, stopTestDaemon)
@packages/cli/src/__tests__/cli-commands.test.ts (기존 단위 테스트 - 중복 방지 참조)
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI init/status/signal 플랫폼 테스트 (4 + 3 + 2 + 5 = 14건)</name>
  <files>
    packages/cli/src/__tests__/platform/init.platform.test.ts
    packages/cli/src/__tests__/platform/status.platform.test.ts
    packages/cli/src/__tests__/platform/signal.platform.test.ts
  </files>
  <action>
packages/cli/src/__tests__/platform/ 디렉토리를 생성하고 3개 테스트 파일을 작성한다.

**init.platform.test.ts (4건)**:
테스트 패턴: 실제 파일시스템에 tmpdir 기반 임시 디렉토리 생성 후 initCommand() 직접 호출.
기존 cli-commands.test.ts와 중복되지 않도록 플랫폼 관점(퍼미션, 엣지 케이스)에 집중한다.

- PLAT-01-INIT-01: 빈 디렉토리에서 initCommand -> 4개 하위 디렉토리(keystore, data, logs, backups) + config.toml 생성 확인
- PLAT-01-INIT-02: 이미 초기화된 디렉토리에서 재실행 -> "Already initialized" 메시지, config.toml 내용 미변경 확인
- PLAT-01-INIT-03: 디렉토리 퍼미션 0o700 검증 (statSync mode & 0o777)
- PLAT-01-INIT-04: config.toml에 [daemon] port=3100, hostname="127.0.0.1", [database] path="data/waiaas.db" 포함 검증

**status.platform.test.ts (3 + 2 = 5건)**:
- PLAT-01-STATUS-01: PID 파일 없음 -> "Status: stopped" 출력
- PLAT-01-STATUS-02: PID 파일 있고 프로세스 alive + /health 200 -> "Status: running (PID: X, Port: Y)"
- PLAT-01-STATUS-03: PID 파일 있고 프로세스 alive + /health 실패 -> "Status: starting (PID: X)"
- PLAT-01-WIN-01: process.platform === 'win32'일 때 SIGBREAK 핸들러 등록 확인 (describe.skipIf(process.platform !== 'win32') 또는 조건부 mock으로 검증)
- PLAT-01-WIN-02: Windows에서 PID 파일 경로에 백슬래시 포함 시 정상 동작 (join()이 플랫폼 구분자 처리)

Windows 테스트: macOS/Linux에서는 SIGBREAK 관련 테스트를 describe.skipIf 처리하되, registerSignalHandlers의 process.platform 분기를 검증하기 위해 signal-handler.ts를 import하여 핸들러 등록 여부를 확인한다. Windows에서 실행 시에만 실제 SIGBREAK 동작을 테스트한다.

**signal.platform.test.ts (5건)**:
DaemonLifecycle 인스턴스를 직접 생성하여 시그널 핸들링을 테스트한다. 실제 데몬 프로세스를 fork하지 않고, DaemonLifecycle.shutdown() 호출로 검증한다.

- PLAT-01-SIG-01: SIGINT 수신 -> shutdown('SIGINT') 호출, isShuttingDown = true
- PLAT-01-SIG-02: SIGTERM 수신 -> shutdown('SIGTERM') 호출, isShuttingDown = true
- PLAT-01-SIG-03: 이중 시그널 (SIGTERM + SIGTERM) -> shutdown 한 번만 실행 (guard 검증)
- PLAT-01-SIG-04: uncaughtException -> shutdown + process.exit(1) 호출
- PLAT-01-SIG-05: unhandledRejection -> shutdown + process.exit(1) 호출

시그널 테스트는 실제 프로세스에 시그널을 보내지 않는다. 대신 registerSignalHandlers가 등록하는 이벤트 리스너를 수동으로 트리거하여 DaemonLifecycle.shutdown()이 올바르게 호출되는지 검증한다. mock을 사용해 process.on('SIGINT', handler) 에서 handler를 캡처한 후 수동 호출한다.

각 테스트 파일에서 afterEach/afterAll에서 tmpdir 정리를 보장한다.
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/cli/src/__tests__/platform/ --reporter=verbose 2>&1 | tail -30
14건 테스트 모두 통과 확인.
  </verify>
  <done>
init 4건 + status 3건 + Windows 2건 + signal 5건 = 14건 플랫폼 테스트가 모두 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI start/stop/exit-codes/E2E 플랫폼 테스트 (6 + 5 + 6 + 1 = 18건)</name>
  <files>
    packages/cli/src/__tests__/platform/start-stop.platform.test.ts
    packages/cli/src/__tests__/platform/e2e-flow.platform.test.ts
  </files>
  <action>
**start-stop.platform.test.ts (6 + 5 + 6 = 17건)**:
initTestDataDir() 헬퍼를 사용하여 격리된 임시 환경에서 테스트. startTestDaemon/stopTestDaemon 헬퍼를 적극 활용한다.

Start 6건:
- PLAT-01-START-01: initTestDataDir -> startTestDaemon -> PID 파일 생성 확인 (existsSync + readFileSync로 PID 번호 일치)
- PLAT-01-START-02: 데몬 시작 후 GET /health 200 OK 응답 (waitForHealth 유틸 사용)
- PLAT-01-START-03: PID 파일이 이미 존재하고 해당 프로세스가 alive -> "already running" 에러 메시지 + exit(1)
- PLAT-01-START-04: Stale PID 파일(존재하지 않는 PID) 있을 때 -> 정상 시작 (stale 파일 무시)
- PLAT-01-START-05: config.toml 누락 시 -> loadConfig에서 기본값으로 동작 (에러 없이 시작)
- PLAT-01-START-06: daemon.lock 이미 잡힌 상태 -> SYSTEM_LOCKED 에러 (proper-lockfile 충돌)

Stop 5건:
- PLAT-01-STOP-01: PID 파일 없음 -> "Daemon is not running" 메시지
- PLAT-01-STOP-02: Stale PID 파일 (프로세스 죽음) -> "not running (stale PID file)" + PID 파일 삭제
- PLAT-01-STOP-03: 실행 중 데몬에 stopCommand -> SIGTERM 전송, 프로세스 종료, PID 파일 삭제 확인
- PLAT-01-STOP-04: 10-step 그레이스풀 셧다운 순서 검증 (DaemonLifecycle.shutdown 호출 -> HTTP 서버 종료 -> 워커 중지 -> WAL 체크포인트 -> 키스토어 잠금 -> DB 종료 -> PID 파일 삭제)
- PLAT-01-STOP-05: 셧다운 타임아웃 시 force exit 동작 (forceTimer 30s -> process.exit(1))

Exit codes 6건:
- PLAT-01-EXIT-01: 정상 셧다운(SIGTERM) -> exit code 0
- PLAT-01-EXIT-02: 이미 실행 중인 데몬 start 시도 -> exit code 1
- PLAT-01-EXIT-03: 마스터 패스워드 미제공 시 -> exit code 1
- PLAT-01-EXIT-04: uncaughtException -> exit code 1
- PLAT-01-EXIT-05: unhandledRejection -> exit code 1
- PLAT-01-EXIT-06: 잘못된 config.toml (port = -1 등) -> 시작 실패, exit code 1

Start/Stop 테스트에서 실제 데몬 시작이 필요한 경우 startTestDaemon 헬퍼를 사용한다. 데몬 시작에 ~2-3초 소요되므로 { timeout: 30_000 } 설정.
Exit code 테스트는 process.exit를 mock하여 검증한다 (ExitError 패턴, 기존 cli-commands.test.ts 참조).
PLAT-01-START-06 (daemon.lock 충돌)은 proper-lockfile을 사용하여 사전에 lock을 잡은 후 startCommand 실행으로 검증.

**e2e-flow.platform.test.ts (1건)**:
- PLAT-01-E2E-01: 전체 플로우: initTestDataDir -> initCommand -> startTestDaemon -> waitForHealth -> statusCommand(running 확인) -> daemon.shutdown('TEST') -> statusCommand(stopped 확인)
timeout: 60_000. afterAll에서 반드시 cleanup.

모든 테스트에서 beforeEach로 initTestDataDir 호출, afterEach/afterAll에서 cleanup (rmSync recursive force).
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/cli/src/__tests__/platform/ --reporter=verbose 2>&1 | tail -40
32건 테스트 모두 통과 확인 (Task 1의 14건 + Task 2의 18건).
  </verify>
  <done>
start 6건 + stop 5건 + exit codes 6건 + E2E 1건 = 18건이 통과하여, CLI Daemon 총 32건 플랫폼 테스트가 모두 통과한다.
  </done>
</task>

</tasks>

<verification>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/cli/src/__tests__/platform/ --reporter=verbose 2>&1 | grep -E "(Tests|PASS|FAIL)" | head -20

기대 결과:
- 5개 테스트 파일 모두 PASS
- 총 32건 테스트 통과 (init 4 + start 6 + stop 5 + status 3 + signal 5 + Windows 2 + exit codes 6 + E2E 1)
</verification>

<success_criteria>
1. packages/cli/src/__tests__/platform/ 디렉토리에 5개 테스트 파일이 존재한다
2. vitest run으로 32건 모두 PASS한다
3. 기존 cli-commands.test.ts 테스트가 깨지지 않는다
4. 각 테스트가 격리된 tmpdir에서 실행되어 서로 간섭하지 않는다
</success_criteria>

<output>
After completion, create `.planning/phases/158-platform-test/158-01-SUMMARY.md`
</output>
