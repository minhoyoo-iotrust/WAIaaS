---
phase: 126-oracle-implementations
plan: 03
type: tdd
wave: 2
depends_on: ["126-01", "126-02"]
files_modified:
  - packages/daemon/src/infrastructure/oracle/oracle-chain.ts
  - packages/daemon/src/infrastructure/oracle/index.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/__tests__/oracle-chain.test.ts
autonomous: true

must_haves:
  truths:
    - "OracleChain.getPrice()가 Pyth 성공 시 Pyth 가격을 캐시하고 반환한다"
    - "OracleChain.getPrice()가 Pyth 실패 시 CoinGecko로 자동 fallback한다"
    - "양쪽 성공 시 편차>5%이면 반환되는 PriceInfo의 isStale=true로 격하된다"
    - "양쪽 성공 시 편차<=5%이면 Pyth 가격을 그대로 반환한다 (isStale=false)"
    - "CoinGecko 키 미설정 시 교차 검증을 건너뛰고 Pyth 가격만 사용한다"
    - "모두 실패 시 stale 캐시에서 fallback한다"
    - "stale 캐시도 없으면 PriceNotAvailableError를 throw한다"
    - "GET /v1/admin/oracle-status가 캐시 적중률, 소스별 상태, 교차검증 설정을 반환한다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/oracle/oracle-chain.ts"
      provides: "OracleChain class implementing IPriceOracle with fallback + cross-validation"
      exports: ["OracleChain"]
    - path: "packages/daemon/src/__tests__/oracle-chain.test.ts"
      provides: "OracleChain 단위 테스트"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "OracleStatusResponseSchema"
      contains: "OracleStatusResponseSchema"
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "GET /admin/oracle-status 엔드포인트"
      contains: "oracle-status"
  key_links:
    - from: "packages/daemon/src/infrastructure/oracle/oracle-chain.ts"
      to: "packages/daemon/src/infrastructure/oracle/pyth-oracle.ts"
      via: "PythOracle dependency injection"
      pattern: "IPriceOracle"
    - from: "packages/daemon/src/infrastructure/oracle/oracle-chain.ts"
      to: "packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts"
      via: "CoinGeckoOracle optional dependency injection"
      pattern: "IPriceOracle"
    - from: "packages/daemon/src/infrastructure/oracle/oracle-chain.ts"
      to: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      via: "InMemoryPriceCache.getOrFetch() for stampede prevention"
      pattern: "cache\\.getOrFetch"
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "packages/daemon/src/infrastructure/oracle/oracle-chain.ts"
      via: "AdminRouteDeps.priceOracle"
      pattern: "priceOracle.*getCacheStats"
---

<objective>
OracleChain fallback + 교차 검증 + GET /v1/admin/oracle-status 엔드포인트

Purpose: Pyth(Primary) -> CoinGecko(Fallback, 키 설정 시) -> Stale Cache 3단계 fallback 체인을 구현하고, CoinGecko 키 설정 시 교차 검증으로 편차>5% 가격을 STALE로 격하한다. Admin API에 oracle-status 엔드포인트를 추가하여 캐시 통계와 소스별 상태를 모니터링한다.

Output: oracle-chain.ts, oracle-chain.test.ts, admin.ts (수정), openapi-schemas.ts (수정)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/125-design-docs-oracle-interfaces/125-02-SUMMARY.md
@.planning/phases/126-oracle-implementations/126-RESEARCH.md
@.planning/phases/126-oracle-implementations/126-01-SUMMARY.md
@.planning/phases/126-oracle-implementations/126-02-SUMMARY.md
@packages/core/src/interfaces/price-oracle.types.ts
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/pyth-oracle.ts
@packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
@packages/daemon/src/infrastructure/oracle/index.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED -- OracleChain fallback + 교차 검증 테스트 작성</name>
  <files>
    packages/daemon/src/__tests__/oracle-chain.test.ts
  </files>
  <action>
**oracle-chain.test.ts 생성 (RED 단계):**

OracleChain은 IPriceOracle을 implements하며, 생성자에 primary(PythOracle), fallback?(CoinGeckoOracle), cache(InMemoryPriceCache), crossValidationThreshold(number, 기본 5)를 주입받는다. 테스트에서는 primary/fallback을 mock IPriceOracle로 주입한다.

**Mock 준비:**
```typescript
function createMockOracle(overrides?: Partial<IPriceOracle>): IPriceOracle {
  return {
    getPrice: vi.fn().mockRejectedValue(new Error('not implemented')),
    getPrices: vi.fn().mockResolvedValue(new Map()),
    getNativePrice: vi.fn().mockRejectedValue(new Error('not implemented')),
    getCacheStats: vi.fn().mockReturnValue({ hits: 0, misses: 0, staleHits: 0, size: 0, evictions: 0 }),
    ...overrides,
  };
}
```

**테스트 케이스:**

1. `Primary 성공 -> Primary 가격 반환 + 캐시 저장`: primary.getPrice 성공 mock -> OracleChain.getPrice() 호출 -> source='pyth' PriceInfo 반환. cache에 저장 확인.

2. `Primary 실패 + Fallback 성공 -> Fallback 가격 반환`: primary.getPrice가 PriceNotAvailableError throw -> fallback.getPrice가 성공 -> source='coingecko' PriceInfo 반환.

3. `Primary 실패 + Fallback 없음 -> Stale 캐시 fallback`: fallback이 null(CoinGecko 키 미설정). primary 실패. cache에 stale 데이터 있음 -> stale PriceInfo 반환 (isStale=true로 마킹).

4. `Primary 실패 + Fallback 실패 -> Stale 캐시 fallback`: 양쪽 모두 실패, stale 캐시에서 반환.

5. `모든 실패 + Stale 캐시 없음 -> PriceNotAvailableError throw`: 모두 실패, stale도 없음 -> 에러.

6. `교차 검증: 편차 <= 5% -> Primary 가격 채택 (isStale=false)`: primary=100, fallback=103 (3% 편차). OracleChain 반환값의 isStale=false, usdPrice=100(primary).

7. `교차 검증: 편차 > 5% -> STALE 격하 (isStale=true)`: primary=100, fallback=120 (20% 편차). OracleChain 반환값의 isStale=true.

8. `교차 검증: 정확히 5% -> 채택 (isStale=false)`: primary=100, fallback=105 (정확히 5%). 경계값 테스트.

9. `교차 검증: 정확히 5% 초과 -> 격하 (isStale=true)`: primary=100, fallback=105.01 (>5%). 경계값 테스트.

10. `Fallback 없으면 교차 검증 스킵`: fallback이 null -> 교차 검증 없이 primary 가격 반환 (isStale=false).

11. `교차 검증 시 Fallback 실패 -> Primary 가격 신뢰`: primary 성공, fallback이 에러 throw -> 교차 검증 스킵, primary 가격 그대로 반환.

12. `getPrices() - 여러 토큰 배치 조회`: OracleChain.getPrices()가 각 토큰별로 cache.getOrFetch()를 호출하고 결과를 Map으로 반환.

13. `getNativePrice() - 네이티브 토큰 가격 조회 위임`: OracleChain.getNativePrice('solana')가 내부적으로 getPrice() 호출.

14. `getCacheStats() - InMemoryPriceCache의 stats 반환`: OracleChain.getCacheStats()가 cache.getStats() 결과 반환.

15. `캐시 히트 시 API 호출 건너뜀`: cache에 FRESH 데이터가 있으면 primary/fallback API 호출 없이 캐시 반환.

테스트를 실행하면 OracleChain 모듈이 없어서 실패해야 한다.
  </action>
  <verify>
`cd packages/daemon && npx vitest run src/__tests__/oracle-chain.test.ts --reporter=verbose 2>&1 | tail -20` -- 모든 테스트 FAIL (import 에러)
  </verify>
  <done>oracle-chain.test.ts에 15개 테스트 RED 상태, mock oracle 패턴 확립</done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN -- OracleChain 구현 + Admin oracle-status 엔드포인트</name>
  <files>
    packages/daemon/src/infrastructure/oracle/oracle-chain.ts
    packages/daemon/src/infrastructure/oracle/index.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/admin.ts
  </files>
  <action>
**oracle-chain.ts 생성:**

```typescript
export interface OracleChainDeps {
  primary: IPriceOracle;        // PythOracle
  fallback?: IPriceOracle;      // CoinGeckoOracle (opt-in, API 키 설정 시)
  cache: InMemoryPriceCache;
  crossValidationThreshold?: number; // 기본값 5 (%)
}

export class OracleChain implements IPriceOracle {
  private readonly primary: IPriceOracle;
  private readonly fallback: IPriceOracle | undefined;
  private readonly cache: InMemoryPriceCache;
  private readonly threshold: number;

  constructor(deps: OracleChainDeps) {
    this.primary = deps.primary;
    this.fallback = deps.fallback;
    this.cache = deps.cache;
    this.threshold = deps.crossValidationThreshold ?? 5;
  }

  async getPrice(token: TokenRef): Promise<PriceInfo> { ... }
  async getPrices(tokens: TokenRef[]): Promise<Map<string, PriceInfo>> { ... }
  async getNativePrice(chain: ChainType): Promise<PriceInfo> { ... }
  getCacheStats(): CacheStats { ... }
}
```

**getPrice() 핵심 로직:**

OracleChain이 캐시 관리를 전담한다. `cache.getOrFetch(cacheKey, fetcher)` 패턴 사용:

```typescript
async getPrice(token: TokenRef): Promise<PriceInfo> {
  const cacheKey = buildCacheKey(token.chain, token.address);

  return this.cache.getOrFetch(cacheKey, async () => {
    // 1. Primary(Pyth) 시도
    let primaryResult: PriceInfo | null = null;
    try {
      primaryResult = await this.primary.getPrice(token);
    } catch {
      // Primary 실패 -> fallback 시도
    }

    // 2. Primary 성공 -> 교차 검증 (fallback 있을 때만)
    if (primaryResult) {
      if (this.fallback) {
        try {
          const fallbackResult = await this.fallback.getPrice(token);
          const deviation = calculateDeviation(primaryResult.usdPrice, fallbackResult.usdPrice);
          if (deviation > this.threshold) {
            return { ...primaryResult, isStale: true };
          }
        } catch {
          // Fallback 실패 -> 교차 검증 스킵, primary 신뢰
        }
      }
      return primaryResult;
    }

    // 3. Primary 실패 -> Fallback(CoinGecko) 시도
    if (this.fallback) {
      try {
        return await this.fallback.getPrice(token);
      } catch {
        // Fallback도 실패
      }
    }

    // 4. Stale cache fallback (getOrFetch의 fetcher이므로, 여기서 직접 stale 체크)
    const stale = this.cache.getStale(cacheKey);
    if (stale) {
      return { ...stale, isStale: true, source: 'cache' };
    }

    // 5. 모든 실패
    throw new PriceNotAvailableError(cacheKey);
  });
}
```

**중요 구현 세부사항:**
- `calculateDeviation(primary, fallback)`: `Math.abs((primary - fallback) / primary) * 100`. primary가 0이면 0 반환.
- `getPrices()`: 각 토큰에 대해 `this.getPrice(token)` 호출. 실패한 토큰은 Map에서 제외 (에러 swallow). 결과를 `Map<cacheKey, PriceInfo>`로 반환.
- `getNativePrice(chain)`: `this.getPrice({ address: 'native', decimals: chain === 'solana' ? 9 : 18, chain })` 위임.
- `getCacheStats()`: `this.cache.getStats()` 반환.

**주의:** getOrFetch()의 fetcher 내에서 getStale()을 호출할 때, getOrFetch()가 이미 cache miss를 확인한 상태이므로 stale 체크는 별도로 수행. 만약 getOrFetch()의 fetcher가 throw하면 캐시에 저장되지 않으므로, stale fallback 로직은 fetcher 내에서 처리해야 한다. **따라서 stale 성공 시 fetcher가 stale 데이터를 반환하도록 구현한다** (cache.set이 호출되어 stale 데이터가 새로 캐시됨 -- 이는 의도된 동작: oracle 전체 장애 시 stale 데이터로 연명).

**openapi-schemas.ts 수정:**

OracleStatusResponseSchema 추가:

```typescript
export const OracleStatusResponseSchema = z.object({
  cache: z.object({
    hits: z.number(),
    misses: z.number(),
    staleHits: z.number(),
    size: z.number(),
    evictions: z.number(),
  }),
  sources: z.object({
    pyth: z.object({
      available: z.boolean(),
      baseUrl: z.string(),
    }),
    coingecko: z.object({
      available: z.boolean(),
      apiKeyConfigured: z.boolean(),
    }),
  }),
  crossValidation: z.object({
    enabled: z.boolean(),
    threshold: z.number(),
  }),
});
```

import 목록에 `OracleStatusResponseSchema` 추가.

**admin.ts 수정:**

1. 파일 상단 주석에 `GET /admin/oracle-status` 추가 (13번째 엔드포인트)
2. `AdminRouteDeps` 인터페이스에 추가:
   ```typescript
   priceOracle?: IPriceOracle;
   oracleConfig?: { coingeckoApiKeyConfigured: boolean; crossValidationThreshold: number; };
   ```
3. openapi-schemas.ts import에 `OracleStatusResponseSchema` 추가
4. route 정의 추가:
   ```typescript
   const oracleStatusRoute = createRoute({
     method: 'get',
     path: '/admin/oracle-status',
     tags: ['Admin'],
     summary: 'Get oracle cache statistics and source status',
     responses: {
       200: {
         description: 'Oracle status',
         content: { 'application/json': { schema: OracleStatusResponseSchema } },
       },
     },
   });
   ```
5. `adminRoutes()` 함수 내에 핸들러 추가:
   ```typescript
   router.openapi(oracleStatusRoute, async (c) => {
     const stats = deps.priceOracle?.getCacheStats() ?? { hits: 0, misses: 0, staleHits: 0, size: 0, evictions: 0 };
     return c.json({
       cache: stats,
       sources: {
         pyth: { available: !!deps.priceOracle, baseUrl: 'https://hermes.pyth.network' },
         coingecko: {
           available: deps.oracleConfig?.coingeckoApiKeyConfigured ?? false,
           apiKeyConfigured: deps.oracleConfig?.coingeckoApiKeyConfigured ?? false,
         },
       },
       crossValidation: {
         enabled: deps.oracleConfig?.coingeckoApiKeyConfigured ?? false,
         threshold: deps.oracleConfig?.crossValidationThreshold ?? 5,
       },
     }, 200);
   });
   ```

**index.ts 업데이트:** OracleChain, OracleChainDeps를 re-export.

테스트를 실행하여 모두 GREEN인지 확인한다.
  </action>
  <verify>
`cd packages/daemon && npx vitest run src/__tests__/oracle-chain.test.ts --reporter=verbose` -- 모든 15개 테스트 PASS
`cd packages/daemon && npx vitest run --reporter=verbose 2>&1 | tail -5` -- 전체 daemon 테스트 회귀 없음
`cd packages/daemon && npx tsc --noEmit` -- 타입 에러 없음
  </verify>
  <done>OracleChain이 3단계 fallback + 교차 검증을 구현하고, GET /admin/oracle-status가 캐시/소스/교차검증 상태를 반환하며, 15개 테스트 PASS 및 전체 회귀 없음</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/__tests__/oracle-chain.test.ts` -- 15개 테스트 PASS
2. `npx vitest run src/__tests__/pyth-oracle.test.ts` -- 여전히 PASS (회귀 없음)
3. `npx vitest run src/__tests__/coingecko-oracle.test.ts` -- 여전히 PASS (회귀 없음)
4. `npx vitest run` -- 전체 daemon 테스트 회귀 없음
5. `npx tsc --noEmit` -- 타입 에러 없음
6. OracleChain이 InMemoryPriceCache.getOrFetch()를 사용하는 것 확인
7. GET /admin/oracle-status 응답 구조가 OracleStatusResponseSchema와 일치
</verification>

<success_criteria>
- OracleChain.getPrice()가 Pyth -> CoinGecko -> Stale Cache 3단계 fallback 동작
- 편차>5% 교차 검증이 isStale=true로 격하
- CoinGecko 키 미설정 시 교차 검증 스킵
- GET /admin/oracle-status가 캐시/소스/교차검증 상태 반환
- 15개 테스트 PASS, 전체 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/126-oracle-implementations/126-03-SUMMARY.md`
</output>
