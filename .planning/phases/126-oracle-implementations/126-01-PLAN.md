---
phase: 126-oracle-implementations
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts
  - packages/daemon/src/infrastructure/oracle/pyth-oracle.ts
  - packages/daemon/src/__tests__/pyth-oracle.test.ts
autonomous: true

must_haves:
  truths:
    - "PythOracle.getPrice()가 Pyth Hermes REST API를 호출하여 SOL/ETH/BTC USD 가격을 PriceInfo로 반환한다"
    - "PythOracle.getPrices()가 여러 토큰을 하나의 배치 API 호출로 조회한다"
    - "PythOracle.getNativePrice('solana'|'ethereum')가 네이티브 토큰 가격을 반환한다"
    - "Feed ID 미등록 토큰에서 PriceNotAvailableError를 throw한다 (OracleChain의 CoinGecko fallback 트리거)"
    - "Pyth API 장애 시 적절한 에러를 throw한다 (OracleChain의 fallback 트리거)"
  artifacts:
    - path: "packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts"
      provides: "SOL/ETH/USDC/USDT/BTC feed ID 하드코딩 맵 + 네이티브 토큰 맵"
      contains: "PYTH_FEED_IDS"
    - path: "packages/daemon/src/infrastructure/oracle/pyth-oracle.ts"
      provides: "PythOracle class implementing IPriceOracle"
      exports: ["PythOracle"]
    - path: "packages/daemon/src/__tests__/pyth-oracle.test.ts"
      provides: "PythOracle 단위 테스트 (fetch mock 기반)"
  key_links:
    - from: "packages/daemon/src/infrastructure/oracle/pyth-oracle.ts"
      to: "packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts"
      via: "PYTH_FEED_IDS import"
      pattern: "import.*PYTH_FEED_IDS"
    - from: "packages/daemon/src/infrastructure/oracle/pyth-oracle.ts"
      to: "packages/core/src/interfaces/price-oracle.types.ts"
      via: "IPriceOracle implements"
      pattern: "implements IPriceOracle"
---

<objective>
PythOracle 구현: Pyth Hermes REST API 기반 가격 조회 + Feed ID 하드코딩 매핑

Purpose: Pyth Hermes API로 SOL/ETH/BTC 등 주요 토큰의 USD 가격을 Zero-config(API 키 불필요)로 조회하는 IPriceOracle 구현체를 TDD로 구현한다. 캐시는 직접 관리하지 않고 순수 API 호출 + PriceInfo 변환만 수행한다 (캐시 관리는 OracleChain 전담).

Output: pyth-feed-ids.ts, pyth-oracle.ts, pyth-oracle.test.ts
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/125-design-docs-oracle-interfaces/125-02-SUMMARY.md
@.planning/phases/126-oracle-implementations/126-RESEARCH.md
@packages/core/src/interfaces/price-oracle.types.ts
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/index.ts
@packages/daemon/src/__tests__/price-cache.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED -- PythOracle + pyth-feed-ids 테스트 작성</name>
  <files>
    packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts
    packages/daemon/src/__tests__/pyth-oracle.test.ts
  </files>
  <action>
**pyth-feed-ids.ts 생성:**

Feed ID 하드코딩 맵을 생성한다. 캐시키(`chain:address`) -> Pyth feed ID (hex, 0x 없이) 매핑:
- SOL/USD: `solana:native` -> `ef0d8b6fda2ceba41da15d4095d1da392a0d2f8ed0c6c7bc0f4cfac8c280b56d`
- ETH/USD: `ethereum:native` -> `ff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace`
- USDC/USD (Solana): `solana:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v` -> `eaa020c61cc479712813461ce153894a96a6c00b21ed0cfc2798d1f9a9e9c94a`
- USDT/USD (Solana): `solana:Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB` -> `2b89b9dc8fdf9f34709a5b106b472f0f39bb6ca9ce04b0fd7f2e971688e2e53b`
- BTC/USD: BTC feed -> `e62df6c8b4a85fe1a67db44dc12de5db330f7ac66b72dc658afedf0f4a415b43`

또한 네이티브 토큰 매핑 헬퍼 함수 `getNativeFeedId(chain: ChainType): string | undefined`를 export한다.
feed ID 조회 함수 `getFeedId(cacheKey: string): string | undefined`를 export한다.

**pyth-oracle.test.ts 생성 (RED 단계):**

TDD RED: 아직 PythOracle이 존재하지 않으므로 import가 실패해야 함. 테스트만 작성:

1. `getPrice() - SOL/USD 가격 반환`: global.fetch를 mock하여 Pyth Hermes API 응답(parsed: [{ id, price: { price: "18413602312", conf: "17716632", expo: -8 }, ... }])을 반환. PythOracle.getPrice({ address: 'native', decimals: 9, chain: 'solana' })가 usdPrice=184.13602312, source='pyth', confidence 정상을 반환하는지 검증.

2. `getPrice() - ETH/USD 가격 반환`: 유사하게 ETH feed 응답 mock.

3. `getPrice() - feed ID 미등록 토큰은 PriceNotAvailableError throw`: 존재하지 않는 주소에 대해 getPrice() 호출 시 에러 throw 검증.

4. `getPrice() - Pyth API HTTP 에러 시 에러 throw`: fetch가 500 반환 시 에러 검증.

5. `getPrice() - 5초 타임아웃 사용`: fetch 호출 시 AbortSignal.timeout(5000) 전달 검증.

6. `getPrices() - 배치 조회`: 여러 토큰을 한 번의 API 호출로 조회. URL에 여러 ids[] 파라미터가 포함되는지 검증.

7. `getNativePrice('solana') - SOL 가격 반환`: 내부적으로 getPrice를 native 주소로 호출.

8. `getNativePrice('ethereum') - ETH 가격 반환`: 유사.

9. `getCacheStats() - 빈 stats 반환`: PythOracle은 캐시를 직접 관리하지 않으므로 모든 카운터가 0인 CacheStats 반환.

10. `Pyth 가격 변환 정밀도`: price="6700000000000", expo=-8 -> usdPrice=67000.0 검증 (BTC 범위).

Mock 패턴: `vi.stubGlobal('fetch', vi.fn())` 사용. beforeEach에서 fetch mock 리셋.

**PriceNotAvailableError**: PythOracle에서 throw할 에러 클래스. 기존 `ChainError extends Error` 패턴을 따라 `PriceNotAvailableError extends Error`로 정의 (pyth-oracle.ts에 co-locate하거나 별도 파일). 테스트에서는 import 경로만 미리 결정해둔다.

테스트를 실행하면 PythOracle 모듈이 없어서 실패해야 한다.
  </action>
  <verify>
`cd packages/daemon && npx vitest run src/__tests__/pyth-oracle.test.ts --reporter=verbose 2>&1 | tail -20` -- 모든 테스트가 FAIL (import 에러 또는 PythOracle 미존재)
  </verify>
  <done>pyth-feed-ids.ts에 5+ 토큰 feed ID가 매핑되고, pyth-oracle.test.ts에 10개 테스트가 존재하며 모두 RED 상태</done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN -- PythOracle 구현</name>
  <files>
    packages/daemon/src/infrastructure/oracle/pyth-oracle.ts
    packages/daemon/src/infrastructure/oracle/index.ts
  </files>
  <action>
**pyth-oracle.ts 생성:**

`PythOracle` 클래스를 구현한다. IPriceOracle 인터페이스를 implements:

```typescript
export class PythOracle implements IPriceOracle {
  private static readonly HERMES_BASE_URL = 'https://hermes.pyth.network';
  private static readonly TIMEOUT_MS = 5000;

  async getPrice(token: TokenRef): Promise<PriceInfo> { ... }
  async getPrices(tokens: TokenRef[]): Promise<Map<string, PriceInfo>> { ... }
  async getNativePrice(chain: ChainType): Promise<PriceInfo> { ... }
  getCacheStats(): CacheStats { ... }
}
```

핵심 로직:
1. `getPrice()`: buildCacheKey(chain, address) -> getFeedId(cacheKey) -> feed ID 없으면 PriceNotAvailableError throw -> `GET /v2/updates/price/latest?ids[]=0x${feedId}&parsed=true` fetch (AbortSignal.timeout(5000)) -> 응답 파싱 -> PriceInfo 반환
2. `getPrices()`: 토큰 배열에서 feed ID가 있는 것만 필터 -> 하나의 배치 URL로 조합 (`?ids[]=0x${id1}&ids[]=0x${id2}&parsed=true`) -> fetch -> 응답의 parsed 배열을 순회하며 feedId -> cacheKey 역매핑 -> Map<cacheKey, PriceInfo> 반환. feed ID 없는 토큰은 건너뜀 (OracleChain이 fallback 처리).
3. `getNativePrice()`: `{ address: 'native', decimals: chain==='solana' ? 9 : 18, chain }` 토큰 생성 후 getPrice() 위임.
4. `getCacheStats()`: 캐시를 직접 관리하지 않으므로 `{ hits: 0, misses: 0, staleHits: 0, size: 0, evictions: 0 }` 반환.

Pyth 가격 변환:
```typescript
const rawPrice = Number(feed.price.price);
const expo = feed.price.expo;
const usdPrice = rawPrice * Math.pow(10, expo);
const rawConf = Number(feed.price.conf);
const confUsd = rawConf * Math.pow(10, expo);
const confidence = usdPrice > 0 ? Math.max(0, 1 - (confUsd / usdPrice)) : undefined;
```

PriceInfo 생성:
```typescript
const now = Date.now();
return { usdPrice, confidence, source: 'pyth', fetchedAt: now, expiresAt: now + 300_000, isStale: false };
```

**PriceNotAvailableError**: pyth-oracle.ts 상단에 정의:
```typescript
export class PriceNotAvailableError extends Error {
  constructor(public readonly cacheKey: string) {
    super(`Price not available for ${cacheKey}`);
    this.name = 'PriceNotAvailableError';
  }
}
```

**index.ts 업데이트:** PythOracle, PriceNotAvailableError, pyth-feed-ids의 getFeedId/getNativeFeedId를 re-export.

테스트를 실행하여 모두 GREEN인지 확인한다.
  </action>
  <verify>
`cd packages/daemon && npx vitest run src/__tests__/pyth-oracle.test.ts --reporter=verbose` -- 모든 10개 테스트 PASS
`cd packages/daemon && npx vitest run --reporter=verbose 2>&1 | tail -5` -- 전체 daemon 테스트 회귀 없음
  </verify>
  <done>PythOracle이 IPriceOracle을 구현하고, 10개 테스트가 모두 PASS하며, 기존 daemon 테스트에 회귀가 없다</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/__tests__/pyth-oracle.test.ts` -- 10개 테스트 PASS
2. `npx vitest run` -- 전체 daemon 테스트 회귀 없음
3. `npx tsc --noEmit` in packages/daemon -- 타입 에러 없음
4. PythOracle이 캐시를 직접 조작하지 않는 것 확인 (import InMemoryPriceCache 없어야 함)
</verification>

<success_criteria>
- PythOracle.getPrice()가 Pyth Hermes API 응답을 PriceInfo로 정확히 변환한다
- Feed ID 미등록 토큰에서 PriceNotAvailableError를 throw한다
- getPrices()가 배치 API 호출을 사용한다
- 10개 테스트 PASS, 전체 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/126-oracle-implementations/126-01-SUMMARY.md`
</output>
