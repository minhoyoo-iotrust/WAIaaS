---
phase: 126-oracle-implementations
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts
  - packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/__tests__/coingecko-oracle.test.ts
autonomous: true

must_haves:
  truths:
    - "CoinGeckoOracle.getPrice()가 CoinGecko Demo API로 컨트랙트 주소 기반 토큰 가격을 PriceInfo로 반환한다"
    - "CoinGeckoOracle.getNativePrice()가 /simple/price 엔드포인트로 SOL/ETH 네이티브 가격을 반환한다"
    - "CoinGeckoOracle.getPrices()가 comma-separated 배치 조회로 여러 토큰을 한 번에 조회한다"
    - "API 키 미설정 시 CoinGeckoOracle 생성자가 에러를 throw하지 않고, getPrice() 호출 시 에러를 throw한다"
    - "SettingsService에 oracle.coingecko_api_key, oracle.cross_validation_threshold 설정 키가 등록되어 있다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts"
      provides: "CoinGecko platformId + nativeCoinId 매핑"
      contains: "COINGECKO_PLATFORM_MAP"
    - path: "packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts"
      provides: "CoinGeckoOracle class implementing IPriceOracle"
      exports: ["CoinGeckoOracle"]
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "oracle 카테고리 설정 키 (coingecko_api_key, cross_validation_threshold)"
      contains: "oracle.coingecko_api_key"
    - path: "packages/daemon/src/__tests__/coingecko-oracle.test.ts"
      provides: "CoinGeckoOracle 단위 테스트 (fetch mock 기반)"
  key_links:
    - from: "packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts"
      to: "packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts"
      via: "COINGECKO_PLATFORM_MAP import"
      pattern: "import.*COINGECKO_PLATFORM_MAP"
    - from: "packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts"
      to: "packages/core/src/interfaces/price-oracle.types.ts"
      via: "IPriceOracle implements"
      pattern: "implements IPriceOracle"
---

<objective>
CoinGeckoOracle 구현: Demo API 기반 롱테일 토큰 가격 조회 + platformId 매핑 + SettingsService oracle 카테고리 확장

Purpose: CoinGecko Demo API로 컨트랙트 주소 기반 SPL/ERC-20 토큰 및 네이티브 토큰(SOL/ETH)의 USD 가격을 조회하는 IPriceOracle 구현체를 TDD로 구현한다. API 키는 SettingsService의 oracle 카테고리에서 관리한다. 캐시는 직접 관리하지 않는다.

Output: coingecko-platform-ids.ts, coingecko-oracle.ts, setting-keys.ts (수정), coingecko-oracle.test.ts
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/125-design-docs-oracle-interfaces/125-02-SUMMARY.md
@.planning/phases/126-oracle-implementations/126-RESEARCH.md
@packages/core/src/interfaces/price-oracle.types.ts
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/index.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/__tests__/price-cache.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED -- CoinGeckoOracle + platformId 매핑 + 설정 키 확장 테스트 작성</name>
  <files>
    packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/__tests__/coingecko-oracle.test.ts
  </files>
  <action>
**coingecko-platform-ids.ts 생성:**

CoinGecko API의 platformId와 nativeCoinId 매핑:

```typescript
interface CoinGeckoPlatform {
  platformId: string;   // /simple/token_price/{platformId} 경로에 사용
  nativeCoinId: string; // /simple/price?ids={nativeCoinId} 경로에 사용
}

export const COINGECKO_PLATFORM_MAP: Record<string, CoinGeckoPlatform> = {
  solana: { platformId: 'solana', nativeCoinId: 'solana' },
  ethereum: { platformId: 'ethereum', nativeCoinId: 'ethereum' },
};

export function getCoinGeckoPlatform(chain: string): CoinGeckoPlatform | undefined {
  return COINGECKO_PLATFORM_MAP[chain];
}
```

**setting-keys.ts 수정:**

1. `SETTING_CATEGORIES` 배열에 `'oracle'` 추가
2. `SETTING_DEFINITIONS` 배열에 두 항목 추가:
   - `{ key: 'oracle.coingecko_api_key', category: 'oracle', configPath: 'oracle.coingecko_api_key', defaultValue: '', isCredential: true }`
   - `{ key: 'oracle.cross_validation_threshold', category: 'oracle', configPath: 'oracle.cross_validation_threshold', defaultValue: '5', isCredential: false }`

**coingecko-oracle.test.ts 생성 (RED 단계):**

TDD RED: CoinGeckoOracle이 아직 없으므로 import 실패. 테스트만 작성:

1. `getPrice() - SPL 토큰 가격 반환`: global.fetch mock으로 CoinGecko `/simple/token_price/solana?contract_addresses=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v&vs_currencies=usd&include_last_updated_at=true` 응답 mock. 결과 PriceInfo의 usdPrice, source='coingecko' 검증.

2. `getPrice() - ERC-20 토큰 가격 반환`: EVM 토큰 주소(lowercase 변환됨)로 platformId='ethereum' 조회 검증.

3. `getNativePrice('solana') - /simple/price 엔드포인트 사용`: CoinGecko `/simple/price?ids=solana&vs_currencies=usd&include_last_updated_at=true` 호출 검증. usdPrice 반환 검증.

4. `getNativePrice('ethereum') - ETH 네이티브 가격`: `/simple/price?ids=ethereum` 검증.

5. `getPrices() - 배치 조회 (comma-separated addresses)`: 여러 토큰을 `contract_addresses=addr1,addr2` 형태로 한 번에 조회. API 호출 횟수가 1회인지 검증.

6. `getPrices() - 혼합 체인 토큰은 체인별로 그룹화하여 API 호출`: solana 토큰 2개 + ethereum 토큰 1개 -> 2회 API 호출 (platformId별 1회씩).

7. `getPrice() - API 키 미설정 시 에러 throw`: apiKey가 빈 문자열일 때 CoinGeckoNotConfiguredError throw.

8. `getPrice() - CoinGecko API HTTP 에러 시 에러 throw`: fetch가 429 Too Many Requests 반환 시 에러 검증.

9. `getPrice() - 5초 타임아웃 사용`: fetch 호출 시 AbortSignal.timeout(5000) 전달 검증.

10. `getCacheStats() - 빈 stats 반환`: 캐시를 직접 관리하지 않으므로 모든 카운터가 0.

11. `x-cg-demo-api-key 헤더 전송`: fetch 호출 시 headers에 `x-cg-demo-api-key` 헤더가 포함되는지 검증.

12. `getPrice() - CoinGecko 응답에 토큰이 없으면 PriceNotAvailableError`: 응답이 `{}` (빈 객체)이면 에러 throw.

Mock 패턴: `vi.stubGlobal('fetch', vi.fn())`. CoinGeckoOracle 생성자에 apiKey를 인자로 전달하는 방식.

테스트를 실행하면 CoinGeckoOracle 모듈이 없어서 실패해야 한다.
  </action>
  <verify>
`cd packages/daemon && npx vitest run src/__tests__/coingecko-oracle.test.ts --reporter=verbose 2>&1 | tail -20` -- 모든 테스트 FAIL (import 에러)
SettingsService oracle 키 검증: `grep -c 'oracle\.' packages/daemon/src/infrastructure/settings/setting-keys.ts` -- 2개 이상 매칭
  </verify>
  <done>coingecko-platform-ids.ts에 solana/ethereum platformId 매핑, setting-keys.ts에 oracle 카테고리 2개 키 추가, coingecko-oracle.test.ts에 12개 테스트 RED 상태</done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN -- CoinGeckoOracle 구현</name>
  <files>
    packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
    packages/daemon/src/infrastructure/oracle/index.ts
  </files>
  <action>
**coingecko-oracle.ts 생성:**

`CoinGeckoOracle` 클래스를 구현한다. IPriceOracle 인터페이스를 implements:

```typescript
export class CoinGeckoNotConfiguredError extends Error {
  constructor() {
    super('CoinGecko API key not configured');
    this.name = 'CoinGeckoNotConfiguredError';
  }
}

export class CoinGeckoOracle implements IPriceOracle {
  private static readonly BASE_URL = 'https://api.coingecko.com/api/v3';
  private static readonly TIMEOUT_MS = 5000;

  constructor(private readonly apiKey: string) {}

  async getPrice(token: TokenRef): Promise<PriceInfo> { ... }
  async getPrices(tokens: TokenRef[]): Promise<Map<string, PriceInfo>> { ... }
  async getNativePrice(chain: ChainType): Promise<PriceInfo> { ... }
  getCacheStats(): CacheStats { ... }
}
```

핵심 로직:

1. `getPrice()`:
   - apiKey가 빈 문자열이면 CoinGeckoNotConfiguredError throw
   - token.address === 'native'이면 getNativePrice(token.chain)으로 위임
   - getCoinGeckoPlatform(token.chain) -> platformId 없으면 PriceNotAvailableError throw
   - `GET /simple/token_price/${platformId}?contract_addresses=${address}&vs_currencies=usd&include_last_updated_at=true` fetch
   - 헤더: `{ 'x-cg-demo-api-key': this.apiKey }`
   - signal: `AbortSignal.timeout(5000)`
   - 응답 파싱: `data[address.toLowerCase()]?.usd` 없으면 PriceNotAvailableError
   - PriceInfo 생성: `{ usdPrice, source: 'coingecko', fetchedAt: now, expiresAt: now + 300_000, isStale: false }`
   - CoinGecko는 confidence 정보를 제공하지 않으므로 confidence undefined

2. `getNativePrice()`:
   - getCoinGeckoPlatform(chain) -> nativeCoinId
   - `GET /simple/price?ids=${nativeCoinId}&vs_currencies=usd&include_last_updated_at=true` fetch
   - 응답: `data[nativeCoinId]?.usd`
   - PriceInfo 변환

3. `getPrices()`:
   - 토큰을 chain별로 그룹화: `Map<ChainType, TokenRef[]>`
   - 네이티브 토큰과 비네이티브 토큰 분리
   - 각 chain의 비네이티브 토큰: `contract_addresses=addr1,addr2,...` comma-separated 배치 조회
   - 각 네이티브 토큰: getNativePrice() 호출
   - 결과를 Map<cacheKey, PriceInfo>로 통합 반환
   - 개별 토큰 조회 실패는 건너뜀 (Map에 포함하지 않음, 에러 전파 안 함)

4. `getCacheStats()`: `{ hits: 0, misses: 0, staleHits: 0, size: 0, evictions: 0 }`

**PriceNotAvailableError 재사용:** Plan 126-01에서 PythOracle에 정의한 PriceNotAvailableError를 import하여 사용. 만약 126-01과 126-02가 병렬(Wave 1)로 실행될 경우를 대비하여, PriceNotAvailableError가 아직 없으면 coingecko-oracle.ts에 자체 정의하되, 126-01의 것과 동일한 시그니처를 사용한다. index.ts에서 re-export할 때 충돌을 피하기 위해, PriceNotAvailableError는 별도 파일(예: oracle-errors.ts)로 분리하는 것이 이상적이다. **결정: oracle-errors.ts 파일을 생성하여 PriceNotAvailableError와 CoinGeckoNotConfiguredError를 모두 배치. 126-01의 pyth-oracle.ts에서도 이 파일에서 import하도록 index.ts 경유.**

실제 구현 시: 만약 126-01이 먼저 완료되어 PriceNotAvailableError가 pyth-oracle.ts에 이미 존재하면, 해당 클래스를 oracle-errors.ts로 이동하고 pyth-oracle.ts의 import를 업데이트한다. 126-01이 아직 미완료면 oracle-errors.ts에 새로 생성한다.

**index.ts 업데이트:** CoinGeckoOracle, CoinGeckoNotConfiguredError, coingecko-platform-ids의 getCoinGeckoPlatform을 re-export. PriceNotAvailableError도 oracle-errors.ts에서 re-export.

테스트를 실행하여 모두 GREEN인지 확인한다.
  </action>
  <verify>
`cd packages/daemon && npx vitest run src/__tests__/coingecko-oracle.test.ts --reporter=verbose` -- 모든 12개 테스트 PASS
`cd packages/daemon && npx vitest run --reporter=verbose 2>&1 | tail -5` -- 전체 daemon 테스트 회귀 없음
  </verify>
  <done>CoinGeckoOracle이 IPriceOracle을 구현하고, 12개 테스트가 모두 PASS하며, oracle 설정 키가 SettingsService에 등록되어 있다</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/__tests__/coingecko-oracle.test.ts` -- 12개 테스트 PASS
2. `npx vitest run` -- 전체 daemon 테스트 회귀 없음
3. `npx tsc --noEmit` in packages/daemon -- 타입 에러 없음
4. CoinGeckoOracle이 캐시를 직접 조작하지 않는 것 확인 (import InMemoryPriceCache 없어야 함)
5. setting-keys.ts에 oracle 카테고리 2개 키 존재 확인
</verification>

<success_criteria>
- CoinGeckoOracle.getPrice()가 CoinGecko Demo API 응답을 PriceInfo로 변환한다
- API 키 미설정 시 CoinGeckoNotConfiguredError throw
- getPrices()가 comma-separated 배치 조회 사용
- oracle.coingecko_api_key, oracle.cross_validation_threshold 설정 키 등록
- 12개 테스트 PASS, 전체 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/126-oracle-implementations/126-02-SUMMARY.md`
</output>
