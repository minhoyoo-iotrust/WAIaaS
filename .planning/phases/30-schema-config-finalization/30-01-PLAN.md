---
phase: 30-schema-config-finalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/24-monorepo-data-directory.md
  - .planning/deliverables/25-sqlite-schema.md
autonomous: true

must_haves:
  truths:
    - "config.toml에 중첩 섹션([rpc.solana], [notifications.telegram] 등)이 존재하지 않고, 모든 키가 [section] 내 평탄화된 snake_case 키로 정의되어 있다"
    - "환경변수 매핑 규칙이 WAIAAS_{SECTION}_{KEY} 형태의 1:1 대응으로 확정되어 있다"
    - "Zod ConfigSchema가 평탄화된 구조를 반영하고, 중첩 섹션 사용 시 명시적 에러 메시지를 제공한다"
    - "applyEnvOverrides 함수가 평탄화된 구조에 맞게 단순화되어 있다"
    - "모든 SQLite 타임스탬프가 초 단위(Unix epoch INTEGER)로 통일 확정되어 있고, audit_log 밀리초 고려 주석이 삭제되어 UUID v7 시간 정밀도 활용으로 대체되었다"
  artifacts:
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "평탄화된 config.toml 구조, 환경변수 매핑 규칙, Zod ConfigSchema, applyEnvOverrides"
      contains: "WAIAAS_.*SECTION.*KEY|solana_mainnet|중첩.*금지|detectNestedSections|applyEnvOverrides"
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "타임스탬프 전체 초 단위 확정, UUID v7 시간 정밀도 근거"
      contains: "초 단위.*통일|UUID v7.*ms.*정밀도|밀리초.*삭제"
  key_links:
    - from: ".planning/deliverables/24-monorepo-data-directory.md"
      to: ".planning/deliverables/35-notification-architecture.md"
      via: "[notifications] 섹션의 평탄화된 키가 35-notification의 확장 키(min_channels 등)와 정합"
      pattern: "notifications.*min_channels|telegram_bot_token|discord_webhook_url"
    - from: ".planning/deliverables/24-monorepo-data-directory.md"
      to: ".planning/deliverables/29-api-framework-design.md"
      via: "평탄화된 config 구조를 미들웨어가 올바르게 참조"
      pattern: "solana_mainnet|config\\.rpc"
---

<objective>
config.toml 중첩 섹션을 평탄화하여 환경변수 매핑 규칙을 WAIAAS_{SECTION}_{KEY}로 확정하고, SQLite 타임스탬프를 전체 초 단위로 통일 확정한다.

Purpose: 구현 시 환경변수 오버라이드가 1:1 단순 매핑으로 동작하고, 타임스탬프 정밀도 관련 미결정 사항을 제거하여 DB 관련 혼란을 방지한다.
Output: 2개 설계 문서 수정 (24-monorepo, 25-sqlite) -- SCHEMA-01, SCHEMA-02 해소
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-schema-config-finalization/30-RESEARCH.md

@.planning/deliverables/24-monorepo-data-directory.md
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/35-notification-architecture.md

@objectives/v0.7-implementation-blockers-resolution.md (E-1, E-2 섹션 참조)
</context>

<tasks>

<task type="auto">
  <name>Task 1: config.toml 중첩 섹션 평탄화 + 환경변수 매핑 규칙 확정 (SCHEMA-01)</name>
  <files>.planning/deliverables/24-monorepo-data-directory.md</files>
  <action>
24-monorepo-data-directory.md의 섹션 3.2~3.5를 전면 수정한다. v0.7 objectives E-1의 해결 방향을 정확히 따른다.

**섹션 3.2 (환경변수 매핑 규칙):**
- 기존 중첩 매핑 테이블을 평탄화된 테이블로 교체
- 매핑 규칙 확정: `WAIAAS_` + SECTION(대문자) + `_` + KEY(대문자, 언더스코어 구분)
- 모든 기존 중첩 참조를 평탄 참조로 변경:
  - `[rpc.solana].mainnet` -> `[rpc].solana_mainnet` -> `WAIAAS_RPC_SOLANA_MAINNET`
  - `[rpc.solana.ws].mainnet` -> `[rpc].solana_ws_mainnet` -> `WAIAAS_RPC_SOLANA_WS_MAINNET`
  - `[notifications.telegram].bot_token` -> `[notifications].telegram_bot_token` -> `WAIAAS_NOTIFICATIONS_TELEGRAM_BOT_TOKEN`
  - `[notifications.discord].webhook_url` -> `[notifications].discord_webhook_url` -> `WAIAAS_NOTIFICATIONS_DISCORD_WEBHOOK_URL`
  - `[notifications.ntfy].server` -> `[notifications].ntfy_server` -> `WAIAAS_NOTIFICATIONS_NTFY_SERVER`
  - `[security.auto_stop].consecutive_failures_threshold` -> `[security].auto_stop_consecutive_failures_threshold` -> `WAIAAS_SECURITY_AUTO_STOP_CONSECUTIVE_FAILURES_THRESHOLD`
  - `[security.policy_defaults].delay_seconds` -> `[security].policy_defaults_delay_seconds`
  - `[security.kill_switch].recovery_cooldown` -> `[security].kill_switch_recovery_cooldown`
- 중첩 섹션 금지 규칙을 명시적으로 문서화: "[v0.7 보완] config.toml은 1단계 섹션만 허용. [rpc.solana] 같은 중첩 섹션은 금지."

**섹션 3.3 (전체 키-값 구조):**
- 모든 중첩 구조를 평탄화된 구조로 재작성
- 35-notification-architecture.md 섹션 12.4의 확장 키(min_channels, health_check_interval, log_retention_days, dedup_ttl)도 [notifications] 섹션에 평탄화하여 포함

**섹션 3.4 (기본 config.toml 예시):**
- 전체 예시를 평탄화된 구조로 재작성. 30-RESEARCH.md의 "After (평탄화)" 예시를 기반으로 하되, 모든 섹션(server, rpc, security, notifications, logging, nonce_storage)을 포함

**섹션 3.5 (설정 로드 구현):**
- ConfigSchema Zod 구조를 평탄화 반영:
  - 기존 `rpc: z.object({ solana: z.object({ mainnet: ... }) })` 구조를 `rpc: z.object({ solana_mainnet: ... })` 구조로 변경
  - 마찬가지로 notifications, security 섹션 평탄화
- applyEnvOverrides 함수 단순화: 중첩 접근 로직 제거, `WAIAAS_{SECTION}_{KEY}` 직접 매핑
- detectNestedSections 유틸리티 함수 추가: TOML 파싱 후 2단계 이상 중첩 감지 시 친절한 에러 메시지 제공
  - 에러 메시지 예시: "중첩 섹션 [rpc.solana]이(가) 감지되었습니다. [rpc] 섹션 내 'solana_mainnet' 키를 사용하세요."
- [v0.7 보완] 태그 추가

환경변수명이 길어지는 것(예: WAIAAS_SECURITY_AUTO_STOP_CONSECUTIVE_FAILURES_THRESHOLD)은 의도된 tradeoff이다. 매핑 규칙의 단순성과 일관성이 더 중요하므로 이에 대한 주석도 추가한다.
  </action>
  <verify>
24-monorepo-data-directory.md에서 다음을 확인:
1. `[rpc.solana]`, `[notifications.telegram]`, `[security.auto_stop]` 같은 중첩 섹션이 존재하지 않음 (grep으로 검증)
2. `WAIAAS_{SECTION}_{KEY}` 매핑 규칙이 명시적으로 기술되어 있음
3. ConfigSchema Zod 구조가 평탄화됨 (z.object 중첩이 1단계만)
4. applyEnvOverrides가 단순화됨
5. detectNestedSections 유틸리티가 추가됨
6. [v0.7 보완] 태그 존재
  </verify>
  <done>config.toml의 17개 중첩 키가 모두 평탄화되고, WAIAAS_{SECTION}_{KEY} 매핑 규칙이 확정되며, Zod 스키마에 중첩 감지 에러가 추가되어 SCHEMA-01이 완전 해소됨</done>
</task>

<task type="auto">
  <name>Task 2: SQLite 타임스탬프 전체 초 단위 통일 확정 (SCHEMA-02)</name>
  <files>.planning/deliverables/25-sqlite-schema.md</files>
  <action>
25-sqlite-schema.md의 섹션 1.3과 2.5를 수정한다. v0.7 objectives E-2의 해결 방향을 정확히 따른다.

**섹션 1.3 (타임스탬프 전략):**
- 기존 "밀리초 필요 시 mode: 'timestamp_ms' 사용 고려" 주석을 삭제
- 확정 문구로 교체:
  "[v0.7 보완] 모든 타임스탬프: Unix epoch 초 단위 (INTEGER). 예외 없음.
  동일 초 내 이벤트 순서는 UUID v7의 시간 정밀도(ms)로 자연 보장.
  audit_log 포함 전체 테이블에 mode: 'timestamp' (초) 적용 확정."
- UUID v7의 시간 정밀도 활용 근거를 간결하게 추가:
  - UUID v7은 타임스탬프 48비트(ms 정밀도)를 포함
  - id 컬럼 정렬이 곧 ms 수준 시간 정렬
  - 별도 밀리초 타임스탬프 컬럼 불필요

**섹션 2.5 (audit_log 테이블):**
- timestamp 컬럼 설명에서 밀리초 관련 문구("밀리초 정밀도 필요 시 mode: 'timestamp_ms' 고려" 등) 완전 제거
- 대신 "[v0.7 보완] 초 단위 확정. 동일 초 내 순서는 id (UUID v7) 정렬로 보장." 추가
  </action>
  <verify>
25-sqlite-schema.md에서 다음을 확인:
1. 섹션 1.3에 "밀리초" 또는 "timestamp_ms" 관련 미결정 주석이 없음
2. 초 단위 통일 확정 문구와 UUID v7 근거가 존재
3. 섹션 2.5 audit_log에서 밀리초 고려 문구가 삭제됨
4. [v0.7 보완] 태그 존재
  </verify>
  <done>모든 SQLite 타임스탬프가 초 단위로 통일 확정되고, audit_log 밀리초 고려 주석이 삭제되어 UUID v7 시간 정밀도 활용으로 대체됨. SCHEMA-02 완전 해소</done>
</task>

</tasks>

<verification>
**SCHEMA-01 검증:**
- 24-monorepo-data-directory.md에서 중첩 TOML 섹션(`[rpc.solana]`, `[notifications.telegram]`, `[security.auto_stop]`, `[security.policy_defaults]`, `[security.kill_switch]`, `[rpc.solana.ws]`) 이 하나도 남아있지 않음
- 환경변수 매핑 테이블이 평탄화된 키 기준으로 완전히 재작성됨
- ConfigSchema Zod가 1단계 중첩만 사용
- detectNestedSections 함수가 스펙에 포함됨

**SCHEMA-02 검증:**
- 25-sqlite-schema.md 전체에서 "timestamp_ms" 검색 결과 0건 (미결정 주석 완전 제거)
- "밀리초 고려" 또는 "밀리초 필요 시" 문구 0건
- UUID v7 시간 정밀도 근거 문구 존재
</verification>

<success_criteria>
1. config.toml 환경변수 매핑 규칙이 WAIAAS_{SECTION}_{KEY} 평탄화로 확정됨
2. 중첩 섹션 금지가 Zod 스키마에 detectNestedSections 에러 메시지로 반영됨
3. SQLite 타임스탬프가 전체 초 단위로 통일 확정됨
4. audit_log 밀리초 고려 주석이 삭제되고 UUID v7 시간 정밀도 활용으로 대체됨
</success_criteria>

<output>
After completion, create `.planning/phases/30-schema-config-finalization/30-01-SUMMARY.md`
</output>
