---
phase: 30-schema-config-finalization
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/45-enum-unified-mapping.md
  - .planning/deliverables/40-telegram-bot-docker.md
  - .planning/deliverables/35-notification-architecture.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/26-keystore-spec.md
  - .planning/deliverables/31-solana-adapter-detail.md
  - .planning/deliverables/29-api-framework-design.md
autonomous: true

must_haves:
  truths:
    - "agents 테이블에 chain CHECK ('solana', 'ethereum')과 network CHECK ('mainnet', 'devnet', 'testnet')이 Drizzle + DDL 양쪽에 정의되어 있다"
    - "45-enum에 ChainType과 NetworkType이 SSoT Enum으로 추가되어 있고, agents CHECK와 1:1 대응한다"
    - "network 값이 'mainnet'으로 통일되어 기존 문서의 'mainnet-beta' 참조가 모두 교체되었다"
    - "Docker UID 1001이 Dockerfile에 홈 디렉토리/WAIAAS_DATA_DIR과 함께 명시되어 있다"
    - "데몬 시작 시 데이터 디렉토리 소유권 확인 로직이 설계에 포함되어 있다"
    - "amount TEXT 유지 근거(JS number 정밀도 한계)가 25-sqlite에 보강 문서화되고 amount_lamports가 유보되었다"
    - "알림 채널 비활성화가 BEGIN IMMEDIATE 트랜잭션으로 동시성 보호되고, 물리 삭제 금지가 확정되었다"
    - "agents 테이블 CHECK 추가를 위한 테이블 재생성 마이그레이션 가이드가 있다"
  artifacts:
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "agents CHECK, amount TEXT 근거, 마이그레이션 가이드"
      contains: "CHECK.*chain.*IN.*solana.*ethereum|CHECK.*network.*IN.*mainnet|amount.*TEXT.*정밀도|테이블 재생성"
    - path: ".planning/deliverables/45-enum-unified-mapping.md"
      provides: "ChainType, NetworkType SSoT Enum"
      contains: "ChainType|NetworkType|solana.*ethereum|mainnet.*devnet.*testnet"
    - path: ".planning/deliverables/40-telegram-bot-docker.md"
      provides: "UID 1001 명시, WAIAAS_DATA_DIR, 소유권 확인"
      contains: "1001|WAIAAS_DATA_DIR|chown|소유권"
    - path: ".planning/deliverables/35-notification-architecture.md"
      provides: "BEGIN IMMEDIATE 채널 비활성화, 물리 삭제 금지"
      contains: "BEGIN IMMEDIATE|물리 삭제.*금지|enabled.*false|MIN_CHANNELS"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "network 값 'mainnet' 통일"
      contains: "mainnet(?!-beta)"
    - path: ".planning/deliverables/26-keystore-spec.md"
      provides: "network 값 'mainnet' 통일"
      contains: "mainnet(?!-beta)"
    - path: ".planning/deliverables/31-solana-adapter-detail.md"
      provides: "network 매핑 주석 (mainnet = mainnet-beta)"
      contains: "mainnet.*mainnet-beta|네트워크.*매핑"
    - path: ".planning/deliverables/29-api-framework-design.md"
      provides: "network 예시 통일"
      contains: "mainnet(?!-beta)"
  key_links:
    - from: ".planning/deliverables/25-sqlite-schema.md"
      to: ".planning/deliverables/45-enum-unified-mapping.md"
      via: "agents CHECK 값이 ChainType/NetworkType Enum SSoT와 1:1 대응"
      pattern: "ChainType.*solana.*ethereum|NetworkType.*mainnet.*devnet.*testnet"
    - from: ".planning/deliverables/25-sqlite-schema.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "agents.network CHECK 값과 REST API 예시의 network 값이 일치"
      pattern: "network.*mainnet"
    - from: ".planning/deliverables/35-notification-architecture.md"
      to: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      via: "BEGIN IMMEDIATE 패턴 동일 적용 (reserved_amount 선례)"
      pattern: "BEGIN IMMEDIATE"
---

<objective>
agents 테이블에 chain/network CHECK 제약을 추가하고 network 값을 통일하며, Docker UID 1001을 명시하고, amount TEXT 근거를 보강하며, 알림 채널 비활성화를 BEGIN IMMEDIATE로 보호한다.

Purpose: DB 스키마의 데이터 무결성과 Docker 배포의 권한 정합성을 확보하고, 잔여 미결정 사항(amount 근거, 채널 삭제 동시성)을 확정하여 v0.7의 마지막 6건 중 4건(SCHEMA-03~06)을 해소한다.
Output: 8개 설계 문서 수정 (25, 45, 40, 35, 37, 26, 31, 29) -- SCHEMA-03, SCHEMA-04, SCHEMA-05, SCHEMA-06 해소
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-schema-config-finalization/30-RESEARCH.md
@.planning/phases/30-schema-config-finalization/30-01-SUMMARY.md

@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/45-enum-unified-mapping.md
@.planning/deliverables/40-telegram-bot-docker.md
@.planning/deliverables/35-notification-architecture.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/26-keystore-spec.md
@.planning/deliverables/31-solana-adapter-detail.md
@.planning/deliverables/29-api-framework-design.md

@objectives/v0.7-implementation-blockers-resolution.md (E-3, E-4, E-5, E-6 섹션 참조)
</context>

<tasks>

<task type="auto">
  <name>Task 1: agents CHECK 제약 + network 값 통일 + amount TEXT 근거 (SCHEMA-03, SCHEMA-05)</name>
  <files>
    .planning/deliverables/25-sqlite-schema.md
    .planning/deliverables/45-enum-unified-mapping.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/26-keystore-spec.md
    .planning/deliverables/31-solana-adapter-detail.md
    .planning/deliverables/29-api-framework-design.md
  </files>
  <action>
**SCHEMA-03: agents 테이블 chain/network CHECK 제약조건 추가**

v0.7 objectives E-3의 해결 방향을 따르되, network 값은 옵션 A(E-3 원문: 'mainnet' | 'devnet' | 'testnet')를 적용한다. 30-RESEARCH.md의 권장 사항에 따라 네트워크명을 추상화한다.

1. **25-sqlite-schema.md 섹션 2.1 (agents 테이블):**
   - chain 컬럼에 CHECK 제약 추가: `CHECK (chain IN ('solana', 'ethereum'))`
   - network 컬럼에 CHECK 제약 추가: `CHECK (network IN ('mainnet', 'devnet', 'testnet'))`
   - Drizzle ORM 코드에 `$type<'solana' | 'ethereum'>()`, `$type<'mainnet' | 'devnet' | 'testnet'>()` 추가
   - Drizzle `check()` 함수로 테이블 레벨 CHECK 제약 추가 (30-RESEARCH.md 패턴 3의 코드 예시 참조)
   - [v0.7 보완] 태그 추가
   - 주석: "앱 레벨 network 값은 체인 무관 추상화. Solana의 'mainnet-beta'는 AdapterRegistry에서 RPC URL 매핑 시 변환."

2. **25-sqlite-schema.md 섹션 4.x (마이그레이션):**
   - agents 테이블에 CHECK 제약을 추가하려면 테이블 재생성이 필요함을 명시
   - 기존 섹션 4.6의 재생성 패턴(CREATE new -> INSERT SELECT -> DROP old -> RENAME)을 참조하여 agents 전용 마이그레이션 가이드 추가
   - [v0.7 보완] 태그

3. **45-enum-unified-mapping.md:**
   - ChainType Enum 추가: `'solana' | 'ethereum'` (2값)
   - NetworkType Enum 추가: `'mainnet' | 'devnet' | 'testnet'` (3값)
   - SSoT 파생 체인: `as const -> TS type -> Zod enum -> Drizzle $type -> DB CHECK`
   - agents 테이블의 chain/network CHECK와 1:1 대응 명시
   - [v0.7 보완] 태그

4. **network 값 'mainnet' 통일 (4개 문서):**
   E-3 옵션 A 적용에 따라, 기존 `mainnet-beta` 참조를 `mainnet`으로 교체한다.

   - **37-rest-api-complete-spec.md:** 모든 예시에서 `mainnet-beta` -> `mainnet` 교체. [v0.7 보완] 주석: "네트워크 값은 체인 무관 추상화. Solana RPC의 mainnet-beta와는 구분."
   - **26-keystore-spec.md:** network 값 예시에서 `mainnet-beta` -> `mainnet` 교체. Ethereum `sepolia` -> `testnet` 교체. [v0.7 보완] 태그.
   - **31-solana-adapter-detail.md:** Solana 네트워크 참조에서 `mainnet-beta` -> `mainnet` 교체. [v0.7 보완] 주석 추가: "앱 레벨 network='mainnet', Solana RPC endpoint는 api.mainnet-beta.solana.com 유지. AdapterRegistry가 매핑."
   - **29-api-framework-design.md:** 네트워크 관련 예시에서 `mainnet-beta` -> `mainnet` 교체. [v0.7 보완] 태그.

**SCHEMA-05: amount TEXT 근거 보강**

5. **25-sqlite-schema.md 섹션 2.3 (transactions 테이블):**
   - amount TEXT 유지 근거를 보강:
     - JavaScript `Number.MAX_SAFE_INTEGER` = 2^53 - 1 = 9,007,199,254,740,991
     - Solana lamport u64 최대: 18,446,744,073,709,551,615 (> 2^53)
     - EVM wei uint256: 2^256 - 1 (>> 2^53)
     - SQLite INTEGER: 최대 64비트 -- lamport는 커버하지만 wei는 불가
     - TEXT로 저장하면 체인 무관하게 안전, BigInt 문자열 그대로 저장
   - amount_lamports 보조 컬럼 옵션 유보 문서화:
     - "구현 시 성능 프로파일링 후 결정. 현재 금액 범위 검색이 필요한 유일한 기능은 AutoStopEngine의 threshold_proximity 규칙이며, 최근 N건만 조회하므로 성능 영향 미미."
   - [v0.7 보완] 태그
  </action>
  <verify>
1. 25-sqlite-schema.md 섹션 2.1에 chain/network CHECK DDL과 Drizzle 코드가 모두 존재
2. 25-sqlite-schema.md 섹션 4.x에 agents 테이블 재생성 마이그레이션 가이드 존재
3. 45-enum-unified-mapping.md에 ChainType(2값)과 NetworkType(3값) 존재
4. 37-rest-api, 26-keystore, 31-solana-adapter, 29-api-framework에서 `mainnet-beta` 검색 결과 0건 (매핑 주석 제외)
5. 25-sqlite-schema.md 섹션 2.3에 amount TEXT 근거(JS 정밀도 수치)와 amount_lamports 유보 문구 존재
6. 모든 수정에 [v0.7 보완] 태그 존재
  </verify>
  <done>agents CHECK 제약이 Drizzle + DDL + Enum SSoT로 정의되고, network 값이 4개 문서에서 'mainnet'으로 통일되며, amount TEXT 유지 근거가 보강됨. SCHEMA-03, SCHEMA-05 완전 해소</done>
</task>

<task type="auto">
  <name>Task 2: Docker UID 1001 정합성 + 알림 채널 BEGIN IMMEDIATE (SCHEMA-04, SCHEMA-06)</name>
  <files>
    .planning/deliverables/40-telegram-bot-docker.md
    .planning/deliverables/35-notification-architecture.md
  </files>
  <action>
**SCHEMA-04: Docker 볼륨 UID 1001 정합성**

v0.7 objectives E-4의 해결 방향을 따른다.

1. **40-telegram-bot-docker.md 섹션 8.2 (Dockerfile):**
   - 기존 `adduser` 명령을 홈 디렉토리 명시 버전으로 교체:
     ```dockerfile
     RUN addgroup -g 1001 -S waiaas && \
         adduser -S waiaas -u 1001 -G waiaas -h /home/waiaas
     ```
     (Alpine Linux 문법 유지 -- 30-RESEARCH.md 주의사항에 따라 groupadd/useradd가 아닌 Alpine 명령 사용)
   - WAIAAS_DATA_DIR 환경변수 추가:
     ```dockerfile
     ENV WAIAAS_DATA_DIR=/home/waiaas/.waiaas
     ```
   - 데이터 디렉토리 명시적 생성 + 소유권 설정:
     ```dockerfile
     RUN mkdir -p $WAIAAS_DATA_DIR && chown -R waiaas:waiaas $WAIAAS_DATA_DIR
     ```
   - VOLUME, USER, WORKDIR 지시어 확인/추가:
     ```dockerfile
     VOLUME /home/waiaas/.waiaas
     USER waiaas
     WORKDIR /home/waiaas
     ```
   - [v0.7 보완] 태그

2. **40-telegram-bot-docker.md 섹션 9.1 (docker-compose):**
   - user 지정 추가: `user: "1001:1001"`
   - volumes 경로 확인: `waiaas-data:/home/waiaas/.waiaas`
   - [v0.7 보완] 태그

3. **데몬 시작 시 소유권 확인 로직:**
   - 40-telegram-bot-docker.md 또는 28-daemon-lifecycle-cli.md의 적절한 위치에 소유권 확인 로직 스펙 추가:
     - `stat(dataDir).uid !== process.getuid()` 시 경고 로그
     - Docker 환경에서 named volume의 UID 불일치 방지 목적
   - 이 로직은 40-telegram-bot-docker.md 내에 "[v0.7 보완] 데몬 시작 시 소유권 확인" 섹션으로 추가

**SCHEMA-06: 알림 채널 삭제 BEGIN IMMEDIATE 트랜잭션**

v0.7 objectives E-6의 해결 방향을 따른다.

4. **35-notification-architecture.md 섹션 9.3 (채널 삭제/비활성화):**
   - 기존 동시성 미보호 코드를 BEGIN IMMEDIATE 트랜잭션으로 교체
   - better-sqlite3의 `.transaction()`은 기본 BEGIN DEFERRED이므로 raw SQL 사용 패턴 명시:
     ```typescript
     db.exec('BEGIN IMMEDIATE');
     try {
       const activeCount = db.prepare(
         'SELECT COUNT(*) as cnt FROM notification_channels WHERE enabled = 1 AND id != ?'
       ).get(channelId) as { cnt: number };
       if (activeCount.cnt < minChannels) {
         db.exec('ROLLBACK');
         throw new WaiaasError('MIN_CHANNELS_REQUIRED', ...);
       }
       db.prepare(
         'UPDATE notification_channels SET enabled = 0, updated_at = ? WHERE id = ?'
       ).run(now, channelId);
       db.exec('COMMIT');
     } catch (err) {
       db.exec('ROLLBACK');
       throw err;
     }
     ```
   - 물리 삭제(DELETE) 금지 결정 명시:
     - "DELETE /v1/owner/notification-channels/:id API는 경로 유지하되, 실제 동작은 enabled=false (soft-delete). 감사 로그 보존과 notification_log FK 무결성 보장."
   - 33-time-lock-approval-mechanism.md의 reserved_amount BEGIN IMMEDIATE 패턴과 동일 접근임을 교차 참조로 명시
   - [v0.7 보완] 태그
  </action>
  <verify>
1. 40-telegram-bot-docker.md Dockerfile에 `adduser ... -h /home/waiaas`, `WAIAAS_DATA_DIR`, `chown`, `VOLUME`, `USER waiaas` 존재
2. 40-telegram-bot-docker.md docker-compose에 `user: "1001:1001"`, `waiaas-data:/home/waiaas/.waiaas` 존재
3. 소유권 확인 로직(stat/getuid) 스펙 존재
4. 35-notification-architecture.md 섹션 9.3에 `BEGIN IMMEDIATE` 패턴 존재
5. 물리 삭제 금지 + soft-delete 결정 명시
6. 33-time-lock 교차 참조 존재
7. 모든 수정에 [v0.7 보완] 태그 존재
  </verify>
  <done>Docker UID 1001이 Dockerfile에 홈 디렉토리/데이터 디렉토리와 함께 명시되고, 데몬 소유권 확인 로직이 추가되며, 알림 채널 비활성화가 BEGIN IMMEDIATE로 보호되고 물리 삭제 금지가 확정됨. SCHEMA-04, SCHEMA-06 완전 해소</done>
</task>

</tasks>

<verification>
**SCHEMA-03 검증:**
- 25-sqlite-schema.md agents 테이블에 chain/network CHECK 존재
- 45-enum-unified-mapping.md에 ChainType/NetworkType SSoT 존재
- 37, 26, 31, 29 문서에서 `mainnet-beta` 직접 참조 0건 (매핑 주석 제외)

**SCHEMA-04 검증:**
- 40-telegram-bot-docker.md에 UID 1001 + 홈 디렉토리 + WAIAAS_DATA_DIR + chown 존재
- docker-compose에 user: "1001:1001" 존재

**SCHEMA-05 검증:**
- 25-sqlite-schema.md에 amount TEXT 유지 근거(Number.MAX_SAFE_INTEGER, u64, uint256 비교) 존재
- amount_lamports 유보 문구 존재

**SCHEMA-06 검증:**
- 35-notification-architecture.md에 BEGIN IMMEDIATE 패턴 존재
- 물리 삭제 금지 결정 존재
- 33-time-lock 교차 참조 존재
</verification>

<success_criteria>
1. agents 테이블에 chain/network CHECK 제약이 Drizzle + DDL + Enum SSoT(45-enum)으로 정의됨
2. network 값이 'mainnet'|'devnet'|'testnet'으로 통일되어 4개 문서의 'mainnet-beta' 참조가 교체됨
3. Docker UID 1001이 Dockerfile에 명시되고 데이터 디렉토리 소유권 확인 로직이 정의됨
4. amount TEXT 유지 근거가 JS 정밀도 수치로 보강되고 amount_lamports가 유보됨
5. 알림 채널 비활성화가 BEGIN IMMEDIATE로 동시성 보호되고 물리 삭제 금지가 확정됨
</success_criteria>

<output>
After completion, create `.planning/phases/30-schema-config-finalization/30-02-SUMMARY.md`
</output>
