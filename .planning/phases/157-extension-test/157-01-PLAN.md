---
phase: 157-extension-test
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/extension/token-transfer.extension.test.ts
  - packages/daemon/src/__tests__/extension/contract-call.extension.test.ts
autonomous: true

must_haves:
  truths:
    - "SPL 토큰 전송이 buildSplTokenTransfer를 통해 UnsignedTransaction을 생성한다"
    - "ERC-20 토큰 전송이 ERC-20 transfer calldata를 올바르게 생성한다"
    - "ALLOWED_TOKENS 정책이 허용 토큰은 통과시키고 미등록 토큰은 거부한다"
    - "ALLOWED_TOKENS 미설정 시 기본 DENY가 적용된다"
    - "FeeEstimate가 ATA 미존재 시 ataCreationCost를 포함하고 존재 시 제외한다"
    - "getAssets()가 SOL+SPL 또는 ETH+ERC-20 목록을 올바르게 반환한다"
    - "CONTRACT_WHITELIST 미설정 시 CONTRACT_CALL이 기본 거부된다"
    - "비화이트리스트 컨트랙트/메서드 호출이 거부된다"
    - "EVM/Solana 정상 컨트랙트 호출이 파이프라인을 통과한다"
    - "Zod 스키마가 잘못된 calldata/accounts를 거부한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/extension/token-transfer.extension.test.ts"
      provides: "EXT-01 토큰 전송 기능 테스트 32건"
      min_lines: 600
    - path: "packages/daemon/src/__tests__/extension/contract-call.extension.test.ts"
      provides: "EXT-02 컨트랙트 호출 기능 테스트 28건"
      min_lines: 500
  key_links:
    - from: "token-transfer.extension.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluate with type TOKEN_TRANSFER + ALLOWED_TOKENS policy"
      pattern: "evaluate.*TOKEN_TRANSFER"
    - from: "token-transfer.extension.test.ts"
      to: "MockChainAdapter"
      via: "buildTransaction/estimateFee for SPL/ERC-20"
      pattern: "adapter\\.(buildTransaction|estimateFee)"
    - from: "contract-call.extension.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluate with type CONTRACT_CALL + CONTRACT_WHITELIST/METHOD_WHITELIST"
      pattern: "evaluate.*CONTRACT_CALL"
---

<objective>
토큰 전송(EXT-01, 32건) + 컨트랙트 호출(EXT-02, 28건) 기능 테스트 60건을 작성한다.

Purpose: discriminatedUnion 5-type 중 TOKEN_TRANSFER와 CONTRACT_CALL의 정상 동작(파이프라인 통과, 정책 평가, Zod 검증, 에러 처리)을 기능 관점에서 검증한다. Phase 156 보안 테스트가 "공격 방어"를 증명했다면, Phase 157은 "정상 사용"이 올바르게 동작함을 증명한다.
Output: 2개 확장 기능 테스트 파일 (extension/ 디렉토리)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

# 핵심 구현 파일
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/pipeline/resolve-effective-amount-usd.ts

# 기존 테스트 패턴 참조
@packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts
@packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts

# 보안 테스트 패턴 (동일 도메인, 보안 관점)
@packages/daemon/src/__tests__/security/extension/token-policy-attacks.security.test.ts
@packages/daemon/src/__tests__/security/extension/contract-whitelist-attacks.security.test.ts

# Mock 인프라
@packages/daemon/src/__tests__/mocks/mock-price-oracle.ts

# 기능 테스트 시나리오 정의 (doc 64, 섹션 6.2~6.3)
@docs/64-extension-test-strategy.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: EXT-01 토큰 전송 기능 테스트 32건</name>
  <files>
    packages/daemon/src/__tests__/extension/token-transfer.extension.test.ts
  </files>
  <action>
packages/daemon/src/__tests__/extension/ 디렉토리를 생성하고 token-transfer.extension.test.ts를 작성한다.

doc 64 섹션 6.2 TOK 시나리오 기반으로 32건의 기능 테스트를 구현한다. 기존 security/ 테스트와 달리 "정상 동작" 검증에 초점을 맞춘다.

**테스트 구조 (describe 블록):**

1. `describe('TOK-U01~U08: TransferRequest 파싱 + ALLOWED_TOKENS 정책')` (8건)
   - TOK-U01: TransferRequest.token 유효한 토큰 필드 -> TOKEN_TRANSFER로 분기
   - TOK-U02: token 미제공 -> TRANSFER(네이티브)로 분기
   - TOK-U03: 잘못된 주소 형식 -> INVALID_ADDRESS
   - TOK-U04: ALLOWED_TOKENS 허용 토큰 -> 정책 통과
   - TOK-U05: ALLOWED_TOKENS 미등록 토큰 -> TOKEN_NOT_ALLOWED 거부
   - TOK-U06: ALLOWED_TOKENS 미설정 -> 기본 DENY
   - TOK-U07: AllowedTokensRuleSchema Zod 유효 데이터 -> 파싱 성공
   - TOK-U08: AllowedTokensRuleSchema Zod 무효 데이터 -> ZodError

2. `describe('TOK-U09~U14: FeeEstimate + AssetInfo')` (6건)
   - TOK-U09: ATA 미존재 SPL 전송 -> total = baseFee + priorityFee + ataCreationCost
   - TOK-U10: ATA 존재 SPL 전송 -> ataCreationCost = undefined
   - TOK-U11: ERC-20 gas 추정 -> total = gasLimit * maxFeePerGas
   - TOK-U12: AssetInfo bigint -> string 직렬화 정확도
   - TOK-U13: AssetInfo type enum 'spl' -> Zod 통과
   - TOK-U14: AssetInfo type enum 무효값 -> ZodError

3. `describe('TOK-I01~I10: Integration 파이프라인')` (10건)
   - TOK-I01: SPL 토큰 전송 buildSplTokenTransfer -> UnsignedTransaction 구조 검증
   - TOK-I02: SPL 전송 잔액 부족 -> INSUFFICIENT_BALANCE
   - TOK-I03: ERC-20 토큰 전송 -> ERC-20 transfer calldata 생성 검증
   - TOK-I04: ERC-20 전송 시뮬레이션 실패 -> SIMULATION_FAILED
   - TOK-I05: ALLOWED_TOKENS 정책 DB 라운드트립 (insert -> evaluate -> 일관성)
   - TOK-I06: ALLOWED_TOKENS 정책 변경 후 재검증 -> 즉시 반영
   - TOK-I07: getAssets() Solana (SOL + 2 SPL) -> AssetInfo[] 3개, native 첫번째
   - TOK-I08: getAssets() EVM (ETH + 1 ERC-20) -> AssetInfo[] 2개
   - TOK-I09: getAssets() REST API 응답 변환 -> bigint->string, Zod 통과
   - TOK-I10: estimateFee() ATA 비용 포함 -> ataCreationCost > 0

4. `describe('TOK-X01~X08: 교차 검증')` (8건)
   - TOK-X01: 네이티브 TRANSFER와 TOKEN_TRANSFER 정책 분리 동작
   - TOK-X02: Oracle 가격 stale 시 TOKEN_TRANSFER NOTIFY 상향
   - TOK-X03: Oracle 완전 장애 시 TOKEN_TRANSFER NOTIFY 고정
   - TOK-X04: SPL + ERC-20 동시 정책 적용 (체인별 분리)
   - TOK-X05: Token-2022 분기 (program id 기반)
   - TOK-X06: decimals 정상 매칭 (transferChecked 성공 경로)
   - TOK-X07: 대소문자 정규화 (EVM lowercase) 정상 동작
   - TOK-X08: 네트워크 스코핑 (ethereum-sepolia vs ethereum-mainnet) 정상 분리

**구현 패턴:**
- 기존 security/ 테스트의 createInMemoryDb, insertPolicy, insertTestWallet 헬퍼 재사용
- security-test-helpers.ts import (packages/daemon/src/__tests__/security/helpers/)
- MockChainAdapter 또는 vi.fn() 기반 adapter mock 사용
- DatabasePolicyEngine 직접 인스턴스화 (실제 SQLite in-memory DB)
- MockPriceOracle (packages/daemon/src/__tests__/mocks/) 사용
- 각 describe 블록에 beforeEach로 DB 초기화

**주의:**
- 보안 테스트(156)와 중복 방지: 보안 테스트는 "우회 공격 방어"에 초점, 기능 테스트는 "정상 경로 동작"에 초점
- defaultNetwork는 'ethereum-sepolia' 사용 (DB CHECK 제약 준수, 156-01 결정 참고)
- 토큰 주소 동적 생성 시 padStart 패턴 사용 (156-01 결정 참고)
  </action>
  <verify>
pnpm vitest run packages/daemon/src/__tests__/extension/token-transfer.extension.test.ts
32건 전체 통과. 0 실패.
  </verify>
  <done>
TOK-U01~U14 (14건) + TOK-I01~I10 (10건) + TOK-X01~X08 (8건) = 32건 토큰 전송 기능 테스트가 모두 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: EXT-02 컨트랙트 호출 기능 테스트 28건</name>
  <files>
    packages/daemon/src/__tests__/extension/contract-call.extension.test.ts
  </files>
  <action>
contract-call.extension.test.ts를 작성한다.

doc 64 섹션 6.3 CTR 시나리오 기반 14건 + v1.7 objectives에서 추가된 14건(METHOD_WHITELIST 정상 동작, 체인별 분기, 파이프라인 통합) = 28건.

**테스트 구조 (describe 블록):**

1. `describe('CTR-U01~U02: 정상 컨트랙트 호출')` (2건)
   - CTR-U01: EVM 정상 컨트랙트 호출 -> PENDING -> policy evaluate -> tier 결정
   - CTR-U02: Solana 정상 프로그램 호출 -> 동일 파이프라인 흐름 (programId + instructionData + accounts)

2. `describe('CTR-U03~U07: 정책 거부 시나리오')` (5건)
   - CTR-U03: CONTRACT_WHITELIST 미설정 -> CONTRACT_CALL_DISABLED
   - CTR-U04: 비화이트리스트 컨트랙트 -> CONTRACT_NOT_WHITELISTED
   - CTR-U05: 비화이트리스트 메서드 (EVM calldata selector) -> METHOD_NOT_WHITELISTED
   - CTR-U06: 체인 불일치 (ethereum 화이트리스트에 solana 호출) -> CONTRACT_NOT_WHITELISTED
   - CTR-U07: 세션 제약 위반 -> SESSION_CONTRACT_NOT_ALLOWED

3. `describe('CTR-U08~U10: 에러 시나리오')` (3건)
   - CTR-U08: calldata 없는 EVM 호출 -> Zod 검증 실패 (400)
   - CTR-U09: 빈 calldata ('0x') -> "최소 4바이트 selector 필요"
   - CTR-U10: Solana accounts 누락 -> Zod refine 실패

4. `describe('CTR-S01~S04: 보안 관련 기능 동작')` (4건)
   - CTR-S01: 과도한 value 첨부 -> APPROVAL 티어 (정상 경로에서의 tier 상향 확인)
   - CTR-S02: 시뮬레이션 실패 컨트랙트 -> SIMULATION_FAILED, FAILED 상태
   - CTR-S03: EVM checksum 주소 -> lowercase 정규화 후 화이트리스트 일치
   - CTR-S04: Solana to !== programId 불일치 -> Zod refine 실패

5. `describe('CTR-I01~I06: Integration 파이프라인')` (6건)
   - CTR-I01: CONTRACT_WHITELIST DB 라운드트립 (insert -> evaluate -> 일관성)
   - CTR-I02: METHOD_WHITELIST DB 라운드트립
   - CTR-I03: CONTRACT_WHITELIST + METHOD_WHITELIST 복합 정책 동작
   - CTR-I04: 정책 변경 후 재검증 (추가/삭제 즉시 반영)
   - CTR-I05: 글로벌 vs 월렛별 CONTRACT_WHITELIST 우선순위
   - CTR-I06: 다중 컨트랙트 화이트리스트 동시 등록

6. `describe('CTR-X01~X08: 교차 검증 + EVM/Solana 분기')` (8건)
   - CTR-X01: EVM calldata 4-byte selector 정상 매칭
   - CTR-X02: Solana programId 정상 매칭
   - CTR-X03: CONTRACT_CALL + SPENDING_LIMIT 복합 정책 (value 첨부 시 합산)
   - CTR-X04: ACTION resolve -> CONTRACT_CALL 파이프라인 연계 (resolve 결과가 CONTRACT_WHITELIST 통과)
   - CTR-X05: 네트워크 스코핑 정상 분리 (sepolia vs mainnet)
   - CTR-X06: 비활성 CONTRACT_WHITELIST 정책 (enabled=false) -> 무시
   - CTR-X07: wildcard METHOD_WHITELIST ('*' 허용 시 모든 메서드 통과)
   - CTR-X08: 빈 METHOD_WHITELIST 배열 -> 메서드 제한 없음 (화이트리스트만 적용)

**구현 패턴:**
- 동일 security-test-helpers.ts 재사용
- ContractCallRequest 타입으로 EVM(calldata) / Solana(programId+instructionData+accounts) 분기
- EVM 4-byte selector: '0x' + keccak256('transfer(address,uint256)').slice(0,10) 등
- Solana accounts 배열 구조: [{ address, isSigner, isWritable }]
- 기존 contract-whitelist-attacks.security.test.ts 패턴 참조하되 정상 동작 검증에 초점
  </action>
  <verify>
pnpm vitest run packages/daemon/src/__tests__/extension/contract-call.extension.test.ts
28건 전체 통과. 0 실패.
  </verify>
  <done>
CTR-U01~U10 (10건) + CTR-S01~S04 (4건) + CTR-I01~I06 (6건) + CTR-X01~X08 (8건) = 28건 컨트랙트 호출 기능 테스트가 모두 통과한다.
  </done>
</task>

</tasks>

<verification>
전체 확장 기능 테스트 실행:
```
pnpm vitest run packages/daemon/src/__tests__/extension/
```
60건 (32+28) 전체 통과.

기존 테스트 회귀 없음:
```
pnpm vitest run --dir packages/daemon/src/__tests__/
```
</verification>

<success_criteria>
1. token-transfer.extension.test.ts에 32건(TOK-U 14 + TOK-I 10 + TOK-X 8) 테스트가 존재하고 모두 통과한다
2. contract-call.extension.test.ts에 28건(CTR-U 10 + CTR-S 4 + CTR-I 6 + CTR-X 8) 테스트가 존재하고 모두 통과한다
3. 기존 보안 테스트(security/ 디렉토리)에 회귀가 없다
</success_criteria>

<output>
After completion, create `.planning/phases/157-extension-test/157-01-SUMMARY.md`
</output>
