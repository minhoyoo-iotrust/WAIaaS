---
phase: 157-extension-test
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/extension/approve-management.extension.test.ts
  - packages/daemon/src/__tests__/extension/batch-transaction.extension.test.ts
  - packages/daemon/src/__tests__/extension/oracle-price.extension.test.ts
autonomous: true

must_haves:
  truths:
    - "ApproveRequest Zod 스키마가 유효한 데이터를 파싱하고 무효한 데이터를 거부한다"
    - "무제한 감지(EVM MAX_UINT256, Solana MAX_U64)가 정확히 isUnlimited을 판별한다"
    - "APPROVED_SPENDERS 미설정 시 APPROVE가 기본 거부된다"
    - "APPROVE_AMOUNT_LIMIT 초과 시 거부된다"
    - "APPROVE_TIER_OVERRIDE가 amount_tiers에 따라 올바르게 tier를 결정한다"
    - "Solana 배치 트랜잭션이 2-instruction 이상에서 원자적으로 실행된다"
    - "배치 합산 금액이 2단계 정책 평가를 통해 올바른 tier를 받는다"
    - "EVM BATCH_NOT_SUPPORTED 에러가 정확히 반환된다"
    - "OracleChain이 primary->fallback->stale cache 순서로 fallback한다"
    - "PriceCache TTL 만료 시 재조회하고 5분 TTL/30분 staleMax가 정확히 동작한다"
    - "교차 검증 5% 불일치 시 isStale=true로 degradation된다"
    - "resolveEffectiveAmountUsd가 토큰 금액을 USD로 정확히 변환한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/extension/approve-management.extension.test.ts"
      provides: "EXT-03 Approve 관리 기능 테스트 24건"
      min_lines: 450
    - path: "packages/daemon/src/__tests__/extension/batch-transaction.extension.test.ts"
      provides: "EXT-04 배치 트랜잭션 기능 테스트 22건"
      min_lines: 400
    - path: "packages/daemon/src/__tests__/extension/oracle-price.extension.test.ts"
      provides: "EXT-05 Oracle 기능 테스트 20건"
      min_lines: 450
  key_links:
    - from: "approve-management.extension.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluate with type APPROVE + APPROVED_SPENDERS/AMOUNT_LIMIT/TIER_OVERRIDE"
      pattern: "evaluate.*APPROVE"
    - from: "batch-transaction.extension.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluateBatch with batch_items 합산"
      pattern: "evaluateBatch"
    - from: "oracle-price.extension.test.ts"
      to: "OracleChain"
      via: "getPrice/getNativePrice with fallback chain"
      pattern: "(getPrice|getNativePrice|getOrFetch)"
    - from: "oracle-price.extension.test.ts"
      to: "InMemoryPriceCache"
      via: "TTL/stale/LRU management"
      pattern: "(getOrFetch|getStale|getStats)"
---

<objective>
Approve 관리(EXT-03, 24건) + 배치 트랜잭션(EXT-04, 22건) + Oracle 가격(EXT-05, 20건) 기능 테스트 66건을 작성한다.

Purpose: discriminatedUnion 5-type 중 APPROVE와 BATCH의 정상 동작을 검증하고, IPriceOracle/OracleChain/PriceCache의 정상 fallback/캐시/교차검증 동작을 기능 관점에서 증명한다.
Output: 3개 확장 기능 테스트 파일 (extension/ 디렉토리)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

# 핵심 구현 파일
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/infrastructure/oracle/oracle-chain.ts
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/price-age.ts
@packages/daemon/src/pipeline/resolve-effective-amount-usd.ts

# 기존 테스트 패턴 참조
@packages/daemon/src/__tests__/oracle-chain.test.ts
@packages/daemon/src/__tests__/price-cache.test.ts
@packages/daemon/src/__tests__/price-age.test.ts
@packages/daemon/src/__tests__/resolve-effective-amount-usd.test.ts
@packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts

# 보안 테스트 패턴 (동일 도메인, 보안 관점)
@packages/daemon/src/__tests__/security/extension/approve-attacks.security.test.ts
@packages/daemon/src/__tests__/security/extension/batch-split-attacks.security.test.ts
@packages/daemon/src/__tests__/security/extension/oracle-manipulation-attacks.security.test.ts

# Mock 인프라
@packages/daemon/src/__tests__/mocks/mock-price-oracle.ts

# 기능 테스트 시나리오 정의 (doc 64, 섹션 6.4~6.6)
@docs/64-extension-test-strategy.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: EXT-03 Approve 관리 24건 + EXT-04 배치 트랜잭션 22건</name>
  <files>
    packages/daemon/src/__tests__/extension/approve-management.extension.test.ts
    packages/daemon/src/__tests__/extension/batch-transaction.extension.test.ts
  </files>
  <action>
**approve-management.extension.test.ts (24건):**

doc 64 섹션 6.4 APR 시나리오 기반 22건 + 교차 검증 2건 = 24건.

1. `describe('APR-U01~U05: ApproveRequest Zod + 무제한 감지')` (5건)
   - APR-U01: ApproveRequest Zod 유효성 -- 정상 (spender, amount, token 모두 유효)
   - APR-U02: ApproveRequest Zod -- spender 누락 -> 파싱 실패
   - APR-U03: 무제한 감지 -- EVM MAX_UINT256 (2^256-1) -> isUnlimited = true
   - APR-U04: 무제한 감지 -- Solana MAX_U64 (2^64-1) -> isUnlimited = true
   - APR-U05: 무제한 감지 -- 임계값 미만 금액 -> isUnlimited = false

2. `describe('APR-U06~U10: 정책 평가')` (5건)
   - APR-U06: APPROVED_SPENDERS 미설정 -> DENY (approve 전면 거부)
   - APR-U07: APPROVED_SPENDERS -- 허용 spender -> ALLOW (정책 통과)
   - APR-U08: APPROVED_SPENDERS -- 비허가 spender -> DENY (SPENDER_NOT_APPROVED)
   - APR-U09: APPROVE_AMOUNT_LIMIT -- maxAmount 초과 -> DENY (APPROVE_AMOUNT_EXCEEDED)
   - APR-U10: APPROVE_TIER_OVERRIDE -- amount_tiers 분기 -> tier='NOTIFY' 등

3. `describe('APR-I01~I03: Integration 파이프라인')` (3건)
   - APR-I01: EVM approve 전체 파이프라인 -> UnsignedTransaction, 올바른 calldata (approve selector 0x095ea7b3)
   - APR-I02: Solana approve 전체 파이프라인 -> ApproveChecked instruction, decimals 포함
   - APR-I03: 정책 위반 파이프라인 종료 -> 403 SPENDER_NOT_APPROVED

4. `describe('APR-I04~I08: 정책 DB 통합')` (5건)
   - APR-I04: APPROVED_SPENDERS DB 라운드트립 (insert -> evaluate -> 일관성)
   - APR-I05: APPROVE_AMOUNT_LIMIT DB 라운드트립
   - APR-I06: APPROVE_TIER_OVERRIDE amount_tiers JSON 저장/복원 정확도
   - APR-I07: 글로벌 vs 월렛별 APPROVED_SPENDERS 우선순위
   - APR-I08: 정책 변경 후 재검증 (삭제 -> 기본 DENY 복구)

5. `describe('APR-X01~X06: 교차 검증 + 보안 관련 기능')` (6건)
   - APR-X01: 무제한 approve 차단 정상 동작 (blockUnlimited=true + EVM uint256.max)
   - APR-X02: blockUnlimited=false 시 무제한 허용 (정상 통과)
   - APR-X03: approve 0 리셋 -> 정상 허용 (금액 0은 리셋 목적으로 통과)
   - APR-X04: APPROVE + TOKEN_TRANSFER 복합 -> 각 타입별 독립 정책 적용
   - APR-X05: EVM race condition 자동 방지 (기존 allowance > 0 시 approve(0) 선행)
   - APR-X06: Solana 단일 delegate -> previousDelegate 정보 포함 경고

**batch-transaction.extension.test.ts (22건):**

doc 64 섹션 6.5 BAT 시나리오 기반 14건 + 추가 8건 = 22건.

1. `describe('BAT-U01~U03: 정상 배치')` (3건)
   - BAT-U01: 2-instruction SOL 전송 배치 -> 성공, amount 합산, metadata 기록
   - BAT-U02: 3-instruction 복합 배치 (transfer + approve + contractCall) -> 혼합 타입
   - BAT-U03: ATA 자동 생성 포함 배치 -> ATA instruction 삽입, metadata.ata_created

2. `describe('BAT-U04~U07: 정책 거부')` (4건)
   - BAT-U04: 합산 금액 APPROVAL 티어 -> 개별은 소액이지만 합산 10 SOL -> APPROVAL
   - BAT-U05: 개별 화이트리스트 위반 -> BATCH_POLICY_VIOLATION
   - BAT-U06: All-or-Nothing 다수 위반 -> violations.length=2, 전체 거부
   - BAT-U07: APPROVE 포함 배치 -> 합산 소액이지만 APPROVAL 강제

3. `describe('BAT-U08~U11: 에러 시나리오')` (4건)
   - BAT-U08: EVM BATCH_NOT_SUPPORTED -> 400 BATCH_NOT_SUPPORTED
   - BAT-U09: instruction 수 부족 (<2) -> Zod "최소 2개" 에러
   - BAT-U10: instruction 수 초과 (>20) -> Zod "최대 20개" 에러
   - BAT-U11: 트랜잭션 크기 초과 (>1232 bytes) -> BATCH_SIZE_EXCEEDED

4. `describe('BAT-I01~I05: Integration + 정책 합산')` (5건)
   - BAT-I01: evaluateBatch 2단계 합산 정확도 (Phase A 개별 + Phase B 합산)
   - BAT-I02: batch_items 정규화 (items 배열 -> TransactionRequest[] 변환)
   - BAT-I03: 빈 batch_items -> Zod 에러 (최소 2개)
   - BAT-I04: 배치 내 동일 수신자 다중 전송 -> 각각 독립 평가 후 합산
   - BAT-I05: SPENDING_LIMIT + 배치 합산 -> USD 기준 합산 평가 (MockPriceOracle 사용)

5. `describe('BAT-X01~X06: 교차 검증')` (6건)
   - BAT-X01: 소액 분할 합산 -> SPENDING_LIMIT 합산 기준 정상 평가
   - BAT-X02: approve + transferFrom 콤보 배치 -> APPROVE_TIER_OVERRIDE 강제
   - BAT-X03: 미인가 프로그램 1개 포함 -> All-or-Nothing 전체 거부
   - BAT-X04: Solana 원자적 배치 -> 단일 트랜잭션 빌드 확인
   - BAT-X05: Oracle 가격 부분 실패 시 배치 합산 -> 성공분만 합산, NOTIFY 이상
   - BAT-X06: evaluateBatch 무정책 시 INSTANT passthrough (156-02 결정 참고: 최소 1개 정책 필요)

**공통 구현 패턴:**
- security-test-helpers.ts 재사용 (createInMemoryDb, insertPolicy, insertTestWallet)
- DatabasePolicyEngine 직접 인스턴스화
- MockPriceOracle (배치 USD 합산 테스트)
- 156-02 결정: evaluateBatch는 정책 0건이면 INSTANT passthrough -> 기본 거부 트리거에 최소 1개 정책 필요
- defaultNetwork는 'ethereum-sepolia' (DB CHECK 제약 준수)
  </action>
  <verify>
pnpm vitest run packages/daemon/src/__tests__/extension/approve-management.extension.test.ts packages/daemon/src/__tests__/extension/batch-transaction.extension.test.ts
46건 (24+22) 전체 통과. 0 실패.
  </verify>
  <done>
APR 24건 (U 10 + I 8 + X 6) + BAT 22건 (U 11 + I 5 + X 6) = 46건 Approve + 배치 기능 테스트가 모두 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: EXT-05 Oracle 가격 기능 테스트 20건</name>
  <files>
    packages/daemon/src/__tests__/extension/oracle-price.extension.test.ts
  </files>
  <action>
oracle-price.extension.test.ts를 작성한다.

doc 64 섹션 6.6 ORC 시나리오 12건 + 교차 검증 8건 = 20건.

**기존 oracle-chain.test.ts, price-cache.test.ts, price-age.test.ts와의 차별점:**
- 기존 테스트: 개별 모듈 단위 테스트 (OracleChain 클래스, PriceCache 클래스 각각)
- 이 테스트: "확장 기능 시나리오" 관점으로 end-to-end 동작 검증 (정책 평가와 연계, 교차 검증 포함)

**테스트 구조 (describe 블록):**

1. `describe('ORC-U01~U06: Unit 가격 정책')` (6건)
   - ORC-U01: PriceCache TTL 만료 시 재조회 트리거 (5분 TTL 정확도)
   - ORC-U02: PriceCache stale 한계 (30분 staleMax) 초과 시 PriceNotAvailableError
   - ORC-U03: resolveEffectiveAmountUsd() 정상 변환 (토큰 금액 * usdPrice / 10^decimals)
   - ORC-U04: resolveEffectiveAmountUsd() 가격 실패 fallback (TOKEN_TRANSFER -> {tier: 'NOTIFY'} 기본)
   - ORC-U05: evaluateSpendingLimitUsd() 4-tier (INSTANT/NOTIFY/DELAY/APPROVAL 각 경계)
   - ORC-U06: maxTier(nativeTier, usdTier) 보수적 채택 (두 tier 중 높은 쪽)

2. `describe('ORC-I01~I06: Integration OracleChain')` (6건)
   - ORC-I01: CoinGeckoOracle mock + getPrice -> PriceInfo 파싱 정확도
   - ORC-I02: OracleChain fallback 경로 (primary 실패 -> fallback 성공)
   - ORC-I03: OracleChain 교차 검증 (5% threshold 내 -> isStale=false, 초과 -> isStale=true)
   - ORC-I04: DatabasePolicyEngine + MockPriceOracle -> USD 기준 end-to-end 정책 평가
   - ORC-I05: CoinGecko 429 -> stale cache fallback (isStale=true, 기존 캐시 가격 반환)
   - ORC-I06: 다중 토큰 getPrices() 부분 실패 -> 성공 토큰만 Map 포함

3. `describe('ORC-X01~X08: 교차 검증 + 가격 나이 + 캐시')` (8건)
   - ORC-X01: 가격 나이 3단계 정확도 (fresh/aging/stale 경계값)
   - ORC-X02: stale 가격 사용 시 INSTANT -> NOTIFY 상향 (adjustTierForStalePrice)
   - ORC-X03: getNativePrice() SOL/ETH 각 정상 반환 (decimals 9/18 자동 설정)
   - ORC-X04: getCacheStats() 통계 정확도 (hits, misses, staleHits, size)
   - ORC-X05: 동시 getPrice() 요청 -> stampede prevention (getOrFetch 단일 in-flight)
   - ORC-X06: LRU 캐시 eviction (maxEntries=128 초과 시 가장 오래된 엔트리 제거)
   - ORC-X07: Oracle 전체 장애 + stale cache 존재 -> isStale=true, source='cache'
   - ORC-X08: Oracle 전체 장애 + stale cache 미존재 -> PriceNotAvailableError

**구현 패턴:**
- OracleChain: vi.fn() 기반 mock IPriceOracle (primary/fallback)로 직접 인스턴스화
- InMemoryPriceCache: 실제 인스턴스 사용 (테스트에서 TTL/stale 검증)
- 156-02 결정: InMemoryPriceCache 내부 expiresAt 직접 조작으로 TTL 만료 시뮬레이션
- resolveEffectiveAmountUsd: MockPriceOracle 주입
- evaluateSpendingLimitUsd: DatabasePolicyEngine + MockPriceOracle + in-memory SQLite
- PriceNotAvailableError import from oracle-errors.ts
- buildPrice() 헬퍼 (기존 oracle-chain.test.ts 패턴 차용)
  </action>
  <verify>
pnpm vitest run packages/daemon/src/__tests__/extension/oracle-price.extension.test.ts
20건 전체 통과. 0 실패.
  </verify>
  <done>
ORC-U01~U06 (6건) + ORC-I01~I06 (6건) + ORC-X01~X08 (8건) = 20건 Oracle 기능 테스트가 모두 통과한다.
  </done>
</task>

</tasks>

<verification>
전체 확장 기능 테스트 실행:
```
pnpm vitest run packages/daemon/src/__tests__/extension/
```
106건 (32+28+24+22+20) 전체 통과 (157-01 + 157-02 합산).

기존 테스트 회귀 없음:
```
pnpm vitest run --dir packages/daemon/src/__tests__/
```
</verification>

<success_criteria>
1. approve-management.extension.test.ts에 24건(APR-U 10 + APR-I 8 + APR-X 6) 테스트가 존재하고 모두 통과한다
2. batch-transaction.extension.test.ts에 22건(BAT-U 11 + BAT-I 5 + BAT-X 6) 테스트가 존재하고 모두 통과한다
3. oracle-price.extension.test.ts에 20건(ORC-U 6 + ORC-I 6 + ORC-X 8) 테스트가 존재하고 모두 통과한다
4. 기존 보안 테스트 및 기존 oracle-chain/price-cache 테스트에 회귀가 없다
</success_criteria>

<output>
After completion, create `.planning/phases/157-extension-test/157-02-SUMMARY.md`
</output>
