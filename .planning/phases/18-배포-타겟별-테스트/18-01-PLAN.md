---
phase: 18-배포-타겟별-테스트
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/v0.4/51-platform-test-scope.md
autonomous: true

must_haves:
  truths:
    - "CLI Daemon 테스트 시나리오(init/start/stop/status, 시그널 처리, exit codes 0-5, Windows fallback)가 카테고리별로 정의되어 있고, 각 시나리오의 검증 방법(child_process spawn + exit code + stdout/stderr)이 명시되어 있다"
    - "Docker 테스트 시나리오(빌드/compose/named volume/환경변수/hostname 오버라이드/grace period/Secrets/healthcheck/non-root)가 정의되어 있고, 자동화 방법(docker CLI)이 명시되어 있다"
    - "Desktop App(Tauri) 테스트에서 자동화 가능 범위(빌드, SEA, IPC, React 컴포넌트)와 수동 QA 필수 범위(Setup Wizard, 트레이 3색, WalletConnect QR, 8화면)가 명확히 분리되어 있고, 자동화 한계 사유가 명시되어 있다"
    - "Telegram Bot 테스트 시나리오(Long Polling, 8명령어, 5인라인 키보드, 2-Tier 인증)가 정의되어 있고, Mock 전략(jest.fn() + global.fetch, 서비스 DI mock)이 명시되어 있다"
    - "4개 타겟이 Phase 17 CI/CD 파이프라인 4단계 중 어느 Stage에 통합되는지 매핑 테이블이 존재한다"
    - "Phase 14 테스트 레벨(Platform 레벨)과 Phase 17 release.yml의 기존 job 골격과의 연동 관계가 문서화되어 있다"
  artifacts:
    - path: "docs/v0.4/51-platform-test-scope.md"
      provides: "4개 배포 타겟별 테스트 범위 및 검증 방법 설계 문서"
      contains: "PLAT-01"
    - path: "docs/v0.4/51-platform-test-scope.md"
      provides: "Docker 테스트 범위"
      contains: "PLAT-02"
    - path: "docs/v0.4/51-platform-test-scope.md"
      provides: "Tauri Desktop 테스트 범위 및 수동 QA 체크리스트"
      contains: "PLAT-03"
    - path: "docs/v0.4/51-platform-test-scope.md"
      provides: "Telegram Bot 테스트 범위 및 Mock 전략"
      contains: "PLAT-04"
  key_links:
    - from: "docs/v0.4/51-platform-test-scope.md"
      to: "docs/v0.4/41-test-levels-matrix-coverage.md"
      via: "Platform 레벨 정의 참조 (TLVL-01)"
      pattern: "Platform.*릴리스"
    - from: "docs/v0.4/51-platform-test-scope.md"
      to: "docs/v0.4/50-cicd-pipeline-coverage-gate.md"
      via: "release.yml Stage 4 platform-cli, platform-docker job 연동"
      pattern: "release\\.yml|Stage 4"
    - from: "docs/v0.4/51-platform-test-scope.md"
      to: "docs/v0.2/28-daemon-lifecycle-cli.md"
      via: "CLI 시나리오가 28번 문서 스펙에 근거"
      pattern: "28-daemon|exit code|SIGINT|SIGTERM"
    - from: "docs/v0.4/51-platform-test-scope.md"
      to: "docs/v0.2/40-telegram-bot-docker.md"
      via: "Docker + Telegram Bot 시나리오가 40번 문서 스펙에 근거"
      pattern: "40-telegram|Long Polling|named volume"
---

<objective>
4개 배포 타겟(CLI Daemon, Docker, Tauri Desktop, Telegram Bot) 각각의 테스트 범위, 시나리오, 검증 방법, 자동화 한계를 확정하는 설계 문서를 작성한다. 이 문서는 v0.4 테스트 전략의 마지막 퍼즐로, 구현 단계에서 플랫폼별 테스트 코드를 작성할 때 "무엇을 어떻게 테스트하고, 어디까지 자동화하며, 수동 QA는 무엇인가"를 참조하는 단일 소스가 된다.

Purpose: Phase 14에서 정의한 Platform 테스트 레벨과 Phase 17에서 설계한 CI/CD Stage 4 릴리스 파이프라인에 구체적인 시나리오를 채워넣어, v0.4 테스트 전략 수립을 완결한다.
Output: `docs/v0.4/51-platform-test-scope.md` (설계 문서 #51)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 18 Research (필수 -- 4개 타겟별 상세 조사 결과)
@.planning/phases/18-배포-타겟별-테스트/18-RESEARCH.md

# Phase 14 의존성 (Platform 테스트 레벨 정의)
@.planning/phases/14-test-foundation/14-01-SUMMARY.md
@docs/v0.4/41-test-levels-matrix-coverage.md

# Phase 17 의존성 (CI/CD 파이프라인 Stage 4 릴리스)
@.planning/phases/17-cicd-pipeline-design/17-01-SUMMARY.md
@docs/v0.4/50-cicd-pipeline-coverage-gate.md

# 설계 원본 문서 (테스트 시나리오의 근거)
@docs/v0.2/28-daemon-lifecycle-cli.md
@docs/v0.2/39-tauri-desktop-architecture.md
@docs/v0.2/40-telegram-bot-docker.md

# Mock 경계 참조 (서비스 DI mock 패턴)
@docs/v0.4/42-mock-boundaries-interfaces-contracts.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 4개 배포 타겟별 테스트 시나리오 및 검증 방법 설계</name>
  <files>docs/v0.4/51-platform-test-scope.md</files>
  <action>
`docs/v0.4/51-platform-test-scope.md` 파일을 생성한다. 문서 번호는 51번이다. 문서는 한글로 작성한다.

**문서 구조:**

1. **개요** -- Phase 18 목적, 4개 타겟 요약, Phase 14/17 연동 관계
2. **공통 원칙** -- Platform 테스트 실행 조건(릴리스 시), `--runInBand` 필수, 포트 충돌 방지, teardown 강제 정리
3. **PLAT-01: CLI Daemon 테스트** (28번 문서 기반)
   - 시나리오 테이블: 7개 카테고리(init/start/stop/status/signal/windows/exit codes)별로 시나리오 나열
   - 각 시나리오: ID, 설명, 입력(args/env), 기대 결과(exit code/stdout/stderr), 자동화 가능 여부
   - 검증 방법: `child_process.spawn` 패턴, 임시 `--data-dir` + `mkdtempSync`, 테스트별 고유 포트
   - 전체 흐름 시나리오: init -> start -> status -> stop -> status (E2E-like)
   - 시그널 테스트: SIGINT, SIGTERM, SIGHUP, SIGUSR1, 이중 시그널 방지
   - Windows fallback: HTTP `/v1/admin/shutdown` + Unit 테스트(조건부 분기 코드) 병행
   - 참고: exit codes 0(성공), 1(일반에러), 2(이미실행중), 3(미초기화), 4(인증실패), 5(타임아웃)
   - 예상 시나리오 수: 20+ 건

4. **PLAT-02: Docker 테스트** (40번 문서 기반)
   - 시나리오 테이블: 10개 카테고리(빌드/compose/named volume/환경변수/hostname 오버라이드/grace period/Secrets/healthcheck/non-root/첫 실행)
   - 각 시나리오: ID, 설명, 명령어(docker build/run/stop/inspect), 기대 결과, 자동화 가능 여부
   - 검증 방법: Docker CLI 기반 bash 스크립트 또는 Jest에서 `child_process.exec` 래핑
   - named volume 영속성: run -> init -> stop -> run -> DB 데이터 존재 확인 패턴
   - hostname 오버라이드: `WAIAAS_DAEMON_HOSTNAME=0.0.0.0` + 호스트 curl 접근 검증
   - grace period: `docker stop --time 35` + exit code 0(graceful) 확인
   - Secrets _FILE 패턴: `/run/secrets/` 마운트 + 데몬 정상 시작
   - non-root 검증: `docker exec waiaas-test whoami` -> waiaas, `id` -> uid=1001
   - Anti-pattern 명시: bind mount 금지(SQLite WAL + VirtioFS 불안정)
   - Phase 17 release.yml platform-docker job 골격 확장 포인트 명시
   - 예상 시나리오 수: 15+ 건

5. **PLAT-03: Desktop App (Tauri) 테스트** (39번 문서 기반)
   - 자동화 가능 범위 테이블: 빌드(`pnpm tauri build --ci`), Sidecar SEA(실행 테스트), IPC(`cargo test`), React 컴포넌트(Jest + @testing-library/react), Sidecar-Daemon HTTP(mock 서버)
   - 수동 QA 체크리스트: Setup Wizard 5단계, 시스템 트레이 3색, WalletConnect QR, 8개 화면 UI, Sidecar 크래시 복구(2회 실패 -> 자동 재시작 max 3x), OS 네이티브 알림, 크로스 플랫폼 3종(macOS/Windows/Linux)
   - 자동화 한계 명시: macOS WebDriver 미지원, Sidecar native addon 크로스 컴파일, 시스템 트레이 OS 레벨 접근 불가, WalletConnect 외부 앱 연동
   - CI 빌드 matrix: macOS/Windows/Linux 3종 빌드 성공 여부만 CI에서 검증 (UI 테스트 없음)
   - QA 체크리스트 형식: 각 항목에 대해 [검증 단계], [기대 결과], [PASS/FAIL 체크박스] 포맷
   - 예상 자동화 시나리오 5건 + 수동 QA 항목 20+ 건

6. **PLAT-04: Telegram Bot 테스트** (40번 문서 기반)
   - 시나리오 테이블: 8개 카테고리(Long Polling/8명령어/5인라인 키보드/2-Tier 인증/MarkdownV2 포맷/callback_data/직접 승인/Graceful shutdown)
   - Mock 전략 테이블: 6개 의존성(Telegram API fetch, SessionService, TransactionService, KillSwitchService, HealthService, TelegramChannel)별 mock 방법
   - Long Polling 테스트 주의점: start()를 fire-and-forget, running=false로 루프 탈출, 또는 1회 getUpdates 단위 메서드 노출
   - 8개 명령어별 시나리오: /start(환영 메시지), /auth(6자리 코드), /status(시스템 요약), /sessions(세션 목록), /revoke(세션 폐기), /killswitch(확인 키보드), /pending(거래 목록+키보드), /help(도움말)
   - 5개 콜백 액션별 시나리오: approve:{txId}, reject:{txId}, revoke:{sessionId}, killswitch_confirm, killswitch_cancel
   - 2-Tier 인증 테스트: Tier 1(chatId, read-only), 미인증 거부, Tier 2(ownerAuth, 자금 관련)
   - Phase 14 MOCK-ALL-LEVELS-NOTIFICATION 결정 준수: 전 레벨 Mock
   - 레벨 분류: 명령어/콜백 핸들러 = Integration(매 PR), Long Polling 루프 + Docker 통합 = Platform(릴리스)
   - 예상 시나리오 수: 25+ 건

**주의사항:**
- 모든 시나리오에 고유 ID 부여 (PLAT-01-CLI-xx, PLAT-02-DOCK-xx, PLAT-03-DESK-xx, PLAT-04-TGBOT-xx)
- 각 시나리오가 어떤 요구사항(PLAT-01~04)을 충족하는지 명시
- Research 문서의 코드 예시(Pattern 1~4)를 참조 패턴으로 포함하되 설계 문서답게 "구현 시 이 패턴을 따른다" 수준으로 요약
- Anti-pattern 4건(bind mount, Playwright for Tauri, Telegram 실제 API, Windows SIGTERM) 명시
  </action>
  <verify>
파일 `docs/v0.4/51-platform-test-scope.md`가 존재하고, 다음 키워드가 모두 포함되어 있는지 확인:
- `PLAT-01`, `PLAT-02`, `PLAT-03`, `PLAT-04` (4개 요구사항 커버)
- `child_process` 또는 `spawn` (CLI 검증 방법)
- `docker build` 또는 `docker run` (Docker 검증 방법)
- `tauri build` (Desktop 빌드 검증)
- `jest.fn()` 또는 `global.fetch` (Telegram Mock 전략)
- `수동 QA` 또는 `체크리스트` (Tauri 자동화 한계)
- `SIGINT`, `SIGTERM` (시그널 테스트)
- `named volume` (Docker 영속성)
- `Long Polling` (Telegram 폴링)
- `exit code` 또는 `exit codes` (CLI 종료 코드)
  </verify>
  <done>
4개 배포 타겟별 테스트 시나리오(CLI 20+, Docker 15+, Tauri 자동5+수동20+, Telegram 25+)가 카테고리별로 정리되어 있고, 각 시나리오의 검증 방법과 자동화 가능 여부가 명시되어 있다. 고유 ID가 부여되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: CI/CD 통합 매핑 + 정합성 검증표 + 요약 테이블 추가</name>
  <files>docs/v0.4/51-platform-test-scope.md</files>
  <action>
Task 1에서 생성한 `docs/v0.4/51-platform-test-scope.md` 문서 끝부분에 다음 섹션들을 추가한다.

**추가 섹션:**

7. **CI/CD 파이프라인 통합 매핑** -- 4개 타겟 x Phase 17 4단계 매트릭스
   - 매핑 테이블:

   | 타겟 | Stage 1 (매 커밋) | Stage 2 (매 PR) | Stage 3 (nightly) | Stage 4 (릴리스) |
   |------|-------------------|-----------------|--------------------|-----------------|
   | CLI Daemon | - | - | - | platform-cli job |
   | Docker | - | - | - | platform-docker job |
   | Tauri Desktop | - | - | - | 빌드 검증 job (선택) |
   | Telegram Bot | - | Integration (명령어/콜백) | - | - (서비스 테스트로 분류) |

   - Phase 17 release.yml의 platform-cli, platform-docker job 확장 포인트를 구체적으로 나열
   - Tauri 빌드 검증 CI matrix(macOS/Windows/Linux) 정의 (선택적 Stage 4 job)
   - Telegram Bot이 Stage 2(매 PR)에서 Integration으로 실행되는 근거: daemon 패키지 내부 서비스이므로 별도 Platform이 아님

8. **Phase 14/17 결정 정합성 검증표**
   - Phase 14 결정과의 정합성: TLVL-01(Platform 릴리스), MOCK-ALL-LEVELS-NOTIFICATION, Contract Test 팩토리 패턴, CI-GATE Soft->Hard
   - Phase 17 결정과의 정합성: CICD-4STAGE, release.yml platform-* job, CICD-SOFT-HARD-PRIORITY
   - 검증표 형식:

   | 결정 ID | 내용 | 본 문서 적용 | 정합 여부 |
   |---------|------|-------------|----------|
   | TLVL-01 | Platform 레벨은 릴리스 시 실행 | CLI/Docker는 Stage 4, Tauri 선택적 Stage 4 | O |
   | ... | ... | ... | ... |

   - 최소 8건 이상의 결정 정합성 검증

9. **Pitfalls 요약** -- Research에서 도출한 6개 pitfall을 간결한 테이블로 정리
   - 포트 충돌, Docker 잔존 컨테이너, Long Polling 무한 루프, SEA native addon, hostname 오버라이드, Windows 시그널

10. **요약 통계**
   - 타겟별 시나리오 수 합계 테이블
   - 자동화 가능 비율 (CLI HIGH/Docker HIGH/Tauri MEDIUM/Telegram HIGH)
   - v0.4 테스트 전략 완결 선언: Phase 14~18 전체를 통해 정의된 테스트 범위 총정리

**주의사항:**
- Phase 17 50번 문서의 release.yml platform-cli, platform-docker job 내용을 직접 참조하여 확장 포인트를 구체적으로 기술
- 정합성 검증표에서 불일치 발견 시 불일치 사유와 해결 방안 기재 (예: Telegram Bot이 Platform이 아닌 Integration인 이유)
- 문서 맨 끝에 "참조 문서" 섹션 추가: 28, 39, 40, 41, 42, 50번 문서 목록
  </action>
  <verify>
파일 `docs/v0.4/51-platform-test-scope.md`의 끝부분에 다음이 포함되어 있는지 확인:
- `CI/CD 파이프라인 통합` 또는 `통합 매핑` 섹션 존재
- `정합성 검증` 섹션 존재
- `Stage 1` ~ `Stage 4` 매핑 테이블 존재
- `TLVL-01`, `MOCK-ALL-LEVELS-NOTIFICATION` 등 Phase 14 결정 ID 참조
- `release.yml` 참조
- `Pitfall` 또는 `pitfall` 섹션 존재
- 참조 문서 목록 존재
  </verify>
  <done>
CI/CD 4단계 통합 매핑 테이블이 존재하고, Phase 14/17 결정 8건 이상의 정합성이 검증되었으며, 6개 pitfall이 정리되어 있고, 타겟별 시나리오 합계 통계가 포함되어 있다. 문서가 v0.4 Phase 18 최종 산출물로서 완결된 상태이다.
  </done>
</task>

</tasks>

<verification>
1. `docs/v0.4/51-platform-test-scope.md` 파일이 존재하고 비어있지 않다
2. PLAT-01~04 각 요구사항이 모두 시나리오로 커버되어 있다
3. CLI 시나리오 20건 이상, Docker 15건 이상, Tauri 자동 5건 + 수동 QA 20건 이상, Telegram 25건 이상
4. 모든 시나리오에 고유 ID가 부여되어 있다
5. CI/CD Stage 4 통합 매핑이 테이블로 존재한다
6. Phase 14/17 결정 정합성 검증표가 8건 이상 포함되어 있다
7. 자동화 한계(Tauri macOS WebDriver, 시스템 트레이 등)가 명시적으로 기재되어 있다
8. Anti-pattern 4건(bind mount, Playwright for Tauri, Telegram 실제 API, Windows SIGTERM)이 기재되어 있다
</verification>

<success_criteria>
- PLAT-01 충족: CLI Daemon init/start/stop/status, 시그널 처리(SIGINT/SIGTERM/SIGHUP/SIGUSR1), exit codes 0-5, Windows HTTP fallback 시나리오가 정의되어 있고 child_process spawn 기반 검증 방법이 명시되어 있다
- PLAT-02 충족: Docker 빌드/compose/named volume/환경변수/hostname 오버라이드/grace period/Secrets/healthcheck/non-root 시나리오가 정의되어 있고 docker CLI 기반 자동화 방법이 명시되어 있다
- PLAT-03 충족: Tauri 빌드/Sidecar SEA 자동화 가능 범위와 Setup Wizard/트레이/QR/8화면 수동 QA 체크리스트가 분리 정의되어 있고, 자동화 한계 사유(macOS WebDriver 미지원 등)가 명시되어 있다
- PLAT-04 충족: Telegram Bot Long Polling/8명령어/5인라인 키보드/2-Tier 인증 시나리오가 정의되어 있고, jest.fn() + global.fetch mock + 서비스 DI mock 전략이 명시되어 있다
- Phase 17 CI/CD Stage 4와의 통합 매핑이 완료되어 있다
- Phase 14/17 기존 결정과의 정합성이 검증되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/18-배포-타겟별-테스트/18-01-SUMMARY.md`
</output>
