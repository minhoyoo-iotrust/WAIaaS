---
phase: 49-daemon-infra
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/package.json
  - packages/daemon/src/infrastructure/keystore/crypto.ts
  - packages/daemon/src/infrastructure/keystore/memory.ts
  - packages/daemon/src/infrastructure/keystore/keystore.ts
  - packages/daemon/src/infrastructure/keystore/index.ts
  - packages/daemon/src/__tests__/keystore.test.ts
autonomous: true

must_haves:
  truths:
    - "Agent private key is encrypted with AES-256-GCM using Argon2id-derived key from master password, and decryption with the same password returns the original key"
    - "Decryption with a wrong password fails with authentication error (GCM authTag mismatch)"
    - "Keystore file is saved as JSON with format v1, file permission 0600, containing version/id/chain/network/publicKey/crypto/metadata fields"
    - "Decrypted keys are stored in sodium-native guarded memory (sodium_malloc) with mprotect_readonly, and released with sodium_memzero on lock"
  artifacts:
    - path: "packages/daemon/src/infrastructure/keystore/crypto.ts"
      provides: "AES-256-GCM encrypt/decrypt + Argon2id key derivation"
      exports: ["deriveKey", "encrypt", "decrypt"]
    - path: "packages/daemon/src/infrastructure/keystore/memory.ts"
      provides: "Sodium guarded memory allocation and zeroing"
      exports: ["allocateGuarded", "zeroAndRelease"]
    - path: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      provides: "LocalKeyStore class implementing ILocalKeyStore interface"
      exports: ["LocalKeyStore"]
    - path: "packages/daemon/src/__tests__/keystore.test.ts"
      provides: "Tests for encrypt/decrypt round-trip, wrong password, file format, memory safety"
  key_links:
    - from: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      to: "@waiaas/core ILocalKeyStore"
      via: "implements ILocalKeyStore interface"
      pattern: "implements ILocalKeyStore"
    - from: "packages/daemon/src/infrastructure/keystore/crypto.ts"
      to: "argon2 + node:crypto"
      via: "argon2.hash for KDF + createCipheriv/createDecipheriv for AES-GCM"
      pattern: "argon2\\.hash|createCipheriv"
    - from: "packages/daemon/src/infrastructure/keystore/memory.ts"
      to: "sodium-native"
      via: "sodium.sodium_malloc + sodium_memzero + sodium_mprotect_readonly"
      pattern: "sodium_malloc|sodium_memzero"
---

<objective>
AES-256-GCM keystore module with Argon2id KDF and sodium-native guarded memory, implementing the ILocalKeyStore interface from @waiaas/core.

Purpose: Agent private keys must be encrypted at rest with a master password and protected in memory during daemon operation. This module provides the crypto primitives (AES-GCM + Argon2id), guarded memory management (sodium-native), and the keystore file format v1 for persistent storage.

Output: Crypto module (encrypt/decrypt/KDF), memory module (sodium guarded buffers), LocalKeyStore class, and comprehensive tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/deliverables/26-keystore-spec.md (SSoT for keystore file format v1, AES-256-GCM, Argon2id, sodium guarded memory)
@packages/core/src/interfaces/ILocalKeyStore.ts (5 methods: generateKeyPair, decryptPrivateKey, releaseKey, hasKey, deleteKey)
@packages/daemon/package.json (needs sodium-native, argon2 dependencies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Crypto module (AES-256-GCM + Argon2id) + memory module (sodium guarded) + LocalKeyStore class</name>
  <files>
    packages/daemon/package.json
    packages/daemon/src/infrastructure/keystore/crypto.ts
    packages/daemon/src/infrastructure/keystore/memory.ts
    packages/daemon/src/infrastructure/keystore/keystore.ts
    packages/daemon/src/infrastructure/keystore/index.ts
  </files>
  <action>
**1. Install keystore dependencies** (add to packages/daemon/package.json if not already present):

Production dependencies:
- `sodium-native` ^5.0.10 (guarded memory)
- `argon2` ^0.44.0 (async Argon2id KDF)

Run `pnpm install` from workspace root.

**2. Create `crypto.ts`** (packages/daemon/src/infrastructure/keystore/crypto.ts):

Implements doc 26 sections 2-3.

```typescript
// deriveKey(password: string, salt?: Buffer): Promise<{ key: Buffer; salt: Buffer }>
// - Uses argon2.hash with argon2id type
// - memoryCost: 65536 (64 MiB), timeCost: 3, parallelism: 4, hashLength: 32
// - Returns raw 32-byte key + salt
// - If salt not provided, generates 16-byte CSPRNG salt

// encrypt(plaintext: Buffer, password: string): Promise<EncryptedData>
// - Generate 12-byte IV (crypto.randomBytes(12)) -- GCM 96-bit nonce
// - Derive AES-256 key via deriveKey(password)
// - Create AES-256-GCM cipher with key + IV
// - Encrypt plaintext, get ciphertext + authTag (16 bytes)
// - Return { iv, ciphertext, authTag, salt, kdfparams }

// decrypt(encrypted: EncryptedData, password: string): Promise<Buffer>
// - Derive key from password + stored salt
// - Create AES-256-GCM decipher with key + iv
// - Set authTag before decryption
// - Decrypt ciphertext
// - If authTag verification fails, throw WAIaaSError('KEYSTORE_WRONG_PASSWORD')
```

Use `node:crypto` for AES-256-GCM (createCipheriv/createDecipheriv). Use `argon2` npm package for async Argon2id (not sodium_pwhash which is sync and blocks event loop).

**EncryptedData interface:**
```typescript
interface EncryptedData {
  iv: Buffer;        // 12 bytes
  ciphertext: Buffer;
  authTag: Buffer;   // 16 bytes
  salt: Buffer;      // 16 bytes
  kdfparams: {
    memoryCost: number;
    timeCost: number;
    parallelism: number;
    hashLength: number;
  };
}
```

**3. Create `memory.ts`** (packages/daemon/src/infrastructure/keystore/memory.ts):

Implements doc 26 section 4 (sodium guarded memory).

```typescript
import sodium from 'sodium-native';

// allocateGuarded(size: number): Buffer
// - sodium.sodium_malloc(size) to allocate guarded buffer
// - Returns buffer with guard pages (no access default)

// writeToGuarded(target: Buffer, source: Buffer): void
// - sodium.sodium_mprotect_readwrite(target)
// - source.copy(target)
// - sodium.sodium_mprotect_readonly(target)

// zeroAndRelease(buf: Buffer): void
// - sodium.sodium_memzero(buf)
// - sodium.sodium_mprotect_noaccess(buf)
// Note: sodium_free is not exposed in sodium-native; rely on GC after zero+noaccess

// isAvailable(): boolean
// - Try to import sodium-native and return true/false
// - Fallback: if sodium-native not available, use regular Buffer (with warning)
```

**4. Create `keystore.ts`** (packages/daemon/src/infrastructure/keystore/keystore.ts):

Implements ILocalKeyStore from @waiaas/core (5 methods) + keystore file I/O.

```typescript
import type { ILocalKeyStore } from '@waiaas/core';

export class LocalKeyStore implements ILocalKeyStore {
  private keystoreDir: string;
  private guardedKeys: Map<string, Buffer>; // agentId -> guarded key buffer

  constructor(keystoreDir: string) { ... }

  // generateKeyPair(agentId, chain, network, password): Promise<{ publicKey: string }>
  // - For solana: generate Ed25519 keypair (64-byte secret = seed + pubkey)
  //   Use sodium.crypto_sign_keypair() for generation
  // - Encrypt private key with password via crypto.encrypt()
  // - Write keystore file to keystoreDir/<agentId>.json with format v1
  //   File permission 0600, JSON.stringify(obj, null, 2)
  // - Return public key (base58 for Solana, hex for EVM)
  // Note: For v1.1, only Solana Ed25519 key generation is needed

  // decryptPrivateKey(agentId, password): Promise<Buffer>
  // - Read keystore file from keystoreDir/<agentId>.json
  // - Parse JSON, validate version === 1
  // - Decrypt via crypto.decrypt() with password
  // - Store in sodium guarded memory (allocateGuarded + writeToGuarded)
  // - Add to guardedKeys map
  // - Return the guarded buffer (readonly)

  // releaseKey(agentId): void
  // - Get buffer from guardedKeys map
  // - zeroAndRelease(buffer)
  // - Remove from map

  // hasKey(agentId): boolean
  // - Check guardedKeys map

  // deleteKey(agentId): void
  // - releaseKey if loaded
  // - Delete keystore file from disk

  // lockAll(): void (additional method for shutdown)
  // - For each key in guardedKeys: zeroAndRelease
  // - Clear map
}
```

**Keystore file format v1** (doc 26 section 1.2):
```json
{
  "version": 1,
  "id": "<uuid v4>",
  "chain": "solana",
  "network": "devnet",
  "publicKey": "<base58>",
  "crypto": {
    "cipher": "aes-256-gcm",
    "cipherparams": { "iv": "<hex 24 chars>" },
    "ciphertext": "<hex>",
    "authTag": "<hex 32 chars>",
    "kdf": "argon2id",
    "kdfparams": {
      "salt": "<hex 32 chars>",
      "memoryCost": 65536,
      "timeCost": 3,
      "parallelism": 4,
      "hashLength": 32
    }
  },
  "metadata": {
    "name": "<agent name>",
    "createdAt": "<ISO 8601>",
    "lastUnlockedAt": null
  }
}
```

Write keystore files atomically: write to temp file, then rename (write-then-rename pattern from v0.9 decision).

**5. Create `index.ts`** barrel export for keystore module.
  </action>
  <verify>
- `pnpm install` succeeds with sodium-native and argon2 native addons compiled
- `pnpm build --filter=@waiaas/daemon` compiles without errors
- LocalKeyStore class implements ILocalKeyStore interface (TypeScript confirms)
  </verify>
  <done>
- crypto.ts: deriveKey + encrypt + decrypt functions implemented with AES-256-GCM + Argon2id
- memory.ts: allocateGuarded + writeToGuarded + zeroAndRelease using sodium-native
- keystore.ts: LocalKeyStore class implementing ILocalKeyStore with file I/O (format v1, permission 0600)
- All code compiles and builds successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Keystore tests -- encrypt/decrypt round-trip, wrong password, file format, memory safety</name>
  <files>
    packages/daemon/src/__tests__/keystore.test.ts
  </files>
  <action>
Create comprehensive tests for the keystore module using Vitest.

**Test categories:**

1. **Argon2id key derivation tests:**
   - deriveKey returns 32-byte key + 16-byte salt
   - Same password + same salt produces same key (deterministic)
   - Same password + different salt produces different key
   - deriveKey with empty password succeeds (allowed per spec, with warning)

2. **AES-256-GCM encrypt/decrypt round-trip tests:**
   - Encrypt 32-byte buffer (EVM private key size), decrypt returns identical buffer
   - Encrypt 64-byte buffer (Solana Ed25519 keypair size), decrypt returns identical buffer
   - Encrypt returns EncryptedData with correct field sizes: iv=12B, authTag=16B, salt=16B

3. **Wrong password tests:**
   - Decrypt with wrong password throws error (GCM authTag mismatch)
   - Error should be WAIaaSError or contain meaningful message about wrong password

4. **Keystore file format tests:**
   - generateKeyPair creates a valid JSON keystore file
   - File has version: 1, cipher: "aes-256-gcm", kdf: "argon2id"
   - kdfparams has memoryCost: 65536, timeCost: 3, parallelism: 4, hashLength: 32
   - File has metadata.name and metadata.createdAt
   - cipherparams.iv is 24-char hex string (12 bytes)
   - crypto.authTag is 32-char hex string (16 bytes)
   - crypto.salt (under kdfparams) is 32-char hex string (16 bytes)

5. **File permission tests** (Unix only):
   - Keystore file has permission 0600 (owner read/write only)
   - Skip on non-Unix platforms

6. **Full round-trip tests:**
   - generateKeyPair -> decryptPrivateKey returns key that can sign (for Solana: sodium.crypto_sign_detached succeeds)
   - decryptPrivateKey -> releaseKey -> hasKey returns false
   - deleteKey removes keystore file from disk

7. **Sodium guarded memory tests** (if sodium-native available):
   - allocateGuarded returns a Buffer of requested size
   - writeToGuarded sets buffer to readonly after write
   - zeroAndRelease zeros the buffer content

**Test setup:**
- Use a temporary directory (os.tmpdir + random suffix) for keystore files
- Clean up temp directory in afterAll
- Use a known test password: 'test-master-password-123'
- For KDF speed in tests, consider if the default Argon2id params (64MiB, t=3) make tests slow (~1-3s per call). If so, document in test file that production params are used and tests take a few seconds.
  </action>
  <verify>
- `pnpm test --filter=@waiaas/daemon` passes all keystore tests
- Tests cover: KDF, encrypt/decrypt, wrong password rejection, file format, permissions, full round-trip, memory safety
  </verify>
  <done>
- Encrypt-decrypt round-trip succeeds for 32-byte and 64-byte keys
- Wrong password is correctly rejected (GCM authTag mismatch)
- Keystore file conforms to format v1 JSON structure
- File permission is 0600 on Unix
- Guarded memory allocation, readonly protection, and zeroing verified
- At least 15 test assertions pass covering all categories
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter=@waiaas/daemon` succeeds
2. `pnpm test --filter=@waiaas/daemon` passes all keystore tests
3. LocalKeyStore correctly implements ILocalKeyStore interface
4. Keystore files are valid JSON with format v1 structure
</verification>

<success_criteria>
- AES-256-GCM encryption/decryption with Argon2id KDF (m=64MiB, t=3, p=4) works correctly
- Wrong password is rejected with clear error
- Keystore file format v1 matches doc 26 specification
- Sodium-native guarded memory protects decrypted keys in memory
- File permission 0600 is enforced
- LocalKeyStore implements ILocalKeyStore with generateKeyPair, decryptPrivateKey, releaseKey, hasKey, deleteKey
</success_criteria>

<output>
After completion, create `.planning/phases/49-daemon-infra/49-02-SUMMARY.md`
</output>
