---
phase: 25-test-strategy-doc-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/45-enum-unified-mapping.md
  - .planning/deliverables/27-chain-adapter-interface.md
  - .planning/deliverables/25-sqlite-schema.md
autonomous: true

must_haves:
  truths:
    - "TransactionType 5개(TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH)가 45-enum에 등록되어 있다"
    - "PolicyType 10개가 45-enum에 등록되어 있다 (기존 4개 + 신규 6개)"
    - "IChainAdapter에 getAssets(), buildContractCall(), buildApprove(), buildBatch() 메서드가 추가되어 있다"
    - "transactions 테이블에 TransactionType 5개 CHECK, PolicyType 10개 CHECK, 감사 컬럼 4개가 반영되어 있다"
  artifacts:
    - path: ".planning/deliverables/45-enum-unified-mapping.md"
      provides: "Enum SSoT - TransactionType 5개, PolicyType 10개, ActionErrorCode"
      contains: "CONTRACT_CALL"
    - path: ".planning/deliverables/27-chain-adapter-interface.md"
      provides: "IChainAdapter 확장 - getAssets, buildContractCall, buildApprove, buildBatch, FeeEstimate"
      contains: "buildContractCall"
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "SQLite 스키마 확장 - TransactionType 5개, PolicyType 10개, 감사 컬럼"
      contains: "contract_address"
  key_links:
    - from: ".planning/deliverables/45-enum-unified-mapping.md"
      to: ".planning/deliverables/27-chain-adapter-interface.md"
      via: "TransactionType, FeeEstimate 타입 정의 참조"
      pattern: "TransactionType"
    - from: ".planning/deliverables/45-enum-unified-mapping.md"
      to: ".planning/deliverables/25-sqlite-schema.md"
      via: "PolicyType CHECK 제약조건 참조"
      pattern: "PolicyType"
    - from: ".planning/deliverables/27-chain-adapter-interface.md"
      to: "docs/58-contract-call-spec.md"
      via: "buildContractCall 상세 설계 참조"
      pattern: "CHAIN-EXT-03"
---

<objective>
v0.6 확장의 SSoT 기반 문서 3개(45-enum, 27-chain-adapter, 25-sqlite)를 업데이트한다. 이 3개 문서는 다른 문서들이 참조하는 기초이므로 먼저 업데이트해야 한다.

Purpose: Enum 정의(45), 인터페이스 명세(27), 데이터 스키마(25)는 나머지 5개 문서(33, 32, 31, 37, 38)의 참조 기반이다. 이 SSoT 문서들을 먼저 v0.6에 맞게 업데이트하여 후속 문서 통합의 일관성을 보장한다.
Output: 3개 기존 문서의 v0.6 통합 업데이트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 현재 상태 (수정 대상)
@.planning/deliverables/45-enum-unified-mapping.md
@.planning/deliverables/27-chain-adapter-interface.md
@.planning/deliverables/25-sqlite-schema.md

# v0.6 소스 문서 (변경 항목 참조)
@docs/56-token-transfer-extension-spec.md
@docs/57-asset-query-fee-estimation-spec.md
@docs/58-contract-call-spec.md
@docs/59-approve-management-spec.md
@docs/60-batch-transaction-spec.md
@docs/61-price-oracle-spec.md
@docs/62-action-provider-architecture.md
@docs/63-swap-action-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 45-enum SSoT + 27-chain-adapter 인터페이스 v0.6 통합</name>
  <files>
    .planning/deliverables/45-enum-unified-mapping.md
    .planning/deliverables/27-chain-adapter-interface.md
  </files>
  <action>
**45-enum-unified-mapping.md 수정 (INTEG-02):**

v0.5에서 확립된 인라인 마킹 패턴(`(v0.6 변경/추가)` 주석)을 사용하여 기존 구조를 유지하면서 수정한다.

변경 항목 (~15개, 소스: 56 섹션 9.1, 58 섹션 10, 61 섹션 9.1, 62 섹션 10.2):

1. **TransactionType Enum 신규 등록** (현재 없음 -> 5개):
   - TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH
   - 각 값에 대해: 이름, 설명, 소스 문서, DB CHECK 제약조건
   - 58-contract-call-spec 섹션 10.1 "45-enum에 TransactionType 5개 정식 등록" 참조

2. **PolicyType Enum 확장** (현재 4개 -> 10개):
   - 기존 4개: SPENDING_LIMIT, DAILY_LIMIT, RATE_LIMIT, TIER_OVERRIDE (유지)
   - 신규 6개: ALLOWED_TOKENS, CONTRACT_WHITELIST, METHOD_WHITELIST, APPROVED_SPENDERS, APPROVE_AMOUNT_LIMIT, APPROVE_TIER_OVERRIDE
   - 58 섹션 10.1 "PolicyType 4개→10개 확장" 참조

3. **ActionErrorCode 추가** (62 섹션 10.2):
   - ACTION_PROVIDER_NOT_FOUND, ACTION_NOT_FOUND, ACTION_RESOLVE_FAILED, ACTION_VALIDATION_FAILED, ACTION_PROVIDER_LOAD_FAILED, ACTION_TIMEOUT, ACTION_CHAIN_MISMATCH
   - 7개 에러 코드, 각각 코드값/설명/HTTP 상태

4. **PriceSource (선택적):**
   - coingecko, pyth_http, chainlink_http, pyth_onchain, chainlink_onchain, cache_stale
   - 61 섹션 9.1 참조. 선택적 등록 (구현 시 확정)

5. **기존 Enum 교차 참조 업데이트:**
   - ErrorCode에 v0.6 에러 코드 교차 참조 추가 (CHAIN-EXT-03~08에서 정의된 에러 코드 10개+)

**27-chain-adapter-interface.md 수정:**

변경 항목 (~20개, 소스: 56 섹션 9.2, 57 섹션 9.1, 58 섹션 10.2, 59 섹션 10, 60 섹션 8, 62 섹션 10.1):

1. **타입 추가:**
   - TokenInfo: { mint: string, symbol: string, decimals: number, programId?: string } (56 섹션 2)
   - AssetInfo: { token: TokenInfo | null, balance: bigint, usdValue?: number } (57 섹션 2)
   - FeeEstimate: { networkFee: bigint, priorityFee?: bigint, accountCreationFee?: bigint, totalFee: bigint } (57 섹션 4 -- estimateFee() 반환 타입 변경)
   - ContractCallRequest: EVM calldata + Solana programId/instructionData/accounts (58 섹션 2)
   - ApproveRequest: token, spender, amount, chain-specific (59 섹션 2)
   - BatchRequest: instructions[], chain: 'solana' (60 섹션 2)

2. **IChainAdapter 메서드 추가 (기존 13 -> 17개):**
   - getAssets(walletAddress): Promise<AssetInfo[]> -- 14번째 (57 섹션 2)
   - buildContractCall(request): Promise<UnsignedTransaction> -- 15번째 (58 섹션 3)
   - buildApprove(request): Promise<UnsignedTransaction> -- 16번째 (59 섹션 3)
   - buildBatch(request): Promise<UnsignedTransaction> -- 17번째 (60 섹션 3)

3. **estimateFee() 반환 타입 변경:**
   - bigint -> FeeEstimate (하위 호환 유지 방안 포함) (57 섹션 4)

4. **에러 코드 확장:**
   - TOKEN_NOT_FOUND, TOKEN_NOT_ALLOWED, INSUFFICIENT_TOKEN_BALANCE (56)
   - CONTRACT_NOT_WHITELISTED, METHOD_NOT_WHITELISTED, CONTRACT_CALL_FAILED (58)
   - APPROVE_LIMIT_EXCEEDED, SPENDER_NOT_APPROVED, UNLIMITED_APPROVE_BLOCKED (59)
   - BATCH_NOT_SUPPORTED, BATCH_SIZE_EXCEEDED, BATCH_INSTRUCTION_INVALID (60)

5. **DeFi 메서드 미추가 원칙 명시:**
   - "IChainAdapter는 저수준 실행 엔진으로, DeFi 프로토콜 지식(swap, stake 등)은 IActionProvider에 위임한다" (62 섹션 10.1)

6. **AdapterRegistry 확장:**
   - Action Provider가 어댑터를 사용하는 패턴 설명 (62 섹션 3 참조)

기존 구조 유지 + 인라인 마킹 패턴. 기존 섹션 번호를 변경하지 않는다.
  </action>
  <verify>
45-enum: grep "CONTRACT_CALL" -- TransactionType 포함 확인
45-enum: grep "APPROVE_TIER_OVERRIDE" -- PolicyType 10번째 확인
45-enum: grep "ACTION_PROVIDER_NOT_FOUND" -- ActionErrorCode 확인
27-chain: grep "getAssets" -- 14번째 메서드 확인
27-chain: grep "buildContractCall" -- 15번째 메서드 확인
27-chain: grep "FeeEstimate" -- 반환 타입 변경 확인
27-chain: grep "DeFi" 또는 "IActionProvider" -- DeFi 미추가 원칙 확인
  </verify>
  <done>
45-enum에 TransactionType 5개, PolicyType 10개, ActionErrorCode 7개가 등록되어 있고, 27-chain-adapter에 4개 메서드(getAssets, buildContractCall, buildApprove, buildBatch), FeeEstimate 타입, DeFi 미추가 원칙이 반영되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 25-sqlite-schema v0.6 통합</name>
  <files>.planning/deliverables/25-sqlite-schema.md</files>
  <action>
25-sqlite-schema.md를 인라인 마킹 패턴으로 수정한다.

변경 항목 (~15개, 소스: 56 섹션 9.3, 58 섹션 10.3, 59 섹션 10, 60 섹션 8, 61 섹션 9.2, 62 섹션 10.3):

1. **transactions 테이블 확장:**
   - type 컬럼 CHECK 제약조건: ('TRANSFER', 'TOKEN_TRANSFER', 'CONTRACT_CALL', 'APPROVE', 'BATCH') -- 기존에는 암묵적/미정의
   - 감사 컬럼 4개 추가 (58 섹션 5):
     - contract_address TEXT -- 컨트랙트 주소 (CONTRACT_CALL, APPROVE)
     - method_signature TEXT -- 메서드 시그니처 (CONTRACT_CALL, EVM 전용)
     - spender_address TEXT -- 승인 대상 (APPROVE)
     - approved_amount TEXT -- 승인 금액 (APPROVE)
   - token_mint TEXT -- 토큰 민트 주소 (TOKEN_TRANSFER) (56 섹션 9.3)
   - metadata JSON 확장: actionSource, batchInstructions 등 (60, 62)

2. **policies 테이블 확장:**
   - rule_type CHECK 제약조건: 10개 PolicyType으로 확장
   - 각 rule_type별 rule_config JSON 스키마 문서화:
     - ALLOWED_TOKENS: { tokens: [{mint, symbol, chain}] }
     - CONTRACT_WHITELIST: { contracts: [{address, chain, label}] }
     - METHOD_WHITELIST: { methods: [{address, selector, name}] }
     - APPROVED_SPENDERS: { spenders: [{address, chain, label}] }
     - APPROVE_AMOUNT_LIMIT: { max_amount: string, unlimited_blocked: boolean }
     - APPROVE_TIER_OVERRIDE: { default_tier: string }

3. **인덱스 추가:**
   - idx_transactions_contract_address ON transactions(contract_address) WHERE contract_address IS NOT NULL
   - idx_transactions_type ON transactions(type) -- type별 조회 최적화

4. **SpendingLimit USD 확장 (61 섹션 9.2):**
   - policies.rule_config 내 SpendingLimitRuleSchema에 instant_max_usd, notify_max_usd, delay_max_usd optional 필드 추가 문서화

5. **ERD 갱신:**
   - transactions 테이블 컬럼 추가 반영
   - policies 테이블 rule_type 확장 반영

기존 구조 유지. 기존 섹션 번호를 변경하지 않는다. v0.6 변경 부분에 `(v0.6 추가)` 인라인 마킹.
  </action>
  <verify>
25-sqlite: grep "contract_address" -- 감사 컬럼 확인
25-sqlite: grep "CONTRACT_WHITELIST" -- PolicyType 확장 확인
25-sqlite: grep "idx_transactions_type" -- 인덱스 추가 확인
25-sqlite: grep "instant_max_usd" -- USD 확장 확인
25-sqlite: grep "BATCH" -- TransactionType 5번째 확인
  </verify>
  <done>
transactions 테이블에 TransactionType 5개 CHECK, 감사 컬럼 4개, token_mint, 인덱스 2개가 추가되어 있고, policies 테이블에 PolicyType 10개 CHECK + 6개 rule_config JSON 스키마가 문서화되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 45-enum에 TransactionType 5개, PolicyType 10개, ActionErrorCode 7개가 등록되어 있다
2. 27-chain-adapter에 IChainAdapter 메서드 17개(기존 13 + 신규 4), FeeEstimate 타입이 반영되어 있다
3. 25-sqlite에 감사 컬럼 4개, 인덱스 2개, PolicyType 10개 CHECK가 반영되어 있다
4. 3개 문서 모두 기존 섹션 구조가 유지되고 인라인 마킹 패턴이 사용되었다
</verification>

<success_criteria>
- INTEG-02 충족: TransactionType 5개, PolicyType 10개, ActionErrorCode 7개가 45-enum SSoT에 통합
- INTEG-01 부분 충족: 27-chain-adapter, 25-sqlite-schema에 v0.6 확장 반영 (3/8 문서)
- 기존 문서 구조 미파괴 (인라인 마킹 패턴 준수)
</success_criteria>

<output>
After completion, create `.planning/phases/25-test-strategy-doc-integration/25-02-SUMMARY.md`
</output>
