---
phase: 25-test-strategy-doc-integration
plan: 03
type: execute
wave: 2
depends_on: ["25-02"]
files_modified:
  - .planning/deliverables/33-time-lock-approval-mechanism.md
  - .planning/deliverables/32-transaction-pipeline-api.md
  - .planning/deliverables/31-solana-adapter-detail.md
autonomous: true

must_haves:
  truths:
    - "33-time-lock에 PolicyType 10개, evaluate() 11단계 알고리즘, 6개 신규 정책 스키마가 반영되어 있다"
    - "32-pipeline에 Stage 1 discriminatedUnion 5-type 분기, IPriceOracle 주입, actionSource 메타가 반영되어 있다"
    - "31-solana에 SPL 전송 정식화, Token-2022 지원, getAssets() 구현, approve/batch 참조가 반영되어 있다"
  artifacts:
    - path: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      provides: "정책 엔진 확장 - PolicyType 10개, evaluate() 11단계, USD 정책"
      contains: "APPROVE_TIER_OVERRIDE"
    - path: ".planning/deliverables/32-transaction-pipeline-api.md"
      provides: "파이프라인 확장 - 5-type 분기, IPriceOracle 주입"
      contains: "discriminatedUnion"
    - path: ".planning/deliverables/31-solana-adapter-detail.md"
      provides: "Solana 어댑터 확장 - SPL 정식화, Token-2022, getAssets"
      contains: "getAssets"
  key_links:
    - from: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      to: ".planning/deliverables/45-enum-unified-mapping.md"
      via: "PolicyType 10개 참조"
      pattern: "45-enum"
    - from: ".planning/deliverables/32-transaction-pipeline-api.md"
      to: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      via: "Stage 3 evaluate() 호출"
      pattern: "evaluate"
    - from: ".planning/deliverables/32-transaction-pipeline-api.md"
      to: "docs/61-price-oracle-spec.md"
      via: "IPriceOracle 주입 참조"
      pattern: "IPriceOracle"
---

<objective>
v0.6 확장의 기능 계층 문서 3개(33-time-lock, 32-pipeline, 31-solana)를 업데이트한다. Plan 25-02에서 업데이트된 SSoT(45-enum, 27-chain-adapter, 25-sqlite)를 기반으로 정책 엔진, 파이프라인, Solana 어댑터 문서를 일관되게 v0.6에 맞춘다.

Purpose: 정책 엔진(33)은 10개 PolicyType과 11단계 evaluate() 알고리즘을 문서화해야 하고, 파이프라인(32)은 5개 TransactionType 분기를 반영해야 하며, Solana 어댑터(31)는 SPL/Token-2022/배치 지원을 정식 반영해야 한다.
Output: 3개 기존 문서의 v0.6 통합 업데이트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# SSoT (Plan 25-02에서 업데이트된 상태)
@.planning/deliverables/45-enum-unified-mapping.md
@.planning/deliverables/27-chain-adapter-interface.md
@.planning/deliverables/25-sqlite-schema.md

# 수정 대상
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/deliverables/32-transaction-pipeline-api.md
@.planning/deliverables/31-solana-adapter-detail.md

# v0.6 소스 문서 (변경 항목 참조)
@docs/56-token-transfer-extension-spec.md
@docs/57-asset-query-fee-estimation-spec.md
@docs/58-contract-call-spec.md
@docs/59-approve-management-spec.md
@docs/60-batch-transaction-spec.md
@docs/61-price-oracle-spec.md
@docs/62-action-provider-architecture.md

# Plan 25-02 SUMMARY (SSoT 변경 사항 참조)
@.planning/phases/25-test-strategy-doc-integration/25-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 33-time-lock 정책 엔진 + 32-pipeline 파이프라인 v0.6 통합</name>
  <files>
    .planning/deliverables/33-time-lock-approval-mechanism.md
    .planning/deliverables/32-transaction-pipeline-api.md
  </files>
  <action>
**33-time-lock-approval-mechanism.md 수정:**

변경 항목 (~20개, 소스: 56 섹션 9.5, 58 섹션 10.4, 59 섹션 10, 60 섹션 8, 61 섹션 9.3):

1. **PolicyType 확장 (4 -> 10개):**
   - 기존 4개 유지: SPENDING_LIMIT, DAILY_LIMIT, RATE_LIMIT, TIER_OVERRIDE
   - 신규 6개 추가 (각각 Zod 스키마 포함):
     - ALLOWED_TOKENS: AllowedTokensRuleSchema -- 에이전트별 토큰 화이트리스트 (56)
     - CONTRACT_WHITELIST: ContractWhitelistRuleSchema -- 허용 컨트랙트 목록, 기본 전면 거부 (58)
     - METHOD_WHITELIST: MethodWhitelistRuleSchema -- EVM 전용 메서드 selector 화이트리스트 (58)
     - APPROVED_SPENDERS: ApprovedSpendersRuleSchema -- 승인 허용 대상 목록 (59)
     - APPROVE_AMOUNT_LIMIT: ApproveAmountLimitRuleSchema -- 단일 approve 최대 금액, unlimited_blocked (59)
     - APPROVE_TIER_OVERRIDE: ApproveTierOverrideRuleSchema -- approve 기본 티어 재정의 (59)

2. **evaluate() 알고리즘 확장 (기존 6단계 -> 11단계):**
   - 58 섹션 5의 11단계 알고리즘으로 업데이트:
     1. TransactionType 결정
     2. ALLOWED_TOKENS 검사 (TOKEN_TRANSFER)
     3. CONTRACT_WHITELIST 검사 (CONTRACT_CALL)
     4. METHOD_WHITELIST 검사 (CONTRACT_CALL, EVM only)
     5. APPROVED_SPENDERS 검사 (APPROVE)
     6. APPROVE_AMOUNT_LIMIT 검사 (APPROVE)
     7. 금액 기반 티어 결정 (SPENDING_LIMIT + resolveEffectiveAmountUsd)
     8. APPROVE_TIER_OVERRIDE 적용 (APPROVE)
     9. DAILY_LIMIT 검사
     10. RATE_LIMIT 검사
     11. 최종 PolicyDecision 반환
   - DENY 우선 원칙 (1-6번 중 하나라도 DENY면 즉시 반환)

3. **SpendingLimitRuleSchema USD 확장 (61 섹션 9.3):**
   - instant_max_usd, notify_max_usd, delay_max_usd optional 필드 추가
   - USD + 네이티브 병행 평가: maxTier(nativeTier, usdTier) 보수적 채택
   - stale 가격 INSTANT->NOTIFY 상향, +-50% 급변동 시 한 단계 상향

4. **CONTRACT_CALL 기본 APPROVAL 티어 (58 섹션 4):**
   - 화이트리스트에 없는 컨트랙트는 DENY
   - 화이트리스트 통과 시 기본 APPROVAL 티어 (보수적)

5. **배치 정책 합산 (60 섹션 5):**
   - Phase A: 개별 instruction 정책 검사 (DENY 발생 시 전체 배치 DENY)
   - Phase B: 금액 합산 후 티어 결정 (합산 금액 + maxTier with APPROVE override)

**32-transaction-pipeline-api.md 수정:**

변경 항목 (~20개, 소스: 56 섹션 9.6, 58 섹션 10.5, 59 섹션 10, 60 섹션 8, 61 섹션 9.4, 62 섹션 10.4):

1. **Stage 1 (요청 파싱) 확장:**
   - discriminatedUnion 5-type: TRANSFER | TOKEN_TRANSFER | CONTRACT_CALL | APPROVE | BATCH
   - type 필드 기반 분기 (58 섹션 7)
   - Zod 스키마: TransferRequestSchema, TokenTransferRequestSchema, ContractCallRequestSchema, ApproveRequestSchema, BatchRequestSchema

2. **Stage 2 (세션 제약) 확장:**
   - allowedContracts 세션 제약 추가 (58 섹션 7)
   - allowedSpenders 세션 제약 추가 (59)
   - allowedTokens 세션 제약 추가 (56)

3. **Stage 3 (정책 평가) 확장:**
   - evaluate() 11단계 알고리즘 호출 (33 참조)
   - IPriceOracle 주입: resolveEffectiveAmountUsd() 호출로 USD 기준 티어 결정 (61 섹션 6)
   - 배치: Phase A + Phase B 2단계 평가 (60)

4. **Stage 4 (대기/승인) 확장:**
   - CONTRACT_CALL, APPROVE의 DELAY/APPROVAL 처리
   - 배치의 All-or-Nothing: 하나라도 DENY면 전체 배치 DENY

5. **Stage 5 (빌드/서명/제출) 확장:**
   - type별 빌드 메서드 분기:
     - TRANSFER/TOKEN_TRANSFER -> buildTransfer()
     - CONTRACT_CALL -> buildContractCall()
     - APPROVE -> buildApprove()
     - BATCH -> buildBatch()

6. **actionSource 메타데이터:**
   - Action Provider에서 resolve()한 요청에 actionSource 필드 추가 (62 섹션 10.4)
   - transactions.metadata에 actionSource 기록

기존 구조 유지 + 인라인 마킹 패턴. 기존 섹션 번호를 변경하지 않는다.
  </action>
  <verify>
33-time-lock: grep "APPROVE_TIER_OVERRIDE" -- 10번째 PolicyType 확인
33-time-lock: grep "11단계" 또는 "Step 11" -- evaluate 알고리즘 확인
33-time-lock: grep "instant_max_usd" -- USD 확장 확인
32-pipeline: grep "discriminatedUnion" -- Stage 1 5-type 확인
32-pipeline: grep "IPriceOracle" -- Stage 3 주입 확인
32-pipeline: grep "buildContractCall" -- Stage 5 분기 확인
32-pipeline: grep "actionSource" -- 메타데이터 확인
  </verify>
  <done>
33-time-lock에 PolicyType 10개, evaluate() 11단계, USD 정책 확장이 반영되어 있고, 32-pipeline에 Stage 1~5 전체 v0.6 확장(5-type 분기, IPriceOracle 주입, actionSource)이 반영되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 31-solana-adapter v0.6 통합</name>
  <files>.planning/deliverables/31-solana-adapter-detail.md</files>
  <action>
31-solana-adapter-detail.md를 인라인 마킹 패턴으로 수정한다.

변경 항목 (~15개, 소스: 56 섹션 9.4, 57 섹션 9.2, 59 섹션 10, 60 섹션 8, 63 섹션 10):

1. **SPL 토큰 전송 정식화 (56 섹션 5):**
   - v0.2에서 "SPL v0.3"으로 미뤘던 SPL 토큰 전송이 v0.6에서 정식 설계됨
   - buildTransfer() 분기: token 필드 존재 시 SPL 전송
   - getTransferCheckedInstruction 사용 (decimals 온체인 검증)
   - ATA(Associated Token Account) 자동 생성: getOrCreateAssociatedTokenAccount
   - ATA 생성 비용: getMinimumBalanceForRentExemption(165) 동적 조회

2. **Token-2022 지원 (56 섹션 5.3):**
   - Token-2022 기본 transfer 지원
   - 위험 확장(TransferFee, ConfidentialTransfer 등) 감지 시 거부
   - 프로그램 ID 감지: TOKEN_PROGRAM_ID vs TOKEN_2022_PROGRAM_ID

3. **getAssets() 구현 설계 (57 섹션 5):**
   - RPC: getTokenAccountsByOwner() 호출
   - 반환: AssetInfo[] (네이티브 SOL 첫 번째, 이후 잔액 내림차순)
   - Token-2022 토큰도 type='spl'로 통합 (programId 내부 구분)

4. **estimateFee() 확장 (57 섹션 6):**
   - 반환 타입: bigint -> FeeEstimate 구조체
   - accountCreationFee: ATA 생성 필요 시 rent-exempt 비용 포함
   - 토큰 전송 시 compute unit 추정 확장

5. **approve/batch 빌드 참조:**
   - buildApprove(): createApproveCheckedInstruction 사용 (59 섹션 6)
   - Solana 단일 delegate 제약 경고 (기존 delegate 덮어쓰기, previousDelegate 감사 로그)
   - buildBatch(): 다중 instruction VersionedTransaction 구성 (60 섹션 4)
   - 배치 한도: min 2 / max 20 instructions, ATA 생성도 카운트 포함

6. **Jupiter swap instruction 빌드 참조 (63 섹션 10):**
   - /swap-instructions 응답의 swapInstruction -> TransactionInstruction 변환
   - computeBudgetInstructions, setupInstructions 포함
   - Jito MEV 보호 (1000 lamports 팁 instruction 추가)

기존 구조 유지 + 인라인 마킹 패턴. 기존 섹션 번호를 변경하지 않는다. 기존 "SPL v0.3" 미루기 주석을 "(v0.6 정식 설계)" 마킹으로 교체.
  </action>
  <verify>
31-solana: grep "getTransferCheckedInstruction" -- SPL 전송 확인
31-solana: grep "Token-2022" 또는 "TOKEN_2022_PROGRAM_ID" -- Token-2022 확인
31-solana: grep "getAssets" -- 자산 조회 확인
31-solana: grep "FeeEstimate" -- 수수료 반환 타입 확인
31-solana: grep "buildApprove" -- approve 빌드 참조 확인
31-solana: grep "buildBatch" -- 배치 빌드 참조 확인
  </verify>
  <done>
31-solana에 SPL 토큰 전송(getTransferCheckedInstruction), Token-2022 지원/거부, getAssets() 구현, FeeEstimate 반환 타입, approve/batch 빌드 참조, Jupiter 연동이 반영되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 33-time-lock에 PolicyType 10개, evaluate() 11단계, 6개 신규 정책 스키마, USD 확장이 반영되어 있다
2. 32-pipeline에 Stage 1 5-type discriminatedUnion, Stage 3 IPriceOracle, Stage 5 type별 빌드 분기가 반영되어 있다
3. 31-solana에 SPL 정식화, Token-2022, getAssets(), approve/batch가 반영되어 있다
4. 3개 문서 모두 기존 섹션 구조가 유지되고 인라인 마킹 패턴이 사용되었다
</verification>

<success_criteria>
- INTEG-01 부분 충족: 33-time-lock, 32-pipeline, 31-solana에 v0.6 확장 반영 (6/8 문서, 누적)
- 33의 10개 PolicyType이 45-enum의 10개와 정확히 일치한다
- 32의 5-type 분기가 45-enum의 TransactionType 5개와 정확히 일치한다
</success_criteria>

<output>
After completion, create `.planning/phases/25-test-strategy-doc-integration/25-03-SUMMARY.md`
</output>
