---
phase: 25-test-strategy-doc-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/64-extension-test-strategy.md
autonomous: true

must_haves:
  truths:
    - "v0.4 테스트 프레임워크에 신규 Mock 경계 5개가 추가되어 있다"
    - "EVM 로컬 테스트 환경(Hardhat)이 ERC-20 배포 + Uniswap fork 시나리오를 포함하여 설계에 반영되어 있다"
    - "@waiaas/actions, @waiaas/oracle, @waiaas/adapter-evm 커버리지 기준이 재설정되어 있다"
    - "Phase 22-24의 ~148개 테스트 시나리오가 도메인별로 통합 분류되어 있다"
    - "IPriceOracle, IActionProvider Contract Test 전략이 명시되어 있다"
  artifacts:
    - path: "docs/64-extension-test-strategy.md"
      provides: "CHAIN-EXT-09 확장 기능 테스트 전략 통합 문서"
      contains: "MockPriceOracle"
      min_lines: 800
  key_links:
    - from: "docs/64-extension-test-strategy.md"
      to: "docs/v0.4/41-test-levels-matrix-coverage.md"
      via: "v0.4 테스트 레벨 매트릭스 확장 참조"
      pattern: "41-test-levels"
    - from: "docs/64-extension-test-strategy.md"
      to: "docs/v0.4/42-mock-boundaries-interfaces-contracts.md"
      via: "v0.4 Mock 경계 5개 -> 10개 확장"
      pattern: "42-mock-boundaries"
    - from: "docs/64-extension-test-strategy.md"
      to: "docs/61-price-oracle-spec.md"
      via: "MockPriceOracle 설계 참조"
      pattern: "MockPriceOracle"
    - from: "docs/64-extension-test-strategy.md"
      to: "docs/62-action-provider-architecture.md"
      via: "Mock IActionProvider 설계 참조"
      pattern: "IActionProvider"
---

<objective>
CHAIN-EXT-09 확장 기능 테스트 전략 문서를 생성한다. Phase 22-24에서 설계한 8개 확장 기능(CHAIN-EXT-01~08)의 테스트 전략을 v0.4 테스트 프레임워크(docs/v0.4/41~51)에 통합하는 단일 문서를 산출한다.

Purpose: v0.6에서 추가된 토큰 전송, 컨트랙트 호출, Approve, 배치 트랜잭션, 가격 오라클, Action Provider, Swap의 테스트 전략이 v0.4 프레임워크와 일관되게 통합되어야 구현 단계에서 테스트 설계 비용이 최소화된다.
Output: docs/64-extension-test-strategy.md (CHAIN-EXT-09)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-test-strategy-doc-integration/25-RESEARCH.md

# v0.4 테스트 프레임워크 (확장 대상)
@docs/v0.4/41-test-levels-matrix-coverage.md
@docs/v0.4/42-mock-boundaries-interfaces-contracts.md
@docs/v0.4/48-blockchain-test-environment-strategy.md

# Phase 22-24 소스 문서 (테스트 시나리오 취합 원본)
@docs/56-token-transfer-extension-spec.md
@docs/57-asset-query-fee-estimation-spec.md
@docs/58-contract-call-spec.md
@docs/59-approve-management-spec.md
@docs/60-batch-transaction-spec.md
@docs/61-price-oracle-spec.md
@docs/62-action-provider-architecture.md
@docs/63-swap-action-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mock 경계 확장 + Contract Test + EVM 테스트 환경 설계</name>
  <files>docs/64-extension-test-strategy.md</files>
  <action>
docs/64-extension-test-strategy.md 파일을 생성한다. 문서 번호는 64, 제목은 "v0.6 확장 기능 테스트 전략 (CHAIN-EXT-09)".

문서 구조 (섹션 1~5를 이 태스크에서 작성):

**섹션 1: 개요**
- v0.4 테스트 프레임워크 요약 (6개 레벨, 9개 모듈, 5개 Mock 경계)
- v0.6 확장 범위 (8개 CHAIN-EXT, 5개 신규 Mock 경계, 2개 신규 모듈)
- 이 문서의 역할: v0.4 42-mock-boundaries 확장 + v0.6 전용 테스트 시나리오 통합

**섹션 2: Mock 경계 확장 (TEST-01)**
v0.4의 5개 Mock 경계에 5개를 추가하여 10개로 확장. 각 Mock 경계에 대해:
- Mock 대상, Mock 방식, 사용 레벨, 소스 문서 참조
- 구체적 코드 수준 인터페이스 (61 섹션 8.2, 62 섹션 9.2, 63 섹션 9.2 참조)

5개 신규 Mock:
1. Aggregator (Jupiter API): msw 2.x로 /quote, /swap-instructions Mock. 63-swap-action-spec 섹션 9.2의 setupServer() 패턴 그대로 참조.
2. 가격 API (CoinGecko/Pyth/Chainlink HTTP): msw로 HTTP 응답 Mock + 429/500 에러 시뮬레이션. 61-price-oracle-spec 섹션 8.4 참조.
3. 온체인 오라클 (Pyth on-chain): Bankrun/Hardhat으로 가격 피드 계정 Mock. 61 섹션 8.2 참조.
4. IPriceOracle: MockPriceOracle 클래스 (setPrice, setFailMode, setStaleMode). 61 섹션 8.2 설계 완료 상태 참조.
5. IActionProvider: mockProvider 객체 (고정 resolve 반환 ContractCallRequest). 62 섹션 9.2 설계 완료 상태 참조.

Mock 경계 매트릭스 10x6 테이블 포함 (기존 5 + 신규 5, 6개 테스트 레벨별 사용 방식).

**섹션 3: Contract Test 확장**
v0.4에서 5개 인터페이스(IChainAdapter, IKeystoreProvider, IPolicyEngine, INotificationChannel, IOwnerSigner)에 Contract Test를 정의했다. v0.6에서 2개 추가:
- IPriceOracle Contract Test: 4개 메서드(getPrice, getPrices, getNativePrice, getCacheStats) 행위 검증. MockPriceOracle이 통과해야 하는 테스트 스위트.
- IActionProvider Contract Test: metadata, actions, resolve() 행위 검증. mockProvider가 통과해야 하는 테스트 스위트. validate-then-trust 경계 검증 포함.

Contract Test 매트릭스를 5개 -> 7개로 확장.

**섹션 4: EVM 로컬 테스트 환경 (TEST-02)**
v0.4에서는 EvmAdapterStub이므로 EVM 테스트가 불필요했다. v0.6에서 ERC-20 빌드 로직이 추가되어 Hardhat 환경 필수.

내용:
- Hardhat Network 인메모리 EVM 설정 (hardhat.config.ts 구조)
- Fork 모드: Ethereum Mainnet fork (Alchemy RPC, Uniswap 컨트랙트 활용)
- @nomicfoundation/hardhat-viem 플러그인 통합 (viem 기반 어댑터와 일관)
- TestERC20.sol 배포 시나리오 (mint 가능, 6/18 decimals)
- 디렉토리 구조: packages/adapters/evm/ 하위 hardhat.config.ts, contracts/, test/
- Uniswap V3 fork 시나리오: approve + swap 통합 (ET-TOKEN-01~08 from 57, C1~C2 from 59)
- Level 3 Chain Mock (nightly/릴리스) 실행 전략
- Solana 테스트 환경 확장: Bankrun으로 SPL ApproveChecked, 배치 트랜잭션, Jupiter instruction 빌드 검증 (Level 2~3)

**섹션 5: 커버리지 재설정 (TEST-03)**
- 패키지별 커버리지 테이블 갱신:
  - @waiaas/adapter-evm: 50% (Stub Low) -> 80%+ (High) -- Stub에서 실제 빌드 로직으로 전환
  - @waiaas/actions (NEW): 80%+ (High) -- Jupiter resolve() + 보안 검증 핵심
  - @waiaas/oracle (NEW): daemon 내부 모듈(infrastructure/oracle/), 80%+ (High) -- 가격 정확성이 정책에 직결
- 모듈 테스트 매트릭스 9개 -> 11개 확장 테이블
- daemon 서브모듈 커버리지 추가:
  - services/policy-engine: 90%+ (evaluateSpendingLimitUsd, 11단계 알고리즘)
  - services/transaction-service: 90%+ (5-type discriminatedUnion 분기)
  - server/routes/: 80%+ (/v1/actions/ 4개 + /v1/wallet/assets)
- Jest coverageThreshold 설정 예시 (jest.config.ts 포맷)

주의사항:
- 문서는 한글로 작성한다 (기존 패턴).
- 코드 예시는 RESEARCH.md와 소스 문서(61, 62, 63)에서 참조하되, 그대로 복사가 아닌 테스트 전략 맥락에 맞게 재구성.
- v0.4 문서 번호를 정확히 참조 (41, 42, 48).
  </action>
  <verify>
docs/64-extension-test-strategy.md 파일이 존재하고, 섹션 1~5가 모두 작성되어 있는지 확인. grep으로 핵심 키워드 존재 검증:
- "MockPriceOracle" (Mock 경계)
- "IActionProvider" (Mock 경계)
- "Hardhat" (EVM 환경)
- "@waiaas/actions" (커버리지)
- "Contract Test" (Contract Test 확장)
  </verify>
  <done>
Mock 경계 10x6 매트릭스, Contract Test 7개, Hardhat EVM 환경, Solana Bankrun 확장, 커버리지 재설정 테이블이 모두 포함된 섹션 1~5가 완성되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 테스트 시나리오 통합 + 보안 시나리오 교차 참조</name>
  <files>docs/64-extension-test-strategy.md</files>
  <action>
docs/64-extension-test-strategy.md에 섹션 6~8을 추가한다.

**섹션 6: 테스트 시나리오 통합**
Phase 22-24의 ~148개 테스트 시나리오를 도메인별로 통합 분류한다. 각 소스 문서에서 테스트 시나리오 섹션을 참조하여 취합:
- 56 섹션 8 (토큰 전송 Unit/Integration/Chain Mock)
- 57 섹션 8 (자산 조회/수수료 Unit/Integration/Chain Mock, ET-TOKEN-01~08)
- 58 섹션 9 (컨트랙트 호출 테스트)
- 59 섹션 9 (Approve 22개 시나리오)
- 60 섹션 7 (배치 14개 시나리오)
- 61 섹션 8 (오라클 테스트 시나리오)
- 62 섹션 9 (Action Provider 테스트)
- 63 섹션 9 (Jupiter Swap 테스트)

시나리오 번호 체계 통일 (도메인 접두어):
- TOK-U## (토큰 Unit), TOK-I## (Integration), TOK-C## (Chain Mock)
- CTR-U## (컨트랙트 Unit), CTR-S## (Security)
- APR-U## (Approve Unit), APR-S## (Security)
- BAT-U## (배치 Unit), BAT-S## (Security)
- ORC-U## (오라클 Unit), ORC-S## (Security)
- ACT-U## (Action Unit), ACT-S## (Security)
- SWP-U## (Swap Unit), SWP-S## (Security)

각 도메인별로:
1. 테스트 레벨별 시나리오 테이블 (번호, 시나리오명, 검증 포인트, 소스 문서 섹션)
2. 도메인 간 교차 시나리오 (예: 오라클 가격 stale 시 Approve 정책 평가)

**섹션 7: 보안 시나리오 통합**
v0.6 보안 시나리오 ~56건을 통합:
- 토큰 보안 (SEC-TOKEN-01~08 from 56)
- 컨트랙트 보안 (~5건 from 58)
- Approve 보안 (S1~S6 from 59)
- 배치 보안 (S1~S3 from 60)
- 오라클 보안 (S1~S12 from 61)
- Action Provider 보안 (시나리오 1~12 from 62)
- Jupiter Swap 보안 (시나리오 1~10 from 63)

v0.4 보안 시나리오(71건, docs/v0.4/43-security-scenario-analysis.md)와 교차 참조 매트릭스:
- 겹치는 영역 식별 (예: v0.4 키스토어 보안 -> v0.6 연관 없음)
- v0.6 고유 위협 영역 (가격 조작, Action Provider 악성 코드, 슬리피지 공격)
- 총 보안 시나리오 수 업데이트: v0.4 71건 + v0.6 ~56건 = ~127건

**섹션 8: 부록**
- v0.4 -> v0.6 변경 요약 테이블 (Old vs New 형식)
- Phase 25 scope out 항목: 36-killswitch 변경 (참조 링크 수준), 56-63 과도기 주석 업데이트 (LOW 우선순위)
- 참조 문서 목록

주의사항:
- 테스트 시나리오는 각 소스 문서의 시나리오를 "취합+재분류"하는 것이지 새로 만드는 것이 아니다. 원본 시나리오의 의미를 유지하되 번호 체계만 통일.
- 각 시나리오 테이블에 소스 문서 참조를 반드시 포함하여 추적성 확보.
- 보안 시나리오는 v0.4의 43-security-scenario-analysis.md 형식을 참조하여 일관된 포맷.
  </action>
  <verify>
docs/64-extension-test-strategy.md에 섹션 6~8이 추가되어 있는지 확인. grep으로 검증:
- "TOK-U" (토큰 시나리오 번호)
- "ORC-S" (오라클 보안 시나리오)
- "SWP-S" (Swap 보안 시나리오)
- 총 시나리오 수 ~148개 이상 포함 여부 (테이블 행 수 확인)
- "43-security-scenario" (v0.4 보안 교차 참조)
  </verify>
  <done>
7개 도메인의 ~148개 테스트 시나리오가 통일된 번호 체계로 통합되어 있고, ~56개 보안 시나리오가 v0.4 71건과 교차 참조되어 총 ~127건의 보안 시나리오 커버리지가 확인된다.
  </done>
</task>

</tasks>

<verification>
1. docs/64-extension-test-strategy.md가 존재하고 800줄 이상이다
2. Mock 경계 10x6 매트릭스가 포함되어 있다 (기존 5 + 신규 5)
3. Contract Test 7개 인터페이스가 명시되어 있다 (기존 5 + IPriceOracle + IActionProvider)
4. Hardhat EVM 환경 설정이 fork 모드 + viem 플러그인 + TestERC20 포함하여 설계되어 있다
5. 커버리지 테이블에 @waiaas/actions 80%+, @waiaas/oracle 80%+, @waiaas/adapter-evm 80%+가 명시되어 있다
6. 도메인별 시나리오 번호 체계(TOK-/CTR-/APR-/BAT-/ORC-/ACT-/SWP-)가 사용되고 있다
7. v0.4 보안 시나리오 71건과의 교차 참조가 존재한다
</verification>

<success_criteria>
- TEST-01 충족: Mock 경계 5개(Aggregator, 가격 API, 온체인 오라클, IPriceOracle, IActionProvider) 추가
- TEST-02 충족: Hardhat EVM 환경 + Uniswap fork + Bankrun SPL 확장 설계
- TEST-03 충족: @waiaas/actions 80%+, @waiaas/oracle 80%+, adapter-evm 80%+ 커버리지 재설정
- 148개 테스트 시나리오 통합, 56개 보안 시나리오 교차 참조
</success_criteria>

<output>
After completion, create `.planning/phases/25-test-strategy-doc-integration/25-01-SUMMARY.md`
</output>
