---
phase: 113-mcp-sdk-admin-ui
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/pages/wallets.tsx
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/__tests__/wallets.test.tsx
  - packages/admin/src/__tests__/policies.test.tsx
autonomous: true

must_haves:
  truths:
    - "Admin UI 월렛 생성 시 environment 라디오버튼(testnet/mainnet)으로 선택할 수 있다"
    - "Admin UI 월렛 상세에서 사용 가능 네트워크 목록이 표시되고 기본 네트워크를 변경할 수 있다"
    - "Admin UI 월렛 목록에서 network 대신 environment 컬럼이 표시된다"
    - "Admin UI 정책 목록에 network 컬럼이 표시된다 (ADMIN-03 대안: Admin에 별도 트랜잭션 페이지 미존재)"
    - "Admin UI 정책 생성에서 ALLOWED_NETWORKS 타입을 선택할 수 있고, 네트워크 스코프를 지정할 수 있다"
  artifacts:
    - path: "packages/admin/src/pages/wallets.tsx"
      provides: "environment 기반 월렛 생성/상세 UI"
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "ALLOWED_NETWORKS 정책 타입 + network 스코프"
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "WALLET_NETWORKS, WALLET_DEFAULT_NETWORK 엔드포인트"
  key_links:
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "POST /v1/wallets"
      via: "apiPost body.environment"
      pattern: "environment.*apiPost|formEnvironment"
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "PUT /v1/wallets/:id/default-network"
      via: "apiPut"
      pattern: "default-network|WALLET_DEFAULT_NETWORK"
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "GET /v1/wallets/:id/networks"
      via: "apiGet"
      pattern: "WALLET_NETWORKS|/networks"
---

<objective>
Admin UI의 월렛 생성/상세/목록과 정책 생성 UI를 멀티체인 환경 모델로 전환한다.

Purpose: 관리자가 Admin UI에서 environment 기반으로 월렛을 관리하고, 네트워크별 정책을 설정할 수 있도록 하여 멀티체인 환경 모델의 UI 인터페이스를 완성한다.
Output: wallets.tsx (환경 모델 전환 + 네트워크 관리) + policies.tsx (ALLOWED_NETWORKS + network 스코프) + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/112-rest-api-network-extension/112-02-SUMMARY.md

@packages/admin/src/pages/wallets.tsx
@packages/admin/src/pages/policies.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/__tests__/wallets.test.tsx
@packages/admin/src/__tests__/policies.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin UI 월렛 환경 모델 전환 + 네트워크 관리 UI</name>
  <files>
    packages/admin/src/pages/wallets.tsx
    packages/admin/src/api/endpoints.ts
  </files>
  <action>
    **A. endpoints.ts에 신규 엔드포인트 추가:**

    ```typescript
    WALLET_NETWORKS: (id: string) => `/v1/wallets/${id}/networks`,
    WALLET_DEFAULT_NETWORK: (id: string) => `/v1/wallets/${id}/default-network`,
    ```

    **B. wallets.tsx Wallet 인터페이스 변경:**

    `Wallet` 인터페이스에 `environment` 필드 추가:
    ```typescript
    interface Wallet {
      id: string;
      name: string;
      chain: string;
      network: string;       // 기존 유지 (defaultNetwork)
      environment: string;    // 신규 추가
      publicKey: string;
      status: string;
      createdAt: number;
    }
    ```

    `WalletDetail` 인터페이스에도 `environment`, `defaultNetwork` 필드 추가:
    ```typescript
    interface WalletDetail extends Wallet {
      defaultNetwork: string;
      ownerAddress: string | null;
      ownerVerified: boolean | null;
      ownerState: 'NONE' | 'GRACE' | 'LOCKED';
      updatedAt: number | null;
    }
    ```

    네트워크 정보를 위한 인터페이스 추가:
    ```typescript
    interface NetworkInfo {
      network: string;
      name?: string;
      isDefault: boolean;
    }
    ```

    **C. walletColumns 수정 -- network -> environment:**

    기존 `{ key: 'network', header: 'Network' }` 를 `{ key: 'environment', header: 'Environment', render: (a) => <Badge variant={a.environment === 'mainnet' ? 'warning' : 'info'}>{a.environment}</Badge> }` 로 변경.

    **D. WalletListView -- 생성 폼 network dropdown -> environment 라디오:**

    기존 `formNetwork` signal 제거. `formEnvironment` signal 추가 (기본값 'testnet').

    기존 `chainNetworkOptions` 함수는 유지 (Admin 내부에서 참조 가능성 대비, export 유지).

    생성 폼 UI 변경:
    - Chain select 유지 (solana/ethereum)
    - Network select 제거
    - Environment 라디오버튼 추가:
    ```tsx
    <FormField
      label="Environment"
      name="environment"
      type="select"
      value={formEnvironment.value}
      onChange={(v) => { formEnvironment.value = v as string; }}
      options={[
        { label: 'Testnet', value: 'testnet' },
        { label: 'Mainnet', value: 'mainnet' },
      ]}
    />
    ```
    (FormField type="select"로 radio 대신 사용 -- 기존 FormField 컴포넌트 유지. select로 testnet/mainnet 선택)

    API 호출 변경:
    ```typescript
    await apiPost<Wallet>(API.WALLETS, {
      name: formName.value.trim(),
      chain: formChain.value,
      environment: formEnvironment.value,
    });
    ```
    기존 `network: formNetwork.value` -> `environment: formEnvironment.value`로 변경. `handleChainChange`에서 formNetwork 업데이트 제거. formEnvironment는 체인 변경 시 리셋 불필요 (환경은 체인과 독립).

    **E. WalletDetailView -- 네트워크 관리 UI 추가:**

    네트워크 목록을 위한 signal과 fetch 함수 추가:
    ```typescript
    const networks = useSignal<NetworkInfo[]>([]);
    const networksLoading = useSignal(true);
    const defaultNetworkLoading = useSignal(false);

    const fetchNetworks = async () => {
      networksLoading.value = true;
      try {
        const result = await apiGet<{ networks: NetworkInfo[] }>(API.WALLET_NETWORKS(id));
        networks.value = result.networks;
      } catch (err) {
        const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
        showToast('error', getErrorMessage(e.code));
      } finally {
        networksLoading.value = false;
      }
    };
    ```

    기본 네트워크 변경 함수:
    ```typescript
    const handleChangeDefaultNetwork = async (network: string) => {
      defaultNetworkLoading.value = true;
      try {
        await apiPut(API.WALLET_DEFAULT_NETWORK(id), { network });
        showToast('success', `Default network changed to ${network}`);
        await fetchWallet();
        await fetchNetworks();
      } catch (err) {
        const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
        showToast('error', getErrorMessage(e.code));
      } finally {
        defaultNetworkLoading.value = false;
      }
    };
    ```

    useEffect에 `fetchNetworks()` 추가.

    상세 뷰 변경:
    - "Network" DetailRow를 "Default Network"로 변경: `<DetailRow label="Default Network" value={wallet.value.defaultNetwork ?? wallet.value.network} />`
    - "Environment" DetailRow 추가: `<DetailRow label="Environment"><Badge variant={wallet.value.environment === 'mainnet' ? 'warning' : 'info'}>{wallet.value.environment}</Badge></DetailRow>`

    네트워크 섹션 추가 (MCP Setup 섹션 전에):
    ```tsx
    <div class="networks-section" style={{ marginTop: 'var(--space-6)' }}>
      <h3 style={{ marginBottom: 'var(--space-3)' }}>Available Networks</h3>
      {networksLoading.value ? (
        <div class="stat-skeleton" style={{ height: '80px' }} />
      ) : (
        <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--space-2)' }}>
          {networks.value.map((n) => (
            <div key={n.network} style={{
              display: 'flex', alignItems: 'center', justifyContent: 'space-between',
              padding: 'var(--space-2) var(--space-3)',
              background: 'var(--color-bg-secondary)', borderRadius: 'var(--radius-md)',
            }}>
              <span>
                {n.name ?? n.network}
                {n.isDefault && <Badge variant="success" style={{ marginLeft: 'var(--space-2)' }}>Default</Badge>}
              </span>
              {!n.isDefault && wallet.value?.status === 'ACTIVE' && (
                <Button
                  size="sm"
                  variant="secondary"
                  onClick={() => handleChangeDefaultNetwork(n.network)}
                  loading={defaultNetworkLoading.value}
                >
                  Set Default
                </Button>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
    ```

    **F. WalletDetailView -- 최근 트랜잭션 섹션 추가 (ADMIN-03):**

    Admin UI에 트랜잭션 목록 페이지가 없으므로, 월렛 상세에 최근 트랜잭션 미니 테이블을 추가한다.

    트랜잭션 인터페이스와 signal 추가:
    ```typescript
    interface WalletTransaction {
      id: string;
      type: string;
      status: string;
      network: string | null;
      amount: string | null;
      toAddress: string | null;
      createdAt: number | null;
    }
    ```

    ```typescript
    const transactions = useSignal<WalletTransaction[]>([]);
    const txLoading = useSignal(true);
    ```

    트랜잭션을 세션 토큰 없이 조회할 수 없으므로, masterAuth 기반 API `GET /v1/transactions?limit=10`은 없다. 그러나 관리자가 masterAuth로 조회 가능한 `GET /v1/wallets` 엔드포인트 패턴을 확인할 것.

    실제로 Admin은 masterAuth를 사용하므로 직접 `/v1/transactions` 호출이 불가 (sessionAuth 필요). 대신 ADMIN-03의 요구사항을 "정책 목록에서 network 컬럼 표시"로 해석한다 -- 이는 Task 2에서 policies.tsx에 network 컬럼을 추가하는 것으로 충족된다.

    **따라서 F 섹션은 건너뛴다.** Admin에서 트랜잭션을 조회하려면 별도의 masterAuth 기반 트랜잭션 엔드포인트가 필요하며, 이는 현재 Phase 113 범위를 넘어선다. 정책 테이블의 network 컬럼이 ADMIN-03의 실질적 대안이다.
  </action>
  <verify>
    `pnpm --filter @waiaas/admin build` 빌드 성공.
  </verify>
  <done>
    - 월렛 생성 폼에서 environment(testnet/mainnet) 선택 가능
    - 월렛 목록에서 Environment 컬럼 표시
    - 월렛 상세에서 Available Networks + Default Network 변경 UI 동작
    - 빌드 통과
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin UI 정책 ALLOWED_NETWORKS + 테스트 업데이트</name>
  <files>
    packages/admin/src/pages/policies.tsx
    packages/admin/src/__tests__/wallets.test.tsx
    packages/admin/src/__tests__/policies.test.tsx
  </files>
  <action>
    **A. policies.tsx POLICY_TYPES에 ALLOWED_NETWORKS 추가:**

    `POLICY_TYPES` 배열에 추가:
    ```typescript
    { label: 'Allowed Networks', value: 'ALLOWED_NETWORKS' },
    ```

    `DEFAULT_RULES`에 추가:
    ```typescript
    ALLOWED_NETWORKS: { networks: [] },
    ```

    **B. policies.tsx 정책 생성 폼에 network scope 추가:**

    정책 생성 폼에 network 필드 추가 (walletId 아래에):
    ```tsx
    <FormField
      label="Network Scope"
      name="network"
      value={formNetwork.value}
      onChange={(v) => { formNetwork.value = v as string; }}
      placeholder="e.g. polygon-mainnet (leave empty for all networks)"
    />
    ```

    `formNetwork` signal 추가: `const formNetwork = useSignal('');`

    handleCreate에서 body에 network 추가:
    ```typescript
    await apiPost(API.POLICIES, {
      walletId: formWalletId.value || undefined,
      type: formType.value,
      rules: parsedRules,
      priority: formPriority.value,
      enabled: formEnabled.value,
      network: formNetwork.value || undefined,
    });
    ```

    폼 리셋 시 `formNetwork.value = '';` 추가.

    **C. policies.tsx 정책 테이블에 network 컬럼 추가:**

    `Policy` 인터페이스에 `network: string | null;` 추가.

    `policyColumns`에 network 컬럼 추가 (walletId와 rules 사이에):
    ```typescript
    {
      key: 'network',
      header: 'Network',
      render: (p) => p.network ?? 'All',
    },
    ```

    **D. wallets.test.tsx 업데이트:**

    mockWallets에 `environment` 필드 추가:
    ```typescript
    { id: 'wallet-1', name: 'bot-alpha', chain: 'solana', network: 'devnet', environment: 'testnet', publicKey: 'abc', status: 'ACTIVE', createdAt: ... }
    ```

    기존 "renders wallet list" 테스트에서 Network 확인을 Environment 확인으로 변경. "Environment" 헤더가 존재하는지 확인.

    월렛 생성 테스트에서 `network` 대신 `environment` 파라미터 확인:
    ```typescript
    expect(apiPost).toHaveBeenCalledWith('/v1/wallets', expect.objectContaining({
      name: expect.any(String),
      chain: 'solana',
      environment: 'testnet',
    }));
    ```

    **E. policies.test.tsx 업데이트:**

    mockPolicies에 `network: null` 필드 추가.

    ALLOWED_NETWORKS 타입이 POLICY_TYPES에 포함되어 있는지 확인하는 테스트 추가 (선택 가능 확인):
    ```typescript
    it('shows ALLOWED_NETWORKS in policy type options', async () => {
      // Render page, open form, check that Allowed Networks option exists
    });
    ```

    기존 테스트가 `network` 컬럼 추가로 깨지지 않도록 mockData에 network 필드 추가.
  </action>
  <verify>
    `pnpm --filter @waiaas/admin build && pnpm --filter @waiaas/admin test` 빌드 및 테스트 통과 확인.
  </verify>
  <done>
    - ALLOWED_NETWORKS 정책 타입이 드롭다운에 표시됨
    - 정책 생성 시 Network Scope 입력 가능
    - 정책 목록에 Network 컬럼 표시
    - 월렛 테스트가 environment 기반으로 업데이트됨
    - 전체 Admin 빌드 및 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin build` Admin UI 빌드 성공
2. `pnpm --filter @waiaas/admin test` Admin UI 테스트 통과
3. 월렛 생성 폼에서 environment 선택 UI 확인
4. 정책 생성 폼에서 ALLOWED_NETWORKS 타입 + network scope 확인
</verification>

<success_criteria>
- Admin UI 월렛 생성이 environment(testnet/mainnet) 기반으로 동작
- 월렛 상세에서 Available Networks + 기본 네트워크 변경 가능
- 정책 생성에서 ALLOWED_NETWORKS 타입 + network scope 선택 가능
- 전체 Admin 빌드 및 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/113-mcp-sdk-admin-ui/113-03-SUMMARY.md`
</output>
