---
phase: 113-mcp-sdk-admin-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/tools/send-token.ts
  - packages/mcp/src/tools/get-balance.ts
  - packages/mcp/src/tools/get-assets.ts
  - packages/mcp/src/tools/call-contract.ts
  - packages/mcp/src/tools/approve-token.ts
  - packages/mcp/src/tools/send-batch.ts
  - packages/mcp/src/tools/get-wallet-info.ts
  - packages/mcp/src/server.ts
  - packages/mcp/src/__tests__/tools.test.ts
autonomous: true

must_haves:
  truths:
    - "MCP send_token 도구에 network 파라미터를 지정하면 REST API에 network 필드가 전달된다"
    - "MCP get_balance/get_assets 도구에 network 파라미터를 지정하면 ?network=X 쿼리로 요청된다"
    - "MCP call_contract/approve_token/send_batch 도구에 network 파라미터를 지정하면 body에 network 필드가 포함된다"
    - "MCP get_wallet_info 도구가 월렛 정보와 사용 가능 네트워크 목록을 반환한다"
    - "network 미지정 시 기존과 동일하게 동작한다 (하위호환)"
  artifacts:
    - path: "packages/mcp/src/tools/get-wallet-info.ts"
      provides: "get_wallet_info 도구 (주소 + 네트워크 목록)"
    - path: "packages/mcp/src/tools/send-token.ts"
      provides: "network optional 파라미터"
    - path: "packages/mcp/src/tools/get-balance.ts"
      provides: "network optional 파라미터 -> query string"
  key_links:
    - from: "packages/mcp/src/tools/send-token.ts"
      to: "POST /v1/transactions/send"
      via: "apiClient.post body.network"
      pattern: "body\\.network|network.*args"
    - from: "packages/mcp/src/tools/get-balance.ts"
      to: "GET /v1/wallet/balance?network=X"
      via: "query parameter"
      pattern: "network.*query|\\?network="
    - from: "packages/mcp/src/tools/get-wallet-info.ts"
      to: "GET /v1/wallet/address + GET /v1/wallets/:id/networks"
      via: "2 sequential API calls"
      pattern: "wallet/address.*networks"
---

<objective>
MCP 6개 트랜잭션/쿼리 도구에 network 선택 파라미터를 추가하고, get_wallet_info 신규 도구를 생성한다.

Purpose: AI 에이전트가 MCP를 통해 특정 네트워크에서 트랜잭션/잔액 조회를 실행할 수 있도록 하여, 멀티체인 환경 모델의 인터페이스 확장을 완성한다.
Output: 7개 MCP 도구 (6개 수정 + 1개 신규) + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/112-rest-api-network-extension/112-01-SUMMARY.md
@.planning/phases/112-rest-api-network-extension/112-02-SUMMARY.md

@packages/mcp/src/tools/send-token.ts
@packages/mcp/src/tools/get-balance.ts
@packages/mcp/src/tools/get-assets.ts
@packages/mcp/src/tools/call-contract.ts
@packages/mcp/src/tools/approve-token.ts
@packages/mcp/src/tools/send-batch.ts
@packages/mcp/src/server.ts
@packages/mcp/src/api-client.ts
@packages/mcp/src/__tests__/tools.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP 6개 도구 network 파라미터 추가 + get_wallet_info 신규 도구</name>
  <files>
    packages/mcp/src/tools/send-token.ts
    packages/mcp/src/tools/get-balance.ts
    packages/mcp/src/tools/get-assets.ts
    packages/mcp/src/tools/call-contract.ts
    packages/mcp/src/tools/approve-token.ts
    packages/mcp/src/tools/send-batch.ts
    packages/mcp/src/tools/get-wallet-info.ts
    packages/mcp/src/server.ts
  </files>
  <action>
    **A. POST 계열 도구 4개에 network optional 파라미터 추가:**

    `send-token.ts`: z.object 스키마에 `network: z.string().optional().describe('Target network (e.g., polygon-mainnet). Defaults to wallet default network.')` 추가. handler에서 `if (args.network !== undefined) body.network = args.network;` 추가.

    `call-contract.ts`: 동일하게 z.object 스키마에 network optional 추가. handler에서 `if (args.network !== undefined) body.network = args.network;` 추가.

    `approve-token.ts`: 동일 패턴. z.object 스키마에 network optional 추가. handler body에 `if (args.network !== undefined) body.network = args.network;` 추가.

    `send-batch.ts`: 동일 패턴. z.object 스키마에 network optional 추가. handler body에 `if (args.network !== undefined) body.network = args.network;` 추가.

    **B. GET 계열 도구 2개에 network query 파라미터 추가:**

    `get-balance.ts`: 현재는 파라미터 없이 `async () =>` 형태. z.object 스키마를 추가하여 `{ network: z.string().optional().describe('Query balance for specific network. Defaults to wallet default network.') }` 정의. handler를 `async (args) =>` 로 변경. `const qs = args.network ? '?network=' + encodeURIComponent(args.network) : '';` 후 `apiClient.get('/v1/wallet/balance' + qs)` 호출.

    `get-assets.ts`: 동일 패턴. z.object 스키마 추가, network optional. handler에서 query string 생성 후 `/v1/wallet/assets` + qs로 호출.

    **C. get_wallet_info 신규 도구 생성:**

    `get-wallet-info.ts` 신규 생성:
    - `registerGetWalletInfo(server, apiClient, walletContext)` 함수
    - 파라미터 없음 (no input schema, parameterless like get_balance 기존 형태)
    - handler에서:
      1. `const addressResult = await apiClient.get('/v1/wallet/address');` 호출
      2. addressResult가 ok가 아니면 `return toToolResult(addressResult);`
      3. addressResult.data에서 walletId 추출
      4. `const networksResult = await apiClient.get('/v1/wallets/' + walletId + '/networks');` 호출
      5. 두 결과를 합쳐서 `{ ...addressResult.data, networks: networksResult.ok ? networksResult.data.networks : [] }` 형태로 반환
      6. `return { content: [{ type: 'text', text: JSON.stringify(combined) }] };`
    - description: `withWalletPrefix('Get wallet info including chain, address, environment, and available networks.', walletContext?.walletName)`

    **D. server.ts에 get_wallet_info 등록:**

    `import { registerGetWalletInfo } from './tools/get-wallet-info.js';` 추가.
    `registerGetWalletInfo(server, apiClient, walletContext);` 를 기존 10개 도구 등록 후에 추가.
    주석을 `// Register 11 tools`로 변경.
  </action>
  <verify>
    `pnpm --filter @waiaas/mcp build` 빌드 성공 확인.
  </verify>
  <done>
    - send_token, call_contract, approve_token, send_batch에 network optional 파라미터가 존재하고, 지정 시 body에 포함됨
    - get_balance, get_assets에 network optional 파라미터가 존재하고, 지정 시 query string으로 전달됨
    - get_wallet_info 도구가 등록되어 있고, 주소 + 네트워크 목록을 반환함
    - 빌드 통과
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP 도구 테스트 업데이트</name>
  <files>
    packages/mcp/src/__tests__/tools.test.ts
  </files>
  <action>
    기존 tools.test.ts에 network 파라미터 관련 테스트를 추가한다.

    **A. send_token 테스트 추가 (기존 describe 블록 내):**
    ```
    it('includes network in body when specified', async () => {
      const apiClient = createMockApiClient(new Map());
      const handler = getToolHandler(registerSendToken, apiClient);
      await handler({ to: 'addr', amount: '100', network: 'polygon-mainnet' });
      expect(apiClient.post).toHaveBeenCalledWith('/v1/transactions/send', {
        to: 'addr', amount: '100', network: 'polygon-mainnet',
      });
    });
    ```

    **B. get_balance 테스트 추가:**
    ```
    it('appends network query parameter when specified', async () => {
      const apiClient = createMockApiClient(new Map());
      const handler = getToolHandler(registerGetBalance, apiClient);
      await handler({ network: 'ethereum-sepolia' });
      expect(apiClient.get).toHaveBeenCalledWith('/v1/wallet/balance?network=ethereum-sepolia');
    });

    it('calls without query when network not specified', async () => {
      // 기존 테스트와 같이 빈 args로 호출
      const apiClient = createMockApiClient(new Map());
      const handler = getToolHandler(registerGetBalance, apiClient);
      await handler({});
      expect(apiClient.get).toHaveBeenCalledWith('/v1/wallet/balance');
    });
    ```

    **C. get_assets 테스트 추가:**
    ```
    it('appends network query parameter when specified', async () => {
      const apiClient = createMockApiClient(new Map());
      const handler = getToolHandler(registerGetAssets, apiClient);
      await handler({ network: 'polygon-mainnet' });
      expect(apiClient.get).toHaveBeenCalledWith('/v1/wallet/assets?network=polygon-mainnet');
    });
    ```

    **D. call_contract 테스트 추가:**
    ```
    it('includes network in body when specified', async () => {
      const apiClient = createMockApiClient(new Map());
      const handler = getToolHandler(registerCallContract, apiClient);
      await handler({ to: '0xAddr', network: 'arbitrum-mainnet' });
      expect(apiClient.post).toHaveBeenCalledWith('/v1/transactions/send', {
        type: 'CONTRACT_CALL', to: '0xAddr', network: 'arbitrum-mainnet',
      });
    });
    ```

    **E. approve_token 테스트 추가:**
    ```
    it('includes network in body when specified', async () => {
      const apiClient = createMockApiClient(new Map());
      const handler = getToolHandler(registerApproveToken, apiClient);
      await handler({
        spender: '0xSpender', token: { address: '0xToken', decimals: 18, symbol: 'TK' },
        amount: '100', network: 'base-mainnet',
      });
      expect(apiClient.post).toHaveBeenCalledWith('/v1/transactions/send', {
        type: 'APPROVE', spender: '0xSpender',
        token: { address: '0xToken', decimals: 18, symbol: 'TK' },
        amount: '100', network: 'base-mainnet',
      });
    });
    ```

    **F. send_batch 테스트 추가:**
    ```
    it('includes network in body when specified', async () => {
      const apiClient = createMockApiClient(new Map());
      const handler = getToolHandler(registerSendBatch, apiClient);
      await handler({
        instructions: [{ to: 'a', amount: '1' }, { to: 'b', amount: '2' }],
        network: 'devnet',
      });
      expect(apiClient.post).toHaveBeenCalledWith('/v1/transactions/send', {
        type: 'BATCH',
        instructions: [{ to: 'a', amount: '1' }, { to: 'b', amount: '2' }],
        network: 'devnet',
      });
    });
    ```

    **G. get_wallet_info 테스트 신규 describe 블록:**
    ```
    import { registerGetWalletInfo } from '../tools/get-wallet-info.js';

    describe('get_wallet_info tool', () => {
      it('returns combined wallet info with networks', async () => {
        const responses = new Map<string, ApiResult<unknown>>([
          ['GET:/v1/wallet/address', { ok: true, data: { walletId: 'w1', chain: 'ethereum', network: 'ethereum-sepolia', address: '0xabc' } }],
          ['GET:/v1/wallets/w1/networks', { ok: true, data: { networks: [{ network: 'ethereum-sepolia', name: 'Sepolia', isDefault: true }] } }],
        ]);
        const apiClient = createMockApiClient(responses);
        const handler = getToolHandler(registerGetWalletInfo, apiClient);
        const result = await handler({}) as { content: Array<{ text: string }> };
        const parsed = JSON.parse(result.content[0]!.text);
        expect(parsed.walletId).toBe('w1');
        expect(parsed.networks).toHaveLength(1);
        expect(parsed.networks[0].isDefault).toBe(true);
      });

      it('returns address info with empty networks on networks API failure', async () => {
        const responses = new Map<string, ApiResult<unknown>>([
          ['GET:/v1/wallet/address', { ok: true, data: { walletId: 'w1', chain: 'solana', network: 'devnet', address: 'abc' } }],
          ['GET:/v1/wallets/w1/networks', { ok: false, error: { code: 'NOT_FOUND', message: 'Not found', retryable: false } }],
        ]);
        const apiClient = createMockApiClient(responses);
        const handler = getToolHandler(registerGetWalletInfo, apiClient);
        const result = await handler({}) as { content: Array<{ text: string }> };
        const parsed = JSON.parse(result.content[0]!.text);
        expect(parsed.walletId).toBe('w1');
        expect(parsed.networks).toEqual([]);
      });

      it('returns error when address API fails', async () => {
        const responses = new Map<string, ApiResult<unknown>>([
          ['GET:/v1/wallet/address', { ok: false, expired: true, message: 'Token expired' }],
        ]);
        const apiClient = createMockApiClient(responses);
        const handler = getToolHandler(registerGetWalletInfo, apiClient);
        const result = await handler({}) as { content: Array<{ text: string }>; isError?: boolean };
        // Session expired should NOT have isError (H-04)
        expect(result.isError).toBeUndefined();
      });
    });
    ```

    **H. tool registration 테스트 업데이트:**
    기존 `tool registration with McpServer` describe에 get_wallet_info 등록 테스트 추가:
    ```
    it('registers get_wallet_info tool without error', () => {
      expect(() => registerGetWalletInfo(server, apiClient)).not.toThrow();
    });
    ```
  </action>
  <verify>
    `pnpm --filter @waiaas/mcp test` 전체 테스트 통과 확인.
  </verify>
  <done>
    - 6개 기존 도구의 network 파라미터 테스트가 추가됨
    - get_wallet_info 도구의 3개 테스트가 통과함
    - 전체 MCP 테스트 회귀 없음
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/mcp build` 빌드 성공
2. `pnpm --filter @waiaas/mcp test` 전체 테스트 통과
3. 각 도구에 network optional 파라미터 존재 확인
4. get_wallet_info 도구가 server.ts에 등록 확인
</verification>

<success_criteria>
- MCP 7개 도구(send_token, get_balance, get_assets, call_contract, approve_token, send_batch + get_wallet_info)가 network 파라미터를 지원
- network 미지정 시 기존 동작과 동일 (하위호환)
- 전체 MCP 빌드 및 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/113-mcp-sdk-admin-ui/113-01-SUMMARY.md`
</output>
