---
phase: 124-notification-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/notifications/notification-service.ts
  - packages/daemon/src/notifications/channels/slack.ts
  - packages/daemon/src/notifications/index.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/infrastructure/settings/settings-crypto.ts
  - packages/daemon/src/infrastructure/settings/hot-reload.ts
  - packages/daemon/src/__tests__/migration-chain.test.ts
  - packages/daemon/src/__tests__/notification-channels.test.ts
  - packages/daemon/src/__tests__/notification-service.test.ts
  - packages/daemon/src/__tests__/admin-notification-api.test.ts
  - skills/admin.skill.md
autonomous: true

must_haves:
  truths:
    - "알림 Delivery Log에서 행을 클릭하면 실제 발송된 메시지 원문을 확인할 수 있다"
    - "notification_logs 테이블에 message 컬럼이 존재하고 발송 시 저장된다"
    - "config.toml에 slack_webhook_url 설정 시 Channel Status에 Slack이 표시된다"
    - "Slack Incoming Webhook으로 알림이 발송된다"
    - "admin.skill.md에 Slack 알림 채널 정보가 반영된다"
    - "DB 마이그레이션 v10이 v9 -> v10 체인에서 정상 적용된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v10 마이그레이션: notification_logs ADD COLUMN message TEXT"
      contains: "version: 10"
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "notification_logs.message 컬럼 정의"
      contains: "message.*text"
    - path: "packages/daemon/src/notifications/channels/slack.ts"
      provides: "SlackChannel 구현 (INotificationChannel)"
      exports: ["SlackChannel"]
    - path: "packages/daemon/src/notifications/notification-service.ts"
      provides: "logDelivery에 message 파라미터 추가"
      contains: "message.*payload.message"
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "notification status에 slack 추가 + log 응답에 message 포함"
      contains: "slack"
    - path: "skills/admin.skill.md"
      provides: "Slack 알림 채널 정보"
      contains: "slack"
  key_links:
    - from: "packages/daemon/src/notifications/notification-service.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "logDelivery inserts message into notification_logs"
      pattern: "message.*payload\\.message"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/notifications/channels/slack.ts"
      via: "slack_webhook_url config check + SlackChannel initialization"
      pattern: "slack_webhook_url"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "v10 migration adds message column matching schema"
      pattern: "ADD COLUMN message"
---

<objective>
DB 마이그레이션 v10 (message 컬럼) + 메시지 저장/조회 + Slack 채널 + 스킬 파일 업데이트 (NOTF-03, NOTF-04, NOTF-05, NOTF-06, SKIL-02)

Purpose: 알림 로그에 실제 발송 메시지가 저장되어 디버깅 가능하고, Slack 채널이 추가되어 알림 생태계가 확장된다
Output: v10 마이그레이션, SlackChannel, 메시지 저장 로직, API/UI 응답 확장, 스킬 파일
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@objectives/issues/v1.4.6-025-notification-log-message-content.md
@objectives/issues/v1.4.6-030-slack-notification-channel.md
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/notifications/notification-service.ts
@packages/daemon/src/notifications/channels/discord.ts
@packages/daemon/src/notifications/channels/telegram.ts
@packages/daemon/src/notifications/index.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/infrastructure/settings/settings-crypto.ts
@packages/daemon/src/infrastructure/settings/hot-reload.ts
@packages/core/src/enums/notification.ts
@skills/admin.skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB 마이그레이션 v10 + 스키마 + 메시지 저장 + Slack 채널</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/notifications/notification-service.ts
    packages/daemon/src/notifications/channels/slack.ts
    packages/daemon/src/notifications/index.ts
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/infrastructure/settings/settings-crypto.ts
    packages/daemon/src/infrastructure/settings/hot-reload.ts
    skills/admin.skill.md
  </files>
  <action>
**A. DB 마이그레이션 v10 (NOTF-04):**

1. `migrate.ts` — LATEST_SCHEMA_VERSION을 9 -> 10으로 변경

2. `migrate.ts` — MIGRATIONS 배열에 v10 추가:
```typescript
MIGRATIONS.push({
  version: 10,
  description: 'Add message column to notification_logs',
  up: (sqlite) => {
    sqlite.exec("ALTER TABLE notification_logs ADD COLUMN message TEXT");
  },
});
```
`managesOwnTransaction` 불필요 — ALTER TABLE ADD COLUMN은 단순 작업. 기본 트랜잭션 관리 사용.

3. `migrate.ts` — getCreateTableStatements()에서 notification_logs 테이블 DDL에 `message TEXT` 컬럼 추가 (created_at 뒤, 닫는 괄호 앞):
```sql
  error TEXT,
  message TEXT,
  created_at INTEGER NOT NULL
```

4. `schema.ts` — notificationLogs 테이블에 `message` 컬럼 추가:
```typescript
message: text('message'), // nullable - null for pre-v10 logs
```
`error` 컬럼 다음, `createdAt` 컬럼 앞에 추가.

**B. 메시지 저장 로직 (NOTF-03):**

5. `notification-service.ts` — `logDelivery` 메서드에 `message` 파라미터 추가:
```typescript
private logDelivery(
  channelName: string,
  payload: NotificationPayload,
  status: 'sent' | 'failed',
  error?: string,
): void {
```
insert values에 `message: payload.message` 추가. payload.message는 이미 `notify()` 메서드에서 `${title}\n${body}` 형태로 생성됨.

6. `admin.ts` — GET /admin/notifications/log 응답에 `message` 필드 추가:
- 718행 부근 `logs` 매핑에 `message: row.message ?? null` 추가

7. `openapi-schemas.ts` — `NotificationLogEntrySchema`에 `message: z.string().nullable()` 필드 추가 (`error` 다음):
```typescript
message: z.string().nullable(),
```

**C. Slack 채널 (NOTF-05, NOTF-06):**

8. `channels/slack.ts` — 신규 파일 생성. 이슈 030의 코드 설계를 기반으로 `INotificationChannel` 구현:
- `readonly name = 'slack'`
- `initialize(config)`: `slack_webhook_url` 필수 검증
- `send(payload)`: Slack Incoming Webhook에 `attachments` 형식으로 POST. color 매핑: KILL_SWITCH/AUTO_STOP/SUSPENDED -> '#ff0000', FAILED/VIOLATION/EXPIRED -> '#ff8c00', CONFIRMED/RECOVERED/VERIFIED -> '#00ff00', 기타 -> '#0099ff'
- `fetch(webhookUrl, { method: 'POST', body: JSON.stringify({ attachments: [...] }) })` 패턴 — discord.ts 참조

9. `notifications/index.ts` — SlackChannel export 추가:
```typescript
export { SlackChannel } from './channels/slack.js';
```

10. `loader.ts` — notifications 스키마에 `slack_webhook_url` 추가:
```typescript
slack_webhook_url: z.string().default(''),
```
`ntfy_topic` 다음에 추가.

11. `daemon.ts` — Step 4d 채널 초기화에 Slack 추가 (ntfy 블록 다음):
```typescript
if (notifConfig.slack_webhook_url) {
  const slack = new SlackChannel();
  await slack.initialize({ slack_webhook_url: notifConfig.slack_webhook_url });
  this.notificationService.addChannel(slack);
}
```
상단 import에 `SlackChannel` 추가.

12. `admin.ts` — GET /admin/notifications/status에 slack 채널 추가 (ntfy 다음):
```typescript
{
  name: 'slack',
  enabled: !!(notifConfig?.slack_webhook_url && channelNames.includes('slack')),
},
```

13. `setting-keys.ts` — SETTING_DEFINITIONS에 slack_webhook_url 추가:
```typescript
{ key: 'notifications.slack_webhook_url', category: 'notifications', configPath: 'notifications.slack_webhook_url', defaultValue: '', isCredential: true },
```
`notifications.ntfy_topic` 다음에 추가.

14. `settings-crypto.ts` — CREDENTIAL_KEYS Set에 `'notifications.slack_webhook_url'` 추가 (있는 경우). CREDENTIAL_KEYS가 setting-keys.ts의 isCredential: true에서 파생되는지 확인하고, 별도 하드코딩 Set이면 추가.

15. `hot-reload.ts` — NOTIFICATION_RELOAD_KEYS 배열에 `'notifications.slack_webhook_url'` 추가. rebuildNotificationChannels() 내부에 Slack 채널 재생성 추가:
```typescript
// Slack
const slackUrl = ss.get('notifications.slack_webhook_url');
if (slackUrl) {
  const slack = new SlackChannel();
  await slack.initialize({ slack_webhook_url: slackUrl });
  newChannels.push(slack);
}
```
import에 `SlackChannel` 추가.

**D. admin.skill.md 업데이트 (SKIL-02):**

16. `skills/admin.skill.md` 수정:
- 버전: 1.4.4 -> 1.4.8
- Section 3 Notification Management:
  - channel status 예시에 `{"name": "slack", "enabled": false}` 추가
  - POST test의 channel 파라미터 설명에 "slack" 추가: `"telegram", "discord", "ntfy", or "slack"`
  - GET log 응답 예시에 `"message": "[WAIaaS] Transaction confirmed: 0.01 ETH..."` 필드 추가
- Section 4 Settings Management:
  - GET settings 응답의 notifications 카테고리에 `"notifications.slack_webhook_url": false` 추가
  - All valid setting keys에 `notifications.slack_webhook_url` 추가: `-- Slack webhook URL (credential, encrypted at rest)`
  - Categories 테이블의 notifications Keys에 `slack_*` 추가
- Section 5 Common Workflows에 "Set up Slack notifications" 워크플로 추가 (Telegram과 동일 패턴)
  </action>
  <verify>
`pnpm --filter @waiaas/daemon build` 성공 (타입 에러 없음)
  </verify>
  <done>
- v10 마이그레이션이 migrate.ts에 등록되고 LATEST_SCHEMA_VERSION=10
- schema.ts의 notificationLogs에 message 컬럼이 존재
- notification-service.ts의 logDelivery가 payload.message를 DB에 저장
- SlackChannel이 INotificationChannel을 구현하고 Incoming Webhook으로 전송
- daemon.ts + hot-reload.ts에서 slack_webhook_url 설정 시 SlackChannel 등록
- admin API status에 slack 채널 포함, log 응답에 message 필드 포함
- admin.skill.md에 Slack 채널 정보 반영
  </done>
</task>

<task type="auto">
  <name>Task 2: 테스트 업데이트 (마이그레이션 + Slack + 메시지 저장)</name>
  <files>
    packages/daemon/src/__tests__/migration-chain.test.ts
    packages/daemon/src/__tests__/notification-channels.test.ts
    packages/daemon/src/__tests__/notification-service.test.ts
    packages/daemon/src/__tests__/admin-notification-api.test.ts
  </files>
  <action>
**1. migration-chain.test.ts:**

- LATEST_SCHEMA_VERSION 참조가 10으로 업데이트됨 (import에서 자동)
- 기존 T-2/T-6 스키마 동등성 테스트가 notification_logs.message 컬럼을 포함하여 검증
- 신규 T-12: v9 DB -> v10 마이그레이션 성공 테스트:
  - v9 스키마 DB 생성 (createV1SchemaDatabase() -> pushSchema 후 기존 마이그레이션 적용, 또는 직접 v9 DDL로 notification_logs 생성)
  - schema_version에 v1~v9 기록
  - pushSchema() 호출
  - notification_logs 테이블에 message 컬럼이 존재하는지 `PRAGMA table_info(notification_logs)` 확인
  - 기존 레코드의 message가 NULL인지 확인
- 신규 T-13: 기존 notification_logs 데이터가 v10 마이그레이션 후 보존되는지 테스트:
  - v9 DB에 notification_logs 레코드 삽입 (id, event_type, channel, status, created_at)
  - pushSchema() 후 레코드가 그대로 존재하고 message=NULL

**2. notification-channels.test.ts:**

- SlackChannel 테스트 섹션 추가 (기존 TelegramChannel, DiscordChannel, NtfyChannel 패턴과 동일):
  - T-1: `slack_webhook_url` 설정 시 초기화 성공
  - T-2: `slack_webhook_url` 미설정 시 에러 throw
  - T-3: send() 호출 시 올바른 Slack attachment 형식 전송 (fetchMock 검증)
  - T-4: 이벤트별 color 매핑 (KILL_SWITCH->'#ff0000', TX_FAILED->'#ff8c00', TX_CONFIRMED->'#00ff00', TX_REQUESTED->'#0099ff')
  - T-5: Webhook HTTP 에러 시 Error throw

**3. notification-service.test.ts:**

- 기존 logDelivery 관련 테스트에서 message 필드 검증 추가:
  - 성공적 전송 후 notification_logs에서 message 컬럼이 payload.message와 일치하는지 확인
  - 실패 전송 후에도 message가 저장되는지 확인

**4. admin-notification-api.test.ts:**

- GET /admin/notifications/status 테스트:
  - 응답의 channels 배열에 slack 채널이 포함되는지 확인 (4개 채널)
- GET /admin/notifications/log 테스트:
  - 응답 로그 항목에 `message` 필드가 포함되는지 확인
  - message가 null인 레코드와 값이 있는 레코드 모두 정상 반환
- 기존 테스트에서 notifConfig에 `slack_webhook_url: ''` 추가 (fullConfig 헬퍼)

주의: settings-service.test.ts의 SETTING_DEFINITIONS count가 변경됨 (기존 pre-existing flaky). slack_webhook_url 1개 추가로 count+1. 이 테스트가 하드코딩된 숫자를 사용하는지 확인하고 업데이트.
  </action>
  <verify>
`pnpm --filter @waiaas/daemon test` 통과 (기존 pre-existing flaky 테스트 제외)
  </verify>
  <done>
- 마이그레이션 체인 테스트가 v1->v10 전체 경로를 검증
- SlackChannel 초기화/전송/에러/색상 테스트 통과
- notification-service에서 message 저장 테스트 통과
- admin API에서 slack 채널 + message 필드 응답 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon build` 성공
2. `pnpm --filter @waiaas/daemon test` 전체 통과 (pre-existing flaky 제외)
3. notification_logs 테이블에 message 컬럼 존재
4. SlackChannel이 notifications/index.ts에서 export됨
5. LATEST_SCHEMA_VERSION === 10
6. admin.skill.md에 slack, message 필드 반영
</verification>

<success_criteria>
- DB 마이그레이션 v10이 notification_logs에 message TEXT 컬럼을 추가한다
- LATEST_SCHEMA_VERSION이 10이다
- 알림 발송 시 payload.message가 notification_logs.message에 저장된다
- GET /admin/notifications/log 응답에 message 필드가 포함된다
- SlackChannel이 INotificationChannel을 구현하고 Incoming Webhook으로 전송한다
- config.toml slack_webhook_url 설정 시 Channel Status에 slack이 표시된다
- hot-reload에서 slack_webhook_url 변경 시 SlackChannel이 재생성된다
- admin.skill.md에 Slack 채널 정보가 반영된다
- 마이그레이션 체인 테스트 + Slack 테스트 + 메시지 저장 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/124-notification-improvements/124-02-SUMMARY.md`
</output>
