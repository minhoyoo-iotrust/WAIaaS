---
phase: 54-policy-engine
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/pipeline/database-policy-engine.ts
  - packages/daemon/src/__tests__/database-policy-engine.test.ts
  - packages/daemon/src/pipeline/index.ts
autonomous: true

must_haves:
  truths:
    - "DatabasePolicyEngine loads policies from DB and evaluates by priority DESC"
    - "SPENDING_LIMIT classifies amounts into INSTANT/NOTIFY/DELAY/APPROVAL 4 tiers"
    - "WHITELIST denies transactions to non-whitelisted addresses"
    - "Agent-specific policies override global policies of the same type"
    - "No policies returns INSTANT passthrough (Phase 7 compatibility)"
  artifacts:
    - path: "packages/daemon/src/pipeline/database-policy-engine.ts"
      provides: "DatabasePolicyEngine class implementing IPolicyEngine"
      exports: ["DatabasePolicyEngine"]
    - path: "packages/daemon/src/__tests__/database-policy-engine.test.ts"
      provides: "TDD tests for policy engine evaluation logic"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "Drizzle query on policies table"
      pattern: "from\\(policies\\)"
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "packages/core/src/interfaces/IPolicyEngine.ts"
      via: "implements IPolicyEngine"
      pattern: "implements IPolicyEngine"
---

<objective>
Implement DatabasePolicyEngine that replaces DefaultPolicyEngine for DB-backed policy evaluation with SPENDING_LIMIT 4-tier classification and WHITELIST address filtering.

Purpose: This is the core policy engine that enables transaction security classification based on configurable rules stored in the policies table. It implements PLCY-01 (DB-backed priority evaluation), PLCY-02 (SPENDING_LIMIT 4-tier), and PLCY-03 (WHITELIST).

Output: Working DatabasePolicyEngine class with comprehensive TDD tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/deliverables/33-time-lock-approval-mechanism.md (sections 2.2, 3.1-3.4 -- PolicyRuleSchema, evaluate algorithm)
@packages/core/src/interfaces/IPolicyEngine.ts (IPolicyEngine interface + PolicyEvaluation type)
@packages/core/src/enums/policy.ts (POLICY_TYPES, POLICY_TIERS SSoT)
@packages/daemon/src/infrastructure/database/schema.ts (policies table schema)
@packages/daemon/src/pipeline/default-policy-engine.ts (v1.1 passthrough to be replaced)
@packages/daemon/src/__tests__/pipeline.test.ts (existing DefaultPolicyEngine tests for reference)
</context>

<feature>
  <name>DatabasePolicyEngine with SPENDING_LIMIT + WHITELIST evaluation</name>
  <behavior>
    DatabasePolicyEngine implements IPolicyEngine.evaluate(agentId, transaction) -> PolicyEvaluation.

    **Core algorithm (v1.2 scope -- SPENDING_LIMIT + WHITELIST only, other types deferred to v1.4+):**

    1. Load enabled policies WHERE (agent_id = agentId OR agent_id IS NULL) AND enabled = 1, ORDER BY priority DESC
    2. If no policies found, return { allowed: true, tier: 'INSTANT' } (Phase 7 compat)
    3. Resolve overrides: agent-specific policies override global policies of same type
    4. Evaluate WHITELIST: if whitelist exists and toAddress not in allowed_addresses -> return { allowed: false, reason }
    5. Evaluate SPENDING_LIMIT: compare BigInt(amount) against instant_max/notify_max/delay_max thresholds
       - amount <= instant_max -> INSTANT
       - amount <= notify_max -> NOTIFY
       - amount <= delay_max -> DELAY (with delaySeconds)
       - amount > delay_max -> APPROVAL

    **Test cases (input -> expected output):**

    SPENDING_LIMIT tests:
    - No policies at all -> { allowed: true, tier: 'INSTANT' }
    - Amount 500M lamports (0.5 SOL) with instant_max=1B -> INSTANT
    - Amount 5B lamports (5 SOL) with instant_max=1B, notify_max=10B -> NOTIFY
    - Amount 30B lamports (30 SOL) with delay_max=50B -> DELAY with delaySeconds
    - Amount 100B lamports (100 SOL) with delay_max=50B -> APPROVAL
    - Agent-specific policy overrides global policy of same type
    - Disabled policy is ignored (enabled=false)

    WHITELIST tests:
    - No whitelist policy -> allowed (passthrough)
    - Empty allowed_addresses -> allowed (whitelist inactive)
    - toAddress in whitelist -> allowed
    - toAddress NOT in whitelist -> { allowed: false }
    - Case-insensitive comparison (EVM address compat)

    Priority tests:
    - Higher priority policy evaluated first
    - Agent-specific SPENDING_LIMIT overrides global SPENDING_LIMIT

  </behavior>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Implement DatabasePolicyEngine with TDD tests</name>
  <files>
    packages/daemon/src/pipeline/database-policy-engine.ts
    packages/daemon/src/__tests__/database-policy-engine.test.ts
    packages/daemon/src/pipeline/index.ts
  </files>
  <action>
    Create DatabasePolicyEngine class in packages/daemon/src/pipeline/database-policy-engine.ts:
    - Constructor takes Drizzle DB instance (BetterSQLite3Database)
    - evaluate() method queries policies table with Drizzle ORM (not raw SQL for v1.2 -- raw SQL reserved for TOCTOU in plan 54-02)
    - Private methods: resolveOverrides(), evaluateWhitelist(), evaluateSpendingLimit()
    - All amounts compared as BigInt (string -> BigInt conversion)
    - WHITELIST: case-insensitive address comparison via toLowerCase()
    - Return PolicyEvaluation type from @waiaas/core (tier, allowed, reason, delaySeconds)

    Tests use in-memory SQLite + Drizzle (same pattern as existing pipeline.test.ts):
    - beforeEach: create fresh DB, push schema, seed test policies
    - Each test inserts specific policies and calls evaluate()
    - Follow RED-GREEN-REFACTOR: write failing tests first, then implement to pass

    Update pipeline/index.ts barrel to export DatabasePolicyEngine.
  </action>
  <verify>
    ```bash
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run database-policy-engine
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm typecheck
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run
    ```
  </verify>
  <done>
    DatabasePolicyEngine implements IPolicyEngine, 11+ TDD tests pass covering SPENDING_LIMIT 4-tier + WHITELIST + priority + overrides, no policies returns INSTANT passthrough, agent-specific overrides global, TypeScript compiles clean, all existing daemon tests pass.
  </done>
</task>

</tasks>

<verification>
```bash
# Run DatabasePolicyEngine tests
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run database-policy-engine

# Typecheck
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm typecheck

# All daemon tests still pass
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run
```
</verification>

<success_criteria>
- DatabasePolicyEngine class implements IPolicyEngine interface
- 11+ TDD tests pass covering SPENDING_LIMIT 4-tier + WHITELIST + priority + overrides
- No policies -> INSTANT passthrough (backward compat)
- Agent-specific policies correctly override global policies of same type
- TypeScript compiles clean
- All existing daemon tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/54-policy-engine/54-01-SUMMARY.md`
</output>
