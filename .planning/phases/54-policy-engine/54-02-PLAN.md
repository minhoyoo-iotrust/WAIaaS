---
phase: 54-policy-engine
plan: 02
type: tdd
wave: 2
depends_on: ["54-01"]
files_modified:
  - packages/daemon/src/api/routes/policies.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/api-policies.test.ts
  - packages/daemon/src/pipeline/database-policy-engine.ts
  - packages/core/src/schemas/policy.schema.ts
autonomous: true

must_haves:
  truths:
    - "masterAuth-protected POST /v1/policies creates a policy with validated rules JSON"
    - "GET /v1/policies returns enabled policies with optional agentId filter"
    - "PUT /v1/policies/:id updates an existing policy's rules/priority/enabled"
    - "DELETE /v1/policies/:id removes a policy"
    - "TOCTOU prevention: BEGIN IMMEDIATE + reserved amount during policy evaluation serializes concurrent requests"
  artifacts:
    - path: "packages/daemon/src/api/routes/policies.ts"
      provides: "Policy CRUD route factory (policyRoutes)"
      exports: ["policyRoutes"]
    - path: "packages/daemon/src/__tests__/api-policies.test.ts"
      provides: "API tests for policy CRUD endpoints"
      min_lines: 80
    - path: "packages/core/src/schemas/policy.schema.ts"
      provides: "Updated CreatePolicyRequestSchema with rules validation"
      exports: ["CreatePolicyRequestSchema", "UpdatePolicyRequestSchema"]
  key_links:
    - from: "packages/daemon/src/api/routes/policies.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "Drizzle CRUD on policies table"
      pattern: "from\\(policies\\)"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/policies.ts"
      via: "policyRoutes registration under /v1 with masterAuth"
      pattern: "policyRoutes"
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "better-sqlite3 raw SQL"
      via: "BEGIN IMMEDIATE for evaluateAndReserve"
      pattern: "transaction.*immediate"
---

<objective>
Implement Policy CRUD API endpoints (masterAuth-protected) and add TOCTOU prevention via BEGIN IMMEDIATE + reserved_amount pattern in DatabasePolicyEngine.

Purpose: Administrators need to manage policy rules via REST API (PLCY-04), and concurrent transaction evaluations must not bypass spending limits (PLCY-05). This completes the policy engine's operational interface.

Output: 4 CRUD endpoints under /v1/policies + TOCTOU-safe evaluateAndReserve method.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-policy-engine/54-01-SUMMARY.md
@.planning/deliverables/33-time-lock-approval-mechanism.md (section 5 -- TOCTOU prevention pattern)
@packages/daemon/src/api/routes/sessions.ts (reference for route factory pattern + masterAuth)
@packages/daemon/src/api/server.ts (createApp pattern for registering new routes + masterAuth)
@packages/core/src/schemas/policy.schema.ts (existing PolicySchema)
@packages/core/src/enums/policy.ts (POLICY_TYPES, POLICY_TIERS)
</context>

<feature>
  <name>Policy CRUD API + TOCTOU Prevention</name>
  <files>
    packages/daemon/src/api/routes/policies.ts
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/__tests__/api-policies.test.ts
    packages/daemon/src/pipeline/database-policy-engine.ts
    packages/core/src/schemas/policy.schema.ts
  </files>
  <behavior>
    **Policy CRUD API (all masterAuth-protected):**

    POST /v1/policies:
    - Body: { agentId?: string, type: PolicyType, rules: object, priority?: number, enabled?: boolean }
    - Validates type against POLICY_TYPES enum
    - Validates rules JSON structure:
      - SPENDING_LIMIT: { instant_max: string, notify_max: string, delay_max: string, delay_seconds?: number, approval_timeout?: number }
      - WHITELIST: { allowed_addresses: string[] }
      - Other types: accepts any object (future v1.4+ validation)
    - If agentId provided, verify agent exists
    - Returns 201 with created policy

    GET /v1/policies:
    - Optional query: ?agentId=xxx (filter by agent, includes global)
    - Returns array of policies, ordered by priority DESC
    - Includes both agent-specific and global (agentId=null) policies

    PUT /v1/policies/:id:
    - Body: { rules?: object, priority?: number, enabled?: boolean }
    - Validates rules if provided (same validation as POST)
    - Returns 200 with updated policy
    - 404 if policy not found

    DELETE /v1/policies/:id:
    - Removes policy from DB
    - Returns 200 with { id, deleted: true }
    - 404 if policy not found

    **TOCTOU Prevention (evaluateAndReserve method):**

    DatabasePolicyEngine gets a new method evaluateAndReserve() that wraps evaluate() with BEGIN IMMEDIATE:
    - Constructor also accepts raw better-sqlite3 Database instance (alongside Drizzle)
    - evaluateAndReserve(agentId, transaction, txId):
      1. BEGIN IMMEDIATE transaction
      2. Load policies (same as evaluate)
      3. For SPENDING_LIMIT: compute current reserved total = SUM(reserved_amount) for agent's PENDING/QUEUED txs
      4. Add current request amount to reserved total
      5. Evaluate against limits with reserved total considered
      6. If allowed: UPDATE transactions SET reserved_amount = request.amount WHERE id = txId
      7. COMMIT
    - This ensures two concurrent requests cannot both pass under the limit

    Note: The transactions table already has no reserved_amount column in the current schema.
    For v1.2, add the reserved_amount column to the schema. This is a text column (same as amount).

    **Test cases:**

    CRUD tests:
    - POST creates policy with valid SPENDING_LIMIT rules -> 201
    - POST creates policy with valid WHITELIST rules -> 201
    - POST rejects invalid type -> 400 (Zod validation error)
    - POST rejects non-existent agentId -> 404
    - POST without masterAuth -> 401
    - GET returns all policies (empty filter)
    - GET ?agentId= returns agent-specific + global policies
    - PUT updates rules and priority -> 200
    - PUT non-existent ID -> 404
    - DELETE removes policy -> 200
    - DELETE non-existent ID -> 404

    TOCTOU test:
    - evaluateAndReserve sets reserved_amount on the transaction row
    - Two sequential evaluateAndReserve calls: second one sees first's reserved amount

  </behavior>
  <implementation>
    **Task 1: Create Zod schemas + Policy CRUD routes + tests**

    1. Update packages/core/src/schemas/policy.schema.ts:
       - Add CreatePolicyRequestSchema: { agentId?: string, type: PolicyTypeEnum, rules: z.record(z.unknown()), priority?: z.number().int().default(0), enabled?: z.boolean().default(true) }
       - Add UpdatePolicyRequestSchema: { rules?: z.record(z.unknown()), priority?: z.number().int(), enabled?: z.boolean() }
       - Export from core index.ts

    2. Create packages/daemon/src/api/routes/policies.ts:
       - policyRoutes(deps: PolicyRouteDeps) factory pattern (same as sessionRoutes)
       - PolicyRouteDeps: { db: BetterSQLite3Database }
       - POST /policies: validate body, check agent if agentId, insert with generateId(), return 201
       - GET /policies: optional agentId query filter, order by priority DESC
       - PUT /policies/:id: partial update, validate rules type-specific if provided
       - DELETE /policies/:id: delete from DB
       - For SPENDING_LIMIT rules validation: verify instant_max/notify_max/delay_max are digit strings using regex
       - For WHITELIST rules validation: verify allowed_addresses is string array

    3. Update packages/daemon/src/api/routes/index.ts: export policyRoutes

    4. Update packages/daemon/src/api/server.ts:
       - Add policyRoutes registration under /v1 (same pattern as sessionRoutes)
       - masterAuth already covers /v1/policies via path-prefix matching at server level
       - Add app.use('/v1/policies', masterAuth) for explicit auth

    5. Write tests in packages/daemon/src/__tests__/api-policies.test.ts:
       - Same test harness pattern as api-agents.test.ts (in-memory DB, createApp)
       - Test all CRUD operations + auth rejection

    **Task 2: Add TOCTOU prevention pattern**

    1. Add reserved_amount TEXT column to transactions schema (packages/daemon/src/infrastructure/database/schema.ts)

    2. Extend DatabasePolicyEngine constructor to accept raw better-sqlite3 Database instance:
       - constructor(db: BetterSQLite3Database, sqlite: Database)
       - sqlite is used for BEGIN IMMEDIATE transactions (Drizzle doesn't support IMMEDIATE)

    3. Add evaluateAndReserve(agentId, transaction, txId) method:
       - Uses sqlite.transaction().immediate() (better-sqlite3 API)
       - Inside transaction: load policies, compute SUM(reserved_amount), evaluate with total, SET reserved_amount
       - Returns PolicyEvaluation (same as evaluate)

    4. Add releaseReservation(txId) static method:
       - UPDATE transactions SET reserved_amount = NULL WHERE id = txId
       - Called on FAILED/CANCELLED/EXPIRED

    5. Write TOCTOU tests in database-policy-engine.test.ts (append to existing):
       - evaluateAndReserve sets reserved_amount
       - Sequential calls accumulate reserved amounts correctly
  </implementation>
</feature>

<verification>
```bash
# Run policy API tests
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run api-policies

# Run updated database-policy-engine tests (TOCTOU)
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run database-policy-engine

# Typecheck
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm typecheck

# All daemon tests still pass
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run
```
</verification>

<success_criteria>
- POST/GET/PUT/DELETE /v1/policies all functional with masterAuth protection
- SPENDING_LIMIT and WHITELIST rules validated on create/update
- Policy CRUD operations correctly persist to/read from policies table
- evaluateAndReserve uses BEGIN IMMEDIATE to serialize concurrent evaluations
- reserved_amount correctly tracks pending amounts for TOCTOU prevention
- 13+ tests pass (11 CRUD + 2 TOCTOU)
- TypeScript compiles clean
- All existing daemon tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/54-policy-engine/54-02-SUMMARY.md`
</output>
