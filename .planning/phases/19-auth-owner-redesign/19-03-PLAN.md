---
phase: 19-auth-owner-redesign
plan: 03
type: execute
wave: 2
depends_on: ["19-01", "19-02"]
files_modified:
  - .planning/deliverables/34-owner-wallet-connection.md
  - .planning/deliverables/37-rest-api-complete-spec.md
autonomous: true

must_haves:
  truths:
    - "34-owner-wallet-connection.md가 v0.5 인증 모델을 반영하여 ownerAuth 적용 범위가 2곳으로 축소되어 있다"
    - "37-rest-api-complete-spec.md의 인증 체계(섹션 3)와 미들웨어 체인(섹션 4)이 v0.5 3-tier 모델을 반영하고 있다"
    - "두 문서 모두 52-auth-model-redesign.md를 참조하고, 25-sqlite-schema.md의 스키마 변경을 반영하고 있다"
  artifacts:
    - path: ".planning/deliverables/34-owner-wallet-connection.md"
      provides: "v0.5 반영: ownerAuth 2곳 한정, agents.owner_address 검증, WC 선택적, CLI 수동 서명"
      contains: "agents.owner_address, wallet_connections, CLI 수동 서명, 선택적 편의 기능"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "v0.5 반영: 3-tier 인증 체계, 인증 맵 재배치, masterAuth implicit/explicit"
      contains: "masterAuth, implicit, explicit, 3-tier, authRouter"
  key_links:
    - from: "34-owner-wallet-connection.md ownerAuth Step 5"
      to: "25-sqlite-schema.md agents.owner_address"
      via: "서명자 주소 == agents.owner_address (v0.5)"
    - from: "37-rest-api-complete-spec.md 인증 체계"
      to: "52-auth-model-redesign.md 3-tier 정의"
      via: "securitySchemes 3종 재정의"
---

<objective>
v0.5 인증 모델 변경을 기존 설계 문서 2개(34-owner-wallet-connection.md, 37-rest-api-complete-spec.md)에 반영한다.

Purpose: Plan 01에서 작성한 인증 모델 재설계와 Plan 02에서 변경한 스키마를 기존 설계 문서에 일관되게 반영하여, 문서 간 비일관성을 방지한다.
Output: 34-owner-wallet-connection.md (대규모 수정), 37-rest-api-complete-spec.md (중규모 수정)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-auth-owner-redesign/19-CONTEXT.md
@.planning/phases/19-auth-owner-redesign/19-01-SUMMARY.md
@.planning/phases/19-auth-owner-redesign/19-02-SUMMARY.md
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/34-owner-wallet-connection.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/25-sqlite-schema.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 34-owner-wallet-connection.md v0.5 대규모 수정</name>
  <files>.planning/deliverables/34-owner-wallet-connection.md</files>
  <action>
34-owner-wallet-connection.md를 v0.5 인증 모델에 맞게 대규모 수정한다. 기존 구조를 최대한 유지하면서 v0.5 변경점을 반영한다.

**문서 헤더 업데이트:**
- 문서 제목: "Owner 지갑 연결 + 인증 프로토콜 설계" (OWNR-CONN → OWNR-CONN v0.5)
- 상태: "v0.5 업데이트"
- 참조에 52-auth-model-redesign.md 추가
- 요구사항: v0.5 OWNR-03, OWNR-05, OWNR-06 추가

**섹션 1 (문서 개요) 수정:**
- 1.1 목적 핵심 변경: "Owner는 WAIaaS에서 유일한 인가 주체이다" -> "Owner는 WAIaaS에서 **자금 관련 인가 주체**이다. 시스템 관리는 masterAuth, 에이전트 API는 sessionAuth가 담당한다."
- 1.3에 v0.2 -> v0.5 변경 요약 테이블 추가:
  | 항목 | v0.2 | v0.5 | 근거 |
  | Owner 인증 범위 | 17+ 엔드포인트 전체 관리 | 2곳(거래 승인+KS 복구)으로 한정 | 자금 영향 기준 분리 |
  | Owner 주소 저장 | owner_wallets 테이블 (시스템 전역) | agents.owner_address (에이전트별) | 멀티 에이전트 격리 |
  | WalletConnect 역할 | 유일한 Owner 연결 경로 | 선택적 편의 기능 (CLI 대안 존재) | WC 외부 의존성 최소화 |
  | Owner API 인증 | ownerAuth 8개 엔드포인트 | ownerAuth 2개 + masterAuth 나머지 | 3-tier 분리 |

**섹션 2 (WalletConnect 아키텍처) 수정:**
- 2.1 역할 분배: WalletConnect가 "Owner 지갑 연결의 유일한 경로"가 아님을 명시. "WC는 모바일 지갑 push 서명의 편의 기능. CLI 수동 서명이 항상 대안으로 존재."
- 2.2 projectId 관리: `waiaas init` 안내를 "선택적" 톤으로 변경 (24-monorepo-data-directory.md Task 2와 일관)

**섹션 3-4 (연결 플로우) 소규모 수정:**
- Phase C의 "owner_wallets 테이블 INSERT" -> "wallet_connections 테이블 INSERT" 변경
- 시퀀스 다이어그램에서 "owner_wallets" -> "wallet_connections" 변경
- CLI 연결 플로우(섹션 4)는 WC 편의 기능으로 유지하되, "이 연결이 없어도 ownerAuth는 CLI 수동 서명으로 사용 가능" 노트 추가

**섹션 5 (ownerAuth 미들웨어) 대규모 수정:**
- 5.1: "CORE-06 ownerAuth stub 완성" 유지하되, 적용 범위 변경 명시
- 5.2: "Owner 전용 API는 매 요청마다 SIWS/SIWE 서명" -> "ownerAuth가 적용되는 2개 엔드포인트는 매 요청마다 SIWS/SIWE 서명"
- 5.3 OwnerSignaturePayload: action enum을 7개에서 2개로 축소:
  ```typescript
  action: z.enum(['approve_tx', 'recover']),
  ```
- 5.5 ownerAuth 미들웨어 Step 5 수정:
  - 변경 전: `owner_wallets.address` 테이블에서 조회
  - 변경 후: `agents.owner_address` 컬럼에서 조회.
    - 거래 승인: txId -> transactions.agent_id -> agents.owner_address
    - KS 복구: 요청 바디에서 에이전트 지정 또는 등록된 에이전트 중 해당 주소의 owner 확인
  - 코드 패턴:
    ```typescript
    // ═══ Step 5: 서명자 주소 == 에이전트의 owner_address 확인 (v0.5) ═══
    const agentId = resolveAgentIdFromContext(c) // txId -> transactions.agent_id
    const agent = await db.select()
      .from(agents)
      .where(eq(agents.id, agentId))
      .get()
    if (!agent || agent.ownerAddress !== payload.address) {
      throw new WaiaasError('OWNER_MISMATCH', '에이전트의 등록된 Owner 주소와 서명자 주소가 일치하지 않습니다.', 403)
    }
    ```
- 5.6 검증 단계 요약 테이블: Step 5의 "서명자 == owner_wallets.address" -> "서명자 == agents.owner_address"
- 5.8 ownerAuth vs sessionAuth 비교: ownerAuth 적용 범위를 "라우트 레벨 (/v1/owner/*)" -> "2개 라우트 (approve/:txId, recover)" 변경
- 5.9 ownerAuth 라우트 등록 패턴: ownerAuth를 /v1/owner/* 전체가 아닌 특정 2개 라우트에만 적용하는 패턴으로 변경

**ROUTE_ACTION_MAP 축소:**
```typescript
const ROUTE_ACTION_MAP: Record<string, string> = {
  'POST /v1/owner/approve': 'approve_tx',
  'POST /v1/owner/recover': 'recover',
}
```

**섹션 6 (Owner API 엔드포인트) 대규모 수정:**
- 6.1 엔드포인트 전체 목록: 8개 중 ownerAuth 유지는 2개(approve, recover). 나머지 6개의 인증을 변경:
  - POST /v1/owner/connect: None(localhost) -- 변경 없음
  - DELETE /v1/owner/disconnect: ownerAuth -> masterAuth(implicit)
  - POST /v1/owner/approve/:txId: ownerAuth -- **변경 없음**
  - POST /v1/owner/reject/:txId: ownerAuth -> masterAuth(implicit)
  - POST /v1/owner/kill-switch: ownerAuth -> masterAuth(implicit) -- 별도 /v1/admin/kill-switch와 통합 언급
  - GET /v1/owner/pending-approvals: ownerAuth -> masterAuth(implicit)
  - PUT /v1/owner/policies/:policyId: ownerAuth -> masterAuth(implicit)
  - POST /v1/owner/policies: ownerAuth -> masterAuth(implicit)
- 각 엔드포인트 상세에서 "인증: ownerAuth" -> "인증: masterAuth(implicit)" 변경 (approve와 recover 제외)
- 6.4 Kill Switch 발동: "인증: ownerAuth (action=kill_switch)" -> "인증: masterAuth(implicit). CLI에서 별도 인증 없이 호출 가능 (데몬 실행 = 인증 상태)."

**섹션 7 (WC 세션 관리) 수정:**
- 7.2: "owner_wallets 테이블 스키마" -> "wallet_connections 테이블 스키마" (25-sqlite-schema.md 참조)
- 7.3: "다중 Owner 미지원" -> "에이전트별 Owner" 개념으로 전환. "v0.5에서는 에이전트별 owner_address로 Owner가 관리되므로, wallet_connections는 WC push 서명 캐시 역할만 수행."
- 7.4: "Owner 주소 변경 절차" 전면 교체 -- masterAuth 단일 트랙 (52-auth-model-redesign.md 참조):
  - `PUT /v1/agents/:id { ownerAddress: "<new_address>" }` (masterAuth implicit)
  - 별도 disconnect + reconnect 절차 불필요
  - APPROVAL 대기 거래 자동 취소

**섹션 8 (Relay 장애 대응) 수정:**
- 8.1 장애 시 영향 분석: APPROVAL 거래 승인이 "필요 (모바일 서명)" -> "WC 미연결 시 CLI 수동 서명으로 대체 가능"
  - WC 장애 시에도 ownerAuth 자체는 동작 (CLI 수동 서명). WC는 UX 편의일 뿐.
- 8.2 CLI 직접 서명 대안: 52-auth-model-redesign.md의 CLI 수동 서명 플로우 참조로 대체 (중복 방지)
- 8.3 Kill Switch 로컬 발동: masterAuth(implicit)로 변경. "마스터 패스워드 입력" 불필요 -> 데몬 실행 = 인증 상태.

**섹션 9 (보안 고려사항) 소규모 수정:**
- 9.3 Owner 사칭 방지: "owner_wallets.address" -> "agents.owner_address"
- 9.4 다중 디바이스 정책: wallet_connections 반영

전체적으로 **기존 구조를 유지**하면서 v0.5 변경점만 수정. 모든 수정 부분에 "(v0.5 변경)" 표시.
  </action>
  <verify>
파일 변경 확인:
- `grep "agents.owner_address\|agents\.owner_address" .planning/deliverables/34-owner-wallet-connection.md` -- agents.owner_address 참조 확인
- `grep "wallet_connections" .planning/deliverables/34-owner-wallet-connection.md` -- 테이블명 변경 확인
- `grep "선택적 편의\|선택적" .planning/deliverables/34-owner-wallet-connection.md` -- WC 선택적 전환 확인
- `grep "approve_tx.*recover\|2곳\|2개" .planning/deliverables/34-owner-wallet-connection.md` -- ownerAuth 2곳 한정 확인
- `grep "52-auth-model-redesign" .planning/deliverables/34-owner-wallet-connection.md` -- 신규 문서 참조 확인
  </verify>
  <done>
- 34-owner-wallet-connection.md의 ownerAuth 적용 범위가 2곳(approve, recover)으로 축소되어 있다
- ownerAuth Step 5가 agents.owner_address 대조로 변경되어 있다
- owner_wallets가 wallet_connections로 전환되어 있다
- WalletConnect가 "선택적 편의 기능"으로 재정의되어 있다
- Owner 주소 변경 절차가 masterAuth 단일 트랙으로 변경되어 있다
- 52-auth-model-redesign.md가 참조 문서로 추가되어 있다
  </done>
</task>

<task type="auto">
  <name>Task 2: 37-rest-api-complete-spec.md 인증 체계 + 미들웨어 업데이트</name>
  <files>.planning/deliverables/37-rest-api-complete-spec.md</files>
  <action>
37-rest-api-complete-spec.md의 인증 관련 섹션을 v0.5 3-tier 모델로 수정한다. 엔드포인트 상세(섹션 5~9)는 이 플랜에서 변경하지 않고, Phase 21(DX 통합)에서 일괄 반영한다. 이 플랜에서는 **섹션 1~4 (개요, 서버 설정, 인증 체계, 미들웨어)**만 수정한다.

**문서 헤더 업데이트:**
- 참조에 52-auth-model-redesign.md 추가
- "v0.5 인증 모델 업데이트: 2026-02-07" 추가

**섹션 1.4 (전체 엔드포인트 요약) 수정:**

| 카테고리 | 수 | 인증 | 범위 |
|----------|---|------|------|
| Public API | 3 | None | 헬스체크, 문서, nonce |
| Session API (Agent) | 5 | Session Bearer | 지갑, 거래, 세션 조회 |
| System Management API | 18 | masterAuth (implicit) | 세션 CRUD, 에이전트 CRUD, 정책, 설정, 대시보드 |
| Owner Auth API | 1 | Owner Signature | 거래 승인 (APPROVAL 티어) |
| Dual Auth API | 1 | Owner Signature + Master Password | Kill Switch 복구 |
| Admin API | 3 | Master Password (explicit) | Kill Switch, Shutdown, Status |
| **합계** | **31** | | |

(기존: "Session Management API 3, ownerAuth", "Owner API 17, ownerAuth" -> 통합 재분류)

**섹션 2.3 (공통 요청 헤더) 업데이트:**

X-Master-Password 헤더 설명 변경:
- 변경 전: "Admin API"
- 변경 후: "Admin API + Kill Switch 복구 (explicit masterAuth). 대부분의 masterAuth 엔드포인트는 implicit(헤더 불필요)."

**섹션 3 (인증 체계) 대규모 수정:**

3.1 Session Bearer: 변경 없음 (v0.2 유지)

3.2 Owner Signature:
- 적용 범위 변경: `/v1/owner/*` (connect 제외), `POST /v1/sessions` -> **POST /v1/owner/approve/:txId, POST /v1/owner/recover 2곳만**
- OwnerSignaturePayload action enum 축소:
  ```typescript
  action: z.enum(['approve_tx', 'recover']),
  ```
- ownerAuth 8단계 검증 Step 5: "서명자 == owner_wallets.address" -> "서명자 == agents.owner_address (에이전트별 검증)"
- 참조를 52-auth-model-redesign.md로 갱신

3.3 Master Password:
- 2가지 모드 추가 설명:
  - **implicit masterAuth**: 데몬 실행 = 인증 상태. 별도 헤더 불필요. 세션 CRUD, 에이전트 CRUD, 정책 CRUD, 설정, 조회 등 시스템 관리 전반.
  - **explicit masterAuth**: `X-Master-Password` 헤더 필수. `/v1/admin/*` + Kill Switch 복구 (dual-auth).
- 적용 범위: `/v1/admin/*` -> `/v1/admin/*` (explicit) + 시스템 관리 전반 (implicit)

3.4 인증 체계 적용 맵 전면 교체:

| 엔드포인트 패턴 | 인증 | 미들웨어 |
|---------------|------|----------|
| `GET /health`, `GET /doc`, `GET /v1/nonce` | None | - |
| `POST /v1/owner/connect` | None (localhost 보안) | hostValidation |
| `/v1/wallet/*`, `/v1/transactions/*`, `GET /v1/sessions` | Session Bearer | sessionAuth |
| `POST /v1/sessions`, `DELETE /v1/sessions/:id`, 에이전트 CRUD, 정책 CRUD, 설정, 조회 등 | masterAuth (implicit) | masterAuth(implicit) |
| `POST /v1/owner/approve/:txId` | Owner Signature | ownerAuth |
| `POST /v1/owner/recover` | Owner Signature + Master Password | ownerAuth + masterAuth(explicit) |
| `/v1/admin/*` | Master Password (explicit) | masterAuth(explicit) |

**섹션 4 (미들웨어 체인) 수정:**

4.1 9단계 미들웨어 순서:
- 순서 9의 "sessionAuth / ownerAuth / masterAuth" -> "authRouter (라우트별 디스패치: publicAuth / sessionAuth / masterAuth(implicit) / masterAuth(explicit) / ownerAuth / dualAuth)"
- authRouter 디스패치 설명 추가 (52-auth-model-redesign.md 참조)

4.2 killSwitchGuard 허용 목록:
- POST /v1/owner/recover 유지 (ownerAuth + masterAuth dual-auth)
- 변경 없음

변경 시 기존 내용을 보존하고 v0.5 변경 부분만 수정. "(v0.5 변경)" 표시 추가.
  </action>
  <verify>
파일 변경 확인:
- `grep "implicit\|암묵적" .planning/deliverables/37-rest-api-complete-spec.md` -- implicit masterAuth 확인
- `grep "explicit\|명시적" .planning/deliverables/37-rest-api-complete-spec.md` -- explicit masterAuth 확인
- `grep "52-auth-model-redesign" .planning/deliverables/37-rest-api-complete-spec.md` -- 신규 문서 참조 확인
- `grep "approve_tx.*recover\|2곳" .planning/deliverables/37-rest-api-complete-spec.md` -- ownerAuth 2곳 확인
- `grep "authRouter" .planning/deliverables/37-rest-api-complete-spec.md` -- 미들웨어 업데이트 확인
  </verify>
  <done>
- 37-rest-api-complete-spec.md 섹션 3(인증 체계)이 3-tier 모델을 반영하고 있다
- masterAuth가 implicit/explicit 2가지 모드로 구분되어 있다
- ownerAuth 적용이 2곳(approve, recover)으로 한정되어 있다
- 섹션 3.4 인증 맵이 v0.5 재배치를 반영하고 있다
- 섹션 4 미들웨어 체인이 authRouter 디스패치로 업데이트되어 있다
- 52-auth-model-redesign.md가 참조로 추가되어 있다
  </done>
</task>

</tasks>

<verification>
Phase 19 Success Criteria 전체 대응:
1. 인증 모델 재설계 문서 (52-auth-model-redesign.md) -> Plan 01
2. 31개 엔드포인트 인증 맵 재배치 + ownerAuth 2곳 한정 -> Plan 01 + Plan 03 Task 2
3. agents.owner_address + config.toml + owner_wallets->wallet_connections -> Plan 02
4. WalletConnect 미연결 시 CLI 수동 서명 플로우 -> Plan 01 (정의) + Plan 03 Task 1 (반영)
5. 보안 비다운그레이드 검증 -> Plan 01
</verification>

<success_criteria>
- 34-owner-wallet-connection.md가 v0.5를 완전히 반영하고 있다 (ownerAuth 2곳, agents.owner_address, wallet_connections, WC 선택적)
- 37-rest-api-complete-spec.md 섹션 1~4가 v0.5 3-tier 인증 모델을 반영하고 있다
- 두 문서 모두 52-auth-model-redesign.md를 참조하고 있다
- 문서 간 비일관성이 없다
</success_criteria>

<output>
After completion, create `.planning/phases/19-auth-owner-redesign/19-03-SUMMARY.md`
</output>
