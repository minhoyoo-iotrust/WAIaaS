---
phase: 19-auth-owner-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/52-auth-model-redesign.md
autonomous: true

must_haves:
  truths:
    - "masterAuth/ownerAuth/sessionAuth 3가지 인증 수단의 대상, 방법, 적용 범위가 명확히 구분되어 있다"
    - "31개 REST API 엔드포인트의 인증 맵이 재배치되어 있고, ownerAuth가 거래 승인 + Kill Switch 복구 2곳으로 한정되어 있다"
    - "보안 비다운그레이드 검증표가 v0.2 vs v0.5 비교로 작성되어 있다"
    - "CLI 수동 서명 플로우가 WalletConnect 없이도 동작하는 형태로 정의되어 있다"
  artifacts:
    - path: ".planning/deliverables/52-auth-model-redesign.md"
      provides: "인증 모델 재설계 전체 스펙 (3-tier 정의 + 31 endpoint auth map + 보안 검증)"
      contains: "masterAuth, ownerAuth, sessionAuth, 인증 맵 재배치, 비다운그레이드 검증"
  key_links:
    - from: "52-auth-model-redesign.md"
      to: "37-rest-api-complete-spec.md"
      via: "31-endpoint auth map replaces section 3.4"
    - from: "52-auth-model-redesign.md"
      to: "34-owner-wallet-connection.md"
      via: "ownerAuth middleware redesign (agents.owner_address verification)"
    - from: "52-auth-model-redesign.md"
      to: "29-api-framework-design.md"
      via: "middleware chain update (authRouter dispatch)"
---

<objective>
masterAuth/ownerAuth/sessionAuth 3-tier 인증 모델 재설계 문서를 신규 작성한다.

Purpose: v0.2에서 ownerAuth 17+ 엔드포인트 중심이던 인증 모델을 masterAuth(시스템 관리)/ownerAuth(자금 승인 2곳)/sessionAuth(에이전트 API)로 재분리하여, 보안 수준을 유지하면서 WalletConnect 의존성을 최소화하고 DX를 개선한다.
Output: .planning/deliverables/52-auth-model-redesign.md (신규 문서)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-auth-owner-redesign/19-CONTEXT.md
@.planning/phases/19-auth-owner-redesign/19-RESEARCH.md
@.planning/deliverables/37-rest-api-complete-spec.md (섹션 1-4: 인증 체계, 미들웨어 체인)
@.planning/deliverables/34-owner-wallet-connection.md (섹션 5: ownerAuth 미들웨어, 섹션 8: CLI 서명 대안)
@.planning/deliverables/29-api-framework-design.md (섹션 1-2: 미들웨어 아키텍처)
@.planning/deliverables/30-session-token-protocol.md (섹션 2-4: JWT + sessionAuth)
@.planning/deliverables/36-killswitch-autostop-evm.md (섹션 2.4: Kill Switch 복구 dual-auth)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 3-tier 인증 모델 정의 + 31 엔드포인트 인증 맵 작성</name>
  <files>.planning/deliverables/52-auth-model-redesign.md</files>
  <action>
신규 문서 `.planning/deliverables/52-auth-model-redesign.md`를 한글로 작성한다.

문서 구조:
1. **문서 개요** -- 문서 ID: AUTH-REDESIGN, 작성일, 상태, 참조 문서, 요구사항 매핑 (AUTH-01~05, OWNR-05~06)
2. **v0.2 -> v0.5 변경 요약** -- 핵심 변경 3줄 요약 + 변경 비교표
3. **3-tier 인증 모델 정의** -- 3개 섹션으로 분리:

   **3.1 masterAuth (시스템 관리 인증)**
   - 정의: 마스터 패스워드(Argon2id) 기반. 데몬 시작 시 1회 입력, 이후 데이몬 실행 = 인증 완료 상태
   - 2가지 모드:
     - **암묵적 masterAuth (implicit)**: 데몬 구동 중 = 인증 완료. 추가 헤더 불필요. 세션 생성, 에이전트 CRUD, 정책 CRUD, 설정, 조회 등 시스템 관리 전반. 보안은 localhost 바인딩(127.0.0.1 Zod literal)에 의존.
     - **명시적 masterAuth (explicit)**: X-Master-Password 헤더 필수. Admin API(kill-switch, shutdown, status) + Kill Switch 복구(dual-auth). 파괴적/비가역적 작업에 대한 defense-in-depth.
   - 미들웨어 코드 패턴: 암묵적 모드는 authType='master' 설정 + next() (사실상 no-op guard). 명시적 모드는 Argon2id verify + brute-force lockout(5회 실패 -> 30분).
   - 감사 추적: actor='master'로 기록 (개인 식별 불가 -- Self-Hosted 단일 운영자이므로 의도적 트레이드오프)

   **3.2 ownerAuth (자금 승인 인증)**
   - 정의: 매 요청 SIWS(Solana)/SIWE(EVM) 서명 기반. 에이전트별 agents.owner_address와 대조 검증.
   - 적용 범위: **정확히 2곳만** -- (1) POST /v1/owner/approve/:txId (APPROVAL 티어 거래 승인), (2) POST /v1/owner/recover (Kill Switch 복구, dual-auth)
   - v0.2 -> v0.5 변경점: Step 5에서 owner_wallets.address 대신 agents.owner_address 대조. txId -> agentId -> owner_address 해석 체인.
   - ownerAuth 미들웨어 8단계 업데이트: Step 5를 "agents.owner_address 대조"로 변경. agentId 해석 로직 추가 (거래 승인: txId -> transactions.agent_id, KS 복구: 요청 바디의 agentId 또는 등록된 에이전트 중 1명의 owner).
   - OwnerSignaturePayload action enum 축소: v0.2의 7개에서 v0.5는 2개로 축소 (approve_tx, recover).
   - APPROVAL 타임아웃: 설정 가능으로 변경 (최소 300초, 최대 86400초, 기본 3600초). config.toml [security.policy_defaults].approval_timeout에서 설정.

   **3.3 sessionAuth (에이전트 API 인증)**
   - 정의: JWT HS256 Bearer 토큰. v0.2와 동일한 2-stage 검증 유지.
   - 적용 범위: 에이전트 API 전체 (/v1/wallet/*, /v1/transactions/*, GET /v1/sessions)
   - 변경점: 없음 (v0.2 SESS-PROTO 그대로 유지)

4. **31 엔드포인트 인증 맵 재배치** -- 전체 테이블 작성:

   | # | Method | Path | v0.2 Auth | v0.5 Auth | 변경 | 근거 |

   RESEARCH.md의 "Discretion Recommendations 섹션 2" 테이블을 기반으로 작성. 핵심 변경:
   - POST /v1/sessions: ownerAuth(body sig) -> masterAuth(implicit) -- 세션 제약이 안전장치
   - GET /v1/sessions: ownerAuth -> sessionAuth -- 에이전트가 자신의 세션 조회
   - DELETE /v1/sessions/:id: ownerAuth -> masterAuth(implicit) -- 시스템 관리
   - POST /v1/owner/reject/:txId: ownerAuth -> masterAuth(implicit) -- 보호적 행위(자금 이동 방지)
   - POST /v1/owner/kill-switch: ownerAuth -> masterAuth(implicit) -- 비상 정지(보호적)
   - GET/PUT /v1/owner/settings, policies, sessions, agents, dashboard, status: ownerAuth -> masterAuth(implicit)
   - POST /v1/owner/approve/:txId: **ownerAuth 유지** (자금 이동)
   - POST /v1/owner/recover: **ownerAuth + masterAuth(explicit) dual-auth 유지** (자금 접근 복구)

   배치 원칙 명시: "자금 영향 기준 -- 자금 이동/동결에 직접 영향 = ownerAuth, 그 외 = masterAuth 또는 sessionAuth"

5. **CLI 수동 서명 플로우 (WalletConnect 대안)**
   - 4단계 플로우:
     (1) CLI가 GET /v1/nonce로 nonce 발급
     (2) CLI가 SIWS/SIWE 메시지 구성 + 터미널에 출력
     (3) Owner가 외부 도구(solana CLI, Ledger CLI, 키페어 파일)로 오프라인 서명
     (4) Owner가 서명을 터미널에 붙여넣기 -> CLI가 API 호출
   - DX 개선: 메시지를 임시 파일로 저장 (`/tmp/waiaas-sign-msg.txt`), stdin으로 서명 수신 지원
   - CLI 커맨드 예시: `waiaas owner approve <txId>` (대화형 플로우), `waiaas owner approve <txId> --signature <sig> --message-file <path>` (비대화형)
   - WalletConnect는 순수 편의 기능: WC 연결 시 모바일 push 서명 자동 시도, 미연결 시 CLI 수동 승인으로 자동 폴백

6. **보안 비다운그레이드 검증 (v0.2 vs v0.5)**
   - 31개 엔드포인트 각각에 대한 비교표:

   | # | Endpoint | v0.2 Auth | v0.5 Auth | Change | Fund Impact | Verdict |

   - Change 컬럼: Same / Upgrade / Downgrade
   - Downgrade인 경우 "보상 통제(compensating control)" 명시:
     - POST /v1/sessions: Downgrade (ownerAuth -> masterAuth). 보상: 세션 제약(constraints) + 최대 수명 7일 + Owner 폐기 가능
     - POST /v1/owner/reject: Downgrade (ownerAuth -> masterAuth). 보상: 거절은 보호적 행위(자금 보존). 자금 이동 없음.
     - POST /v1/owner/kill-switch: Downgrade (ownerAuth -> masterAuth). 보상: 비상 정지는 보호적 행위. 복구에만 ownerAuth 유지.
   - **결론**: ownerAuth가 필요한 2곳(APPROVAL 거래 승인, KS 복구)에서 v0.2와 동일한 보안 수준 유지. 다운그레이드된 엔드포인트는 모두 보상 통제가 존재.

7. **미들웨어 아키텍처 업데이트**
   - v0.5 미들웨어 체인: requestId -> logger -> shutdownGuard -> secureHeaders -> hostValidation -> cors -> rateLimiter -> killSwitchGuard -> authRouter
   - authRouter 디스패치 로직:
     - publicAuth: GET /health, GET /doc, GET /v1/nonce
     - sessionAuth: /v1/wallet/*, /v1/transactions/*, GET /v1/sessions
     - masterAuth(implicit): 에이전트 CRUD, 정책 CRUD, 세션 관리, 설정, POST /v1/sessions 등
     - masterAuth(explicit): /v1/admin/*
     - ownerAuth: POST /v1/owner/approve/:txId
     - dualAuth(ownerAuth + masterAuth explicit): POST /v1/owner/recover
   - killSwitchGuard 허용 목록 업데이트: GET /health, POST /v1/owner/recover, GET /v1/admin/status (v0.2와 동일)

8. **요구사항 매핑 총괄** -- AUTH-01~05, OWNR-05~06 각각이 문서 어느 섹션에서 충족되는지 표로 정리

모든 내용은 **한글**로 작성. 코드 예시에서 주석도 한글.
  </action>
  <verify>
파일 존재 확인: `ls .planning/deliverables/52-auth-model-redesign.md`
내용 검증:
- "masterAuth" 문자열이 포함되어 있는지
- "ownerAuth" 문자열이 포함되어 있는지
- "sessionAuth" 문자열이 포함되어 있는지
- "비다운그레이드" 또는 "non-downgrade" 문자열이 포함되어 있는지
- 31개 엔드포인트 테이블이 존재하는지 ("|" 문자 라인이 35개 이상)
- AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-05, OWNR-05, OWNR-06 텍스트가 모두 포함되어 있는지
  </verify>
  <done>
- 52-auth-model-redesign.md가 .planning/deliverables/에 존재한다
- masterAuth/ownerAuth/sessionAuth 3-tier가 각각 대상, 방법, 적용 범위로 구분되어 정의되어 있다
- 31개 엔드포인트의 v0.5 인증 맵이 테이블로 작성되어 있다
- ownerAuth 적용이 정확히 2곳(거래 승인, KS 복구)으로 한정되어 있다
- v0.2 vs v0.5 보안 비다운그레이드 검증표가 존재하며, 다운그레이드 항목에 보상 통제가 명시되어 있다
- CLI 수동 서명 4단계 플로우가 정의되어 있다
- AUTH-01~05, OWNR-05~06 요구사항이 모두 매핑되어 있다
  </done>
</task>

</tasks>

<verification>
Phase 19 Success Criteria와의 대응:
1. "인증 모델 재설계 문서가 존재하며, 3가지 인증 수단의 대상, 방법, 적용 범위가 명확히 구분" -> 섹션 3 (3-tier 정의)
2. "31개 엔드포인트 인증 맵 재배치 + ownerAuth 2곳 한정" -> 섹션 4 (인증 맵)
4. "WalletConnect 미연결 시 CLI 수동 서명 플로우" -> 섹션 5 (CLI 수동 서명)
5. "보안 비다운그레이드 검증" -> 섹션 6 (v0.2 vs v0.5 검증표)
</verification>

<success_criteria>
- 52-auth-model-redesign.md 문서가 존재하며 8개 섹션으로 구성
- 3-tier 인증 모델이 명확하게 분리 정의됨
- 31개 엔드포인트 인증 맵이 완성됨 (ownerAuth = 2곳)
- 보안 비다운그레이드 검증표 완성
- CLI 수동 서명 플로우 완성
- 7개 요구사항(AUTH-01~05, OWNR-05~06) 커버리지 완료
</success_criteria>

<output>
After completion, create `.planning/phases/19-auth-owner-redesign/19-01-SUMMARY.md`
</output>
