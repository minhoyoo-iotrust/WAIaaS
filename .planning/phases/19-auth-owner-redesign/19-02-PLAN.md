---
phase: 19-auth-owner-redesign
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/24-monorepo-data-directory.md
autonomous: true

must_haves:
  truths:
    - "agents 테이블에 owner_address 컬럼이 NOT NULL로 정의되고 체인별 주소 형식 검증이 명세되어 있다"
    - "owner_wallets 테이블이 wallet_connections로 전환되어 인증 역할이 제거되고 WC 세션 캐시 전용으로 재정의되어 있다"
    - "config.toml에서 Owner 관련 개념이 제거되고 walletconnect 섹션이 선택적 편의 기능으로 명시되어 있다"
    - "Owner 주소 변경 정책이 masterAuth 단일 트랙으로 정의되어 있다"
    - "멀티 에이전트 시나리오에서 에이전트별 owner_address로 Owner가 격리되는 구조가 설명되어 있다"
  artifacts:
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "agents.owner_address NOT NULL + wallet_connections 테이블 + 마이그레이션 전략"
      contains: "owner_address TEXT NOT NULL, wallet_connections, idx_agents_owner_address"
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "config.toml walletconnect 섹션 선택적 전환"
      contains: "walletconnect, project_id"
  key_links:
    - from: "25-sqlite-schema.md agents.owner_address"
      to: "52-auth-model-redesign.md ownerAuth Step 5"
      via: "ownerAuth가 agents.owner_address와 대조 검증"
    - from: "25-sqlite-schema.md wallet_connections"
      to: "34-owner-wallet-connection.md WC 세션 관리"
      via: "owner_wallets -> wallet_connections 테이블명 전환"
---

<objective>
Owner 주소를 에이전트별 속성으로 이동하고 DB 스키마와 config.toml 변경을 명세한다.

Purpose: v0.2의 시스템 전역 Owner(owner_wallets 테이블 + config.toml)를 에이전트별 Owner(agents.owner_address NOT NULL)로 전환하여, 멀티 에이전트 환경에서 Owner 격리를 지원하고 WalletConnect를 선택적 편의 기능으로 분리한다.
Output: 25-sqlite-schema.md (수정), 24-monorepo-data-directory.md (수정)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-auth-owner-redesign/19-CONTEXT.md
@.planning/phases/19-auth-owner-redesign/19-RESEARCH.md
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/24-monorepo-data-directory.md
@.planning/deliverables/34-owner-wallet-connection.md (섹션 7.2: owner_wallets 스키마 참조)
</context>

<tasks>

<task type="auto">
  <name>Task 1: agents 테이블 스키마 변경 + wallet_connections 테이블 전환</name>
  <files>.planning/deliverables/25-sqlite-schema.md</files>
  <action>
25-sqlite-schema.md를 수정한다. 변경 사항:

**1. agents 테이블 (섹션 2.1) 수정:**

(a) `owner_address` 컬럼을 NOT NULL로 변경:
- 변경 전: `ownerAddress: text('owner_address'),` (nullable, "Phase 8에서 연결")
- 변경 후: `ownerAddress: text('owner_address').notNull(),` (NOT NULL, 에이전트 생성 시 필수)
- SQL DDL에서도 `owner_address TEXT` -> `owner_address TEXT NOT NULL`
- 컬럼 설명 테이블에서 Nullable을 NULL -> NOT NULL로 변경, 용도를 "에이전트 생성 시 필수 지정. Owner 지갑 주소 (Solana: base58, EVM: 0x...)"로 변경

(b) idx_agents_owner_address 인덱스 추가:
- Drizzle: indexes 배열에 `index('idx_agents_owner_address').on(table.ownerAddress)` 추가
- SQL DDL에 `CREATE INDEX idx_agents_owner_address ON agents(owner_address);` 추가
- 인덱스 용도: 1:N 조회 (동일 Owner의 모든 에이전트), ownerAuth 검증, Owner 주소 일괄 변경

(c) 컬럼 설명 업데이트:
- owner_address 행의 용도를 "에이전트 소유자 지갑 주소. 에이전트 생성 시 필수(NOT NULL). 1:1 바인딩(에이전트당 단일 Owner). 동일 주소가 여러 에이전트를 소유 가능(1:N). 체인별 형식: Solana=base58(32-44자), EVM=0x 접두사 hex(42자)"로 변경

**2. wallet_connections 테이블 신규 추가 (기존 owner_wallets 대체):**

이 문서에는 기존에 owner_wallets 테이블 정의가 없다(34-owner-wallet-connection.md에 정의됨). 25-sqlite-schema.md 섹션 2 끝에 새 섹션을 추가한다:

**섹션 "2.8 wallet_connections 테이블 -- WalletConnect 세션 캐시"**

v0.5에서 owner_wallets를 대체한다. 인증 역할이 제거되고 WalletConnect 푸시 서명 편의 기능 전용.

Drizzle ORM 정의:
```typescript
export const walletConnections = sqliteTable('wallet_connections', {
  id: text('id').primaryKey(),                          // UUID v7
  ownerAddress: text('owner_address').notNull(),        // agents.owner_address와 일치
  chain: text('chain', {
    enum: ['solana', 'ethereum'],
  }).notNull(),
  wcSessionTopic: text('wc_session_topic'),             // WalletConnect 세션 토픽
  wcPairingTopic: text('wc_pairing_topic'),             // WalletConnect 페어링 토픽
  connectedAt: integer('connected_at', { mode: 'timestamp' }).notNull(),
  lastActiveAt: integer('last_active_at', { mode: 'timestamp' }),
  metadata: text('metadata'),                           // JSON: 지갑 이름, 아이콘 등
}, (table) => [
  index('idx_wallet_connections_owner_address').on(table.ownerAddress),
]);
```

SQL DDL:
```sql
CREATE TABLE wallet_connections (
  id TEXT PRIMARY KEY,
  owner_address TEXT NOT NULL,
  chain TEXT NOT NULL CHECK (chain IN ('solana', 'ethereum')),
  wc_session_topic TEXT,
  wc_pairing_topic TEXT,
  connected_at INTEGER NOT NULL,
  last_active_at INTEGER,
  metadata TEXT
);
CREATE INDEX idx_wallet_connections_owner_address ON wallet_connections(owner_address);
```

컬럼 설명 테이블 작성 (owner_wallets와 대비):
- FK 없음 (agents.owner_address와의 관계는 애플리케이션 레벨 관리)
- address UNIQUE 인덱스 제거 (여러 에이전트의 동일 Owner가 동일 WC 세션 사용 가능)
- 핵심 차이: "이 테이블은 인증 소스가 아님. ownerAuth는 agents.owner_address로 검증. 이 테이블의 부재가 ownerAuth를 차단하지 않음."

**3. owner_wallets 테이블 제거 명시:**

기존에 이 문서에는 owner_wallets가 없지만, ERD(섹션 3)의 관계 다이어그램을 업데이트하여 wallet_connections를 추가한다:
- wallet_connections를 ERD에 추가 (독립 테이블, FK 없음)
- 관계 요약 테이블에 `wallet_connections | 독립 | FK 없음 (WC 편의 기능)` 추가

**4. v0.2 -> v0.5 스키마 마이그레이션 전략 추가:**

섹션 4 끝에 "4.7 v0.5 스키마 마이그레이션 (owner_wallets -> wallet_connections)" 추가:
1. `ALTER TABLE agents ADD COLUMN owner_address TEXT DEFAULT '' NOT NULL` (기존 에이전트에 빈 문자열 기본값)
2. `UPDATE agents SET owner_address = (SELECT address FROM owner_wallets LIMIT 1)` (기존 단일 Owner 주소 복사)
3. `CREATE INDEX idx_agents_owner_address ON agents(owner_address)`
4. `ALTER TABLE owner_wallets RENAME TO wallet_connections` (SQLite 3.25.0+ 지원)
5. `DROP INDEX idx_owner_wallets_address` (UNIQUE 인덱스 제거)
6. `CREATE INDEX idx_wallet_connections_owner_address ON wallet_connections(owner_address)`
- 주의: NOT NULL + DEFAULT ''는 마이그레이션용. 신규 에이전트는 애플리케이션에서 유효한 주소 강제.

**5. Owner 주소 변경 정책 (구현 노트 추가):**

섹션 7에 "7.2 Owner 주소 변경 정책 (v0.5)" 추가:
- 단일 트랙: masterAuth(implicit)만으로 변경 가능. 서명 이력 유무와 무관.
  - `PUT /v1/agents/:id { ownerAddress: "<new_address>" }` -- masterAuth(implicit)
- 변경 시 동작:
  1. agents.owner_address 업데이트
  2. 해당 에이전트의 APPROVAL 대기 중인 거래(status='QUEUED')를 모두 CANCELLED 처리 (기존 Owner 서명으로는 새 Owner가 승인 불가)
  3. audit_log에 OWNER_ADDRESS_CHANGED 이벤트 기록 (actor='master', 이전/이후 주소)
  4. 활성 세션은 유지 (Owner 변경이 세션 무효화하지 않음 -- 세션은 에이전트 인증이지 Owner 인증이 아님)
- 주소 형식 검증: Solana(base58 디코드 성공 + 32바이트), EVM(0x 접두사 + 40자 hex + EIP-55 체크섬)

**6. 전체 스키마 export (섹션 6) 업데이트:**

- agents 테이블의 ownerAddress를 `.notNull()`으로 변경
- `idx_agents_owner_address` 인덱스 추가
- walletConnections export 추가

**7. 요구사항 매핑 총괄 (섹션 8) 업데이트:**

테이블에 v0.5 요구사항 추가:
- OWNR-01: agents 테이블 `owner_address NOT NULL + idx_agents_owner_address`
- OWNR-02: config.toml 변경 (24-monorepo-data-directory.md 참조)
- OWNR-03: wallet_connections 테이블
- OWNR-04: agents.owner_address + idx_agents_owner_address (멀티 에이전트 격리)
- AUTH-04: 섹션 7.2 Owner 주소 변경 정책 (단일 트랙)

변경 시 **기존 내용을 보존**하고, v0.5 변경 부분은 명확히 "v0.5 변경" 주석 또는 헤더로 구분한다. 문서 상단에 "v0.5 업데이트: 2026-02-07" 날짜를 추가한다.
  </action>
  <verify>
파일 변경 확인:
- `grep "owner_address.*NOT NULL\|owner_address.*notNull" .planning/deliverables/25-sqlite-schema.md` -- NOT NULL 변경 확인
- `grep "wallet_connections" .planning/deliverables/25-sqlite-schema.md` -- 신규 테이블 확인
- `grep "idx_agents_owner_address" .planning/deliverables/25-sqlite-schema.md` -- 인덱스 확인
- `grep "OWNR-01\|OWNR-03\|OWNR-04\|AUTH-04" .planning/deliverables/25-sqlite-schema.md` -- 요구사항 매핑 확인
  </verify>
  <done>
- agents.owner_address가 NOT NULL로 변경되고 idx_agents_owner_address 인덱스가 추가되어 있다
- wallet_connections 테이블이 정의되어 있고, 인증 역할 제거가 명시되어 있다
- v0.5 스키마 마이그레이션 6단계 전략이 작성되어 있다
- Owner 주소 변경 정책(masterAuth 단일 트랙)이 명세되어 있다
- OWNR-01, OWNR-02, OWNR-03, OWNR-04, AUTH-04 요구사항이 매핑되어 있다
  </done>
</task>

<task type="auto">
  <name>Task 2: config.toml walletconnect 섹션 선택적 전환 + Owner 개념 제거</name>
  <files>.planning/deliverables/24-monorepo-data-directory.md</files>
  <action>
24-monorepo-data-directory.md를 수정한다. 변경 사항:

**1. config.toml 전체 기본 예시 (섹션 3.4) 업데이트:**

[walletconnect] 섹션에 주석 변경:
```toml
# ─────────────────────────────────────────
# WalletConnect v2 설정 (선택적 편의 기능)
# 미설정 시에도 CLI 수동 서명으로 ownerAuth 가능
# Reown Cloud에서 무료 projectId 발급: https://cloud.reown.com
# ─────────────────────────────────────────
[walletconnect]
project_id = ""   # 선택. 미설정 시 WC 기능 비활성 (CLI 수동 서명은 항상 가능)
```

핵심: "필수"에서 "선택"으로 변경. "미설정 시 Owner 연결 기능 비활성" 대신 "미설정 시 WC 기능 비활성 (CLI 수동 서명은 항상 가능)"으로 변경.

**2. [walletconnect] Zod 스키마 (섹션 3.x 또는 해당 부분) 주석 업데이트:**

기존:
```typescript
walletconnect: z.object({
  project_id: z.string().default(''),
}).default({}),
```

변경 후 (코드는 동일, 주석만 변경):
```typescript
// WalletConnect v2 -- 선택적 편의 기능
// project_id 미설정 시 WC push 서명 비활성. CLI 수동 서명은 항상 가능.
walletconnect: z.object({
  project_id: z.string().default(''),
}).default({}),
```

**3. waiaas init 안내 메시지 변경 (섹션 2 또는 init 관련 부분):**

기존: "WalletConnect projectId가 설정되지 않았습니다. Owner 지갑 연결을 위해 https://cloud.reown.com 에서 발급하세요."
변경: "WalletConnect projectId가 미설정입니다. 모바일 지갑 push 서명을 사용하려면 https://cloud.reown.com 에서 발급하세요. CLI 수동 서명은 projectId 없이도 사용 가능합니다."

**4. v0.5 변경 노트 추가:**

문서 적절한 위치(섹션 7 구현 노트 등)에 "v0.5 Owner 모델 변경" 노트 추가:
- config.toml에서 [owner] 섹션이 제거됨 (원래 존재하지 않았으나 향후 추가 예정이었던 부분 명시적 제거)
- Owner 개념이 config.toml(데몬 전역)에서 agents 테이블(에이전트별)로 이동
- WalletConnect는 "Owner 지갑 연결의 유일한 경로"에서 "모바일 지갑 push 서명의 편의 기능"으로 역할 변경
- 참조: 52-auth-model-redesign.md, 25-sqlite-schema.md (v0.5 업데이트)

변경 시 기존 내용을 보존하고 v0.5 변경 부분만 수정/추가한다.
  </action>
  <verify>
파일 변경 확인:
- `grep "선택적 편의 기능\|선택.*편의" .planning/deliverables/24-monorepo-data-directory.md` -- WC 선택적 전환 확인
- `grep "CLI 수동 서명" .planning/deliverables/24-monorepo-data-directory.md` -- CLI 대안 언급 확인
  </verify>
  <done>
- config.toml [walletconnect] 섹션이 "선택적 편의 기능"으로 재정의되어 있다
- waiaas init 안내 메시지가 CLI 수동 서명 대안을 포함하도록 변경되어 있다
- v0.5 Owner 모델 변경 노트가 추가되어 있다
- OWNR-02 (config.toml Owner 개념 제거) 요구사항이 충족되어 있다
  </done>
</task>

</tasks>

<verification>
Phase 19 Success Criteria와의 대응:
3. "agents 테이블 스키마에 owner_address 컬럼 추가, config.toml [owner] 섹션 제거, owner_wallets -> wallet_connections 전환" -> Task 1 (스키마) + Task 2 (config.toml)
</verification>

<success_criteria>
- agents.owner_address가 NOT NULL로 변경되고 인덱스가 추가됨
- wallet_connections 테이블이 owner_wallets를 대체하며 인증 역할 제거가 명시됨
- config.toml walletconnect가 선택적 편의 기능으로 재정의됨
- 마이그레이션 전략이 6단계로 명세됨
- Owner 주소 변경 정책이 masterAuth 단일 트랙으로 정의됨
- OWNR-01~04, AUTH-04 커버리지 완료
</success_criteria>

<output>
After completion, create `.planning/phases/19-auth-owner-redesign/19-02-SUMMARY.md`
</output>
