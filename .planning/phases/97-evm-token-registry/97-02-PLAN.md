---
phase: 97-evm-token-registry
plan: 02
type: tdd
wave: 2
depends_on: ["97-01"]
files_modified:
  - packages/daemon/src/api/routes/tokens.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/token-registry.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /v1/tokens?network=ethereum-mainnet returns built-in + custom tokens for the network"
    - "POST /v1/tokens with {network, address, symbol, name, decimals} adds a custom token (masterAuth required)"
    - "DELETE /v1/tokens with {network, address} removes a custom token (masterAuth required)"
    - "Built-in tokens cannot be deleted via DELETE /v1/tokens"
    - "Token registry is UX-only: adding a token to registry does NOT affect ALLOWED_TOKENS policy enforcement"
    - "Duplicate network+address on POST returns 409 conflict"
  artifacts:
    - path: "packages/daemon/src/api/routes/tokens.ts"
      provides: "Token registry CRUD route handlers"
      exports: ["tokenRegistryRoutes", "TokenRegistryRouteDeps"]
    - path: "packages/daemon/src/__tests__/token-registry.test.ts"
      provides: "Token registry service + API integration tests"
      min_lines: 80
  key_links:
    - from: "packages/daemon/src/api/routes/tokens.ts"
      to: "packages/daemon/src/infrastructure/token-registry/token-registry-service.ts"
      via: "TokenRegistryService dependency injection"
      pattern: "TokenRegistryService"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/tokens.ts"
      via: "route registration"
      pattern: "tokenRegistryRoutes"
---

<objective>
Create REST API endpoints for token registry CRUD and comprehensive tests covering the service + API layer.

Purpose: REGISTRY-02 requires users to add/delete custom tokens via API. REGISTRY-03 requires clear separation between registry (UX) and ALLOWED_TOKENS (security). This plan delivers the API layer and validates the full stack with TDD tests.
Output: Token registry routes, OpenAPI schemas, integration tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/97-evm-token-registry/97-01-SUMMARY.md
@packages/daemon/src/api/routes/wallets.ts (route pattern reference)
@packages/daemon/src/api/routes/openapi-schemas.ts (schema pattern reference)
@packages/daemon/src/api/server.ts (route registration reference)
@packages/daemon/src/api/routes/index.ts (barrel export reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Token registry API routes + OpenAPI schemas + server wiring</name>
  <files>
    packages/daemon/src/api/routes/tokens.ts
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
1. Add OpenAPI schemas to `packages/daemon/src/api/routes/openapi-schemas.ts`:

```typescript
// Token Registry schemas
export const TokenRegistryItemSchema = z.object({
  address: z.string(),
  symbol: z.string(),
  name: z.string(),
  decimals: z.number().int(),
  source: z.enum(['builtin', 'custom']),
}).openapi('TokenRegistryItem');

export const TokenRegistryListResponseSchema = z.object({
  network: z.string(),
  tokens: z.array(TokenRegistryItemSchema),
}).openapi('TokenRegistryListResponse');

export const AddTokenRequestSchema = z.object({
  network: z.string().openapi({ example: 'ethereum-mainnet' }),
  address: z.string().openapi({ example: '0x...' }),
  symbol: z.string().min(1).max(20).openapi({ example: 'LINK' }),
  name: z.string().min(1).max(100).openapi({ example: 'Chainlink Token' }),
  decimals: z.number().int().min(0).max(18).openapi({ example: 18 }),
}).openapi('AddTokenRequest');

export const AddTokenResponseSchema = z.object({
  id: z.string(),
  network: z.string(),
  address: z.string(),
  symbol: z.string(),
}).openapi('AddTokenResponse');

export const RemoveTokenRequestSchema = z.object({
  network: z.string(),
  address: z.string(),
}).openapi('RemoveTokenRequest');

export const RemoveTokenResponseSchema = z.object({
  removed: z.boolean(),
  network: z.string(),
  address: z.string(),
}).openapi('RemoveTokenResponse');
```

2. Create `packages/daemon/src/api/routes/tokens.ts`:

Define 3 OpenAPI routes following the established pattern in wallets.ts:
- `GET /tokens` with query param `network` (required) -> returns TokenRegistryListResponseSchema. Protected by masterAuth (all /v1/* under masterAuth prefix). Calls `tokenRegistryService.getTokensForNetwork(network)`.
- `POST /tokens` with body AddTokenRequestSchema -> returns 201 AddTokenResponseSchema. Validates that network is a valid EVM network type. Calls `tokenRegistryService.addCustomToken()`. On UNIQUE constraint violation (duplicate network+address), catch and throw WAIaaSError('ACTION_VALIDATION_FAILED') with 409-like message "Token already exists in registry".
- `DELETE /tokens` with body RemoveTokenRequestSchema -> returns RemoveTokenResponseSchema. Calls `tokenRegistryService.removeCustomToken()`. Returns `{ removed: true/false }`. If the user tries to remove a built-in token (which won't be in DB with source='custom'), `removed` will be false.

Export:
```typescript
export interface TokenRegistryRouteDeps {
  tokenRegistryService: TokenRegistryService;
}
export function tokenRegistryRoutes(deps: TokenRegistryRouteDeps): OpenAPIHono { ... }
```

3. Update `packages/daemon/src/api/routes/index.ts` barrel to export tokenRegistryRoutes.

4. Wire into `packages/daemon/src/api/server.ts`:
- Import TokenRegistryService and tokenRegistryRoutes
- Create TokenRegistryService instance in createApp (using the db dependency)
- Mount tokenRegistryRoutes on the masterAuth-protected v1 prefix (same as wallets, policies, admin routes)
- The routes should be mounted at `/v1` prefix alongside existing routes

NOTE: Use `EVM_NETWORK_TYPES` from `@waiaas/core` to validate network parameter in the GET and POST routes. If network is not a valid EVM network, return a validation error.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/daemon/tsconfig.json` to verify TypeScript compiles.
  </verify>
  <done>
- GET /v1/tokens?network= returns token list from registry
- POST /v1/tokens creates custom token, returns 201
- DELETE /v1/tokens removes custom token
- Routes registered in server.ts under masterAuth protection
- TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Token registry tests (service + API integration)</name>
  <files>
    packages/daemon/src/__tests__/token-registry.test.ts
  </files>
  <action>
Create comprehensive test file `packages/daemon/src/__tests__/token-registry.test.ts` with two test suites:

**Suite 1: TokenRegistryService unit tests** (use in-memory SQLite from test helpers)

Tests:
1. `getTokensForNetwork returns built-in tokens for ethereum-mainnet` - verify USDC, USDT, WETH, DAI present with correct source='builtin'
2. `getTokensForNetwork returns empty for unknown network` - verify returns []
3. `addCustomToken inserts to DB` - add a token, verify getTokensForNetwork includes it with source='custom'
4. `addCustomToken duplicate network+address throws` - add same token twice, expect error on second insert
5. `removeCustomToken removes custom token` - add then remove, verify gone from getTokensForNetwork
6. `removeCustomToken returns false for non-existent token` - try removing address that doesn't exist
7. `removeCustomToken cannot remove built-in tokens` - attempt to remove a built-in token address, verify returns false and token still in results
8. `custom token overrides built-in with same address` - add custom with same address as a built-in, verify getTokensForNetwork returns custom version
9. `getAdapterTokenList returns correct format` - verify returns array with {address, symbol, name, decimals} matching setAllowedTokens format
10. `tokens sorted alphabetically by symbol` - add tokens with various symbols, verify sort order

**Suite 2: Token registry API integration tests** (use createApp test pattern from existing tests like api-server.test.ts)

Tests:
1. `GET /v1/tokens?network=ethereum-mainnet returns built-in tokens` - verify 200 with tokens array
2. `GET /v1/tokens without network returns 400` - missing required query param
3. `POST /v1/tokens adds custom token` - verify 201 response, then GET returns it
4. `POST /v1/tokens with duplicate returns 409-like error` - add same token twice
5. `DELETE /v1/tokens removes custom token` - POST then DELETE, verify GET no longer has it
6. `DELETE /v1/tokens for built-in returns removed:false` - attempt to delete USDC
7. `POST /v1/tokens with invalid network returns validation error` - invalid network name

Use the same test setup pattern as existing daemon tests (in-memory SQLite, pushSchema, createApp).
All test data should use realistic ERC-20 token addresses.
  </action>
  <verify>
Run `npx vitest run packages/daemon/src/__tests__/token-registry.test.ts` -- all tests pass.
Run `npx vitest run packages/daemon/` -- no regressions.
  </verify>
  <done>
- 10+ service unit tests covering all TokenRegistryService methods
- 7+ API integration tests covering GET/POST/DELETE with edge cases
- All tests pass
- No regressions in existing daemon tests
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon/src/__tests__/token-registry.test.ts` passes (17+ tests)
2. `npx vitest run packages/daemon/` -- no regressions
3. `npx tsc --noEmit -p packages/daemon/tsconfig.json` passes
4. GET /v1/tokens?network=ethereum-mainnet returns USDC, USDT, WETH, DAI with source='builtin'
5. POST/DELETE cycle for custom tokens works correctly
6. Built-in tokens survive custom token operations
</verification>

<success_criteria>
- Token registry API is functional (GET/POST/DELETE)
- Comprehensive tests validate service logic and API behavior
- Registry role is clearly UX-only (tests confirm no interaction with ALLOWED_TOKENS)
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/97-evm-token-registry/97-02-SUMMARY.md`
</output>
