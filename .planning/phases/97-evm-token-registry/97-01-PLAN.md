---
phase: 97-evm-token-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/token-registry/builtin-tokens.ts
  - packages/daemon/src/infrastructure/token-registry/token-registry-service.ts
  - packages/daemon/src/infrastructure/token-registry/index.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/infrastructure/database/migrate.ts
autonomous: true

must_haves:
  truths:
    - "Built-in token data exists for all 5 EVM mainnet networks (ethereum, polygon, arbitrum, optimism, base) with USDC, USDT, WETH, DAI at minimum"
    - "DB token_registry table stores custom tokens with network/address/symbol/name/decimals/source"
    - "TokenRegistryService.getTokensForNetwork() returns built-in + custom tokens merged, with custom overriding built-in for same address"
    - "Migration v4 creates token_registry table for existing databases"
  artifacts:
    - path: "packages/daemon/src/infrastructure/token-registry/builtin-tokens.ts"
      provides: "Static built-in ERC-20 token data keyed by EvmNetworkType"
      contains: "BUILTIN_TOKENS"
    - path: "packages/daemon/src/infrastructure/token-registry/token-registry-service.ts"
      provides: "TokenRegistryService class with getTokensForNetwork, addCustomToken, removeCustomToken"
      exports: ["TokenRegistryService"]
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "tokenRegistry Drizzle table definition"
      contains: "tokenRegistry"
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "Migration v4 for token_registry table creation"
      contains: "version: 4"
  key_links:
    - from: "packages/daemon/src/infrastructure/token-registry/token-registry-service.ts"
      to: "packages/daemon/src/infrastructure/token-registry/builtin-tokens.ts"
      via: "imports BUILTIN_TOKENS"
      pattern: "BUILTIN_TOKENS"
    - from: "packages/daemon/src/infrastructure/token-registry/token-registry-service.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "queries tokenRegistry table"
      pattern: "tokenRegistry"
---

<objective>
Create the token registry infrastructure: built-in ERC-20 token data for 5 EVM mainnet networks, a DB table for custom tokens, and a service class that merges both sources.

Purpose: REGISTRY-01 requires the daemon to recognize major ERC-20 tokens per EVM network without any configuration. This plan creates the data layer and service that the API (plan 97-02) will expose.
Output: Built-in token data, Drizzle schema, migration v4, TokenRegistryService class.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/core/src/enums/chain.ts
@packages/adapters/evm/src/evm-chain-map.ts
@packages/adapters/evm/src/adapter.ts (lines 73-99, setAllowedTokens pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Built-in token data + DB schema + migration v4</name>
  <files>
    packages/daemon/src/infrastructure/token-registry/builtin-tokens.ts
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/infrastructure/database/migrate.ts
  </files>
  <action>
1. Create `packages/daemon/src/infrastructure/token-registry/builtin-tokens.ts`:

Define a `TokenEntry` interface:
```typescript
export interface TokenEntry {
  address: string;      // checksum EIP-55 address
  symbol: string;
  name: string;
  decimals: number;
}
```

Export `BUILTIN_TOKENS: Record<string, TokenEntry[]>` keyed by EvmNetworkType string.

Populate MAINNET tokens (at minimum):
- **ethereum-mainnet**: USDC (0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48, 6), USDT (0xdAC17F958D2ee523a2206206994597C13D831ec7, 6), WETH (0xC02aaA39b223FE8D0A0e5c4F27eAD9083C756Cc2, 18), DAI (0x6B175474E89094C44Da98b954EedeAC495271d0F, 18), LINK (0x514910771AF9Ca656af840dff83E8264EcF986CA, 18), UNI (0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984, 18)
- **polygon-mainnet**: USDC (0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359, 6), USDT (0xc2132D05D31c914a87C6611C10748AEb04B58e8F, 6), WETH (0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619, 18), DAI (0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063, 18), WMATIC (0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270, 18)
- **arbitrum-mainnet**: USDC (0xaf88d065e77c8cC2239327C5EDb3A432268e5831, 6), USDT (0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9, 6), WETH (0x82aF49447D8a07e3bd95BD0d56f35241523fBab1, 18), DAI (0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1, 18), ARB (0x912CE59144191C1204E64559FE8253a0e49E6548, 18)
- **optimism-mainnet**: USDC (0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85, 6), USDT (0x94b008aA00579c1307B0EF2c499aD98a8ce58e58, 6), WETH (0x4200000000000000000000000000000000000006, 18), DAI (0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1, 18), OP (0x4200000000000000000000000000000000000042, 18)
- **base-mainnet**: USDC (0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913, 6), WETH (0x4200000000000000000000000000000000000006, 18), DAI (0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb, 18)

For testnet networks (ethereum-sepolia, polygon-amoy, arbitrum-sepolia, optimism-sepolia, base-sepolia) provide empty arrays `[]`. Users can add testnet tokens via custom token API.

Export a helper: `export function getBuiltinTokens(network: string): TokenEntry[]` that returns the array for the given network or `[]` if not found.

2. Add `tokenRegistry` table to `packages/daemon/src/infrastructure/database/schema.ts`:

```typescript
export const tokenRegistry = sqliteTable(
  'token_registry',
  {
    id: text('id').primaryKey(),          // UUID v7
    network: text('network').notNull(),    // EvmNetworkType
    address: text('address').notNull(),    // EIP-55 checksum address
    symbol: text('symbol').notNull(),
    name: text('name').notNull(),
    decimals: integer('decimals').notNull(),
    source: text('source').notNull().default('custom'), // 'builtin' | 'custom'
    createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
  },
  (table) => [
    uniqueIndex('idx_token_registry_network_address').on(table.network, table.address),
    index('idx_token_registry_network').on(table.network),
    check('check_token_source', sql`source IN ('builtin', 'custom')`),
  ],
);
```

3. Add migration v4 to `packages/daemon/src/infrastructure/database/migrate.ts`:

```typescript
MIGRATIONS.push({
  version: 4,
  description: 'Create token_registry table for EVM token management',
  up: (sqlite) => {
    sqlite.exec(`CREATE TABLE IF NOT EXISTS token_registry (
  id TEXT PRIMARY KEY,
  network TEXT NOT NULL,
  address TEXT NOT NULL,
  symbol TEXT NOT NULL,
  name TEXT NOT NULL,
  decimals INTEGER NOT NULL,
  source TEXT NOT NULL DEFAULT 'custom' CHECK (source IN ('builtin', 'custom')),
  created_at INTEGER NOT NULL
)`);
    sqlite.exec('CREATE UNIQUE INDEX IF NOT EXISTS idx_token_registry_network_address ON token_registry(network, address)');
    sqlite.exec('CREATE INDEX IF NOT EXISTS idx_token_registry_network ON token_registry(network)');
  },
});
```

Update `LATEST_SCHEMA_VERSION` to 4.

Update `getCreateTableStatements()` to include the token_registry CREATE TABLE statement.

Update `getCreateIndexStatements()` to include the token_registry indexes.

Update the file header comment to say "10 tables" (was 9, but actually schema_version was already the 9th, and the header says 9 tables -- check the actual count and update accordingly; token_registry becomes a new table).
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/daemon/tsconfig.json` to verify TypeScript compiles.
Run existing migration tests: `npx vitest run packages/daemon/src/__tests__/migration-runner.test.ts`.
  </verify>
  <done>
- builtin-tokens.ts exports BUILTIN_TOKENS with 5+ tokens per mainnet network and getBuiltinTokens() helper
- schema.ts exports tokenRegistry Drizzle table with network+address unique index
- migrate.ts has migration v4 that creates token_registry table, LATEST_SCHEMA_VERSION=4
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: TokenRegistryService class + barrel export</name>
  <files>
    packages/daemon/src/infrastructure/token-registry/token-registry-service.ts
    packages/daemon/src/infrastructure/token-registry/index.ts
  </files>
  <action>
1. Create `packages/daemon/src/infrastructure/token-registry/token-registry-service.ts`:

```typescript
import type { BetterSQLite3Database } from 'drizzle-orm/better-sqlite3';
import { eq, and } from 'drizzle-orm';
import { tokenRegistry } from '../database/schema.js';
import type * as schema from '../database/schema.js';
import { getBuiltinTokens, type TokenEntry } from './builtin-tokens.js';
import { generateId } from '../database/id.js';

export interface RegistryToken extends TokenEntry {
  source: 'builtin' | 'custom';
}

export class TokenRegistryService {
  constructor(private readonly db: BetterSQLite3Database<typeof schema>) {}

  /**
   * Get all tokens for a network: built-in + custom merged.
   * Custom tokens with the same address as a built-in token override the built-in entry.
   * Returns tokens sorted by symbol alphabetically.
   */
  async getTokensForNetwork(network: string): Promise<RegistryToken[]> {
    // 1. Get built-in tokens
    const builtins = getBuiltinTokens(network);

    // 2. Get custom tokens from DB
    const customRows = await this.db
      .select()
      .from(tokenRegistry)
      .where(eq(tokenRegistry.network, network))
      .all();

    // 3. Merge: custom overrides built-in for same address (case-insensitive)
    const merged = new Map<string, RegistryToken>();

    for (const t of builtins) {
      merged.set(t.address.toLowerCase(), { ...t, source: 'builtin' });
    }

    for (const row of customRows) {
      merged.set(row.address.toLowerCase(), {
        address: row.address,
        symbol: row.symbol,
        name: row.name,
        decimals: row.decimals,
        source: row.source as 'builtin' | 'custom',
      });
    }

    // 4. Sort by symbol alphabetically
    return Array.from(merged.values()).sort((a, b) => a.symbol.localeCompare(b.symbol));
  }

  /**
   * Add a custom token to the registry.
   * If a token with the same network+address exists, throw error.
   * Address is stored as-is (caller should provide checksum).
   */
  async addCustomToken(
    network: string,
    token: TokenEntry,
  ): Promise<{ id: string }> {
    const id = generateId();
    const now = new Date(Math.floor(Date.now() / 1000) * 1000);

    await this.db.insert(tokenRegistry).values({
      id,
      network,
      address: token.address,
      symbol: token.symbol,
      name: token.name,
      decimals: token.decimals,
      source: 'custom',
      createdAt: now,
    });

    return { id };
  }

  /**
   * Remove a custom token by network + address.
   * Only custom tokens can be removed. Built-in tokens cannot be removed.
   * Returns true if a row was deleted, false if not found.
   */
  async removeCustomToken(network: string, address: string): Promise<boolean> {
    const result = await this.db
      .delete(tokenRegistry)
      .where(
        and(
          eq(tokenRegistry.network, network),
          eq(tokenRegistry.address, address),
          eq(tokenRegistry.source, 'custom'),
        ),
      )
      .run();

    return (result as unknown as { changes: number }).changes > 0;
  }

  /**
   * Get token list formatted for EvmAdapter.setAllowedTokens().
   * Returns all tokens (builtin + custom) for the given network.
   */
  async getAdapterTokenList(
    network: string,
  ): Promise<Array<{ address: string; symbol?: string; name?: string; decimals?: number }>> {
    const tokens = await this.getTokensForNetwork(network);
    return tokens.map((t) => ({
      address: t.address,
      symbol: t.symbol,
      name: t.name,
      decimals: t.decimals,
    }));
  }
}
```

2. Create barrel export `packages/daemon/src/infrastructure/token-registry/index.ts`:

```typescript
export { TokenRegistryService, type RegistryToken } from './token-registry-service.js';
export { getBuiltinTokens, BUILTIN_TOKENS, type TokenEntry } from './builtin-tokens.js';
```
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/daemon/tsconfig.json` to verify TypeScript compiles cleanly.
  </verify>
  <done>
- TokenRegistryService with getTokensForNetwork(), addCustomToken(), removeCustomToken(), getAdapterTokenList()
- Custom tokens override built-in for same address
- Barrel export from index.ts
- TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/daemon/tsconfig.json` passes
2. `npx vitest run packages/daemon/src/__tests__/migration-runner.test.ts` passes
3. `npx vitest run packages/daemon/src/__tests__/database.test.ts` passes (schema push includes new table)
4. Built-in tokens: ethereum-mainnet has >= 6 tokens, polygon/arbitrum/optimism >= 4, base >= 3
5. LATEST_SCHEMA_VERSION is 4
</verification>

<success_criteria>
- Token registry infrastructure exists: built-in data, DB table, migration, service class
- TypeScript compiles without errors
- Existing tests pass (no regression)
- Ready for API layer in plan 97-02
</success_criteria>

<output>
After completion, create `.planning/phases/97-evm-token-registry/97-01-SUMMARY.md`
</output>
