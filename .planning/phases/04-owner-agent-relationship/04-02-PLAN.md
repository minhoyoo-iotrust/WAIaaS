---
phase: 04-owner-agent-relationship
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/15-agent-lifecycle-management.md
autonomous: true

must_haves:
  truths:
    - "에이전트의 5단계 상태 모델(CREATING->ACTIVE->SUSPENDED->TERMINATING->TERMINATED)이 상태 전이 다이어그램과 함께 정의됨"
    - "각 상태별 온체인(Squads 멤버/Spending Limit) 및 오프체인(서버 DB) 매핑이 명확히 정의됨"
    - "키 로테이션 시 Drain-then-Rotate 패턴이 단계별로 정의되고 레이스 컨디션 방지책이 포함됨"
    - "에이전트 키 폐기 절차가 Squads RemoveMember와 키 메모리 삭제를 포함하여 정의됨"
    - "SUSPENDED 상태에서 Squads Spending Limit 비활성화 처리가 설계됨"
  artifacts:
    - path: ".planning/deliverables/15-agent-lifecycle-management.md"
      provides: "에이전트 생명주기 및 키 관리 설계 (REL-03)"
      contains: "AgentStatus"
  key_links:
    - from: "15-agent-lifecycle-management.md"
      to: "08-dual-key-architecture.md"
      via: "Agent Key 생성/로테이션/폐기가 Dual Key 아키텍처에 기반"
      pattern: "Agent Key.*Enclave\|Nitro"
    - from: "15-agent-lifecycle-management.md"
      to: "11-security-threat-model.md"
      via: "Circuit Breaker와 이상 탐지가 SUSPENDED 전환 트리거"
      pattern: "Circuit Breaker\|이상 탐지"
    - from: "15-agent-lifecycle-management.md"
      to: "09-system-components.md"
      via: "IKeyManagementService 인터페이스로 키 관리 작업 수행"
      pattern: "IKeyManagementService"
---

<objective>
에이전트 생명주기 관리 및 키 관리 설계 문서(REL-03)를 작성한다.

Purpose: 에이전트의 전체 생명주기(생성부터 폐기까지)를 유한 상태 머신으로 모델링하고, 각 상태 전환에 필요한 온체인/오프체인 작업, 키 로테이션 절차, 키 폐기 절차를 정의한다. 이 문서는 REL-04(비상 회수)와 REL-05(멀티 에이전트)의 기반이 된다.

Output: .planning/deliverables/15-agent-lifecycle-management.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 4 context (MUST READ - locked user decisions and research findings)
@.planning/phases/04-owner-agent-relationship/04-CONTEXT.md
@.planning/phases/04-owner-agent-relationship/04-RESEARCH.md

# Phase 3 deliverables (reference for Dual Key, system components, security)
@.planning/deliverables/08-dual-key-architecture.md
@.planning/deliverables/09-system-components.md
@.planning/deliverables/11-security-threat-model.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 에이전트 생명주기 및 키 관리 설계 문서 작성 (REL-03)</name>
  <files>.planning/deliverables/15-agent-lifecycle-management.md</files>
  <action>
  REL-03 에이전트 생명주기 관리 및 키 관리 설계 문서를 작성한다. 이 문서는 에이전트의 전체 생명주기를 다루는 핵심 설계 문서이며, 내용이 풍부해야 한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요 및 설계 원칙**
  - 에이전트 = Owner가 관리하는 자율적 온체인 행위자 (Squads 멀티시그 + Agent Key)
  - 핵심 원칙: 불가역 상태 전이(TERMINATED는 되돌릴 수 없음), Fail-safe(의심 시 정지), Owner 최종 권한

  **2. 에이전트 상태 모델 (State Machine)**
  - Mermaid 상태 전이 다이어그램 (stateDiagram-v2): 5개 상태 (CREATING, ACTIVE, SUSPENDED, TERMINATING, TERMINATED)
  - 각 상태별 정의 테이블:

  | 상태 | 서버 DB | Squads 온체인 | Spending Limit | 트랜잭션 허용 | 진입 조건 | 탈출 조건 |
  |------|---------|-------------|---------------|-------------|----------|----------|
  | CREATING | creating | 멤버 추가 중 | 미설정 | 불가 | 에이전트 생성 요청 | 모든 초기화 완료 |
  | ACTIVE | active | 멤버 등록됨 | 활성 | 정책 범위 내 | 초기화 완료 or 재활성화 | 정지/폐기 요청 |
  | SUSPENDED | suspended | 멤버 유지 | **비활성화(amount=0 또는 members에서 제거)** | 불가 | 이상 탐지/소유자 요청/Circuit Breaker | 재활성화 or 폐기 |
  | TERMINATING | terminating | 멤버 제거 진행 | 제거됨 | 불가 | 폐기 결정 | 모든 정리 완료 |
  | TERMINATED | terminated | 멤버 아님 | 없음 | 불가 | 정리 완료 | 없음 (최종) |

  - 상태 전환 규칙 상세 (어떤 주체가 어떤 조건에서 전환 가능한지):
    - CREATING -> ACTIVE: 시스템 자동 (모든 초기화 단계 성공 시)
    - ACTIVE -> SUSPENDED: 시스템 자동(Circuit Breaker, 이상 탐지) 또는 소유자 수동 요청
    - SUSPENDED -> ACTIVE: 소유자 수동 승인만 가능 (시스템 자동 재활성화 금지)
    - ACTIVE -> TERMINATING: 소유자 수동 요청만 가능
    - SUSPENDED -> TERMINATING: 소유자 수동 요청만 가능
    - TERMINATING -> TERMINATED: 시스템 자동 (모든 정리 단계 완료 시)

  **3. SUSPENDED 상태 온체인 보안 처리 (Pitfall 2 반영)**
  - 문제: SUSPENDED 시 Squads 멤버를 유지하면, Agent Key로 직접 SpendingLimitUse 호출 가능성 (이론적)
  - 해결책 설계: SUSPENDED 전환 시 Owner Key(configAuthority)로 RemoveSpendingLimit 또는 Spending Limit amount를 0으로 재설정
  - 재활성화 시: Spending Limit 재설정 (AddSpendingLimit)
  - 위험도 분석: Agent Key는 Enclave/서버 내에서만 사용 가능하므로 외부 호출 가능성 극히 낮음. 그러나 defense-in-depth 원칙으로 온체인에서도 비활성화
  - Mermaid 시퀀스 다이어그램: SUSPENDED 전환 시 온체인 Spending Limit 비활성화 흐름

  **4. 에이전트 생성 프로세스 (상세 플로우)**
  - Mermaid 시퀀스 다이어그램: 전체 생성 플로우
  - 단계:
    1. API 요청 수신 (필수 입력: 예산 한도, 보충 모드, 허용 토큰)
    2. 에이전트 레코드 생성 (DB, status=CREATING)
    3. Squads 멀티시그 생성 (Owner Key = configAuthority, threshold=2)
    4. Agent Key 생성 (Enclave 내부 또는 서버 메모리)
    5. Squads AddMember(Agent Key, Permissions: Vote + Execute)
    6. Squads AddSpendingLimit (에이전트별 예산 한도 설정)
    7. 초기 자금 충전 (13-fund-deposit-process.md 참조)
    8. status=ACTIVE 전환, lastActiveAt 기록
  - 각 단계 실패 시 롤백 절차 (부분 생성 상태 정리)
  - 기본값 정책 (04-RESEARCH.md Discretion #3 기반): 보충 모드=MANUAL, 화이트리스트=빈 목록, 운영 시간=24/7, 비활성 타임아웃=60분

  **5. 에이전트 폐기(Termination) 프로세스 (상세 플로우)**
  - Mermaid 시퀀스 다이어그램: TERMINATING 상태의 전체 플로우
  - 단계:
    1. 소유자 폐기 요청 -> status=TERMINATING
    2. 새 트랜잭션 즉시 차단 (서버 레벨)
    3. 진행 중 트랜잭션 처리: (a) 온체인 제출 완료 건 -> 결과 대기(2분 타임아웃), (b) 서명 전 건 -> 즉시 거부, (c) Squads Proposal 미실행 건 -> stale 처리
    4. Squads RemoveSpendingLimit (모든 Spending Limit 제거)
    5. Squads ChangeThreshold(1) (Owner 단독 작업 가능하게)
    6. Vault 잔액 전액 소유자 회수 (14-fund-withdrawal-process.md 참조)
    7. Squads RemoveMember(Agent Key)
    8. Agent Key 메모리 삭제 (Enclave: 키 파기 / 셀프호스트: 키스토어 파일 삭제)
    9. status=TERMINATED, 감사 로그 기록
  - 각 단계 실패 시 대응 (예: ChangeThreshold 실패 시 재시도, 자금 회수 실패 시 소유자 알림)
  - TERMINATING -> TERMINATED는 모든 단계 성공 시에만 전환

  **6. 키 로테이션 프로세스 (Drain-then-Rotate)**
  - Mermaid 시퀀스 다이어그램: 전체 로테이션 플로우
  - Drain-then-Rotate 패턴 (04-RESEARCH.md Discretion #5 기반):
    1. ACTIVE -> SUSPENDED 전환 (새 요청 차단)
    2. Squads Spending Limit 비활성화 (SUSPENDED 보안 처리)
    3. 진행 중 트랜잭션 완료 대기 (타임아웃: 2분)
    4. Squads Proposal 미실행 건 stale 처리
    5. 새 Agent Key 생성 (Enclave 내부)
    6. Squads AddMember(새 Agent Key)
    7. Squads RemoveMember(기존 Agent Key)
    8. 기존 Agent Key 메모리 삭제
    9. Squads Spending Limit 재설정 (새 Agent Key를 members에 포함)
    10. SUSPENDED -> ACTIVE 전환 (소유자 승인)
  - 레이스 컨디션 방지 (Pitfall 3 반영):
    - AddMember와 RemoveMember 사이 실패 시 롤백 절차 (두 키가 동시 존재하는 상태의 처리)
    - Agent Key 로테이션 중 에이전트 ID는 불변 (키만 교체)
  - 정기 로테이션 (90일) vs 긴급 로테이션 (이상 징후) 트리거
  - keyRotatedAt 타임스탬프 업데이트

  **7. 에이전트 데이터 모델**
  - Agent TypeScript 인터페이스 (04-RESEARCH.md 기반, 필요시 확장)
  - AgentStatus enum (5개 상태)
  - AgentStatusTransition 이력 인터페이스: fromStatus, toStatus, reason, triggeredBy(system/owner), timestamp
  - PostgreSQL 스키마 (Prisma 모델): agents 테이블, agent_status_history 테이블
  - Redis 캐시 키 정의: agent:{agentId}:status, agent:{agentId}:last_heartbeat

  **8. Heartbeat 및 비활성 감지**
  - Heartbeat 메커니즘: 에이전트가 주기적으로 서버에 heartbeat 전송 (기본 30초)
  - 비활성 타임아웃: 설정 가능 (기본 60분), 초과 시 자동 SUSPENDED + 소유자 알림
  - Redis 기반 실시간 모니터링: agent:{agentId}:last_heartbeat TTL 관리
  - 타임아웃 != 자동 회수 (비활성으로 SUSPENDED만 할 뿐, 자금 회수는 소유자 수동)

  각 주요 프로세스에 Mermaid 다이어그램을 포함할 것 (최소 5개: 상태 전이도, 생성 플로우, 폐기 플로우, 키 로테이션, SUSPENDED 온체인 처리).
  Phase 3 문서(08, 09, 11)와의 연결 참조를 명시할 것.
  04-RESEARCH.md의 Pattern 3 (상태 머신)과 Pitfall 2, 3를 반드시 반영할 것.
  </action>
  <verify>
  파일 존재 확인: ls .planning/deliverables/15-agent-lifecycle-management.md
  5개 상태: grep -c "CREATING\|ACTIVE\|SUSPENDED\|TERMINATING\|TERMINATED" .planning/deliverables/15-agent-lifecycle-management.md (10 이상, 각 상태가 여러 번 언급)
  상태 전이 다이어그램: grep -c "stateDiagram" .planning/deliverables/15-agent-lifecycle-management.md (1 이상)
  Mermaid 다이어그램 총 수: grep -c "```mermaid" .planning/deliverables/15-agent-lifecycle-management.md (5 이상)
  키 로테이션: grep -c "Drain-then-Rotate\|키 로테이션\|key rotation" .planning/deliverables/15-agent-lifecycle-management.md (3 이상)
  Pitfall 2 반영: grep -c "SpendingLimit.*비활성\|amount.*0\|RemoveSpendingLimit" .planning/deliverables/15-agent-lifecycle-management.md (1 이상)
  Pitfall 3 반영: grep -c "레이스.*컨디션\|race condition\|AddMember.*RemoveMember" .planning/deliverables/15-agent-lifecycle-management.md (1 이상)
  TypeScript 인터페이스: grep -c "interface Agent\|enum AgentStatus" .planning/deliverables/15-agent-lifecycle-management.md (2 이상)
  Heartbeat: grep -c "heartbeat\|비활성.*타임아웃" .planning/deliverables/15-agent-lifecycle-management.md (2 이상)
  </verify>
  <done>
  - 5단계 에이전트 상태 모델이 Mermaid 상태 전이 다이어그램으로 시각화됨
  - 각 상태별 온체인/오프체인 매핑과 전환 규칙이 테이블로 정의됨
  - SUSPENDED 상태의 Squads Spending Limit 비활성화 처리가 설계됨 (Pitfall 2)
  - 에이전트 생성 8단계 프로세스가 롤백 절차와 함께 정의됨
  - 에이전트 폐기 9단계 프로세스가 ChangeThreshold 순서 포함하여 정의됨
  - Drain-then-Rotate 키 로테이션 10단계가 레이스 컨디션 방지와 함께 설계됨 (Pitfall 3)
  - 에이전트 데이터 모델이 TypeScript 인터페이스와 Prisma 스키마로 정의됨
  - Heartbeat/비활성 감지 메커니즘이 설계됨
  - 최소 5개의 Mermaid 다이어그램이 포함됨
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 02 전체 검증:
1. 문서가 .planning/deliverables/에 존재: ls .planning/deliverables/15-agent-lifecycle-management.md
2. 5단계 상태 모델이 상태 전이 다이어그램과 상세 정의 테이블로 문서화됨
3. SUSPENDED 온체인 보안 처리(Spending Limit 비활성화)가 설계됨
4. 생성/폐기/키 로테이션 3가지 핵심 프로세스가 각각 시퀀스 다이어그램과 함께 정의됨
5. 레이스 컨디션 방지, threshold 순서, 롤백 절차 등 엣지 케이스가 처리됨
6. 데이터 모델(TypeScript + Prisma)이 정의됨
7. 총 Mermaid 다이어그램 5개 이상
</verification>

<success_criteria>
- REL-03 충족: 에이전트 키 폐기 및 교체 절차가 명시됨
- 5단계 상태 모델이 온체인/오프체인 매핑과 함께 완전히 정의됨
- Drain-then-Rotate 키 로테이션이 레이스 컨디션 방지와 함께 설계됨
- SUSPENDED 상태의 보안 구멍(Pitfall 2)이 해결됨
- 에이전트 생성/폐기 프로세스가 실패 시 롤백 포함하여 정의됨
- Phase 3 설계(Dual Key, Security Threat Model)와의 연결이 명확함
</success_criteria>

<output>
After completion, create `.planning/phases/04-owner-agent-relationship/04-02-SUMMARY.md`
</output>
