---
phase: 04-owner-agent-relationship
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - .planning/deliverables/16-emergency-recovery.md
  - .planning/deliverables/17-multi-agent-management.md
autonomous: true

must_haves:
  truths:
    - "비상 회수 4가지 트리거(수동/Circuit Breaker/이상 탐지/비활성 타임아웃)가 각각의 자동화 수준과 함께 정의됨"
    - "비상 회수 시 대기 트랜잭션 3단계 분류(서명 전/서명 완료 미제출/제출 완료 미확정) 처리 방법이 명시됨"
    - "가디언 메커니즘(소유자 키 분실 대비 복구 경로)이 클라우드/셀프호스트별로 정의됨"
    - "Hub-and-Spoke 멀티 에이전트 구조가 다이어그램과 함께 설계됨"
    - "에이전트 간 자금 이동 절차가 Owner Key 서명 기반으로 정의됨"
    - "전체 에이전트 합산 예산 한도(Owner-level aggregate)가 서버 레벨로 설계됨"
    - "통합 대시보드 API 데이터 모델(OwnerDashboard, AgentSummary)이 TypeScript 인터페이스로 정의됨"
  artifacts:
    - path: ".planning/deliverables/16-emergency-recovery.md"
      provides: "비상 자금 회수 메커니즘 설계 (REL-04)"
      contains: "EmergencyTrigger"
    - path: ".planning/deliverables/17-multi-agent-management.md"
      provides: "멀티 에이전트 관리 모델 설계 (REL-05)"
      contains: "Hub-and-Spoke"
  key_links:
    - from: "16-emergency-recovery.md"
      to: "14-fund-withdrawal-process.md"
      via: "비상 회수는 자금 회수 메커니즘(Spending Limit/Threshold 방식)을 재사용"
      pattern: "14-fund-withdrawal\|회수.*메커니즘"
    - from: "16-emergency-recovery.md"
      to: "15-agent-lifecycle-management.md"
      via: "비상 트리거가 SUSPENDED 상태 전환을 유발"
      pattern: "SUSPENDED\|상태 전환"
    - from: "16-emergency-recovery.md"
      to: "11-security-threat-model.md"
      via: "Circuit Breaker와 이상 탐지 규칙이 비상 트리거로 연결"
      pattern: "Circuit Breaker\|이상 탐지"
    - from: "17-multi-agent-management.md"
      to: "13-fund-deposit-process.md"
      via: "에이전트별 예산 할당이 충전 프로세스를 통해 이루어짐"
      pattern: "예산.*할당\|충전"
    - from: "17-multi-agent-management.md"
      to: "15-agent-lifecycle-management.md"
      via: "멀티 에이전트 일괄 작업이 개별 에이전트 생명주기를 기반으로 함"
      pattern: "생명주기\|lifecycle"
---

<objective>
비상 자금 회수 메커니즘(REL-04)과 멀티 에이전트 관리 모델(REL-05) 설계 문서를 작성한다.

Purpose: 에이전트 장애나 보안 사고 시 자금을 안전하게 복구하는 비상 절차를 정의하고, 한 소유자가 다수의 에이전트를 효율적으로 관리하는 운영 모델을 설계한다. 두 문서 모두 Plan 01(자금 충전/회수)과 Plan 02(에이전트 생명주기)의 설계를 기반으로 한다.

Output: .planning/deliverables/16-emergency-recovery.md, .planning/deliverables/17-multi-agent-management.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 4 context (MUST READ - locked user decisions and research findings)
@.planning/phases/04-owner-agent-relationship/04-CONTEXT.md
@.planning/phases/04-owner-agent-relationship/04-RESEARCH.md

# Prior plan summaries from this phase (MUST READ - depend on these)
@.planning/phases/04-owner-agent-relationship/04-01-SUMMARY.md
@.planning/phases/04-owner-agent-relationship/04-02-SUMMARY.md

# Phase 3 deliverables (reference)
@.planning/deliverables/08-dual-key-architecture.md
@.planning/deliverables/11-security-threat-model.md

# Phase 4 Plan 01/02 deliverables (MUST READ - direct dependencies)
@.planning/deliverables/13-fund-deposit-process.md
@.planning/deliverables/14-fund-withdrawal-process.md
@.planning/deliverables/15-agent-lifecycle-management.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 비상 자금 회수 메커니즘 설계 문서 작성 (REL-04)</name>
  <files>.planning/deliverables/16-emergency-recovery.md</files>
  <action>
  REL-04 비상 자금 회수 메커니즘 설계 문서를 작성한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요 및 설계 원칙**
  - 비상 회수 = 에이전트 장애, 키 탈취 의심, 시스템 이상 시 자금을 안전하게 복구하는 절차
  - 핵심 원칙: 자동 정지(SUSPENDED) + 수동 회수(Owner 판단), 시스템은 자금 이동 결정을 하지 않음
  - Solana 생태계 제약: 전용 dead man's switch 없음, 온체인 제출된 트랜잭션 취소 불가

  **2. 비상 트리거 유형 (상세 테이블)**
  04-RESEARCH.md Pattern 4 기반, 4가지 트리거:

  | 트리거 | 주체 | 조건 | 자동화 수준 | 자동 SUSPEND | 자동 회수 | 소유자 알림 |
  |--------|------|------|------------|------------|---------|------------|
  | 수동 회수 | 소유자 | 소유자 판단 | MFA 인증 후 즉시 | 선택 | 아니오(소유자가 직접) | 확인 알림 |
  | Circuit Breaker | 시스템 | 연속 5회 tx 실패 | 자동 | 예 | 아니오 | 즉시 알림 |
  | 이상 탐지 | 시스템 | 규칙 기반 이상 행위 | 자동 | 예 | 아니오 | 즉시 알림 |
  | 비활성 타임아웃 | 시스템 | heartbeat 미응답 | 설정 가능 | 예 | 아니오 | 경고 알림 |

  - 각 트리거의 EmergencyTrigger TypeScript 인터페이스 정의
  - 트리거 우선순위 및 중복 트리거 처리 (이미 SUSPENDED인 에이전트에 대한 추가 트리거)

  **3. 비상 회수 전체 절차 (시퀀스 다이어그램)**
  - Mermaid 시퀀스 다이어그램: 트리거 발생 -> SUSPENDED -> 대기 tx 처리 -> Owner 알림 -> Owner 회수 결정 -> 자금 이동 -> 후속 조치
  - 5단계 흐름:
    1. 트리거 발생 -> 에이전트 즉시 SUSPENDED (15-agent-lifecycle-management.md의 SUSPENDED 전환 절차 참조)
    2. Squads Spending Limit 비활성화 (15번 문서의 SUSPENDED 온체인 처리)
    3. 대기 트랜잭션 분류 처리 (아래 섹션 4 상세)
    4. 소유자에게 상황 알림 (트리거 유형, 에이전트 상태, Vault 잔액, 권장 조치)
    5. 소유자 판단 -> 회수 실행 (14-fund-withdrawal-process.md의 회수 메커니즘 사용) 또는 재활성화

  **4. 대기 트랜잭션 처리 방침 (Pitfall 6 반영)**
  - 3단계 분류 테이블:

  | 상태 | 설명 | 처리 방법 | 자금 위험 |
  |------|------|----------|---------|
  | 서명 전 (서버 큐) | 아직 서명되지 않은 요청 | 즉시 REJECTED 응답 | 없음 |
  | 서명 완료, 미제출 | 서명됨, Solana에 미제출 | 제출 안 함, blockhash 만료 대기 | 없음 |
  | 제출 완료, 미확정 | Solana에 제출됨, 블록 미포함 | 취소 불가, 결과 모니터링 | 해당 tx 금액만큼 위험 |

  - Solana blockhash 만료 시간: ~90초 (150 슬롯 * 0.6초)
  - PendingTxPolicy 인터페이스 정의
  - Squads Spending Limits가 기간당 총액을 제한하므로 연쇄 손실 방지됨을 명시
  - 제한 사항 명시: "비상 회수 시 모든 자금을 즉시 보호할 수 없음 - 이미 제출된 트랜잭션은 온체인 확정될 수 있음"

  **5. 자금 회수 실행 (14번 문서 메커니즘 재사용)**
  - 비상 회수 시 사용할 Squads Vault 자금 이동 방법:
    - 방법 A (권장): Spending Limit을 Owner에게 할당 -> SpendingLimitUse로 직접 인출
    - 방법 B: ChangeThreshold(1) -> Owner 단독 Vault Transaction
  - 14-fund-withdrawal-process.md의 메커니즘을 참조하되, 비상 상황에서의 차이점 명시:
    - 일반 회수: 부분/전액 선택 가능
    - 비상 회수: 전액 회수 권장 (잔여 위험 최소화)
  - 회수 목적지: EmergencyRecoveryConfig.recoveryDestination (사전 등록된 소유자 주소)

  **6. 가디언 메커니즘 (소유자 키 분실 대비)**
  04-RESEARCH.md Discretion #8 기반:
  - 클라우드 환경:
    - AWS KMS 키는 IAM Role 기반 -> Root 계정이 항상 접근 가능
    - IAM 접근 자체 분실 시: AWS 계정 복구 절차 -> IAM 복구 -> KMS 접근 회복
    - 복구 경로 플로우차트 (Mermaid)
  - 셀프호스트 환경:
    - 비밀번호 분실 시 복구 불가 (설계상 의도)
    - 필수 안전 조치: 별도 안전한 위치에 비밀번호 백업 (문서에 명시적 경고)
  - 가디언 메커니즘은 소유자 키 복구에 한정. 에이전트 키는 Owner가 새로 생성 가능 (configAuthority 권한)

  **7. EmergencyRecoveryConfig 데이터 모델**
  - EmergencyRecoveryConfig TypeScript 인터페이스 (04-RESEARCH.md 기반)
  - EmergencyTrigger 인터페이스
  - PendingTxPolicy enum
  - EmergencyRecoveryLog: 비상 회수 이력 (trigger_type, agent_id, vault_balance_at_trigger, recovered_amount, pending_tx_count, duration)
  - PostgreSQL 스키마: emergency_recovery_logs 테이블

  **8. 비상 회수 시나리오별 대응 매트릭스**
  주요 시나리오 테이블:
  - Agent Key 탈취 의심 -> 즉시 SUSPENDED + Spending Limit 비활성화 + 전액 회수 + 키 폐기
  - 서버 장애 -> Circuit Breaker 자동 발동 + 소유자 알림 + 수동 회수 대기
  - Enclave 장애 -> Fail-safe로 모든 tx 거부 + 소유자 알림 + 복구 후 재활성화
  - 네트워크 장애 (Solana) -> tx 제출 실패 -> 자동 정지 + 복구 후 재활성화
  - 에이전트 비활성 -> 타임아웃 후 SUSPENDED + 소유자 확인 후 재활성화 또는 폐기

  각 주요 흐름에 Mermaid 다이어그램을 포함할 것 (최소 3개: 비상 회수 전체 흐름, 대기 tx 처리, 가디언 복구 경로).
  14-fund-withdrawal-process.md와 15-agent-lifecycle-management.md를 직접 참조할 것.
  11-security-threat-model.md의 위협 대응 체계와의 연결을 명시할 것.
  </action>
  <verify>
  파일 존재 확인: ls .planning/deliverables/16-emergency-recovery.md
  4가지 트리거: grep -c "수동 회수\|Circuit Breaker\|이상 탐지\|비활성 타임아웃\|inactivity_timeout" .planning/deliverables/16-emergency-recovery.md (4 이상)
  대기 tx 3단계: grep -c "서명 전\|서명 완료.*미제출\|제출 완료.*미확정\|REJECTED\|blockhash" .planning/deliverables/16-emergency-recovery.md (3 이상)
  가디언 메커니즘: grep -c "가디언\|Guardian\|KMS.*복구\|IAM.*복구" .planning/deliverables/16-emergency-recovery.md (2 이상)
  Mermaid 다이어그램: grep -c "```mermaid" .planning/deliverables/16-emergency-recovery.md (3 이상)
  TypeScript 인터페이스: grep -c "interface.*Emergency\|interface.*Trigger\|enum.*PendingTx" .planning/deliverables/16-emergency-recovery.md (2 이상)
  상호 참조: grep -c "14-fund-withdrawal\|15-agent-lifecycle\|11-security-threat" .planning/deliverables/16-emergency-recovery.md (3 이상)
  시나리오 매트릭스: grep -c "탈취\|서버 장애\|Enclave 장애\|네트워크 장애\|비활성" .planning/deliverables/16-emergency-recovery.md (4 이상)
  </verify>
  <done>
  - 4가지 비상 트리거가 자동화 수준, 소유자 알림 여부와 함께 상세 정의됨
  - 비상 회수 전체 5단계 절차가 시퀀스 다이어그램과 함께 정의됨
  - 대기 트랜잭션 3단계 분류 처리 방침이 Solana 제약(취소 불가, blockhash 만료)과 함께 명시됨
  - 가디언 메커니즘이 클라우드/셀프호스트 환경별로 복구 경로와 함께 설계됨
  - EmergencyRecoveryConfig 데이터 모델이 TypeScript 인터페이스로 정의됨
  - 5가지 비상 시나리오별 대응 매트릭스가 작성됨
  - 최소 3개의 Mermaid 다이어그램이 포함됨
  </done>
</task>

<task type="auto">
  <name>Task 2: 멀티 에이전트 관리 모델 설계 문서 작성 (REL-05)</name>
  <files>.planning/deliverables/17-multi-agent-management.md</files>
  <action>
  REL-05 멀티 에이전트 관리 모델 설계 문서를 작성한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요 및 설계 원칙**
  - 한 소유자가 다수의 에이전트를 운영하는 모델
  - 사용자 결정 반영: 에이전트 간 자금 이동 허용(정책 범위 내), 역할 구분 불필요(예산 한도로만 구분), 통합 대시보드 필요(API 지원)
  - 핵심 원칙: 에이전트 간 자금 격리(독립 Vault), 중앙 제어(Owner Key), 합산 예산 관리

  **2. Hub-and-Spoke 아키텍처 (다이어그램 포함)**
  04-RESEARCH.md Pattern 1 기반:
  - Mermaid 다이어그램: Owner Key(중앙) -> 다수의 Squads 멀티시그(스포크)
  - 구조 설명:
    - Hub: Owner Key (AWS KMS) = 모든 Squads 멀티시그의 configAuthority
    - Spoke: 각 에이전트별 독립 Squads 멀티시그 + Vault
  - 장점: 에이전트 간 자금 격리, 독립 Spending Limit, 개별 상태 관리
  - Anti-pattern: 단일 Squads 멀티시그에 다수 에이전트 등록 금지 (자금 격리 불가)
  - 확장성: 에이전트 추가 시 새 멀티시그 생성만 하면 됨 (Hub 변경 불필요)

  **3. 에이전트 간 자금 이동 (시퀀스 다이어그램)**
  - Mermaid 시퀀스 다이어그램: Source Agent Vault -> Owner Key 서명 -> Destination Agent Vault
  - 이동 절차:
    1. 소유자가 이동 요청 (source_agent, dest_agent, amount, mint)
    2. 서버 정책 검증 (양쪽 에이전트 상태=ACTIVE, 합산 한도 미초과, 화이트리스트)
    3. Source Vault에서 인출: Owner Key 서명으로 Spending Limit 사용 또는 Threshold 변경
    4. Destination Vault로 입금: Vault PDA 주소로 단순 전송
    5. 양쪽 잔액 업데이트 (DB + Redis)
  - 제약사항: Owner Key 서명 필수 (에이전트 간 직접 이동 불가), ACTIVE 상태 에이전트만 참여 가능
  - Open Question 반영: Vault A -> Vault B 직접 이동 vs 소유자 지갑 경유 (두 가지 방식 모두 설계, 구현 시 확인)

  **4. 전체 에이전트 합산 예산 한도 (Owner-level Aggregate)**
  04-RESEARCH.md Discretion #10 기반:
  - 설계: 서버 레벨 구현 (Squads는 개별 멀티시그 단위만 관리)
  - GlobalBudgetLimit TypeScript 인터페이스 (04-RESEARCH.md 기반)
  - Redis 기반 실시간 합산 추적:
    - 키: owner:{ownerId}:daily_spend, owner:{ownerId}:weekly_spend, owner:{ownerId}:monthly_spend
    - 갱신: 에이전트 트랜잭션 성공 시 INCRBY, 기간 만료 시 TTL로 자동 리셋
  - 합산 한도 초과 시: 모든 에이전트의 새 트랜잭션 거부 (개별 Spending Limit과 무관)
  - 합산 한도 설정: 소유자가 일일/주간/월간 합산 한도 지정
  - 합산 한도와 개별 한도의 관계: 개별 한도 합계가 합산 한도를 초과할 수 있음 (유연성). 실제 사용은 합산 한도로 제한

  **5. 에이전트 일괄 관리 작업**
  - 일괄 정지 (Batch Suspend): 소유자가 모든/선택 에이전트를 한번에 SUSPENDED로 전환
  - 일괄 예산 조정: 모든 에이전트의 Spending Limit을 비례 조정 (예: 전체 20% 감축)
  - 일괄 키 로테이션: 모든 에이전트의 Agent Key를 순차적으로 로테이션 (15-agent-lifecycle-management.md의 Drain-then-Rotate)
  - 각 일괄 작업의 실행 전략: 순차(안전) vs 병렬(속도) vs 혼합
  - 실패 처리: 부분 성공 시 결과 리포트 (성공/실패 에이전트 목록)

  **6. 통합 대시보드 데이터 모델 (API 지원)**
  - OwnerDashboard TypeScript 인터페이스 (04-RESEARCH.md 기반, 필요시 확장):
    - 전체 에이전트 합산 정보 (totalAgents, activeAgents, suspendedAgents, totalBalance, totalSpentToday)
    - GlobalBudgetLimit (합산 한도 및 현재 사용액)
    - agents: AgentSummary[] (에이전트별 상세)
  - AgentSummary 인터페이스: agentId, status, vaultBalance, spentToday, remainingDailyLimit, lastTransactionAt, alertCount
  - 데이터 소스 매핑:
    - 실시간 데이터 (Redis): 잔액, 사용액, 상태
    - 온체인 확인 (주기적): Vault 잔액 검증, Spending Limit remaining_amount 동기화
    - DB (Prisma): 에이전트 메타데이터, 이력, 설정
  - API 엔드포인트 스케치 (Phase 5에서 상세화):
    - GET /api/v1/owner/dashboard - 전체 요약
    - GET /api/v1/owner/agents - 에이전트 목록
    - GET /api/v1/owner/agents/:id - 에이전트 상세

  **7. 에이전트 네이밍 및 식별**
  - 에이전트 역할 구분 불필요 (사용자 결정) -> 예산 한도로만 구분
  - 에이전트 식별자: UUID (내부) + 사용자 지정 별명 (선택, 대시보드 표시용)
  - 에이전트 태그/레이블 (선택): 소유자가 자유롭게 태그 부여 (예: "trading", "payment")

  **8. 멀티 에이전트 보안 고려사항**
  - 하나의 에이전트 침해가 다른 에이전트에 미치는 영향: 독립 Vault로 격리 -> 직접 영향 없음
  - Owner Key 침해 시: 모든 에이전트의 configAuthority가 동일 -> 전체 위험. 대응: Owner Key는 KMS(FIPS 140-2 Level 3)로 보호
  - 합산 한도의 보안 역할: 단일 에이전트 한도를 넘지 않더라도 전체 합산으로 과다 사용 방지
  - 에이전트 간 자금 이동의 악용 방지: 서버 정책으로 이동 빈도/금액 제한

  각 주요 구조/흐름에 Mermaid 다이어그램을 포함할 것 (최소 3개: Hub-and-Spoke 구조, 에이전트 간 자금 이동, 합산 한도 검증 흐름).
  13-fund-deposit-process.md, 15-agent-lifecycle-management.md를 직접 참조할 것.
  사용자 결정(에이전트 간 이동 허용, 역할 구분 불필요, 통합 대시보드 필요)을 충실히 반영할 것.
  </action>
  <verify>
  파일 존재 확인: ls .planning/deliverables/17-multi-agent-management.md
  Hub-and-Spoke: grep -c "Hub-and-Spoke\|Hub.*Spoke\|configAuthority" .planning/deliverables/17-multi-agent-management.md (3 이상)
  에이전트 간 이동: grep -c "에이전트 간.*이동\|inter-agent\|Source.*Vault.*Destination" .planning/deliverables/17-multi-agent-management.md (2 이상)
  합산 한도: grep -c "합산.*한도\|GlobalBudgetLimit\|owner-level aggregate" .planning/deliverables/17-multi-agent-management.md (3 이상)
  대시보드 데이터 모델: grep -c "OwnerDashboard\|AgentSummary" .planning/deliverables/17-multi-agent-management.md (2 이상)
  Mermaid 다이어그램: grep -c "```mermaid" .planning/deliverables/17-multi-agent-management.md (3 이상)
  사용자 결정 반영: grep -c "역할 구분.*불필요\|예산 한도로만\|통합 대시보드" .planning/deliverables/17-multi-agent-management.md (2 이상)
  상호 참조: grep -c "13-fund-deposit\|15-agent-lifecycle" .planning/deliverables/17-multi-agent-management.md (2 이상)
  API 엔드포인트: grep -c "/api/v1/owner" .planning/deliverables/17-multi-agent-management.md (2 이상)
  </verify>
  <done>
  - Hub-and-Spoke 멀티 에이전트 아키텍처가 다이어그램과 함께 설계됨
  - 에이전트 간 자금 이동 절차가 Owner Key 서명 기반으로 5단계 정의됨
  - 전체 에이전트 합산 예산 한도가 Redis 기반 실시간 추적과 함께 설계됨
  - 통합 대시보드 데이터 모델(OwnerDashboard, AgentSummary)이 TypeScript 인터페이스로 정의됨
  - 일괄 관리 작업(정지, 예산 조정, 키 로테이션)이 실행 전략과 함께 정의됨
  - 멀티 에이전트 보안 고려사항(격리, Owner Key 침해, 악용 방지)이 분석됨
  - 최소 3개의 Mermaid 다이어그램이 포함됨
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 03 전체 검증:
1. 두 문서가 .planning/deliverables/에 존재: ls .planning/deliverables/16-emergency-recovery.md .planning/deliverables/17-multi-agent-management.md
2. 16번 문서에 4가지 비상 트리거, 대기 tx 처리, 가디언 메커니즘, 시나리오 매트릭스가 설계됨
3. 17번 문서에 Hub-and-Spoke 구조, 에이전트 간 이동, 합산 한도, 대시보드 모델이 설계됨
4. 두 문서 모두 Plan 01/02의 산출물(13, 14, 15번 문서)을 참조함
5. 총 Mermaid 다이어그램 6개 이상 (16번 3+, 17번 3+)
6. 사용자 결정(CONTEXT.md)이 충실히 반영됨
</verification>

<success_criteria>
- REL-04 충족: 에이전트 장애 시 자금 복구 방법이 설계됨
- REL-05 충족: 한 소유자가 다수 에이전트를 관리하는 모델이 정의됨
- 비상 회수: 4가지 트리거, 대기 tx 3단계 처리, 가디언 메커니즘 포함
- 멀티 에이전트: Hub-and-Spoke, 에이전트 간 이동, 합산 한도, 대시보드 API 모델 포함
- 사용자 결정 반영: 에이전트 간 이동 허용, 역할 구분 불필요, 통합 대시보드 필요
- Plan 01/02 산출물과의 연결이 명확함
</success_criteria>

<output>
After completion, create `.planning/phases/04-owner-agent-relationship/04-03-SUMMARY.md`
</output>
