---
phase: 04-owner-agent-relationship
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/13-fund-deposit-process.md
  - .planning/deliverables/14-fund-withdrawal-process.md
autonomous: true

must_haves:
  truths:
    - "소유자가 에이전트 Vault에 자금을 예치하는 전체 흐름이 단계별로 정의됨"
    - "예산 풀 방식의 데이터 모델(BudgetConfig, ReplenishmentConfig)이 TypeScript 인터페이스로 명세됨"
    - "자동 보충과 수동 보충 두 가지 모드가 각각의 트리거/흐름/안전장치와 함께 설계됨"
    - "에이전트에서 소유자로의 자금 회수 절차가 수동/자동/폐기 시나리오별로 정의됨"
    - "Squads threshold 변경 순서(ChangeThreshold -> 회수 -> RemoveMember)가 명시됨"
    - "자금 회수 시 Squads Vault PDA 주소 사용이 강조되고 멀티시그 주소 전송 금지가 명시됨"
  artifacts:
    - path: ".planning/deliverables/13-fund-deposit-process.md"
      provides: "자금 충전 프로세스 설계 (REL-01)"
      contains: "예산 풀"
    - path: ".planning/deliverables/14-fund-withdrawal-process.md"
      provides: "자금 회수 프로세스 설계 (REL-02)"
      contains: "ChangeThreshold"
  key_links:
    - from: "13-fund-deposit-process.md"
      to: "08-dual-key-architecture.md"
      via: "Owner Key가 Squads Vault에 자금 전송"
      pattern: "Owner Key.*Vault"
    - from: "13-fund-deposit-process.md"
      to: "10-transaction-flow.md"
      via: "충전 트랜잭션도 정책 검증 흐름을 따름"
      pattern: "정책 검증"
    - from: "14-fund-withdrawal-process.md"
      to: "13-fund-deposit-process.md"
      via: "회수는 충전의 역방향 자금 흐름"
      pattern: "Vault.*소유자"
    - from: "14-fund-withdrawal-process.md"
      to: "08-dual-key-architecture.md"
      via: "Owner Key configAuthority로 threshold 변경 및 회수 실행"
      pattern: "configAuthority"
---

<objective>
자금 충전 프로세스(REL-01)와 자금 회수 프로세스(REL-02) 설계 문서를 작성한다.

Purpose: 소유자가 에이전트에게 운영 자금을 공급하고, 에이전트에서 소유자로 자금을 회수하는 양방향 자금 흐름을 정의하여 Phase 4의 자금 관리 기반을 완성한다. 이 두 프로세스는 예산 풀의 입출금이라는 하나의 맥락에서 함께 설계되어야 한다.

Output: .planning/deliverables/13-fund-deposit-process.md, .planning/deliverables/14-fund-withdrawal-process.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 4 context (MUST READ - locked user decisions and research findings)
@.planning/phases/04-owner-agent-relationship/04-CONTEXT.md
@.planning/phases/04-owner-agent-relationship/04-RESEARCH.md

# Phase 3 deliverables (reference for Dual Key, Squads integration, transaction flow)
@.planning/deliverables/08-dual-key-architecture.md
@.planning/deliverables/09-system-components.md
@.planning/deliverables/10-transaction-flow.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 자금 충전 프로세스 설계 문서 작성 (REL-01)</name>
  <files>.planning/deliverables/13-fund-deposit-process.md</files>
  <action>
  REL-01 자금 충전 프로세스 설계 문서를 작성한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요 및 설계 원칙**
  - 예산 풀(Budget Pool) 방식 설명: 소유자가 에이전트 Squads Vault에 자금 예치, 에이전트가 Spending Limit 범위 내에서 사용
  - 핵심 원칙: 온체인 강제(Squads Spending Limits) + 오프체인 보완(서버 정책)

  **2. 초기 자금 충전 흐름 (시퀀스 다이어그램 포함)**
  - Mermaid 시퀀스 다이어그램: 소유자 -> API Server -> Owner Key(KMS) -> Solana RPC -> Squads Vault
  - 단계: (1) 소유자가 충전 요청, (2) 서버가 Vault PDA 주소 확인 (주의: 멀티시그 PDA가 아닌 Vault PDA), (3) Owner Key로 SOL/SPL 전송 트랜잭션 서명, (4) 온체인 제출 및 확정, (5) DB 잔액 업데이트 + 캐시 갱신
  - Vault PDA 주소 도출 방법 명시: findProgramAddressSync(['vault', multisigPda, vaultIndex])
  - 주의사항 박스: "멀티시그 계정 주소로 자금 전송 금지 - 복구 불가" (Squads 공식 경고)

  **3. Squads Spending Limit 설정 (에이전트별)**
  - Spending Limit 파라미터 테이블: create_key, vault_index, mint, amount, period(Day/Week/Month), members([Agent Key]), destinations
  - 토큰별 독립 한도 설정 예시 (SOL 한도 + USDC 한도)
  - remaining_amount와 last_reset 자동 추적 메커니즘 설명
  - Period 기반 자동 리셋 (Unix timestamp 기반, 슬롯이 아님)

  **4. 계층적 예산 한도 체계 (다이어그램 포함)**
  - 3-Layer 한도 구조 다이어그램 (Mermaid 또는 ASCII):
    - Layer 1: 서버 정책 (건당 한도, 일일/주간/월간 합산, 전체 에이전트 합산, 화이트리스트, 시간 제어)
    - Layer 2: Squads Spending Limits (Period 기반, 토큰별, 목적지 제한)
    - Layer 3: Dynamic Threshold 서버 라우팅 (소액 1-of-2, 중액 Time Lock, 고액 2-of-2)
  - 온체인 vs 오프체인 한도 분리 원칙 테이블 (04-RESEARCH.md의 표 참조)
  - BudgetConfig TypeScript 인터페이스 정의 (04-RESEARCH.md의 코드 예시 기반, 필요시 확장)

  **5. 보충(Replenishment) 프로세스**
  - 보충 모드 2가지 설명:
    - AUTO: 잔액 <= thresholdAmount 시 자동 보충. 안전장치: maxDailyReplenishments, ownerMinBalance, 비정상 패턴 탐지
    - MANUAL: 잔액 <= thresholdAmount 시 소유자에게 알림, 소유자가 수동 충전
  - 자동 보충 시퀀스 다이어그램 (Mermaid): 잔액 모니터링 -> 임계값 감지 -> 안전장치 확인 -> Owner Key 서명 -> Vault 전송
  - ReplenishmentConfig TypeScript 인터페이스 (04-RESEARCH.md 기반)
  - 자동 보충의 위험과 안전장치 (Pitfall 5 반영): 무한 루프 방지, 일일 보충 횟수 제한, 소유자 최소 보호 잔액

  **6. 에이전트 생성 시 초기 자금 설정 플로우**
  - 필수 입력: 예산 한도(최소 1개), 보충 모드, 허용 토큰
  - 기본값 정책: 보충 모드=MANUAL, 화이트리스트=빈 목록(모든 주소), 운영 시간=24/7, 비활성 타임아웃=60분
  - 생성 플로우 (상태 전이 포함): API 요청 -> Squads 멀티시그 생성 -> Agent Key 등록 -> Spending Limit 설정 -> 초기 자금 충전 -> ACTIVE 전환

  **7. 잔액 모니터링 및 알림**
  - 실시간 잔액 추적: Redis 캐시 (agent:{agentId}:balance) + 주기적 온체인 확인
  - 알림 트리거: 잔액 임계값, 보충 완료, 보충 실패, 한도 초과 시도
  - 알림 채널: Webhook, SNS

  각 주요 흐름에 Mermaid 다이어그램을 포함할 것 (최소 3개: 초기 충전, 자동 보충, 계층 한도 구조).
  기존 Phase 3 문서(08, 09, 10)와의 연결 참조를 명시할 것.
  04-RESEARCH.md의 Code Examples 섹션에 있는 TypeScript 인터페이스를 활용하되, 문서 맥락에 맞게 조정할 것.
  </action>
  <verify>
  파일 존재 확인: ls .planning/deliverables/13-fund-deposit-process.md
  필수 섹션 존재: grep -c "예산 풀\|Budget Pool" .planning/deliverables/13-fund-deposit-process.md (1 이상)
  Spending Limit 파라미터: grep -c "SpendingLimit\|spending_limit\|Spending Limit" .planning/deliverables/13-fund-deposit-process.md (3 이상)
  Mermaid 다이어그램: grep -c "```mermaid" .planning/deliverables/13-fund-deposit-process.md (3 이상)
  TypeScript 인터페이스: grep -c "interface.*Config\|interface.*Limit" .planning/deliverables/13-fund-deposit-process.md (2 이상)
  Vault PDA 경고: grep -c "멀티시그.*주소.*전송.*금지\|Vault PDA" .planning/deliverables/13-fund-deposit-process.md (1 이상)
  자동 보충 안전장치: grep -c "maxDailyReplenishments\|ownerMinBalance" .planning/deliverables/13-fund-deposit-process.md (1 이상)
  </verify>
  <done>
  - 예산 풀 방식의 자금 충전 전체 흐름이 단계별로 정의됨
  - Squads Spending Limit 파라미터와 설정 방법이 명세됨
  - 3-Layer 계층적 예산 한도 체계가 온체인/오프체인 분리 원칙과 함께 설계됨
  - 자동/수동 보충 모드가 각각의 안전장치와 함께 설계됨
  - 에이전트 생성 시 초기 자금 설정 플로우가 정의됨
  - 최소 3개의 Mermaid 다이어그램이 포함됨
  </done>
</task>

<task type="auto">
  <name>Task 2: 자금 회수 프로세스 설계 문서 작성 (REL-02)</name>
  <files>.planning/deliverables/14-fund-withdrawal-process.md</files>
  <action>
  REL-02 자금 회수 프로세스 설계 문서를 작성한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요 및 설계 원칙**
  - 회수 = 에이전트 Vault에서 소유자 지갑으로의 자금 이동
  - 핵심 원칙: Owner Key 단독 권한, 에이전트 동의 불필요, Squads configAuthority 활용
  - 사용자 결정 반영: "에이전트 폐기 시 잔액 전액 자동 회수" (CONTEXT.md)

  **2. 회수 트리거 유형 (테이블)**
  3가지 트리거를 테이블로 정의:
  - 수동 회수: 소유자가 부분/전액 회수 요청. MFA 인증 후 즉시 실행
  - 자동 회수 (폐기 시): 에이전트 TERMINATED 전환 시 잔액 전액 자동 회수
  - 비상 회수: REL-04에서 상세 정의 (여기서는 참조만). Circuit Breaker/이상 탐지 시 자동 SUSPENDED 후 소유자 수동 회수

  **3. 수동 회수 프로세스 (시퀀스 다이어그램)**
  - Mermaid 시퀀스 다이어그램: 소유자 -> API Server -> 정책 검증 -> Owner Key(KMS) -> Squads Vault -> 소유자 지갑
  - 부분 회수: 소유자가 금액 지정, Vault 잔액 확인, Spending Limit을 Owner에게 할당하여 인출 또는 Proposal 방식
  - 전액 회수: 전체 Vault 잔액 이동
  - 회수 후 Spending Limit remaining_amount에 미치는 영향 설명

  **4. 자동 회수 프로세스 - 에이전트 폐기 시 (시퀀스 다이어그램)**
  - Mermaid 시퀀스 다이어그램: TERMINATING 상태 진입 -> 진행 중 tx 완료 대기 -> ChangeThreshold(1) -> Vault 자금 전액 회수 -> RemoveMember(Agent Key) -> 키 삭제 -> TERMINATED
  - **중요: Squads Threshold 순서** (Pitfall 4 반영):
    1. ChangeThreshold(1)로 threshold 변경 (Owner Key, configAuthority)
    2. Vault 자금 전액 회수 트랜잭션 실행 (Owner Key 단독)
    3. RemoveMember(Agent Key)로 멤버 제거
    순서 변경 불가 - RemoveMember 먼저 하면 threshold 충족 불가로 자금 잠김
  - 각 단계의 실패 시 롤백/재시도 절차

  **5. Squads Vault에서 자금 이동 메커니즘 (기술 상세)**
  - 방법 A: Owner Key에게 Spending Limit 할당 -> SpendingLimitUse로 직접 인출
  - 방법 B: ChangeThreshold(1) -> Owner 단독 Vault Transaction (proposal -> approve -> execute를 Owner 혼자)
  - Open Question 반영: configAuthority의 정확한 vault 접근 범위는 구현 시 테스트 확인 필요. 설계는 두 가지 시나리오 모두 지원
  - 각 방법의 장단점 비교 테이블

  **6. 회수 관련 데이터 모델**
  - WithdrawalRequest TypeScript 인터페이스: type(manual/auto_termination/emergency), amount, destinationPubkey, status, requestedAt, completedAt
  - WithdrawalStatus enum: PENDING, EXECUTING, COMPLETED, FAILED
  - DB 감사 로그 스키마: withdrawal_id, agent_id, owner_id, type, amount, tx_signature, timestamp

  **7. 안전장치 및 제약사항**
  - Vault PDA 주소 검증 (멀티시그 주소 아닌 Vault 주소로만 인출)
  - 회수 금액 검증 (Vault 잔액 초과 불가)
  - 동시 회수 요청 방지 (Redis 락)
  - 회수 중 에이전트 트랜잭션 차단 (SUSPENDED 전환)
  - 실패 시 알림 및 수동 개입 절차

  각 주요 흐름에 Mermaid 다이어그램을 포함할 것 (최소 2개: 수동 회수, 자동 폐기 회수).
  Task 1에서 작성한 13-fund-deposit-process.md와의 상호 참조를 포함할 것.
  04-RESEARCH.md의 Pitfall 4 (threshold 문제)를 반드시 반영할 것.
  </action>
  <verify>
  파일 존재 확인: ls .planning/deliverables/14-fund-withdrawal-process.md
  회수 트리거: grep -c "수동 회수\|자동 회수\|비상 회수" .planning/deliverables/14-fund-withdrawal-process.md (3 이상)
  Threshold 순서: grep -c "ChangeThreshold" .planning/deliverables/14-fund-withdrawal-process.md (2 이상)
  Mermaid 다이어그램: grep -c "```mermaid" .planning/deliverables/14-fund-withdrawal-process.md (2 이상)
  TypeScript 인터페이스: grep -c "interface.*Withdrawal\|interface.*Request" .planning/deliverables/14-fund-withdrawal-process.md (1 이상)
  Squads Vault 메커니즘: grep -c "SpendingLimitUse\|Vault Transaction\|configAuthority" .planning/deliverables/14-fund-withdrawal-process.md (2 이상)
  상호 참조: grep -c "13-fund-deposit" .planning/deliverables/14-fund-withdrawal-process.md (1 이상)
  </verify>
  <done>
  - 수동/자동/비상 3가지 회수 트리거가 테이블로 정의됨
  - 수동 회수(부분/전액) 프로세스가 시퀀스 다이어그램과 함께 정의됨
  - 에이전트 폐기 시 자동 회수 절차가 ChangeThreshold(1) -> 회수 -> RemoveMember 순서로 명시됨
  - Squads Vault 자금 이동의 2가지 메커니즘(Spending Limit 방식 vs Threshold 방식)이 비교됨
  - 회수 관련 데이터 모델이 TypeScript 인터페이스로 정의됨
  - 최소 2개의 Mermaid 다이어그램이 포함됨
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 01 전체 검증:
1. 두 문서가 .planning/deliverables/에 존재: ls .planning/deliverables/13-fund-deposit-process.md .planning/deliverables/14-fund-withdrawal-process.md
2. 13번 문서에 예산 풀 방식, Spending Limit, 계층적 한도, 보충 프로세스가 설계됨
3. 14번 문서에 수동/자동 회수 절차, Squads threshold 순서, 데이터 모델이 설계됨
4. 두 문서 간 상호 참조가 존재
5. 총 Mermaid 다이어그램 5개 이상 (13번 3+, 14번 2+)
6. Phase 3 문서(08, 09, 10)와의 연결 참조 존재
</verification>

<success_criteria>
- REL-01 충족: 소유자가 에이전트에게 운영 자금을 공급하는 흐름이 정의됨
- REL-02 충족: 에이전트에서 소유자로의 자금 이동 절차가 정의됨
- 사용자 결정 반영: 예산 풀 방식, 자동/수동 보충 모두 지원, 폐기 시 전액 자동 회수
- Squads v4 기능 활용: Spending Limits, configAuthority, Vault PDA
- Pitfall 반영: Vault 주소 혼동 방지(Pitfall 1), 자동 보충 무한 루프 방지(Pitfall 5), Threshold 순서(Pitfall 4)
</success_criteria>

<output>
After completion, create `.planning/phases/04-owner-agent-relationship/04-01-SUMMARY.md`
</output>
