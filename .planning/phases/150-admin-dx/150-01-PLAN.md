---
phase: 150-admin-dx
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/wc.ts
  - packages/daemon/src/api/server.ts
  - packages/admin/src/pages/walletconnect.tsx
  - packages/admin/src/components/layout.tsx
  - packages/admin/src/api/endpoints.ts
autonomous: true

must_haves:
  truths:
    - "Session-scoped WC REST endpoints respond to sessionAuth Bearer token"
    - "Admin UI sidebar has WalletConnect navigation item"
    - "Admin WC page lists all wallets with their WC session status"
    - "Admin WC page allows pairing start, status check, and disconnect per wallet"
  artifacts:
    - path: "packages/daemon/src/api/routes/wc.ts"
      provides: "Session-scoped /v1/wallet/wc/* endpoints (pair, session GET/DELETE, pair/status)"
      contains: "wallet/wc/pair"
    - path: "packages/admin/src/pages/walletconnect.tsx"
      provides: "Dedicated WC management page"
      min_lines: 100
    - path: "packages/admin/src/components/layout.tsx"
      provides: "WalletConnect route in PageRouter + NAV_ITEMS"
      contains: "walletconnect"
  key_links:
    - from: "packages/admin/src/pages/walletconnect.tsx"
      to: "/v1/wallets/:id/wc/*"
      via: "apiCall with masterAuth"
      pattern: "WALLET_WC_PAIR|WALLET_WC_SESSION"
    - from: "packages/daemon/src/api/routes/wc.ts"
      to: "wcSessionService"
      via: "session-scoped handlers reuse same WcSessionService methods"
      pattern: "wcSessionService\\.createPairing|wcSessionService\\.getSessionInfo"
    - from: "packages/daemon/src/api/server.ts"
      to: "sessionAuth middleware"
      via: "/v1/wallet/wc/* route registration"
      pattern: "wallet/wc"
---

<objective>
Session-scoped WC REST endpoints + Admin UI WalletConnect 관리 페이지

Purpose: MCP/SDK가 sessionAuth로 WC 기능에 접근할 수 있는 REST 엔드포인트를 추가하고, Admin UI에 전용 WC 관리 페이지를 생성하여 모든 월렛의 WC 세션을 한눈에 관리할 수 있게 한다.
Output: 4개 session-scoped REST 엔드포인트 + Admin UI WalletConnect 페이지
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/147-qr-pairing/147-01-SUMMARY.md
@.planning/phases/147-qr-pairing/147-02-SUMMARY.md
@.planning/phases/150-admin-dx/150-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Session-scoped WC REST endpoints (/v1/wallet/wc/*)</name>
  <files>
    packages/daemon/src/api/routes/wc.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
Add session-scoped WC endpoints to wc.ts that mirror the existing masterAuth endpoints. The walletId comes from `c.get('walletId')` (set by sessionAuth middleware from JWT payload), not from URL params.

**In wc.ts:**

1. Add 4 new route definitions (session-scoped, no `:id` param):
   - `POST /wallet/wc/pair` -> createPairing (walletId from JWT)
   - `GET /wallet/wc/session` -> getSessionInfo (walletId from JWT)
   - `DELETE /wallet/wc/session` -> disconnectSession (walletId from JWT)
   - `GET /wallet/wc/pair/status` -> getPairingStatus (walletId from JWT)

2. Create a new exported function `wcSessionRoutes(deps: WcRouteDeps): OpenAPIHono` that registers the 4 session-scoped routes. The handler logic is identical to the existing masterAuth handlers, except:
   - No `z.object({ id: z.string().uuid() })` param validation
   - walletId obtained via `c.get('walletId')` instead of `c.req.valid('param').id`
   - Same wallet existence check using raw SQL
   - Same WcSessionService method calls

3. Use tag `['WalletConnect']` and add `(session)` suffix to summaries for clarity.

**In server.ts:**

1. Import `wcSessionRoutes` alongside existing `wcRoutes` import
2. Register session-scoped routes: `app.route('/v1', wcSessionRoutes({ db, wcSessionService }))` inside the same `if (deps.db && deps.wcSessionService)` block
3. The existing `/v1/wallet/*` sessionAuth middleware (line 189) already covers `/v1/wallet/wc/*` -- no additional auth middleware needed

Do NOT modify the existing masterAuth wcRoutes function. Keep both sets of endpoints.
  </action>
  <verify>
`pnpm build --filter=@waiaas/daemon` succeeds. `pnpm test --filter=@waiaas/daemon` passes. Check that `/doc` endpoint shows both `/wallets/{id}/wc/*` and `/wallet/wc/*` routes.
  </verify>
  <done>
4 session-scoped WC endpoints exist at `/v1/wallet/wc/*`, protected by sessionAuth, reusing WcSessionService. Both masterAuth and sessionAuth endpoint sets coexist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin UI dedicated WalletConnect 관리 페이지</name>
  <files>
    packages/admin/src/pages/walletconnect.tsx
    packages/admin/src/components/layout.tsx
    packages/admin/src/api/endpoints.ts
  </files>
  <action>
Create a dedicated WalletConnect management page that shows ALL wallets' WC sessions in a unified view.

**walletconnect.tsx (NEW):**

1. Define interfaces: reuse same `WcSession`, `WcPairingResult`, `WcPairingStatus` shapes as wallets.tsx (lines 67-87). Also define `WalletSummary` with `{ id, name, chain, environment }`.

2. Signals:
   - `walletList: Signal<WalletSummary[]>` -- all wallets
   - `wcSessions: Signal<Record<string, WcSession | null>>` -- walletId -> session map
   - `loading: Signal<boolean>`
   - `pairingWalletId: Signal<string | null>` -- which wallet is currently pairing
   - `pairingResult: Signal<WcPairingResult | null>` -- QR modal data
   - `pairingPollRef: Signal<number | null>` -- polling interval ID

3. On mount (`useEffect`):
   - Fetch `GET /v1/wallets` (via `apiGet(API.WALLETS)`) -> walletList
   - For each wallet, fetch `GET /v1/wallets/:id/wc/session` -> populate wcSessions map (404 = null, 200 = session)

4. Table view showing all wallets:
   - Columns: Wallet Name, Chain, WC Status (badge: "Connected" green / "Not Connected" gray), Peer Name, Owner Address, Expiry, Actions
   - Actions column:
     - If no session: "Connect" button -> call `POST /v1/wallets/:id/wc/pair`, show QR modal
     - If session: "Disconnect" button -> call `DELETE /v1/wallets/:id/wc/session`, refresh

5. QR Modal: reuse same pattern from wallets.tsx (lines 572-692):
   - Show QR code image (base64 data URL, 280x280)
   - 3-second polling interval on `GET /v1/wallets/:id/wc/pair/status`
   - On `connected` -> close modal, refresh sessions, success toast
   - On `expired`/`none` -> close modal, error toast
   - Cleanup polling on unmount

6. Use existing `apiGet`, `apiPost`, `apiDelete` from `../api/client`. Use `API.WALLET_WC_PAIR(id)`, `API.WALLET_WC_SESSION(id)`, `API.WALLET_WC_PAIR_STATUS(id)` from endpoints.ts.

7. Toast notifications via existing `showToast` pattern (import from dashboard or wherever it's defined -- check existing pages for pattern).

8. Style with existing CSS classes: `.card`, `.table`, `.btn-primary`, `.btn-danger`, `.badge`, `.modal` -- follow patterns from wallets.tsx and policies.tsx.

**layout.tsx:**

1. Import `WalletConnectPage` from `'../pages/walletconnect'`
2. Add to `PAGE_TITLES`: `'/walletconnect': 'WalletConnect'`
3. Add to `NAV_ITEMS` (after Telegram, before Settings): `{ path: '/walletconnect', label: 'WalletConnect' }`
4. Add to `PageRouter`: `if (path === '/walletconnect') return <WalletConnectPage />;` (before the wallets catch-all)

**endpoints.ts** -- no changes needed, the 3 WC endpoint constants already exist (lines 29-31).

Do NOT modify the existing WC section in wallets.tsx. The dedicated page and the wallet detail section serve different purposes (overview vs single-wallet detail).
  </action>
  <verify>
`pnpm build --filter=@waiaas/admin` succeeds. Navigate to `#/walletconnect` in the admin UI -- page renders with wallet table. Sidebar shows "WalletConnect" link.
  </verify>
  <done>
Admin UI has a dedicated WalletConnect page accessible from sidebar, showing all wallets' WC session status with connect/disconnect actions and QR modal.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` -- full monorepo build succeeds
2. `pnpm test --filter=@waiaas/daemon` -- all tests pass
3. Session-scoped endpoints visible in OpenAPI spec at `/doc`
4. Admin UI `/walletconnect` route renders correctly
5. No regressions in existing masterAuth WC endpoints
</verification>

<success_criteria>
- 4 session-scoped WC REST endpoints operational at `/v1/wallet/wc/*`
- Admin UI sidebar includes WalletConnect link
- WalletConnect page shows all wallets with WC status, connect/disconnect actions
- QR modal with 3s polling for pairing flow
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/150-admin-dx/150-01-SUMMARY.md`
</output>
