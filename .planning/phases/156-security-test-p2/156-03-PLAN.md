---
phase: 156-security-test-p2
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/security/extension/chain-error-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/x402/x402-payment-attacks.security.test.ts
autonomous: true

must_haves:
  truths:
    - "모든 29개 ChainErrorCode가 3개 카테고리(PERMANENT/TRANSIENT/STALE)에 정확히 매핑된다"
    - "PERMANENT 카테고리의 retryable이 항상 false이다"
    - "TRANSIENT/STALE 카테고리의 retryable이 항상 true이다"
    - "private IP(10.x, 127.x, 192.168.x 등) 대상 x402 요청이 SSRF 가드에서 차단된다"
    - "IPv4-mapped IPv6(::ffff:127.0.0.1) 우회가 차단된다"
    - "X402_ALLOWED_DOMAINS 미설정 시 x402 결제가 기본 거부된다"
    - "X402_ALLOWED_DOMAINS에 없는 도메인의 결제가 거부된다"
    - "결제 금액(PaymentRequirements.amount) 조작이 서버 검증으로 방어된다"
  artifacts:
    - path: "packages/daemon/src/__tests__/security/extension/chain-error-attacks.security.test.ts"
      provides: "SEC-13 ChainError 보안 시나리오 12건"
      min_lines: 150
    - path: "packages/daemon/src/__tests__/security/x402/x402-payment-attacks.security.test.ts"
      provides: "SEC-14 x402 결제 보안 시나리오 ~12건"
      min_lines: 200
  key_links:
    - from: "chain-error-attacks.security.test.ts"
      to: "ChainError + CHAIN_ERROR_CATEGORIES"
      via: "new ChainError(code, chain) -> category/retryable 검증"
      pattern: "new ChainError|CHAIN_ERROR_CATEGORIES"
    - from: "x402-payment-attacks.security.test.ts"
      to: "validateUrlSafety + evaluateX402Domain + matchDomain"
      via: "SSRF 가드 + 도메인 정책 직접 호출"
      pattern: "validateUrlSafety|evaluateX402Domain|matchDomain"
---

<objective>
ChainError 보안(SEC-13, 12건) + x402 결제 보안(SEC-14, ~12건) 보안 공격 시나리오 ~24건을 테스트로 검증한다.

Purpose: 에러 카테고리 오분류에 의한 무한 재시도 방지와, x402 HTTP 프록시의 SSRF/도메인 정책/금액 조작 방어를 증명한다.
Output: 2개 보안 테스트 파일 (extension/ + x402/ 디렉토리)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/155-security-test-p1/155-01-SUMMARY.md

# ChainError 구현
@packages/core/src/errors/chain-error.ts

# x402 구현
@packages/daemon/src/services/x402/ssrf-guard.ts
@packages/daemon/src/services/x402/x402-domain-policy.ts
@packages/daemon/src/services/x402/x402-handler.ts
@packages/daemon/src/services/x402/payment-signer.ts
@packages/daemon/src/services/x402/x402-usd-resolver.ts

# 보안 테스트 헬퍼
@packages/daemon/src/__tests__/security/helpers/security-test-helpers.ts

# 보안 시나리오 정의
@docs/64-extension-test-strategy.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SEC-13 ChainError 보안 12건</name>
  <files>
    packages/daemon/src/__tests__/security/extension/chain-error-attacks.security.test.ts
  </files>
  <action>
ChainError 클래스와 CHAIN_ERROR_CATEGORIES 매핑의 보안 무결성을 검증하는 테스트를 생성한다.

**chain-error-attacks.security.test.ts (SEC-13, 12건):**

Import: ChainError, ChainErrorCode, ChainErrorCategory, CHAIN_ERROR_CATEGORIES from '@waiaas/core' (또는 상대 경로로 packages/core/src/errors/chain-error.ts)

시나리오 구성 (~12건):
1. SEC-13-01: 모든 21개 PERMANENT 코드의 retryable === false 검증 (전수 확인)
2. SEC-13-02: 모든 4개 TRANSIENT 코드의 retryable === true 검증 (전수 확인)
3. SEC-13-03: 모든 4개 STALE 코드의 retryable === true 검증 (전수 확인)
4. SEC-13-04: CHAIN_ERROR_CATEGORIES 키 수 === 29 (누락/추가 코드 감지)
5. SEC-13-05: ChainError.category가 CHAIN_ERROR_CATEGORIES[code]와 일치 (생성자 무결성)
6. SEC-13-06: ChainError.retryable === (category !== 'PERMANENT') 자동 파생 정확성
7. SEC-13-07: PERMANENT 에러로 재시도 시도 시나리오 (INSUFFICIENT_BALANCE 등) -> retryable=false이므로 재시도 금지
8. SEC-13-08: TRANSIENT 에러 재시도 안전성 (RPC_TIMEOUT 등) -> retryable=true, 동일 TX 재제출 안전
9. SEC-13-09: STALE 에러 재시도 시 TX 재빌드 필요 (BLOCKHASH_EXPIRED 등) -> retryable=true, BUT 새 blockhash 필요
10. SEC-13-10: ChainError.toJSON() 직렬화 무결성 (code, message, category, chain, retryable 모두 포함)
11. SEC-13-11: cause 체이닝 (options.cause 전달 시 cause 프로퍼티 설정)
12. SEC-13-12: 잘못된 code 타입 전달 시 TypeScript 컴파일 에러 (런타임 검증은 불가, 타입 안전성 확인 방식으로 테스트)

핵심: 29개 ChainErrorCode를 모두 순회하면서 category->retryable 자동 파생이 정확한지 전수 검증. PERMANENT 오분류는 재시도 무한 루프를, TRANSIENT 오분류는 영구 실패를 야기하므로 보안 관점에서 중요.

for...of Object.entries(CHAIN_ERROR_CATEGORIES) 패턴으로 전수 검증. 각 카테고리별 기대 코드 목록을 하드코딩하여 매핑 변경 시 테스트 실패로 감지.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/extension/chain-error-attacks.security.test.ts --reporter=verbose` 실행하여 12건 통과 확인.
  </verify>
  <done>
SEC-13 ChainError 보안 12건이 모두 통과한다. 29개 에러 코드의 3-카테고리 매핑이 정확하고, retryable 자동 파생이 올바르며, PERMANENT/TRANSIENT/STALE 오분류가 없음이 증명된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: SEC-14 x402 결제 보안 ~12건</name>
  <files>
    packages/daemon/src/__tests__/security/x402/x402-payment-attacks.security.test.ts
  </files>
  <action>
x402 HTTP 프록시의 SSRF 가드, 도메인 정책, 핸들러 보안을 검증하는 테스트를 생성한다.

**x402-payment-attacks.security.test.ts (SEC-14, ~12건):**

Import:
- validateUrlSafety, safeFetchWithRedirects from services/x402/ssrf-guard.ts
- evaluateX402Domain, matchDomain from services/x402/x402-domain-policy.ts
- selectPaymentRequirement from services/x402/x402-handler.ts
- WAIaaSError from '@waiaas/core'

시나리오 구성 (~12건):

**SSRF 우회 공격 (5건):**
1. SEC-14-01: private IP 직접 접근 (http://10.0.0.1, http://192.168.1.1, http://127.0.0.1) -> X402_SSRF_BLOCKED
2. SEC-14-02: IPv4-mapped IPv6 우회 (::ffff:127.0.0.1, ::ffff:10.0.0.1) -> X402_SSRF_BLOCKED (normalizeIPv6Mapped 검증)
3. SEC-14-03: localhost 변형 (http://localhost, http://0.0.0.0, http://[::1]) -> X402_SSRF_BLOCKED
4. SEC-14-04: HTTP 프로토콜 (http:// 아닌 HTTPS만 허용) -> X402_SSRF_BLOCKED
5. SEC-14-05: userinfo 포함 URL (https://admin:pass@example.com) -> X402_SSRF_BLOCKED
   추가: 비표준 포트 (https://example.com:8443) -> X402_SSRF_BLOCKED (443만 허용)
   추가: hex-encoded IPv4-mapped IPv6 (::ffff:0a00:0001 = 10.0.0.1) -> X402_SSRF_BLOCKED

**X402_ALLOWED_DOMAINS 우회 공격 (4건):**
6. SEC-14-06: X402_ALLOWED_DOMAINS 미설정 -> x402 결제 기본 거부 (evaluateX402Domain returns allowed=false)
7. SEC-14-07: 비허용 도메인 결제 시도 -> 거부
8. SEC-14-08: 와일드카드 우회 (*.example.com에서 example.com 자체는 불일치, sub.example.com은 일치)
9. SEC-14-09: 대소문자 도메인 매칭 (API.Example.COM vs api.example.com -> case-insensitive 매칭)

**결제 금액/스키마 조작 (3건):**
10. SEC-14-10: PaymentRequirements에서 supportedNetworks에 없는 네트워크 -> X402_UNSUPPORTED_SCHEME
11. SEC-14-11: scheme !== 'exact' -> selectPaymentRequirement()에서 필터링
12. SEC-14-12: accepts 배열 빈 경우 -> X402_UNSUPPORTED_SCHEME
    추가: 리다이렉트 3회 초과 시 X402_SSRF_BLOCKED
    추가: trailing dot FQDN 정규화 (example.com. -> example.com)

validateUrlSafety()는 DNS resolution이 필요하므로, private IP 직접 삽입 테스트는 isIP() 경로로 테스트. DNS 기반 테스트는 localhost 등 시스템 해석 가능한 호스트명 사용.

matchDomain()과 evaluateX402Domain()은 순수 함수이므로 직접 호출하여 테스트. selectPaymentRequirement()도 순수 함수로 직접 테스트.

참고: handleX402Fetch() 전체 흐름 테스트는 fetch mock이 필요하며 Phase 157(기능 테스트)에서 커버. 여기서는 보안 경계(SSRF 가드, 도메인 정책, 스키마 검증)에 집중.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/x402/x402-payment-attacks.security.test.ts --reporter=verbose` 실행하여 ~12건 통과 확인. 이어서 `pnpm test:security` 실행하여 전체 보안 테스트(155 + 156) 통과 확인.
  </verify>
  <done>
SEC-14 x402 결제 보안 ~12건이 모두 통과한다. SSRF private IP/IPv6 우회 차단, X402_ALLOWED_DOMAINS 기본 거부, 와일드카드 도메인 매칭, 비지원 네트워크/스키마 거부 등이 모두 증명된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/daemon/src/__tests__/security/extension/chain-error-attacks.security.test.ts packages/daemon/src/__tests__/security/x402/x402-payment-attacks.security.test.ts --reporter=verbose` -> ~24건 통과
2. `pnpm test:security` -> Phase 155 (131건) + Phase 156 전체 (~178건) = ~309건 전체 통과
</verification>

<success_criteria>
1. SEC-13 ChainError 보안 12건이 모두 통과한다 (29 코드 전수 매핑, retryable 자동 파생)
2. SEC-14 x402 결제 보안 ~12건이 모두 통과한다 (SSRF 차단, 도메인 정책, 금액 검증)
3. 전체 보안 테스트 스위트 (Phase 155 + 156) 통과
4. 기존 테스트가 깨지지 않는다
</success_criteria>

<output>
After completion, create `.planning/phases/156-security-test-p2/156-03-SUMMARY.md`
</output>
