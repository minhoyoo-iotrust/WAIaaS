---
phase: 156-security-test-p2
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/security/extension/batch-split-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/extension/oracle-manipulation-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/extension/action-provider-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/extension/swap-slippage-attacks.security.test.ts
autonomous: true

must_haves:
  truths:
    - "배치 내 소액 분할 합산이 SPENDING_LIMIT을 초과하면 거부된다"
    - "배치 내 각 instruction이 개별 정책 검증을 거친다 (All-or-Nothing)"
    - "가격 급변동(60%+) 감지 시 INSTANT->NOTIFY 상향된다"
    - "전체 오라클 장애 시 가격 기반 정책이 보수적으로 동작한다"
    - "stale 가격(isStale=true) 사용 시 티어가 상향된다"
    - "악성 Action Provider의 from 주소 위변조가 validateResolveResult()에서 차단된다"
    - "슬리피지 500bps 초과 요청이 inputSchema에서 거부된다"
  artifacts:
    - path: "packages/daemon/src/__tests__/security/extension/batch-split-attacks.security.test.ts"
      provides: "SEC-09 배치 분할 우회 보안 시나리오 22건"
      min_lines: 200
    - path: "packages/daemon/src/__tests__/security/extension/oracle-manipulation-attacks.security.test.ts"
      provides: "SEC-10 Oracle 가격 조작 보안 시나리오 20건"
      min_lines: 250
    - path: "packages/daemon/src/__tests__/security/extension/action-provider-attacks.security.test.ts"
      provides: "SEC-11 Action Provider 보안 시나리오 16건"
      min_lines: 200
    - path: "packages/daemon/src/__tests__/security/extension/swap-slippage-attacks.security.test.ts"
      provides: "SEC-12 Swap 슬리피지/MEV 보안 시나리오 12건"
      min_lines: 150
  key_links:
    - from: "batch-split-attacks.security.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluate with type BATCH"
      pattern: "engine\\.evaluate.*BATCH"
    - from: "oracle-manipulation-attacks.security.test.ts"
      to: "OracleChain"
      via: "getPrice/getNativePrice with mock oracles"
      pattern: "oracle\\.getPrice|oracleChain"
    - from: "action-provider-attacks.security.test.ts"
      to: "ActionProviderRegistry"
      via: "register + executeResolve"
      pattern: "registry\\.register|registry\\.executeResolve"
    - from: "swap-slippage-attacks.security.test.ts"
      to: "Zod inputSchema"
      via: "inputSchema.parse with slippage validation"
      pattern: "inputSchema\\.parse|slippage"
---

<objective>
배치 분할 우회(SEC-09, 22건) + Oracle 가격 조작(SEC-10, 20건) + Action Provider(SEC-11, 16건) + Swap 슬리피지/MEV(SEC-12, 12건) 보안 공격 시나리오 70건을 테스트로 검증한다.

Purpose: 배치 합산 정책, 가격 오라클 장애/조작, 악성 플러그인, 슬리피지 공격 등 확장 기능 고유 위협 벡터의 방어를 증명한다.
Output: 4개 보안 테스트 파일 (extension/ 디렉토리)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/155-security-test-p1/155-01-SUMMARY.md

# 핵심 구현 파일
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/infrastructure/oracle/oracle-chain.ts
@packages/daemon/src/infrastructure/oracle/oracle-errors.ts
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/price-age.ts
@packages/daemon/src/infrastructure/action/action-provider-registry.ts
@packages/daemon/src/__tests__/mocks/mock-action-provider.ts
@packages/daemon/src/__tests__/security/helpers/security-test-helpers.ts

# 보안 시나리오 정의
@docs/64-extension-test-strategy.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SEC-09 배치 분할 우회 22건 + SEC-10 Oracle 가격 조작 20건</name>
  <files>
    packages/daemon/src/__tests__/security/extension/batch-split-attacks.security.test.ts
    packages/daemon/src/__tests__/security/extension/oracle-manipulation-attacks.security.test.ts
  </files>
  <action>
**batch-split-attacks.security.test.ts (SEC-09, 22건):**

Setup: createInMemoryDb() -> insertTestWallet() -> new DatabasePolicyEngine(conn.db)
트랜잭션 헬퍼: `batchTx(items)` -> `{ type: 'BATCH', batchItems: items, chain }` (items는 개별 TRANSFER/TOKEN_TRANSFER/APPROVE 배열)

시나리오 구성 (~22건):
1. SEC-09-01: 소액 분할 우회 (개별 100 * 10건 = 1000, instant_max=500) -> 합산 평가로 DELAY 이상 (SEC-BAT-01)
2. SEC-09-02: 배치 내 approve + transferFrom 콤보 -> APPROVE_TIER_OVERRIDE 강제 적용 (SEC-BAT-02)
3. SEC-09-03: 배치 내 악성 instruction 삽입 -> All-or-Nothing 거부 (SEC-BAT-03)
4. SEC-09-04: 배치 내 비화이트리스트 컨트랙트 호출 포함 -> 전체 거부
5. SEC-09-05: 배치 내 비허용 토큰 전송 포함 -> 전체 거부
6. SEC-09-06: 빈 batchItems -> 거부 또는 무시
7. SEC-09-07: 단일 item 배치 -> 개별 평가와 동일 결과
8. SEC-09-08: 배치 합산이 정확히 instant_max 경계 -> INSTANT
9. SEC-09-09: 배치 합산이 instant_max + 1 lamport -> NOTIFY
10. SEC-09-10: 다양한 타입 혼합 배치 (TRANSFER + TOKEN_TRANSFER + CONTRACT_CALL)
11. SEC-09-11: 글로벌 vs 월렛 정책 오버라이드와 배치 합산
12. SEC-09-12: BATCH 타입 미지원 체인 -> BATCH_NOT_SUPPORTED 에러
13. SEC-09-13~22: 금액 경계값 (합산 정확히 notify_max, delay_max), 100+ items 배치 크기 제한, TOCTOU reserved_amount 배치 합산, 네트워크 스코핑 등 ~10건

DatabasePolicyEngine.evaluate()에 BATCH 타입 트랜잭션을 전달. batchItems 합산 금액이 SPENDING_LIMIT 평가에 사용되는지, 개별 item의 WHITELIST/ALLOWED_TOKENS/CONTRACT_WHITELIST 정책이 각각 검증되는지 확인.

**oracle-manipulation-attacks.security.test.ts (SEC-10, 20건):**

Setup: OracleChain 직접 인스턴스화 (primary: MockPriceOracle, fallback: MockPriceOracle, cache: InMemoryPriceCache)
- 기존 __tests__/mocks/mock-action-provider.ts 참조하여 MockPriceOracle 인라인 생성 또는 @packages/daemon/src/__tests__/mocks/ 내 MockPriceOracle 사용
- InMemoryPriceCache 직접 import하여 캐시 제어

시나리오 구성 (~20건, SEC-ORC-01~12 + 확장):
1. SEC-10-01: 급격한 가격 변동 (primary $150 -> fallback $60, 60% 이상) -> isStale=true (SEC-ORC-01)
2. SEC-10-02: 교차 검증 실패 (primary $100, fallback $80, 20% 불일치) -> isStale=true + 보수적 가격 (SEC-ORC-02)
3. SEC-10-03: 전체 오라클 장애 (primary fail + fallback fail + cache empty) -> PriceNotAvailableError (SEC-ORC-03)
4. SEC-10-04: stale 캐시 반환 (primary fail + fallback fail + cache stale) -> isStale=true (SEC-ORC-04)
5. SEC-10-05: getPrice 실패 시 TOKEN_TRANSFER fallback 동작 (SEC-ORC-05)
6. SEC-10-06: getNativePrice 실패 시 type별 fallback (SEC-ORC-06)
7. SEC-10-07: OracleChain fallback 순서 (primary -> fallback -> cache, 순환 참조 없음) (SEC-ORC-07)
8. SEC-10-08: 0가격 토큰 (usdPrice=0) -> 정상 처리 (SEC-ORC-08)
9. SEC-10-09: 극단적 가격 정밀도 (BTC $100K+, 밈코인 $0.000001) -> 정밀도 손실 없음 (SEC-ORC-09)
10. SEC-10-10: 배치 부분 가격 실패 (5개 중 2개 실패) -> 성공분만 합산 (SEC-ORC-10)
11. SEC-10-11: Rate Limit 도달 (CoinGecko 429) -> fallback 전환 (SEC-ORC-11)
12. SEC-10-12: stale 가격 INSTANT -> NOTIFY 상향 (SEC-ORC-12)
13. SEC-10-13: crossValidationThreshold 경계값 (정확히 5%, 4.9%, 5.1%)
14. SEC-10-14: 캐시 TTL 만료 후 재요청
15. SEC-10-15: primary 성공 + fallback 실패 -> primary 신뢰
16. SEC-10-16: primary 실패 + fallback 성공 -> fallback 사용
17. SEC-10-17~20: getNativePrice 교차 검증, 다중 토큰 getPrices 부분 실패, 가격 0 -> 음수 검증, 캐시 stampede 방지 등 ~4건

OracleChain을 직접 생성하여 DI로 제어 가능한 mock oracle을 주입. InMemoryPriceCache 직접 import. calculateDeviation 내부 로직은 OracleChain이 관리하므로 외부에서 primary/fallback 가격을 설정하여 교차 검증 결과를 테스트.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/extension/batch-split-attacks.security.test.ts packages/daemon/src/__tests__/security/extension/oracle-manipulation-attacks.security.test.ts --reporter=verbose` 실행하여 42건 통과 확인.
  </verify>
  <done>
SEC-09 배치 분할 우회 22건 + SEC-10 Oracle 가격 조작 20건 = 42건 보안 시나리오 테스트가 모두 통과한다. 소액 분할 합산 방어, All-or-Nothing 정책, 교차 검증, stale 가격 티어 상향 등이 모두 증명된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: SEC-11 Action Provider 보안 16건 + SEC-12 Swap 슬리피지/MEV 보안 12건</name>
  <files>
    packages/daemon/src/__tests__/security/extension/action-provider-attacks.security.test.ts
    packages/daemon/src/__tests__/security/extension/swap-slippage-attacks.security.test.ts
  </files>
  <action>
**action-provider-attacks.security.test.ts (SEC-11, 16건):**

Setup: ActionProviderRegistry 직접 인스턴스화
- @packages/daemon/src/__tests__/mocks/mock-action-provider.ts의 createMockProvider, createMaliciousProvider 활용
- ActionProviderRegistry import from infrastructure/action/action-provider-registry.ts

시나리오 구성 (~16건, SEC-ACT-01~04 + 확장):
1. SEC-11-01: 타 지갑 from 반환 (resolve()가 context.walletAddress 아닌 다른 주소 설정) -> validateResolveResult() 거부 (SEC-ACT-01)
2. SEC-11-02: 직렬화된 트랜잭션 반환 (ContractCallRequestSchema 위반) -> Zod 검증 실패 (SEC-ACT-02)
3. SEC-11-03: 체인 형식 불일치 (Solana에 EVM 형식 반환) -> 검증 실패 (SEC-ACT-03)
4. SEC-11-04: 내장 프로바이더 이름 충돌 -> ACTION_NAME_CONFLICT 에러 (SEC-ACT-04)
5. SEC-11-05: resolve()에서 예외 발생 -> 적절한 에러 처리
6. SEC-11-06: inputSchema 검증 실패 (잘못된 파라미터) -> Zod 에러
7. SEC-11-07: metadata.mcpExpose=true인 악성 프로바이더 등록 -> MCP 도구 변환 위험 검증
8. SEC-11-08: 빈 actions 배열 프로바이더 등록 -> 허용/거부 동작
9. SEC-11-09: resolve()가 null/undefined 반환 -> 적절한 에러
10. SEC-11-10: inputSchema에 parse/safeParse 없는 프로바이더 -> ACTION_VALIDATION_FAILED
11. SEC-11-11: 동일 actionName을 가진 두 프로바이더 등록 -> 충돌 처리
12. SEC-11-12: 미등록 providerName/actionName으로 executeResolve 호출 -> ACTION_NOT_FOUND
13. SEC-11-13: ContractCallRequest.to가 빈 문자열 -> 검증 실패
14. SEC-11-14: 악의적 metadata (name에 특수문자, 빈 version 등) -> 스키마 검증
15. SEC-11-15: resolve()가 매우 큰 instructionData 반환 -> 크기 제한 검증
16. SEC-11-16: chains 필드에 없는 chain으로 resolve 호출 -> 체인 불일치 검증

ActionProviderRegistry를 직접 생성하고, createMaliciousProvider()로 각종 악성 반환값을 설정. register() -> executeResolve() 호출 순서. Zod 스키마 검증과 validateResolveResult() 내부 from === walletAddress 검증을 테스트.

**swap-slippage-attacks.security.test.ts (SEC-12, 12건):**

Setup: Jupiter swap 관련 Zod 스키마(inputSchema) + msw mock (필요 시)
- JupiterSwapProvider가 아직 존재하지 않으므로 (v2.3.1 이연), swap 관련 보안 검증은 Zod inputSchema 레벨과 Mock 기반으로 테스트
- 실제 슬리피지/priceImpact 검증 로직이 있는 파일을 확인하여 테스트

시나리오 구성 (~12건, SEC-SWP-01~04 + 확장):
1. SEC-12-01: 슬리피지 500bps 초과 -> inputSchema max(500) 강제 거부 (SEC-SWP-01)
2. SEC-12-02: 슬리피지 0bps -> 허용 (최소값)
3. SEC-12-03: 슬리피지 500bps -> 허용 (경계값)
4. SEC-12-04: 슬리피지 501bps -> 거부 (경계값 + 1)
5. SEC-12-05: priceImpact 1% 초과 -> 경고 또는 거부 (SEC-SWP-02)
6. SEC-12-06: programId 위조 (Jupiter 아닌 악의적 프로그램) -> 하드코딩 검증 (SEC-SWP-03)
7. SEC-12-07: 동일 토큰 스왑 (inputMint === outputMint) -> 거부 (SEC-SWP-04)
8. SEC-12-08: outAmount=0 (유동성 부족) -> 거부
9. SEC-12-09: 음수 슬리피지 -> inputSchema 거부
10. SEC-12-10: 비정수 슬리피지 (50.5bps) -> 처리 방식 검증
11. SEC-12-11: amount=0 스왑 -> 거부
12. SEC-12-12: 매우 큰 amount (2^64-1) 스왑 -> 범위 검증

참고: JupiterSwapProvider가 v2.3.1로 이연된 상태이므로, 실제 Jupiter 호출 테스트 대신 Zod inputSchema 검증 + Mock 기반 resolve() 반환값 검증에 집중. JupiterSwapProvider 구현 파일이 없으면 describe.skip 처리하거나, createMockProvider로 swap 시나리오의 핵심 검증(슬리피지 상한, priceImpact, programId)만 개념 검증으로 구현. 이 결정을 테스트 파일 상단 주석에 명시.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/extension/action-provider-attacks.security.test.ts packages/daemon/src/__tests__/security/extension/swap-slippage-attacks.security.test.ts --reporter=verbose` 실행하여 28건 통과 확인.
  </verify>
  <done>
SEC-11 Action Provider 보안 16건 + SEC-12 Swap 슬리피지/MEV 보안 12건 = 28건 보안 시나리오 테스트가 모두 통과한다. 악성 플러그인 from 위변조, 직렬화 TX 우회, 이름 충돌, 슬리피지 상한 등이 모두 방어됨이 증명된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/daemon/src/__tests__/security/extension/ --reporter=verbose` -> 156-01 + 156-02 합산 전체 통과
2. `pnpm test:security` -> Phase 155 기존 131건 + Phase 156 전체 통과
</verification>

<success_criteria>
1. SEC-09 배치 분할 우회 22건이 모두 통과한다 (소액 분할 합산 + All-or-Nothing)
2. SEC-10 Oracle 가격 조작 20건이 모두 통과한다 (교차 검증 실패, stale 가격, 전체 장애)
3. SEC-11 Action Provider 보안 16건이 모두 통과한다 (from 위변조, 스키마 검증, 이름 충돌)
4. SEC-12 Swap 슬리피지/MEV 보안 12건이 모두 통과한다 (500bps 상한, priceImpact, programId)
5. 기존 보안 테스트가 깨지지 않는다
</success_criteria>

<output>
After completion, create `.planning/phases/156-security-test-p2/156-02-SUMMARY.md`
</output>
