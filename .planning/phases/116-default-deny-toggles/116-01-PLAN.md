---
phase: 116-default-deny-toggles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/pipeline/database-policy-engine.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/infrastructure/settings/hot-reload.ts
  - packages/admin/src/pages/settings.tsx
autonomous: true

must_haves:
  truths:
    - "Admin UI/API에서 default_deny_tokens를 OFF로 전환하면 ALLOWED_TOKENS 미설정 월렛도 토큰 전송이 허용된다"
    - "Admin UI/API에서 default_deny_contracts를 OFF로 전환하면 CONTRACT_WHITELIST 미설정 월렛도 컨트랙트 호출이 허용된다"
    - "Admin UI/API에서 default_deny_spenders를 OFF로 전환하면 APPROVED_SPENDERS 미설정 월렛도 토큰 승인이 허용된다"
    - "화이트리스트 정책이 설정되어 있으면 토글과 무관하게 정상 화이트리스트 평가가 수행된다"
    - "3개 토글의 기본값은 모두 ON(기본 거부 유지)이며 hot-reload를 지원한다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "3개 토글 SETTING_DEFINITIONS"
      contains: "policy.default_deny_tokens"
    - path: "packages/daemon/src/pipeline/database-policy-engine.ts"
      provides: "SettingsService DI + 3개 메서드 토글 분기"
      contains: "settingsService"
    - path: "packages/daemon/src/lifecycle/daemon.ts"
      provides: "DatabasePolicyEngine에 settingsService 전달"
      contains: "settingsService"
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "SecuritySettings 섹션에 3개 체크박스"
      contains: "default_deny_tokens"
  key_links:
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      via: "constructor DI"
      pattern: "settingsService\\?.get\\('policy\\.default_deny_"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "new DatabasePolicyEngine(db, sqlite, settingsService)"
      pattern: "new DatabasePolicyEngine"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "PUT /admin/settings"
      via: "handleFieldChange('policy.default_deny_*', v)"
      pattern: "default_deny_"
---

<objective>
SettingsService에 3개 기본 거부 토글(default_deny_tokens/contracts/spenders)을 추가하고, DatabasePolicyEngine의 "no policy" 분기에 토글 확인 로직을 삽입하며, Admin UI SecuritySettings에 체크박스를 노출한다.

Purpose: 관리자가 기본 거부 정책을 개별적으로 ON/OFF 전환하여 운영 유연성을 확보한다.
Output: 3개 토글이 setting-keys.ts에 정의되고, DatabasePolicyEngine이 토글 값에 따라 분기하며, Admin UI에서 조작 가능한 상태.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/116-default-deny-toggles/116-RESEARCH.md
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/infrastructure/settings/hot-reload.ts
@packages/admin/src/pages/settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: SETTING_DEFINITIONS 3개 토글 추가 + DatabasePolicyEngine SettingsService DI + 분기 로직</name>
  <files>
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/pipeline/database-policy-engine.ts
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/infrastructure/settings/hot-reload.ts
  </files>
  <action>
1. **setting-keys.ts** -- `security.policy_defaults_approval_timeout` 항목 뒤(line 82 이후)에 3개 정의를 추가:
   ```typescript
   // --- policy default deny toggles (Phase 116) ---
   { key: 'policy.default_deny_tokens', category: 'security', configPath: 'security.default_deny_tokens', defaultValue: 'true', isCredential: false },
   { key: 'policy.default_deny_contracts', category: 'security', configPath: 'security.default_deny_contracts', defaultValue: 'true', isCredential: false },
   { key: 'policy.default_deny_spenders', category: 'security', configPath: 'security.default_deny_spenders', defaultValue: 'true', isCredential: false },
   ```
   주의: `key`는 `policy.*` prefix (논리적 도메인), `category`는 `security` (Admin UI 그룹), `defaultValue`는 `'true'`.

2. **database-policy-engine.ts** -- 3가지 변경:
   a. 파일 상단 import 추가:
      ```typescript
      import type { SettingsService } from '../infrastructure/settings/settings-service.js';
      ```
   b. 생성자 수정 (line 137-145): `settingsService` 선택적 파라미터 추가:
      ```typescript
      export class DatabasePolicyEngine implements IPolicyEngine {
        private readonly sqlite: SQLiteDatabase | null;
        private readonly settingsService: SettingsService | null;

        constructor(
          private readonly db: BetterSQLite3Database<typeof schema>,
          sqlite?: SQLiteDatabase,
          settingsService?: SettingsService,
        ) {
          this.sqlite = sqlite ?? null;
          this.settingsService = settingsService ?? null;
        }
      ```
   c. 3개 private 메서드의 "no policy" 분기에 토글 확인 삽입:

      - `evaluateAllowedTokens` (line 774): `if (!allowedTokensPolicy)` 블록 내부를 교체:
        ```typescript
        if (!allowedTokensPolicy) {
          if (this.settingsService?.get('policy.default_deny_tokens') === 'false') {
            return null; // default-allow mode: skip token whitelist check
          }
          return {
            allowed: false,
            tier: 'INSTANT',
            reason: 'Token transfer not allowed: no ALLOWED_TOKENS policy configured',
          };
        }
        ```

      - `evaluateContractWhitelist` (line 838): `if (!contractWhitelistPolicy)` 블록 내부를 교체:
        ```typescript
        if (!contractWhitelistPolicy) {
          if (this.settingsService?.get('policy.default_deny_contracts') === 'false') {
            return null; // default-allow mode: skip contract whitelist check
          }
          return {
            allowed: false,
            tier: 'INSTANT',
            reason: 'Contract calls disabled: no CONTRACT_WHITELIST policy configured',
          };
        }
        ```

      - `evaluateApprovedSpenders` (line 961): `if (!approvedSpendersPolicy)` 블록 내부를 교체:
        ```typescript
        if (!approvedSpendersPolicy) {
          if (this.settingsService?.get('policy.default_deny_spenders') === 'false') {
            return null; // default-allow mode: skip approved spenders check
          }
          return {
            allowed: false,
            tier: 'INSTANT',
            reason: 'Token approvals disabled: no APPROVED_SPENDERS policy configured',
          };
        }
        ```

      핵심: `settingsService?.get()` 사용으로 null-safe. settingsService가 null이면 `undefined === 'false'` -> false -> 기본 거부 유지 (안전한 폴백). 토글은 오직 "no policy exists" 분기에서만 확인 — 정책이 존재하면 토글 무관하게 화이트리스트 평가가 정상 수행됨 (TOGGLE-04).

3. **daemon.ts** -- line 369의 `new DatabasePolicyEngine(...)` 호출에 settingsService 전달:
   ```typescript
   policyEngine: new DatabasePolicyEngine(
     this._db!,
     this.sqlite ?? undefined,
     this._settingsService ?? undefined,
   ),
   ```

4. **hot-reload.ts** -- `SECURITY_KEYS` Set에 3개 키 추가 (변경 시 "Security parameters updated" 로그 출력용):
   ```typescript
   const SECURITY_KEYS = new Set([
     // ... 기존 8개 키 ...
     'policy.default_deny_tokens',
     'policy.default_deny_contracts',
     'policy.default_deny_spenders',
   ]);
   ```
   실제 hot-reload 동작은 SettingsService.get()이 매번 DB 조회하므로 자동 지원. 이 추가는 운영자 로그 가시성을 위한 것.
  </action>
  <verify>
1. `npx tsc --noEmit -p packages/daemon/tsconfig.json` -- 타입 에러 없음
2. `npx vitest run packages/daemon/src/__tests__/database-policy-engine.test.ts` -- 기존 테스트 모두 통과 (settingsService 미전달 시 기본 거부 유지)
3. `grep -c 'policy.default_deny' packages/daemon/src/infrastructure/settings/setting-keys.ts` == 3
4. `grep -c 'settingsService' packages/daemon/src/pipeline/database-policy-engine.ts` >= 5
  </verify>
  <done>
- setting-keys.ts에 3개 토글 SETTING_DEFINITIONS 추가됨 (key: policy.*, category: security, default: 'true')
- DatabasePolicyEngine 생성자에 선택적 settingsService 파라미터 추가됨
- evaluateAllowedTokens/evaluateContractWhitelist/evaluateApprovedSpenders의 "no policy" 분기에 토글 확인 삽입됨
- daemon.ts에서 settingsService가 DatabasePolicyEngine에 전달됨
- hot-reload.ts의 SECURITY_KEYS에 3개 키 추가됨
- 기존 테스트 모두 통과 (하위 호환)
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin UI SecuritySettings에 Default Deny Toggles 체크박스 추가</name>
  <files>
    packages/admin/src/pages/settings.tsx
  </files>
  <action>
1. **keyToLabel 맵** (line 52-85)에 3개 라벨 매핑 추가:
   ```typescript
   default_deny_tokens: 'Default Deny: Token Transfers',
   default_deny_contracts: 'Default Deny: Contract Calls',
   default_deny_spenders: 'Default Deny: Token Approvals',
   ```
   `policy_defaults_approval_timeout` 항목 뒤에 추가.

2. **SecuritySettings 함수** (line 559-595)에서 기존 `<div class="settings-fields-grid">` 블록 다음에 Default Deny Toggles 서브그룹 추가:
   `</div>` (line 591, settings-fields-grid 닫힘) 바로 뒤, `</div>` (settings-category-body 닫힘, line 592) 앞에 다음을 삽입:

   ```tsx
   {/* Default Deny Policy Toggles */}
   <div class="settings-subgroup" style={{ marginTop: '1rem', borderTop: '1px solid var(--border)', paddingTop: '1rem' }}>
     <h4 style={{ margin: '0 0 0.5rem 0', fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-secondary)' }}>Default Deny Policies</h4>
     <p class="settings-description" style={{ marginBottom: '0.75rem' }}>
       When enabled, transactions are denied if no matching whitelist policy exists.
       Disable to allow all transactions of that type when no policy is configured.
     </p>
     <div class="settings-fields-grid">
       <FormField
         label={keyToLabel('default_deny_tokens')}
         name="policy.default_deny_tokens"
         type="checkbox"
         value={getEffectiveBoolValue('security', 'default_deny_tokens')}
         onChange={(v) => handleFieldChange('policy.default_deny_tokens', v)}
       />
       <FormField
         label={keyToLabel('default_deny_contracts')}
         name="policy.default_deny_contracts"
         type="checkbox"
         value={getEffectiveBoolValue('security', 'default_deny_contracts')}
         onChange={(v) => handleFieldChange('policy.default_deny_contracts', v)}
       />
       <FormField
         label={keyToLabel('default_deny_spenders')}
         name="policy.default_deny_spenders"
         type="checkbox"
         value={getEffectiveBoolValue('security', 'default_deny_spenders')}
         onChange={(v) => handleFieldChange('policy.default_deny_spenders', v)}
       />
     </div>
   </div>
   ```

   핵심: `getEffectiveBoolValue('security', 'default_deny_tokens')` -- category는 `security`, shortKey는 `default_deny_tokens`. 이는 SETTING_DEFINITIONS의 `category: 'security'` + `key.split('.').slice(1) = 'default_deny_tokens'`와 일치. `handleFieldChange`는 full key `'policy.default_deny_tokens'`를 사용하여 PUT /admin/settings에 올바른 키를 전달.
  </action>
  <verify>
1. `npx tsc --noEmit -p packages/admin/tsconfig.json` -- 타입 에러 없음 (또는 Vite build 확인)
2. `grep -c 'default_deny' packages/admin/src/pages/settings.tsx` >= 9 (3 labels + 3 checkboxes + 3 handlers)
3. Admin UI 빌드: `cd packages/admin && npx vite build` -- 에러 없음
  </verify>
  <done>
- SecuritySettings에 "Default Deny Policies" 서브그룹이 표시됨
- 3개 체크박스: Default Deny: Token Transfers, Default Deny: Contract Calls, Default Deny: Token Approvals
- 체크 해제(OFF) 시 해당 기본 거부가 비활성화됨
- keyToLabel에 3개 라벨 매핑 추가됨
  </done>
</task>

</tasks>

<verification>
1. **타입 체크**: `npx tsc --noEmit -p packages/daemon/tsconfig.json && npx tsc --noEmit -p packages/admin/tsconfig.json` -- 에러 없음
2. **기존 테스트**: `npx vitest run packages/daemon/src/__tests__/database-policy-engine.test.ts` -- 모든 기존 테스트 통과 (settingsService 미전달 시 기본 거부 유지)
3. **Admin 빌드**: `cd packages/admin && npx vite build` -- 에러 없음
4. **SETTING_DEFINITIONS 확인**: 3개 토글 키가 setting-keys.ts에 존재
5. **DatabasePolicyEngine DI 확인**: 생성자에 settingsService 파라미터 존재, 3개 메서드에 토글 확인 분기 존재
</verification>

<success_criteria>
- setting-keys.ts에 policy.default_deny_tokens/contracts/spenders 3개 정의 존재
- DatabasePolicyEngine이 settingsService를 선택적으로 받아 3개 메서드에서 토글 확인
- daemon.ts에서 settingsService가 DatabasePolicyEngine에 전달됨
- Admin UI SecuritySettings에 3개 체크박스 노출
- 기존 테스트 모두 통과 (하위 호환)
</success_criteria>

<output>
After completion, create `.planning/phases/116-default-deny-toggles/116-01-SUMMARY.md`
</output>
