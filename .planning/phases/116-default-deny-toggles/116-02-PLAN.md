---
phase: 116-default-deny-toggles
plan: 02
type: tdd
wave: 2
depends_on: ["116-01"]
files_modified:
  - packages/daemon/src/__tests__/database-policy-engine.test.ts
autonomous: true

must_haves:
  truths:
    - "default_deny_tokens=true(기본값)이고 ALLOWED_TOKENS 정책 없으면 TOKEN_TRANSFER가 거부된다"
    - "default_deny_tokens=false이고 ALLOWED_TOKENS 정책 없으면 TOKEN_TRANSFER가 SPENDING_LIMIT만으로 평가된다"
    - "default_deny_contracts=false이고 CONTRACT_WHITELIST 정책 없으면 CONTRACT_CALL이 허용된다"
    - "default_deny_spenders=false이고 APPROVED_SPENDERS 정책 없으면 APPROVE가 허용된다"
    - "화이트리스트 정책 존재 시 토글과 무관하게 정상 화이트리스트 평가가 수행된다"
    - "토글 값 변경 시 다음 evaluate() 호출에 즉시 반영된다 (hot-reload)"
  artifacts:
    - path: "packages/daemon/src/__tests__/database-policy-engine.test.ts"
      provides: "Default Deny Toggles 테스트 suite"
      contains: "Default Deny Toggles"
  key_links:
    - from: "packages/daemon/src/__tests__/database-policy-engine.test.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "new DatabasePolicyEngine(db, undefined, settingsService)"
      pattern: "new DatabasePolicyEngine.*settingsService"
---

<objective>
DatabasePolicyEngine의 Default Deny Toggles 동작을 TDD로 검증한다. 기본 거부 ON/OFF, 화이트리스트 공존, hot-reload 시나리오를 포함한다.

Purpose: TOGGLE-01 ~ TOGGLE-05 요구사항이 코드에 올바르게 구현되었는지 자동화된 테스트로 보장한다.
Output: database-policy-engine.test.ts에 "Default Deny Toggles" describe 블록 추가.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/116-default-deny-toggles/116-RESEARCH.md
@.planning/phases/116-default-deny-toggles/116-01-SUMMARY.md
@packages/daemon/src/__tests__/database-policy-engine.test.ts
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/infrastructure/settings/settings-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Default Deny Toggles TDD 테스트 작성 (RED → GREEN)</name>
  <files>
    packages/daemon/src/__tests__/database-policy-engine.test.ts
  </files>
  <action>
파일 끝(마지막 `});` 앞 또는 뒤)에 `describe('DatabasePolicyEngine - Default Deny Toggles', ...)` 블록을 추가한다. SettingsService를 실제 인스턴스로 생성하여 DatabasePolicyEngine에 DI한다.

**Setup 패턴:**

```typescript
import { SettingsService } from '../infrastructure/settings/settings-service.js';
import { createTestConfig } from './test-helpers.js'; // 또는 인라인 config
```

SettingsService 생성에 필요한 인자를 확인하고 (`{ db, config, masterPassword }` 패턴), 테스트용 인스턴스를 생성한다. `createTestConfig`가 없으면 기존 테스트 패턴에서 config 생성 방법을 확인하여 인라인으로 구성한다. SettingsService 생성이 복잡하다면 settingsService를 mock으로 대체해도 좋다 — 핵심은 `get(key)` 메서드가 올바른 값을 반환하는 것:

```typescript
// Mock 대안 (SettingsService 생성이 복잡할 경우):
const mockSettings = { get: (key: string) => settingsMap.get(key) } as any;
```

**테스트 케이스 (최소 10개):**

```typescript
describe('DatabasePolicyEngine - Default Deny Toggles', () => {
  // --- TOGGLE-01: default_deny_tokens ---

  it('denies TOKEN_TRANSFER when default_deny_tokens=true (default) and no ALLOWED_TOKENS policy', async () => {
    // settingsService 없이 engine 생성 (기본 거부 유지)
    const result = await engine.evaluate(walletId, tokenTx('1000', 'SomeToken111'));
    expect(result.allowed).toBe(false);
    expect(result.reason).toContain('no ALLOWED_TOKENS');
  });

  it('allows TOKEN_TRANSFER when default_deny_tokens=false and no ALLOWED_TOKENS policy', async () => {
    // settingsService.get('policy.default_deny_tokens') === 'false'
    // SPENDING_LIMIT 정책 필요 (아니면 "no policies" passthrough)
    await insertPolicy({ type: 'SPENDING_LIMIT', rules: JSON.stringify({ instant_max: '999999999', notify_max: '999999999', delay_max: '999999999', approval_max: '999999999' }), priority: 1 });
    const result = await engineWithToggle.evaluate(walletId, tokenTx('1000', 'SomeToken111'));
    expect(result.allowed).toBe(true);
  });

  // --- TOGGLE-02: default_deny_contracts ---

  it('denies CONTRACT_CALL when default_deny_contracts=true (default) and no CONTRACT_WHITELIST policy', async () => {
    const result = await engine.evaluate(walletId, contractCallTx({ contractAddress: '0x1234567890abcdef' }));
    expect(result.allowed).toBe(false);
    expect(result.reason).toContain('no CONTRACT_WHITELIST');
  });

  it('allows CONTRACT_CALL when default_deny_contracts=false and no CONTRACT_WHITELIST policy', async () => {
    await insertPolicy({ type: 'SPENDING_LIMIT', rules: JSON.stringify({ instant_max: '999999999', notify_max: '999999999', delay_max: '999999999', approval_max: '999999999' }), priority: 1 });
    const result = await engineWithToggle.evaluate(walletId, contractCallTx({ contractAddress: '0x1234567890abcdef' }));
    expect(result.allowed).toBe(true);
  });

  // --- TOGGLE-03: default_deny_spenders ---

  it('denies APPROVE when default_deny_spenders=true (default) and no APPROVED_SPENDERS policy', async () => {
    const result = await engine.evaluate(walletId, approveTx({ spenderAddress: '0xSpender' }));
    expect(result.allowed).toBe(false);
    expect(result.reason).toContain('no APPROVED_SPENDERS');
  });

  it('allows APPROVE when default_deny_spenders=false and no APPROVED_SPENDERS policy', async () => {
    // APPROVE는 APPROVE_TIER_OVERRIDE가 없으면 기본 APPROVAL 티어 적용
    // toggles off + no APPROVED_SPENDERS -> skip spenders check -> APPROVE_AMOUNT_LIMIT check -> APPROVE_TIER_OVERRIDE check
    // 모든 approve 관련 정책이 없으면 결국 SPENDING_LIMIT 평가로 진행
    await insertPolicy({ type: 'SPENDING_LIMIT', rules: JSON.stringify({ instant_max: '999999999', notify_max: '999999999', delay_max: '999999999', approval_max: '999999999' }), priority: 1 });
    const result = await engineWithToggle.evaluate(walletId, approveTx({ spenderAddress: '0xSpender' }));
    // APPROVE_TIER_OVERRIDE 없으면 기본 APPROVAL 티어 → allowed true, tier APPROVAL
    expect(result.allowed).toBe(true);
  });

  // --- TOGGLE-04: 화이트리스트 정책 존재 시 토글 무시 ---

  it('evaluates ALLOWED_TOKENS whitelist normally when policy exists, regardless of toggle=false', async () => {
    // toggle OFF + ALLOWED_TOKENS policy exists -> whitelist evaluation
    await insertPolicy({
      type: 'ALLOWED_TOKENS',
      rules: JSON.stringify({ tokens: [{ address: 'AllowedToken1' }] }),
      priority: 15,
    });
    // Token NOT in whitelist -> deny by whitelist, not by toggle
    const result = await engineWithToggle.evaluate(walletId, tokenTx('1000', 'NotAllowedToken'));
    expect(result.allowed).toBe(false);
    expect(result.reason).toContain('not in allowed');
  });

  it('evaluates CONTRACT_WHITELIST normally when policy exists, regardless of toggle=false', async () => {
    await insertPolicy({
      type: 'CONTRACT_WHITELIST',
      rules: JSON.stringify({ contracts: [{ address: '0xAllowedContract' }] }),
      priority: 15,
    });
    const result = await engineWithToggle.evaluate(walletId, contractCallTx({ contractAddress: '0xNotAllowed' }));
    expect(result.allowed).toBe(false);
    expect(result.reason).toContain('not whitelisted');
  });

  it('evaluates APPROVED_SPENDERS normally when policy exists, regardless of toggle=false', async () => {
    await insertPolicy({
      type: 'APPROVED_SPENDERS',
      rules: JSON.stringify({ spenders: [{ address: '0xApprovedSpender' }] }),
      priority: 15,
    });
    const result = await engineWithToggle.evaluate(walletId, approveTx({ spenderAddress: '0xNotApproved' }));
    expect(result.allowed).toBe(false);
    expect(result.reason).toContain('not in approved');
  });

  // --- TOGGLE-05: hot-reload ---

  it('reflects toggle change on next evaluate() call (hot-reload)', async () => {
    await insertPolicy({ type: 'SPENDING_LIMIT', rules: JSON.stringify({ instant_max: '999999999', notify_max: '999999999', delay_max: '999999999', approval_max: '999999999' }), priority: 1 });

    // Initially: deny (toggle = true by default if using settingsMap)
    // Then set to false -> allow
    // Then set back to true -> deny again
    // 이 테스트에서 settingsMap 또는 settingsService.set()으로 동적 변경
  });
```

**주의사항:**
- `engineWithToggle`은 beforeEach에서 SettingsService(또는 mock) + `default_deny_*=false`로 생성한 DatabasePolicyEngine 인스턴스
- hot-reload 테스트: settingsMap/settingsService를 동적으로 변경하고 다시 evaluate() 호출
- APPROVE 테스트에서 APPROVE_TIER_OVERRIDE/APPROVE_AMOUNT_LIMIT이 없으면 기본 APPROVAL 티어가 적용됨 — 실제 코드 동작을 확인하고 expect를 조정
- 기존 테스트의 `insertPolicy`, `tokenTx`, `contractCallTx`, `approveTx` 헬퍼를 재사용

RED 단계에서 테스트를 먼저 작성하고 `npx vitest run --reporter=verbose` 으로 실행하여 실패를 확인한다. 116-01이 이미 구현되었으므로 GREEN이어야 하지만, 테스트 작성 중 구현 미비점이 발견되면 database-policy-engine.ts를 수정한다.
  </action>
  <verify>
1. `npx vitest run packages/daemon/src/__tests__/database-policy-engine.test.ts --reporter=verbose` -- 모든 테스트 통과
2. "Default Deny Toggles" describe 블록에 최소 10개 테스트 존재
3. 기존 테스트도 모두 통과 (하위 호환)
  </verify>
  <done>
- "Default Deny Toggles" describe 블록 추가 (최소 10개 테스트)
- TOGGLE-01: default_deny_tokens ON/OFF 동작 검증 (2개)
- TOGGLE-02: default_deny_contracts ON/OFF 동작 검증 (2개)
- TOGGLE-03: default_deny_spenders ON/OFF 동작 검증 (2개)
- TOGGLE-04: 화이트리스트 정책 존재 시 토글 무관 검증 (3개)
- TOGGLE-05: hot-reload 동적 변경 검증 (1개+)
- 모든 기존 + 신규 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon/src/__tests__/database-policy-engine.test.ts --reporter=verbose` -- 전체 테스트 통과
2. "Default Deny Toggles" describe 블록에서 TOGGLE-01 ~ TOGGLE-05 각각 최소 1개 테스트 존재
3. 기존 테스트 (SPENDING_LIMIT, WHITELIST, ALLOWED_TOKENS, CONTRACT_WHITELIST 등) 모두 통과
</verification>

<success_criteria>
- Default Deny Toggles describe 블록에 최소 10개 테스트 존재
- 모든 테스트 통과 (신규 + 기존)
- TOGGLE-01 ~ TOGGLE-05 각 요구사항에 매핑되는 테스트 존재
</success_criteria>

<output>
After completion, create `.planning/phases/116-default-deny-toggles/116-02-SUMMARY.md`
</output>
