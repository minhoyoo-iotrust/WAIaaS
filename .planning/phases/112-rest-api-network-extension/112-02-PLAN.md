---
phase: 112-rest-api-network-extension
plan: 02
type: execute
wave: 2
depends_on: ["112-01"]
files_modified:
  - packages/daemon/src/api/routes/wallets.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/api-wallet-network.test.ts
autonomous: true

must_haves:
  truths:
    - "PUT /v1/wallets/:id/default-network으로 기본 네트워크를 변경할 수 있다"
    - "GET /v1/wallets/:id/networks로 사용 가능 네트워크 목록을 조회할 수 있다"
    - "PUT /v1/wallets/:id/default-network에서 환경 불일치 네트워크 지정 시 ENVIRONMENT_NETWORK_MISMATCH 에러가 반환된다"
    - "ALLOWED_NETWORKS 정책을 POST /v1/policies로 생성하고 GET /v1/policies로 조회할 수 있다"
    - "GET /v1/wallets/:id/networks 응답에 chain, environment, defaultNetwork, availableNetworks가 포함된다"
  artifacts:
    - path: "packages/daemon/src/api/routes/wallets.ts"
      provides: "PUT /wallets/:id/default-network + GET /wallets/:id/networks 엔드포인트"
      contains: "default-network"
    - path: "packages/daemon/src/__tests__/api-wallet-network.test.ts"
      provides: "신규 엔드포인트 통합 테스트"
      contains: "default-network"
  key_links:
    - from: "packages/daemon/src/api/routes/wallets.ts"
      to: "@waiaas/core getNetworksForEnvironment"
      via: "import getNetworksForEnvironment"
      pattern: "getNetworksForEnvironment"
    - from: "packages/daemon/src/api/routes/wallets.ts"
      to: "@waiaas/core validateNetworkEnvironment"
      via: "import validateNetworkEnvironment"
      pattern: "validateNetworkEnvironment"
    - from: "packages/daemon/src/api/server.ts"
      to: "wallets.ts new routes"
      via: "masterAuth middleware for new paths"
      pattern: "default-network|networks"
---

<objective>
PUT /v1/wallets/:id/default-network (기본 네트워크 변경) + GET /v1/wallets/:id/networks (사용 가능 네트워크 목록) 신규 엔드포인트를 추가하고, ALLOWED_NETWORKS 정책 CRUD가 동작함을 확인한다.

Purpose: 월렛별 네트워크 관리 기능을 REST API로 노출하여, API 사용자가 기본 네트워크를 변경하고 사용 가능 네트워크를 조회할 수 있게 한다.
Output: 2개 신규 엔드포인트 + ALLOWED_NETWORKS CRUD 검증 + 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/112-rest-api-network-extension/112-01-SUMMARY.md
@packages/daemon/src/api/routes/wallets.ts
@packages/daemon/src/api/routes/policies.ts
@packages/daemon/src/api/server.ts
@packages/core/src/enums/chain.ts
@packages/core/src/schemas/policy.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PUT /wallets/:id/default-network + GET /wallets/:id/networks 신규 엔드포인트</name>
  <files>
    packages/daemon/src/api/routes/wallets.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
1. **openapi-schemas.ts** -- 신규 응답/요청 스키마 추가:
   ```ts
   // PUT /wallets/:id/default-network request
   export const UpdateDefaultNetworkRequestSchema = z
     .object({
       network: z.string().min(1),
     })
     .openapi('UpdateDefaultNetworkRequest');

   // PUT /wallets/:id/default-network response
   export const UpdateDefaultNetworkResponseSchema = z
     .object({
       id: z.string().uuid(),
       defaultNetwork: z.string(),
       previousNetwork: z.string().nullable(),
     })
     .openapi('UpdateDefaultNetworkResponse');

   // GET /wallets/:id/networks response
   export const WalletNetworksResponseSchema = z
     .object({
       id: z.string().uuid(),
       chain: z.string(),
       environment: z.string(),
       defaultNetwork: z.string().nullable(),
       availableNetworks: z.array(
         z.object({
           network: z.string(),
           isDefault: z.boolean(),
         }),
       ),
     })
     .openapi('WalletNetworksResponse');
   ```

2. **wallets.ts** -- 신규 라우트 정의 + 핸들러:
   - import 추가: `getNetworksForEnvironment, validateNetworkEnvironment` from `@waiaas/core`
   - import 추가: openapi-schemas에서 `UpdateDefaultNetworkRequestSchema, UpdateDefaultNetworkResponseSchema, WalletNetworksResponseSchema`

   **PUT /wallets/:id/default-network 라우트 정의:**
   ```ts
   const updateDefaultNetworkRoute = createRoute({
     method: 'put',
     path: '/wallets/{id}/default-network',
     tags: ['Wallets'],
     summary: 'Update wallet default network',
     request: {
       params: z.object({ id: z.string().uuid() }),
       body: {
         content: {
           'application/json': { schema: UpdateDefaultNetworkRequestSchema },
         },
       },
     },
     responses: {
       200: {
         description: 'Default network updated',
         content: { 'application/json': { schema: UpdateDefaultNetworkResponseSchema } },
       },
       ...buildErrorResponses(['WALLET_NOT_FOUND', 'ENVIRONMENT_NETWORK_MISMATCH']),
     },
   });
   ```

   **PUT handler:**
   - wallet 조회 (404 처리)
   - wallet.status === 'TERMINATED' 체크 (WALLET_TERMINATED 에러)
   - `validateNetworkEnvironment(wallet.chain, wallet.environment, body.network)` 호출. catch 시 ENVIRONMENT_NETWORK_MISMATCH 에러 (환경-네트워크 불일치)
   - `previousNetwork = wallet.defaultNetwork`
   - DB UPDATE: `set({ defaultNetwork: body.network, updatedAt: now })`
   - 응답: `{ id, defaultNetwork: body.network, previousNetwork }`

   **GET /wallets/:id/networks 라우트 정의:**
   ```ts
   const walletNetworksRoute = createRoute({
     method: 'get',
     path: '/wallets/{id}/networks',
     tags: ['Wallets'],
     summary: 'List available networks for wallet',
     request: {
       params: z.object({ id: z.string().uuid() }),
     },
     responses: {
       200: {
         description: 'Available networks',
         content: { 'application/json': { schema: WalletNetworksResponseSchema } },
       },
       ...buildErrorResponses(['WALLET_NOT_FOUND']),
     },
   });
   ```

   **GET handler:**
   - wallet 조회 (404 처리)
   - `const networks = getNetworksForEnvironment(wallet.chain, wallet.environment)`
   - 응답:
     ```ts
     {
       id: wallet.id,
       chain: wallet.chain,
       environment: wallet.environment,
       defaultNetwork: wallet.defaultNetwork,
       availableNetworks: networks.map(n => ({
         network: n,
         isDefault: n === wallet.defaultNetwork,
       })),
     }
     ```

3. **server.ts** -- 신규 엔드포인트 인증 미들웨어 등록:
   - `/v1/wallets/:id/default-network`과 `/v1/wallets/:id/networks`에 masterAuth 적용
   - 기존 `/v1/wallets/:id` 미들웨어 핸들러에서 `/default-network`과 `/networks` 서브패스를 `/owner`와 동일하게 skip 처리:
     ```ts
     // 기존:
     if (c.req.path.includes('/owner')) {
     // 변경:
     if (c.req.path.includes('/owner') || c.req.path.includes('/default-network') || c.req.path.includes('/networks')) {
     ```
   - 별도 masterAuth 등록:
     ```ts
     app.use('/v1/wallets/:id/default-network', masterAuthForOwner); // 기존 masterAuthForOwner 재사용 가능
     app.use('/v1/wallets/:id/networks', masterAuthForOwner);
     ```
   - 주의: 라우트 등록 순서상 walletCrudRoutes 안에 신규 라우트가 포함되므로 별도 route() 불필요

빌드 확인: `pnpm --filter @waiaas/daemon build` 성공 확인
  </action>
  <verify>
`pnpm --filter @waiaas/daemon build` 성공. wallets.ts에 updateDefaultNetworkRoute + walletNetworksRoute 존재. server.ts에 /default-network 미들웨어 등록 존재.
  </verify>
  <done>
PUT /wallets/:id/default-network + GET /wallets/:id/networks 2개 엔드포인트가 빌드 성공하고, masterAuth 미들웨어가 적용되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 신규 엔드포인트 통합 테스트 + ALLOWED_NETWORKS CRUD 검증 + 빌드/테스트 회귀</name>
  <files>
    packages/daemon/src/__tests__/api-wallet-network.test.ts
  </files>
  <action>
1. **api-wallet-network.test.ts** 신규 테스트 파일 생성:
   - 기존 api-agents.test.ts 또는 api-policies.test.ts의 테스트 패턴(createApp, 인메모리 DB, masterAuth 헤더)을 참고
   - 테스트 setup: createApp + DB + wallet 생성 (chain=ethereum, environment=testnet)

   **테스트 케이스 (8개):**

   a. `PUT /v1/wallets/:id/default-network` 정상 변경:
      - ethereum testnet 월렛의 defaultNetwork를 ethereum-sepolia -> polygon-amoy로 변경
      - 응답: 200, `{ id, defaultNetwork: 'polygon-amoy', previousNetwork: 'ethereum-sepolia' }`

   b. `PUT /v1/wallets/:id/default-network` 환경 불일치:
      - testnet 월렛에 ethereum-mainnet 지정
      - 응답: 400, ENVIRONMENT_NETWORK_MISMATCH

   c. `PUT /v1/wallets/:id/default-network` 월렛 미존재:
      - 존재하지 않는 UUID
      - 응답: 404, WALLET_NOT_FOUND

   d. `GET /v1/wallets/:id/networks` 정상 조회:
      - ethereum testnet 월렛
      - 응답: 200, availableNetworks에 5개 테스트넷 (ethereum-sepolia, polygon-amoy, arbitrum-sepolia, optimism-sepolia, base-sepolia)
      - 현재 defaultNetwork에 isDefault: true

   e. `GET /v1/wallets/:id/networks` 월렛 미존재:
      - 응답: 404

   f. `POST /v1/policies` ALLOWED_NETWORKS 생성:
      - type: ALLOWED_NETWORKS, rules: { networks: [{ network: 'ethereum-sepolia' }, { network: 'polygon-amoy' }] }
      - 응답: 201, rules에 networks 배열 포함

   g. `GET /v1/policies` ALLOWED_NETWORKS 조회:
      - 위에서 생성한 정책이 목록에 포함
      - type: ALLOWED_NETWORKS, network 필드 확인

   h. `DELETE /v1/policies/:id` ALLOWED_NETWORKS 삭제:
      - 위에서 생성한 정책 삭제
      - 응답: 200, deleted: true

2. 전체 회귀 확인:
   - `pnpm build` (전체 모노레포)
   - `pnpm --filter @waiaas/daemon test` (daemon 전체 테스트)
  </action>
  <verify>
`pnpm build` 성공. `pnpm --filter @waiaas/daemon test -- --testPathPattern api-wallet-network` 실행 시 8개 테스트 PASS. `pnpm --filter @waiaas/daemon test` 전체 통과 (pre-existing flaky 제외).
  </verify>
  <done>
PUT /wallets/:id/default-network + GET /wallets/:id/networks + ALLOWED_NETWORKS CRUD가 통합 테스트에서 검증되고, 전체 빌드/테스트 회귀가 없다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` 성공 (전체 모노레포)
2. `pnpm --filter @waiaas/daemon test` 통과 (pre-existing flaky 제외)
3. PUT /wallets/:id/default-network 라우트 존재 + masterAuth 적용
4. GET /wallets/:id/networks 라우트 존재 + masterAuth 적용
5. api-wallet-network.test.ts에 8개 테스트 PASS
6. ALLOWED_NETWORKS 정책 CRUD 테스트 PASS
</verification>

<success_criteria>
- PUT /wallets/:id/default-network으로 기본 네트워크 변경 가능 (환경 교차 검증 포함)
- GET /wallets/:id/networks로 사용 가능 네트워크 목록 조회 가능
- ALLOWED_NETWORKS 정책 CRUD가 REST API로 동작
- 신규 8개 통합 테스트 PASS + 전체 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/112-rest-api-network-extension/112-02-SUMMARY.md`
</output>
