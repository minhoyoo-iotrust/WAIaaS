---
phase: 112-rest-api-network-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/wallet.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/__tests__/api-agents.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /v1/wallet/balance?network=polygon-mainnet 요청 시 해당 네트워크의 잔액이 반환된다"
    - "GET /v1/wallet/assets?network=polygon-mainnet 요청 시 해당 네트워크의 자산 목록이 반환된다"
    - "GET /v1/wallet/balance에 network 미지정 시 wallet.defaultNetwork 잔액이 반환된다 (하위호환)"
    - "트랜잭션 목록/상세 API 응답에 network 필드가 포함된다"
    - "POST /v1/wallets 응답에 environment 필드가 포함된다"
    - "[API-01 선행완료] POST /v1/wallets 요청에 environment 파라미터가 동작한다 (Phase 110-01에서 구현 완료, 빌드/테스트로 확인)"
    - "[API-02 선행완료] POST /v1/transactions/send 요청에 network 파라미터가 동작한다 (Phase 110-01 스키마 + Phase 111 resolveNetwork 파이프라인으로 구현 완료, 빌드/테스트로 확인)"
  artifacts:
    - path: "packages/daemon/src/api/routes/wallet.ts"
      provides: "balance/assets 엔드포인트 network 쿼리 파라미터"
      contains: "network"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "network 필드 포함 응답 스키마"
      contains: "network"
  key_links:
    - from: "packages/daemon/src/api/routes/wallet.ts"
      to: "resolveRpcUrl + adapterPool.resolve"
      via: "network query param -> resolveRpcUrl(config, chain, network)"
      pattern: "resolveRpcUrl.*network"
---

<objective>
GET /wallet/balance + GET /wallet/assets에 network 쿼리 파라미터를 추가하고, 트랜잭션/월렛 응답에 network/environment 필드를 보강한다.

Purpose: REST API 사용자가 특정 네트워크의 잔액/자산을 조회할 수 있게 하고, 응답에서 네트워크 정보를 확인할 수 있게 한다.
Output: network 쿼리 파라미터가 동작하는 balance/assets 엔드포인트 + network/environment 보강된 응답 스키마
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/110-schema-policy-engine/110-01-SUMMARY.md
@.planning/phases/111-pipeline-network-resolution/111-02-SUMMARY.md
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/core/src/enums/chain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: GET /wallet/balance + GET /wallet/assets network 쿼리 파라미터 + 응답 스키마 보강</name>
  <files>
    packages/daemon/src/api/routes/wallet.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
  </files>
  <action>
1. **openapi-schemas.ts** - 응답 스키마에 environment 필드 추가:
   - `WalletCrudResponseSchema`에 `environment: z.string()` 필드 추가 (optional 제거, required로 전환)
   - `WalletBalanceResponseSchema` + `WalletAssetsResponseSchema`는 이미 `network` 있으므로 변경 불필요
   - `TxDetailResponseSchema`에 `network: z.string().nullable()` 필드 추가 (트랜잭션 상세에 네트워크 표시)

2. **wallet.ts** - balance/assets 라우트에 network 쿼리 파라미터 추가:
   - `walletBalanceRoute` 정의에 `request.query` 추가:
     ```ts
     request: {
       query: z.object({
         network: z.string().optional(),
       }),
     },
     ```
   - `walletAssetsRoute` 정의에 동일한 query 추가
   - balance handler에서: `const { network: queryNetwork } = c.req.valid('query')` 또는 없으면 `c.req.query('network')`
   - 네트워크 결정 로직:
     ```ts
     import { validateNetworkEnvironment } from '@waiaas/core';
     import type { EnvironmentType } from '@waiaas/core';

     // network 쿼리 파라미터가 있으면 그것을 사용, 없으면 wallet.defaultNetwork
     const targetNetwork = queryNetwork ?? wallet.defaultNetwork!;

     // 쿼리 파라미터 지정 시 환경 교차 검증
     if (queryNetwork) {
       try {
         validateNetworkEnvironment(
           wallet.chain as ChainType,
           wallet.environment as EnvironmentType,
           queryNetwork as NetworkType,
         );
       } catch (err) {
         throw new WAIaaSError('ENVIRONMENT_NETWORK_MISMATCH', {
           message: err instanceof Error ? err.message : 'Network validation failed',
         });
       }
     }
     ```
   - `resolveRpcUrl` + `adapterPool.resolve`에 `targetNetwork` 전달 (기존 `wallet.defaultNetwork!` 대체)
   - 응답 JSON의 `network` 값을 `targetNetwork`로 변경
   - assets handler에도 동일 패턴 적용
   - assets handler에서 tokenRegistryService 호출 시 `wallet.defaultNetwork!` -> `targetNetwork`로 변경

3. **wallet.ts** - address handler 응답에 `environment` 추가:
   - 기존 address handler 응답에 `environment: wallet.environment` 추가

4. **wallets.ts** 응답 보강 -- POST /wallets + GET /wallets + GET /wallets/:id + PUT 응답에 `environment` 필드 추가:
   - POST /wallets 201 응답에 `environment` 필드 추가 (이미 `environment` 변수 있음)
   - GET /wallets (list) 각 항목에 `environment: a.environment` 추가
   - GET /wallets/:id (detail) 응답에 `environment: wallet.environment` 추가
   - PUT /wallets/:id 응답에 `environment: wallet.environment` 추가
   - PUT /wallets/:id/owner 응답에 `environment: updated!.environment` 추가

빌드 확인: `pnpm --filter @waiaas/daemon build` 성공 확인
  </action>
  <verify>
`pnpm --filter @waiaas/daemon build` 성공. openapi-schemas.ts의 TxDetailResponseSchema에 network 필드 존재. wallet.ts의 balance/assets handler에 queryNetwork 로직 존재.
  </verify>
  <done>
GET /wallet/balance?network=X, GET /wallet/assets?network=X가 빌드 시점에 올바른 타입으로 컴파일되고, 미지정 시 defaultNetwork fallback이 적용된다. 트랜잭션 상세 응답 스키마에 network 필드가 포함된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 트랜잭션 응답 network 필드 + 월렛 API 테스트 수정 + 빌드/테스트 회귀 확인</name>
  <files>
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/__tests__/api-agents.test.ts
  </files>
  <action>
1. **transactions.ts** - 트랜잭션 목록/상세/pending 응답에 `network` 필드 추가:
   - GET /transactions (list) 응답 items에 `network: tx.network ?? null` 추가
   - GET /transactions/pending 응답 items에 `network: tx.network ?? null` 추가
   - GET /transactions/:id 응답에 `network: tx.network ?? null` 추가

2. **api-agents.test.ts** - Pre-existing 6개 테스트 실패 수정:
   - 111-01-SUMMARY에서 확인: "wallet API 응답에서 body.network 참조" 때문에 실패
   - Phase 110에서 wallet 스키마가 `network` -> `environment + defaultNetwork`로 변경됨
   - 테스트에서 `body.network` 참조를 유지하되, wallet 응답이 하위호환으로 `network: defaultNetwork`를 반환하므로 기존 테스트 값만 맞으면 됨
   - 실패 원인 확인: 테스트가 `body.network`를 기대하는데 실제로는 포함되어 있을 수 있음 (wallets.ts에서 `network: a.defaultNetwork!` 반환)
   - 실제 실패 원인을 `pnpm --filter @waiaas/daemon test -- --testPathPattern api-agents` 실행하여 확인
   - 에러 메시지 기반으로 테스트 수정 (environment 필드 기대 추가 또는 network 값 변경)

3. 전체 회귀 확인:
   - `pnpm build` (전체 모노레포 빌드)
   - `pnpm --filter @waiaas/daemon test` (daemon 전체 테스트)
   - Pre-existing 실패(lifecycle.test.ts flaky, CLI E2E 3개)만 남아야 함
  </action>
  <verify>
`pnpm build` 성공. `pnpm --filter @waiaas/daemon test` 실행 시 api-agents.test.ts 6개 테스트가 PASS. 트랜잭션 목록/상세 응답에 network 필드 포함.
  </verify>
  <done>
api-agents.test.ts 6개 pre-existing 실패가 해결되고, 트랜잭션 응답에 network 필드가 포함되며, 전체 빌드/테스트 회귀가 없다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` 성공 (전체 모노레포)
2. `pnpm --filter @waiaas/daemon test` 통과 (pre-existing flaky 제외)
3. GET /wallet/balance route에 query.network 파라미터 존재
4. GET /wallet/assets route에 query.network 파라미터 존재
5. TxDetailResponseSchema에 network 필드 존재
6. WalletCrudResponseSchema에 environment 필드 존재
7. api-agents.test.ts 6개 실패 해결
8. [API-01] POST /v1/wallets 핸들러에 environment 파라미터 처리 존재 확인 (Phase 110-01 선행 구현, grep으로 확인)
9. [API-02] SendTransactionRequestSchema에 network 필드 존재 + transactions.ts send handler에서 network를 파이프라인에 전달 확인 (Phase 110-01 + 111 선행 구현, grep으로 확인)
</verification>

<success_criteria>
- balance/assets 엔드포인트에 network 쿼리 파라미터가 추가되어 특정 네트워크 조회 가능
- 트랜잭션 응답에 network 필드 포함
- 월렛 응답에 environment 필드 포함
- 기존 테스트 회귀 없음 + pre-existing api-agents 실패 해결
</success_criteria>

<output>
After completion, create `.planning/phases/112-rest-api-network-extension/112-01-SUMMARY.md`
</output>
