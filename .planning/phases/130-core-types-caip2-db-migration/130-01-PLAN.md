---
phase: 130-core-types-caip2-db-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/package.json
  - packages/core/src/enums/transaction.ts
  - packages/core/src/enums/policy.ts
  - packages/core/src/interfaces/x402.types.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/errors/error-codes.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/enums.test.ts
  - packages/core/src/__tests__/errors.test.ts
  - packages/core/src/__tests__/x402-types.test.ts
autonomous: true

must_haves:
  truths:
    - "@x402/core Zod 스키마(PaymentRequiredV2Schema 등)를 @waiaas/core에서 import하여 x402 v2 타입 검증이 동작한다"
    - "CAIP-2 식별자(eip155:1 등 13개)를 WAIaaS NetworkType으로 양방향 변환하는 매핑이 동작한다"
    - "TransactionType에 X402_PAYMENT(7번째), PolicyType에 X402_ALLOWED_DOMAINS(12번째)가 추가되어 Zod enum이 자동 파생된다"
    - "x402 전용 에러 코드 8개가 ERROR_CODES에 추가되고 i18n en/ko 메시지가 동기화된다"
    - "X402FetchRequest/Response Zod 스키마가 정의되어 후속 Phase에서 API 검증에 사용 가능하다"
  artifacts:
    - path: "packages/core/src/interfaces/x402.types.ts"
      provides: "CAIP-2 매핑 + X402FetchRequest/Response 스키마 + @x402/core re-export"
      contains: "CAIP2_TO_NETWORK"
    - path: "packages/core/src/enums/transaction.ts"
      provides: "TransactionType SSoT with X402_PAYMENT"
      contains: "X402_PAYMENT"
    - path: "packages/core/src/enums/policy.ts"
      provides: "PolicyType SSoT with X402_ALLOWED_DOMAINS"
      contains: "X402_ALLOWED_DOMAINS"
    - path: "packages/core/src/errors/error-codes.ts"
      provides: "X402 도메인 에러 코드 8개"
      contains: "X402_DISABLED"
    - path: "packages/core/src/__tests__/x402-types.test.ts"
      provides: "CAIP-2 매핑 + X402 스키마 테스트"
  key_links:
    - from: "packages/core/src/interfaces/x402.types.ts"
      to: "packages/core/src/enums/chain.ts"
      via: "ChainType, NetworkType import for CAIP-2 매핑"
      pattern: "import.*ChainType.*NetworkType.*chain\\.js"
    - from: "packages/core/src/index.ts"
      to: "packages/core/src/interfaces/x402.types.ts"
      via: "re-export of x402 types and schemas"
      pattern: "x402"
    - from: "packages/core/src/i18n/en.ts"
      to: "packages/core/src/errors/error-codes.ts"
      via: "Messages interface type-checks error code key coverage"
      pattern: "X402_DISABLED"
---

<objective>
@x402/core 의존성 추가, x402 타입 시스템 구축, CAIP-2 매핑 정의, Enum SSoT 확장, 에러 코드 8개 정의

Purpose: x402 기능의 타입 안전성 기반을 구축하여 후속 Phase(131~133)에서 컴파일 타임 안전성을 가지게 한다
Output: @waiaas/core 패키지에 x402 관련 타입, 스키마, enum 값, 에러 코드가 모두 포함되어 빌드와 테스트가 통과하는 상태
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/130-core-types-caip2-db-migration/130-RESEARCH.md

# Prior phase reference (identical pattern: enum extension + error codes + type definitions)
@.planning/phases/115-core-types-db-migration-parsers/115-01-SUMMARY.md

# Source files to modify
@packages/core/src/enums/transaction.ts
@packages/core/src/enums/policy.ts
@packages/core/src/enums/chain.ts
@packages/core/src/errors/error-codes.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/index.ts
@packages/core/src/i18n/en.ts
@packages/core/src/i18n/ko.ts
@packages/core/src/__tests__/enums.test.ts
@packages/core/src/__tests__/errors.test.ts
@packages/core/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: @x402/core 의존성 + Enum 확장 + x402.types.ts + 에러 코드 + i18n</name>
  <files>
    packages/core/package.json
    packages/core/src/enums/transaction.ts
    packages/core/src/enums/policy.ts
    packages/core/src/interfaces/x402.types.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/errors/error-codes.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/core/src/index.ts
  </files>
  <action>
**Step 1: @x402/core 의존성 추가**

```bash
cd packages/core && pnpm add @x402/core@^2.3.1
```

의존성 추가 후 즉시 import 테스트:
```bash
node -e "import('@x402/core').then(m => console.log(Object.keys(m))).catch(e => console.log('fallback needed:', e.message))"
```
subpath `@x402/core/schemas`와 `@x402/core/types`도 테스트. 동작하지 않으면 기본 export(`@x402/core`)에서 모두 가져온다.

**Step 2: Enum SSoT 확장**

`packages/core/src/enums/transaction.ts`:
- TRANSACTION_TYPES 배열 끝에 `'X402_PAYMENT'` 추가 (7번째). SIGN 뒤에 추가.
- TransactionType, TransactionTypeEnum은 자동으로 새 값 포함 (as const + z.enum 패턴).

`packages/core/src/enums/policy.ts`:
- POLICY_TYPES 배열 끝에 `'X402_ALLOWED_DOMAINS'` 추가 (12번째). ALLOWED_NETWORKS 뒤에 추가.

**Step 3: x402.types.ts 신규 파일 생성**

`packages/core/src/interfaces/x402.types.ts` 신규 생성:

(a) @x402/core에서 Zod 스키마 + 타입 import 및 re-export. subpath import 먼저 시도, 실패 시 기본 export 사용.

(b) CAIP-2 -> WAIaaS NetworkType 양방향 매핑 상수:
```typescript
export const CAIP2_TO_NETWORK: Record<string, { chain: ChainType; network: NetworkType }> = {
  'eip155:1':        { chain: 'ethereum', network: 'ethereum-mainnet' },
  'eip155:11155111': { chain: 'ethereum', network: 'ethereum-sepolia' },
  'eip155:137':      { chain: 'ethereum', network: 'polygon-mainnet' },
  'eip155:80002':    { chain: 'ethereum', network: 'polygon-amoy' },
  'eip155:42161':    { chain: 'ethereum', network: 'arbitrum-mainnet' },
  'eip155:421614':   { chain: 'ethereum', network: 'arbitrum-sepolia' },
  'eip155:10':       { chain: 'ethereum', network: 'optimism-mainnet' },
  'eip155:11155420': { chain: 'ethereum', network: 'optimism-sepolia' },
  'eip155:8453':     { chain: 'ethereum', network: 'base-mainnet' },
  'eip155:84532':    { chain: 'ethereum', network: 'base-sepolia' },
  'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp': { chain: 'solana', network: 'mainnet' },
  'solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1':  { chain: 'solana', network: 'devnet' },
  'solana:4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z':  { chain: 'solana', network: 'testnet' },
};
```

(c) NETWORK_TO_CAIP2 역방향 매핑 (Object.fromEntries).

(d) parseCaip2(caip2Network: string) 함수: indexOf(':')로 namespace/reference 분리. -1이면 throw Error.

(e) resolveX402Network(caip2: string) 함수: CAIP2_TO_NETWORK 조회, 미지원이면 throw Error.

(f) X402FetchRequestSchema: z.object({ url: z.string().url(), method: z.enum(['GET','POST','PUT','DELETE','PATCH']).default('GET'), headers: z.record(z.string()).optional(), body: z.string().optional() })

(g) X402PaymentInfoSchema: z.object({ amount: z.string(), asset: z.string(), network: z.string(), payTo: z.string(), txId: z.string() })

(h) X402FetchResponseSchema: z.object({ status: z.number().int(), headers: z.record(z.string()), body: z.string(), payment: X402PaymentInfoSchema.optional() })

각 스키마에 대응하는 TypeScript 타입을 z.infer로 파생.

**Step 4: interfaces/index.ts 업데이트**

x402.types.ts에서 모든 export를 re-export:
```typescript
// v1.5.1 x402 types (Zod SSoT)
export type { X402FetchRequest, X402FetchResponse, X402PaymentInfo } from './x402.types.js';
export {
  X402FetchRequestSchema,
  X402FetchResponseSchema,
  X402PaymentInfoSchema,
  CAIP2_TO_NETWORK,
  NETWORK_TO_CAIP2,
  parseCaip2,
  resolveX402Network,
} from './x402.types.js';
```
@x402/core re-export도 포함 (PaymentRequiredV2Schema 등 -- x402.types.ts에서 re-export한 것들).

**Step 5: 에러 코드 8개 추가**

`packages/core/src/errors/error-codes.ts`:
(a) ErrorDomain 유니온에 `| 'X402'` 추가 (11번째).
(b) ERROR_CODES 객체 맨 끝에 X402 도메인 에러 8개 추가:
- X402_DISABLED: domain 'X402', httpStatus 403, retryable false
- X402_DOMAIN_NOT_ALLOWED: domain 'X402', httpStatus 403, retryable false
- X402_SSRF_BLOCKED: domain 'X402', httpStatus 403, retryable false
- X402_UNSUPPORTED_SCHEME: domain 'X402', httpStatus 400, retryable false
- X402_PAYMENT_REJECTED: domain 'X402', httpStatus 402, retryable false
- X402_DELAY_TIMEOUT: domain 'X402', httpStatus 408, retryable true
- X402_APPROVAL_REQUIRED: domain 'X402', httpStatus 403, retryable false
- X402_SERVER_ERROR: domain 'X402', httpStatus 502, retryable true

message 필드는 연구 파일의 값을 사용.

**Step 6: i18n 메시지 추가**

`packages/core/src/i18n/en.ts` errors 객체에 8개 X402 영문 메시지 추가.
`packages/core/src/i18n/ko.ts` errors 객체에 8개 X402 한글 메시지 추가.
Messages 인터페이스가 TypeScript로 키 일치를 검증하므로 누락 시 빌드 실패로 감지됨.

**Step 7: core/src/index.ts 업데이트**

x402 관련 타입과 스키마를 re-export에 추가:
- interfaces/index.js에서 x402 타입/스키마 re-export
- 주석 카운트 업데이트 (예: "73 error codes" -> "84 error codes")

**Step 8: 빌드 검증**

```bash
npx turbo run build --filter=@waiaas/core
```
빌드 실패 시 즉시 수정. 특히 i18n Messages 인터페이스 누락 키, @x402/core import 경로 문제를 주의.

**주의사항:**
- TransactionRequestSchema의 discriminatedUnion에 X402_PAYMENT을 추가하지 않는다. X402_PAYMENT은 DB 기록용이며 별도 핸들러 파이프라인으로 처리된다.
- @x402/core subpath imports(`@x402/core/schemas`, `@x402/core/types`)가 동작하지 않으면 `@x402/core` 기본 export에서 가져온다.
  </action>
  <verify>
1. `npx turbo run build --filter=@waiaas/core` 성공
2. `node -e "const c = require('./packages/core/dist/index.js'); console.log(c.TRANSACTION_TYPES.length, c.POLICY_TYPES.length)"` 출력이 `7 12`
3. `node -e "const c = require('./packages/core/dist/index.js'); console.log(Object.keys(c.ERROR_CODES).length)"` 출력이 `84`
4. `node -e "const c = require('./packages/core/dist/index.js'); console.log(Object.keys(c.CAIP2_TO_NETWORK).length)"` 출력이 `13`
  </verify>
  <done>
- TransactionType 7개 (X402_PAYMENT 포함), PolicyType 12개 (X402_ALLOWED_DOMAINS 포함)
- ERROR_CODES 84개 (X402 도메인 8개 포함), ErrorDomain 11개 (X402 포함)
- CAIP-2 매핑 13개 (EVM 10개 + Solana 3개) 양방향 매핑 동작
- X402FetchRequest/Response/PaymentInfo Zod 스키마 정의 완료
- @x402/core 타입 re-export 완료
- i18n en/ko 메시지 8개씩 동기화 완료
- @waiaas/core 빌드 성공
  </done>
</task>

<task type="auto">
  <name>Task 2: 테스트 카운트 수정 + x402-types 테스트 작성</name>
  <files>
    packages/core/src/__tests__/enums.test.ts
    packages/core/src/__tests__/errors.test.ts
    packages/core/src/__tests__/x402-types.test.ts
  </files>
  <action>
**Step 1: 기존 테스트 카운트 불일치 수정**

`packages/core/src/__tests__/enums.test.ts`:
- `TransactionStatus has 9 values` -> `TransactionStatus has 10 values` (SIGNED 추가됨. 실제 10개)
- `TransactionType has 5 values` -> `TransactionType has 7 values` (SIGN + X402_PAYMENT 추가. 실제 7개)
- `PolicyType has 11 values` -> `PolicyType has 12 values` (X402_ALLOWED_DOMAINS 추가. 실제 12개)
- X402_PAYMENT과 X402_ALLOWED_DOMAINS에 대한 toContain assertion 추가

`packages/core/src/__tests__/errors.test.ts`:
- `has exactly 69 error codes` -> `has exactly 84 error codes` (실제 76개 + X402 8개 = 84개)
- `covers all 10 domains` -> `covers all 11 domains`:
  - `expect(domains).toContain('X402')` assertion 추가
  - `expect(domains.size).toBe(11)` 으로 변경
- TX domain 카운트도 확인 필요: 현재 `TX domain has 23 codes`가 하드코딩. 실제 TX 도메인 코드 수를 확인하여 정확히 업데이트.
- X402 도메인 전용 테스트 추가: `it('X402 domain has 8 codes')` assertion
- package-exports.test.ts가 있다면 에러 코드 카운트도 확인하여 수정

**Step 2: x402-types.test.ts 신규 작성**

`packages/core/src/__tests__/x402-types.test.ts` 신규 생성:

(a) CAIP-2 매핑 테스트:
- `CAIP2_TO_NETWORK has 13 entries` (EVM 10 + Solana 3)
- `NETWORK_TO_CAIP2 has 13 entries` (역방향 매핑)
- `every CAIP-2 entry maps to a valid NetworkType` (NETWORK_TYPES.includes 검증)
- `every CAIP-2 entry maps to a valid ChainType` (CHAIN_TYPES.includes 검증)
- `resolveX402Network returns correct chain+network for known CAIP-2 IDs` (eip155:1 -> ethereum/ethereum-mainnet, solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp -> solana/mainnet)
- `resolveX402Network throws for unknown CAIP-2 ID`
- `parseCaip2 splits namespace and reference correctly` (eip155:1 -> {namespace:'eip155', reference:'1'})
- `parseCaip2 throws for invalid CAIP-2 format` (no colon)
- `bidirectional mapping consistency` (CAIP2 -> Network -> CAIP2 roundtrip)

(b) X402FetchRequest 스키마 테스트:
- 유효한 요청 parse 성공
- method 기본값 GET
- url이 유효하지 않으면 parse 실패
- headers/body optional

(c) X402FetchResponse 스키마 테스트:
- 유효한 응답 parse 성공
- payment optional
- payment 있을 때 모든 필드 필수

(d) @x402/core re-export 검증:
- PaymentRequiredV2Schema 등이 import 가능한지 확인 (typeof check)

**Step 3: 테스트 실행**

```bash
cd packages/core && pnpm test
```
모든 테스트 통과 확인. 특히 기존 enums.test.ts, errors.test.ts, i18n.test.ts의 회귀 없음을 확인.
  </action>
  <verify>
1. `cd packages/core && pnpm test` 전체 통과
2. x402-types.test.ts에서 CAIP-2 매핑 13개 검증 통과
3. enums.test.ts에서 TransactionType 7개, PolicyType 12개, TransactionStatus 10개 검증 통과
4. errors.test.ts에서 ERROR_CODES 84개, 11 domains 검증 통과
  </verify>
  <done>
- enums.test.ts 카운트 수정: TransactionStatus 10개, TransactionType 7개, PolicyType 12개
- errors.test.ts 카운트 수정: ERROR_CODES 84개, 11 domains, X402 도메인 8개
- x402-types.test.ts 신규: CAIP-2 매핑 13개 양방향 검증, parseCaip2/resolveX402Network 함수 테스트, X402FetchRequest/Response 스키마 검증, @x402/core re-export 확인
- @waiaas/core 전체 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `npx turbo run build --filter=@waiaas/core` 성공
2. `cd packages/core && pnpm test` 전체 통과 (기존 + 신규 테스트)
3. TRANSACTION_TYPES.length === 7 (X402_PAYMENT 포함)
4. POLICY_TYPES.length === 12 (X402_ALLOWED_DOMAINS 포함)
5. Object.keys(ERROR_CODES).length === 84 (X402 도메인 8개 포함)
6. Object.keys(CAIP2_TO_NETWORK).length === 13
7. X402FetchRequestSchema, X402FetchResponseSchema parse 동작
8. @x402/core 타입 import 정상 (PaymentRequiredV2Schema 등)
</verification>

<success_criteria>
- @waiaas/core 패키지가 빌드 성공하고 모든 테스트가 통과한다
- x402 관련 타입, 스키마, enum, 에러 코드가 패키지에서 export되어 후속 Phase에서 사용 가능하다
- CAIP-2 양방향 매핑이 13개 네트워크에 대해 동작한다
- 기존 테스트의 카운트 불일치가 수정된다
</success_criteria>

<output>
After completion, create `.planning/phases/130-core-types-caip2-db-migration/130-01-SUMMARY.md`
</output>
