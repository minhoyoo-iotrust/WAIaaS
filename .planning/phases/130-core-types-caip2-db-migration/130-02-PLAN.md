---
phase: 130-core-types-caip2-db-migration
plan: 02
type: execute
wave: 2
depends_on: ["130-01"]
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/__tests__/migration-chain.test.ts
  - packages/daemon/src/__tests__/migration-runner.test.ts
  - packages/daemon/src/__tests__/migration-v6-v8.test.ts
  - packages/daemon/src/__tests__/settings-schema-migration.test.ts
autonomous: true

must_haves:
  truths:
    - "DB 마이그레이션 v12가 적용되어 transactions CHECK 제약에 X402_PAYMENT이 포함되고, policies CHECK 제약에 X402_ALLOWED_DOMAINS가 포함된다"
    - "기존 데이터(transactions/policies)가 v12 마이그레이션 후 그대로 보존된다"
    - "LATEST_SCHEMA_VERSION이 12로 업데이트되어 fresh DB에서 pushSchema 후 마이그레이션이 스킵된다"
    - "v1 -> v12 전체 체인 마이그레이션이 테스트로 검증된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v12 마이그레이션 (transactions + policies 12-step 재생성) + LATEST_SCHEMA_VERSION=12"
      contains: "version: 12"
    - path: "packages/daemon/src/__tests__/migration-chain.test.ts"
      provides: "v12 마이그레이션 체인 테스트"
      contains: "v12"
  key_links:
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "packages/core/src/enums/transaction.ts"
      via: "TRANSACTION_TYPES SSoT import for CHECK constraint"
      pattern: "inList\\(TRANSACTION_TYPES\\)"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "packages/core/src/enums/policy.ts"
      via: "POLICY_TYPES SSoT import for CHECK constraint"
      pattern: "inList\\(POLICY_TYPES\\)"
    - from: "packages/daemon/src/__tests__/migration-chain.test.ts"
      to: "packages/daemon/src/infrastructure/database/migrate.ts"
      via: "LATEST_SCHEMA_VERSION import for version assertion"
      pattern: "LATEST_SCHEMA_VERSION.*12"
---

<objective>
DB 마이그레이션 v12 추가: transactions CHECK 제약에 X402_PAYMENT, policies CHECK 제약에 X402_ALLOWED_DOMAINS 반영 + 마이그레이션 테스트

Purpose: 기존 DB의 CHECK 제약이 새로운 TransactionType/PolicyType 값을 수용하여, 데이터베이스 무결성을 유지하면서 x402 트랜잭션/정책 저장이 가능해진다
Output: v12 마이그레이션이 migrate.ts에 추가되고 LATEST_SCHEMA_VERSION이 12로 업데이트되며 마이그레이션 체인 테스트가 통과하는 상태
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/130-core-types-caip2-db-migration/130-RESEARCH.md
@.planning/phases/130-core-types-caip2-db-migration/130-01-SUMMARY.md

# Source files
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/__tests__/migration-chain.test.ts
@packages/daemon/src/__tests__/migration-runner.test.ts
@packages/daemon/src/__tests__/migration-v6-v8.test.ts
@packages/daemon/src/__tests__/settings-schema-migration.test.ts

# Prior art: v9 migration (transactions 12-step recreation)
# v8 migration (policies 12-step recreation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: v12 마이그레이션 추가 + LATEST_SCHEMA_VERSION 업데이트</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
  </files>
  <action>
**Step 1: LATEST_SCHEMA_VERSION 업데이트**

`packages/daemon/src/infrastructure/database/migrate.ts`:
- `export const LATEST_SCHEMA_VERSION = 11;` -> `export const LATEST_SCHEMA_VERSION = 12;`

**Step 2: v12 마이그레이션 추가**

MIGRATIONS 배열 끝(v11 마이그레이션 다음)에 v12 마이그레이션을 추가. v9(transactions 재생성)와 v8(policies 재생성)을 결합한 패턴.

```typescript
// ---------------------------------------------------------------------------
// v12: Add X402_PAYMENT to transactions and X402_ALLOWED_DOMAINS to policies CHECK constraints
// ---------------------------------------------------------------------------
// x402 결제 지원을 위해 transactions.type에 X402_PAYMENT,
// policies.type에 X402_ALLOWED_DOMAINS가 CHECK 제약에 포함되어야 한다.
// SQLite는 ALTER CHECK 불가 -> transactions와 policies 모두 12-step 재생성.

MIGRATIONS.push({
  version: 12,
  description: 'Add X402_PAYMENT to transactions and X402_ALLOWED_DOMAINS to policies CHECK constraints',
  managesOwnTransaction: true,
  up: (sqlite) => {
    sqlite.exec('BEGIN');

    try {
      // ── Part 1: transactions 테이블 재생성 ──
      // v9과 동일 DDL. TRANSACTION_TYPES SSoT에 X402_PAYMENT이 이미 포함됨.
      sqlite.exec(`CREATE TABLE transactions_new (
  id TEXT PRIMARY KEY,
  wallet_id TEXT NOT NULL REFERENCES wallets(id) ON DELETE RESTRICT,
  session_id TEXT REFERENCES sessions(id) ON DELETE SET NULL,
  chain TEXT NOT NULL,
  tx_hash TEXT,
  type TEXT NOT NULL CHECK (type IN (${inList(TRANSACTION_TYPES)})),
  amount TEXT,
  to_address TEXT,
  token_mint TEXT,
  contract_address TEXT,
  method_signature TEXT,
  spender_address TEXT,
  approved_amount TEXT,
  parent_id TEXT REFERENCES transactions_new(id) ON DELETE CASCADE,
  batch_index INTEGER,
  status TEXT NOT NULL DEFAULT 'PENDING' CHECK (status IN (${inList(TRANSACTION_STATUSES)})),
  tier TEXT CHECK (tier IS NULL OR tier IN (${inList(POLICY_TIERS)})),
  queued_at INTEGER,
  executed_at INTEGER,
  created_at INTEGER NOT NULL,
  reserved_amount TEXT,
  error TEXT,
  metadata TEXT,
  network TEXT CHECK (network IS NULL OR network IN (${inList(NETWORK_TYPES)}))
)`);

      sqlite.exec(`INSERT INTO transactions_new (id, wallet_id, session_id, chain, tx_hash, type, amount, to_address, token_mint, contract_address, method_signature, spender_address, approved_amount, parent_id, batch_index, status, tier, queued_at, executed_at, created_at, reserved_amount, error, metadata, network)
  SELECT id, wallet_id, session_id, chain, tx_hash, type, amount, to_address, token_mint, contract_address, method_signature, spender_address, approved_amount, parent_id, batch_index, status, tier, queued_at, executed_at, created_at, reserved_amount, error, metadata, network FROM transactions`);

      sqlite.exec('DROP TABLE transactions');
      sqlite.exec('ALTER TABLE transactions_new RENAME TO transactions');

      // Recreate all 8 indexes (same as v9)
      sqlite.exec('CREATE INDEX idx_transactions_wallet_status ON transactions(wallet_id, status)');
      sqlite.exec('CREATE INDEX idx_transactions_session_id ON transactions(session_id)');
      sqlite.exec('CREATE UNIQUE INDEX idx_transactions_tx_hash ON transactions(tx_hash)');
      sqlite.exec('CREATE INDEX idx_transactions_queued_at ON transactions(queued_at)');
      sqlite.exec('CREATE INDEX idx_transactions_created_at ON transactions(created_at)');
      sqlite.exec('CREATE INDEX idx_transactions_type ON transactions(type)');
      sqlite.exec('CREATE INDEX idx_transactions_contract_address ON transactions(contract_address)');
      sqlite.exec('CREATE INDEX idx_transactions_parent_id ON transactions(parent_id)');

      // ── Part 2: policies 테이블 재생성 ──
      // v8과 동일 DDL. POLICY_TYPES SSoT에 X402_ALLOWED_DOMAINS가 이미 포함됨.
      sqlite.exec(`CREATE TABLE policies_new (
  id TEXT PRIMARY KEY,
  wallet_id TEXT REFERENCES wallets(id) ON DELETE CASCADE,
  type TEXT NOT NULL CHECK (type IN (${inList(POLICY_TYPES)})),
  rules TEXT NOT NULL,
  priority INTEGER NOT NULL DEFAULT 0,
  enabled INTEGER NOT NULL DEFAULT 1,
  network TEXT CHECK (network IS NULL OR network IN (${inList(NETWORK_TYPES)})),
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
)`);

      sqlite.exec(`INSERT INTO policies_new (id, wallet_id, type, rules, priority, enabled, network, created_at, updated_at)
  SELECT id, wallet_id, type, rules, priority, enabled, network, created_at, updated_at FROM policies`);

      sqlite.exec('DROP TABLE policies');
      sqlite.exec('ALTER TABLE policies_new RENAME TO policies');

      // Recreate 3 indexes (same as v8)
      sqlite.exec('CREATE INDEX idx_policies_wallet_enabled ON policies(wallet_id, enabled)');
      sqlite.exec('CREATE INDEX idx_policies_type ON policies(type)');
      sqlite.exec('CREATE INDEX idx_policies_network ON policies(network)');

      sqlite.exec('COMMIT');
    } catch (err) {
      sqlite.exec('ROLLBACK');
      throw err;
    }

    // Re-enable foreign keys and verify integrity
    sqlite.pragma('foreign_keys = ON');
    const fkErrors = sqlite.pragma('foreign_key_check') as unknown[];
    if (fkErrors.length > 0) {
      throw new Error(`FK integrity violation after v12: ${JSON.stringify(fkErrors)}`);
    }
  },
});
```

**핵심 주의사항:**
- transactions_new의 `parent_id TEXT REFERENCES transactions_new(id) ON DELETE CASCADE` -- 자기참조 FK는 `transactions_new`를 참조해야 한다 (v9 선례).
- inList(TRANSACTION_TYPES), inList(POLICY_TYPES) 등 SSoT 배열 참조 사용 (하드코딩 금지).
- managesOwnTransaction: true로 설정하여 외부 트랜잭션 래핑을 방지.

**Step 3: 빌드 검증**

```bash
npx turbo run build --filter=@waiaas/daemon
```
  </action>
  <verify>
1. `npx turbo run build --filter=@waiaas/daemon` 성공
2. migrate.ts에 `version: 12` 마이그레이션이 존재
3. `LATEST_SCHEMA_VERSION` 값이 12
4. 마이그레이션 코드에서 `inList(TRANSACTION_TYPES)`, `inList(POLICY_TYPES)` 사용 확인
5. transactions_new의 parent_id가 `transactions_new(id)` 참조 확인
  </verify>
  <done>
- v12 마이그레이션이 migrate.ts에 추가됨: transactions + policies 12-step 재생성
- LATEST_SCHEMA_VERSION = 12
- transactions CHECK에 X402_PAYMENT 포함 (SSoT 자동)
- policies CHECK에 X402_ALLOWED_DOMAINS 포함 (SSoT 자동)
- @waiaas/daemon 빌드 성공
  </done>
</task>

<task type="auto">
  <name>Task 2: 마이그레이션 테스트 버전 기대값 업데이트 + v12 체인 테스트</name>
  <files>
    packages/daemon/src/__tests__/migration-chain.test.ts
    packages/daemon/src/__tests__/migration-runner.test.ts
    packages/daemon/src/__tests__/migration-v6-v8.test.ts
    packages/daemon/src/__tests__/settings-schema-migration.test.ts
  </files>
  <action>
**Step 1: 마이그레이션 테스트 버전 기대값 업데이트 (11 -> 12)**

Phase 115-01에서 8->9로 업데이트한 것과 동일한 패턴. 4개 테스트 파일에서 LATEST_SCHEMA_VERSION 관련 하드코딩 값을 11 -> 12로 수정.

`packages/daemon/src/__tests__/settings-schema-migration.test.ts`:
- `'should record schema_version 11 in fresh DB'` -> `'should record schema_version 12 in fresh DB'`
- `expect(row.max_version).toBe(11)` -> `expect(row.max_version).toBe(12)`
- `'LATEST_SCHEMA_VERSION should be 11'` -> `'LATEST_SCHEMA_VERSION should be 12'`
- `expect(LATEST_SCHEMA_VERSION).toBe(11)` -> `expect(LATEST_SCHEMA_VERSION).toBe(12)`

`packages/daemon/src/__tests__/migration-chain.test.ts`:
- `'Verify LATEST_SCHEMA_VERSION is 11'` -> `'Verify LATEST_SCHEMA_VERSION is 12'`
- `expect(LATEST_SCHEMA_VERSION).toBe(11)` -> `expect(LATEST_SCHEMA_VERSION).toBe(12)`

`packages/daemon/src/__tests__/migration-v6-v8.test.ts`:
- `'should have LATEST_SCHEMA_VERSION = 11'` -> `'should have LATEST_SCHEMA_VERSION = 12'`
- `expect(LATEST_SCHEMA_VERSION).toBe(11)` -> `expect(LATEST_SCHEMA_VERSION).toBe(12)`

`packages/daemon/src/__tests__/migration-runner.test.ts`:
- 주석과 assertion에서 11 관련 값을 12로 업데이트
- `version 12 should NOT be recorded` -> 적절히 수정 (이제 12가 최대 버전)
- `should skip version 1-11 migrations` -> `should skip version 1-12 migrations`
- `version: 11` 하드코딩 -> `version: 12`

**Step 2: v12 마이그레이션 체인 테스트 추가**

`packages/daemon/src/__tests__/migration-chain.test.ts`에 v12 테스트 케이스 추가.
기존 v9 테스트(transactions 재생성 후 데이터 보존 검증)와 v8 테스트(policies 재생성 후 데이터 보존 검증) 패턴을 결합.

v12 테스트가 검증해야 할 것:
1. v11 -> v12 마이그레이션 성공
2. 기존 transactions 데이터가 보존됨 (마이그레이션 전에 TRANSFER/TOKEN_TRANSFER 등 기존 타입의 행 삽입 후 마이그레이션, 마이그레이션 후 동일한 행이 존재하는지 확인)
3. 기존 policies 데이터가 보존됨 (마이그레이션 전에 SPENDING_LIMIT 등 기존 타입의 행 삽입 후 마이그레이션, 마이그레이션 후 동일한 행이 존재하는지 확인)
4. transactions CHECK 제약이 X402_PAYMENT 허용 (마이그레이션 후 type='X402_PAYMENT' 행 삽입 성공)
5. policies CHECK 제약이 X402_ALLOWED_DOMAINS 허용 (마이그레이션 후 type='X402_ALLOWED_DOMAINS' 행 삽입 성공)
6. 유효하지 않은 타입 삽입 시 CHECK 제약 위반 에러 (type='INVALID_TYPE' 삽입 실패)
7. FK integrity check 통과
8. v1 -> v12 전체 체인 마이그레이션 테스트 (이미 기존 체인 테스트가 LATEST_SCHEMA_VERSION까지 실행하므로 자동으로 커버될 가능성 높음)

**Step 3: 전체 테스트 실행**

```bash
cd packages/daemon && pnpm test
```
마이그레이션 관련 테스트 전체 통과 확인.
  </action>
  <verify>
1. `cd packages/daemon && pnpm test` 전체 통과 (또는 마이그레이션 관련 테스트만: `pnpm vitest run src/__tests__/migration`)
2. v12 체인 테스트에서 transactions/policies 데이터 보존 검증
3. X402_PAYMENT / X402_ALLOWED_DOMAINS 타입 삽입 성공 검증
4. LATEST_SCHEMA_VERSION 12 assertion 통과
  </verify>
  <done>
- 4개 테스트 파일에서 LATEST_SCHEMA_VERSION 기대값 11 -> 12 업데이트
- v12 체인 테스트 추가: transactions/policies 데이터 보존, 새 타입 삽입 성공, CHECK 제약 검증
- v1 -> v12 전체 마이그레이션 체인 테스트 통과
- @waiaas/daemon 전체 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `npx turbo run build` 전체 빌드 성공
2. `cd packages/daemon && pnpm test` 마이그레이션 테스트 전체 통과
3. LATEST_SCHEMA_VERSION === 12
4. v12 마이그레이션에서 transactions/policies CHECK 제약이 새 타입 포함
5. 기존 데이터 마이그레이션 후 보존 확인
6. v1 -> v12 체인 마이그레이션 성공
</verification>

<success_criteria>
- DB 마이그레이션 v12가 추가되어 transactions.type CHECK에 X402_PAYMENT, policies.type CHECK에 X402_ALLOWED_DOMAINS가 포함된다
- 기존 데이터가 마이그레이션 후 그대로 보존된다
- LATEST_SCHEMA_VERSION = 12
- 모든 마이그레이션 테스트가 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/130-core-types-caip2-db-migration/130-02-SUMMARY.md`
</output>
