---
phase: 05-api-및-통합-설계
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - .planning/deliverables/22-sdk-interface.md
  - .planning/deliverables/23-mcp-integration.md
autonomous: true

must_haves:
  truths:
    - "TypeScript SDK의 WaiassClient 클래스와 하위 클라이언트(AgentsClient, TransactionsClient, OwnerClient, WebhooksClient)의 전체 메서드 시그니처가 정의됨"
    - "Python SDK의 WaiassClient 클래스와 하위 클라이언트의 전체 메서드 시그니처가 정의됨"
    - "SDK 공통 패턴(Options Bag, PagedAsyncIterableIterator, 에러 타입 계층, 자동 재시도)이 설계됨"
    - "MCP Tools(10개 이내)가 에이전트 핵심 동작에 한정되어 정의됨"
    - "MCP Resources가 읽기 전용 정보(잔액, 정책, 대시보드)로 정의됨"
    - "MCP 인증이 OAuth 2.1 + API Key 어댑터로 설계됨"
  artifacts:
    - path: ".planning/deliverables/22-sdk-interface.md"
      provides: "SDK 인터페이스 설계 (API-05)"
      contains: "WaiassClient"
    - path: ".planning/deliverables/23-mcp-integration.md"
      provides: "MCP 통합 스펙 (API-06)"
      contains: "McpServer"
  key_links:
    - from: "22-sdk-interface.md"
      to: "21-openapi-spec.md"
      via: "SDK 메서드가 REST API 엔드포인트와 1:1 매핑"
      pattern: "createAgent|executeTransaction|listAgents"
    - from: "22-sdk-interface.md"
      to: "20-error-codes.md"
      via: "SDK 에러 클래스가 WalletApiError 코드를 래핑"
      pattern: "WaiassError|PolicyError|AuthError"
    - from: "23-mcp-integration.md"
      to: "21-openapi-spec.md"
      via: "MCP Tools가 REST API의 핵심 엔드포인트를 래핑"
      pattern: "execute_transaction|get_balance"
    - from: "23-mcp-integration.md"
      to: "18-authentication-model.md"
      via: "MCP Authorization이 OAuth 2.1 + API Key 어댑터를 사용"
      pattern: "oauth-protected-resource|Bearer"
---

<objective>
SDK 인터페이스 설계(API-05)와 MCP 통합 스펙(API-06) 문서를 작성한다.

Purpose: 외부 개발자가 TypeScript/Python으로 WAIaaS API에 접근하는 SDK 인터페이스와, AI 에이전트 프레임워크(Claude, GPT, Gemini 등)가 MCP 프로토콜을 통해 지갑 기능에 접근하는 통합 스펙을 설계한다. SDK는 REST API 위의 편의 계층으로 HTTP 세부사항을 추상화하고, MCP는 에이전트의 핵심 동작만 선별적으로 노출하여 LLM 컨텍스트 효율을 극대화한다.

Output: .planning/deliverables/22-sdk-interface.md, .planning/deliverables/23-mcp-integration.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 5 research (SDK patterns, MCP server structure, code examples)
@.planning/phases/05-api-및-통합-설계/05-RESEARCH.md

# Phase 5 prior plan outputs (MUST READ for API spec, auth, errors)
@.planning/phases/05-api-및-통합-설계/05-01-SUMMARY.md
@.planning/phases/05-api-및-통합-설계/05-02-SUMMARY.md

# Phase 5 deliverables from prior plans
@.planning/deliverables/18-authentication-model.md
@.planning/deliverables/19-permission-policy-model.md
@.planning/deliverables/20-error-codes.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SDK 인터페이스 설계 문서 작성 (API-05)</name>
  <files>.planning/deliverables/22-sdk-interface.md</files>
  <action>
  API-05 SDK 인터페이스 설계 문서를 작성한다. 문서 상단에 "문서 ID: API-05", 작성일, 상태, 참조 문서를 기재한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요: SDK 설계 원칙**
  - Azure SDK Guidelines + Stripe SDK 패턴 기반 (05-RESEARCH.md 참고)
  - 핵심 원칙: (1) HTTP 세부사항 완전 추상화, (2) 일관된 동사 접두사(create/get/list/update/delete), (3) Options Bag 패턴, (4) 자동 페이지네이션, (5) 타입 안전(TypeScript), (6) 에러 타입 계층
  - SDK는 REST API(21-openapi-spec.md)의 편의 래퍼 - OpenAPI 스펙에서 타입 추론 가능하도록 설계
  - 안티패턴: SDK 사용자에게 URL 조합, 헤더 설정, 페이지네이션 토큰 관리를 노출하지 않음 (05-RESEARCH.md Pitfall 5)

  **2. TypeScript SDK 인터페이스**
  - 05-RESEARCH.md의 SDK 인터페이스 설계 (TypeScript) 코드를 기반으로 확장. 다음을 포함:

  2.1 WaiassClient (진입점):
  ```typescript
  class WaiassClient {
    constructor(apiKey: string, options?: WaiassClientOptions);
    readonly agents: AgentsClient;
    readonly transactions: TransactionsClient;
    readonly owner: OwnerClient;
    readonly webhooks: WebhooksClient;
    readonly auth: AuthClient;
  }
  ```
  - WaiassClientOptions: baseUrl, network(mainnet/devnet/testnet), timeoutInMs(기본 30000), retryOptions, logger

  2.2 AgentsClient (에이전트 관리):
  - createAgent(options: CreateAgentOptions): Promise<Agent>
  - getAgent(agentId: string): Promise<Agent>
  - listAgents(options?: ListAgentsOptions): PagedAsyncIterableIterator<Agent>
  - updateAgent(agentId: string, options: UpdateAgentOptions): Promise<Agent>
  - deleteAgent(agentId: string): Promise<void>
  - suspendAgent(agentId: string, options?: SuspendOptions): Promise<Agent>
  - resumeAgent(agentId: string): Promise<Agent>
  - rotateKey(agentId: string): Promise<KeyRotationResult>
  - getBalance(agentId: string): Promise<Balance>
  - fund(agentId: string, options: FundOptions): Promise<FundingResult>
  - withdraw(agentId: string, options?: WithdrawOptions): Promise<WithdrawalResult>
  - getPolicy(agentId: string): Promise<AgentPolicy>
  - updatePolicy(agentId: string, policy: UpdatePolicyOptions): Promise<AgentPolicy>
  - getPolicyUsage(agentId: string): Promise<PolicyUsage>
  각 메서드의 Options 인터페이스와 반환 타입을 완전히 정의할 것.

  2.3 TransactionsClient (트랜잭션):
  - executeTransaction(options: ExecuteTransactionOptions): Promise<TransactionResult>
  - getTransaction(txId: string): Promise<Transaction>
  - listTransactions(agentId: string, options?: ListTransactionsOptions): PagedAsyncIterableIterator<Transaction>

  2.4 OwnerClient (소유자):
  - getDashboard(): Promise<OwnerDashboard>
  - listAgentSummaries(options?: ListOptions): PagedAsyncIterableIterator<AgentSummary>
  - getGlobalBudget(): Promise<GlobalBudgetLimit>
  - updateGlobalBudget(options: UpdateGlobalBudgetOptions): Promise<GlobalBudgetLimit>
  - transferFunds(options: TransferFundsOptions): Promise<TransferResult>
  - emergencySuspendAll(): Promise<BatchOperationResult>
  - emergencySuspend(agentId: string, options?: EmergencyOptions): Promise<Agent>
  - emergencyRecover(agentId: string, options?: RecoveryOptions): Promise<RecoveryResult>

  2.5 WebhooksClient: create, list, delete, test
  2.6 AuthClient: createKey, listKeys, revokeKey

  **3. Python SDK 인터페이스**
  - 05-RESEARCH.md의 Python SDK 설계를 기반으로 확장.
  - WaiassClient, AgentsClient, TransactionsClient, OwnerClient의 전체 메서드 시그니처 (Python typing 사용)
  - AsyncPaginator 패턴: __aiter__, __anext__, pages()
  - Python 컨벤션: snake_case 메서드명, keyword-only arguments (*, 구문)
  - 동기(sync) 클라이언트 + 비동기(async) 클라이언트 모두 제공: WaiassClient(sync), AsyncWaiassClient(async)

  **4. SDK 공통 패턴 상세**

  4.1 Options Bag 패턴:
  - 모든 메서드에 단일 options 객체 사용 (positional args 최소화)
  - 필수 필드 vs 선택 필드 분리
  - 예시: createAgent({ nickname, budgetConfig, ...optional })

  4.2 PagedAsyncIterableIterator (자동 페이지네이션):
  - for-await-of로 개별 항목 순회: for await (const agent of client.agents.listAgents()) {}
  - byPage()로 페이지 단위 순회: for await (const page of client.agents.listAgents().byPage({ maxPageSize: 50 })) {}
  - 내부적으로 cursor 기반 자동 페치

  4.3 자동 재시도 (RetryOptions):
  - retryable 에러만 재시도 (20-error-codes.md의 retryable 필드 참조)
  - exponential backoff: 기본 1s, 최대 3회
  - 429 응답: Retry-After 헤더 준수
  - 5xx 응답: 재시도 (SYSTEM_* 에러 중 retryable=true)

  4.4 에러 타입 계층:
  - WaiassError (base) -> AuthenticationError, PolicyError, AgentError, TransactionError, FundingError, SystemError
  - 각 에러 클래스: code, status, detail, requestId, retryable, escalation 속성
  - 20-error-codes.md의 에러 타입(auth_error, policy_error 등)과 1:1 매핑
  - TypeScript: try-catch에서 instanceof로 분기
  - Python: except WaiassError as e / except PolicyError as e

  4.5 로깅:
  - 선택적 로거 주입 (constructor options)
  - 요청/응답 로깅 (debug level), 에러 로깅 (warn level)
  - requestId를 모든 로그에 포함

  **5. SDK 사용 예제**
  - 에이전트 생성 + 트랜잭션 실행 + 에러 처리 전체 흐름 (TypeScript)
  - 동일 흐름 (Python)
  - 각 예제는 10-20줄로 간결하되, SDK의 추상화 수준을 보여줄 것

  **6. SDK 배포 및 버전 관리**
  - TypeScript: npm 패키지 (@waiass/sdk), ESM + CJS 이중 빌드
  - Python: PyPI 패키지 (waiass-sdk), Python 3.10+ 지원
  - 버전: API 버전과 동기화 (1.x.x = /api/v1/)
  - SDK 자동 생성 vs 수동 작성: OpenAPI 스펙 기반 인터페이스를 수동 설계, 구현 시 SDK 생성기 평가 (05-RESEARCH.md Open Question 3)

  최소 2개의 코드 블록 포함: TypeScript 사용 예제, Python 사용 예제.
  05-RESEARCH.md의 SDK 인터페이스 코드를 기반으로 하되 Options Bag, 에러 계층, 로깅을 확장할 것.
  모든 메서드 시그니처가 REST API 엔드포인트(05-RESEARCH.md 엔드포인트 목록)와 일관되도록 할 것.
  </action>
  <verify>
  파일 존재: ls .planning/deliverables/22-sdk-interface.md
  TypeScript 인터페이스: grep -c "class WaiassClient\|interface.*Client\|AgentsClient\|TransactionsClient\|OwnerClient" .planning/deliverables/22-sdk-interface.md (5 이상)
  Python 인터페이스: grep -c "class WaiassClient\|class AgentsClient\|class AsyncWaiassClient\|def create\|async def" .planning/deliverables/22-sdk-interface.md (5 이상)
  에러 타입 계층: grep -c "WaiassError\|AuthenticationError\|PolicyError\|TransactionError" .planning/deliverables/22-sdk-interface.md (4 이상)
  페이지네이션: grep -c "PagedAsyncIterableIterator\|AsyncPaginator\|byPage" .planning/deliverables/22-sdk-interface.md (3 이상)
  Options Bag: grep -c "Options\|options:" .planning/deliverables/22-sdk-interface.md (5 이상)
  사용 예제: grep -c "```typescript\|```python" .planning/deliverables/22-sdk-interface.md (4 이상)
  </verify>
  <done>
  - TypeScript SDK의 WaiassClient + 5개 하위 클라이언트의 전체 메서드 시그니처가 정의됨
  - Python SDK의 동기/비동기 클라이언트 전체 메서드 시그니처가 정의됨
  - SDK 공통 패턴(Options Bag, 자동 페이지네이션, 재시도, 에러 계층, 로깅)이 상세 설계됨
  - 에러 타입 계층이 20-error-codes.md와 1:1 매핑됨
  - TypeScript + Python 사용 예제가 포함됨
  - SDK 배포/버전 관리 전략이 정의됨
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP 통합 스펙 설계 문서 작성 (API-06)</name>
  <files>.planning/deliverables/23-mcp-integration.md</files>
  <action>
  API-06 MCP(Model Context Protocol) 통합 스펙 설계 문서를 작성한다. 문서 상단에 "문서 ID: API-06", 작성일, 상태, 참조 문서를 기재한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요: MCP 통합 전략**
  - MCP 채택 배경: 2026년 AI 에이전트-도구 연동의 사실상 표준. Google, Microsoft, OpenAI 모두 채택. OpenAI Assistants API 2026 중반 sunset.
  - 핵심 원칙: (1) MCP Tools는 에이전트 핵심 동작만 (10개 이내), (2) 관리 작업은 REST API만, (3) MCP Resources로 읽기 전용 정보 노출, (4) OAuth 2.1 기반 인증
  - 안티패턴: 모든 REST API를 MCP Tool로 노출하지 않음 (LLM 컨텍스트 효율, 05-RESEARCH.md Pitfall 4)
  - WAIaaS MCP 서버 아키텍처 다이어그램 (Mermaid): AI Agent (Claude/GPT/Gemini) -> MCP Client -> MCP Server (waiass-wallet) -> WAIaaS REST API

  **2. MCP Server 구성**
  - 서버 메타데이터: name("waiass-wallet"), version("1.0.0")
  - @modelcontextprotocol/sdk 기반 구현 (05-RESEARCH.md Pattern 5)
  - 전송 계층: stdio (로컬), SSE (원격), Streamable HTTP (차세대)
  - 연결 구성 예시 (Claude Desktop claude_desktop_config.json, MCP 클라이언트 설정)

  **3. MCP Tools 설계 (에이전트 핵심 동작)**
  에이전트가 직접 호출하는 Tool만 정의. 각 Tool에 대해: name, description(LLM이 이해할 수 있는 명확한 설명), inputSchema(Zod 기반), 반환 값, 매핑되는 REST API 엔드포인트를 정의.

  3.1 execute_transaction: 트랜잭션 실행
  - description: "Execute a cryptocurrency transaction from the agent wallet. Supports SOL and SPL tokens. Subject to policy limits."
  - input: to(string, 목적지 주소), amount(string, lamports), mint(string, optional, 토큰 주소)
  - return: TransactionResult (id, status, txSignature)
  - REST: POST /api/v1/transactions

  3.2 get_balance: 잔액 조회
  - description: "Get the current wallet balance including SOL and all SPL tokens."
  - input: (없음 - 에이전트 자신의 잔액)
  - return: Balance (sol, tokens[])
  - REST: GET /api/v1/agents/:agentId/balance

  3.3 get_transaction: 트랜잭션 상태 조회
  - description: "Check the status of a previously submitted transaction."
  - input: txId(string)
  - return: Transaction
  - REST: GET /api/v1/transactions/:txId

  3.4 list_transactions: 거래 내역 조회
  - description: "List recent transactions from the agent wallet with optional filters."
  - input: limit(number, optional, 기본 10), status(string, optional)
  - return: Transaction[]
  - REST: GET /api/v1/agents/:agentId/transactions

  3.5 get_policy: 현재 정책 조회
  - description: "View the current spending policy including limits, whitelist, and operating hours."
  - input: (없음)
  - return: AgentPolicy
  - REST: GET /api/v1/agents/:agentId/policy

  3.6 get_policy_usage: 정책 사용량 조회
  - description: "Check current spending usage against policy limits (daily, weekly, monthly)."
  - input: (없음)
  - return: PolicyUsage
  - REST: GET /api/v1/agents/:agentId/policy/usage

  3.7 get_agent_status: 에이전트 상태 조회
  - description: "Check the current status of this agent (ACTIVE, SUSPENDED, etc)."
  - input: (없음)
  - return: AgentStatus
  - REST: GET /api/v1/agents/:agentId

  선택적 Tools (소유자 전용, MCP로 노출 시):
  3.8 suspend_agent: 에이전트 정지 (소유자 전용)
  3.9 resume_agent: 에이전트 재활성화 (소유자 전용)

  각 Tool 정의에 Zod 스키마 코드 예시를 포함할 것 (server.tool() 호출 형태).

  **4. MCP Resources 설계 (읽기 전용 정보)**
  - wallet://balance: 현재 잔액 (JSON)
  - wallet://policy: 현재 정책 (JSON)
  - wallet://status: 에이전트 상태 (JSON)
  - wallet://transactions/recent: 최근 10건 거래 (JSON)
  - 각 Resource에 대해: URI, name, description, mimeType, 매핑되는 REST API
  - Resource 구독(subscription) 지원: 잔액 변동 시 자동 업데이트 알림

  **5. MCP 인증 설계**
  - OAuth 2.1 기반 (MCP 스펙 요구사항)
  - Protected Resource Metadata (PRM) 엔드포인트: GET /.well-known/oauth-protected-resource
  - API Key 어댑터: MCP 클라이언트가 API Key를 Bearer Token으로 직접 전달 (18-authentication-model.md 참조)
  - 인증 플로우 다이어그램 (Mermaid):
    1. MCP Client가 PRM 발견
    2. OAuth Authorization Server Metadata 조회
    3. Client Credentials Grant로 토큰 획득 (또는 API Key 직접 사용)
    4. MCP 요청에 Bearer Token 포함
  - 스코프: MCP Tools/Resources별 필요 스코프 매핑

  **6. MCP 에러 처리**
  - MCP Tool 호출 실패 시 에러 응답 구조: isError: true, content에 에러 메시지
  - WAIaaS 에러(WalletApiError)를 MCP 에러로 변환하는 매핑
  - 에이전트(LLM)에게 유용한 에러 메시지: code와 함께 다음 행동 제안 포함
  - 예시: POLICY_DAILY_LIMIT_EXCEEDED -> "Daily spending limit exceeded. Remaining budget: 500000000 lamports. Try a smaller amount or wait until tomorrow."

  **7. 배포 및 연동 가이드**
  - npm 패키지: @waiass/mcp-server
  - Claude Desktop 연동 설정 (claude_desktop_config.json 예시)
  - 범용 MCP 클라이언트 연동 (stdio transport, SSE transport)
  - 환경 변수: WAIASS_API_KEY, WAIASS_API_URL, WAIASS_AGENT_ID
  - Docker 이미지 제공 (원격 배포용)

  **8. MCP vs REST 기능 매트릭스**
  - REST API 전체 엔드포인트 vs MCP Tool/Resource 대응 테이블
  - REST-only 기능 명시: 에이전트 CRUD, 정책 변경, 자금 충전/회수, Webhook 관리, API Key 관리, 비상 회수
  - MCP 제공 기능: 트랜잭션 실행, 잔액/정책/상태 조회, 거래 내역 조회
  - 근거: 에이전트는 "사용"하고, 소유자는 "관리"한다. MCP는 사용 기능만.

  최소 3개의 코드 블록 포함: MCP Tool 정의 예시, MCP Resource 정의 예시, 클라이언트 연동 설정 예시.
  최소 2개의 다이어그램 포함: MCP 아키텍처, MCP 인증 플로우.
  05-RESEARCH.md의 Pattern 5 (MCP Server Integration) + MCP Tool 매핑 테이블을 기반으로 확장할 것.
  MCP Tools는 10개 이내로 엄격히 제한. 관리 기능은 REST API로만 제공.
  </action>
  <verify>
  파일 존재: ls .planning/deliverables/23-mcp-integration.md
  MCP Server: grep -c "McpServer\|@modelcontextprotocol/sdk\|waiass-wallet" .planning/deliverables/23-mcp-integration.md (3 이상)
  MCP Tools: grep -c "server.tool\|execute_transaction\|get_balance\|get_policy" .planning/deliverables/23-mcp-integration.md (5 이상)
  MCP Resources: grep -c "server.resource\|wallet://\|Resource" .planning/deliverables/23-mcp-integration.md (4 이상)
  인증: grep -c "oauth-protected-resource\|Bearer\|API Key 어댑터\|MCP 인증" .planning/deliverables/23-mcp-integration.md (3 이상)
  다이어그램: grep -c "```mermaid" .planning/deliverables/23-mcp-integration.md (2 이상)
  코드 블록: grep -c "```typescript" .planning/deliverables/23-mcp-integration.md (3 이상)
  기능 매트릭스: grep -c "REST-only\|MCP.*제공\|매트릭스\|REST.*MCP" .planning/deliverables/23-mcp-integration.md (2 이상)
  Tool 제한: MCP Tools가 10개 이내인지 확인 (수동 카운트)
  </verify>
  <done>
  - MCP Server 구성(name, version, transport, 메타데이터)이 정의됨
  - 7-9개의 MCP Tools가 에이전트 핵심 동작(트랜잭션, 잔액, 정책, 상태)에 한정되어 Zod 스키마와 함께 정의됨
  - 4개의 MCP Resources가 읽기 전용 정보로 정의됨
  - MCP 인증(OAuth 2.1 + API Key 어댑터)이 PRM, 플로우 다이어그램과 함께 설계됨
  - MCP 에러 처리(WalletApiError -> MCP 에러 변환, LLM 친화 메시지)가 정의됨
  - 배포/연동 가이드(npm, Claude Desktop, Docker)가 제공됨
  - REST vs MCP 기능 매트릭스가 명확히 구분됨
  - 최소 3개 코드 블록, 2개 다이어그램이 포함됨
  </done>
</task>

</tasks>

<verification>
Phase 5 Plan 04 전체 검증:
1. 두 문서가 .planning/deliverables/에 존재: ls .planning/deliverables/22-sdk-interface.md .planning/deliverables/23-mcp-integration.md
2. TypeScript/Python SDK의 전체 메서드 시그니처가 REST API와 1:1 매핑됨
3. SDK 공통 패턴(Options Bag, 페이지네이션, 에러 계층, 재시도)이 설계됨
4. MCP Tools가 10개 이내로 핵심 동작에 한정됨
5. MCP Resources가 읽기 전용으로 정의됨
6. MCP 인증이 OAuth 2.1 + API Key 어댑터로 설계됨
7. REST vs MCP 기능 구분이 명확함
</verification>

<success_criteria>
- API-05 충족: TypeScript/Python SDK의 메서드 시그니처가 설계됨
- API-06 충족: 에이전트 프레임워크 연동 방법이 정의됨
- SDK 원칙: HTTP 추상화, 타입 안전, 자동 페이지네이션, 에러 계층
- MCP 원칙: 핵심 동작만 노출(10개 이내), LLM 컨텍스트 효율, 표준 프로토콜 준수
- 일관성: SDK 메서드와 MCP Tools가 동일한 REST API를 기반으로 하며 인증/에러 체계가 통합됨
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-및-통합-설계/05-04-SUMMARY.md`
</output>
