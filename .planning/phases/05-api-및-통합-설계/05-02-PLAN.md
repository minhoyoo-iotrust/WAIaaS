---
phase: 05-api-및-통합-설계
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/20-error-codes.md
autonomous: true

must_haves:
  truths:
    - "RFC 9457 기반 에러 응답 구조가 표준 필드(type, title, status, detail, instance)와 확장 필드(code, param, requestId, docUrl, retryable, escalation)로 완전히 정의됨"
    - "4-Layer 에러 코드 계층(HTTP Status -> Error Type -> Error Code -> Detail)이 전체 레지스트리로 구축됨"
    - "도메인별 에러 코드(정책, 인증, 트랜잭션, 에이전트, 시스템)가 각각 코드, 설명, 재시도 여부, 에스컬레이션 수준과 함께 정의됨"
    - "Webhook 에러 이벤트 매핑이 정의되어 에러 발생 시 어떤 Webhook이 트리거되는지 명확함"
  artifacts:
    - path: ".planning/deliverables/20-error-codes.md"
      provides: "에러 코드 및 처리 규격 정의 (API-04)"
      contains: "RFC 9457"
  key_links:
    - from: "20-error-codes.md"
      to: "10-transaction-flow.md"
      via: "트랜잭션 흐름의 각 단계에서 발생 가능한 에러가 코드로 매핑됨"
      pattern: "TRANSACTION_|POLICY_"
    - from: "20-error-codes.md"
      to: "15-agent-lifecycle-management.md"
      via: "에이전트 상태 전이 실패 시 에러 코드가 매핑됨"
      pattern: "AGENT_"
    - from: "20-error-codes.md"
      to: "16-emergency-recovery.md"
      via: "비상 트리거 시 에러/이벤트 코드가 매핑됨"
      pattern: "EMERGENCY_|CRITICAL"
---

<objective>
에러 코드 및 처리 규격(API-04) 설계 문서를 작성한다.

Purpose: WAIaaS API의 전체 에러 체계를 사전 정의하여 모든 엔드포인트가 일관된 에러 응답을 반환하도록 한다. RFC 9457 Problem Details 표준 + Stripe 스타일 계층적 에러 코드를 결합하여, 외부 개발자와 AI 에이전트가 에러를 프로그래밍적으로 일관되게 처리할 수 있게 한다. 이 문서는 OpenAPI 스펙(API-01)의 에러 스키마와 SDK(API-05)의 에러 타입 계층의 기반이 된다.

Output: .planning/deliverables/20-error-codes.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 5 research (MUST READ - RFC 9457, Stripe error pattern, code examples)
@.planning/phases/05-api-및-통합-설계/05-RESEARCH.md

# Phase 3 deliverables (transaction flow for error mapping, security threat model)
@.planning/deliverables/10-transaction-flow.md
@.planning/deliverables/11-security-threat-model.md

# Phase 4 deliverables (agent states, emergency triggers, policy violations)
@.planning/deliverables/13-fund-deposit-process.md
@.planning/deliverables/14-fund-withdrawal-process.md
@.planning/deliverables/15-agent-lifecycle-management.md
@.planning/deliverables/16-emergency-recovery.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 에러 코드 및 처리 규격 설계 문서 작성 (API-04)</name>
  <files>.planning/deliverables/20-error-codes.md</files>
  <action>
  API-04 에러 코드 및 처리 규격 설계 문서를 작성한다. 문서 상단에 "문서 ID: API-04", 작성일, 상태, 참조 문서를 기재한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요: 에러 응답 표준**
  - RFC 9457 (Problem Details for HTTP APIs) 채택 배경 및 핵심 원칙
  - Stripe 스타일 계층적 에러 코드 패턴과의 결합 근거
  - 핵심 원칙: (1) 모든 에러 응답이 동일 구조, (2) 프로그래밍적 처리 가능(code로 분기), (3) 사람이 읽을 수 있는 detail, (4) 문서 링크(docUrl) 제공, (5) 재시도 가능 여부 명시

  **2. 에러 응답 구조 (WalletApiError)**
  - WalletApiError TypeScript 인터페이스 (05-RESEARCH.md Pattern 3 기반, 그대로 활용):
    - RFC 9457 표준 필드: type(에러 타입 URI), title(짧은 설명), status(HTTP 상태 코드), detail(상세 설명), instance(요청 인스턴스 URI)
    - 확장 필드: code(도메인 에러 코드), param(문제 파라미터), requestId(요청 추적 ID), docUrl(문서 링크), retryable(재시도 가능 여부), escalation(에스컬레이션 수준 - LOW/MEDIUM/HIGH/CRITICAL)
  - Content-Type: application/problem+json (RFC 9457 표준)
  - 에러 응답 예시 3개 (05-RESEARCH.md의 RFC 9457 에러 응답 예시 활용): 정책 위반, 인증 실패, 에이전트 상태 충돌

  **3. 4-Layer 에러 코드 계층 구조**
  - 계층 다이어그램 (ASCII 또는 Mermaid):
    Layer 1: HTTP Status Code (400, 401, 403, 404, 409, 422, 429, 500, 502, 503)
      -> Layer 2: Error Type (policy_error, auth_error, validation_error, transaction_error, agent_error, funding_error, system_error, webhook_error)
        -> Layer 3: Error Code (POLICY_DAILY_LIMIT_EXCEEDED, AUTH_KEY_EXPIRED, ...)
          -> Layer 4: Detail (context-specific human-readable message)
  - HTTP Status Code 사용 원칙 테이블: 각 상태 코드의 의미와 사용 시나리오 (10개)

  **4. 에러 코드 레지스트리 (전체 목록)**
  도메인별로 분류하여 모든 에러 코드를 테이블로 정의. 각 코드에 대해: code, HTTP status, type, title, retryable, escalation, 설명.

  4.1 인증 에러 (auth_error) - HTTP 401/403:
  - AUTH_KEY_INVALID: 잘못된 API Key
  - AUTH_KEY_EXPIRED: 만료된 API Key
  - AUTH_KEY_REVOKED: 폐기된 API Key
  - AUTH_TOKEN_EXPIRED: OAuth 토큰 만료
  - AUTH_TOKEN_INVALID: 잘못된 OAuth 토큰
  - AUTH_SCOPE_INSUFFICIENT: 스코프 부족
  - AUTH_IP_BLOCKED: IP 화이트리스트 외 접근
  - AUTH_MFA_REQUIRED: MFA 인증 필요 (소유자 조작 시)

  4.2 검증 에러 (validation_error) - HTTP 400/422:
  - VALIDATION_REQUIRED_FIELD: 필수 필드 누락
  - VALIDATION_INVALID_FORMAT: 잘못된 형식 (예: 주소 형식)
  - VALIDATION_OUT_OF_RANGE: 값 범위 초과
  - VALIDATION_INVALID_ENUM: 잘못된 열거값
  - VALIDATION_DUPLICATE: 중복 리소스

  4.3 정책 에러 (policy_error) - HTTP 403:
  - POLICY_PER_TX_LIMIT_EXCEEDED: 건당 한도 초과
  - POLICY_DAILY_LIMIT_EXCEEDED: 일일 한도 초과
  - POLICY_WEEKLY_LIMIT_EXCEEDED: 주간 한도 초과
  - POLICY_MONTHLY_LIMIT_EXCEEDED: 월간 한도 초과
  - POLICY_DESTINATION_NOT_ALLOWED: 허용되지 않은 목적지
  - POLICY_PROGRAM_NOT_ALLOWED: 허용되지 않은 프로그램
  - POLICY_TOKEN_NOT_ALLOWED: 허용되지 않은 토큰
  - POLICY_OUTSIDE_OPERATING_HOURS: 운영 시간 외 요청
  - POLICY_BLACKOUT_DATE: 거래 금지일
  - POLICY_GLOBAL_BUDGET_EXCEEDED: 전체 합산 예산 초과 (REL-05 GlobalBudgetLimit)

  4.4 에이전트 에러 (agent_error) - HTTP 404/409:
  - AGENT_NOT_FOUND: 에이전트 없음
  - AGENT_SUSPENDED: 정지 상태에서 트랜잭션 시도
  - AGENT_TERMINATED: 폐기된 에이전트 조작 시도
  - AGENT_CREATING: 생성 중 에이전트 사용 시도
  - AGENT_TERMINATING: 폐기 진행 중
  - AGENT_KEY_ROTATION_IN_PROGRESS: 키 로테이션 진행 중

  4.5 트랜잭션 에러 (transaction_error) - HTTP 400/409/502:
  - TRANSACTION_NOT_FOUND: 트랜잭션 없음
  - TRANSACTION_ALREADY_SUBMITTED: 중복 제출
  - TRANSACTION_SIGNING_FAILED: 서명 실패 (Enclave/KMS 오류)
  - TRANSACTION_SUBMISSION_FAILED: 온체인 제출 실패
  - TRANSACTION_SIMULATION_FAILED: 시뮬레이션 실패
  - TRANSACTION_EXPIRED: 블록해시 만료
  - TRANSACTION_INSUFFICIENT_BALANCE: 잔액 부족

  4.6 자금 에러 (funding_error) - HTTP 400/409:
  - FUNDING_INSUFFICIENT_OWNER_BALANCE: 소유자 잔액 부족
  - FUNDING_VAULT_ADDRESS_MISMATCH: Vault 주소 불일치 (멀티시그 주소 오사용 방지)
  - FUNDING_REPLENISHMENT_LIMIT_REACHED: 일일 보충 횟수 초과
  - FUNDING_WITHDRAWAL_IN_PROGRESS: 회수 진행 중 충전 시도
  - FUNDING_WITHDRAWAL_EXCEEDS_BALANCE: 회수 금액이 Vault 잔액 초과

  4.7 비상 에러 (emergency_error) - HTTP 409/503:
  - EMERGENCY_ALREADY_SUSPENDED: 이미 비상 정지 상태
  - EMERGENCY_RECOVERY_IN_PROGRESS: 비상 회수 진행 중
  - EMERGENCY_CIRCUIT_BREAKER_ACTIVE: Circuit Breaker 활성 (ARCH-04 연동)

  4.8 시스템 에러 (system_error) - HTTP 500/502/503:
  - SYSTEM_INTERNAL_ERROR: 내부 서버 오류 (상세 내용 비노출)
  - SYSTEM_KMS_UNAVAILABLE: AWS KMS 서비스 불가
  - SYSTEM_ENCLAVE_UNAVAILABLE: Nitro Enclave 서비스 불가
  - SYSTEM_RPC_UNAVAILABLE: Solana RPC 서비스 불가
  - SYSTEM_DATABASE_ERROR: 데이터베이스 오류
  - SYSTEM_RATE_LIMITED: Rate Limit 초과 (429)
  - SYSTEM_MAINTENANCE: 서비스 점검 중 (503)

  4.9 Webhook 에러 (webhook_error) - HTTP 400/404:
  - WEBHOOK_NOT_FOUND: 웹훅 없음
  - WEBHOOK_URL_UNREACHABLE: 웹훅 URL 접근 불가
  - WEBHOOK_SIGNATURE_INVALID: 웹훅 서명 검증 실패 (클라이언트 측)
  - WEBHOOK_DELIVERY_FAILED: 웹훅 전달 실패

  **5. 에러 처리 가이드 (개발자 향)**
  - 에러 처리 플로우차트 (Mermaid): 에러 수신 -> code 확인 -> retryable 확인 -> 재시도 or 에러 보고
  - 재시도 전략: retryable=true인 경우 exponential backoff (1s, 2s, 4s), 최대 3회
  - 에스컬레이션별 대응 가이드: LOW(로깅만), MEDIUM(소유자 알림), HIGH(즉시 대응 필요), CRITICAL(자동 정지됨)
  - SDK에서의 에러 처리 패턴 (TypeScript/Python 예시 코드): try-catch에서 error.code로 분기

  **6. Webhook 에러 이벤트 매핑**
  - 에러 코드 -> Webhook 이벤트 매핑 테이블:
    - POLICY_* -> policy.violation 이벤트
    - TRANSACTION_SIGNING_FAILED/SUBMISSION_FAILED -> transaction.failed 이벤트
    - EMERGENCY_* -> emergency.triggered 이벤트
    - AGENT_SUSPENDED -> agent.suspended 이벤트
  - 에스컬레이션 수준별 Webhook 전달 우선순위

  **7. 에러 코드 거버넌스**
  - 새 에러 코드 추가 절차: 도메인 확인 -> 코드 명명 규칙(DOMAIN_ACTION_DETAIL) -> 레지스트리 등록 -> docUrl 생성
  - 에러 코드 폐기 절차: deprecated 마킹 -> 6개월 유예 -> 삭제
  - docUrl 패턴: https://docs.waiass.io/errors/{ERROR_CODE}
  - 코드 명명 규칙: SCREAMING_SNAKE_CASE, 접두사는 도메인(AUTH_, POLICY_, TRANSACTION_, AGENT_, FUNDING_, EMERGENCY_, SYSTEM_, WEBHOOK_)

  최소 2개의 다이어그램 포함: 4-Layer 에러 코드 계층 구조, 에러 처리 플로우차트.
  05-RESEARCH.md의 Pattern 3 (Hierarchical Error Response)과 Code Examples (RFC 9457 에러 응답)을 기반으로 하되 포괄적으로 확장.
  Phase 3/4에서 정의된 모든 실패 시나리오(트랜잭션 실패, 정책 위반, 비상 트리거, 키 로테이션 실패 등)를 에러 코드로 매핑할 것.
  </action>
  <verify>
  파일 존재: ls .planning/deliverables/20-error-codes.md
  RFC 9457: grep -c "RFC 9457\|application/problem+json" .planning/deliverables/20-error-codes.md (2 이상)
  WalletApiError: grep -c "WalletApiError\|interface.*Error" .planning/deliverables/20-error-codes.md (2 이상)
  에러 코드 수: grep -c "^[- |]*AUTH_\|^[- |]*POLICY_\|^[- |]*TRANSACTION_\|^[- |]*AGENT_\|^[- |]*FUNDING_\|^[- |]*SYSTEM_\|^[- |]*EMERGENCY_\|^[- |]*WEBHOOK_\|^[- |]*VALIDATION_" .planning/deliverables/20-error-codes.md (30 이상)
  에러 타입 범주: grep -c "auth_error\|policy_error\|validation_error\|transaction_error\|agent_error\|funding_error\|system_error\|webhook_error" .planning/deliverables/20-error-codes.md (8 이상)
  다이어그램: grep -c "```mermaid" .planning/deliverables/20-error-codes.md (2 이상)
  재시도 가이드: grep -c "retryable\|exponential backoff\|Retry-After" .planning/deliverables/20-error-codes.md (3 이상)
  docUrl 패턴: grep -c "docs.waiass.io/errors" .planning/deliverables/20-error-codes.md (2 이상)
  </verify>
  <done>
  - RFC 9457 기반 WalletApiError 구조가 표준 + 확장 필드로 완전히 정의됨
  - 4-Layer 에러 코드 계층 구조가 다이어그램과 함께 설명됨
  - 9개 도메인(auth, validation, policy, agent, transaction, funding, emergency, system, webhook)에 걸쳐 40개 이상의 에러 코드가 레지스트리로 정의됨
  - 각 에러 코드에 code, HTTP status, type, retryable, escalation, 설명이 명세됨
  - 에러 처리 가이드(재시도 전략, 에스컬레이션 대응)가 플로우차트와 함께 제공됨
  - Webhook 에러 이벤트 매핑이 정의됨
  - 에러 코드 거버넌스(추가/폐기 절차, 명명 규칙)가 정의됨
  - 최소 2개의 Mermaid 다이어그램이 포함됨
  </done>
</task>

</tasks>

<verification>
Phase 5 Plan 02 전체 검증:
1. 문서가 .planning/deliverables/에 존재: ls .planning/deliverables/20-error-codes.md
2. RFC 9457 표준 기반 에러 응답 구조가 정의됨
3. 40개 이상의 에러 코드가 9개 도메인에 걸쳐 레지스트리로 구축됨
4. 에러 처리 가이드(재시도, 에스컬레이션)가 개발자 관점으로 제공됨
5. Phase 3/4의 실패 시나리오가 에러 코드로 매핑됨
6. Webhook 이벤트와의 연동이 정의됨
</verification>

<success_criteria>
- API-04 충족: 모든 에러 코드와 처리 규격이 정의됨
- RFC 9457 준수: 표준 필드(type, title, status, detail, instance) 포함
- Stripe 패턴: 계층적 코드 체계, docUrl, retryable 포함
- 포괄성: Phase 3(트랜잭션 실패, 보안 위협) + Phase 4(정책 위반, 에이전트 상태, 비상) 모든 실패 시나리오 커버
- 개발자 친화: 에러 코드로 프로그래밍적 분기 가능, 재시도 가이드 제공
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-및-통합-설계/05-02-SUMMARY.md`
</output>
