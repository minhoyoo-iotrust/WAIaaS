---
phase: 05-api-및-통합-설계
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - .planning/deliverables/21-openapi-spec.md
autonomous: true

must_haves:
  truths:
    - "모든 REST API 엔드포인트(에이전트, 트랜잭션, 자금, 정책, 소유자, 비상, Webhook, 인증)가 경로, 메서드, 요청/응답 스키마와 함께 정의됨"
    - "OpenAPI 3.0 스펙의 securitySchemes에 API Key와 OAuth 2.1이 정의되고 각 엔드포인트에 적용됨"
    - "모든 응답에 에러 스키마(WalletApiError)가 포함되어 API-04와 연동됨"
    - "Webhook 이벤트 타입, 페이로드, 서명 검증(HMAC-SHA256), 재시도 정책이 정의됨"
    - "API 버전 관리 전략(/api/v1/, Sunset 헤더, deprecation 정책)이 명시됨"
    - "Zod 스키마 기반 자동 생성 전략이 설명되어 구현 시 스펙-코드 동기화 방법이 명확함"
  artifacts:
    - path: ".planning/deliverables/21-openapi-spec.md"
      provides: "에이전트 지갑 REST API 스펙 설계 (API-01)"
      contains: "openapi: 3.0"
  key_links:
    - from: "21-openapi-spec.md"
      to: "18-authentication-model.md"
      via: "securitySchemes가 인증 모델의 API Key/OAuth 2.1을 참조"
      pattern: "ApiKeyAuth|OAuth2|securitySchemes"
    - from: "21-openapi-spec.md"
      to: "20-error-codes.md"
      via: "모든 에러 응답이 WalletApiError 스키마를 사용"
      pattern: "WalletApiError|application/problem\\+json"
    - from: "21-openapi-spec.md"
      to: "19-permission-policy-model.md"
      via: "엔드포인트별 필요 스코프가 권한 모델과 일치"
      pattern: "agents:read|transactions:execute|security"
    - from: "21-openapi-spec.md"
      to: "13-fund-deposit-process.md"
      via: "자금 충전/회수 API가 Phase 4 프로세스를 구현"
      pattern: "/fund|/withdraw|/balance"
---

<objective>
에이전트 지갑 REST API 스펙(API-01) 설계 문서를 작성한다.

Purpose: WAIaaS의 전체 REST API를 OpenAPI 3.0 형식으로 설계한다. Phase 3-4에서 확정된 기능(에이전트 관리, 트랜잭션, 자금, 정책, 비상)을 API 엔드포인트로 변환하고, Plan 05-01(인증/권한)과 Plan 05-02(에러 코드)에서 설계한 보안/에러 체계를 통합한다. 이 문서는 SDK(API-05)와 MCP(API-06) 인터페이스 설계의 기반이 된다.

Output: .planning/deliverables/21-openapi-spec.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 5 research (endpoint list, OpenAPI structure, Zod patterns)
@.planning/phases/05-api-및-통합-설계/05-RESEARCH.md

# Phase 5 prior plan outputs (MUST READ for auth schemes and error schemas)
@.planning/phases/05-api-및-통합-설계/05-01-SUMMARY.md
@.planning/phases/05-api-및-통합-설계/05-02-SUMMARY.md

# Phase 5 deliverables from prior plans
@.planning/deliverables/18-authentication-model.md
@.planning/deliverables/19-permission-policy-model.md
@.planning/deliverables/20-error-codes.md

# Phase 3-4 deliverables (source of API functionality)
@.planning/deliverables/08-dual-key-architecture.md
@.planning/deliverables/09-system-components.md
@.planning/deliverables/10-transaction-flow.md
@.planning/deliverables/13-fund-deposit-process.md
@.planning/deliverables/14-fund-withdrawal-process.md
@.planning/deliverables/15-agent-lifecycle-management.md
@.planning/deliverables/16-emergency-recovery.md
@.planning/deliverables/17-multi-agent-management.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: OpenAPI 3.0 REST API 스펙 설계 문서 작성 - 공통 구조 및 에이전트/트랜잭션 API (API-01 Part 1)</name>
  <files>.planning/deliverables/21-openapi-spec.md</files>
  <action>
  API-01 OpenAPI 3.0 REST API 스펙 설계 문서를 작성한다. 문서 상단에 "문서 ID: API-01", 작성일, 상태, 참조 문서를 기재한다. 이 태스크에서는 문서의 전반부(공통 구조 + 에이전트/트랜잭션/자금 API)를 작성한다. 아래 섹션을 반드시 포함할 것.

  **1. 개요: API 설계 원칙**
  - Zod as Single Source of Truth: Zod 스키마 -> TypeScript 타입 + OpenAPI 스키마 + 런타임 검증 자동 생성 (05-RESEARCH.md Pattern 1)
  - API 버전 관리: URL 경로 기반 (/api/v1/), 마이너 버전은 헤더 (X-API-Version), Sunset 헤더로 deprecation 고지
  - 일관된 응답 구조: 성공(200/201) + 에러(RFC 9457 WalletApiError)
  - 페이지네이션: 커서 기반 (cursor + limit), Link 헤더로 다음 페이지 URL 제공
  - 필터링/정렬: 쿼리 파라미터 (status, createdAfter, createdBefore, sortBy, sortOrder)
  - 요청 ID: 모든 응답에 X-Request-Id 헤더, 에러에 requestId 필드

  **2. OpenAPI 3.0 스펙 메타데이터 (YAML)**
  - 05-RESEARCH.md의 OpenAPI 3.0 스펙 구조 YAML을 기반으로 작성:
    - openapi: 3.0.3, info (title, description, version, contact, license)
    - servers (production, testnet)
    - tags (Agents, Transactions, Funding, Policies, Owner, Emergency, Webhooks, Auth)
    - security (ApiKeyAuth, OAuth2)
    - components.securitySchemes (18-authentication-model.md 기반)

  **3. 공통 스키마 정의 (components/schemas)**
  - 공통 응답 스키마:
    - PaginatedResponse: items, cursor, hasMore, total
    - WalletApiError: RFC 9457 기반 (20-error-codes.md 참조)
    - Timestamps: createdAt, updatedAt (ISO 8601)
  - 도메인 스키마 (Zod 인터페이스 + OpenAPI YAML 병행 표기):
    - Agent: id, nickname, status(5단계 상태), ownerId, multisigAddress, vaultAddress, createdAt, updatedAt
    - AgentPolicy: limits, whitelist, timeControl, escalation (19-permission-policy-model.md 기반)
    - BudgetConfig: dailyLimit, weeklyLimit, monthlyLimit, perTransactionLimit (13-fund-deposit-process.md 기반)
    - Transaction: id, agentId, type, to, amount, mint, status, txSignature, createdAt, confirmedAt
    - Balance: sol, tokens[{mint, amount}], lastUpdatedAt
    - WebhookEvent: id, type, data, agentId, createdAt (05-RESEARCH.md Webhook 이벤트 설계 기반)

  **4. 에이전트 관리 API (Agents)**
  각 엔드포인트에 대해: 경로, 메서드, 설명, 필요 스코프, 요청 스키마(Zod + YAML), 응답 스키마(성공 + 에러), 에러 코드 목록을 정의.

  - POST /api/v1/agents: 에이전트 생성. 요청: nickname, budgetConfig, allowedDestinations, replenishmentMode, tags. 응답: 201 Agent. 에러: VALIDATION_*, AUTH_*. 스코프: agents:write
  - GET /api/v1/agents: 에이전트 목록. 쿼리: status, cursor, limit, sortBy. 응답: PaginatedResponse<Agent>. 스코프: agents:read
  - GET /api/v1/agents/:agentId: 에이전트 상세. 응답: Agent + policy + balance. 에러: AGENT_NOT_FOUND. 스코프: agents:read
  - PATCH /api/v1/agents/:agentId: 에이전트 수정. 요청: nickname, tags (정책은 별도 API). 스코프: agents:write
  - DELETE /api/v1/agents/:agentId: 에이전트 삭제(TERMINATED). 에러: AGENT_TERMINATED, AGENT_TERMINATING. 스코프: agents:delete
  - POST /api/v1/agents/:agentId/suspend: 정지. 요청: reason(optional). 에러: AGENT_SUSPENDED. 스코프: agents:write
  - POST /api/v1/agents/:agentId/resume: 재활성화. 에러: AGENT_NOT_FOUND. 스코프: agents:write
  - POST /api/v1/agents/:agentId/rotate-key: 키 로테이션. 에러: AGENT_KEY_ROTATION_IN_PROGRESS. 스코프: agents:write

  **5. 트랜잭션 API (Transactions)**
  - POST /api/v1/transactions: 트랜잭션 실행. 요청: agentId, to, amount, mint(optional), memo(optional). 응답: 202 Accepted + Transaction(PENDING 상태) + webhookUrl 안내. 에러: POLICY_*, AGENT_SUSPENDED, TRANSACTION_*. 스코프: transactions:execute. 중요: 비동기 처리 - 202 반환 후 Webhook으로 최종 상태 알림 (ARCH-03 "동기 + Webhook" 패턴)
  - GET /api/v1/transactions/:txId: 트랜잭션 상태. 응답: Transaction. 에러: TRANSACTION_NOT_FOUND. 스코프: transactions:read
  - GET /api/v1/agents/:agentId/transactions: 에이전트 거래 내역. 쿼리: status, type, createdAfter, createdBefore, cursor, limit. 응답: PaginatedResponse<Transaction>. 스코프: transactions:read

  **6. 자금 관리 API (Funding)**
  - POST /api/v1/agents/:agentId/fund: 자금 충전. 요청: amount, mint(optional). 응답: 202 FundingResult. 에러: FUNDING_*. 스코프: wallets:fund
  - POST /api/v1/agents/:agentId/withdraw: 자금 회수. 요청: amount(optional, null=전액), destinationPubkey(optional, 기본=소유자). 에러: FUNDING_*. 스코프: wallets:fund
  - GET /api/v1/agents/:agentId/balance: 잔액 조회. 응답: Balance. 스코프: wallets:read
  - POST /api/v1/owner/agents/transfer: 에이전트 간 이동. 요청: fromAgentId, toAgentId, amount, mint. 에러: FUNDING_*. 스코프: wallets:fund

  **7. 정책 관리 API (Policies)**
  - GET /api/v1/agents/:agentId/policy: 정책 조회. 응답: AgentPolicy. 스코프: policies:read
  - PUT /api/v1/agents/:agentId/policy: 정책 변경. 요청: AgentPolicy (partial). 에러: VALIDATION_*. 스코프: policies:write
  - GET /api/v1/agents/:agentId/policy/usage: 사용량 조회. 응답: PolicyUsage(일일/주간/월간 사용량, 남은 한도). 스코프: policies:read

  **8. 소유자 대시보드 API (Owner)**
  - GET /api/v1/owner/dashboard: 통합 대시보드 (REL-05 OwnerDashboard 인터페이스 기반). 스코프: dashboard:read
  - GET /api/v1/owner/agents: 소유자의 모든 에이전트 요약. 스코프: dashboard:read
  - PUT /api/v1/owner/global-budget: 전체 합산 예산 설정. 요청: limit, period. 스코프: policies:write

  **9. 비상 API (Emergency)**
  - POST /api/v1/agents/:agentId/emergency/suspend: 비상 정지. 요청: reason, trigger(manual/circuit_breaker/anomaly_detection). 에러: EMERGENCY_*. 스코프: agents:write
  - POST /api/v1/agents/:agentId/emergency/recover: 비상 회수 요청. 요청: destinationPubkey(optional, 기본=recoveryDestination). 에러: EMERGENCY_*. 스코프: wallets:fund
  - POST /api/v1/owner/emergency/suspend-all: 전체 에이전트 비상 정지. 스코프: admin:all

  **10. Webhook 관리 API**
  - POST /api/v1/webhooks: 웹훅 등록. 요청: url, events(필터링할 이벤트 타입 목록), secret(자동 생성). 응답: Webhook + signingSecret(한 번만 반환)
  - GET /api/v1/webhooks: 웹훅 목록
  - DELETE /api/v1/webhooks/:webhookId: 웹훅 삭제
  - POST /api/v1/webhooks/:webhookId/test: 테스트 이벤트 전송

  **11. Webhook 이벤트 스펙**
  - 이벤트 타입 전체 목록 (05-RESEARCH.md WebhookEventType 기반)
  - WebhookEvent 페이로드 구조
  - HMAC-SHA256 서명 검증 절차: X-WAIaaS-Signature 헤더, 타임스탬프+페이로드 해싱
  - 재시도 정책: 최대 3회, exponential backoff (1s, 5s, 25s), 5초 타임아웃
  - 서명 검증 코드 예시 (TypeScript)

  **12. 인증 API (Auth)**
  - POST /api/v1/auth/keys: API Key 생성 (18-authentication-model.md 참조)
  - GET /api/v1/auth/keys: API Key 목록
  - DELETE /api/v1/auth/keys/:keyId: API Key 폐기
  - POST /oauth/token: OAuth 2.1 토큰 발급
  - POST /oauth/register: Dynamic Client Registration

  **13. API 버전 관리 및 거버넌스**
  - 버전 정책: Major(/v1 -> /v2), Minor(새 필드/엔드포인트, 하위 호환)
  - Deprecation: 최소 6개월 고지, Sunset 헤더, deprecated: true 마킹
  - Breaking change 정의: 필드 삭제, 타입 변경, 필수 파라미터 추가
  - Non-breaking change: 새 optional 필드, 새 에러 코드, 새 엔드포인트

  문서는 마크다운으로 작성하되, 각 엔드포인트 정의에 경로/메서드/스코프/요청/응답/에러를 포함한 구조화된 형식을 사용할 것.
  05-RESEARCH.md의 API 엔드포인트 목록(약 30개)을 전부 커버할 것.
  18-authentication-model.md의 securitySchemes, 19-permission-policy-model.md의 스코프, 20-error-codes.md의 에러 코드를 정확히 참조할 것.
  </action>
  <verify>
  파일 존재: ls .planning/deliverables/21-openapi-spec.md
  OpenAPI 메타데이터: grep -c "openapi: 3.0\|OpenAPI 3.0" .planning/deliverables/21-openapi-spec.md (1 이상)
  엔드포인트 수: grep -c "POST /api/v1\|GET /api/v1\|PUT /api/v1\|PATCH /api/v1\|DELETE /api/v1" .planning/deliverables/21-openapi-spec.md (25 이상)
  보안 스키마: grep -c "ApiKeyAuth\|OAuth2\|securitySchemes" .planning/deliverables/21-openapi-spec.md (3 이상)
  에러 참조: grep -c "WalletApiError\|POLICY_\|AUTH_\|TRANSACTION_\|AGENT_" .planning/deliverables/21-openapi-spec.md (10 이상)
  Webhook: grep -c "HMAC-SHA256\|X-WAIaaS-Signature\|webhook" .planning/deliverables/21-openapi-spec.md (5 이상)
  버전 관리: grep -c "Sunset\|deprecated\|/api/v1" .planning/deliverables/21-openapi-spec.md (3 이상)
  페이지네이션: grep -c "cursor\|PaginatedResponse\|hasMore" .planning/deliverables/21-openapi-spec.md (3 이상)
  도메인 스키마: grep -c "Agent\|Transaction\|Balance\|AgentPolicy\|BudgetConfig" .planning/deliverables/21-openapi-spec.md (10 이상)
  Phase 4 연결: grep -c "REL-01\|REL-02\|REL-03\|REL-04\|REL-05\|ARCH-03" .planning/deliverables/21-openapi-spec.md (3 이상)
  </verify>
  <done>
  - OpenAPI 3.0.3 메타데이터(info, servers, tags, securitySchemes)가 정의됨
  - 공통 스키마(Agent, Transaction, Balance, AgentPolicy, PaginatedResponse, WalletApiError)가 Zod + YAML로 정의됨
  - 25개 이상의 REST API 엔드포인트가 경로, 메서드, 스코프, 요청/응답 스키마, 에러 코드와 함께 완전히 정의됨
  - 8개 도메인(Agents, Transactions, Funding, Policies, Owner, Emergency, Webhooks, Auth)이 모두 커버됨
  - Webhook 이벤트(타입, 페이로드, HMAC-SHA256 서명, 재시도)가 완전히 정의됨
  - API 버전 관리 및 거버넌스 정책이 명시됨
  - Plan 05-01(인증/권한)과 Plan 05-02(에러 코드) 문서가 정확히 참조됨
  </done>
</task>

</tasks>

<verification>
Phase 5 Plan 03 전체 검증:
1. 문서가 .planning/deliverables/에 존재: ls .planning/deliverables/21-openapi-spec.md
2. 25개 이상의 엔드포인트가 8개 도메인에 걸쳐 정의됨
3. securitySchemes가 18-authentication-model.md와 일관됨
4. 에러 응답이 20-error-codes.md의 WalletApiError를 사용
5. 엔드포인트별 스코프가 19-permission-policy-model.md와 일관됨
6. Webhook 이벤트 스펙이 HMAC-SHA256 서명과 함께 정의됨
7. Phase 3/4 문서의 기능이 빠짐없이 API로 변환됨
</verification>

<success_criteria>
- API-01 충족: OpenAPI 3.0 스펙에 모든 엔드포인트, 요청/응답 스키마가 정의됨
- 통합성: 인증(API-02), 권한(API-03), 에러(API-04) 문서가 API 스펙에 정확히 통합됨
- 완전성: Phase 3-4에서 설계된 모든 기능(에이전트 CRUD, 트랜잭션, 자금, 정책, 비상, 멀티 에이전트)이 API로 변환됨
- 비동기 패턴: 트랜잭션 API가 "동기 응답(202) + Webhook 알림" 패턴을 따름
- 개발자 경험: 커서 기반 페이지네이션, 일관된 응답 구조, 요청 ID 추적
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-및-통합-설계/05-03-SUMMARY.md`
</output>
