---
phase: 39-cli-telegram-integration-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ".planning/deliverables/54-cli-flow-redesign.md"
  - "objectives/v0.9-session-management-automation.md"
autonomous: true

must_haves:
  truths:
    - "`waiaas mcp setup` 커맨드의 인터페이스(--agent, --expires-in 등 옵션), 동작(데몬 확인 -> 에이전트 결정 -> constraints 결정 -> 세션 생성 -> 토큰 파일 저장), 출력(세션 정보 + Claude Desktop config.json 안내)이 54-cli-flow-redesign.md에 정의되어 있다"
    - "`waiaas mcp refresh-token` 커맨드의 동작(토큰 로드 -> 기존 세션 조회 -> 새 세션 생성 -> 토큰 파일 교체 -> 구 세션 폐기, constraints 계승)이 54-cli-flow-redesign.md에 정의되어 있다"
    - "CLI `mcp` 서브커맨드 그룹 진입점(기존 switch 구조에 case 'mcp' 추가)이 정의되어 있다"
    - "Claude Desktop config.json 안내 출력의 플랫폼별 경로(macOS/Windows/Linux)와 JSON 포맷이 정의되어 있다"
  artifacts:
    - path: ".planning/deliverables/54-cli-flow-redesign.md"
      provides: "mcp 서브커맨드 그룹(setup + refresh-token) 설계 섹션"
      contains: "waiaas mcp setup"
    - path: "objectives/v0.9-session-management-automation.md"
      provides: "Phase 39-01 설계 결과 반영"
      contains: "Phase 39-01"
  key_links:
    - from: "54-cli-flow-redesign.md (mcp setup)"
      to: "@waiaas/core utils/token-file.ts (writeMcpToken)"
      via: "토큰 파일 저장"
      pattern: "writeMcpToken"
    - from: "54-cli-flow-redesign.md (mcp refresh-token)"
      to: "@waiaas/core utils/token-file.ts (readMcpToken)"
      via: "기존 토큰 로드"
      pattern: "readMcpToken"
    - from: "54-cli-flow-redesign.md (mcp refresh-token)"
      to: "jose decodeJwt"
      via: "기존 토큰에서 sessionId 추출"
      pattern: "decodeJwt"
---

<objective>
CLI `waiaas mcp setup` 및 `waiaas mcp refresh-token` 두 커맨드의 인터페이스, 동작 플로우, 출력 포맷을 54-cli-flow-redesign.md에 설계 섹션으로 추가한다.

Purpose: MCP 환경 초기 설정과 수동 토큰 교체를 CLI에서 수행할 수 있도록, 구현 시 해석 없이 코딩 가능한 수준의 설계를 제공한다.
Output: 54-cli-flow-redesign.md에 mcp 서브커맨드 그룹 섹션 추가, objectives에 Phase 39-01 결과 반영
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Phase 36 토큰 파일 유틸리티 API (writeMcpToken, readMcpToken, getMcpTokenPath)
@.planning/phases/36-토큰-파일-인프라-알림-이벤트/36-01-SUMMARY.md

# Phase 37 SessionManager 인터페이스 (jose decodeJwt 패턴)
@.planning/phases/37-sessionmanager-core-design/37-01-SUMMARY.md

# Research: CLI 패턴, Claude Desktop config, refresh-token 순서, 에이전트 자동 선택
@.planning/phases/39-cli-telegram-integration-design/39-RESEARCH.md

# CLI 기존 구조 (진입점, parseArgs, 커맨드 목록)
@.planning/deliverables/54-cli-flow-redesign.md

# MCP Server 설계 (Claude Desktop 설정, 토큰 전달)
@.planning/deliverables/38-sdk-mcp-interface.md

# 세션 프로토콜 (SessionConstraints, JWT 구조, 갱신 프로토콜)
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/53-session-renewal-protocol.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 54-cli-flow-redesign.md에 mcp 서브커맨드 그룹 설계 섹션 추가</name>
  <files>.planning/deliverables/54-cli-flow-redesign.md</files>
  <action>
54-cli-flow-redesign.md에 `[v0.9] MCP 서브커맨드 그룹` 섹션을 추가한다. 기존 문서의 커맨드 목록/진입점 구조에 맞춰 다음을 포함:

**1. mcp 서브커맨드 그룹 진입점:**
- 기존 switch 구조(섹션 5.4)에 `case 'mcp': return runMcp(subAction, args)` 추가 패턴
- `runMcp(action, args)` 함수: action = 'setup' | 'refresh-token', 나머지는 usage 출력 + exit(1)
- 커맨드 목록 테이블에 `mcp setup`, `mcp refresh-token` 2개 행 추가

**2. `waiaas mcp setup` 커맨드 설계:**
- 인터페이스: parseArgs 옵션 정의
  - `--agent <name|id>` (선택. 에이전트 1개면 자동 선택, 0개면 에러, 2개 이상이면 필수)
  - `--expires-in <seconds>` (선택. 기본 604800 = 7일)
  - `--max-amount <amount>` (선택. maxAmountPerTx 설정)
  - `--allowed-ops <ops>` (선택. 쉼표 구분 allowedOperations)
  - `--data-dir <path>` (선택. WAIAAS_DATA_DIR 오버라이드)
  - `--output <text|json>` (선택. 기본 text)
  - `--help, -h` (도움말)
- 동작 플로우 (7단계):
  1. 데몬 실행 확인: `GET /health` 요청. 실패 시 "daemon is not running. Start: waiaas start" 에러
  2. 에이전트 결정: `resolveAgentId(baseUrl, options.agent)` -- `GET /v1/agents` 조회 후 자동 선택 또는 매칭. 0개 에러, 2개 이상 --agent 미지정 에러
  3. 기본 constraints 결정: `resolveDefaultConstraints(config, options)` -- CLI 옵션 > config.toml > 하드코딩 기본값
  4. 세션 생성: `POST /v1/sessions` (masterAuth implicit, localhost). body: `{ agentId, expiresIn, maxAmountPerTx?, allowedOperations?, maxRenewals }`
  5. 토큰 파일 저장: `writeMcpToken(getMcpTokenPath(options.dataDir), session.token)` (Phase 36 유틸리티)
  6. 텍스트 출력: 세션 정보 (Agent, Expires, Token path)
  7. Claude Desktop config.json 안내: 플랫폼별 경로 + JSON 스니펫 출력
- Claude Desktop config.json 안내:
  - 플랫폼별 경로: macOS `~/Library/Application Support/Claude/claude_desktop_config.json`, Windows `%APPDATA%\Claude\claude_desktop_config.json`, Linux `~/.config/Claude/claude_desktop_config.json`
  - JSON 스니펫: `{ "mcpServers": { "waiaas-wallet": { "command": "npx", "args": ["@waiaas/mcp"], "env": { "WAIAAS_SESSION_TOKEN": "<token>", "WAIAAS_BASE_URL": "http://127.0.0.1:<port>" } } } }`
  - 참고: "first time only" 안내 -- 토큰 파일 기반이므로 이후 갱신은 자동
- `--output json` 포맷: `{ "agentId", "agentName", "sessionId", "expiresAt", "tokenPath", "configPath" }`
- 에러 케이스 테이블: 데몬 미실행, 에이전트 0개, 에이전트 2개+--agent 미지정, 에이전트 미발견, 세션 생성 실패

**3. `waiaas mcp refresh-token` 커맨드 설계:**
- 인터페이스: parseArgs 옵션 정의
  - `--data-dir <path>` (선택)
  - `--output <text|json>` (선택. 기본 text)
  - `--help, -h`
- 동작 플로우 (8단계, Pitfall 5 순서 적용: 생성 -> 파일 -> 폐기):
  1. 데몬 실행 확인: `GET /health`
  2. 기존 토큰 로드: `readMcpToken(getMcpTokenPath(options.dataDir))`. 파일 없으면 "No token file. Run: waiaas mcp setup" 에러
  3. sessionId 추출: `jose.decodeJwt(token)` -> `payload.sid` (SM-05 패턴)
  4. 기존 세션 조회: `GET /v1/sessions/:sessionId` (masterAuth implicit). constraints + agentId 획득. 세션 미발견 시 "Session not found. Run: waiaas mcp setup" 에러 (만료/폐기된 세션도 DB에서 조회 가능하도록 masterAuth 사용)
  5. 새 세션 생성: `POST /v1/sessions` (기존 agentId + constraints 계승). expiresIn은 기존 세션의 원래 TTL(original_expires_in 필드 또는 기본 604800) 적용
  6. 토큰 파일 교체: `writeMcpToken(getMcpTokenPath(), newSession.token)` (원자적 쓰기)
  7. 구 세션 폐기: `DELETE /v1/sessions/:oldSessionId`. 실패해도 경고만 출력 (새 세션은 이미 활성)
  8. 완료 출력: 갱신 정보 (Old session -> New session, Agent, Expires)
- constraints 계승 규칙:
  - 기존 세션의 `GET /v1/sessions/:id` 응답에서 `constraints` 객체를 그대로 새 세션 생성 body에 전달
  - `renewalCount`는 0으로 리셋 (새 세션이므로)
  - `maxRenewals`는 기존 값 계승
- 에러 케이스 테이블: 데몬 미실행, 토큰 파일 없음, JWT 디코딩 실패, 세션 미발견, 새 세션 생성 실패, 구 세션 폐기 실패(경고)

**문서 구조 참고:** 기존 54-cli-flow-redesign.md의 섹션 구조/포맷/스타일을 준수한다. 새 섹션 번호는 기존 문서의 마지막 섹션 이후에 배치하거나, 기존 커맨드 섹션과 동일 레벨의 하위 섹션으로 추가한다. 문서 헤더에 `v0.9 CLI MCP 서브커맨드: 2026-02-09` 추가. 요구사항 매핑에 CLIP-01, CLIP-02 추가.
  </action>
  <verify>
grep으로 54-cli-flow-redesign.md에 다음이 포함되는지 확인:
- "mcp setup" 문자열 존재
- "mcp refresh-token" 문자열 존재
- "writeMcpToken" 참조 존재
- "readMcpToken" 참조 존재
- "claude_desktop_config.json" 안내 존재
- "CLIP-01" 및 "CLIP-02" 요구사항 ID 존재
- 플랫폼별 경로 3개 (macOS, Windows, Linux) 존재
  </verify>
  <done>
54-cli-flow-redesign.md에 mcp 서브커맨드 그룹(setup + refresh-token) 설계 섹션이 추가되어, 각 커맨드의 인터페이스(parseArgs 옵션), 동작 플로우(단계별), 출력 포맷(text/json), 에러 케이스가 구현 가능한 수준으로 정의되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: v0.9 objectives에 Phase 39-01 설계 결과 반영</name>
  <files>objectives/v0.9-session-management-automation.md</files>
  <action>
objectives/v0.9-session-management-automation.md에 Phase 39-01 설계 완료를 반영한다:

1. CLI MCP 커맨드 관련 섹션에 `[설계 확정 -- Phase 39-01]` 태그 추가
2. 영향받는 설계 문서 테이블의 CLI 행에 `[설계 완료: Phase 39-01]` 표시
3. "Phase 39-01 설계 결과" 섹션 신설:
   - 핵심 설계 결정 목록:
     - CLI-01: mcp 서브커맨드 그룹 (setup + refresh-token) 진입점 패턴
     - CLI-02: mcp setup 7단계 동작 플로우 (데몬확인 -> 에이전트결정 -> constraints -> 세션생성 -> 파일저장 -> 출력 -> config안내)
     - CLI-03: mcp refresh-token 8단계 동작 플로우 (생성 -> 파일 -> 폐기 순서, Pitfall 5 대응)
     - CLI-04: 에이전트 자동 선택 (1개면 자동, 0개 에러, 2개+ 필수)
     - CLI-05: Claude Desktop config.json 플랫폼별 경로 안내 (macOS/Windows/Linux)
     - CLI-06: constraints 계승 규칙 (기존 세션 constraints 그대로 전달, renewalCount 리셋)
   - 설계 문서 위치: 54-cli-flow-redesign.md 해당 섹션 참조
4. 문서 푸터에 Phase 39-01 업데이트 이력 추가
  </action>
  <verify>
objectives/v0.9-session-management-automation.md에 "Phase 39-01" 문자열 존재, "CLI-01" ~ "CLI-06" 결정 ID 존재 확인
  </verify>
  <done>
v0.9 objectives 문서에 Phase 39-01의 CLI MCP 서브커맨드 설계 결과(6건 설계 결정)가 반영되어, 전체 v0.9 진행 상황이 추적 가능하다.
  </done>
</task>

</tasks>

<verification>
1. 54-cli-flow-redesign.md에 mcp 서브커맨드 그룹 섹션이 존재하고, setup/refresh-token 각각의 인터페이스/동작/출력이 정의되어 있다
2. Claude Desktop config.json 안내에 macOS/Windows/Linux 3개 플랫폼 경로가 포함되어 있다
3. mcp refresh-token의 동작 순서가 "생성 -> 파일 -> 폐기" (Pitfall 5 대응)로 정의되어 있다
4. Phase 36 유틸리티(writeMcpToken, readMcpToken, getMcpTokenPath) 참조가 포함되어 있다
5. CLIP-01, CLIP-02 요구사항이 매핑되어 있다
</verification>

<success_criteria>
- `waiaas mcp setup` 커맨드 설계가 인터페이스(7개 옵션), 동작(7단계), 출력(text + json + Claude Desktop config 안내), 에러(5종)를 포함한다
- `waiaas mcp refresh-token` 커맨드 설계가 인터페이스(3개 옵션), 동작(8단계, 생성->파일->폐기), constraints 계승 규칙, 에러(6종)를 포함한다
- objectives 문서에 Phase 39-01 결과(6건 설계 결정)가 반영되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/39-cli-telegram-integration-design/39-01-SUMMARY.md`
</output>
