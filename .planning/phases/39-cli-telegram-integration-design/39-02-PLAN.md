---
phase: 39-cli-telegram-integration-design
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ".planning/deliverables/40-telegram-bot-docker.md"
  - "objectives/v0.9-session-management-automation.md"
autonomous: true

must_haves:
  truths:
    - "Telegram `/newsession` 명령어의 chatId Tier 1 인증 -> 에이전트 목록 조회 -> 인라인 키보드 선택 -> 세션 생성 -> 토큰 파일 저장 -> 완료 메시지 플로우가 40-telegram-bot-docker.md에 정의되어 있다"
    - "에이전트 1개일 때 인라인 키보드 생략하고 직접 세션 생성하는 분기가 정의되어 있다"
    - "기본 constraints 결정 규칙(2-level: config.toml > 하드코딩 기본값, 향후 agents.default_constraints 3-level 확장 예약)이 정의되어 있다"
    - "callback_data 포맷 `newsession:{agentId}` (47바이트 < 64바이트 제한)과 콜백 핸들러가 정의되어 있다"
  artifacts:
    - path: ".planning/deliverables/40-telegram-bot-docker.md"
      provides: "/newsession 명령어 + 콜백 핸들러 + 기본 constraints 규칙 설계"
      contains: "/newsession"
    - path: "objectives/v0.9-session-management-automation.md"
      provides: "Phase 39-02 설계 결과 반영"
      contains: "Phase 39-02"
  key_links:
    - from: "40-telegram-bot-docker.md (/newsession)"
      to: "@waiaas/core utils/token-file.ts (writeMcpToken)"
      via: "토큰 파일 저장"
      pattern: "writeMcpToken"
    - from: "40-telegram-bot-docker.md (resolveDefaultConstraints)"
      to: "config.toml [security] 섹션"
      via: "기본 constraints 우선순위"
      pattern: "resolveDefaultConstraints"
    - from: "40-telegram-bot-docker.md (callback_data)"
      to: "sessionService.create()"
      via: "콜백에서 agentId 파싱 후 세션 생성"
      pattern: "newsession:"
---

<objective>
Telegram `/newsession` 명령어의 전체 플로우(인증, 에이전트 선택, 세션 생성, 완료 메시지)와 기본 constraints 결정 규칙(CLI/Telegram 공용)을 40-telegram-bot-docker.md에 설계 섹션으로 추가한다.

Purpose: Telegram에서 원클릭 세션 재생성을 수행할 수 있도록 구현 가능한 설계를 제공하고, MCP 세션 생성 시 적용할 기본 constraints 우선순위 체계를 확정한다.
Output: 40-telegram-bot-docker.md에 /newsession 명령어 섹션 추가, 기본 constraints 규칙 정의, objectives에 Phase 39-02 결과 반영
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Phase 36 토큰 파일 유틸리티 API
@.planning/phases/36-토큰-파일-인프라-알림-이벤트/36-01-SUMMARY.md

# Research: Telegram 패턴, callback_data 크기, 기본 constraints, 에이전트 자동 선택
@.planning/phases/39-cli-telegram-integration-design/39-RESEARCH.md

# Telegram Bot 기존 구조 (8개 명령어, 2-Tier 인증, Long Polling, 인라인 키보드)
@.planning/deliverables/40-telegram-bot-docker.md

# 세션 프로토콜 (SessionConstraints 8필드)
@.planning/deliverables/30-session-token-protocol.md

# 세션 갱신 프로토콜 (config.toml 설정 우선순위)
@.planning/deliverables/53-session-renewal-protocol.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 40-telegram-bot-docker.md에 /newsession 명령어 + 기본 constraints 규칙 설계 추가</name>
  <files>.planning/deliverables/40-telegram-bot-docker.md</files>
  <action>
40-telegram-bot-docker.md에 `[v0.9] /newsession 명령어` 섹션과 `[v0.9] 기본 Constraints 결정 규칙` 섹션을 추가한다. 기존 문서의 명령어 목록/핸들러 패턴에 맞춰 다음을 포함:

**1. /newsession 명령어 등록:**
- 기존 명령어 목록 테이블(8개)에 9번째 명령어로 `/newsession` 추가
  - 설명: "MCP 세션 재생성"
  - 인증: Tier 1 (chatId)
  - 응답: 인라인 키보드 또는 완료 메시지
- TelegramBotService의 handleUpdate() dispatch에 `case '/newsession'` 추가 패턴

**2. handleNewSession(message) 핸들러 설계:**
- 동작 플로우 (5단계):
  1. Tier 1 인증: `isAuthorizedOwner(message.from.id)` 검증. 실패 시 "Unauthorized" 응답
  2. 에이전트 목록 조회: `agentService.listActive()` 호출
  3. 에이전트 분기:
     - 0개: "No active agents. Create an agent first." 메시지
     - 1개: 키보드 생략, 직접 `createNewSession(chatId, agent.id, agent.name)` 호출
     - 2개 이상: 인라인 키보드로 에이전트 선택 UI 제공
  4. 인라인 키보드 구성:
     - 각 에이전트별 버튼 1행: `{ text: agent.name ?? agent.id.slice(0,8), callback_data: "newsession:{agentId}" }`
     - callback_data 크기: "newsession:" (11) + UUID v7 (36) = 47바이트 < 64바이트 제한
     - 메시지: "*Select an agent for the new session:*" (MarkdownV2)
  5. 인라인 키보드 타임아웃: 없음 (Telegram이 관리, 사용자가 키보드를 직접 닫음)

**3. handleNewSessionCallback(callbackQuery) 콜백 핸들러 설계:**
- 기존 callbackQuery 처리 패턴(40-telegram-bot-docker.md의 `/approve`, `/reject` 콜백 참조)을 따름
- 동작 플로우 (4단계):
  1. callback_data 파싱: `"newsession:{agentId}"` -> agentId 추출
  2. Tier 1 재인증: `isAuthorizedOwner(callbackQuery.from.id)` (콜백도 인증 필수)
  3. `answerCallbackQuery(callbackQuery.id)` -- Telegram 로딩 해제
  4. `createNewSession(chatId, agentId, agentName)` 호출

**4. createNewSession(chatId, agentId, agentName) private 메서드 설계:**
- 동작 (4단계):
  1. 기본 constraints 결정: `resolveDefaultConstraints(agentId)` (아래 규칙 적용)
  2. 세션 생성: `sessionService.create({ agentId, ...constraints })` -- masterAuth implicit (데몬 내부)
  3. 토큰 파일 저장: `writeMcpToken(getMcpTokenPath(), session.token)` (Phase 36 유틸리티)
  4. 완료 메시지 전송 (MarkdownV2):
     ```
     *New Session Created*

     Agent: `{agentName}`
     Expires: `{expiresAt}`
     Token file updated: `~/.waiaas/mcp-token`

     _MCP Server will automatically load the new token._
     ```
- 에러 처리:
  - 세션 생성 실패: "Failed to create session: {error}" 메시지
  - 토큰 파일 쓰기 실패: "Session created but token file write failed: {error}" 메시지 (세션은 생성됨)

**5. 기본 Constraints 결정 규칙 (CLI + Telegram 공용):**
- 현재 v0.9: 2-level 우선순위
  - Level 1 (최우선): config.toml `[security]` 섹션 기본값
    - `default_max_renewals` (기본 30)
    - `default_renewal_reject_window` (기본 3600)
    - `session_absolute_lifetime` (기본 7776000 = 90일)
  - Level 2 (하드코딩): 코드 내 상수
    - `DEFAULT_EXPIRES_IN = 604800` (7일, MCP 전용)
    - `DEFAULT_MAX_RENEWALS = 30`
    - `DEFAULT_RENEWAL_REJECT_WINDOW = 3600` (1시간)
    - `DEFAULT_ALLOWED_OPERATIONS = undefined` (제한 없음)
    - `DEFAULT_MAX_AMOUNT_PER_TX = undefined` (제한 없음)
- 향후 v1.x: 3-level 확장 예약
  - Level 0 (최우선): `agents.default_constraints` DB 컬럼 (EXT-03 이연)
  - Level 1: config.toml
  - Level 2: 하드코딩
- `resolveDefaultConstraints(config)` 유틸리티 함수:
  - 위치: `@waiaas/core` 또는 CLI/daemon 공통 모듈
  - 입력: AppConfig 객체
  - 출력: `{ expiresIn, maxRenewals, renewalRejectWindow, maxAmountPerTx?, allowedOperations? }`
  - CLI `--expires-in` 등 명시 옵션이 있으면 해당 값이 최우선 (CLI 전용)
- 최소 보안 보장: expiresIn과 maxRenewals는 항상 값이 존재 (undefined 불가)
  - Pitfall 4 대응: constraints가 빈 객체가 되지 않도록 하드코딩 기본값이 반드시 적용

**문서 구조 참고:** 기존 40-telegram-bot-docker.md의 명령어 섹션 구조/포맷/스타일을 준수한다. 문서 헤더에 `v0.9 /newsession + 기본 Constraints: 2026-02-09` 추가. 요구사항 매핑에 TGSN-01, TGSN-02 추가.
  </action>
  <verify>
grep으로 40-telegram-bot-docker.md에 다음이 포함되는지 확인:
- "/newsession" 문자열 존재
- "newsession:" (callback_data 접두사) 존재
- "resolveDefaultConstraints" 함수 참조 존재
- "writeMcpToken" 참조 존재
- "Tier 1" 인증 참조 존재
- "TGSN-01" 및 "TGSN-02" 요구사항 ID 존재
- "EXT-03" (향후 3-level 확장) 참조 존재
- "604800" (기본 expiresIn) 존재
  </verify>
  <done>
40-telegram-bot-docker.md에 /newsession 명령어(핸들러, 콜백, createNewSession), 기본 constraints 결정 규칙(2-level + 3-level 확장 예약)이 구현 가능한 수준으로 정의되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: v0.9 objectives에 Phase 39-02 설계 결과 반영</name>
  <files>objectives/v0.9-session-management-automation.md</files>
  <action>
objectives/v0.9-session-management-automation.md에 Phase 39-02 설계 완료를 반영한다:

1. Telegram /newsession 관련 섹션에 `[설계 확정 -- Phase 39-02]` 태그 추가
2. 기본 constraints 관련 섹션에 `[설계 확정 -- Phase 39-02]` 태그 추가
3. 영향받는 설계 문서 테이블의 Telegram/Constraints 행에 `[설계 완료: Phase 39-02]` 표시
4. "Phase 39-02 설계 결과" 섹션 신설:
   - 핵심 설계 결정 목록:
     - TG-01: /newsession 9번째 명령어 등록 (Tier 1 인증)
     - TG-02: 에이전트 인라인 키보드 (1개 자동, 2개+ 선택, callback_data 47바이트)
     - TG-03: createNewSession private 메서드 (세션 생성 + 파일 저장 + 완료 메시지)
     - TG-04: 기본 constraints 2-level (config.toml > 하드코딩), EXT-03 3-level 확장 예약
     - TG-05: resolveDefaultConstraints 공용 함수 (CLI + Telegram 공유)
     - TG-06: 최소 보안 보장 (expiresIn/maxRenewals 항상 값 존재, Pitfall 4 대응)
   - 설계 문서 위치: 40-telegram-bot-docker.md 해당 섹션 참조
5. 문서 푸터에 Phase 39-02 업데이트 이력 추가

**주의:** Plan 39-01(Task 2)과 동일 파일을 수정하므로, 39-01이 이미 추가한 내용과 충돌하지 않도록 별도 섹션(Phase 39-02 설계 결과)으로 추가한다. 39-01이 먼저 실행된 경우 해당 내용을 확인하고 이어서 추가. 39-02가 먼저 실행된 경우 자체 섹션만 추가.
  </action>
  <verify>
objectives/v0.9-session-management-automation.md에 "Phase 39-02" 문자열 존재, "TG-01" ~ "TG-06" 결정 ID 존재 확인
  </verify>
  <done>
v0.9 objectives 문서에 Phase 39-02의 Telegram /newsession + 기본 constraints 설계 결과(6건 설계 결정)가 반영되어, 전체 v0.9 진행 상황이 추적 가능하다.
  </done>
</task>

</tasks>

<verification>
1. 40-telegram-bot-docker.md에 /newsession 명령어 섹션이 존재하고, 인증/에이전트선택/세션생성/완료메시지 플로우가 단계별로 정의되어 있다
2. 인라인 키보드 callback_data 포맷이 "newsession:{agentId}" (47바이트)로 정의되어 있다
3. 기본 constraints 결정 규칙이 2-level(config.toml > 하드코딩)로 정의되고, EXT-03 3-level 확장이 예약되어 있다
4. resolveDefaultConstraints 함수의 입출력이 정의되어 있다
5. Phase 36 유틸리티(writeMcpToken, getMcpTokenPath) 참조가 포함되어 있다
6. TGSN-01, TGSN-02 요구사항이 매핑되어 있다
</verification>

<success_criteria>
- `/newsession` 명령어 플로우(Tier 1 인증, 에이전트 키보드, 세션 생성, 파일 저장, 완료 메시지)가 단계별로 정의되어 있다
- 콜백 핸들러(callback_data 파싱, 재인증, 세션 생성)가 정의되어 있다
- 기본 constraints 결정 규칙(2-level + 3-level 확장 예약)이 resolveDefaultConstraints 함수 시그니처와 함께 정의되어 있다
- objectives 문서에 Phase 39-02 결과(6건 설계 결정)가 반영되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/39-cli-telegram-integration-design/39-02-SUMMARY.md`
</output>
