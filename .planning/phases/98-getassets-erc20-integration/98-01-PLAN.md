---
phase: 98-getassets-erc20-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/wallet.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/token-registry.test.ts
autonomous: true

must_haves:
  truths:
    - "EVM wallet GET /v1/wallet/assets returns native ETH plus ERC-20 token balances from registry + ALLOWED_TOKENS union"
    - "EVM wallet with no registry tokens and no ALLOWED_TOKENS policy returns only native ETH without errors"
    - "Solana wallet getAssets() behavior is unchanged (no regression)"
  artifacts:
    - path: "packages/daemon/src/api/routes/wallet.ts"
      provides: "ERC-20 token list wiring before getAssets() call"
      contains: "setAllowedTokens"
    - path: "packages/daemon/src/api/server.ts"
      provides: "TokenRegistryService injected into walletRoutes deps"
      contains: "tokenRegistryService"
    - path: "packages/daemon/src/__tests__/token-registry.test.ts"
      provides: "Integration tests for getAssets ERC-20 wiring"
      contains: "getAssets"
  key_links:
    - from: "packages/daemon/src/api/routes/wallet.ts"
      to: "packages/daemon/src/infrastructure/token-registry/token-registry-service.ts"
      via: "getAdapterTokenList(network)"
      pattern: "getAdapterTokenList"
    - from: "packages/daemon/src/api/routes/wallet.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "ALLOWED_TOKENS policy query from policies table"
      pattern: "ALLOWED_TOKENS"
    - from: "packages/daemon/src/api/routes/wallet.ts"
      to: "packages/adapters/evm/src/adapter.ts"
      via: "setAllowedTokens() call before getAssets()"
      pattern: "setAllowedTokens"
---

<objective>
Wire EVM getAssets() to query ERC-20 token balances from token registry + ALLOWED_TOKENS policy union.

Purpose: BUG-014 fix -- EVM wallets currently only return native ETH from getAssets() because nobody calls setAllowedTokens() on the EvmAdapter before calling getAssets(). This plan wires TokenRegistryService + ALLOWED_TOKENS policy tokens into the adapter before the getAssets() call in the wallet route handler.

Output: Modified wallet route with ERC-20 wiring, updated server.ts with TokenRegistryService injection, integration tests proving the wiring works.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/97-evm-token-registry/97-01-SUMMARY.md
@.planning/phases/97-evm-token-registry/97-02-SUMMARY.md

Key files to read before implementing:
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/infrastructure/token-registry/token-registry-service.ts
@packages/daemon/src/infrastructure/token-registry/builtin-tokens.ts
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/adapters/evm/src/adapter.ts
@packages/daemon/src/__tests__/token-registry.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire token registry + ALLOWED_TOKENS into wallet route getAssets</name>
  <files>
    packages/daemon/src/api/routes/wallet.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
**1. Update WalletRouteDeps in wallet.ts:**

Add `tokenRegistryService` (optional, type `TokenRegistryService | null`) to the `WalletRouteDeps` interface. Import `TokenRegistryService` from `../../infrastructure/token-registry/index.js`. Also import `policies` from the schema and `eq`, `and` from drizzle-orm (already imported: `eq`).

**2. Modify GET /wallet/assets handler in wallet.ts:**

After resolving the adapter (line ~192) and BEFORE calling `adapter.getAssets()`, add EVM token wiring:

```typescript
// Wire ERC-20 tokens for EVM adapters before getAssets
if (wallet.chain === 'ethereum' && 'setAllowedTokens' in adapter) {
  const tokenList: Array<{ address: string; symbol?: string; name?: string; decimals?: number }> = [];
  const seenAddresses = new Set<string>();

  // Source 1: Token registry (builtin + custom for this network)
  if (deps.tokenRegistryService) {
    const registryTokens = await deps.tokenRegistryService.getAdapterTokenList(wallet.network);
    for (const t of registryTokens) {
      const lower = t.address.toLowerCase();
      if (!seenAddresses.has(lower)) {
        seenAddresses.add(lower);
        tokenList.push(t);
      }
    }
  }

  // Source 2: ALLOWED_TOKENS policy for this wallet
  const allowedTokensPolicies = await deps.db.select().from(policies)
    .where(
      and(
        eq(policies.walletId, wallet.id),
        eq(policies.type, 'ALLOWED_TOKENS'),
        eq(policies.enabled, true),
      )
    );
  if (allowedTokensPolicies.length > 0) {
    const rules = JSON.parse(allowedTokensPolicies[0]!.rules) as { tokens: Array<{ address: string }> };
    for (const t of rules.tokens) {
      const lower = t.address.toLowerCase();
      if (!seenAddresses.has(lower)) {
        seenAddresses.add(lower);
        tokenList.push({ address: t.address });
      }
    }
  }

  // Set merged token list on adapter
  (adapter as unknown as { setAllowedTokens: (t: typeof tokenList) => void }).setAllowedTokens(tokenList);
}
```

Key implementation notes:
- Use `'setAllowedTokens' in adapter` type guard to only apply to EVM adapters (avoids importing EvmAdapter directly into daemon).
- Merge with case-insensitive address dedup (Set of lowercase addresses). Registry tokens come first (they have symbol/name/decimals); ALLOWED_TOKENS policy tokens add any not already in registry (they may only have address).
- Import `policies` table from `../../infrastructure/database/schema.js` (add to existing import).
- Import `and` from `drizzle-orm` (add to existing import that already has `eq`).

**3. Update server.ts to pass tokenRegistryService to walletRoutes:**

In the `walletRoutes()` call (line ~228), add `tokenRegistryService`. The TokenRegistryService is already instantiated at line 305 for token registry routes, but it's inside a separate `if (deps.db)` block. Restructure to share the instance:

Create the TokenRegistryService once before both usages:
```typescript
const tokenRegistryService = deps.db ? new TokenRegistryService(deps.db) : null;
```

Then use it in both walletRoutes deps and tokenRegistryRoutes deps. Update the walletRoutes call to include `tokenRegistryService`.

Do NOT change the tokenRegistryRoutes block -- just pass the shared instance instead of creating a new one.
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/daemon/tsconfig.json` to verify no type errors. Grep for `setAllowedTokens` in wallet.ts to confirm wiring exists. Verify server.ts passes tokenRegistryService to walletRoutes.
  </verify>
  <done>
    wallet.ts GET /wallet/assets handler calls setAllowedTokens with merged registry + ALLOWED_TOKENS tokens before getAssets for EVM wallets. server.ts injects TokenRegistryService into walletRoutes deps. Solana path is unaffected (no setAllowedTokens on SolanaAdapter).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for getAssets ERC-20 wiring</name>
  <files>
    packages/daemon/src/__tests__/token-registry.test.ts
  </files>
  <action>
Add a new `describe('getAssets ERC-20 wiring')` block to the existing token-registry.test.ts file. This test group validates BUG-014 fix at the API integration level.

The tests need a Hono app with:
- Full createApp deps (db, masterPasswordHash, jwtSecretManager, config)
- A mock AdapterPool that returns a mock EvmAdapter with a `setAllowedTokens` spy and `getAssets` that reads from the set tokens
- TokenRegistryService wired via server.ts

**Test setup pattern (from evm-lifecycle-e2e.test.ts):**
- Create in-memory SQLite DB with pushSchema
- Create JwtSecretManager
- Hash master password with argon2
- Use minimal DaemonConfigSchema.parse
- Mock AdapterPool that returns a mock EVM adapter

**Mock EVM adapter for these tests:**
```typescript
let capturedTokens: Array<{ address: string; symbol?: string; name?: string; decimals?: number }> = [];
const mockEvmAdapter = {
  chain: 'ethereum',
  network: 'ethereum-sepolia',
  connect: async () => {},
  disconnect: async () => {},
  isConnected: () => true,
  getHealth: async () => ({ healthy: true, latencyMs: 1 }),
  getBalance: async (addr: string) => ({ address: addr, balance: 1000000000000000000n, decimals: 18, symbol: 'ETH' }),
  setAllowedTokens: (tokens: typeof capturedTokens) => { capturedTokens = tokens; },
  getAssets: async (addr: string) => {
    // Return native + any tokens that were set
    const assets = [{ mint: 'native', symbol: 'ETH', name: 'Ether', balance: 1000000000000000000n, decimals: 18, isNative: true }];
    for (const t of capturedTokens) {
      assets.push({ mint: t.address, symbol: t.symbol ?? '', name: t.name ?? '', balance: 500000n, decimals: t.decimals ?? 18, isNative: false });
    }
    return assets;
  },
  // ... stub remaining IChainAdapter methods
};
```

**Tests to write (4 tests):**

1. **"EVM getAssets returns registry tokens when token registry has entries"**
   - Insert builtin/custom tokens into token_registry table for `ethereum-sepolia`
   - Create EVM wallet, create session, call GET /v1/wallet/assets
   - Assert response contains native ETH + registry tokens
   - Assert capturedTokens includes registry token addresses

2. **"EVM getAssets returns ALLOWED_TOKENS policy tokens"**
   - Create EVM wallet with ALLOWED_TOKENS policy containing a token address
   - Create session, call GET /v1/wallet/assets
   - Assert capturedTokens includes the policy token address

3. **"EVM getAssets deduplicates registry and policy tokens by address"**
   - Add same token address to both registry and ALLOWED_TOKENS policy
   - Call GET /v1/wallet/assets
   - Assert capturedTokens has no duplicate addresses (case-insensitive)

4. **"EVM getAssets returns only native ETH when no registry or policy tokens"**
   - Create EVM wallet with no tokens in registry and no ALLOWED_TOKENS policy
   - Call GET /v1/wallet/assets
   - Assert response has exactly 1 asset (native ETH)
   - Assert capturedTokens is empty

**Common test flow for each:**
1. Create wallet via POST /v1/wallets with chain=ethereum, network=ethereum-sepolia
2. Create session via POST /v1/sessions for the wallet
3. Call GET /v1/wallet/assets with Authorization: Bearer <session_token>
4. Assert response status 200 and check assets array

Use the same mock KeyStore pattern from evm-lifecycle-e2e.test.ts:
```typescript
const keyStore = {
  generateKeyPair: async () => ({ publicKey: EVM_TEST_ADDRESS }),
  getPrivateKey: async () => new Uint8Array(32),
};
```

Insert registry tokens directly via `db.insert(tokenRegistry).values(...)`.
Insert policies directly via `db.insert(policies).values(...)` with `type: 'ALLOWED_TOKENS'` and `rules: JSON.stringify({ tokens: [...] })`.
  </action>
  <verify>
    Run `npx vitest run packages/daemon/src/__tests__/token-registry.test.ts` -- all tests including the new 4 tests should pass. Run the full daemon test suite: `npx vitest run packages/daemon/src/__tests__/ --reporter=verbose 2>&1 | tail -20` to check for regressions.
  </verify>
  <done>
    4 new integration tests pass verifying: (1) registry tokens wired to getAssets, (2) ALLOWED_TOKENS policy tokens wired, (3) deduplication works, (4) empty state returns native-only. No regressions in existing tests.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/daemon/tsconfig.json` passes with no errors
2. `npx vitest run packages/daemon/src/__tests__/token-registry.test.ts` -- all tests pass including 4 new getAssets wiring tests
3. `npx vitest run packages/daemon/src/__tests__/` -- no regressions in existing daemon tests
4. grep confirms `setAllowedTokens` is called in wallet.ts before `getAssets`
5. grep confirms `tokenRegistryService` is passed from server.ts to walletRoutes deps
</verification>

<success_criteria>
- EVM wallet GET /v1/wallet/assets returns ERC-20 token balances from token registry + ALLOWED_TOKENS union
- Empty registry + no policy = native ETH only, no errors
- Solana wallet behavior unchanged
- 4 new integration tests pass
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/98-getassets-erc20-integration/98-01-SUMMARY.md`
</output>
