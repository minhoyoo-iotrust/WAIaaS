---
phase: 108-api-interface-dx-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/72-api-interface-dx-design.md
autonomous: true

must_haves:
  truths:
    - "POST /v1/transactions/send의 5-type 요청 스키마 + legacy 스키마에 network optional 파라미터가 Zod 수준으로 정의되어 있다"
    - "POST /v1/wallets의 environment optional 파라미터 + network 의미 변경(default_network 설정용)이 하위호환 4가지 조합으로 정의되어 있다"
    - "GET /v1/wallet/balance + GET /v1/wallet/assets의 ?network= 쿼리 파라미터 확장과 GET /v1/wallets/:id/assets 멀티네트워크 집계 신설이 설계되어 있다"
    - "GET /v1/wallets, GET /v1/wallets/:id 응답의 environment + defaultNetwork 필드 추가가 기존 필드 유지와 함께 설계되어 있다"
    - "REST API 하위호환 전략(network 미지정 = resolveNetwork fallback, environment 미지정 = deriveEnvironment 역추론, 응답 필드 추가 only)이 명시되어 있다"
  artifacts:
    - path: "docs/72-api-interface-dx-design.md"
      provides: "REST API network 파라미터 + 월렛 생성 + 잔액 조회 + 하위호환 전략 설계 (섹션 1~5)"
      contains: "POST /v1/transactions/send"
  key_links:
    - from: "docs/72 (REST API 스키마)"
      to: "docs/68 (EnvironmentType, deriveEnvironment)"
      via: "environment 파라미터 역추론 로직 참조"
      pattern: "deriveEnvironment"
    - from: "docs/72 (Route Handler 의사코드)"
      to: "docs/70 (resolveNetwork 순수 함수)"
      via: "network resolve 호출"
      pattern: "resolveNetwork"
    - from: "docs/72 (멀티네트워크 잔액)"
      to: "docs/68 (getNetworksForEnvironment)"
      via: "환경 내 네트워크 목록 조회"
      pattern: "getNetworksForEnvironment"
---

<objective>
REST API 7개 엔드포인트의 network/environment 파라미터 추가와 Zod 스키마 변경, 멀티네트워크 잔액 집계 엔드포인트 신설, 하위호환 전략을 설계한다.

Purpose: Phase 105-107 설계를 REST API 인터페이스에 노출하여 구현자가 Zod 스키마 -> OpenAPI -> Route Handler 변경을 일관되게 수행할 수 있도록 한다.
Output: docs/72-api-interface-dx-design.md 섹션 1~5 (REST API 설계)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 105-107 설계 문서 (필수 참조)
@docs/68-environment-model-design.md
@docs/70-pipeline-network-resolve-design.md
@docs/71-policy-engine-network-extension-design.md

# 리서치 결과 (인터페이스 전수 목록 + 의사코드)
@.planning/phases/108-api-interface-dx-design/108-RESEARCH.md

# 현재 Zod 스키마 + Route 코드 (변경 전 기준)
@packages/core/src/schemas/wallet.schema.ts
@packages/core/src/schemas/transaction.schema.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/wallets.ts
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: REST API 트랜잭션 + 월렛 스키마 변경 설계 (docs/72 섹션 1~3)</name>
  <files>docs/72-api-interface-dx-design.md</files>
  <action>
docs/72-api-interface-dx-design.md 파일을 생성하고 섹션 1~3을 작성한다.

**섹션 1: 트랜잭션 요청 스키마 network 파라미터 (API-01)**

- 5-type 스키마(TransferRequestSchema, TokenTransferRequestSchema, ContractCallRequestSchema, ApproveRequestSchema, BatchRequestSchema) 각각에 `network: NetworkTypeEnum.optional()` 필드 추가를 Zod 코드 수준으로 정의
- Legacy SendTransactionRequestSchema에도 동일 패턴 적용
- BatchRequestSchema는 최상위에 network 하나 (instructions 내부가 아님)
- Route Handler(transactions.ts) POST /v1/transactions/send에서 resolveNetwork() 호출 의사코드: request.network -> wallet.defaultNetwork -> getDefaultNetwork() 3단계 fallback
- OpenAPI 스키마(openapi-schemas.ts) 변경 사항: 5-type 각각의 request body에 network 필드 추가
- 트랜잭션 응답 스키마에 network 필드 포함 (실행된 네트워크 반환)

**섹션 2: 월렛 생성 API environment 파라미터 (API-03)**

- CreateWalletRequestSchema에 `environment: EnvironmentTypeEnum.optional()` 추가
- 기존 `network` 필드 의미 변경: network -> default_network 초기값 설정용
- Route Handler(wallets.ts) POST /v1/wallets에서 4가지 조합 처리 의사코드:
  - env 미지정 + network 지정: deriveEnvironment(network) -> env 역추론
  - env 미지정 + network 미지정: chain 기본 환경(testnet) + getDefaultNetwork()
  - env 지정 + network 미지정: getDefaultNetwork(chain, env)
  - env 지정 + network 지정: validateNetworkEnvironment() 교차 검증
- WalletResponseSchema 변경: network -> environment + defaultNetwork 필드 추가
- GET /v1/wallets, GET /v1/wallets/:id 응답 변경: 기존 network 유지 + environment, defaultNetwork 추가

**섹션 3: 잔액/자산 조회 멀티네트워크 확장 (API-01 + API-02)**

- GET /v1/wallet/balance: ?network=X 쿼리 파라미터 추가 (sessionAuth). 미지정 시 wallet.defaultNetwork 사용
- GET /v1/wallet/assets: ?network=X 쿼리 파라미터 추가 (sessionAuth). 미지정 시 wallet.defaultNetwork 사용
- GET /v1/wallets/:id/assets: 멀티네트워크 잔액 집계 엔드포인트 신설 (masterAuth)
  - getNetworksForEnvironment(chain, env)로 환경 내 전체 네트워크 목록 조회
  - Promise.allSettled 병렬 조회 의사코드
  - 응답 스키마: { walletId, chain, environment, networks: [{ network, status: "ok"|"error", assets?, error? }] }
  - Zod 응답 스키마 정의
  </action>
  <verify>
docs/72-api-interface-dx-design.md 파일이 존재하고 섹션 1~3이 포함되어 있으며, 각 섹션에 Zod 스키마 변경, Route Handler 의사코드, OpenAPI 변경이 코드 수준으로 기술되어 있다.
  </verify>
  <done>
- 5-type + legacy 스키마의 network 파라미터 추가가 Zod 코드로 정의됨
- CreateWalletRequestSchema의 environment 파라미터 + 4가지 조합 처리 로직이 의사코드로 존재
- 멀티네트워크 잔액 집계 엔드포인트의 요청/응답 스키마와 Promise.allSettled 의사코드가 존재
  </done>
</task>

<task type="auto">
  <name>Task 2: REST API 하위호환 전략 + OpenAPI 변경 요약 + 설계 결정 (docs/72 섹션 4~5)</name>
  <files>docs/72-api-interface-dx-design.md</files>
  <action>
docs/72-api-interface-dx-design.md에 섹션 4~5를 추가한다.

**섹션 4: REST API 하위호환 전략 (API-05)**

- 3-Layer 하위호환 원칙 명시:
  1. network 미지정 = 기존 동작 유지 (resolveNetwork fallback)
  2. environment 미지정 = 자동 추론 (deriveEnvironment 또는 chain 기본값)
  3. 응답 필드 추가 only (기존 필드 제거 안 함)
- 엔드포인트별 하위호환 매트릭스 (7개 엔드포인트 x 3가지 원칙)
- 기존 API 호출 예시가 변경 없이 동작하는 증명:
  - `{ name: "sol", chain: "solana", network: "devnet" }` -> environment=testnet 역추론, defaultNetwork=devnet 설정
  - `POST /v1/transactions/send { type: "TRANSFER", to, amount }` -> resolveNetwork가 wallet.defaultNetwork 사용
  - `GET /v1/wallet/assets` (파라미터 없음) -> wallet.defaultNetwork 기반 조회

**섹션 5: OpenAPI 스키마 변경 요약 + REST API 설계 결정 (API-D01~D0N)**

- openapi-schemas.ts 변경 사항 전수 목록 (8개 Zod 스키마 변경이 OpenAPI에 미치는 영향)
- REST API 설계 결정 정리:
  - API-D01: environment optional + deriveEnvironment fallback (breaking change 방지)
  - API-D02: 멀티네트워크 잔액을 별도 엔드포인트로 분리 (기존 sessionAuth 엔드포인트 보호)
  - API-D03: 트랜잭션 응답에 network 필드 추가 (실행 네트워크 추적)
  - API-D04: GET 엔드포인트는 query parameter, POST 엔드포인트는 body로 network 전달
  - API-D05: WalletResponse에 기존 network 필드 유지 + environment, defaultNetwork 추가 (호환)
- Phase 108-02 이행 포인트: MCP/SDK에서 이 REST API 설계를 참조해야 하는 인터페이스 목록
  </action>
  <verify>
docs/72의 섹션 4에 하위호환 매트릭스와 기존 호출 동작 증명이 있고, 섹션 5에 OpenAPI 변경 요약 + 설계 결정 + Phase 108-02 이행 포인트가 있다.
  </verify>
  <done>
- 7개 엔드포인트 x 3가지 하위호환 원칙 매트릭스가 존재
- 기존 API 호출 3개가 변경 없이 동작하는 증명이 존재
- OpenAPI 변경 전수 목록 + 설계 결정 5개 이상 + 108-02 이행 포인트가 존재
  </done>
</task>

</tasks>

<verification>
1. docs/72-api-interface-dx-design.md가 존재하고 섹션 1~5를 포함한다
2. 섹션 1에 5-type + legacy 스키마의 network 파라미터가 Zod 코드로 정의되어 있다
3. 섹션 2에 CreateWalletRequestSchema의 environment + 4가지 조합 로직이 있다
4. 섹션 3에 멀티네트워크 잔액 집계 엔드포인트 스키마 + Promise.allSettled 의사코드가 있다
5. 섹션 4에 하위호환 매트릭스 + 기존 호출 동작 증명이 있다
6. 섹션 5에 설계 결정 + 108-02 이행 포인트가 있다
</verification>

<success_criteria>
- REST API 7개 엔드포인트의 요청/응답 스키마 변경이 Zod 코드 수준으로 정의됨
- 멀티네트워크 잔액 집계 엔드포인트(GET /v1/wallets/:id/assets)의 전체 설계가 완료됨
- 하위호환 전략이 엔드포인트별 매트릭스로 체계화됨
- Phase 108-02(MCP/SDK/Quickstart)에서 참조할 REST API 인터페이스가 확정됨
</success_criteria>

<output>
After completion, create `.planning/phases/108-api-interface-dx-design/108-01-SUMMARY.md`
</output>
