---
phase: 83-keystore-multicurve
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/ILocalKeyStore.ts
  - packages/daemon/package.json
  - packages/daemon/src/infrastructure/keystore/keystore.ts
  - packages/daemon/src/__tests__/keystore.test.ts
autonomous: true

must_haves:
  truths:
    - "chain='ethereum' 에이전트 키 생성 시 0x EIP-55 체크섬 주소가 반환된다"
    - "secp256k1 비밀키가 AES-256-GCM으로 암호화되고 평문이 즉시 제로화된다"
    - "키스토어 파일에 curve:'secp256k1' 필드가 기록된다"
    - "키스토어 파일에 실제 network 값이 기록된다 (하드코딩 'devnet' 제거)"
    - "기존 Solana 키 생성 경로가 무변경으로 동작한다"
    - "curve 필드 없는 기존 키스토어 파일이 ed25519로 정상 로드된다"
    - "ILocalKeyStore.generateKeyPair 시그니처가 (agentId, chain, network, masterPassword) 4-param 형태다"
  artifacts:
    - path: "packages/core/src/interfaces/ILocalKeyStore.ts"
      provides: "generateKeyPair with 4 parameters (agentId, chain, network, masterPassword)"
      contains: "generateKeyPair.*agentId.*chain.*network.*masterPassword"
    - path: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      provides: "secp256k1 key gen + EIP-55 address + curve field + network field"
      contains: "secp256k1"
    - path: "packages/daemon/src/__tests__/keystore.test.ts"
      provides: "TDD tests for secp256k1/EVM keystore"
      contains: "secp256k1"
    - path: "packages/daemon/package.json"
      provides: "viem dependency for EIP-55 address derivation"
      contains: "viem"
  key_links:
    - from: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      to: "viem/accounts"
      via: "privateKeyToAccount for EIP-55 address derivation"
      pattern: "privateKeyToAccount"
    - from: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      to: "packages/core/src/interfaces/ILocalKeyStore.ts"
      via: "implements ILocalKeyStore with 4-param generateKeyPair"
      pattern: "generateKeyPair.*agentId.*chain.*network.*masterPassword"
---

<objective>
secp256k1 키 생성 + EIP-55 주소 파생 + curve/network 필드 확장을 TDD로 구현하고, 기존 Solana Ed25519 경로의 무변경 동작을 검증한다.

Purpose: EVM 에이전트 생성의 핵심 암호 계층. secp256k1 키가 생성되지 않으면 EVM 에이전트 자체가 불가능하다.
Output: LocalKeyStore가 chain='ethereum' 시 secp256k1 키 생성 + 0x EIP-55 주소 반환, curve/network 필드 기록, 기존 Solana 무변경 동작.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/82-config-networktype-evm-deps/82-03-SUMMARY.md

# Implementation targets
@packages/core/src/interfaces/ILocalKeyStore.ts
@packages/daemon/src/infrastructure/keystore/keystore.ts
@packages/daemon/src/__tests__/keystore.test.ts
@packages/daemon/src/infrastructure/keystore/crypto.ts
@packages/daemon/src/infrastructure/keystore/memory.ts
@packages/daemon/package.json

# Reference: objective document keystore section
@objectives/v1.4.1-evm-wallet-infrastructure.md (search for "Keystore 멀티커브", "secp256k1", "privateKeyToAccount", "KeystoreFileV1 확장")
</context>

<feature>
  <name>secp256k1 Keystore Multicurve</name>
  <files>
    packages/core/src/interfaces/ILocalKeyStore.ts
    packages/daemon/package.json
    packages/daemon/src/infrastructure/keystore/keystore.ts
    packages/daemon/src/__tests__/keystore.test.ts
  </files>
  <behavior>
    TDD cases (RED tests first, then GREEN implementation):

    **1. EVM key generation produces 0x EIP-55 address**
    - Input: generateKeyPair('agent-evm', 'ethereum', 'ethereum-sepolia', password)
    - Output: { publicKey: /^0x[0-9a-fA-F]{40}$/, encryptedPrivateKey: Uint8Array }
    - publicKey must pass viem getAddress() === publicKey (EIP-55 checksum)

    **2. EVM keystore file has curve:'secp256k1'**
    - After EVM key gen, read JSON file
    - parsed.curve === 'secp256k1'

    **3. Keystore file records actual network value**
    - After generateKeyPair('agent', 'ethereum', 'ethereum-sepolia', pw)
    - parsed.network === 'ethereum-sepolia' (not 'devnet')
    - After generateKeyPair('agent2', 'solana', 'devnet', pw)
    - parsed.network === 'devnet'

    **4. EVM private key is 32 bytes, encrypted with AES-256-GCM**
    - Decrypt EVM keystore -> 32 bytes (secp256k1 private key)
    - Re-derive address from decrypted key matches original publicKey

    **5. secp256k1 plaintext zeroed after generation**
    - Verified by the existing zeroing pattern (sodium.sodium_memzero)

    **6. Solana key generation unchanged**
    - generateKeyPair('agent-sol', 'solana', 'devnet', password)
    - Still returns base58 public key, 64-byte secret, curve:'ed25519'

    **7. Backward compat: curve-less keystore reads as ed25519**
    - Manually create a keystore file WITHOUT curve field
    - readKeystoreFile() should return curve defaulting to 'ed25519'
  </behavior>
  <implementation>
    See Task 2 action for full implementation details.

    **IMPORTANT decisions (locked from objective doc):**
    - Use viem `privateKeyToAccount` for address derivation (decision #1, #2). Do NOT use Node.js crypto for address derivation.
    - Use `crypto.randomBytes(32)` for private key entropy (CSPRNG)
    - `curve` field backward compatible: missing = 'ed25519' (decision #7)
    - `network` parameter replaces hardcoded 'devnet' (decision #15)
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Install viem dependency and write RED failing tests</name>
  <files>
    packages/daemon/package.json
    packages/daemon/src/__tests__/keystore.test.ts
  </files>
  <action>
    **Step 1: Install viem dependency in daemon package**
    ```bash
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm add viem --filter @waiaas/daemon
    ```
    Verify viem appears in packages/daemon/package.json dependencies.

    **Step 2: Write 7 RED failing tests in keystore.test.ts**

    Add a new describe block `describe('secp256k1 / EVM multicurve')` to the existing test file with these test cases:

    1. **EVM key generation produces 0x EIP-55 address:**
       - Call generateKeyPair('agent-evm', 'ethereum', 'ethereum-sepolia', password) with 4 params
       - Assert publicKey matches /^0x[0-9a-fA-F]{40}$/
       - Assert viem getAddress(publicKey) === publicKey (EIP-55 checksum valid)

    2. **EVM keystore file has curve:'secp256k1':**
       - After EVM key gen, read the keystore JSON file from disk
       - Assert parsed.curve === 'secp256k1'

    3. **Keystore file records actual network value:**
       - After generateKeyPair('agent-net', 'ethereum', 'ethereum-sepolia', pw)
       - Assert parsed.network === 'ethereum-sepolia'
       - After generateKeyPair('agent-sol', 'solana', 'devnet', pw)
       - Assert parsed.network === 'devnet'

    4. **EVM private key round-trip (32 bytes, AES-256-GCM encrypted):**
       - Generate EVM key, decrypt keystore, verify decrypted key is 32 bytes
       - Re-derive address from decrypted key using privateKeyToAccount, assert matches original publicKey

    5. **secp256k1 plaintext zeroed after generation:**
       - Verify via sodium.sodium_memzero call pattern (spy or existing coverage)

    6. **Solana key generation unchanged (4-param call):**
       - generateKeyPair('agent-sol', 'solana', 'devnet', password) with 4 params
       - Assert returns base58 public key (not 0x), 64-byte encrypted key
       - Assert curve:'ed25519' in keystore file

    7. **Backward compat: curve-less keystore reads as ed25519:**
       - Create a keystore file manually without curve field
       - Read it, assert curve defaults to 'ed25519'

    **All tests MUST call generateKeyPair with 4 parameters (agentId, chain, network, masterPassword).** This proves the interface contract.

    Tests should FAIL (RED) at this point because:
    - generateKeyPair currently takes 3 params (no network)
    - No secp256k1/ethereum branch exists yet

    Commit: `test(83-01): add failing tests for secp256k1 keystore multicurve`
  </action>
  <verify>
    ```bash
    # Run tests - they should FAIL (RED phase)
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run --reporter=verbose src/__tests__/keystore.test.ts 2>&1 | tail -20
    # Confirm failures exist (non-zero exit code expected)
    ```
  </verify>
  <done>
    1. viem is in packages/daemon/package.json dependencies
    2. 7 new test cases exist in keystore.test.ts calling generateKeyPair with 4 params
    3. Tests FAIL because generateKeyPair doesn't accept network param yet and no ethereum branch exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement multicurve keystore to pass all tests (GREEN)</name>
  <files>
    packages/core/src/interfaces/ILocalKeyStore.ts
    packages/daemon/src/infrastructure/keystore/keystore.ts
  </files>
  <action>
    **Step 1: Update ILocalKeyStore interface (core)**
    - Change generateKeyPair signature to 4 parameters:
      ```typescript
      generateKeyPair(
        agentId: string,
        chain: ChainType,
        network: string,
        masterPassword: string,
      ): Promise<{ publicKey: string; encryptedPrivateKey: Uint8Array }>;
      ```
    - This is the critical interface contract that Plan 02 depends on.

    **Step 2: Extend KeystoreFileV1 type**
    - Add optional `curve?: 'ed25519' | 'secp256k1'` field to KeystoreFileV1 interface
    - Backward compat: existing files without curve are treated as 'ed25519'

    **Step 3: Implement secp256k1 branch in LocalKeyStore.generateKeyPair**
    - Update method signature to accept `network: string` as 3rd parameter
    - Remove the `if (chain !== 'solana') throw` guard
    - Add `if (chain === 'ethereum')` branch:
      1. Generate 32-byte random private key via `crypto.randomBytes(32)`
      2. Derive address using viem: `privateKeyToAccount('0x' + privKey.toString('hex')).address`
      3. Encrypt the 32-byte private key (existing encrypt function)
      4. Zero the plaintext private key buffer immediately (sodium.sodium_memzero)
      5. Write keystore file with curve: 'secp256k1', network: actual value from param
    - Update Solana branch: add curve: 'ed25519', use passed `network` param instead of hardcoded 'devnet'

    **Step 4: Update readKeystoreFile for backward compat**
    - After parsing JSON, if `curve` field is missing, set `parsed.curve = 'ed25519'`

    **Step 5: Update any other callers of generateKeyPair in daemon**
    - Search for all generateKeyPair calls and add the network parameter
    - This may include agent creation in routes (but Plan 02 handles that separately)
    - If there are internal callers in daemon (e.g., tests, helpers), update them too

    Commit: `feat(83-01): implement secp256k1 multicurve keystore`
  </action>
  <verify>
    ```bash
    # Run keystore tests - ALL should PASS (GREEN phase)
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run --reporter=verbose src/__tests__/keystore.test.ts

    # Verify TypeScript compilation for both core and daemon
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core run build && pnpm --filter @waiaas/daemon run typecheck
    ```
  </verify>
  <done>
    1. ILocalKeyStore.generateKeyPair signature is (agentId: string, chain: ChainType, network: string, masterPassword: string)
    2. All 7 new EVM/multicurve tests pass (GREEN)
    3. All existing Solana keystore tests pass unchanged
    4. TypeScript compiles without errors (core + daemon)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify interface contract and full regression</name>
  <files>
    packages/core/src/interfaces/ILocalKeyStore.ts
    packages/daemon/src/infrastructure/keystore/keystore.ts
  </files>
  <action>
    **Verification-only task. No new code unless refactoring is needed.**

    **Step 1: Verify ILocalKeyStore 4-param contract**
    ```bash
    # Confirm interface has 4-param generateKeyPair
    grep -n 'generateKeyPair' packages/core/src/interfaces/ILocalKeyStore.ts
    # Must show: generateKeyPair(agentId: string, chain: ChainType, network: string, masterPassword: string)
    ```

    **Step 2: Verify implementation matches interface**
    ```bash
    # Confirm LocalKeyStore implements 4-param generateKeyPair
    grep -n 'generateKeyPair' packages/daemon/src/infrastructure/keystore/keystore.ts
    # Must show method with (agentId, chain, network, masterPassword) params
    ```

    **Step 3: Verify secp256k1 / viem integration**
    ```bash
    # Confirm privateKeyToAccount import
    grep -n 'privateKeyToAccount' packages/daemon/src/infrastructure/keystore/keystore.ts
    ```

    **Step 4: Full daemon test suite regression**
    ```bash
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run
    ```

    **Step 5: If any non-keystore tests fail due to generateKeyPair signature change (e.g., mock callers), fix them by adding the network parameter.**

    If refactoring is needed, commit: `refactor(83-01): clean up multicurve keystore`
  </action>
  <verify>
    ```bash
    # Full daemon test suite
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run --reporter=verbose

    # Core build
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core run build

    # Verify 4-param interface contract explicitly
    grep -c 'network.*string' packages/core/src/interfaces/ILocalKeyStore.ts
    # Expected: at least 1 match in generateKeyPair signature
    ```
  </verify>
  <done>
    1. ILocalKeyStore.generateKeyPair confirmed as 4-param (agentId, chain, network, masterPassword)
    2. LocalKeyStore implementation matches 4-param interface
    3. All daemon tests pass (full regression, including non-keystore tests)
    4. viem privateKeyToAccount is used for EIP-55 address derivation
    5. Interface contract is verified — Plan 02 can safely depend on 4-param generateKeyPair
  </done>
</task>

</tasks>

<verification>
```bash
# Run keystore tests specifically
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run --reporter=verbose src/__tests__/keystore.test.ts

# Verify TypeScript compilation
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core run build && pnpm --filter @waiaas/daemon run typecheck

# Verify interface contract
grep 'generateKeyPair' packages/core/src/interfaces/ILocalKeyStore.ts | grep 'network'
```
</verification>

<success_criteria>
1. All existing Solana keystore tests pass unchanged
2. New EVM keystore tests pass (secp256k1 gen, EIP-55, curve field, network field, round-trip, backward compat)
3. TypeScript compiles without errors (core + daemon)
4. viem is in daemon's package.json dependencies
5. No test uses hardcoded 'devnet' network for EVM agents
6. ILocalKeyStore.generateKeyPair has 4-param signature (agentId, chain, network, masterPassword) — verified explicitly
</success_criteria>

<output>
After completion, create `.planning/phases/83-keystore-multicurve/83-01-SUMMARY.md`
</output>
