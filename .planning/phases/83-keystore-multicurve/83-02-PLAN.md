---
phase: 83-keystore-multicurve
plan: 02
type: execute
wave: 2
depends_on: ["83-01"]
files_modified:
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/__tests__/api-agents.test.ts
autonomous: true

must_haves:
  truths:
    - "POST /agents chain='ethereum' 호출 시 0x EIP-55 주소를 포함한 201 응답이 반환된다"
    - "기존 Solana 에이전트 생성 API가 무변경으로 동작한다"
    - "generateKeyPair에 network 파라미터가 올바르게 전달된다"
  artifacts:
    - path: "packages/daemon/src/api/routes/agents.ts"
      provides: "Agent route with network param passed to generateKeyPair"
      contains: "network"
    - path: "packages/daemon/src/__tests__/api-agents.test.ts"
      provides: "Integration tests for EVM agent creation via API"
      contains: "ethereum"
  key_links:
    - from: "packages/daemon/src/api/routes/agents.ts"
      to: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      via: "generateKeyPair(id, chain, network, masterPassword)"
      pattern: "generateKeyPair.*network"
---

<objective>
Agent route의 generateKeyPair 호출에 network 파라미터를 추가하고, EVM 에이전트 생성 API 통합 테스트를 작성하여 Phase 83의 End-to-End 동작을 검증한다.

Purpose: Plan 01에서 구현한 keystore multicurve를 실제 API 라우트에 연결하여, POST /agents로 EVM 에이전트를 생성할 수 있는 상태를 만든다.
Output: Agent route가 generateKeyPair(id, chain, network, masterPassword)를 호출하고, EVM agent creation이 API 레벨에서 동작하는 것을 통합 테스트로 검증.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/83-keystore-multicurve/83-01-SUMMARY.md

# Implementation targets
@packages/daemon/src/api/routes/agents.ts
@packages/daemon/src/__tests__/api-agents.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update agent route to pass network to generateKeyPair + EVM integration tests</name>
  <files>
    packages/daemon/src/api/routes/agents.ts
    packages/daemon/src/__tests__/api-agents.test.ts
  </files>
  <action>
    **1. Update agents.ts generateKeyPair call**

    In the POST /agents handler (`createAgentRoute`), change the generateKeyPair call from:
    ```typescript
    const { publicKey } = await deps.keyStore.generateKeyPair(id, chain, deps.masterPassword);
    ```
    to:
    ```typescript
    const { publicKey } = await deps.keyStore.generateKeyPair(id, chain, network, deps.masterPassword);
    ```

    The `network` variable is already resolved earlier in the handler (from parsed.network or chain-based defaults). No other changes needed in this file.

    **2. Update mock keyStore in api-agents test**

    The test file uses a mock keyStore. Update its `generateKeyPair` mock to accept the new signature:
    ```typescript
    generateKeyPair: vi.fn().mockImplementation(async (agentId: string, chain: string, network: string, _password: string) => {
      if (chain === 'ethereum') {
        return { publicKey: '0x1234567890AbCDef1234567890abcdef12345678', encryptedPrivateKey: new Uint8Array(32) };
      }
      return { publicKey: 'MockPublicKeyBase58', encryptedPrivateKey: new Uint8Array(64) };
    })
    ```

    **3. Add EVM agent creation integration tests**

    Add tests to the existing api-agents test suite:

    a. **EVM agent creation returns 0x address:**
       - POST `/v1/agents` with `{ name: 'evm-test', chain: 'ethereum', network: 'ethereum-sepolia' }`
       - Assert 201, response.publicKey starts with '0x'

    b. **EVM agent creation with default network:**
       - POST `/v1/agents` with `{ name: 'evm-default', chain: 'ethereum' }` (no network)
       - Assert 201, response.network is config's evm_default_network value

    c. **Existing Solana tests still pass:**
       - Verify the existing tests (which use chain: 'solana' or default) continue to work with the new generateKeyPair signature

    **4. Verify generateKeyPair mock receives network parameter**
    - After each test call, verify `mockKeyStore.generateKeyPair.mock.calls[N]` includes the network at the correct position (3rd arg).
  </action>
  <verify>
    ```bash
    # Run agent API tests
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run --reporter=verbose src/__tests__/api-agents.test.ts

    # Run all daemon tests to verify no regressions
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run

    # TypeScript compilation check
    cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon run typecheck
    ```
  </verify>
  <done>
    1. Agent route calls generateKeyPair with 4 args (id, chain, network, masterPassword)
    2. EVM agent creation tests pass with 0x mock address
    3. Existing Solana agent tests pass without modification
    4. All daemon tests pass (no regressions)
    5. TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
```bash
# Full test suite
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run

# Type check
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon run typecheck
```
</verification>

<success_criteria>
1. POST /agents with chain='ethereum' returns 201 with 0x-prefixed publicKey
2. generateKeyPair is called with (id, chain, network, masterPassword) in all agent creation paths
3. All existing Solana agent creation tests pass unchanged
4. All daemon tests pass (full regression check)
</success_criteria>

<output>
After completion, create `.planning/phases/83-keystore-multicurve/83-02-SUMMARY.md`
</output>
