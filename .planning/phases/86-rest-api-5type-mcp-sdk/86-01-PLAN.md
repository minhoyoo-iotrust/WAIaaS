---
phase: 86-rest-api-5type-mcp-sdk
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/__tests__/api-transactions.test.ts
autonomous: true

must_haves:
  truths:
    - "Legacy request {to, amount, memo} without type field returns 201 and is stored as type=TRANSFER in DB"
    - "Request with type=TOKEN_TRANSFER + token field returns 201 and invokes buildTokenTransfer through pipeline"
    - "Request with type=CONTRACT_CALL returns 201 and invokes buildContractCall through pipeline"
    - "Request with type=APPROVE returns 201 and invokes buildApprove through pipeline"
    - "Request with type=BATCH + instructions array returns 201 and invokes buildBatch through pipeline"
    - "Request with invalid type (e.g., 'INVALID') returns 400 VALIDATION_ERROR"
    - "GET /doc OpenAPI spec contains oneOf 6-variant for transaction send request"
    - "All 5 type-specific Zod schemas are registered as OpenAPI components"
  artifacts:
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "5-type OpenAPI components + TransactionRequestOpenAPI oneOf 6-variant"
      contains: "TransactionRequestOpenAPI"
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "Route handler using c.req.json() + stage1Validate() delegation"
      contains: "stage1Validate"
    - path: "packages/daemon/src/__tests__/api-transactions.test.ts"
      provides: "Tests for all 5 transaction types + legacy fallback + validation error"
  key_links:
    - from: "packages/daemon/src/api/routes/transactions.ts"
      to: "packages/daemon/src/pipeline/stages.ts"
      via: "stage1Validate(ctx) call"
      pattern: "stage1Validate"
    - from: "packages/daemon/src/api/routes/openapi-schemas.ts"
      to: "@waiaas/core transaction.schema.ts"
      via: "Import 5-type schemas for .openapi() registration"
      pattern: "TransferRequestSchema.*openapi"
---

<objective>
REST API POST /v1/transactions/send route schema separation (방안 C) + 5-type OpenAPI components.

Purpose: Transform the transaction send endpoint from legacy-only (to/amount/memo, hardcoded type=TRANSFER) to accept all 5 transaction types via discriminatedUnion, while maintaining backward compatibility for clients that don't send a `type` field. OpenAPI doc must accurately reflect the 6-variant schema.

Output: Working transaction endpoint supporting TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH + legacy fallback, with correct OpenAPI spec.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.4.1-evm-wallet-infrastructure.md (sections 10: REST API 5-type)
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/pipeline/stages.ts (stage1Validate already supports 5-type)
@packages/core/src/schemas/transaction.schema.ts (5-type schemas defined)
@packages/daemon/src/__tests__/api-transactions.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED -- failing tests for 5-type route + OpenAPI + legacy fallback</name>
  <files>packages/daemon/src/__tests__/api-transactions.test.ts</files>
  <action>
Add a new `describe('5-type transaction request support')` block to the existing api-transactions.test.ts file. Write the following failing tests:

1. **Legacy fallback test**: POST /v1/transactions/send with `{to: "addr", amount: "1000"}` (no type field) -> 201, DB transaction has type='TRANSFER'. This should already pass with current code but is needed as a regression guard.

2. **TRANSFER type explicit**: POST with `{type: "TRANSFER", to: "addr", amount: "1000", memo: "test"}` -> 201.

3. **TOKEN_TRANSFER type**: POST with `{type: "TOKEN_TRANSFER", to: "addr", amount: "1000", token: {address: "mint1", decimals: 6, symbol: "USDC"}}` -> 201. The mock adapter's `buildTokenTransfer` must be called.

4. **CONTRACT_CALL type**: POST with `{type: "CONTRACT_CALL", to: "0xcontract", calldata: "0x12345678"}` -> 201. The mock adapter's `buildContractCall` must be called.

5. **APPROVE type**: POST with `{type: "APPROVE", spender: "0xspender", token: {address: "mint1", decimals: 6, symbol: "USDC"}, amount: "1000"}` -> 201. The mock adapter's `buildApprove` must be called.

6. **BATCH type**: POST with `{type: "BATCH", instructions: [{to: "addr1", amount: "100"}, {to: "addr2", amount: "200"}]}` -> 201. The mock adapter's `buildBatch` must be called.

7. **Invalid type**: POST with `{type: "INVALID", to: "addr", amount: "1000"}` -> 400 with error code (ACTION_VALIDATION_FAILED or VALIDATION_ERROR).

8. **OpenAPI spec test**: GET /doc -> response body contains `oneOf` array with 6 entries including references to TransferRequest, TokenTransferRequest, ContractCallRequest, ApproveRequest, BatchRequest, and SendTransactionRequest (legacy).

For the mock adapter, extend the existing `mockAdapter()` to include `buildTokenTransfer`, `buildContractCall`, `buildApprove`, `buildBatch` as vi.fn() returning valid UnsignedTransaction objects. The mock adapter already has `buildTransaction` from the existing tests.

These tests will FAIL initially because:
- The current route hardcodes `type: 'TRANSFER'` and uses `c.req.valid('json')` with SendTransactionRequestOpenAPI (legacy-only schema)
- The OpenAPI spec does not have oneOf 6-variant
- Non-TRANSFER types will be rejected by the current Hono validation

Use the same test setup pattern as existing tests in the file: in-memory DB, mock adapter via mockAdapterPool, session token via JwtSecretManager.

Run tests and verify they FAIL.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/api-transactions.test.ts` — new 5-type tests FAIL, existing tests still pass.
  </verify>
  <done>
7-8 new failing tests exist that exercise all 5 transaction types, legacy fallback, invalid type rejection, and OpenAPI oneOf verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN -- implement route schema separation + OpenAPI 5-type components</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/transactions.ts
  </files>
  <action>
**openapi-schemas.ts changes:**

1. Import the 5 type-specific schemas from `@waiaas/core`:
   ```typescript
   import {
     // ... existing imports ...
     TransferRequestSchema,
     TokenTransferRequestSchema,
     ContractCallRequestSchema,
     ApproveRequestSchema,
     BatchRequestSchema,
   } from '@waiaas/core';
   ```

2. Register each as an OpenAPI component (alongside existing SendTransactionRequestOpenAPI):
   ```typescript
   export const TransferRequestOpenAPI = TransferRequestSchema.openapi('TransferRequest');
   export const TokenTransferRequestOpenAPI = TokenTransferRequestSchema.openapi('TokenTransferRequest');
   export const ContractCallRequestOpenAPI = ContractCallRequestSchema.openapi('ContractCallRequest');
   export const ApproveRequestOpenAPI = ApproveRequestSchema.openapi('ApproveRequest');
   export const BatchRequestOpenAPI = BatchRequestSchema.openapi('BatchRequest');
   ```

3. Create the loose passthrough schema for the route with manual oneOf for OpenAPI doc:
   ```typescript
   export const TransactionRequestOpenAPI = z.any().openapi({
     type: 'object',
     oneOf: [
       { $ref: '#/components/schemas/TransferRequest' },
       { $ref: '#/components/schemas/TokenTransferRequest' },
       { $ref: '#/components/schemas/ContractCallRequest' },
       { $ref: '#/components/schemas/ApproveRequest' },
       { $ref: '#/components/schemas/BatchRequest' },
       { $ref: '#/components/schemas/SendTransactionRequest' },
     ],
     description: 'Transaction request. Legacy format (to/amount/memo without type) is treated as TRANSFER.',
   });
   ```

4. Keep the existing `SendTransactionRequestOpenAPI` as-is (it's the legacy variant).

**transactions.ts changes:**

1. Import `stage1Validate` from the pipeline stages:
   ```typescript
   import { stage1Validate, stage2Auth, stage3Policy, ... } from '../../pipeline/stages.js';
   ```

2. Replace `SendTransactionRequestOpenAPI` with `TransactionRequestOpenAPI` in the route import and the `sendTransactionRoute` definition:
   ```typescript
   import { TransactionRequestOpenAPI, ... } from './openapi-schemas.js';

   const sendTransactionRoute = createRoute({
     // ...
     request: {
       body: {
         content: {
           'application/json': { schema: TransactionRequestOpenAPI },
         },
       },
     },
     // ...
   });
   ```

3. In the POST /transactions/send handler, replace inline Stage 1 logic with `stage1Validate()` delegation:

   **Current code (remove):**
   - `const request = c.req.valid('json');` -- uses Hono's Zod validation
   - Inline `await deps.db.insert(transactions).values(...)` -- hardcoded `type: 'TRANSFER'`
   - Inline notification call
   - `const response = c.json(...)` returns 201 immediately

   **New code:**
   - `const request = await c.req.json();` -- raw JSON, bypasses Hono Zod validation
   - Build PipelineContext with `request` as the raw body
   - Call `await stage1Validate(ctx)` -- this does the Zod validation (legacy or 5-type), generates txId, inserts into DB with correct type, and fires notification
   - After stage1Validate returns, use `ctx.txId` for the 201 response
   - Return `c.json({ id: ctx.txId, status: 'PENDING' }, 201)`
   - Continue with stages 2-6 fire-and-forget (same pattern)

   **Important:** The route handler currently builds `ctx.request = request` and sets `ctx.txId = generateId()` before the fire-and-forget block. After the change, `stage1Validate` assigns `ctx.txId` internally, so the handler reads `ctx.txId` AFTER `stage1Validate()` returns.

   The handler structure becomes:
   ```typescript
   router.openapi(sendTransactionRoute, async (c) => {
     const agentId = c.get('agentId' as never) as string;
     const agent = await deps.db.select()...get();
     if (!agent) throw new WAIaaSError('AGENT_NOT_FOUND', ...);

     const request = await c.req.json();

     // Resolve adapter before pipeline
     const rpcUrl = resolveRpcUrl(...);
     const adapter = await deps.adapterPool.resolve(...);

     // Build pipeline context
     const ctx: PipelineContext = {
       db: deps.db,
       adapter,
       keyStore: deps.keyStore,
       policyEngine: deps.policyEngine,
       masterPassword: deps.masterPassword,
       agentId,
       agent: { publicKey: agent.publicKey, chain: agent.chain, network: agent.network },
       request,
       txId: '',  // stage1Validate will assign
       sessionId: c.get('sessionId' as never) as string | undefined,
       sqlite: deps.sqlite,
       delayQueue: deps.delayQueue,
       approvalWorkflow: deps.approvalWorkflow,
       config: {
         policy_defaults_delay_seconds: deps.config.security.policy_defaults_delay_seconds,
         policy_defaults_approval_timeout: deps.config.security.policy_defaults_approval_timeout,
       },
       notificationService: deps.notificationService,
     };

     // Stage 1: Validate + DB INSERT (synchronous, assigns ctx.txId)
     await stage1Validate(ctx);

     // Return 201 immediately with txId
     const response = c.json({ id: ctx.txId, status: 'PENDING' }, 201);

     // Stages 2-6 fire-and-forget (same pattern as before)
     void (async () => {
       try {
         await stage2Auth(ctx);
         await stage3Policy(ctx);
         await stage4Wait(ctx);
         await stage5Execute(ctx);
         await stage6Confirm(ctx);
       } catch (error) {
         // ... same error handling as current ...
       }
     })();

     return response;
   });
   ```

   **Error handling for stage1Validate failures:** If stage1Validate throws (ZodError from invalid input), the Hono error handler middleware will catch it. The existing `openApiValidationHook` won't fire because we're using `z.any()` which never fails, but `stage1Validate` throws a raw ZodError. The global error handler in server.ts should already handle ZodError → 400. If not, wrap stage1Validate in a try/catch that converts ZodError to WAIaaSError('ACTION_VALIDATION_FAILED').

4. Remove the import of `SendTransactionRequestOpenAPI` from openapi-schemas.ts if it's no longer used in transaction routes (keep it exported from openapi-schemas.ts for OpenAPI component registration -- it's the legacy variant).

5. Remove the import of `generateId` if stage1Validate handles ID generation (check if generateId is used elsewhere in the file -- it might be used by other routes, so only remove the unused import).

After implementation, run all daemon tests to verify GREEN.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/api-transactions.test.ts` — ALL tests pass (new 5-type tests + existing tests).
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo build --filter=@waiaas/daemon` — TypeScript compilation succeeds.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run --filter=daemon` — full daemon test suite passes.
  </verify>
  <done>
- POST /v1/transactions/send accepts all 5 transaction types via stage1Validate delegation
- Legacy requests (no type field) fallback to TRANSFER and return 201
- Invalid type requests return 400 with validation error
- OpenAPI spec at GET /doc contains oneOf 6-variant with all type schemas as components
- All existing transaction tests continue to pass (zero regressions)
  </done>
</task>

</tasks>

<verification>
1. Run full daemon tests: `pnpm vitest run --filter=daemon` -- all pass
2. Build check: `pnpm turbo build` -- no TypeScript errors
3. OpenAPI check: Start daemon or inspect GET /doc response to verify oneOf 6-variant presence
4. Regression: All existing api-transactions.test.ts tests pass unchanged
</verification>

<success_criteria>
- POST /v1/transactions/send returns 201 for all 5 transaction types + legacy (no type)
- Invalid type returns 400
- GET /doc OpenAPI spec includes oneOf 6-variant for send transaction request schema
- All 5 type-specific schemas registered as OpenAPI components
- stage1Validate is the single Zod validation SSoT (not Hono's built-in)
- Zero test regressions in daemon package
</success_criteria>

<output>
After completion, create `.planning/phases/86-rest-api-5type-mcp-sdk/86-01-SUMMARY.md`
</output>
