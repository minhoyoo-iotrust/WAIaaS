---
phase: 86-rest-api-5type-mcp-sdk
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/tools/send-token.ts
  - packages/mcp/src/__tests__/tools.test.ts
  - packages/sdk/src/types.ts
  - packages/sdk/src/client.ts
  - packages/sdk/src/validation.ts
  - packages/sdk/src/__tests__/client.test.ts
  - packages/sdk/src/__tests__/validation.test.ts
  - python-sdk/waiaas/models.py
  - python-sdk/waiaas/client.py
  - python-sdk/tests/test_client.py
  - python-sdk/tests/test_models.py
autonomous: true

must_haves:
  truths:
    - "MCP send_token tool accepts optional type (TRANSFER|TOKEN_TRANSFER) and token parameters"
    - "MCP send_token without type/token fields sends legacy {to, amount, memo} body (backward compat)"
    - "MCP send_token with type=TOKEN_TRANSFER + token sends 5-type body to daemon"
    - "MCP does NOT expose CONTRACT_CALL, APPROVE, or BATCH transaction types (security policy)"
    - "TS SDK sendToken accepts optional type and token parameters for all 5 types"
    - "TS SDK sendToken without type/token sends legacy body (backward compat)"
    - "TS SDK validation allows type/token fields"
    - "Python SDK send_token accepts optional type and token keyword arguments"
    - "Python SDK send_token without type/token sends legacy body (backward compat)"
  artifacts:
    - path: "packages/mcp/src/tools/send-token.ts"
      provides: "MCP send_token with type/token params (TRANSFER|TOKEN_TRANSFER only)"
      contains: "type.*z.enum"
    - path: "packages/sdk/src/types.ts"
      provides: "SendTokenParams with optional type/token fields"
      contains: "type.*TRANSFER"
    - path: "packages/sdk/src/client.ts"
      provides: "sendToken method passing type/token to daemon API"
    - path: "packages/sdk/src/validation.ts"
      provides: "validateSendToken supporting type/token fields"
    - path: "python-sdk/waiaas/models.py"
      provides: "SendTokenRequest with optional type/token fields"
      contains: "type.*Optional"
    - path: "python-sdk/waiaas/client.py"
      provides: "send_token method with type/token kwargs"
  key_links:
    - from: "packages/mcp/src/tools/send-token.ts"
      to: "daemon POST /v1/transactions/send"
      via: "apiClient.post with type/token in body"
      pattern: "apiClient.post.*transactions/send"
    - from: "packages/sdk/src/client.ts"
      to: "daemon POST /v1/transactions/send"
      via: "http.post with type/token in body"
      pattern: "http.post.*transactions/send"
    - from: "python-sdk/waiaas/client.py"
      to: "daemon POST /v1/transactions/send"
      via: "_request POST with type/token in body"
      pattern: "_request.*POST.*transactions/send"
---

<objective>
Extend MCP send_token tool, TS SDK, and Python SDK to support 5-type transaction parameters.

Purpose: Enable MCP AI agents to send token transfers (TRANSFER + TOKEN_TRANSFER), and give SDK users full 5-type transaction support. MCP deliberately limits to TRANSFER/TOKEN_TRANSFER for security (no CONTRACT_CALL/APPROVE/BATCH exposure to AI agents).

Output: Updated MCP tool, TS SDK client+types+validation, Python SDK models+client with backward-compatible type/token parameters.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.4.1-evm-wallet-infrastructure.md (section 10: MCP send_token, SDK extension)
@packages/mcp/src/tools/send-token.ts
@packages/mcp/src/__tests__/tools.test.ts
@packages/sdk/src/client.ts
@packages/sdk/src/types.ts
@packages/sdk/src/validation.ts
@packages/sdk/src/__tests__/client.test.ts
@packages/sdk/src/__tests__/validation.test.ts
@python-sdk/waiaas/client.py
@python-sdk/waiaas/models.py
@python-sdk/tests/test_client.py
@python-sdk/tests/test_models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP send_token type/token extension + tests</name>
  <files>
    packages/mcp/src/tools/send-token.ts
    packages/mcp/src/__tests__/tools.test.ts
  </files>
  <action>
**send-token.ts changes:**

Update the MCP send_token tool registration to add optional `type` and `token` parameters, per the objective doc pseudocode:

```typescript
server.tool(
  'send_token',
  withAgentPrefix('Send SOL/ETH or tokens from the agent wallet. For token transfers, specify type and token info.', agentContext?.agentName),
  {
    to: z.string().describe('Destination wallet address'),
    amount: z.string().describe('Amount in smallest unit (lamports/wei)'),
    memo: z.string().optional().describe('Optional transaction memo'),
    type: z.enum(['TRANSFER', 'TOKEN_TRANSFER']).optional()
      .describe('Transaction type. Default: TRANSFER (native). TOKEN_TRANSFER for SPL/ERC-20'),
    token: z.object({
      address: z.string().describe('Token mint (SPL) or contract address (ERC-20)'),
      decimals: z.number().describe('Token decimals (e.g., 6 for USDC)'),
      symbol: z.string().describe('Token symbol (e.g., USDC)'),
    }).optional().describe('Required for TOKEN_TRANSFER'),
  },
  async (args) => {
    const body: Record<string, unknown> = { to: args.to, amount: args.amount };
    if (args.memo !== undefined) body.memo = args.memo;
    if (args.type) body.type = args.type;
    if (args.token) body.token = args.token;
    const result = await apiClient.post('/v1/transactions/send', body);
    return toToolResult(result);
  },
);
```

Key decisions:
- Only `TRANSFER` and `TOKEN_TRANSFER` exposed via z.enum (MCPSDK-04: no CONTRACT_CALL/APPROVE/BATCH)
- When type/token are omitted, body is `{to, amount}` or `{to, amount, memo}` -- legacy format (backward compat)
- The description explains the MCP tool can send native tokens or SPL/ERC-20 tokens

**tools.test.ts changes:**

Add to the existing `describe('send_token tool')` block:

1. **Test: send_token with type/token calls POST with correct body**
   ```
   args = { to: 'addr', amount: '1000', type: 'TOKEN_TRANSFER', token: { address: 'mint1', decimals: 6, symbol: 'USDC' } }
   -> apiClient.post called with { to: 'addr', amount: '1000', type: 'TOKEN_TRANSFER', token: { address: 'mint1', decimals: 6, symbol: 'USDC' } }
   ```

2. **Test: send_token without type/token sends legacy body (backward compat)**
   ```
   args = { to: 'addr', amount: '1000' }
   -> apiClient.post called with { to: 'addr', amount: '1000' }  (no type, no token)
   ```

3. **Test: send_token with TRANSFER type sends type field in body**
   ```
   args = { to: 'addr', amount: '1000', type: 'TRANSFER', memo: 'test' }
   -> apiClient.post called with { to: 'addr', amount: '1000', type: 'TRANSFER', memo: 'test' }
   ```

Use the existing `getToolHandler` and `createMockApiClient` helper functions from the test file.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/mcp/src/__tests__/tools.test.ts` — all tests pass (new + existing).
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo build --filter=@waiaas/mcp` — TypeScript compilation succeeds.
  </verify>
  <done>
- MCP send_token accepts type (TRANSFER|TOKEN_TRANSFER) and token parameters
- When type/token omitted, legacy body format is sent (backward compat)
- CONTRACT_CALL/APPROVE/BATCH are NOT exposed in the MCP tool schema
- All existing MCP tests pass unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: TS SDK + Python SDK 5-type send extension + tests</name>
  <files>
    packages/sdk/src/types.ts
    packages/sdk/src/client.ts
    packages/sdk/src/validation.ts
    packages/sdk/src/__tests__/client.test.ts
    packages/sdk/src/__tests__/validation.test.ts
    python-sdk/waiaas/models.py
    python-sdk/waiaas/client.py
    python-sdk/tests/test_client.py
    python-sdk/tests/test_models.py
  </files>
  <action>
**TS SDK -- types.ts changes:**

1. Add TokenInfo type:
   ```typescript
   export interface TokenInfo {
     address: string;
     decimals: number;
     symbol: string;
   }
   ```

2. Extend SendTokenParams to support all 5 types:
   ```typescript
   export interface SendTokenParams {
     to?: string;
     amount?: string;
     memo?: string;
     type?: 'TRANSFER' | 'TOKEN_TRANSFER' | 'CONTRACT_CALL' | 'APPROVE' | 'BATCH';
     token?: TokenInfo;
     // CONTRACT_CALL fields
     calldata?: string;
     abi?: Record<string, unknown>[];
     value?: string;
     programId?: string;
     instructionData?: string;
     accounts?: Array<{ pubkey: string; isSigner: boolean; isWritable: boolean }>;
     // APPROVE fields
     spender?: string;
     // BATCH fields
     instructions?: Array<Record<string, unknown>>;
   }
   ```

   Note: `to` and `amount` become optional because APPROVE doesn't have `to`, and BATCH doesn't have top-level `to`/`amount`. The validation layer handles required field checking per type.

**TS SDK -- validation.ts changes:**

Update `validateSendToken` to handle the 5-type case:

- If `type` is not present or is `'TRANSFER'`: validate `to` (required, non-empty string) and `amount` (required, numeric string) and `memo` (optional, max 256 chars) -- same as current logic
- If `type` is `'TOKEN_TRANSFER'`: validate `to`, `amount`, and `token` (required: {address: non-empty string, decimals: number, symbol: non-empty string})
- If `type` is `'CONTRACT_CALL'`: validate `to` (required)
- If `type` is `'APPROVE'`: validate `spender` (required, non-empty string), `token` (required), `amount` (required)
- If `type` is `'BATCH'`: validate `instructions` (required, array with >= 2 items)
- Unknown `type` values: throw VALIDATION_ERROR

Keep zero external dependencies (no Zod). Use inline checks.

**TS SDK -- client.ts changes:**

The `sendToken` method already passes `params` directly to `http.post`. Since `SendTokenParams` now includes optional type/token/etc fields, the HTTP body will automatically include them when set. No change needed to the method logic itself -- `params` is spread into the POST body by `validateSendToken(params)` then `http.post('/v1/transactions/send', params, ...)`.

Verify that `params` is passed as-is to the HTTP post body. The current code does `this.http.post<SendTokenResponse>('/v1/transactions/send', params, this.authHeaders())` which serializes the entire params object as JSON body. This is correct -- the daemon will receive the full body including type/token fields.

**TS SDK -- tests:**

In `client.test.ts`, add tests:
1. `sendToken with type=TOKEN_TRANSFER passes type and token in request body`
2. `sendToken without type sends legacy body (backward compat)`

In `validation.test.ts`, add tests:
1. `validates TOKEN_TRANSFER requires token field`
2. `validates APPROVE requires spender and token`
3. `validates BATCH requires instructions array`
4. `validates unknown type throws VALIDATION_ERROR`
5. `passes valid TOKEN_TRANSFER params`

**Python SDK -- models.py changes:**

1. Add TokenInfo model:
   ```python
   class TokenInfo(BaseModel):
       address: str
       decimals: int
       symbol: str
   ```

2. Extend SendTokenRequest to support type and token:
   ```python
   class SendTokenRequest(BaseModel):
       """Request body for POST /v1/transactions/send."""
       to: Optional[str] = None
       amount: Optional[str] = None
       memo: Optional[str] = None
       type: Optional[str] = None
       token: Optional[TokenInfo] = None
       # CONTRACT_CALL fields
       calldata: Optional[str] = None
       abi: Optional[list[dict[str, Any]]] = None
       value: Optional[str] = None
       program_id: Optional[str] = Field(default=None, alias="programId")
       instruction_data: Optional[str] = Field(default=None, alias="instructionData")
       accounts: Optional[list[dict[str, Any]]] = None
       # APPROVE fields
       spender: Optional[str] = None
       # BATCH fields
       instructions: Optional[list[dict[str, Any]]] = None

       model_config = {"populate_by_name": True}
   ```

**Python SDK -- client.py changes:**

Extend the `send_token` method signature to accept type/token and extra kwargs:

```python
async def send_token(
    self,
    to: Optional[str] = None,
    amount: Optional[str] = None,
    *,
    memo: Optional[str] = None,
    type: Optional[str] = None,
    token: Optional[dict[str, Any]] = None,
    **kwargs: Any,
) -> TransactionResponse:
    """POST /v1/transactions/send -- Send transaction (5-type support).

    For legacy TRANSFER: send_token(to="addr", amount="1000")
    For TOKEN_TRANSFER: send_token(to="addr", amount="1000", type="TOKEN_TRANSFER", token={...})
    For CONTRACT_CALL: send_token(type="CONTRACT_CALL", to="0xcontract", calldata="0x...")
    For APPROVE: send_token(type="APPROVE", spender="0x...", token={...}, amount="1000")
    For BATCH: send_token(type="BATCH", instructions=[...])
    """
    # Build the request body. Import TokenInfo only if token is a dict
    from waiaas.models import TokenInfo as TokenInfoModel
    token_obj = TokenInfoModel(**token) if isinstance(token, dict) else token

    request = SendTokenRequest(
        to=to, amount=amount, memo=memo, type=type,
        token=token_obj, **kwargs
    )
    body = request.model_dump(exclude_none=True, by_alias=True)
    resp = await self._request("POST", "/v1/transactions/send", json_body=body)
    return TransactionResponse.model_validate(resp.json())
```

IMPORTANT: The existing `send_token(to, amount, *, memo=None)` signature changes to make `to` and `amount` optional (with defaults of None). For backward compat, existing calls like `send_token("addr", "1000")` or `send_token(to="addr", amount="1000")` still work. The type/token are keyword-only arguments.

**Python SDK -- tests:**

In `test_client.py`, add:
1. Test send_token with type=TOKEN_TRANSFER passes correct body
2. Test send_token without type passes legacy body

In `test_models.py`, add:
1. Test SendTokenRequest serialization with type and token
2. Test SendTokenRequest serialization legacy (to/amount only)
3. Test TokenInfo model
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/sdk/` — all TS SDK tests pass.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo build --filter=@waiaas/sdk` — TypeScript compilation succeeds.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && cd python-sdk && python -m pytest tests/ -v` — all Python tests pass.
  </verify>
  <done>
- TS SDK SendTokenParams includes optional type/token and all 5-type fields
- TS SDK validation handles per-type field requirements
- TS SDK sendToken passes full params object to daemon API
- Python SDK SendTokenRequest includes optional type/token and all 5-type fields
- Python SDK send_token passes type/token in request body
- Both SDKs maintain backward compatibility (type/token omitted = legacy TRANSFER)
- All existing SDK tests pass unchanged (zero regressions)
  </done>
</task>

</tasks>

<verification>
1. MCP tests: `pnpm vitest run packages/mcp/` -- all pass
2. TS SDK tests: `pnpm vitest run packages/sdk/` -- all pass
3. Python SDK tests: `cd python-sdk && python -m pytest tests/ -v` -- all pass
4. Build: `pnpm turbo build` -- all packages compile
5. Backward compat: Existing send_token calls without type/token still work in all 3 targets
</verification>

<success_criteria>
- MCP send_token accepts TRANSFER/TOKEN_TRANSFER only (CONTRACT_CALL/APPROVE/BATCH not exposed)
- TS SDK sendToken accepts all 5 types via optional type/token fields
- Python SDK send_token accepts all 5 types via optional type/token kwargs
- Legacy calls (no type field) work unchanged in all 3 targets
- Zero test regressions in mcp, sdk, and python-sdk packages
</success_criteria>

<output>
After completion, create `.planning/phases/86-rest-api-5type-mcp-sdk/86-02-SUMMARY.md`
</output>
