---
phase: 187-audit-gap-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/components/currency-select.tsx
  - packages/admin/src/pages/system.tsx
  - packages/admin/src/utils/settings-search-index.ts
  - .planning/phases/182-ui-shared-components/182-VERIFICATION.md
autonomous: true
requirements: [SRCH-02, SRCH-03]
gap_closure: true

must_haves:
  truths:
    - "검색에서 'Display Currency' 클릭 시 System 페이지로 이동하고 display.currency 필드가 스크롤+하이라이트된다"
    - "settings-search-index.ts의 모든 엔트리 id가 고유하다 (중복 없음)"
    - "Phase 182의 7개 요구사항(TAB-01, FGRP-01, DESC-01, DESC-02, BCMB-01, BCMB-02, BCMB-03)에 대한 형식적 검증 문서가 존재한다"
  artifacts:
    - path: "packages/admin/src/components/currency-select.tsx"
      provides: "CurrencySelect with name prop and hidden input"
      contains: "name"
    - path: "packages/admin/src/pages/system.tsx"
      provides: "CurrencySelect wrapper with form-field class and highlight"
      contains: "form-field"
    - path: "packages/admin/src/utils/settings-search-index.ts"
      provides: "All unique IDs in search index"
      contains: "telegram_dedicated_bot_token"
    - path: ".planning/phases/182-ui-shared-components/182-VERIFICATION.md"
      provides: "Phase 182 formal verification report"
      contains: "7/7"
  key_links:
    - from: "settings-search-index.ts"
      to: "system.tsx CurrencySelect"
      via: "highlightField signal + querySelector('[name=display.currency]')"
      pattern: 'name="display.currency"'
---

<objective>
감사에서 발견된 2개 integration finding (FINDING-01, FINDING-02)을 수정하고, Phase 182의 누락된 VERIFICATION.md를 생성하여 v2.3 마일스톤의 모든 감사 갭을 해소한다.

Purpose: v2.3 마일스톤 완료 전 기술 부채 0건 달성
Output: 수정된 소스 파일 3개 + Phase 182 검증 문서 1개
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v2.3-MILESTONE-AUDIT.md

# Source files to modify
@packages/admin/src/components/currency-select.tsx
@packages/admin/src/pages/system.tsx
@packages/admin/src/utils/settings-search-index.ts
@packages/admin/src/components/form.tsx

# Phase 182 artifacts for VERIFICATION evidence
@packages/admin/src/components/tab-nav.tsx
@packages/admin/src/components/field-group.tsx
@packages/admin/src/components/breadcrumb.tsx
@packages/admin/src/components/layout.tsx
@.planning/phases/182-ui-shared-components/182-01-SUMMARY.md
@.planning/phases/182-ui-shared-components/182-02-SUMMARY.md

# VERIFICATION format reference
@.planning/phases/183-menu-page-restructure/183-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: FINDING-01 CurrencySelect name 속성 + 하이라이트 수정 + FINDING-02 중복 ID 수정</name>
  <files>
    packages/admin/src/components/currency-select.tsx
    packages/admin/src/pages/system.tsx
    packages/admin/src/utils/settings-search-index.ts
  </files>
  <action>
**FINDING-01 수정 (CurrencySelect highlight):**

The problem: When search result "Display Currency" is clicked, `highlightField.value = 'display.currency'` is set. FormField's useEffect in form.tsx does `document.querySelector('[name="display.currency"]')` to find the element, then `el.closest('.form-field')?.scrollIntoView(...)` for scroll, and applies `form-field--highlight` CSS class. But CurrencySelect is NOT inside a FormField component -- it's in a raw `div.settings-field-full` wrapper. No element has `name="display.currency"`.

Fix approach (2 files):

1. **currency-select.tsx** -- Add optional `name` prop to CurrencySelectProps interface:
   ```typescript
   interface CurrencySelectProps {
     value: string;
     onChange: (code: string) => void;
     name?: string;  // ADD THIS
   }
   ```
   In the component function signature, destructure `name`. Inside the `<div class="currency-select">` container, add a hidden input BEFORE the trigger button:
   ```tsx
   {name && <input type="hidden" name={name} value={value} />}
   ```

2. **system.tsx** -- In the `DisplaySettings` function component (around line 333), change the CurrencySelect wrapper from:
   ```tsx
   <div class="settings-field-full">
     <label>{keyToLabel('currency')}</label>
     <CurrencySelect ... />
   </div>
   ```
   To use `form-field` class and add highlight support. Import `highlightField` from `'../components/settings-search'` and `useEffect` from `'preact/hooks'` (if not already imported). Then wrap CurrencySelect in a div with class `form-field` that conditionally adds `form-field--highlight`:

   At the top of the `DisplaySettings` function body, add highlight logic:
   ```tsx
   const isCurrencyHighlighted = highlightField.value === 'display.currency';

   useEffect(() => {
     if (isCurrencyHighlighted) {
       const el = document.querySelector('[name="display.currency"]');
       if (el) {
         el.closest('.form-field')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
       }
       const timer = setTimeout(() => {
         highlightField.value = '';
       }, 2500);
       return () => clearTimeout(timer);
     }
   }, [isCurrencyHighlighted]);
   ```

   Replace the settings-field-full wrapper:
   ```tsx
   <div class={`form-field${isCurrencyHighlighted ? ' form-field--highlight' : ''}`}>
     <label>{keyToLabel('currency')}</label>
     <CurrencySelect
       name="display.currency"
       value={ev('display', 'currency') || 'USD'}
       onChange={(code) => handleFieldChange('display.currency', code)}
     />
   </div>
   ```

   Note: `highlightField` must be imported at the top of system.tsx. Check if it's already imported; if not, add:
   ```typescript
   import { highlightField } from '../components/settings-search';
   ```

   Also ensure `useEffect` is imported from `preact/hooks` (check existing imports -- it may already be there for the settings loading effect).

**FINDING-02 수정 (duplicate search index ID):**

3. **settings-search-index.ts** line 87 -- Change the duplicate `id` from:
   ```
   id: 'notifications.settings.telegram_bot_token'
   ```
   To:
   ```
   id: 'notifications.settings.telegram_dedicated_bot_token'
   ```
   This distinguishes the Telegram Bot's dedicated token entry (fieldName: 'telegram.bot_token') from the notification-channel telegram token entry (fieldName: 'notifications.telegram_bot_token') on line 78. The label "Bot Token" and description remain unchanged.
  </action>
  <verify>
1. `grep -n 'name.*display.currency' packages/admin/src/pages/system.tsx` -- Should show the name prop being passed
2. `grep -n 'name?' packages/admin/src/components/currency-select.tsx` -- Should show optional name in props
3. `grep -n 'type="hidden"' packages/admin/src/components/currency-select.tsx` -- Should show hidden input
4. `grep -c 'notifications.settings.telegram_bot_token' packages/admin/src/utils/settings-search-index.ts` -- Should be 1 (not 2)
5. `grep -n 'telegram_dedicated_bot_token' packages/admin/src/utils/settings-search-index.ts` -- Should exist
6. `grep -n 'form-field--highlight' packages/admin/src/pages/system.tsx` -- Should show highlight class
7. `pnpm turbo run typecheck --filter=@waiaas/admin` -- Should pass
  </verify>
  <done>
1. CurrencySelect has optional `name` prop and renders hidden input with that name when provided
2. system.tsx passes `name="display.currency"` to CurrencySelect and wraps it in a `form-field` div with highlight support
3. `document.querySelector('[name="display.currency"]')` will find the hidden input, `.closest('.form-field')` will find the wrapper, and `form-field--highlight` CSS class will apply the highlight animation
4. settings-search-index.ts has no duplicate IDs -- line 87 now uses 'notifications.settings.telegram_dedicated_bot_token'
  </done>
</task>

<task type="auto">
  <name>Task 2: Phase 182 VERIFICATION.md 생성</name>
  <files>
    .planning/phases/182-ui-shared-components/182-VERIFICATION.md
  </files>
  <action>
Create `.planning/phases/182-ui-shared-components/182-VERIFICATION.md` following the exact format of the 183-VERIFICATION.md template. Verify each of the 5 success criteria from ROADMAP.md Phase 182, which map to 7 requirement IDs.

Phase 182 Success Criteria (from ROADMAP.md):
1. TabNav 컴포넌트가 탭 목록과 활성 탭을 받아 탭 전환을 수행하고, 독립적으로 동작한다
2. FieldGroup 컴포넌트가 fieldset+legend 시맨틱 래퍼로 자식 필드를 그룹화하여 렌더링한다
3. FormField에 description prop을 전달하면 필드 아래에 help text가 렌더링된다
4. PageHeader에 subtitle 영역이 추가되어 설명 텍스트를 표시한다
5. Breadcrumb 컴포넌트가 탭 페이지에서 "페이지명 > 탭명"을 표시하고, Dashboard/System에서는 미표시되며, 페이지명 클릭 시 첫 번째 탭으로 이동한다

Requirements to verify: TAB-01, FGRP-01, DESC-01, DESC-02, BCMB-01, BCMB-02, BCMB-03

For each truth/requirement, gather evidence by reading the actual source files:

**Truth 1 (TAB-01):** Read `packages/admin/src/components/tab-nav.tsx`. Evidence: TabNavProps interface accepts `tabs: TabItem[]`, `activeTab: string`, `onTabChange: (key: string) => void`. Component renders `.tab-nav` with `.tab-btn` buttons, applying `.active` class to activeTab. Used in wallets.tsx, sessions.tsx, policies.tsx, notifications.tsx, security.tsx (5 pages). File exists at 40 lines.

**Truth 2 (FGRP-01):** Read `packages/admin/src/components/field-group.tsx`. Evidence: FieldGroupProps: `legend: string`, `children: ComponentChildren`, `description?: string`. Renders `<fieldset class="field-group">` with `<legend>` and optional `<p class="field-group-description">`. File exists at 17 lines.

**Truth 3 (DESC-02):** Read `packages/admin/src/components/form.tsx`. Evidence: FormFieldProps includes `description?: string`. Both checkbox branch (line 65) and standard branch (line 119) render `{description && <span class="form-description">{description}</span>}`.

**Truth 4 (DESC-01):** Read `packages/admin/src/components/layout.tsx`. Evidence: `PAGE_SUBTITLES` Record with 7 entries (dashboard/wallets/sessions/policies/notifications/security/system). `getPageSubtitle()` exported. Header renders `<p class="header-subtitle">` when subtitle exists. global.css contains `.header-subtitle` styles.

**Truth 5 (BCMB-01, BCMB-02, BCMB-03):** Read `packages/admin/src/components/breadcrumb.tsx`. Evidence: BreadcrumbProps: `pageName`, `tabName?`, `onPageClick?`. Returns `null` when no tabName (BCMB-02 -- Dashboard/System without tabs show no breadcrumb). Renders `<nav class="breadcrumb">` with page button (BCMB-03 -- click triggers onPageClick) and current tab span (BCMB-01). Used in wallets.tsx, sessions.tsx, policies.tsx, notifications.tsx, security.tsx (5 tabbed pages).

Write the VERIFICATION.md with:
- Frontmatter: phase, verified (2026-02-18 timestamp), status: passed, score: 5/5, re_verification: true (retroactive from audit), gaps: []
- Goal Achievement table with 5 truths
- Required Artifacts table (tab-nav.tsx, field-group.tsx, form.tsx, layout.tsx, breadcrumb.tsx, global.css)
- Key Links table (imports from downstream phases)
- Requirements Coverage table (7 requirements mapped to plans 182-01 and 182-02)
- Anti-Patterns: None
- Gaps Summary: No gaps
- Note this is a retroactive verification generated during Phase 187 gap closure
  </action>
  <verify>
1. `test -f .planning/phases/182-ui-shared-components/182-VERIFICATION.md && echo "EXISTS"` -- Must print EXISTS
2. `grep -c 'VERIFIED' .planning/phases/182-ui-shared-components/182-VERIFICATION.md` -- Should be >= 5 (one per truth)
3. `grep 'TAB-01' .planning/phases/182-ui-shared-components/182-VERIFICATION.md` -- Must appear
4. `grep 'BCMB-03' .planning/phases/182-ui-shared-components/182-VERIFICATION.md` -- Must appear
5. `grep '5/5' .planning/phases/182-ui-shared-components/182-VERIFICATION.md` -- Must appear in score
  </verify>
  <done>
1. 182-VERIFICATION.md exists in .planning/phases/182-ui-shared-components/
2. All 5 success criteria marked VERIFIED with specific codebase evidence
3. All 7 requirement IDs (TAB-01, FGRP-01, DESC-01, DESC-02, BCMB-01, BCMB-02, BCMB-03) mapped and marked SATISFIED
4. Document follows exact format of 183-VERIFICATION.md template
5. Retroactive verification noted in re_verification field and document body
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/admin` passes (no new type errors)
2. `pnpm turbo run lint --filter=@waiaas/admin` passes (no new lint errors)
3. All 3 success criteria from ROADMAP Phase 187 are satisfied:
   - display.currency CurrencySelect has name attribute -> querySelector finds it -> highlight works
   - settings-search-index.ts has 0 duplicate IDs
   - 182-VERIFICATION.md exists with 7 requirements verified
</verification>

<success_criteria>
1. `document.querySelector('[name="display.currency"]')` returns a DOM element (the hidden input inside CurrencySelect)
2. The containing div has `form-field` class, so `el.closest('.form-field')` works for scrollIntoView
3. `form-field--highlight` class is conditionally applied for the 2.5s highlight animation
4. No duplicate `id` values exist in SETTINGS_SEARCH_INDEX array (each id is unique)
5. 182-VERIFICATION.md contains VERIFIED status for all 5 truths and SATISFIED for all 7 requirements
</success_criteria>

<output>
After completion, create `.planning/phases/187-audit-gap-fix/187-01-SUMMARY.md`
</output>
