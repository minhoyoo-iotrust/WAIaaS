---
phase: 134-form-infra-5type-forms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/schemas/policy.schema.ts
  - packages/admin/src/components/dynamic-row-list.tsx
  - packages/admin/src/components/policy-forms/index.ts
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "타입 셀렉트 변경 시 전용 폼 영역이 렌더링된다 (PolicyFormRouter가 타입별 분기)"
    - "[JSON 직접 편집] 토글 클릭 시 JSON textarea와 구조화 폼 간 전환된다"
    - "DynamicRowList의 [+ 추가] 버튼으로 행이 추가되고 [x] 버튼으로 행이 삭제된다"
    - "4개 미등록 타입(WHITELIST, RATE_LIMIT, TIME_RESTRICTION, X402_ALLOWED_DOMAINS)의 Zod rules 스키마가 POLICY_RULES_SCHEMAS에 등록된다"
    - "X402_ALLOWED_DOMAINS가 Admin UI 정책 타입 드롭다운에 추가된다"
  artifacts:
    - path: "packages/core/src/schemas/policy.schema.ts"
      provides: "4개 추가 Zod rules 스키마 (WhitelistRulesSchema, RateLimitRulesSchema, TimeRestrictionRulesSchema, X402AllowedDomainsRulesSchema)"
      contains: "WhitelistRulesSchema"
    - path: "packages/admin/src/components/dynamic-row-list.tsx"
      provides: "재사용 동적 행 추가/삭제 컴포넌트"
      exports: ["DynamicRowList"]
    - path: "packages/admin/src/components/policy-forms/index.ts"
      provides: "PolicyFormRouter + PolicyFormProps 타입 export"
      exports: ["PolicyFormRouter"]
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "PolicyFormRouter 통합 + JSON 토글 상태 관리"
      contains: "PolicyFormRouter"
    - path: "packages/admin/src/styles/global.css"
      provides: "policy-form, dynamic-row-list, json-toggle CSS"
      contains: "dynamic-row"
  key_links:
    - from: "packages/admin/src/pages/policies.tsx"
      to: "packages/admin/src/components/policy-forms/index.ts"
      via: "import PolicyFormRouter"
      pattern: "PolicyFormRouter"
    - from: "packages/admin/src/components/policy-forms/index.ts"
      to: "packages/admin/src/components/dynamic-row-list.tsx"
      via: "import DynamicRowList (consumed by type-specific forms in plan 02)"
      pattern: "DynamicRowList"
    - from: "packages/core/src/schemas/policy.schema.ts"
      to: "POLICY_RULES_SCHEMAS map"
      via: "4개 신규 스키마가 superRefine에서 검증됨"
      pattern: "WHITELIST.*WhitelistRulesSchema"
---

<objective>
폼 인프라 구성: DynamicRowList 재사용 컴포넌트, PolicyFormRouter(타입별 분기 + JSON 폴백), JSON 토글 상태 관리, 4개 미등록 Zod 스키마 추가, policies.tsx 리팩터링.

Purpose: 5-type 전용 폼(Plan 02)과 7-type 전용 폼(Phase 135)이 사용할 공통 인프라를 구축한다.
Output: DynamicRowList, PolicyFormRouter(placeholder), JSON 토글, 4 Zod schemas, CSS, policies.tsx 통합
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.5.2-admin-policy-form-ux.md
@packages/core/src/schemas/policy.schema.ts
@packages/core/src/enums/policy.ts
@packages/admin/src/pages/policies.tsx
@packages/admin/src/components/form.tsx
@packages/admin/src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: 4개 미등록 Zod rules 스키마 추가 + core export</name>
  <files>packages/core/src/schemas/policy.schema.ts, packages/core/src/schemas/index.ts, packages/core/src/index.ts</files>
  <action>
packages/core/src/schemas/policy.schema.ts에 4개 미등록 타입의 Zod rules 스키마를 추가하고 POLICY_RULES_SCHEMAS 맵에 등록한다:

1. **WhitelistRulesSchema** (WHITELIST): `{ allowed_addresses: z.array(z.string().min(1)).min(1, 'At least one address required') }` — policies.tsx의 DEFAULT_RULES.WHITELIST가 `{ allowed_addresses: [] }` 형태이므로 이 구조를 따른다.

2. **RateLimitRulesSchema** (RATE_LIMIT): `{ max_requests: z.number().int().min(1), window_seconds: z.number().int().min(1) }` — DEFAULT_RULES.RATE_LIMIT: `{ max_requests: 100, window_seconds: 3600 }`.

3. **TimeRestrictionRulesSchema** (TIME_RESTRICTION): `{ allowed_hours: z.object({ start: z.number().int().min(0).max(23), end: z.number().int().min(1).max(24) }), allowed_days: z.array(z.number().int().min(0).max(6)).min(1, 'At least one day required') }` — DEFAULT_RULES.TIME_RESTRICTION: `{ allowed_hours: {start:0, end:24}, allowed_days:[0..6] }`.

4. **X402AllowedDomainsRulesSchema** (X402_ALLOWED_DOMAINS): `{ domains: z.array(z.string().min(1)).min(1, 'At least one domain required') }` — x402 정책의 도메인 패턴 목록.

각 스키마를 POLICY_RULES_SCHEMAS에 키-값으로 추가한다 (WHITELIST, RATE_LIMIT, TIME_RESTRICTION, X402_ALLOWED_DOMAINS). 기존 "free-form rules, no validation" 주석을 제거하거나 업데이트한다.

WhitelistRulesSchema, RateLimitRulesSchema, TimeRestrictionRulesSchema, X402AllowedDomainsRulesSchema를 export 한다. schemas/index.ts와 core의 index.ts에도 re-export 추가한다.

POLICY_RULES_SCHEMAS 맵이 이제 12개 전체 타입을 커버하므로 `Partial<Record<string, ...>>` 타입을 `Record<string, ...>`로 변경해도 좋고, 유지해도 무방하다 (Claude 재량).
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core run build` 성공.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core run test` 기존 policy-superrefine 테스트 통과 + 새로운 4개 타입이 superRefine에서 올바로 검증되는지 확인.
  </verify>
  <done>
12개 PolicyType 전체에 대해 POLICY_RULES_SCHEMAS에 Zod 스키마가 등록되어 있고, core 빌드/테스트 통과.
  </done>
</task>

<task type="auto">
  <name>Task 2: DynamicRowList + PolicyFormRouter + JSON 토글 + policies.tsx 리팩터링 + CSS</name>
  <files>packages/admin/src/components/dynamic-row-list.tsx, packages/admin/src/components/policy-forms/index.ts, packages/admin/src/pages/policies.tsx, packages/admin/src/styles/global.css</files>
  <action>
**A. DynamicRowList 컴포넌트 (`packages/admin/src/components/dynamic-row-list.tsx`):**

재사용 가능한 동적 행 추가/삭제 컴포넌트. Props:
- `items: T[]` — 현재 행 배열
- `onAdd: () => void` — [+ 추가] 클릭 핸들러 (부모가 빈 항목 추가)
- `onRemove: (index: number) => void` — [x] 클릭 핸들러
- `renderRow: (item: T, index: number, onChange: (index: number, updated: T) => void) => ComponentChildren` — 각 행 렌더링 콜백
- `onChange: (index: number, updated: T) => void` — 행 내용 변경 핸들러
- `addLabel?: string` — 추가 버튼 텍스트 (기본값: '+ Add')
- `minItems?: number` — 최소 항목 수 (기본값: 0). 항목이 minItems 이하일 때 [x] 버튼 비활성화
- `error?: string` — 목록 수준 에러 메시지 (빈 목록 에러 등)

렌더링 구조:
```
<div class="dynamic-row-list">
  {items.map((item, i) => (
    <div class="dynamic-row" key={i}>
      <div class="dynamic-row-fields">
        {renderRow(item, i, onChange)}
      </div>
      <button class="btn btn-ghost btn-sm dynamic-row-remove" onClick={() => onRemove(i)} disabled={items.length <= minItems} title="Remove">x</button>
    </div>
  ))}
  <button class="btn btn-secondary btn-sm" onClick={onAdd}>{addLabel}</button>
  {error && <span class="form-error">{error}</span>}
</div>
```

**B. PolicyFormRouter (`packages/admin/src/components/policy-forms/index.ts`):**

Props 인터페이스:
```ts
export interface PolicyFormProps {
  rules: Record<string, unknown>;
  onChange: (rules: Record<string, unknown>) => void;
  errors: Record<string, string>;
}
```

PolicyFormRouter 컴포넌트:
```ts
export function PolicyFormRouter({ type, rules, onChange, errors }: { type: string } & PolicyFormProps): ComponentChildren
```

현재 단계에서는 5개 타입의 실제 폼이 아직 없으므로, 모든 타입에 대해 "Coming soon - use JSON editor" 플레이스홀더를 렌더링한다. Plan 02에서 5개 타입 폼을 추가하면 switch/case에서 해당 컴포넌트를 반환한다.

default case: `<p class="policy-form-placeholder">This policy type uses JSON editor. Toggle to JSON mode.</p>`

**C. policies.tsx 리팩터링:**

1. **X402_ALLOWED_DOMAINS를 POLICY_TYPES 배열에 추가:**
   `{ label: 'x402 Allowed Domains', value: 'X402_ALLOWED_DOMAINS' }` 항목을 추가한다.

2. **DEFAULT_RULES에 X402_ALLOWED_DOMAINS 추가:**
   `X402_ALLOWED_DOMAINS: { domains: [] }`.

3. **JSON 토글 상태 추가:**
   `const jsonMode = useSignal(false);` — true일 때 기존 JSON textarea, false일 때 PolicyFormRouter 렌더링.

4. **formRulesObj 시그널 추가:**
   `const formRulesObj = useSignal<Record<string, unknown>>(DEFAULT_RULES.SPENDING_LIMIT as Record<string, unknown>);`
   — PolicyFormRouter와 구조화 폼이 사용하는 객체 형태의 rules 상태.

5. **formErrors 시그널 추가:**
   `const formErrors = useSignal<Record<string, string>>({});`
   — 필드별 에러 메시지 저장.

6. **handleTypeChange 수정:**
   타입 변경 시 `formRulesObj.value`를 DEFAULT_RULES[type]으로 리셋, `formErrors.value`를 `{}`로 리셋, `jsonMode.value`를 `false`로 리셋.

7. **폼 영역 렌더링 변경:**
   기존 Rules (JSON) textarea 부분을 다음으로 교체:
   ```tsx
   <div class="policy-form-section">
     <div class="policy-form-header">
       <label>Rules</label>
       <button class="btn btn-ghost btn-sm json-toggle" onClick={() => {
         if (!jsonMode.value) {
           // 구조화 → JSON: formRulesObj → formRules (JSON 문자열)
           formRules.value = JSON.stringify(formRulesObj.value, null, 2);
         } else {
           // JSON → 구조화: formRules → formRulesObj (파싱 시도, 실패 시 유지)
           try {
             formRulesObj.value = JSON.parse(formRules.value);
             formError.value = null;
           } catch {
             formError.value = 'Invalid JSON — cannot switch to form mode';
             return; // 전환 중단
           }
         }
         jsonMode.value = !jsonMode.value;
       }}>
         {jsonMode.value ? 'Switch to Form' : 'JSON Direct Edit'}
       </button>
     </div>
     {jsonMode.value ? (
       <FormField label="" name="rules" type="textarea" value={formRules.value} onChange={(v) => { formRules.value = v as string; }} error={formError.value ?? undefined} />
     ) : (
       <PolicyFormRouter type={formType.value} rules={formRulesObj.value} onChange={(r) => { formRulesObj.value = r; }} errors={formErrors.value} />
     )}
   </div>
   ```

8. **handleCreate 수정:**
   - jsonMode가 false(구조화 폼)일 때 `formRulesObj.value`를 직접 사용 (JSON.parse 불필요).
   - jsonMode가 true일 때 기존대로 `JSON.parse(formRules.value)`.
   - 생성 후 `formRulesObj.value = DEFAULT_RULES.SPENDING_LIMIT`, `formErrors.value = {}`, `jsonMode.value = false`로 리셋.

9. **import 추가:** `PolicyFormRouter`를 `'../components/policy-forms'`에서 import.

**D. CSS 추가 (`packages/admin/src/styles/global.css`):**

파일 끝(마지막 `}` 뒤, `@media` 앞)에 다음 CSS를 추가:

```css
/* Dynamic Row List */
.dynamic-row-list { display: flex; flex-direction: column; gap: var(--space-2); }
.dynamic-row { display: flex; align-items: flex-start; gap: var(--space-2); }
.dynamic-row-fields { flex: 1; display: flex; gap: var(--space-2); align-items: flex-start; }
.dynamic-row-fields .form-field { flex: 1; margin-bottom: 0; }
.dynamic-row-remove { flex-shrink: 0; margin-top: var(--space-6); color: var(--color-danger); }

/* Policy Form */
.policy-form-section { margin-bottom: var(--space-4); }
.policy-form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); }
.policy-form-header label { font-weight: var(--font-weight-semibold); font-size: var(--font-size-sm); }
.json-toggle { font-size: var(--font-size-xs); }
.policy-form-placeholder { color: var(--color-text-secondary); font-size: var(--font-size-sm); padding: var(--space-4); border: 1px dashed var(--color-border); border-radius: var(--radius-md); text-align: center; }
.policy-form-fields { display: flex; flex-direction: column; gap: var(--space-3); }
.policy-form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); }
.policy-form-grid .form-field { margin-bottom: 0; }
```
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter admin run build` 빌드 성공.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter admin run test` 기존 테스트 통과.
policies.tsx에 PolicyFormRouter import 존재, jsonMode 토글 버튼 존재, X402_ALLOWED_DOMAINS 옵션 존재 확인.
  </verify>
  <done>
- DynamicRowList 컴포넌트가 packages/admin/src/components/dynamic-row-list.tsx에 존재하고 export됨
- PolicyFormRouter가 packages/admin/src/components/policy-forms/index.ts에 존재하고 export됨
- policies.tsx가 PolicyFormRouter를 사용하고, JSON 토글 버튼이 있으며, X402_ALLOWED_DOMAINS가 타입 드롭다운에 포함됨
- admin 빌드/테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core run build && pnpm --filter @waiaas/core run test` — core 빌드/테스트 통과
2. `pnpm --filter admin run build && pnpm --filter admin run test` — admin 빌드/테스트 통과
3. policies.tsx에서 PolicyFormRouter import, jsonMode 토글, X402_ALLOWED_DOMAINS 드롭다운 확인
4. policy.schema.ts에서 POLICY_RULES_SCHEMAS 맵이 12개 타입 전체를 포함하는지 확인
</verification>

<success_criteria>
- 12개 PolicyType 전체에 Zod rules 스키마가 POLICY_RULES_SCHEMAS에 등록됨
- DynamicRowList 컴포넌트가 존재하고 export됨 (items, onAdd, onRemove, renderRow, onChange props)
- PolicyFormRouter가 타입별 분기 구조를 갖고 있음 (placeholder 상태)
- policies.tsx에 JSON 토글(jsonMode), formRulesObj, formErrors 상태가 있고 PolicyFormRouter를 렌더링함
- X402_ALLOWED_DOMAINS가 정책 타입 드롭다운에 포함됨
- admin + core 빌드/테스트 모두 통과
</success_criteria>

<output>
After completion, create `.planning/phases/134-form-infra-5type-forms/134-01-SUMMARY.md`
</output>
