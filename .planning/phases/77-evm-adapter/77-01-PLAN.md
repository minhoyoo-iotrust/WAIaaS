---
phase: 77-evm-adapter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/adapters/evm/package.json
  - packages/adapters/evm/tsconfig.json
  - packages/adapters/evm/vitest.config.ts
  - packages/adapters/evm/src/index.ts
  - packages/adapters/evm/src/adapter.ts
  - packages/adapters/evm/src/abi/erc20.ts
  - packages/adapters/evm/src/__tests__/evm-adapter.test.ts
autonomous: true

must_haves:
  truths:
    - "@waiaas/adapter-evm 패키지가 monorepo workspace에 등록되고, pnpm install + pnpm turbo build가 성공한다"
    - "EvmAdapter가 IChainAdapter 20개 메서드를 구현하여 타입 에러 없이 인스턴스화된다"
    - "EvmAdapter.connect()가 viem createPublicClient로 RPC 연결하고 isConnected()가 true를 반환한다"
    - "EvmAdapter.getHealth()가 viem getBlockNumber로 RPC 레이턴시와 블록 높이를 반환한다"
    - "EvmAdapter.getBalance()가 viem getBalance로 네이티브 잔액을 조회한다"
    - "ERC20_ABI 상수가 transfer/balanceOf/decimals/symbol/name/approve/allowance 함수를 정의한다"
  artifacts:
    - path: "packages/adapters/evm/package.json"
      provides: "Package manifest with viem 2.x dependency"
      contains: "viem"
    - path: "packages/adapters/evm/src/adapter.ts"
      provides: "EvmAdapter class implementing IChainAdapter"
      exports: ["EvmAdapter"]
    - path: "packages/adapters/evm/src/abi/erc20.ts"
      provides: "ERC-20 ABI constants"
      exports: ["ERC20_ABI"]
    - path: "packages/adapters/evm/src/index.ts"
      provides: "Package barrel export"
      exports: ["EvmAdapter"]
  key_links:
    - from: "packages/adapters/evm/src/adapter.ts"
      to: "@waiaas/core"
      via: "IChainAdapter interface import"
      pattern: "import.*IChainAdapter.*@waiaas/core"
    - from: "packages/adapters/evm/src/adapter.ts"
      to: "viem"
      via: "createPublicClient for RPC connection"
      pattern: "createPublicClient"
---

<objective>
@waiaas/adapter-evm 패키지를 monorepo에 스캐폴딩하고, viem 2.x 기반으로 IChainAdapter 20개 메서드의 기본 구조(connection 4 + balance 1 + pipeline 4 stubs + confirm 1 stub + assets 1 stub + fee 1 stub + token 2 stubs + contract 2 stubs + batch 1 + utility 3)를 구현한다. connect/disconnect/isConnected/getHealth/getBalance 5개 메서드는 실제 viem RPC 호출을 구현하고, 나머지 15개는 Plan 77-02 및 후속 Phase에서 구현할 스텁을 배치한다.

Purpose: EVM 어댑터의 패키지 기반을 확립하여 Phase 77-02(네이티브 전송 + gas + nonce + ERC-20/approve)가 즉시 구현에 착수할 수 있는 상태를 만든다.
Output: @waiaas/adapter-evm 패키지 (빌드 성공 + 기본 테스트 통과)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# SolanaAdapter pattern reference (mirror this structure)
@packages/adapters/solana/package.json
@packages/adapters/solana/tsconfig.json
@packages/adapters/solana/vitest.config.ts
@packages/adapters/solana/src/index.ts
@packages/adapters/solana/src/adapter.ts

# IChainAdapter 20-method interface + types (Phase 76-03 output)
@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/chain-adapter.types.ts

# ChainError class for error handling
@packages/core/src/errors/chain-error.ts

# Chain enums
@packages/core/src/enums/chain.ts

# pnpm workspace config
@pnpm-workspace.yaml
@tsconfig.base.json

# ERC-20 ABI design spec (section 4.2)
@docs/56-token-transfer-extension-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: @waiaas/adapter-evm 패키지 스캐폴딩 + ERC20 ABI + EvmAdapter 20-method skeleton</name>
  <files>
    packages/adapters/evm/package.json
    packages/adapters/evm/tsconfig.json
    packages/adapters/evm/vitest.config.ts
    packages/adapters/evm/src/index.ts
    packages/adapters/evm/src/abi/erc20.ts
    packages/adapters/evm/src/adapter.ts
  </files>
  <action>
    1. **Create package.json** mirroring `@waiaas/adapter-solana` structure:
       - `name`: `@waiaas/adapter-evm`, `version`: `0.0.0`, `type`: `module`
       - `main`, `types`, `exports`, `files`, `scripts` identical to adapter-solana
       - `dependencies`: `@waiaas/core: "workspace:*"`, `viem: "^2.21.0"` (latest 2.x)
       - No devDependencies (vitest inherited from root)

    2. **Create tsconfig.json** mirroring adapter-solana:
       - `extends: "../../../tsconfig.base.json"` (same relative path from packages/adapters/evm/)
       - `compilerOptions`: `outDir: "dist"`, `rootDir: "src"`
       - `references`: `[{ "path": "../../core" }]`
       - `include`: `["src"]`

    3. **Create vitest.config.ts** identical to adapter-solana:
       - `globals: true`, `passWithNoTests: true`

    4. **Create src/abi/erc20.ts** with ERC-20 standard ABI (from design doc 56 section 4.2):
       - `ERC20_ABI` as const array with: `transfer`, `approve`, `balanceOf`, `allowance`, `decimals`, `symbol`, `name`, `totalSupply`
       - Use `as const` for viem type inference (abi parameter requires literal types)
       - Export `ERC20_ABI`

    5. **Create src/adapter.ts** — EvmAdapter class implementing IChainAdapter:
       - Import from viem: `createPublicClient`, `http`, `type PublicClient`, `type Chain`, `type Address`, `formatEther`
       - Import from @waiaas/core: IChainAdapter types + ChainError + WAIaaSError
       - Constructor: `(network: NetworkType, chain?: Chain)` — store chain config (default undefined, used later for EVM chain selection)
       - Private fields: `_client: PublicClient | null`, `_connected: boolean`, `_rpcUrl: string | null`
       - **Connection methods (4 real implementations):**
         - `connect(rpcUrl)`: Create `createPublicClient({ transport: http(rpcUrl), chain: this._chain })`. Set `_connected = true`.
         - `disconnect()`: Set client to null, connected to false.
         - `isConnected()`: Return `_connected`.
         - `getHealth()`: Call `client.getBlockNumber()` with timing. Return `{ healthy: true, latencyMs, blockHeight }`. Catch -> `{ healthy: false, latencyMs: 0 }`.
       - **Balance (1 real implementation):**
         - `getBalance(address)`: Call `client.getBalance({ address })`. Return `{ address, balance, decimals: 18, symbol: 'ETH' }`. Throw WAIaaSError('CHAIN_ERROR') on failure.
       - **Pipeline methods (4 stubs):** buildTransaction, simulateTransaction, signTransaction, submitTransaction — all throw `new Error('Not implemented: {method} will be implemented in Phase 77 Plan 02')`. Use underscore-prefixed params to avoid unused param errors.
       - **Confirmation (1 stub):** waitForConfirmation — throw not implemented.
       - **Assets (1 stub):** getAssets — throw not implemented (Phase 78).
       - **Fee estimation (1 stub):** estimateFee — throw not implemented (Phase 77-02).
       - **Token operations (2 stubs):** buildTokenTransfer, getTokenInfo — throw not implemented (Phase 77-02 for getTokenInfo, Phase 78 for buildTokenTransfer).
       - **Contract operations (2 stubs):** buildContractCall, buildApprove — throw not implemented (Phase 77-02 for buildApprove, Phase 79 for buildContractCall).
       - **Batch (1 real implementation):** buildBatch — throw `new WAIaaSError('BATCH_NOT_SUPPORTED', { message: 'EVM does not support atomic batch transactions. Use Account Abstraction for batching.' })`. BATCH_NOT_SUPPORTED exists in ERROR_CODES (domain TX, httpStatus 400, retryable false).
       - **Utility (3):**
         - `getCurrentNonce(address)`: Call `client.getTransactionCount({ address })`. Return number. (real implementation needed for EVM)
         - `getTransactionFee(_tx)`: Stub, throw not implemented (Phase 77-02).
         - `sweepAll`: Stub, throw not implemented (Phase 80).
       - Private helpers: `ensureConnected()`, `getClient()` — mirror SolanaAdapter pattern.

    6. **Create src/index.ts** barrel export:
       ```typescript
       export { EvmAdapter } from './adapter.js';
       ```

    7. Run `pnpm install` (to link the new workspace package).
    8. Run `pnpm turbo build` to verify full monorepo build succeeds.
    9. Verify `packages/adapters/evm/dist/` contains compiled output.
  </action>
  <verify>
    - `pnpm install` succeeds without errors
    - `pnpm turbo build` succeeds (all packages including adapter-evm)
    - `ls packages/adapters/evm/dist/` shows compiled .js and .d.ts files
    - No TypeScript type errors (IChainAdapter contract satisfied)
  </verify>
  <done>
    @waiaas/adapter-evm package exists in monorepo with viem 2.x dependency. EvmAdapter implements IChainAdapter 20-method contract (5 real + 15 stubs). Build passes. ERC20_ABI constant available.
  </done>
</task>

<task type="auto">
  <name>Task 2: EvmAdapter 기본 메서드 테스트 + getCurrentNonce 테스트</name>
  <files>
    packages/adapters/evm/src/__tests__/evm-adapter.test.ts
  </files>
  <action>
    Create test file `packages/adapters/evm/src/__tests__/evm-adapter.test.ts`:

    **Test structure** (mirror adapter-solana test patterns):

    1. **IChainAdapter 인터페이스 준수 테스트 (3 tests):**
       - `EvmAdapter implements IChainAdapter` — instanceof check, chain='ethereum', network matches constructor arg
       - `EvmAdapter has all 20 IChainAdapter methods` — iterate expected method names, assert typeof === 'function'
       - `ERC20_ABI has required functions` — check transfer, approve, balanceOf, allowance, decimals, symbol, name entries

    2. **Connection 테스트 (4 tests):**
       - `isConnected() returns false before connect()` — new EvmAdapter, check false
       - `connect() creates viem PublicClient and sets connected` — mock is difficult for viem, so test via isConnected() state
       - `disconnect() sets connected to false` — connect then disconnect, check isConnected()
       - `methods throw when not connected` — getBalance on disconnected adapter should throw ADAPTER_NOT_AVAILABLE

    3. **Stub 메서드 테스트 (5 tests):**
       - `buildTransaction throws not implemented` — call with dummy params, expect Error('Not implemented')
       - `simulateTransaction throws not implemented`
       - `buildBatch throws BATCH_NOT_SUPPORTED` — call buildBatch, expect WAIaaSError with code BATCH_NOT_SUPPORTED
       - `sweepAll throws not implemented`
       - `buildTokenTransfer throws not implemented`

    4. **getCurrentNonce 실제 구현 테스트는 Phase 77-02에서 viem mock과 함께 구현** (RPC 의존이므로 여기서는 연결 안 된 상태에서 에러 체크만):
       - `getCurrentNonce throws when not connected`

    **Important notes:**
    - viem의 PublicClient는 내부적으로 RPC 호출을 하므로, 단위 테스트에서 실제 RPC 연결 없이 테스트하려면 mock이 필요하다. 이 Plan에서는 연결 상태 관리, 인터페이스 준수, 스텁 에러 동작만 테스트한다.
    - RPC 의존 메서드(getHealth, getBalance, getCurrentNonce 실제 호출)는 Plan 77-02에서 vi.mock('viem')으로 테스트한다.
    - `import { EvmAdapter } from '../adapter.js'` 사용 (ESM .js extension)
    - `import { WAIaaSError } from '@waiaas/core'` for error assertion

    Run: `pnpm --filter @waiaas/adapter-evm test`
  </action>
  <verify>
    - `pnpm --filter @waiaas/adapter-evm test` — all tests pass
    - `pnpm turbo build` still succeeds after test file added
    - No import resolution errors
  </verify>
  <done>
    EvmAdapter has ~12 unit tests covering: IChainAdapter interface compliance, connection state management, stub method errors, buildBatch BATCH_NOT_SUPPORTED. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` runs without errors
2. `pnpm turbo build` — all packages build (including new adapter-evm)
3. `pnpm --filter @waiaas/adapter-evm test` — all tests pass
4. `ls packages/adapters/evm/dist/` shows adapter.js, adapter.d.ts, index.js, index.d.ts, abi/erc20.js, abi/erc20.d.ts
5. No TypeScript errors in any package
</verification>

<success_criteria>
- @waiaas/adapter-evm package registered in pnpm workspace and builds successfully
- EvmAdapter class implements IChainAdapter 20-method contract with zero type errors
- viem 2.x is installed as dependency
- ERC20_ABI constant exported with standard ERC-20 function signatures
- Connection methods (connect/disconnect/isConnected/getHealth) use viem createPublicClient
- getBalance uses viem getBalance
- getCurrentNonce uses viem getTransactionCount
- buildBatch throws BATCH_NOT_SUPPORTED WAIaaSError
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/77-evm-adapter/77-01-SUMMARY.md`
</output>
