---
phase: 33-정책-다운그레이드-알림-설계
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/33-time-lock-approval-mechanism.md
autonomous: true

must_haves:
  truths:
    - "evaluate() Step 9 이후, Step 10 전에 APPROVAL->DELAY 다운그레이드 삽입 지점(Step 9.5)이 명세되어 있다"
    - "OwnerState가 NONE 또는 GRACE일 때 APPROVAL이 DELAY로 다운그레이드되고, LOCKED일 때 정상 APPROVAL로 처리된다"
    - "evaluateBatch()의 합산 티어 결정에도 동일한 다운그레이드 로직이 적용된다"
    - "다운그레이드 시 delaySeconds가 SPENDING_LIMIT 규칙의 delay_seconds로 설정되고, 없으면 300초 fallback이 명세되어 있다"
    - "Owner 등록+LOCKED 이후 동일 금액 거래가 정상 APPROVAL 흐름으로 처리되는 경로가 명세되어 있다"
  artifacts:
    - path: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      provides: "Step 9.5 다운그레이드 로직, evaluateBatch 다운그레이드, evaluate 시그니처 확장, 감사 로그, 정상 APPROVAL 복원 흐름"
      contains: "Step 9.5"
  key_links:
    - from: "evaluate() Step 9.5"
      to: "resolveOwnerState()"
      via: "OwnerState 산출"
      pattern: "resolveOwnerState.*NONE.*GRACE"
    - from: "evaluate() Step 9.5"
      to: "PolicyDecision.downgraded"
      via: "다운그레이드 플래그 설정"
      pattern: "downgraded.*true.*originalTier.*APPROVAL"
    - from: "evaluateBatch()"
      to: "Step 9.5"
      via: "합산 티어 다운그레이드"
      pattern: "evaluateBatch.*downgraded"
---

<objective>
DatabasePolicyEngine.evaluate()에 Step 9.5 APPROVAL->DELAY 다운그레이드 로직을 설계하고, evaluateBatch()에도 동일 로직을 적용하며, evaluate() 시그니처 확장 + TX_DOWNGRADED 감사 로그 + Owner LOCKED 후 정상 APPROVAL 복원 흐름을 명세한다.

Purpose: Owner 없는(NONE) 또는 미검증(GRACE) 에이전트의 APPROVAL 거래가 차단되지 않고 DELAY로 대체 실행되어, 에이전트 자율성을 유지하면서 보안을 점진적으로 해금하는 핵심 메커니즘을 확정한다.
Output: 33-time-lock-approval-mechanism.md에 Step 9.5 섹션 + evaluateBatch 다운그레이드 + evaluate 시그니처 확장 + 감사 로그 + 정상 APPROVAL 복원 흐름이 추가된다.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/deliverables/32-transaction-pipeline-api.md
@.planning/phases/31-데이터-모델-타입-기반-설계/31-01-SUMMARY.md
@.planning/phases/31-데이터-모델-타입-기반-설계/31-02-SUMMARY.md
@.planning/phases/33-정책-다운그레이드-알림-설계/33-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: evaluate() Step 9.5 다운그레이드 로직 + evaluate() 시그니처 확장 설계</name>
  <files>.planning/deliverables/33-time-lock-approval-mechanism.md</files>
  <action>
33-time-lock-approval-mechanism.md에 다음 내용을 추가한다. 기존 섹션 구조를 파악하여 적절한 위치에 삽입한다.

**1. evaluate() 시그니처 v0.8 확장 (기존 evaluate 명세 근처)**

현재 evaluate() 시그니처에 optional 파라미터를 추가하는 설계를 명세한다:
- 현재: `evaluate(agentId: string, request: TxRequest): Promise<PolicyDecision>`
- v0.8: `evaluate(agentId: string, request: TxRequest, agentOwnerInfo?: AgentOwnerInfo): Promise<PolicyDecision>`
- `agentOwnerInfo`는 optional로 IPolicyEngine 인터페이스 하위 호환성 유지
- DatabasePolicyEngine 구현체에서 agentOwnerInfo가 undefined이면 내부에서 DB 조회
- Stage 3(Policy Evaluate)에서 이미 agent를 DB에서 로드하므로 전달이 자연스러움
- **IPolicyEngine 인터페이스 자체는 변경하지 않는다** -- DatabasePolicyEngine의 evaluate() 오버라이드에서 처리

**2. [v0.8] Step 9.5: OwnerState 기반 APPROVAL -> DELAY 다운그레이드 (신규 섹션)**

기존 evaluate() 11단계 알고리즘 설명 내에서 Step 9(SPENDING_LIMIT) 이후, Step 10(APPROVE_TIER_OVERRIDE) 전에 Step 9.5를 삽입한다:

삽입 지점과 로직:
```
Step 9:  SPENDING_LIMIT (금액 기반 티어 결정, USD dual 평가)
--- [v0.8] Step 9.5: APPROVAL -> DELAY 다운그레이드 ---
Step 10: APPROVE_TIER_OVERRIDE (APPROVE 전용)
```

Step 9.5 의사코드:
```typescript
// [v0.8] Step 9.5: OwnerState 기반 APPROVAL -> DELAY 다운그레이드
if (tierResult.allowed && tierResult.tier === 'APPROVAL') {
  const ownerInfo = agentOwnerInfo ?? await this.loadAgentOwnerInfo(agentId)
  const ownerState = resolveOwnerState(ownerInfo)
  if (ownerState !== 'LOCKED') {
    // NONE 또는 GRACE: Owner 승인 불가 -> DELAY로 다운그레이드
    const spendingRule = effectiveRules.find(r => r.type === 'SPENDING_LIMIT')
    const config = spendingRule ? JSON.parse(spendingRule.rules) : {}
    return {
      allowed: true,
      tier: 'DELAY',
      delaySeconds: config.delay_seconds ?? 300,  // 규칙의 delay_seconds 우선, fallback 300초(5분)
      downgraded: true,
      originalTier: 'APPROVAL',
    }
  }
  // ownerState === 'LOCKED': 다운그레이드 안 함 -> 정상 APPROVAL 진행
}
// Step 10으로 계속... (downgraded 시 여기 도달하지 않으므로 Step 10 스킵)
```

핵심 설계 사항을 다음 테이블로 명시:

| 항목 | 값 | 근거 |
|------|-----|------|
| 삽입 지점 | Step 9 이후, Step 10 전 | Step 9가 최종 tier를 결정하는 시점 |
| 다운그레이드 대상 OwnerState | NONE, GRACE | NONE=Owner 미등록, GRACE=ownerAuth 미사용 (승인 불가) |
| delaySeconds 결정 | SPENDING_LIMIT의 delay_seconds 우선 | APPROVAL 규칙에 delay_seconds가 없을 수 있으므로 fallback 300초 |
| delaySeconds 최소값 | 60초 | 0초면 INSTANT과 동일하여 보안 의미 없음 |
| APPROVE 트랜잭션 처리 | 동일하게 다운그레이드 | APPROVE도 Owner 서명이 필요한 APPROVAL이면 다운그레이드 |
| Step 10 스킵 | return으로 즉시 반환 | 다운그레이드 후 APPROVE_TIER_OVERRIDE가 DELAY를 APPROVAL로 복원하는 것 방지 |

안티패턴 주의사항:
- evaluate() 외부(Stage 4 등)에서 다운그레이드하지 않는다 -- PolicyDecision SSoT 유지
- GRACE 상태에서 APPROVAL 허용하지 않는다 -- ownerAuth 미사용 상태에서 승인 불가
- delaySeconds를 0으로 설정하지 않는다 -- 최소 60초 보장

**3. TX_DOWNGRADED 감사 로그 이벤트 명세**

기존 감사 로그 섹션(또는 관련 테이블)에 TX_DOWNGRADED 이벤트를 추가:
- event_type: `TX_DOWNGRADED`
- severity: `info`
- details: `{ originalTier: 'APPROVAL', downgradedTier: 'DELAY', ownerState: 'NONE'|'GRACE', reason: 'OWNER_NOT_LOCKED', agentId: string, txId: string, amount: string }`
- 기록 시점: Stage 4에서 다운그레이드된 PolicyDecision을 처리할 때 (QUEUED 전이 직후)
- 별도 이벤트 타입으로 추가하여 audit_log 쿼리에서 다운그레이드 빈도를 직접 집계 가능

감사 이벤트 테이블이 있다면 해당 테이블에 행 추가. 없다면 적절한 위치에 명시.
  </action>
  <verify>
33-time-lock-approval-mechanism.md에서 다음을 확인:
1. "Step 9.5" 문자열이 존재한다
2. resolveOwnerState 호출 + NONE/GRACE 분기가 명세되어 있다
3. delaySeconds fallback 300초가 명세되어 있다
4. evaluate() 시그니처에 agentOwnerInfo optional 파라미터가 명세되어 있다
5. TX_DOWNGRADED 감사 로그 이벤트가 명세되어 있다
6. Step 10 스킵 메커니즘(return)이 명세되어 있다
  </verify>
  <done>
evaluate() Step 9.5 다운그레이드 로직이 삽입 지점, 분기 조건, delaySeconds 결정, 안티패턴과 함께 완전하게 명세되어 있고, evaluate() 시그니처 확장과 TX_DOWNGRADED 감사 로그가 정의되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: evaluateBatch() 다운그레이드 + Owner LOCKED 후 정상 APPROVAL 복원 흐름 명세</name>
  <files>.planning/deliverables/33-time-lock-approval-mechanism.md</files>
  <action>
33-time-lock-approval-mechanism.md에 다음 내용을 추가한다.

**1. evaluateBatch() 합산 티어 다운그레이드 (기존 evaluateBatch 명세 근처)**

evaluateBatch()의 최종 합산 PolicyDecision 반환 전에 동일한 Step 9.5 다운그레이드 로직을 적용하는 설계를 명세한다:

```typescript
// evaluateBatch() 합산 결과에 Step 9.5 적용
async function evaluateBatch(
  agentId: string,
  instructions: TxRequest[],
  agentOwnerInfo?: AgentOwnerInfo,
): Promise<PolicyDecision> {
  // ... 기존 개별 instruction 평가 + 합산 tiering ...

  const sumTierDecision = this.evaluateSpendingLimit(effectiveRules, {
    amount: totalAmount.toString(),
    // ...
  })

  // [v0.8] 합산 결과에도 Step 9.5 다운그레이드 적용
  if (sumTierDecision.allowed && sumTierDecision.tier === 'APPROVAL') {
    const ownerInfo = agentOwnerInfo ?? await this.loadAgentOwnerInfo(agentId)
    const ownerState = resolveOwnerState(ownerInfo)
    if (ownerState !== 'LOCKED') {
      const spendingRule = effectiveRules.find(r => r.type === 'SPENDING_LIMIT')
      const config = spendingRule ? JSON.parse(spendingRule.rules) : {}
      return {
        allowed: true,
        tier: 'DELAY',
        delaySeconds: config.delay_seconds ?? 300,
        downgraded: true,
        originalTier: 'APPROVAL',
      }
    }
  }

  return sumTierDecision
}
```

핵심:
- evaluateBatch()에도 agentOwnerInfo optional 파라미터를 동일하게 추가
- 개별 instruction 평가는 개별 instruction의 tier만 결정 (다운그레이드 불필요)
- 합산 tierDecision이 APPROVAL일 때만 다운그레이드 적용
- 다운그레이드를 중복 적용하지 않도록 evaluateBatch 내부에서만 1회 적용

**2. [v0.8] Owner LOCKED 후 정상 APPROVAL 복원 흐름 (신규 섹션)**

Owner가 등록되고 LOCKED 상태가 된 이후 동일 금액 거래가 정상 APPROVAL로 처리되는 전체 흐름을 단계별로 명세한다:

```
[Owner LOCKED 후 정상 APPROVAL 흐름]

1. 에이전트 A에 Owner 등록: set-owner → OwnerState: NONE → GRACE
2. ownerAuth 최초 사용 (예: 다른 APPROVAL 승인, set-owner 변경 등)
   → Step 8.5에서 markOwnerVerified() 호출
   → OwnerState: GRACE → LOCKED
3. 대액 거래 요청 (예: 15 SOL 전송)
   → evaluate() Step 9: SPENDING_LIMIT에서 APPROVAL 결정
   → evaluate() Step 9.5: ownerState === LOCKED → 다운그레이드 스킵
   → evaluate() Step 10: (APPROVE가 아닌 TRANSFER이므로 해당 없음) → 스킵
   → evaluate() Step 11: PolicyDecision { tier: 'APPROVAL', downgraded: undefined }
4. Stage 4: APPROVAL 큐잉 → TX_APPROVAL_REQUEST 알림 전송
5. Owner가 ownerAuth로 승인 → 거래 실행
```

GRACE에서 다운그레이드되는 케이스도 병렬로 명시:
```
[GRACE 상태에서 다운그레이드 흐름]

1. 에이전트 A에 Owner 등록: set-owner → GRACE
2. 대액 거래 요청 (15 SOL)
   → evaluate() Step 9.5: ownerState === GRACE → 다운그레이드
   → PolicyDecision { tier: 'DELAY', downgraded: true, originalTier: 'APPROVAL' }
3. Stage 4: DELAY 큐잉 → TX_DOWNGRADED_DELAY 알림 (Owner 등록 안내 포함)
4. delaySeconds 후 자동 실행
```

**3. Stage 4 다운그레이드 분기 상세화 (선택적)**

기존 Stage 4 명세에 다운그레이드된 PolicyDecision 처리 분기를 추가한다:

```typescript
// Stage 4: DELAY 큐잉 시 다운그레이드 정보 저장
case 'DELAY':
  validateTransition('PENDING', 'QUEUED')
  await db.update(transactions).set({
    tier: 'DELAY',
    status: 'QUEUED',
    queuedAt: now,
    metadata: JSON.stringify({
      expiresAt: ...,
      delaySeconds: decision.delaySeconds ?? 300,
      // [v0.8] 다운그레이드 정보
      downgraded: decision.downgraded ?? false,
      originalTier: decision.originalTier,
    }),
  }).where(eq(transactions.id, txId))

  // [v0.8] 다운그레이드 감사 로그
  if (decision.downgraded) {
    await auditLog.insert({
      eventType: 'TX_DOWNGRADED',
      severity: 'info',
      agentId,
      details: JSON.stringify({
        txId,
        originalTier: 'APPROVAL',
        downgradedTier: 'DELAY',
        ownerState,
        reason: 'OWNER_NOT_LOCKED',
      }),
    })
  }

  // [v0.8] 알림 분기: downgraded이면 TX_DOWNGRADED_DELAY, 아니면 TX_DELAY_QUEUED
  const notifEvent = decision.downgraded
    ? 'TX_DOWNGRADED_DELAY'
    : 'TX_DELAY_QUEUED'
  notificationService.notify({ event: notifEvent, ... })
```

이 Stage 4 확장은 33-time-lock-approval-mechanism.md의 기존 Stage 4 설명 근처에 [v0.8] 태그로 추가한다.
  </action>
  <verify>
33-time-lock-approval-mechanism.md에서 다음을 확인:
1. evaluateBatch()에 agentOwnerInfo 파라미터와 Step 9.5 다운그레이드가 명세되어 있다
2. "Owner LOCKED 후 정상 APPROVAL 흐름" 또는 유사한 제목의 섹션이 있다
3. GRACE 상태에서 다운그레이드되는 흐름이 명세되어 있다
4. Stage 4 다운그레이드 분기(downgraded === true 시 TX_DOWNGRADED_DELAY 알림)가 명세되어 있다
5. metadata에 downgraded/originalTier 저장이 명세되어 있다
  </verify>
  <done>
evaluateBatch() 합산 다운그레이드가 명세되고, Owner LOCKED 후 정상 APPROVAL 복원 흐름과 GRACE 다운그레이드 흐름이 단계별로 기술되어 있으며, Stage 4 다운그레이드 분기와 감사 로그 기록이 완전하게 명세되어 있다.
  </done>
</task>

</tasks>

<verification>
Phase 33 Plan 01 전체 검증:
1. `grep -c "Step 9.5" .planning/deliverables/33-time-lock-approval-mechanism.md` -- Step 9.5가 2회 이상 등장 (evaluate + evaluateBatch)
2. `grep "downgraded.*true" .planning/deliverables/33-time-lock-approval-mechanism.md` -- 다운그레이드 플래그 설정이 명세됨
3. `grep "resolveOwnerState" .planning/deliverables/33-time-lock-approval-mechanism.md` -- resolveOwnerState 호출이 명세됨
4. `grep "TX_DOWNGRADED" .planning/deliverables/33-time-lock-approval-mechanism.md` -- 감사 로그 이벤트가 명세됨
5. `grep "agentOwnerInfo" .planning/deliverables/33-time-lock-approval-mechanism.md` -- 시그니처 확장이 명세됨
6. `grep "LOCKED.*APPROVAL" .planning/deliverables/33-time-lock-approval-mechanism.md` -- LOCKED 후 정상 APPROVAL 경로가 명세됨
</verification>

<success_criteria>
- POLICY-01 충족: Owner 없는 에이전트의 APPROVAL이 DELAY로 다운그레이드되어 실행되는 로직이 명세됨
- POLICY-02 충족: downgraded: true 플래그가 포함되어 알림 분기 조건이 명세됨
- POLICY-03 충족: Owner LOCKED 후 동일 금액 거래가 정상 APPROVAL로 처리되는 흐름이 명세됨
- evaluate() Step 9.5 삽입 지점이 Step 9/Step 10 사이에 명확히 위치함
- evaluateBatch()에도 동일 다운그레이드가 적용됨
- TX_DOWNGRADED 감사 로그 이벤트가 정의됨
- delaySeconds fallback (300초)와 최소값 (60초)이 명세됨
</success_criteria>

<output>
After completion, create `.planning/phases/33-정책-다운그레이드-알림-설계/33-01-SUMMARY.md`
</output>
