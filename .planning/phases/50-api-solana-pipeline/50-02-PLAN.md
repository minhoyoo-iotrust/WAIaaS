---
phase: 50-api-solana-pipeline
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/adapters/solana/package.json
  - packages/adapters/solana/src/index.ts
  - packages/adapters/solana/src/adapter.ts
  - packages/adapters/solana/src/__tests__/solana-adapter.test.ts
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "SolanaAdapter implements IChainAdapter with chain='solana'"
    - "connect() establishes RPC connection and isConnected() returns true"
    - "getBalance() returns lamports balance for a Solana address"
    - "buildTransaction() creates an unsigned SOL transfer transaction"
    - "simulateTransaction() validates transaction without submitting"
    - "signTransaction() signs with Ed25519 private key"
    - "submitTransaction() sends signed tx to blockchain"
    - "waitForConfirmation() polls until confirmed status"
  artifacts:
    - path: "packages/adapters/solana/src/adapter.ts"
      provides: "SolanaAdapter class implementing IChainAdapter"
      exports: ["SolanaAdapter"]
    - path: "packages/adapters/solana/src/index.ts"
      provides: "Re-export of SolanaAdapter"
  key_links:
    - from: "packages/adapters/solana/src/adapter.ts"
      to: "@waiaas/core IChainAdapter"
      via: "implements IChainAdapter"
      pattern: "implements IChainAdapter"
    - from: "packages/adapters/solana/src/adapter.ts"
      to: "@solana/kit"
      via: "createSolanaRpc, pipe, getTransferSolInstruction"
      pattern: "import.*@solana/kit"
---

<objective>
Implement SolanaAdapter with 10 IChainAdapter methods using @solana/kit 3.x functional pipe pattern.

Purpose: Provides the blockchain execution engine for Solana SOL transfers. The adapter translates chain-agnostic TransferRequest into Solana-specific RPC calls.
Output: SolanaAdapter class, tests with mock RPC.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key references:
- packages/core/src/interfaces/IChainAdapter.ts — 10-method interface contract
- packages/core/src/interfaces/chain-adapter.types.ts — TransferRequest, UnsignedTransaction, SimulationResult, SubmitResult, BalanceInfo, HealthInfo
- packages/core/src/enums/chain.ts — ChainType, NetworkType
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @solana/kit and implement SolanaAdapter</name>
  <files>
    packages/adapters/solana/package.json
    packages/adapters/solana/src/adapter.ts
    packages/adapters/solana/src/index.ts
    pnpm-lock.yaml
  </files>
  <action>
1. Install @solana/kit:
   ```
   cd packages/adapters/solana && pnpm add @solana/kit
   ```
   Note: @solana/kit 3.x is a meta-package that re-exports @solana/rpc, @solana/transactions, @solana/addresses, @solana/signers, etc.

2. Create `packages/adapters/solana/src/adapter.ts`:

```typescript
import type {
  IChainAdapter,
  ChainType,
  NetworkType,
  TransferRequest,
  UnsignedTransaction,
  SimulationResult,
  SubmitResult,
  BalanceInfo,
  HealthInfo,
} from '@waiaas/core';
import { WAIaaSError } from '@waiaas/core';
```

3. Implement SolanaAdapter class:

**Constructor:**
- Takes `chain: 'solana'` and `network: NetworkType`
- Stores rpcUrl, rpc client, connected state

**connect(rpcUrl: string):**
- Use `createSolanaRpc(rpcUrl)` from @solana/kit to create RPC client
- Store rpcUrl and mark connected
- NOTE: @solana/kit 3.x uses functional API, not class-based Connection

**disconnect():**
- Clear rpc reference, mark not connected

**isConnected():**
- Return boolean from internal state

**getHealth():**
- Call `rpc.getHealth().send()` or `rpc.getSlot().send()` to check RPC
- Measure latency with Date.now() before/after
- Return HealthInfo { healthy, latencyMs, blockHeight }
- On error: return { healthy: false, latencyMs: 0 }

**getBalance(address: string):**
- Use `rpc.getBalance(address as Address).send()`
- Returns BalanceInfo { address, balance: BigInt(lamports), decimals: 9, symbol: 'SOL' }
- Wrap RPC errors in WAIaaSError('CHAIN_ERROR')

**buildTransaction(request: TransferRequest):**
- Use @solana/kit 3.x pipe pattern:
  1. `createTransactionMessage({ version: 0 })` - create v0 transaction message
  2. `setTransactionMessageFeePayer(fromAddress, msg)` - set fee payer
  3. `appendTransactionMessageInstruction(transferSolInstruction, msg)` - add SOL transfer
  4. `setTransactionMessageLifetimeUsingBlockhash(blockhash, msg)` - set blockhash lifetime
- For the transfer instruction, use `getTransferSolInstruction({ source, destination, amount: lamports })` from `@solana-program/system`
- @solana/kit 3.x re-exports this or you may need `@solana-program/system` separately
- Get latest blockhash via `rpc.getLatestBlockhash().send()`
- Serialize the message using `getCompiledTransactionMessageEncoder().encode(msg)` or equivalent
- Return UnsignedTransaction with serialized bytes, estimated fee (5000 lamports default for SOL transfer), expiry from blockhash, metadata with lastValidBlockHeight

IMPORTANT: @solana/kit 3.x API is functional, not OOP. Study the actual @solana/kit exports carefully. Key differences from @solana/web3.js 1.x:
- No `Connection` class — use `createSolanaRpc(url)`
- No `Transaction` class — use `createTransactionMessage()` + pipe
- No `SystemProgram.transfer()` — use `getTransferSolInstruction()` from @solana-program/system
- Addresses are branded types: `address("base58string")`
- Everything returns codec encoders/decoders

If @solana-program/system is not bundled with @solana/kit, install it separately:
```
pnpm add @solana-program/system
```

**simulateTransaction(tx: UnsignedTransaction):**
- Use `rpc.simulateTransaction(base64EncodedTx, { encoding: 'base64' }).send()`
- Return SimulationResult { success, logs, unitsConsumed, error }

**signTransaction(tx: UnsignedTransaction, privateKey: Uint8Array):**
- Create a CryptoKeyPair or use Ed25519 sign directly
- The privateKey from keystore is 64 bytes (Ed25519 secret + public)
- Use @solana/kit's signing utilities or directly sign the serialized message
- Return the signed transaction bytes

**submitTransaction(signedTx: Uint8Array):**
- Use `rpc.sendTransaction(base64Encoded, { encoding: 'base64' }).send()`
- Return SubmitResult { txHash: signature, status: 'submitted' }

**waitForConfirmation(txHash: string, timeoutMs = 30000):**
- Poll `rpc.getSignatureStatuses([txHash]).send()` every 2 seconds
- Check for confirmationStatus 'confirmed' or 'finalized'
- On timeout: return { txHash, status: 'submitted' } (not confirmed yet)
- On confirmed: return { txHash, status: 'confirmed', confirmations }
- Use WAIaaSError('CHAIN_ERROR') for RPC failures

4. Update `packages/adapters/solana/src/index.ts`:
   - Export SolanaAdapter class

CRITICAL NOTES:
- @solana/kit 3.x is significantly different from @solana/web3.js 1.x. The executor MUST check actual @solana/kit 3.x API before implementing. Use `node_modules/@solana/kit` to verify exports.
- All RPC calls are `rpc.method(params).send()` pattern (returns promise)
- Addresses use `address()` factory from @solana/addresses (re-exported by @solana/kit)
- Transaction message is built functionally with pipe() or sequential function calls
- If exact API differs from plan, adapt while maintaining IChainAdapter contract
  </action>
  <verify>
    - `pnpm build --filter=@waiaas/adapter-solana` succeeds
    - `pnpm typecheck --filter=@waiaas/adapter-solana` succeeds
    - SolanaAdapter correctly implements IChainAdapter interface (TypeScript enforces all 10 methods)
  </verify>
  <done>
    - SolanaAdapter class implements all 10 IChainAdapter methods
    - Uses @solana/kit 3.x functional API (not deprecated @solana/web3.js 1.x)
    - All RPC errors wrapped in WAIaaSError('CHAIN_ERROR')
  </done>
</task>

<task type="auto">
  <name>Task 2: SolanaAdapter unit tests with mock RPC</name>
  <files>
    packages/adapters/solana/src/__tests__/solana-adapter.test.ts
  </files>
  <action>
1. Create test file that mocks @solana/kit RPC calls.

2. Mock strategy:
   - Mock `createSolanaRpc` to return a fake RPC object
   - Each RPC method (getBalance, getLatestBlockhash, simulateTransaction, sendTransaction, getSignatureStatuses, getSlot) returns a mock `.send()` result
   - This avoids real network calls while testing adapter logic

3. Test categories:

**Connection management (4 tests):**
- connect() stores RPC URL and isConnected returns true
- disconnect() clears state and isConnected returns false
- getHealth() returns healthy:true with latencyMs when RPC responds
- getHealth() returns healthy:false when RPC throws

**Balance query (2 tests):**
- getBalance() returns correct lamports value from mock RPC
- getBalance() wraps RPC error in WAIaaSError('CHAIN_ERROR')

**Build transaction (2 tests):**
- buildTransaction() returns UnsignedTransaction with serialized bytes
- buildTransaction() includes blockhash metadata and expiresAt

**Simulate (2 tests):**
- simulateTransaction() returns success:true with logs
- simulateTransaction() returns success:false with error message on sim failure

**Sign (1 test):**
- signTransaction() returns signed bytes (verify signature is appended)

**Submit + confirm (3 tests):**
- submitTransaction() returns SubmitResult with txHash and status 'submitted'
- waitForConfirmation() resolves to 'confirmed' when RPC returns confirmed status
- waitForConfirmation() handles timeout gracefully

**Error handling (2 tests):**
- All methods throw WAIaaSError when adapter not connected (ADAPTER_NOT_AVAILABLE)
- RPC network errors wrapped in CHAIN_ERROR

Target: 16 tests minimum.

NOTE: Since @solana/kit 3.x API may differ from expectations, the executor should adapt mock shapes to match actual API. The key goal is: SolanaAdapter methods produce correct outputs given mock RPC inputs.
  </action>
  <verify>
    - `pnpm test --filter=@waiaas/adapter-solana` passes all tests
    - No real network calls made during tests (all mocked)
  </verify>
  <done>
    - 16+ tests covering all 10 IChainAdapter methods
    - Mock RPC pattern established for future test expansion
    - Error handling verified (CHAIN_ERROR wrapping, not-connected guard)
  </done>
</task>

</tasks>

<verification>
- `pnpm build --filter=@waiaas/adapter-solana` succeeds
- `pnpm test --filter=@waiaas/adapter-solana` passes all 16+ tests
- `pnpm lint --filter=@waiaas/adapter-solana` passes
- SolanaAdapter correctly implements IChainAdapter (TypeScript compile = proof)
- No dependency on @solana/web3.js 1.x (only @solana/kit 3.x)
</verification>

<success_criteria>
SolanaAdapter with all 10 IChainAdapter methods is implemented and tested with mock RPC, ready for integration with the transaction pipeline in Plan 50-04.
</success_criteria>

<output>
After completion, create `.planning/phases/50-api-solana-pipeline/50-02-SUMMARY.md`
</output>
