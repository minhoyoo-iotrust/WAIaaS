---
phase: 50-api-solana-pipeline
plan: 04
type: tdd
wave: 3
depends_on: ["50-02", "50-03"]
files_modified:
  - packages/daemon/src/pipeline/pipeline.ts
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/pipeline/default-policy-engine.ts
  - packages/daemon/src/pipeline/index.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/index.ts
  - packages/daemon/src/__tests__/pipeline.test.ts
  - packages/daemon/src/__tests__/api-transactions.test.ts
autonomous: true

must_haves:
  truths:
    - "POST /v1/transactions/send accepts SOL transfer request and returns 201 with transaction ID"
    - "GET /v1/transactions/:id returns transaction status with all expected fields"
    - "Pipeline Stage 1 validates request with Zod and INSERTs PENDING transaction into DB"
    - "Pipeline Stage 3 uses DefaultPolicyEngine returning INSTANT tier"
    - "Pipeline Stage 5 calls adapter build->simulate->sign->submit in sequence"
    - "Pipeline Stage 6 calls waitForConfirmation and updates DB to CONFIRMED or FAILED"
    - "Invalid send request returns 400 with Zod validation error"
    - "Transaction for non-existent agent returns 404"
  artifacts:
    - path: "packages/daemon/src/pipeline/pipeline.ts"
      provides: "TransactionPipeline class with executeSend() method"
      exports: ["TransactionPipeline"]
    - path: "packages/daemon/src/pipeline/stages.ts"
      provides: "6 stage functions (validate, auth, policy, wait, execute, confirm)"
    - path: "packages/daemon/src/pipeline/default-policy-engine.ts"
      provides: "DefaultPolicyEngine implementing IPolicyEngine (INSTANT passthrough)"
      exports: ["DefaultPolicyEngine"]
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "POST /v1/transactions/send and GET /v1/transactions/:id routes"
      exports: ["transactionRoutes"]
  key_links:
    - from: "packages/daemon/src/pipeline/pipeline.ts"
      to: "packages/daemon/src/pipeline/stages.ts"
      via: "Sequential stage execution"
      pattern: "stage[1-6]"
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "IChainAdapter"
      via: "Stage 5 calls build/simulate/sign/submit"
      pattern: "adapter\\.(build|simulate|sign|submit)"
    - from: "packages/daemon/src/api/routes/transactions.ts"
      to: "packages/daemon/src/pipeline/pipeline.ts"
      via: "POST /v1/transactions/send calls pipeline.executeSend()"
      pattern: "pipeline\\.executeSend"
---

<objective>
Implement the 6-stage transaction pipeline and transaction API routes (send + status query).

Purpose: Completes the SOL transfer flow end-to-end: API receives send request, pipeline validates/authorizes/executes on-chain, and status is queryable.
Output: TransactionPipeline, DefaultPolicyEngine, transaction routes, tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-api-solana-pipeline/50-01-SUMMARY.md
@.planning/phases/50-api-solana-pipeline/50-02-SUMMARY.md
@.planning/phases/50-api-solana-pipeline/50-03-SUMMARY.md

Key references:
- packages/core/src/schemas/transaction.schema.ts — SendTransactionRequestSchema, TransactionSchema
- packages/core/src/interfaces/IChainAdapter.ts — 4-stage pipeline (build/simulate/sign/submit)
- packages/core/src/interfaces/IPolicyEngine.ts — IPolicyEngine.evaluate()
- packages/daemon/src/infrastructure/database/schema.ts — transactions table
- packages/daemon/src/infrastructure/database/id.ts — generateId()
- packages/daemon/src/infrastructure/keystore/keystore.ts — decryptPrivateKey, releaseKey
</context>

<tasks>

<task type="auto">
  <name>Task 1: 6-stage pipeline + DefaultPolicyEngine + transaction routes</name>
  <files>
    packages/daemon/src/pipeline/pipeline.ts
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/pipeline/default-policy-engine.ts
    packages/daemon/src/pipeline/index.ts
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/index.ts
  </files>
  <action>
1. Create `packages/daemon/src/pipeline/default-policy-engine.ts`:
   - Implements IPolicyEngine from @waiaas/core
   - evaluate() always returns: { tier: 'INSTANT', allowed: true }
   - v1.1: no policy rules, all transactions pass through instantly

2. Create `packages/daemon/src/pipeline/stages.ts`:
   - Define PipelineContext type with all dependencies and state:
   ```typescript
   interface PipelineContext {
     // Dependencies
     db: DrizzleDb;
     adapter: IChainAdapter;
     keyStore: LocalKeyStore;
     policyEngine: IPolicyEngine;
     masterPassword: string;
     // Request data
     agentId: string;
     agent: { publicKey: string; chain: string; network: string };
     request: SendTransactionRequest;
     // State accumulated through stages
     txId: string;
     tier?: PolicyTier;
     unsignedTx?: UnsignedTransaction;
     signedTx?: Uint8Array;
     submitResult?: SubmitResult;
   }
   ```

   **Stage 1: Validate + DB INSERT**
   ```typescript
   async function stage1Validate(ctx: PipelineContext): Promise<void>
   ```
   - Validate request with SendTransactionRequestSchema.parse()
   - Generate txId with generateId()
   - INSERT into transactions table: { id: txId, agentId, chain, type: 'NATIVE_TRANSFER', status: 'PENDING', amount: request.amount, toAddress: request.to, createdAt: now, updatedAt: now }
   - Set ctx.txId

   **Stage 2: Auth (passthrough)**
   ```typescript
   async function stage2Auth(ctx: PipelineContext): Promise<void>
   ```
   - v1.1: no-op (masterAuth implicit, no sessionAuth)
   - Log: 'Stage 2: Auth passthrough (v1.1)'

   **Stage 3: Policy evaluation**
   ```typescript
   async function stage3Policy(ctx: PipelineContext): Promise<void>
   ```
   - Call policyEngine.evaluate(agentId, { type, amount, toAddress, chain })
   - If !allowed: UPDATE tx status to 'REJECTED', throw WAIaaSError('POLICY_DENIED')
   - Set ctx.tier from evaluation result
   - UPDATE tx tier in DB

   **Stage 4: Wait (passthrough)**
   ```typescript
   async function stage4Wait(ctx: PipelineContext): Promise<void>
   ```
   - v1.1: no-op (only INSTANT tier, no DELAY/APPROVAL)
   - Log: 'Stage 4: Wait passthrough (INSTANT tier)'

   **Stage 5: On-chain execution**
   ```typescript
   async function stage5Execute(ctx: PipelineContext): Promise<void>
   ```
   - UPDATE tx status to 'BUILDING' (or directly to 'SUBMITTED' after submit)
   - Build: `ctx.unsignedTx = await adapter.buildTransaction({ from: agent.publicKey, to: request.to, amount: BigInt(request.amount), memo: request.memo })`
   - Simulate: `const simResult = await adapter.simulateTransaction(ctx.unsignedTx)`
   - If !simResult.success: UPDATE tx to 'FAILED' with error, throw WAIaaSError('SIMULATION_FAILED')
   - Decrypt key: `const privateKey = await keyStore.decryptPrivateKey(agentId, masterPassword)`
   - Sign: `ctx.signedTx = await adapter.signTransaction(ctx.unsignedTx, privateKey)`
   - Release key: `keyStore.releaseKey(privateKey)` (MUST be in finally block)
   - Submit: `ctx.submitResult = await adapter.submitTransaction(ctx.signedTx)`
   - UPDATE tx: status='SUBMITTED', txHash=submitResult.txHash

   CRITICAL: Private key MUST be released in a finally block to prevent memory leaks.

   **Stage 6: Confirmation wait**
   ```typescript
   async function stage6Confirm(ctx: PipelineContext): Promise<void>
   ```
   - Call `await adapter.waitForConfirmation(ctx.submitResult!.txHash, 30_000)`
   - If confirmed: UPDATE tx status='CONFIRMED', executedAt=now
   - If error/timeout: UPDATE tx status='FAILED', error=message
   - Wrap RPC errors in WAIaaSError('CHAIN_ERROR')

3. Create `packages/daemon/src/pipeline/pipeline.ts`:
   ```typescript
   export class TransactionPipeline {
     constructor(private deps: PipelineDeps) {}

     async executeSend(agentId: string, request: SendTransactionRequest): Promise<string> {
       // Look up agent
       const agent = await this.getAgent(agentId);
       if (!agent) throw new WAIaaSError('AGENT_NOT_FOUND');

       // Create context
       const ctx: PipelineContext = { ...this.deps, agentId, agent, request, txId: '' };

       // Execute 6 stages sequentially
       await stage1Validate(ctx);
       await stage2Auth(ctx);
       await stage3Policy(ctx);
       await stage4Wait(ctx);
       await stage5Execute(ctx);
       await stage6Confirm(ctx);

       return ctx.txId;
     }

     async getTransaction(txId: string) {
       // SELECT from transactions WHERE id = txId
       // Return transaction object or throw WAIaaSError('TX_NOT_FOUND')
     }
   }
   ```

4. Create `packages/daemon/src/pipeline/index.ts`:
   - Barrel export: TransactionPipeline, DefaultPolicyEngine, stage functions

5. Create `packages/daemon/src/api/routes/transactions.ts`:

   **POST /v1/transactions/send** handler:
   - Requires X-Agent-Id header
   - Parse body with SendTransactionRequestSchema
   - Call pipeline.executeSend(agentId, request)
   - Return 201 with JSON: { txId, status: 'PENDING' }
   - NOTE: The pipeline runs synchronously in v1.1. In v1.2+ it would return immediately and process async.
   - Actually, for v1.1, run the pipeline synchronously and return the final status:
     Return 201 with { id: txId, status: finalStatus, txHash }
   - HOWEVER, the pipeline may take time (30s+ for confirmation). Two options:
     a) Return immediately with PENDING, let client poll GET /v1/transactions/:id
     b) Run entire pipeline and return final status
   - Choose (a): Return 201 immediately after Stage 1 (DB INSERT), then run stages 2-6 async (fire-and-forget with error catching). This matches the "submit to pipeline" semantic.
   - Implementation: After stage1, respond 201. Then stages 2-6 run in background:
     ```typescript
     // After stage1
     // Return early with txId
     // Then execute remaining stages asynchronously
     void (async () => { try { stage2...stage6 } catch { updateTxFailed } })();
     ```

   **GET /v1/transactions/:id** handler:
   - Look up transaction by ID in DB
   - If not found: throw WAIaaSError('TX_NOT_FOUND') -> 404
   - Return 200 with transaction JSON: { id, agentId, type, status, tier, chain, toAddress, amount, txHash, error, createdAt }

   Route factory:
   ```typescript
   export function transactionRoutes(deps: TransactionRouteDeps): Hono { ... }
   ```

6. Update `packages/daemon/src/api/routes/index.ts`:
   - Add transactionRoutes export

7. Update `packages/daemon/src/api/server.ts`:
   - Create TransactionPipeline instance from deps
   - Register transaction routes: app.route('/v1', transactionRoutes({ pipeline }))

8. Update `packages/daemon/src/index.ts`:
   - Export TransactionPipeline, DefaultPolicyEngine from pipeline module
  </action>
  <verify>
    - `pnpm build --filter=@waiaas/daemon` succeeds
    - `pnpm typecheck --filter=@waiaas/daemon` succeeds
  </verify>
  <done>
    - 6-stage pipeline with all stage functions implemented
    - DefaultPolicyEngine returns INSTANT/allowed for all requests
    - POST /v1/transactions/send accepts request and returns 201 with txId
    - GET /v1/transactions/:id returns transaction status
    - Private key always released in finally block
  </done>
</task>

<task type="auto">
  <name>Task 2: Pipeline + transaction API tests</name>
  <files>
    packages/daemon/src/__tests__/pipeline.test.ts
    packages/daemon/src/__tests__/api-transactions.test.ts
  </files>
  <action>
1. Create `packages/daemon/src/__tests__/pipeline.test.ts`:

   Test setup:
   - In-memory SQLite with pushSchema()
   - Mock adapter implementing IChainAdapter (all methods return mock data)
   - Mock keyStore with decryptPrivateKey returning fake 64-byte key
   - DefaultPolicyEngine (real, not mock -- it's trivial)

   **DefaultPolicyEngine (2 tests):**
   - evaluate() returns { tier: 'INSTANT', allowed: true }
   - evaluate() works for any input

   **Stage 1: Validate + INSERT (3 tests):**
   - Valid request creates PENDING transaction in DB
   - Invalid request (missing 'to') throws validation error
   - Generated txId is UUID v7 format

   **Stage 3: Policy (2 tests):**
   - With DefaultPolicyEngine, tx gets INSTANT tier
   - With mock engine returning allowed:false, tx gets REJECTED status

   **Stage 5: Execute (3 tests):**
   - Calls build -> simulate -> sign -> submit in order
   - On simulation failure, tx status becomes FAILED
   - Private key is released even when sign throws (finally block)

   **Stage 6: Confirm (2 tests):**
   - Confirmed status updates DB to CONFIRMED
   - Timeout/error updates DB to FAILED

   **Full pipeline integration (2 tests):**
   - executeSend() with all mocks returning success -> tx reaches CONFIRMED
   - executeSend() with mock adapter throw -> tx reaches FAILED

   Target: 14 tests minimum.

2. Create `packages/daemon/src/__tests__/api-transactions.test.ts`:

   Test setup: Same as api-agents.test.ts pattern -- in-memory DB, mock adapter, Hono app.request().

   **POST /v1/transactions/send (4 tests):**
   - Valid request returns 201 with txId
   - Invalid amount (non-numeric) returns 400
   - Missing X-Agent-Id returns 400
   - Non-existent agent returns 404

   **GET /v1/transactions/:id (3 tests):**
   - Existing transaction returns 200 with full JSON
   - Non-existent ID returns 404 with TX_NOT_FOUND
   - Response includes all expected fields (id, agentId, type, status, txHash)

   Target: 7 tests minimum.
  </action>
  <verify>
    - `pnpm test --filter=@waiaas/daemon` passes all tests
    - Pipeline tests cover all 6 stages
    - Transaction API tests cover send + status query
  </verify>
  <done>
    - 14+ pipeline tests covering all 6 stages + integration
    - 7+ API tests covering transaction send + status query
    - Error cases tested (validation, not found, simulation failure)
    - Key release in finally block verified
  </done>
</task>

</tasks>

<verification>
- `pnpm build --filter=@waiaas/daemon` succeeds
- `pnpm test --filter=@waiaas/daemon` passes all tests (existing + ~21 new)
- `pnpm lint --filter=@waiaas/daemon` passes
- POST /v1/transactions/send submits to pipeline and returns txId
- GET /v1/transactions/:id returns transaction state
- DefaultPolicyEngine returns INSTANT for all requests
- Pipeline stages execute in correct order
</verification>

<success_criteria>
Complete transaction flow is working: send request -> 6-stage pipeline (validate/auth/policy/wait/execute/confirm) -> status queryable. This is the final piece of Phase 50 success criteria #4.
</success_criteria>

<output>
After completion, create `.planning/phases/50-api-solana-pipeline/50-04-SUMMARY.md`
</output>
