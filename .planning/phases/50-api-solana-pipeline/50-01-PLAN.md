---
phase: 50-api-solana-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/package.json
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/api/middleware/request-id.ts
  - packages/daemon/src/api/middleware/host-guard.ts
  - packages/daemon/src/api/middleware/kill-switch-guard.ts
  - packages/daemon/src/api/middleware/request-logger.ts
  - packages/daemon/src/api/middleware/error-handler.ts
  - packages/daemon/src/api/middleware/index.ts
  - packages/daemon/src/api/routes/health.ts
  - packages/daemon/src/api/index.ts
  - packages/daemon/src/__tests__/api-server.test.ts
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "Hono server binds to 127.0.0.1:3100 and responds to requests"
    - "GET /health returns 200 OK with status JSON"
    - "Requests from external IPs (non-127.0.0.1) are rejected by hostGuard"
    - "Unhandled errors produce WAIaaSError-shaped JSON responses"
    - "Every response includes an X-Request-Id header"
  artifacts:
    - path: "packages/daemon/src/api/server.ts"
      provides: "createApp() factory returning Hono instance with all middleware"
      exports: ["createApp"]
    - path: "packages/daemon/src/api/middleware/host-guard.ts"
      provides: "hostGuard middleware blocking non-localhost requests"
    - path: "packages/daemon/src/api/middleware/error-handler.ts"
      provides: "errorHandler middleware converting errors to WAIaaSError JSON"
    - path: "packages/daemon/src/api/routes/health.ts"
      provides: "GET /health route returning daemon status"
  key_links:
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/middleware/index.ts"
      via: "app.use() middleware registration"
      pattern: "app\\.use"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/health.ts"
      via: "app.route() for /health"
      pattern: "app\\.route"
---

<objective>
Create the Hono 4.x API server framework with 5 middleware (requestId, hostGuard, killSwitchGuard, requestLogger) + errorHandler (app.onError) and GET /health endpoint. Zod validation is done inline in route handlers, not as separate middleware.

Purpose: Establishes the HTTP transport layer that all subsequent API routes (agents, wallet, transactions) will plug into. Fills in DaemonLifecycle Step 5 stub.
Output: `createApp()` factory, 5 middleware + error handler, /health route, tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-daemon-infra/49-03-SUMMARY.md

Key references:
- packages/daemon/src/lifecycle/daemon.ts — Step 4/5 stubs to fill
- packages/daemon/src/infrastructure/config/loader.ts — DaemonConfigSchema with daemon.port, daemon.hostname
- packages/core/src/errors/base-error.ts — WAIaaSError with toJSON(), httpStatus
- packages/core/src/errors/error-codes.ts — KILL_SWITCH_ACTIVE, AGENT_NOT_FOUND, etc.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Hono + create server factory and 6 middleware</name>
  <files>
    packages/daemon/package.json
    packages/daemon/src/api/server.ts
    packages/daemon/src/api/middleware/request-id.ts
    packages/daemon/src/api/middleware/host-guard.ts
    packages/daemon/src/api/middleware/kill-switch-guard.ts
    packages/daemon/src/api/middleware/request-logger.ts
    packages/daemon/src/api/middleware/error-handler.ts
    packages/daemon/src/api/middleware/index.ts
    packages/daemon/src/api/routes/health.ts
    packages/daemon/src/api/index.ts
    pnpm-lock.yaml
  </files>
  <action>
1. Install Hono and @hono/node-server:
   ```
   cd packages/daemon && pnpm add hono @hono/node-server
   ```

2. Create `packages/daemon/src/api/middleware/request-id.ts`:
   - Hono middleware that generates a UUID v7 (using generateId from database/id.ts) for every request
   - Sets `X-Request-Id` response header
   - Stores requestId in c.set('requestId', id) for downstream use
   - If client sends `X-Request-Id` header, use it instead of generating

3. Create `packages/daemon/src/api/middleware/host-guard.ts`:
   - Checks hostname from request. Only allow requests where the Host header starts with `127.0.0.1` or `localhost` or `[::1]`
   - If not localhost, return 403 with WAIaaSError('SYSTEM_LOCKED', { message: 'Only localhost access allowed' })
   - This is the simplest security layer: bind to 127.0.0.1 + reject non-localhost Host headers

4. Create `packages/daemon/src/api/middleware/kill-switch-guard.ts`:
   - Accepts a function `getKillSwitchState: () => string` as factory parameter
   - If state is 'ACTIVATED', reject with WAIaaSError('KILL_SWITCH_ACTIVE') 409
   - v1.1: pass-through (no kill switch state management yet). Factory default returns 'NORMAL'
   - Allow /health endpoint to bypass the guard (check c.req.path)

5. Create `packages/daemon/src/api/middleware/request-logger.ts`:
   - Log method, path, status, duration (ms) for every request
   - Use console.log for now (structured logger deferred to later milestone)
   - Format: `[REQ] GET /health 200 12ms`

6. Create `packages/daemon/src/api/middleware/error-handler.ts`:
   - Hono onError handler (not middleware, but set via app.onError)
   - If error is WAIaaSError: respond with error.httpStatus and error.toJSON()
   - If error is ZodError: respond with 400 and formatted validation error
   - Otherwise: respond with 500 and generic SYSTEM_LOCKED error
   - Always include requestId from context in the error response

7. Create `packages/daemon/src/api/middleware/index.ts`:
   - Barrel export of all 5 middleware + error handler

8. Create `packages/daemon/src/api/routes/health.ts`:
   - Hono router with GET /health
   - Returns 200 with JSON: { status: 'ok', version: '0.0.0', uptime: process.uptime(), timestamp: Math.floor(Date.now() / 1000) }
   - No authentication required

9. Create `packages/daemon/src/api/server.ts`:
   - Export `createApp(deps)` factory function
   - deps parameter: `{ getKillSwitchState?: () => string }` (extensible for future)
   - Creates Hono instance
   - Registers middleware in order: requestId -> hostGuard -> killSwitchGuard -> requestLogger
   - Registers error handler via app.onError
   - Registers /health route
   - Returns the app instance (NOT started -- starting is DaemonLifecycle's job)

10. Create `packages/daemon/src/api/index.ts`:
    - Barrel export: createApp, all middleware, health route

11. DO NOT update DaemonLifecycle Step 4/5 yet (that's Plan 50-03/04's job after routes are ready)

CRITICAL: Use `import { Hono } from 'hono'` (NOT OpenAPIHono -- that requires @hono/zod-openapi which is v1.2 scope). For v1.1, plain Hono is sufficient. Zod validation is done manually in route handlers via schema.parse().
  </action>
  <verify>
    - `pnpm build --filter=@waiaas/daemon` succeeds
    - `pnpm typecheck --filter=@waiaas/daemon` succeeds
    - Hono is in daemon's package.json dependencies
  </verify>
  <done>
    - createApp() returns a configured Hono instance with 5 middleware + error handler + /health route
    - All middleware modules compile and export correctly
    - /health route handler defined
  </done>
</task>

<task type="auto">
  <name>Task 2: API server + middleware tests</name>
  <files>
    packages/daemon/src/__tests__/api-server.test.ts
  </files>
  <action>
1. Create test file using Hono's `app.request()` method for testing (no real HTTP server needed):

2. Test categories:

**requestId middleware (3 tests):**
- Response includes X-Request-Id header
- If client sends X-Request-Id, server echoes it back
- Generated ID has UUID format

**hostGuard middleware (3 tests):**
- Request with Host: 127.0.0.1:3100 -> passes through
- Request with Host: localhost:3100 -> passes through
- Request with Host: evil.com -> returns 403

**killSwitchGuard middleware (3 tests):**
- Default state (NORMAL) -> passes through
- State ACTIVATED -> returns 409 with KILL_SWITCH_ACTIVE
- /health bypasses kill switch even when ACTIVATED

**errorHandler (3 tests):**
- WAIaaSError thrown -> responds with error.httpStatus and error.toJSON()
- Generic Error thrown -> responds with 500
- Error response includes requestId

**health route (3 tests):**
- GET /health returns 200
- Response body has status: 'ok', version, uptime, timestamp
- Health response timestamp is Unix seconds (not milliseconds)

**requestLogger (1 test):**
- Verify console.log is called with method, path, status (spy on console.log)

Use `app.request('/health', { headers: { Host: '127.0.0.1:3100' } })` pattern.
For hostGuard tests, create separate app instances or test routes that check the guard directly.

Target: 16 tests minimum.
  </action>
  <verify>
    - `pnpm test --filter=@waiaas/daemon` passes
    - All 16+ tests in api-server.test.ts pass
  </verify>
  <done>
    - requestId, hostGuard, killSwitchGuard, requestLogger, errorHandler, health route all tested
    - Tests verify middleware ordering and error handling behavior
  </done>
</task>

</tasks>

<verification>
- `pnpm build --filter=@waiaas/daemon` succeeds
- `pnpm test --filter=@waiaas/daemon` passes all tests (existing 114 + new ~16)
- `pnpm lint --filter=@waiaas/daemon` passes
- createApp() callable and returns Hono instance
- Health route returns 200 with expected JSON shape
</verification>

<success_criteria>
Hono API server framework with 5 middleware + error handler + /health route is implemented and tested, ready for route registration in Plans 50-03 and 50-04.
</success_criteria>

<output>
After completion, create `.planning/phases/50-api-solana-pipeline/50-01-SUMMARY.md`
</output>
