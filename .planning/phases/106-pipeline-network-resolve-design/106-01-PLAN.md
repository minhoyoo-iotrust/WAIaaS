---
phase: 106-pipeline-network-resolve-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/70-pipeline-network-resolve-design.md]
autonomous: true

must_haves:
  truths:
    - "resolveNetwork() 순수 함수의 3단계 우선순위(request.network > wallet.defaultNetwork > getDefaultNetwork) 인터페이스, 에러 분기 3개, 의사코드가 정의되어 있다"
    - "PipelineContext.resolvedNetwork + wallet.environment 필드가 Stage 1~6 전체 데이터 흐름도에서 전파 경로가 명시되어 있다"
    - "환경-네트워크 교차 검증의 검증 시점(PipelineContext 생성 전), 에러 코드(ENVIRONMENT_NETWORK_MISMATCH), 에러 메시지 템플릿이 명시되어 있다"
    - "AdapterPool.resolve() 호출부 2곳(transactions.ts, daemon.ts)의 변경 방안이 캐시 키 호환성 확인과 함께 기술되어 있다"
    - "daemon.ts Stage 5 재진입부(executeFromStage5)에서 tx.network 사용 방안이 NULL 처리 포함하여 설계되어 있다"
  artifacts:
    - path: "docs/70-pipeline-network-resolve-design.md"
      provides: "파이프라인 네트워크 리졸브 + 환경 교차 검증 + AdapterPool 호출 변경 통합 설계 문서"
      contains: "resolveNetwork"
  key_links:
    - from: "docs/70-pipeline-network-resolve-design.md"
      to: "docs/68-environment-model-design.md"
      via: "매핑 함수 참조 (getDefaultNetwork, validateNetworkEnvironment, validateChainNetwork, deriveEnvironment)"
      pattern: "getDefaultNetwork|validateNetworkEnvironment"
    - from: "docs/70-pipeline-network-resolve-design.md"
      to: "packages/daemon/src/pipeline/stages.ts"
      via: "PipelineContext 확장 설계가 현재 인터페이스를 참조"
      pattern: "PipelineContext"
    - from: "docs/70-pipeline-network-resolve-design.md"
      to: "packages/daemon/src/api/routes/transactions.ts"
      via: "AdapterPool.resolve() 호출부 변경 설계"
      pattern: "adapterPool.resolve"
---

<objective>
NetworkResolver 순수 함수, PipelineContext 확장, 환경-네트워크 교차 검증, AdapterPool 호출부 변경을 단일 설계 문서(docs/70)로 작성한다.

Purpose: 트랜잭션 요청에서 실제 네트워크가 리졸브되고 환경 격리가 검증되는 데이터 흐름을 설계하여, v1.4.6 구현자가 Stage 1부터 AdapterPool 호출까지 코드를 작성할 수 있도록 한다.
Output: docs/70-pipeline-network-resolve-design.md (7개 섹션)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 105 설계 문서 (매핑 함수 4개 설계, WalletSchema 변경)
@docs/68-environment-model-design.md

# Phase 105 DB 마이그레이션 설계 (transactions.network, wallets 12-step)
@docs/69-db-migration-v6-design.md

# Phase 106 리서치 (파이프라인 흐름 분석, 변경 지점 식별, 의사코드)
@.planning/phases/106-pipeline-network-resolve-design/106-RESEARCH.md

# 현재 PipelineContext, Stage 1~6 구현
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/pipeline/pipeline.ts

# 현재 AdapterPool, resolveRpcUrl
@packages/daemon/src/infrastructure/adapter-pool.ts

# 현재 transactions route handler (PipelineContext 생성부)
@packages/daemon/src/api/routes/transactions.ts

# daemon.ts Stage 5 재진입 (executeFromStage5)
@packages/daemon/src/lifecycle/daemon.ts

# 현재 에러 코드 정의
@packages/core/src/errors/error-codes.ts

# 현재 체인/네트워크 타입
@packages/core/src/enums/chain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: NetworkResolver + ENVIRONMENT_NETWORK_MISMATCH 에러 코드 + 환경 교차 검증 설계 (PIPE-01, PIPE-03)</name>
  <files>docs/70-pipeline-network-resolve-design.md</files>
  <action>
docs/70-pipeline-network-resolve-design.md 파일을 생성한다. 다음 4개 섹션을 포함한다:

**섹션 1: 개요**
- Phase 106 목적: 트랜잭션 요청에서 실제 네트워크 리졸브 + 환경 격리 검증 데이터 흐름 설계
- Before/After 아키텍처 비교 다이어그램 (106-RESEARCH.md의 "현재 파이프라인 네트워크 흐름" vs "설계 대상 흐름" 참조)
- Phase 105 참조 관계 명시 (docs/68: 매핑 함수 4개, docs/69: DB 마이그레이션)

**섹션 2: resolveNetwork() 순수 함수 설계 (PIPE-01)**
- 파일 위치: `packages/daemon/src/pipeline/network-resolver.ts` (신규 파일)
- 함수 시그니처: `resolveNetwork(requestNetwork, walletDefaultNetwork, environment, chain): NetworkType`
- 3단계 우선순위: request.network > wallet.defaultNetwork > getDefaultNetwork(chain, environment)
- 내부 2중 검증: validateChainNetwork() + validateNetworkEnvironment() 호출 순서
- 에러 분기 3개 (chain-network 불일치, environment-network 불일치, 정상 해결)
- 입출력 예시 테이블: 최소 8개 케이스 (정상 3 + chain 불일치 2 + environment 불일치 2 + null fallback 1)
- 106-RESEARCH.md의 Pattern 1 의사코드를 기반으로, 에러 메시지 템플릿까지 완전히 명시

**섹션 3: ENVIRONMENT_NETWORK_MISMATCH 에러 코드 설계**
- 에러 코드 정의: domain='TX', httpStatus=400, retryable=false
- 에러 메시지 템플릿: `"Network '{network}' is not allowed in environment '{environment}' for chain '{chain}'. Valid networks: {validNetworks}"`
- 기존 에러 코드와의 관계: ACTION_VALIDATION_FAILED(chain-network 불일치)와 분리하는 이유 (보안 추적)
- error-codes.ts에 추가할 정확한 코드 블록 (의사코드)
- 현재 error-codes.ts를 읽고 68개 에러 코드 넘버링/카테고리 체계를 파악하여 신규 코드의 위치를 결정

**섹션 4: 환경-네트워크 교차 검증 설계 (PIPE-03)**
- 검증 시점: PipelineContext 생성 전 (Route Handler에서 resolveNetwork() 호출 시)
- 검증 로직 흐름: validateChainNetwork() -> validateNetworkEnvironment() (순서 근거 포함)
- 에러 시나리오 테이블: 106-RESEARCH.md의 5개 시나리오 + 추가 edge case 2~3개
- WAIaaSError 변환 패턴: ChainError -> WAIaaSError 매핑 (기존 wallets.ts line 271-275 패턴 참조)
- 보안 관점: 환경 불일치 시도 로깅 요구사항 (로그 레벨, 포함 정보)
- DB INSERT 전 검증 보장: resolveNetwork()가 PipelineContext 생성부에서 호출되어 Stage 1 진입 전 검증 완료
  </action>
  <verify>
docs/70-pipeline-network-resolve-design.md 파일이 존재하고, 다음을 포함하는지 확인:
- resolveNetwork() 함수 시그니처와 3단계 우선순위 의사코드
- ENVIRONMENT_NETWORK_MISMATCH 에러 코드 정의 (domain, httpStatus, retryable, message)
- 입출력 예시 테이블 (최소 8개 케이스)
- 에러 시나리오 테이블 (최소 7개 시나리오)
- "PipelineContext 생성 전" 검증 시점 명시
  </verify>
  <done>
resolveNetwork()의 인터페이스, 우선순위, 에러 분기가 의사코드로 정의되어 있고, ENVIRONMENT_NETWORK_MISMATCH 에러 코드가 기존 체계와 일관되게 정의되어 있으며, 환경-네트워크 교차 검증의 검증 시점/에러 코드/에러 메시지/보안 로깅이 명시되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: PipelineContext 확장 + Stage 1~6 데이터 흐름도 + AdapterPool 호출 변경 + 설계 결정 요약 (PIPE-02, PIPE-04)</name>
  <files>docs/70-pipeline-network-resolve-design.md</files>
  <action>
docs/70-pipeline-network-resolve-design.md에 섹션 5~7을 추가한다.

**섹션 5: PipelineContext 확장 설계 (PIPE-02)**
- PipelineContext 인터페이스 변경 전/후 비교 (현재 stages.ts의 PipelineContext를 직접 참조)
- 변경 사항:
  - wallet.network -> wallet.environment (string='testnet'|'mainnet') + wallet.defaultNetwork (string|null)
  - resolvedNetwork (string) 추가 -- Stage 1~6 전체에서 참조
- Stage 1~6 데이터 흐름도 (106-RESEARCH.md의 PIPE-02 데이터 흐름도를 기반으로 확장):
  - Route Handler: wallet 조회 -> resolveNetwork() -> resolveRpcUrl() -> adapterPool.resolve() -> ctx 생성
  - Stage 1: Zod parse + INSERT (network = ctx.resolvedNetwork)
  - Stage 2: 변경 없음 (sessionId 검증)
  - Stage 3: 변경 없음 (Phase 107 범위)
  - Stage 4: 변경 없음 (DELAY/APPROVAL 분기)
  - Stage 5: buildByType + simulate + sign + submit (ctx.adapter가 이미 resolvedNetwork의 어댑터)
  - Stage 6: 변경 없음 (ctx.adapter가 올바른 네트워크)
- 각 Stage에서 resolvedNetwork를 어떻게 참조하는지 코드 수준 의사코드
- Stage 1 INSERT 변경: transactions VALUES에 `network: ctx.resolvedNetwork` 추가

**섹션 6: AdapterPool 호출부 변경 설계 (PIPE-04)**
- AdapterPool.resolve() 시그니처 변경 불필요 확인 (캐시 키 `chain:network` 호환)
- resolveRpcUrl() 시그니처 변경 불필요 확인
- 변경 대상 2곳:
  1. `transactions.ts` (line 255-291): wallet.network -> resolvedNetwork 의사코드
  2. `daemon.ts` executeFromStage5 (line 624-655): wallet.network -> tx.network 의사코드
- daemon.ts 재진입 경로 특이사항:
  - tx.network (DB에 기록된 resolvedNetwork)를 사용하여 다시 해결할 필요 없음
  - v6a 마이그레이션 이전 트랜잭션(network=NULL) 처리: wallet에서 fallback하는 호환성 로직
  - NULL 처리 의사코드: `const resolvedNetwork = tx.network ?? getDefaultNetwork(wallet.chain, wallet.environment)`
- 메모리 영향: 같은 월렛이 다른 네트워크 사용 시 어댑터 2개 동시 캐시 -- 경량이므로 문제 없음 확인

**섹션 7: 설계 결정 요약**
- PIPE-01~PIPE-04 설계 결정 4~6개를 테이블로 정리
- 각 결정: ID, 결정 내용, 근거, 대안, 영향 범위
- Phase 107/108에 대한 영향 명시 (Phase 107: 정책 평가 시 ctx.resolvedNetwork 참조, Phase 108: request.network Zod 스키마)
  </action>
  <verify>
docs/70-pipeline-network-resolve-design.md 파일에 다음이 추가되었는지 확인:
- PipelineContext 인터페이스 변경 전/후 비교
- Stage 1~6 데이터 흐름도 (각 Stage에서 resolvedNetwork 참조 방식)
- AdapterPool 호출부 변경 2곳의 의사코드 (transactions.ts, daemon.ts)
- daemon.ts executeFromStage5 NULL 처리 의사코드
- 설계 결정 테이블 (최소 4개)
  </verify>
  <done>
PipelineContext.resolvedNetwork + wallet.environment의 Stage 1~6 데이터 흐름도가 존재하고, AdapterPool.resolve() 호출부 2곳의 변경 방안이 캐시 키 호환성 확인과 함께 기술되어 있으며, daemon.ts 재진입부의 NULL 처리가 포함되어 있고, 설계 결정 요약이 Phase 107/108 영향과 함께 정리되어 있다.
  </done>
</task>

</tasks>

<verification>
Phase 106 성공 기준 4개 항목 점검:

1. **NetworkResolver 인터페이스** -- docs/70 섹션 2에 resolveNetwork() 시그니처, 3단계 우선순위, 에러 분기 3개, 입출력 예시 8개 이상의 의사코드가 존재한다
2. **PipelineContext 데이터 흐름도** -- docs/70 섹션 5에 wallet.environment + resolvedNetwork가 전파되는 Stage 1~6 흐름도가 존재하고, 각 Stage의 참조 방식이 코드 수준으로 명시되어 있다
3. **환경-네트워크 교차 검증** -- docs/70 섹션 3~4에 ENVIRONMENT_NETWORK_MISMATCH 에러 코드, 검증 시점(PipelineContext 생성 전), 에러 메시지 템플릿, 보안 로깅 요구사항이 명시되어 있다
4. **AdapterPool 호출 변경** -- docs/70 섹션 6에 호출부 2곳의 변경 의사코드가 있고, 캐시 키 `chain:network` 호환성이 확인되어 있으며, daemon.ts 재진입부의 NULL 처리가 포함되어 있다
</verification>

<success_criteria>
- docs/70-pipeline-network-resolve-design.md가 7개 섹션으로 작성되어 있다
- PIPE-01~PIPE-04 4개 요구사항이 모두 커버되어 있다
- v1.4.6 구현자가 이 문서만으로 resolveNetwork() -> PipelineContext -> Stage 1 INSERT -> AdapterPool 호출 변경을 코드로 작성할 수 있다
- Phase 105의 docs/68(매핑 함수) + docs/69(마이그레이션)와의 참조 관계가 명확하다
- Phase 107(정책), Phase 108(API) 설계 시 필요한 인터페이스가 확정되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/106-pipeline-network-resolve-design/106-01-SUMMARY.md`
</output>
