---
phase: 11-critical-decisions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/24-monorepo-data-directory.md
  - .planning/deliverables/28-daemon-lifecycle-cli.md
  - .planning/deliverables/29-api-framework-design.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/40-telegram-bot-docker.md
autonomous: true

must_haves:
  truths:
    - "모든 문서에서 기본 포트가 3100으로 일관됨"
    - "Docker 환경에서 0.0.0.0 바인딩이 허용됨 (WAIAAS_DAEMON_HOSTNAME 환경변수)"
    - "트랜잭션 상태 8개가 SSoT로 확정되고 클라이언트 표시 가이드가 존재함"
    - "자금 충전 방법이 REST API 문서에 명시됨"
  artifacts:
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "config.toml SSoT with port 3100, hostname 0.0.0.0 허용"
      contains: "port.*3100"
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "CLI 예시 port 3100"
      contains: "3100"
    - path: ".planning/deliverables/29-api-framework-design.md"
      provides: "z.union hostname 스키마, Docker 보안 경고"
      contains: "z.union"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "클라이언트 상태 표시 가이드, 자금 충전 사용 사례"
      contains: "자금 충전"
    - path: ".planning/deliverables/40-telegram-bot-docker.md"
      provides: "WAIAAS_DAEMON_HOSTNAME 환경변수 명시"
      contains: "WAIAAS_DAEMON_HOSTNAME"
  key_links:
    - from: ".planning/deliverables/29-api-framework-design.md"
      to: ".planning/deliverables/40-telegram-bot-docker.md"
      via: "WAIAAS_DAEMON_HOSTNAME 환경변수 참조"
      pattern: "WAIAAS_DAEMON_HOSTNAME"
    - from: ".planning/deliverables/24-monorepo-data-directory.md"
      to: ".planning/deliverables/29-api-framework-design.md"
      via: "config.toml hostname 설정이 Zod 스키마와 일치"
      pattern: "hostname.*0\\.0\\.0\\.0"
---

<objective>
CRITICAL 4건 의사결정을 확정하고 관련 설계 문서에 반영한다.

Purpose: v0.3 설계 논리 일관성 확보의 핵심 단계로, 시스템 기본 동작에 영향을 미치는 모순을 해소한다. 구현 단계 진입 전 모든 문서가 동일한 값을 참조하도록 통일한다.

Output:
- 24-monorepo, 28-daemon-lifecycle: 포트 3100 통일
- 29-api-framework, 24-monorepo, 40-telegram-bot: Docker hostname 오버라이드 설계
- 37-rest-api: 클라이언트 상태 표시 가이드 + 자금 충전 사용 사례
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-critical-decisions/11-RESEARCH.md

# 수정 대상 문서
@.planning/deliverables/24-monorepo-data-directory.md
@.planning/deliverables/28-daemon-lifecycle-cli.md
@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/40-telegram-bot-docker.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 기본 포트 3100 통일 (CRIT-01)</name>
  <files>
    .planning/deliverables/24-monorepo-data-directory.md
    .planning/deliverables/28-daemon-lifecycle-cli.md
  </files>
  <action>
24-monorepo-data-directory.md 수정:
- 라인 669: `| \`port\` | integer | \`3000\` |` -> `| \`port\` | integer | \`3100\` |`
- 라인 736: `cors_origins` 배열의 3000 -> 3100
- 라인 749: `port = 3000` -> `port = 3100`
- 라인 822-823: localhost:3000, 127.0.0.1:3000 -> 3100
- 라인 837: `.default(3000)` -> `.default(3100)`

28-daemon-lifecycle-cli.md 수정:
- 라인 173: `127.0.0.1:3000` -> `127.0.0.1:3100`
- 라인 1356: `(기본: 3000)` -> `(기본: 3100)`
- 라인 1369: `3000` -> `3100`
- 라인 1407, 1409: `127.0.0.1:3000` -> `127.0.0.1:3100`
- 라인 1435-1436: 포트 충돌 예시에서 3000 -> 3100
- 라인 1706, 1732: `127.0.0.1:3000` -> `127.0.0.1:3100`

수정 시 주의: 5000(busy_timeout) 등 다른 숫자는 변경하지 말 것.
  </action>
  <verify>
grep -c "3000" 두 파일에서 0 반환 (busy_timeout 5000은 제외)
grep "port.*3100" 24-monorepo에서 결과 확인
grep "127.0.0.1:3100" 28-daemon-lifecycle에서 결과 확인
  </verify>
  <done>
- 24-monorepo: 모든 port 기본값이 3100, cors_origins도 3100
- 28-daemon-lifecycle: 모든 CLI 예시가 3100 포트 사용
- 3000 문자열이 포트 관련 위치에서 더 이상 나타나지 않음
  </done>
</task>

<task type="auto">
  <name>Task 2: Docker hostname 오버라이드 설계 (CRIT-03)</name>
  <files>
    .planning/deliverables/29-api-framework-design.md
    .planning/deliverables/24-monorepo-data-directory.md
    .planning/deliverables/40-telegram-bot-docker.md
  </files>
  <action>
29-api-framework-design.md 수정:
1. z.literal('127.0.0.1') 부분을 z.union으로 변경:
   ```typescript
   hostname: z.union([
     z.literal('127.0.0.1'),
     z.literal('0.0.0.0'),
   ]).default('127.0.0.1'),
   ```
2. 해당 섹션에 보안 경고 추가:
   ```
   > **Docker 전용 경고**: `0.0.0.0` 바인딩은 Docker 컨테이너 환경에서만 사용.
   > 반드시 Docker 포트 매핑에서 `127.0.0.1:3100:3100` 형식 사용.
   > `0.0.0.0:3100:3100` (전체 노출)은 보안 위험.
   ```

24-monorepo-data-directory.md 수정:
1. [daemon] 섹션의 hostname 설명 업데이트:
   - 기본값 127.0.0.1 유지
   - 유효 범위에 0.0.0.0 추가 (Docker 전용)
   - 환경변수 `WAIAAS_DAEMON_HOSTNAME` 오버라이드 설명 추가

40-telegram-bot-docker.md 수정:
1. docker-compose.yml의 environment 섹션에 추가:
   ```yaml
   environment:
     - WAIAAS_DAEMON_HOSTNAME=0.0.0.0
   ```
2. 보안 설명 추가: "컨테이너 내부에서 0.0.0.0 바인딩, Docker ports에서 127.0.0.1 제한"
  </action>
  <verify>
grep "z.union" 29-api-framework에서 hostname 관련 패턴 확인
grep "WAIAAS_DAEMON_HOSTNAME" 40-telegram-bot에서 결과 확인
grep "0.0.0.0" 24-monorepo에서 hostname 설명 확인
  </verify>
  <done>
- 29-api-framework: z.literal -> z.union으로 변경, 보안 경고 추가
- 24-monorepo: hostname 설정에 0.0.0.0 허용 및 환경변수 오버라이드 설명
- 40-telegram-bot: WAIAAS_DAEMON_HOSTNAME=0.0.0.0 환경변수 명시
- 기본값 127.0.0.1 유지 (보안 기본 원칙)
  </done>
</task>

<task type="auto">
  <name>Task 3: 상태 표시 가이드 + 자금 충전 문서화 (CRIT-02, CRIT-04)</name>
  <files>
    .planning/deliverables/37-rest-api-complete-spec.md
  </files>
  <action>
37-rest-api-complete-spec.md에 두 섹션 추가:

1. **클라이언트 상태 표시 가이드** (Transaction 관련 섹션 근처에 추가):
   ```markdown
   ### 클라이언트 상태 표시 가이드

   DB의 8개 트랜잭션 상태(`TransactionStatusEnum`)는 SSoT이다.
   클라이언트 UI에서는 상태와 tier를 조합하여 사용자 친화적 메시지로 표시한다.

   | DB 상태 | Tier | 표시 텍스트 (예시) |
   |---------|------|-------------------|
   | `PENDING` | - | "승인 대기 중" |
   | `QUEUED` | `INSTANT` | "실행 준비됨" |
   | `QUEUED` | `DELAY` | "대기 중 (15분 후 실행)" |
   | `QUEUED` | `APPROVAL` | "Owner 승인 대기 중" |
   | `EXECUTING` | - | "실행 중" |
   | `SUBMITTED` | - | "블록체인 전송됨" |
   | `CONFIRMED` | - | "완료" |
   | `FAILED` | - | "실패" |
   | `CANCELLED` | - | "취소됨" |
   | `EXPIRED` | - | "시간 초과" |

   > **참고**: DB 상태 8개가 SSoT이며, 표시 텍스트는 클라이언트 구현 재량.
   > Telegram Bot, Tauri Desktop 모두 이 매핑을 따른다.
   ```

2. **자금 충전 사용 사례** (`/v1/wallet/address` 엔드포인트 설명에 추가):
   ```markdown
   #### 사용 사례: Agent 지갑에 자금 충전

   WAIaaS는 Owner의 Private Key에 접근하지 않으므로,
   Agent 지갑으로의 자금 전송은 Owner가 외부 지갑에서 직접 수행한다.

   **절차:**
   1. Agent 지갑 주소 조회: `GET /v1/wallet/address`
   2. Owner 지갑(Phantom, Ledger 등)에서 해당 주소로 SOL/ETH 전송
   3. 잔액 확인: `GET /v1/wallet/balance`

   **v0.1 대비 변경:**
   | v0.1 (Squads Vault) | v0.2 (Self-Hosted) |
   |---------------------|-------------------|
   | Owner -> Vault PDA -> Agent | Owner -> Agent 직접 전송 |
   | 다층 예산 관리 | 정책 엔진(`policies` 테이블)으로 대체 |
   ```
  </action>
  <verify>
grep "클라이언트 상태 표시 가이드" 37-rest-api에서 결과 확인
grep "자금 충전" 37-rest-api에서 결과 확인
grep "QUEUED.*DELAY" 37-rest-api에서 tier 조합 표시 확인
  </verify>
  <done>
- 클라이언트 상태 표시 가이드 섹션이 37-rest-api에 추가됨
- DB 8개 상태 + tier 조합 매핑 테이블 존재
- 자금 충전 사용 사례가 /v1/wallet/address 근처에 추가됨
- v0.1 대비 변경 비교표 포함
  </done>
</task>

</tasks>

<verification>
전체 검증:

1. 포트 통일 검증:
   ```bash
   # 포트 관련 3000이 더 이상 없어야 함 (busy_timeout 5000은 제외)
   grep -E "port.*3000|:3000" .planning/deliverables/24-monorepo-data-directory.md
   grep -E "port.*3000|:3000" .planning/deliverables/28-daemon-lifecycle-cli.md
   # 결과: 없어야 함
   ```

2. Docker 바인딩 검증:
   ```bash
   grep "z.union" .planning/deliverables/29-api-framework-design.md
   grep "WAIAAS_DAEMON_HOSTNAME" .planning/deliverables/40-telegram-bot-docker.md
   # 결과: 있어야 함
   ```

3. 문서화 검증:
   ```bash
   grep "클라이언트 상태 표시" .planning/deliverables/37-rest-api-complete-spec.md
   grep "자금 충전" .planning/deliverables/37-rest-api-complete-spec.md
   # 결과: 있어야 함
   ```

4. 문서 간 일관성:
   - 24-monorepo hostname 설명과 29-api-framework Zod 스키마 일치
   - 40-telegram-bot 환경변수가 29-api-framework 설계와 일치
</verification>

<success_criteria>
- [x] CRIT-01: 모든 문서에서 기본 포트 3100으로 통일
- [x] CRIT-02: 트랜잭션 상태 8개 SSoT 확인 + 클라이언트 표시 가이드 추가
- [x] CRIT-03: WAIAAS_DAEMON_HOSTNAME 환경변수 오버라이드 설계 완료
- [x] CRIT-04: 자금 충전 사용 사례가 REST API 문서에 추가
- [x] 보안 기본 원칙 유지 (기본값 127.0.0.1, 0.0.0.0은 Docker 전용)
</success_criteria>

<output>
After completion, create `.planning/phases/11-critical-decisions/11-01-SUMMARY.md`

SUMMARY frontmatter includes:
- phase: 11-critical-decisions
- plan: 01
- outcome: success
- artifacts: 수정된 5개 문서 목록
- decisions: 4개 CRITICAL 의사결정 확정 내용
</output>
