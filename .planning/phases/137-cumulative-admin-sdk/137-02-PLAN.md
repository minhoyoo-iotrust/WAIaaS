---
phase: 137-cumulative-admin-sdk
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/policies.skill.md
  - packages/sdk/src/types.ts
  - python-sdk/waiaas/models.py
autonomous: true

must_haves:
  truths:
    - "policies.skill.md의 SPENDING_LIMIT 섹션에 daily_limit_usd/monthly_limit_usd 필드가 문서화되어 있다"
    - "TS SDK types.ts에 SpendingLimitRules 타입 힌트가 JSDoc으로 문서화되어 있다"
    - "Python SDK models.py에 SpendingLimitRules Pydantic 모델이 정의되어 있다"
    - "curl로 daily_limit_usd를 포함한 SPENDING_LIMIT 정책을 생성할 수 있다"
  artifacts:
    - path: "skills/policies.skill.md"
      provides: "SPENDING_LIMIT 누적 한도 필드 문서"
      contains: "daily_limit_usd"
    - path: "packages/sdk/src/types.ts"
      provides: "SpendingLimitRules 타입 참조 JSDoc"
      contains: "daily_limit_usd"
    - path: "python-sdk/waiaas/models.py"
      provides: "SpendingLimitRules Pydantic model"
      contains: "daily_limit_usd"
  key_links:
    - from: "skills/policies.skill.md"
      to: "packages/core/src/schemas/policy.schema.ts"
      via: "문서가 Zod 스키마의 SpendingLimitRulesSchema 필드를 반영"
      pattern: "daily_limit_usd.*monthly_limit_usd"
    - from: "packages/mcp/src/resources/skills.ts"
      to: "skills/policies.skill.md"
      via: "MCP skill resource가 policies.skill.md를 서빙"
      pattern: "policies"
---

<objective>
policies.skill.md에 SPENDING_LIMIT 누적 한도 필드를 문서화하고, TS/Python SDK에 타입 힌트를 추가하여 프로그래밍 방식으로 누적 한도 정책을 다룰 수 있게 한다.

Purpose: CUMUL-10 요구사항 구현 -- SDK/MCP에서 누적 한도 필드를 포함한 정책을 생성/조회할 수 있어야 한다. REST API 는 Phase 136에서 이미 Zod 스키마가 확장되어 작동하므로, SDK 타입과 스킬 파일 문서화가 핵심.
Output: 수정된 policies.skill.md, SDK types.ts, Python SDK models.py
</objective>

<execution_context>
@.planning/phases/137-cumulative-admin-sdk/137-02-PLAN.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/136-cumulative-spending-engine/136-01-SUMMARY.md
@packages/core/src/schemas/policy.schema.ts
@skills/policies.skill.md
@packages/sdk/src/types.ts
@packages/sdk/src/client.ts
@python-sdk/waiaas/models.py
@python-sdk/waiaas/client.py
@packages/mcp/src/resources/skills.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: policies.skill.md 누적 한도 필드 문서화</name>
  <files>
    skills/policies.skill.md
  </files>
  <action>
**policies.skill.md 수정:**

1. **SPENDING_LIMIT 섹션 (### a. SPENDING_LIMIT)** 의 Rules schema JSON 예시에 누적 필드를 추가:
```json
{
  "instant_max": "100000000",
  "notify_max": "500000000",
  "delay_max": "1000000000",
  "delay_seconds": 300,
  "instant_max_usd": 10,
  "notify_max_usd": 100,
  "delay_max_usd": 1000,
  "daily_limit_usd": 500,
  "monthly_limit_usd": 5000
}
```

2. Rules schema 테이블에 누적 필드 행을 추가:

| Field | Type | Required | Description |
|---|---|---|---|
| (기존 필드 유지) | | | |
| `instant_max_usd` | number | No | Max USD amount for INSTANT tier (oracle-based). |
| `notify_max_usd` | number | No | Max USD amount for NOTIFY tier. |
| `delay_max_usd` | number | No | Max USD amount for DELAY tier. |
| `daily_limit_usd` | number | No | Cumulative USD spending limit in 24h rolling window. Exceeding escalates to APPROVAL. |
| `monthly_limit_usd` | number | No | Cumulative USD spending limit in 30d rolling window. Exceeding escalates to APPROVAL. |

3. Tier assignment 설명 아래에 "Cumulative limit evaluation" 섹션을 추가:

```
**Cumulative limit evaluation:** After per-transaction tier assignment, if `daily_limit_usd` or `monthly_limit_usd` is set, the engine checks rolling-window cumulative USD spending (confirmed + pending reserved amounts). If cumulative + current transaction exceeds the limit, the tier is escalated to APPROVAL regardless of the per-transaction tier. The `TX_APPROVAL_REQUIRED` notification includes a `reason` field (`per_tx`, `cumulative_daily`, or `cumulative_monthly`).
```

4. curl 예시를 업데이트하여 누적 필드를 포함:
```bash
curl -s -X POST http://localhost:3100/v1/policies \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer <token>' \
  -d '{"walletId":"<uuid>","type":"SPENDING_LIMIT","rules":{"instant_max":"100000000","notify_max":"500000000","delay_max":"1000000000","daily_limit_usd":500,"monthly_limit_usd":5000}}'
```

5. "Common Workflows" 섹션에 누적 한도 워크플로우를 추가:

```
### Set daily/monthly cumulative spending limits

Prevent split-transaction bypass by limiting total USD spending per rolling window:
\`\`\`bash
curl -s -X POST http://localhost:3100/v1/policies \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer <token>' \
  -d '{"walletId":"<uuid>","type":"SPENDING_LIMIT","rules":{"instant_max":"100000000","notify_max":"500000000","delay_max":"1000000000","daily_limit_usd":500,"monthly_limit_usd":5000}}'
\`\`\`

When cumulative spending exceeds the limit, the transaction is escalated to APPROVAL. Owner can then approve, reject, or increase the limit.
```

6. 문서 version을 "1.5.3"으로 업데이트.

7. Policy Types 개수를 "11 Types" 에서 "12 Types"로 업데이트 (X402_ALLOWED_DOMAINS가 이미 12번째 -- 헤더의 "11" 을 "12"로 수정. 현재 문서에 "11 policy types"로 되어 있으나 실제로 12개이므로 함께 수정).
  </action>
  <verify>
1. `grep -c "daily_limit_usd" /Users/minho.yoo/dev/wallet/WAIaaS/skills/policies.skill.md` -- 최소 3 이상 (JSON + 테이블 + curl)
2. `grep "monthly_limit_usd" /Users/minho.yoo/dev/wallet/WAIaaS/skills/policies.skill.md` -- 존재
3. `grep "Cumulative limit evaluation" /Users/minho.yoo/dev/wallet/WAIaaS/skills/policies.skill.md` -- 존재
4. `grep "1.5.3" /Users/minho.yoo/dev/wallet/WAIaaS/skills/policies.skill.md` -- version 업데이트 확인
  </verify>
  <done>
policies.skill.md에 SPENDING_LIMIT 누적 한도 필드가 완전히 문서화되고, MCP skill resource로 서빙 시 AI 에이전트가 누적 한도 정책을 올바르게 생성할 수 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: TS SDK 타입 힌트 + Python SDK 모델 + 빌드 검증</name>
  <files>
    packages/sdk/src/types.ts
    python-sdk/waiaas/models.py
  </files>
  <action>
**packages/sdk/src/types.ts 수정:**

TS SDK는 정책 CRUD 메서드를 제공하지 않지만, REST API를 직접 호출하는 사용자를 위해 SPENDING_LIMIT rules 타입을 참조용으로 추가한다. 파일 하단에 Policy 관련 타입을 추가:

```typescript
// ---------------------------------------------------------------------------
// Policy Types (reference for REST API /v1/policies users)
// ---------------------------------------------------------------------------

/**
 * SPENDING_LIMIT policy rules schema.
 *
 * Per-transaction tiers: instant_max, notify_max, delay_max (native amount digit strings).
 * USD tiers (optional): instant_max_usd, notify_max_usd, delay_max_usd.
 * Cumulative limits (optional): daily_limit_usd (24h rolling), monthly_limit_usd (30d rolling).
 *
 * When cumulative USD spending exceeds the limit, the transaction tier is escalated to APPROVAL.
 *
 * @example
 * ```typescript
 * const rules: SpendingLimitRules = {
 *   instant_max: '100000000',
 *   notify_max: '500000000',
 *   delay_max: '1000000000',
 *   daily_limit_usd: 500,
 *   monthly_limit_usd: 5000,
 * };
 * ```
 */
export interface SpendingLimitRules {
  /** INSTANT tier max amount (lamports/wei digit string) */
  instant_max: string;
  /** NOTIFY tier max amount (digit string) */
  notify_max: string;
  /** DELAY tier max amount (digit string) */
  delay_max: string;
  /** Delay cooldown seconds (min 60, default 900) */
  delay_seconds?: number;
  /** INSTANT tier max USD amount (oracle-based, optional) */
  instant_max_usd?: number;
  /** NOTIFY tier max USD amount */
  notify_max_usd?: number;
  /** DELAY tier max USD amount */
  delay_max_usd?: number;
  /** 24h rolling window cumulative USD spending limit (optional, exceeding escalates to APPROVAL) */
  daily_limit_usd?: number;
  /** 30d rolling window cumulative USD spending limit (optional, exceeding escalates to APPROVAL) */
  monthly_limit_usd?: number;
}

/** Policy type enum for REST API /v1/policies. */
export type PolicyType =
  | 'SPENDING_LIMIT'
  | 'WHITELIST'
  | 'TIME_RESTRICTION'
  | 'RATE_LIMIT'
  | 'ALLOWED_TOKENS'
  | 'CONTRACT_WHITELIST'
  | 'METHOD_WHITELIST'
  | 'APPROVED_SPENDERS'
  | 'APPROVE_AMOUNT_LIMIT'
  | 'APPROVE_TIER_OVERRIDE'
  | 'ALLOWED_NETWORKS'
  | 'X402_ALLOWED_DOMAINS';
```

**python-sdk/waiaas/models.py 수정:**

Policy Types 섹션을 파일 하단에 추가:

```python
# ---------------------------------------------------------------------------
# Policy models (reference for REST API /v1/policies users)
# ---------------------------------------------------------------------------


class SpendingLimitRules(BaseModel):
    """SPENDING_LIMIT policy rules schema.

    Per-transaction tiers use native amount digit strings.
    USD tiers and cumulative limits are optional.
    When cumulative USD spending exceeds the limit, the transaction
    tier is escalated to APPROVAL.
    """

    instant_max: str = Field(description="INSTANT tier max (lamports/wei digit string)")
    notify_max: str = Field(description="NOTIFY tier max (digit string)")
    delay_max: str = Field(description="DELAY tier max (digit string)")
    delay_seconds: Optional[int] = Field(default=None, description="Delay cooldown seconds (min 60)")
    instant_max_usd: Optional[float] = Field(default=None, description="INSTANT tier max USD")
    notify_max_usd: Optional[float] = Field(default=None, description="NOTIFY tier max USD")
    delay_max_usd: Optional[float] = Field(default=None, description="DELAY tier max USD")
    daily_limit_usd: Optional[float] = Field(
        default=None, description="24h rolling window cumulative USD limit"
    )
    monthly_limit_usd: Optional[float] = Field(
        default=None, description="30d rolling window cumulative USD limit"
    )
```

이 모델은 REST API를 직접 호출하는 Python SDK 사용자를 위한 참조 타입이다. client.py에 policy CRUD 메서드를 추가하는 것은 스코프 외 (SDK는 월렛/트랜잭션 클라이언트).

**빌드 검증:**
- TS SDK: `npx turbo build --filter=@waiaas/sdk` 성공
- Python SDK: `python -c "from waiaas.models import SpendingLimitRules; print('OK')"` 성공
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/sdk` -- 빌드 성공
2. `grep "daily_limit_usd" /Users/minho.yoo/dev/wallet/WAIaaS/packages/sdk/src/types.ts` -- 존재
3. `grep "daily_limit_usd" /Users/minho.yoo/dev/wallet/WAIaaS/python-sdk/waiaas/models.py` -- 존재
4. `cd /Users/minho.yoo/dev/wallet/WAIaaS/python-sdk && python -c "from waiaas.models import SpendingLimitRules; r = SpendingLimitRules(instant_max='100', notify_max='500', delay_max='1000', daily_limit_usd=500); print(r.daily_limit_usd)"` -- 500 출력
5. `npx turbo build` -- 전체 빌드 성공
  </verify>
  <done>
TS SDK에 SpendingLimitRules 인터페이스, Python SDK에 SpendingLimitRules Pydantic 모델이 추가되어, SDK 사용자가 타입 안전하게 누적 한도 정책 rules를 구성할 수 있다.
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` 전체 빌드 성공
2. policies.skill.md에 daily_limit_usd/monthly_limit_usd 문서화 완료
3. TS SDK SpendingLimitRules 인터페이스 존재
4. Python SDK SpendingLimitRules 모델 존재
5. MCP skill resource가 업데이트된 policies.skill.md를 서빙 (기존 skills.ts가 파일을 읽으므로 자동 반영)
</verification>

<success_criteria>
- CUMUL-10: policies.skill.md가 누적 한도를 문서화하여 MCP AI 에이전트가 올바른 정책 생성 가능
- CUMUL-10: TS/Python SDK에 SpendingLimitRules 타입이 추가되어 타입 안전한 정책 구성 가능
- REST API는 Phase 136에서 이미 daily_limit_usd/monthly_limit_usd를 수용 (Zod 스키마 확장 완료)
- 전체 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/137-cumulative-admin-sdk/137-02-SUMMARY.md`
</output>
