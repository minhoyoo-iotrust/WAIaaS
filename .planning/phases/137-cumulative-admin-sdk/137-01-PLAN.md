---
phase: 137-cumulative-admin-sdk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/components/policy-forms/spending-limit-form.tsx
  - packages/admin/src/components/policy-rules-summary.tsx
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "Admin SpendingLimitForm에서 daily_limit_usd/monthly_limit_usd 값을 입력할 수 있다"
    - "기존 정책 수정 시 daily_limit_usd/monthly_limit_usd 현재값이 프리필된다"
    - "PolicyRulesSummary SPENDING_LIMIT 케이스에서 누적 한도 설정값이 시각적으로 표시된다"
    - "빈 값(미설정) 입력 시 필드가 rules에서 제거되어 누적 한도가 비활성화된다"
  artifacts:
    - path: "packages/admin/src/components/policy-forms/spending-limit-form.tsx"
      provides: "daily_limit_usd, monthly_limit_usd input fields"
      contains: "daily_limit_usd"
    - path: "packages/admin/src/components/policy-rules-summary.tsx"
      provides: "Cumulative limit visualization in SPENDING_LIMIT case"
      contains: "daily_limit_usd"
    - path: "packages/admin/src/styles/global.css"
      provides: "CSS for cumulative limit section in tier visualization"
      contains: "cumulative"
  key_links:
    - from: "packages/admin/src/components/policy-forms/spending-limit-form.tsx"
      to: "packages/admin/src/pages/policies.tsx"
      via: "PolicyFormRouter dispatches to SpendingLimitForm"
      pattern: "SpendingLimitForm"
    - from: "packages/admin/src/components/policy-rules-summary.tsx"
      to: "packages/admin/src/pages/policies.tsx"
      via: "PolicyRulesSummary renders in policies table"
      pattern: "PolicyRulesSummary"
---

<objective>
SpendingLimitForm에 daily_limit_usd/monthly_limit_usd 입력 필드를 추가하고, PolicyRulesSummary에 누적 한도 설정값을 시각적으로 표시한다.

Purpose: CUMUL-08, CUMUL-09 요구사항 구현 -- Admin UI에서 누적 한도를 설정/확인할 수 있어야 한다.
Output: 수정된 SpendingLimitForm, PolicyRulesSummary, policies.tsx 검증 로직, CSS 스타일.
</objective>

<execution_context>
@.planning/phases/137-cumulative-admin-sdk/137-01-PLAN.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/136-cumulative-spending-engine/136-01-SUMMARY.md
@.planning/phases/136-cumulative-spending-engine/136-02-SUMMARY.md
@packages/core/src/schemas/policy.schema.ts
@packages/admin/src/components/policy-forms/spending-limit-form.tsx
@packages/admin/src/components/policy-rules-summary.tsx
@packages/admin/src/pages/policies.tsx
@packages/admin/src/components/form.tsx
@packages/admin/src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: SpendingLimitForm 누적 한도 필드 + policies.tsx 검증 로직</name>
  <files>
    packages/admin/src/components/policy-forms/spending-limit-form.tsx
    packages/admin/src/pages/policies.tsx
  </files>
  <action>
**spending-limit-form.tsx 수정:**

기존 "USD Amount Tiers (Optional)" 섹션 아래에 새로운 "Cumulative USD Limits (Optional)" 섹션을 추가한다.

1. delay_seconds FormField 바로 위에 새 섹션 추가:
```tsx
<h4>Cumulative USD Limits (Optional)</h4>
<div class="policy-form-grid">
  <FormField
    label="Daily Limit USD (24h rolling)"
    name="daily_limit_usd"
    type="number"
    value={(rules.daily_limit_usd as number) ?? ''}
    onChange={handleUsdChange('daily_limit_usd')}
    placeholder="e.g. 500"
  />
  <FormField
    label="Monthly Limit USD (30d rolling)"
    name="monthly_limit_usd"
    type="number"
    value={(rules.monthly_limit_usd as number) ?? ''}
    onChange={handleUsdChange('monthly_limit_usd')}
    placeholder="e.g. 5000"
  />
</div>
```

2. 기존 `handleUsdChange` 함수를 그대로 재사용한다 -- 이미 빈 값/0/NaN 시 필드 삭제, 유효 숫자 시 number로 설정하는 로직이 있다. Zod 스키마가 `.positive()` 이므로 0이나 음수는 서버에서 거부된다.

**policies.tsx 수정:**

`validateRules` 함수의 SPENDING_LIMIT 케이스에 누적 한도 필드 검증을 추가한다:
```typescript
// 기존 instant_max, notify_max, delay_max, delay_seconds 검증 아래에 추가:
const dailyUsd = rules.daily_limit_usd;
if (dailyUsd !== undefined && dailyUsd !== '') {
  const num = Number(dailyUsd);
  if (Number.isNaN(num) || num <= 0) {
    errors.daily_limit_usd = 'Must be a positive number';
  }
}
const monthlyUsd = rules.monthly_limit_usd;
if (monthlyUsd !== undefined && monthlyUsd !== '') {
  const num = Number(monthlyUsd);
  if (Number.isNaN(num) || num <= 0) {
    errors.monthly_limit_usd = 'Must be a positive number';
  }
}
```

검증은 optional이므로 값이 없으면 에러 없음. 값이 있으면 양수여야 한다.

**프리필(Edit) 동작:**
기존 edit 모달의 `openEdit` 함수가 `editRulesObj.value = { ...policy.rules }` 로 전체 rules를 복사하므로, daily_limit_usd/monthly_limit_usd가 rules에 있으면 자동으로 SpendingLimitForm에 프리필된다. 추가 작업 불필요.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/admin` -- 빌드 성공
2. SpendingLimitForm에 "Cumulative USD Limits (Optional)" 섹션이 있고 daily_limit_usd, monthly_limit_usd 두 필드가 렌더링됨
3. policies.tsx의 validateRules에서 daily_limit_usd에 -1 입력 시 'Must be a positive number' 에러 반환
  </verify>
  <done>
SpendingLimitForm에서 daily_limit_usd/monthly_limit_usd 입력 가능하고, 빈 값은 rules에서 제거되며, 기존 정책 수정 시 프리필됨. 검증에서 양수만 허용.
  </done>
</task>

<task type="auto">
  <name>Task 2: PolicyRulesSummary 누적 한도 시각화 + CSS</name>
  <files>
    packages/admin/src/components/policy-rules-summary.tsx
    packages/admin/src/styles/global.css
  </files>
  <action>
**policy-rules-summary.tsx 수정:**

SPENDING_LIMIT 케이스에서 기존 `TierVisualization`만 렌더하던 것을, 누적 한도가 있으면 추가 시각화를 함께 렌더하도록 변경한다.

1. `TierVisualization` 컴포넌트 아래에 `CumulativeLimitSummary` 컴포넌트를 추가한다:

```tsx
function CumulativeLimitSummary({ rules }: { rules: Record<string, unknown> }) {
  const dailyLimit = rules.daily_limit_usd as number | undefined;
  const monthlyLimit = rules.monthly_limit_usd as number | undefined;

  if (!dailyLimit && !monthlyLimit) return null;

  return (
    <div class="cumulative-limits">
      <div class="cumulative-limits-label">Cumulative Limits</div>
      {dailyLimit && (
        <div class="cumulative-limit-row">
          <span class="cumulative-limit-type">Daily (24h)</span>
          <span class="cumulative-limit-value">${formatUsd(dailyLimit)}</span>
        </div>
      )}
      {monthlyLimit && (
        <div class="cumulative-limit-row">
          <span class="cumulative-limit-type">Monthly (30d)</span>
          <span class="cumulative-limit-value">${formatUsd(monthlyLimit)}</span>
        </div>
      )}
    </div>
  );
}
```

2. `formatUsd` 헬퍼 함수를 추가한다:
```tsx
function formatUsd(value: number): string {
  return value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
}
```

3. SPENDING_LIMIT case를 수정하여 TierVisualization + CumulativeLimitSummary를 모두 표시:
```tsx
case 'SPENDING_LIMIT':
  return (
    <div class="spending-limit-summary">
      <TierVisualization rules={rules} />
      <CumulativeLimitSummary rules={rules} />
    </div>
  );
```

**참고**: 현재 기간 내 사용량(current usage) 표시는 실시간 서버 데이터 조회가 필요하다. PolicyRulesSummary는 순수 프레젠테이션 컴포넌트로 rules 객체만 받으므로, 사용량 표시를 위해서는 별도 API 호출이 필요하다. 현 스코프에서는 **설정값(limit)만 표시**하고, 실시간 사용량은 향후 대시보드/상세보기에서 구현한다. (CUMUL-09 "누적 한도 설정값과 현재 사용량이 시각화" 중 설정값은 이 태스크, 사용량은 Admin 대시보드 월렛 상세에서 표시가 더 자연스러움)

실제로 PolicyRulesSummary는 정책 목록 테이블의 Rules 컬럼에서 렌더링되며, 각 정책이 어떤 월렛에 적용되는지에 따라 다른 사용량을 보여줘야 한다. 목록에서 모든 정책별 사용량을 한번에 조회하는 것은 비효율적이므로, 사용량은 간소화하여 "limit 설정값만 표시"로 구현한다.

**global.css 수정:**

다음 스타일을 추가한다 (기존 `.tier-bar-fill--approval` 아래):

```css
/* Cumulative limits in SPENDING_LIMIT summary */
.spending-limit-summary {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.cumulative-limits {
  display: flex;
  flex-direction: column;
  gap: 0.125rem;
  padding-top: 0.25rem;
  border-top: 1px solid var(--color-border);
}

.cumulative-limits-label {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  font-weight: 500;
}

.cumulative-limit-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: var(--font-size-xs);
}

.cumulative-limit-type {
  color: var(--color-text-secondary);
  min-width: 72px;
}

.cumulative-limit-value {
  color: var(--color-warning);
  font-weight: 600;
}
```
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/admin` -- 빌드 성공
2. PolicyRulesSummary에서 daily_limit_usd/monthly_limit_usd가 있는 SPENDING_LIMIT rules를 넣으면 "Cumulative Limits" 라벨 아래 "Daily (24h) $500" / "Monthly (30d) $5,000" 이 표시됨
3. daily_limit_usd/monthly_limit_usd가 없는 rules에서는 CumulativeLimitSummary가 null 반환하여 기존 TierVisualization만 표시됨 (regression 없음)
  </verify>
  <done>
PolicyRulesSummary가 SPENDING_LIMIT 정책의 누적 한도 설정값을 시각적으로 표시하고, 미설정 시 기존 동작이 유지됨.
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build --filter=@waiaas/admin` 빌드 성공
2. SpendingLimitForm에 Cumulative USD Limits 섹션 존재 (daily_limit_usd, monthly_limit_usd)
3. PolicyRulesSummary에 CumulativeLimitSummary 컴포넌트가 조건부 렌더링
4. 기존 Admin 테스트 통과 (regression 없음)
</verification>

<success_criteria>
- CUMUL-08: Admin SpendingLimitForm에서 daily_limit_usd/monthly_limit_usd 입력/수정 가능, 기존 정책 수정 시 프리필
- CUMUL-09 (부분): PolicyRulesSummary에서 누적 한도 설정값이 시각적으로 표시 (사용량은 별도 대시보드 스코프)
- 기존 Admin 빌드/테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/137-cumulative-admin-sdk/137-01-SUMMARY.md`
</output>
