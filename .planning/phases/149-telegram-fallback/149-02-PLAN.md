---
phase: 149-telegram-fallback
plan: 02
type: execute
wave: 2
depends_on: ["149-01"]
files_modified:
  - packages/daemon/src/__tests__/wc-signing-bridge.test.ts
  - packages/daemon/src/__tests__/wc-approval-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "WC 세션 없을 때 fallbackToTelegram()이 호출되고 approval_channel이 'telegram'으로 설정된다"
    - "WC 타임아웃(8000)과 네트워크 에러 시 fallbackToTelegram()이 호출된다"
    - "사용자 거부(4001/5000) 시 fallback 없이 reject만 호출된다"
    - "이미 처리된 approval에 대해 fallback이 동작하지 않는다"
    - "EventBus에 'approval:channel-switched' 이벤트가 올바른 payload로 발행된다"
    - "NotificationService에 'APPROVAL_CHANNEL_SWITCHED' 알림이 전송된다"
    - "stage4Wait에서 WcSigningBridge fallback이 fire-and-forget으로 동작한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/wc-signing-bridge.test.ts"
      provides: "fallback 분기 단위 테스트 (~10개 신규)"
      contains: "fallbackToTelegram"
    - path: "packages/daemon/src/__tests__/wc-approval-integration.test.ts"
      provides: "채널 전환 통합 테스트 (~3개 신규)"
      contains: "channel-switched"
  key_links:
    - from: "packages/daemon/src/__tests__/wc-signing-bridge.test.ts"
      to: "packages/daemon/src/services/wc-signing-bridge.ts"
      via: "WcSigningBridge 인스턴스 생성 with notificationService + eventBus mocks"
      pattern: "notificationService.*eventBus"
---

<objective>
WcSigningBridge fallback 로직과 채널 전환 이벤트에 대한 단위 테스트 및 통합 테스트를 작성한다.

Purpose: Phase 149 구현의 모든 분기(WC 없음/타임아웃/에러 -> fallback, 사용자 거부 -> reject, 이미 처리됨 -> skip)를 테스트로 검증한다.
Output: ~13개 신규 테스트 (단위 ~10 + 통합 ~3)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/149-telegram-fallback/149-RESEARCH.md
@.planning/phases/149-telegram-fallback/149-01-SUMMARY.md
@.planning/phases/148-wc-signing/148-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: WcSigningBridge fallback 단위 테스트 추가</name>
  <files>packages/daemon/src/__tests__/wc-signing-bridge.test.ts</files>
  <action>
    기존 `wc-signing-bridge.test.ts`에 새 `describe('Telegram fallback (Phase 149)')` 블록을 추가한다.

    **테스트 setup 변경:**
    - WcSigningBridgeDeps 생성 시 `notificationService` (vi.fn() mock with `notify` method)와 `eventBus` (vi.fn() mock with `emit` method)를 추가한다.
    - 기존 테스트의 deps 생성 부분도 호환되도록 옵셔널 필드로 추가한다 (기존 테스트에는 undefined로 유지하거나, 동일하게 mock 추가해도 무방).

    **새 describe 블록에 포함할 테스트 (~10개):**

    1. **'signClient null -> fallback to telegram + approval_channel update'**:
       - signClient null로 설정
       - requestSignature() 호출
       - pending_approvals.approval_channel이 'telegram'으로 UPDATE 확인
       - eventBus.emit('approval:channel-switched', ...) 호출 확인 (payload: fromChannel='walletconnect', toChannel='telegram', reason='wc_not_initialized')
       - notificationService.notify('APPROVAL_CHANNEL_SWITCHED', ...) 호출 확인

    2. **'session topic null -> fallback to telegram'**:
       - signClient 존재, topic null
       - approval_channel='telegram' 업데이트 + eventBus emit 확인
       - reason='no_wc_session'

    3. **'session info null -> fallback to telegram'**:
       - signClient + topic 존재, sessionInfo null
       - reason='no_session_info'

    4. **'WC timeout (8000) -> fallback to telegram'**:
       - signClient.request()가 { code: 8000 } 에러 throw
       - fallback 호출 확인 (reason='wc_timeout')
       - approvalWorkflow.reject 미호출 확인

    5. **'WC network error -> fallback to telegram'**:
       - signClient.request()가 Error('network failure') throw
       - fallback 호출 확인 (reason='wc_error')
       - approvalWorkflow.reject 미호출 확인

    6. **'user rejected (4001) -> reject, no fallback'**:
       - signClient.request()가 { code: 4001 } throw
       - approvalWorkflow.reject 호출 확인
       - eventBus.emit 미호출 확인 (fallback 아님)
       - notificationService.notify 미호출 확인

    7. **'user rejected (5000) -> reject, no fallback'**:
       - signClient.request()가 { code: 5000 } throw
       - 6번과 동일한 검증

    8. **'already processed approval -> no fallback'**:
       - pending_approvals에 approved_at 이미 설정 (이미 승인됨)
       - signClient null로 설정하여 fallback 경로 진입
       - eventBus.emit 미호출 + notificationService.notify 미호출 + approval_channel 변경 없음

    9. **'eventBus undefined -> no throw'**:
       - eventBus를 undefined로 설정
       - signClient null -> fallback 경로 진입
       - 에러 없이 정상 반환 (eventBus?.emit은 no-op)

    10. **'notificationService undefined -> no throw'**:
        - notificationService를 undefined로 설정
        - signClient null -> fallback 경로 진입
        - 에러 없이 정상 반환

    **테스트 setup 참고:**
    - in-memory SQLite + pushSchema (기존 패턴 재사용)
    - pending_approvals INSERT 시 `approval_channel` 기본값 'rest_api' 확인
    - fallback 후 SELECT로 approval_channel 값 검증
    - eventBus mock: `{ emit: vi.fn() }`
    - notificationService mock: `{ notify: vi.fn().mockResolvedValue(undefined) }`

    주의: 기존 테스트 22개 + 통합 테스트 7개가 깨지지 않도록 한다. 기존 deps 생성 부분에 notificationService/eventBus가 없어도 WcSigningBridge가 정상 동작해야 한다 (optional deps).
  </action>
  <verify>
    `pnpm test --filter=@waiaas/daemon -- --reporter=verbose src/__tests__/wc-signing-bridge.test.ts` -- 기존 22개 + 신규 ~10개 전부 통과.
  </verify>
  <done>
    WcSigningBridge의 모든 fallback 분기 (WC 없음 3가지 / 타임아웃 / 네트워크 에러 / 사용자 거부 2가지 / 이미 처리됨 / optional deps 2가지)가 테스트로 검증된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: stage4Wait 채널 전환 통합 테스트 추가</name>
  <files>packages/daemon/src/__tests__/wc-approval-integration.test.ts</files>
  <action>
    기존 `wc-approval-integration.test.ts`에 새 `describe('Telegram fallback integration (Phase 149)')` 블록을 추가한다.

    **새 테스트 (~3개):**

    1. **'APPROVAL tier + no WC session -> requestSignature triggers fallback'**:
       - WcSigningBridge를 notificationService + eventBus mock과 함께 생성
       - wcSessionService.getSignClient() -> null 설정
       - stage4Wait 호출 -> requestSignature fire-and-forget
       - 짧은 대기 (setTimeout 또는 flushPromises) 후 eventBus.emit('approval:channel-switched') 호출 확인

    2. **'APPROVAL tier + WC session exists -> no fallback triggered'**:
       - signClient가 정상 응답하도록 설정 (reject/resolve)
       - stage4Wait 호출 -> requestSignature 내부에서 WC 요청 전송
       - eventBus.emit('approval:channel-switched') 미호출 확인

    3. **'WcSigningBridge null -> no crash, no fallback'**:
       - ctx.wcSigningBridge = undefined
       - stage4Wait 호출 -> PIPELINE_HALTED throw
       - eventBus.emit 미호출, 에러 없음
       - (기존 backward-compat 테스트와 유사하지만 eventBus 검증 추가)

    **테스트 setup 참고:**
    - 기존 wc-approval-integration.test.ts의 패턴을 그대로 따른다
    - stage4Wait는 PIPELINE_HALTED를 throw하므로 expect(...).rejects.toThrow() 패턴
    - fire-and-forget 비동기 대기: `await new Promise(r => setTimeout(r, 50))` 후 검증
    - mock WcSigningBridge의 deps에 eventBus/notificationService mock 포함
  </action>
  <verify>
    `pnpm test --filter=@waiaas/daemon -- --reporter=verbose src/__tests__/wc-approval-integration.test.ts` -- 기존 7개 + 신규 ~3개 전부 통과.
  </verify>
  <done>
    stage4Wait에서 WcSigningBridge fallback이 fire-and-forget으로 정상 동작하며, WC 세션 유무에 따라 fallback 여부가 올바르게 결정된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` -- 전체 모노레포 빌드 성공
2. `pnpm test --filter=@waiaas/daemon` -- 전체 테스트 통과 (기존 1,598 + 신규 ~13 = ~1,611)
3. WcSigningBridge fallback 모든 분기 커버: no signClient / no topic / no sessionInfo / timeout / network error / user reject / already processed / optional deps
4. stage4Wait 통합: fallback 트리거 / no fallback / backward compat
</verification>

<success_criteria>
- 신규 테스트 ~13개 전부 통과
- 기존 테스트 회귀 없음 (1,598 -> ~1,611)
- WcSigningBridge fallback 분기 100% 커버
- EventBus emit + NotificationService notify 호출이 테스트로 검증됨
</success_criteria>

<output>
After completion, create `.planning/phases/149-telegram-fallback/149-02-SUMMARY.md`
</output>
