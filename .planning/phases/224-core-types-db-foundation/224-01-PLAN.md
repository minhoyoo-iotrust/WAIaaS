---
phase: 224-core-types-db-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/IChainSubscriber.ts
  - packages/core/src/interfaces/chain-subscriber.types.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/schemas/incoming-transaction.schema.ts
  - packages/core/src/schemas/index.ts
  - packages/core/src/enums/incoming-tx.ts
  - packages/core/src/enums/index.ts
  - packages/core/src/events/event-types.ts
  - packages/core/src/events/index.ts
  - packages/core/src/index.ts
autonomous: true
requirements:
  - SUB-01

must_haves:
  truths:
    - "IChainSubscriber 6-method interface is importable from @waiaas/core in adapter-solana/adapter-evm"
    - "IncomingTransaction type and IncomingTxStatus enum are exported from @waiaas/core"
    - "IncomingTransactionSchema Zod schema is exported from @waiaas/core and validates incoming TX data"
    - "INCOMING_TX_STATUSES const array is exported for use in DB CHECK constraints"
    - "IncomingTxEvent and IncomingTxSuspiciousEvent are defined in WaiaasEventMap"
  artifacts:
    - path: "packages/core/src/interfaces/IChainSubscriber.ts"
      provides: "6-method subscriber interface (subscribe/unsubscribe/subscribedWallets/connect/waitForDisconnect/destroy)"
      contains: "export interface IChainSubscriber"
    - path: "packages/core/src/interfaces/chain-subscriber.types.ts"
      provides: "IncomingTransaction type re-exported from Zod schema"
      contains: "IncomingTransaction"
    - path: "packages/core/src/schemas/incoming-transaction.schema.ts"
      provides: "Zod SSoT schema for IncomingTransaction + IncomingTxStatus"
      exports: ["IncomingTransactionSchema", "IncomingTxStatusEnum", "INCOMING_TX_STATUSES"]
    - path: "packages/core/src/enums/incoming-tx.ts"
      provides: "SSoT const array + Zod enum + TS type for IncomingTxStatus"
      exports: ["INCOMING_TX_STATUSES", "IncomingTxStatus", "IncomingTxStatusEnum"]
    - path: "packages/core/src/events/event-types.ts"
      provides: "IncomingTxEvent + IncomingTxSuspiciousEvent payloads in WaiaasEventMap"
      contains: "transaction:incoming"
  key_links:
    - from: "packages/core/src/interfaces/IChainSubscriber.ts"
      to: "packages/core/src/interfaces/chain-subscriber.types.ts"
      via: "import type { IncomingTransaction }"
      pattern: "import.*IncomingTransaction.*chain-subscriber\\.types"
    - from: "packages/core/src/interfaces/chain-subscriber.types.ts"
      to: "packages/core/src/schemas/incoming-transaction.schema.ts"
      via: "re-export from Zod SSoT schema"
      pattern: "IncomingTransaction"
    - from: "packages/core/src/enums/incoming-tx.ts"
      to: "packages/core/src/schemas/incoming-transaction.schema.ts"
      via: "INCOMING_TX_STATUSES used in Zod enum"
      pattern: "INCOMING_TX_STATUSES"
    - from: "packages/core/src/index.ts"
      to: "packages/core/src/interfaces/index.ts"
      via: "barrel re-export of IChainSubscriber + IncomingTransaction"
      pattern: "IChainSubscriber"
---

<objective>
Define the IChainSubscriber 6-method interface, IncomingTransaction Zod SSoT schema, IncomingTxStatus enum, and EventBus event types in @waiaas/core so that all downstream packages (adapter-solana, adapter-evm, daemon) can import and implement against these types.

Purpose: Establish the type foundation that Phase 225 (chain subscriber implementations), Phase 226 (monitor service), and Phase 228 (REST API) all depend on. Without these types, no downstream code compiles.

Output: 5 new files + 5 modified barrel exports in packages/core, all passing typecheck.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/224-core-types-db-foundation/224-RESEARCH.md

# Existing patterns to follow:
@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/schemas/wallet.schema.ts
@packages/core/src/enums/chain.ts
@packages/core/src/enums/index.ts
@packages/core/src/events/event-types.ts
@packages/core/src/events/index.ts
@packages/core/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IncomingTxStatus enum + IChainSubscriber interface + types</name>
  <files>
    packages/core/src/enums/incoming-tx.ts
    packages/core/src/enums/index.ts
    packages/core/src/interfaces/chain-subscriber.types.ts
    packages/core/src/interfaces/IChainSubscriber.ts
    packages/core/src/interfaces/index.ts
  </files>
  <action>
1. Create `packages/core/src/enums/incoming-tx.ts` following the pattern from `enums/wallet.ts`:
   - `export const INCOMING_TX_STATUSES = ['DETECTED', 'CONFIRMED'] as const;`
   - `export type IncomingTxStatus = (typeof INCOMING_TX_STATUSES)[number];`
   - `export const IncomingTxStatusEnum = z.enum(INCOMING_TX_STATUSES);` (import z from 'zod')
   - This SSoT array will be used by Drizzle CHECK constraints and migrate.ts `inList()`.

2. Add re-exports to `packages/core/src/enums/index.ts`:
   ```typescript
   export {
     INCOMING_TX_STATUSES,
     type IncomingTxStatus,
     IncomingTxStatusEnum,
   } from './incoming-tx.js';
   ```

3. Create `packages/core/src/interfaces/chain-subscriber.types.ts` following the pattern from `chain-adapter.types.ts`:
   - Import `ChainType` from `../enums/chain.js`
   - Import `IncomingTxStatus` from `../enums/incoming-tx.js`
   - Define `IncomingTransaction` interface with 13 fields:
     - `id: string` (UUID v7)
     - `txHash: string`
     - `walletId: string`
     - `fromAddress: string`
     - `amount: string` (bigint-safe string representation)
     - `tokenAddress: string | null` (null for native transfers)
     - `chain: ChainType`
     - `network: string`
     - `status: IncomingTxStatus`
     - `blockNumber: number | null`
     - `detectedAt: number` (Unix epoch seconds)
     - `confirmedAt: number | null`
     - `isSuspicious?: boolean`

4. Create `packages/core/src/interfaces/IChainSubscriber.ts` following the pattern from `IChainAdapter.ts`:
   - Import `ChainType` from `../enums/chain.js`
   - Import `IncomingTransaction` from `./chain-subscriber.types.js`
   - Define `IChainSubscriber` interface with `readonly chain: ChainType` property and 6 methods:
     - `subscribe(walletId: string, address: string, network: string, onTransaction: (tx: IncomingTransaction) => void): Promise<void>`
     - `unsubscribe(walletId: string): Promise<void>`
     - `subscribedWallets(): string[]`
     - `connect(): Promise<void>`
     - `waitForDisconnect(): Promise<void>`
     - `destroy(): Promise<void>`
   - Add JSDoc comment blocks for each method explaining its purpose.

5. Add re-exports to `packages/core/src/interfaces/index.ts`:
   - Add `export type { IncomingTransaction } from './chain-subscriber.types.js';`
   - Add `export type { IChainSubscriber } from './IChainSubscriber.js';`
   - Group under a `// v27.1 incoming transaction subscriber types` comment section.
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=@waiaas/core` to confirm all types compile.
Verify exports: `grep -c 'IChainSubscriber\|IncomingTransaction\|INCOMING_TX_STATUSES' packages/core/src/index.ts` should show these are exported.
  </verify>
  <done>
IChainSubscriber interface with 6 methods is defined and importable from @waiaas/core. IncomingTransaction type with 13 fields and IncomingTxStatus enum ('DETECTED' | 'CONFIRMED') are exported. INCOMING_TX_STATUSES const array is available for CHECK constraints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create IncomingTransaction Zod schema + event types + barrel re-exports</name>
  <files>
    packages/core/src/schemas/incoming-transaction.schema.ts
    packages/core/src/schemas/index.ts
    packages/core/src/events/event-types.ts
    packages/core/src/events/index.ts
    packages/core/src/index.ts
  </files>
  <action>
1. Create `packages/core/src/schemas/incoming-transaction.schema.ts` following the Zod SSoT pattern from `wallet.schema.ts`:
   - Import `z` from 'zod'
   - Import `ChainTypeEnum` from `../enums/index.js`
   - Import `IncomingTxStatusEnum` from `../enums/index.js`
   - Define `IncomingTransactionSchema = z.object({...})` with all 13 fields:
     - `id: z.string()` (UUID v7)
     - `txHash: z.string()`
     - `walletId: z.string()`
     - `fromAddress: z.string()`
     - `amount: z.string()` (bigint-safe string)
     - `tokenAddress: z.string().nullable()`
     - `chain: ChainTypeEnum`
     - `network: z.string()`
     - `status: IncomingTxStatusEnum`
     - `blockNumber: z.number().int().nullable()`
     - `detectedAt: z.number().int()`
     - `confirmedAt: z.number().int().nullable()`
     - `isSuspicious: z.boolean().optional()`
   - `export type IncomingTransaction = z.infer<typeof IncomingTransactionSchema>;`
   - Note: The `chain-subscriber.types.ts` file's IncomingTransaction interface is the same shape but defined independently for the interface contract. The Zod schema is the SSoT for validation and OpenAPI generation.

2. Add re-exports to `packages/core/src/schemas/index.ts`:
   ```typescript
   export {
     IncomingTransactionSchema,
     type IncomingTransaction as IncomingTransactionDto,
   } from './incoming-transaction.schema.js';
   ```
   - Use `IncomingTransactionDto` alias in schemas to avoid name collision with the interface type. The interface type from `chain-subscriber.types.ts` is the canonical one for code.

3. Add event types to `packages/core/src/events/event-types.ts`:
   - Add `IncomingTxEvent` interface:
     ```typescript
     export interface IncomingTxEvent {
       walletId: string;
       txHash: string;
       fromAddress: string;
       amount: string;
       tokenAddress: string | null;
       chain: string;
       network: string;
       status: string;
       timestamp: number;
     }
     ```
   - Add `IncomingTxSuspiciousEvent` interface:
     ```typescript
     export interface IncomingTxSuspiciousEvent extends IncomingTxEvent {
       suspiciousReasons: string[];
     }
     ```
   - Add to `WaiaasEventMap`:
     ```typescript
     'transaction:incoming': IncomingTxEvent;
     'transaction:incoming:suspicious': IncomingTxSuspiciousEvent;
     ```
   - Update the file's JSDoc header to mention the 2 new events (total: 7 event types).

4. Add event type re-exports to `packages/core/src/events/index.ts`:
   - Add `IncomingTxEvent` and `IncomingTxSuspiciousEvent` to the type exports.

5. Update `packages/core/src/index.ts` barrel:
   - In the Enums section, add: `INCOMING_TX_STATUSES, type IncomingTxStatus, IncomingTxStatusEnum`
   - In the Interfaces type section, add: `type IncomingTransaction, type IChainSubscriber`
   - In the Schemas section, add: `IncomingTransactionSchema, type IncomingTransactionDto`
   - In the Events section, add: `type IncomingTxEvent, type IncomingTxSuspiciousEvent`
   - Update comment counts (enums: 13 SSoT, events: 7 types).
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=@waiaas/core` to confirm all types compile.
Run `pnpm turbo run lint --filter=@waiaas/core` to confirm no lint errors.
Verify the following are importable:
- `import { IncomingTransactionSchema, INCOMING_TX_STATUSES, IncomingTxStatusEnum } from '@waiaas/core';`
- `import type { IChainSubscriber, IncomingTransaction, IncomingTxEvent } from '@waiaas/core';`
  </verify>
  <done>
IncomingTransactionSchema Zod SSoT is defined and exported. IncomingTxEvent and IncomingTxSuspiciousEvent are in WaiaasEventMap (7 total event types). All types, schemas, and enums are re-exported from @waiaas/core's barrel export. @waiaas/core passes typecheck and lint.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/core` passes with 0 errors
2. `pnpm turbo run lint --filter=@waiaas/core` passes with 0 errors
3. IChainSubscriber has exactly 6 methods: subscribe, unsubscribe, subscribedWallets, connect, waitForDisconnect, destroy
4. INCOMING_TX_STATUSES = ['DETECTED', 'CONFIRMED'] is a const array usable in CHECK constraints
5. IncomingTransactionSchema validates a well-formed incoming TX object
6. WaiaasEventMap has 7 event keys (5 existing + 2 new incoming TX events)
</verification>

<success_criteria>
- IChainSubscriber 6-method interface defined and importable from @waiaas/core
- IncomingTransaction type (13 fields) and IncomingTxStatus enum (2 values) exported
- IncomingTransactionSchema Zod SSoT schema exported for validation/OpenAPI
- INCOMING_TX_STATUSES const array exported for DB CHECK constraints
- 2 new event types (transaction:incoming, transaction:incoming:suspicious) in WaiaasEventMap
- @waiaas/core typecheck + lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/224-core-types-db-foundation/224-01-SUMMARY.md`
</output>
