---
phase: 224-core-types-db-foundation
plan: 02
type: execute
wave: 2
depends_on: ["224-01"]
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/infrastructure/database/index.ts
  - packages/daemon/src/__tests__/migration-chain.test.ts
autonomous: true
requirements:
  - STO-01

must_haves:
  truths:
    - "DB v21 migration creates incoming_transactions table with 13 columns (including is_suspicious) and UNIQUE(tx_hash, wallet_id) constraint"
    - "DB v21 migration creates incoming_tx_cursors table with 6 columns"
    - "DB v21 migration adds wallets.monitor_incoming INTEGER NOT NULL DEFAULT 0 column"
    - "DB v21 migration creates 4 indexes on incoming_transactions (wallet_detected, detected_at, chain_network, status partial)"
    - "pushSchema DDL includes the 2 new tables and wallets.monitor_incoming column for fresh databases"
    - "Drizzle schema defines incomingTransactions and incomingTxCursors tables matching the DDL"
    - "Migration chain tests (T-1 through T-6) all pass with updated fixtures"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "LATEST_SCHEMA_VERSION=21, v21 migration, updated pushSchema DDL"
      contains: "version: 21"
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "Drizzle table definitions for incomingTransactions + incomingTxCursors + wallets.monitorIncoming"
      contains: "incomingTransactions"
    - path: "packages/daemon/src/infrastructure/database/index.ts"
      provides: "Re-exports incomingTransactions and incomingTxCursors from schema"
      contains: "incomingTransactions"
    - path: "packages/daemon/src/__tests__/migration-chain.test.ts"
      provides: "Updated EXPECTED_INDEXES and ALL_TABLES with incoming TX tables + indexes"
      contains: "incoming_transactions"
  key_links:
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "@waiaas/core"
      via: "import INCOMING_TX_STATUSES, CHAIN_TYPES for inList() CHECK constraints"
      pattern: "INCOMING_TX_STATUSES"
    - from: "packages/daemon/src/infrastructure/database/schema.ts"
      to: "@waiaas/core"
      via: "import INCOMING_TX_STATUSES for buildCheckSql CHECK constraint"
      pattern: "INCOMING_TX_STATUSES"
    - from: "packages/daemon/src/infrastructure/database/schema.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts (wallets table)"
      via: "incomingTransactions.walletId references wallets.id with ON DELETE CASCADE"
      pattern: "references.*wallets\\.id"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts (pushSchema DDL)"
      to: "packages/daemon/src/infrastructure/database/migrate.ts (v21 migration)"
      via: "DDL must produce identical schema as running migration on existing DB"
      pattern: "incoming_transactions"
---

<objective>
Add DB v21 migration (incoming_transactions table, incoming_tx_cursors table, wallets.monitor_incoming column) with synchronized pushSchema DDL, Drizzle ORM schema definitions, and updated migration chain tests.

Purpose: Establish the persistent storage layer that IncomingTxQueue (Phase 226) flushes to and that REST API (Phase 228) queries from. Without the DB tables, no incoming transactions can be recorded.

Output: v21 migration in migrate.ts, 2 new Drizzle table definitions in schema.ts, updated migration chain test fixtures.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/224-core-types-db-foundation/224-RESEARCH.md
@.planning/phases/224-core-types-db-foundation/224-01-SUMMARY.md

# Key files to modify:
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/index.ts
@packages/daemon/src/__tests__/migration-chain.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v21 migration + update pushSchema DDL + bump LATEST_SCHEMA_VERSION</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
  </files>
  <action>
**Three synchronized changes in migrate.ts (all must match or T-2/T-6 equivalence tests fail):**

1. **Bump LATEST_SCHEMA_VERSION from 20 to 21.**

2. **Update `getCreateTableStatements()`:**
   - Add `monitor_incoming INTEGER NOT NULL DEFAULT 0` column to the wallets CREATE TABLE DDL (after `suspension_reason TEXT`, before `owner_approval_method TEXT CHECK ...`).
   - Add new Table 16: `incoming_transactions` with 13 columns:
     ```sql
     CREATE TABLE IF NOT EXISTS incoming_transactions (
       id TEXT PRIMARY KEY,
       tx_hash TEXT NOT NULL,
       wallet_id TEXT NOT NULL REFERENCES wallets(id) ON DELETE CASCADE,
       from_address TEXT NOT NULL,
       amount TEXT NOT NULL,
       token_address TEXT,
       chain TEXT NOT NULL CHECK (chain IN (${inList(CHAIN_TYPES)})),
       network TEXT NOT NULL,
       status TEXT NOT NULL DEFAULT 'DETECTED' CHECK (status IN (${inList(INCOMING_TX_STATUSES)})),
       block_number INTEGER,
       detected_at INTEGER NOT NULL,
       confirmed_at INTEGER,
       is_suspicious INTEGER NOT NULL DEFAULT 0,
       UNIQUE(tx_hash, wallet_id)
     )
     ```
   - Import `INCOMING_TX_STATUSES` from `@waiaas/core` (add to existing import).
   - Add new Table 17: `incoming_tx_cursors` with 6 columns:
     ```sql
     CREATE TABLE IF NOT EXISTS incoming_tx_cursors (
       wallet_id TEXT PRIMARY KEY REFERENCES wallets(id) ON DELETE CASCADE,
       chain TEXT NOT NULL,
       network TEXT NOT NULL,
       last_signature TEXT,
       last_block_number INTEGER,
       updated_at INTEGER NOT NULL
     )
     ```
   - Update the file's top JSDoc to mention "18 tables" (was "16 tables").

3. **Update `getCreateIndexStatements()`:**
   - Add 4 indexes for incoming_transactions after existing index blocks:
     ```sql
     'CREATE INDEX IF NOT EXISTS idx_incoming_tx_wallet_detected ON incoming_transactions(wallet_id, detected_at DESC)',
     'CREATE INDEX IF NOT EXISTS idx_incoming_tx_detected_at ON incoming_transactions(detected_at)',
     'CREATE INDEX IF NOT EXISTS idx_incoming_tx_chain_network ON incoming_transactions(chain, network)',
     "CREATE INDEX IF NOT EXISTS idx_incoming_tx_status ON incoming_transactions(status) WHERE status = 'DETECTED'",
     ```
   - Group under a `// incoming_transactions indexes` comment.

4. **Add v21 migration to MIGRATIONS array** (after v20 entry):
   ```typescript
   MIGRATIONS.push({
     version: 21,
     description: 'Add incoming transaction monitoring tables and wallet opt-in column',
     up: (sqlite) => {
       // 1. wallets.monitor_incoming opt-in column
       sqlite.exec('ALTER TABLE wallets ADD COLUMN monitor_incoming INTEGER NOT NULL DEFAULT 0');

       // 2. incoming_transactions table (13 columns + UNIQUE constraint)
       sqlite.exec(`CREATE TABLE incoming_transactions (
         id TEXT PRIMARY KEY,
         tx_hash TEXT NOT NULL,
         wallet_id TEXT NOT NULL REFERENCES wallets(id) ON DELETE CASCADE,
         from_address TEXT NOT NULL,
         amount TEXT NOT NULL,
         token_address TEXT,
         chain TEXT NOT NULL CHECK (chain IN (${inList(CHAIN_TYPES)})),
         network TEXT NOT NULL,
         status TEXT NOT NULL DEFAULT 'DETECTED' CHECK (status IN (${inList(INCOMING_TX_STATUSES)})),
         block_number INTEGER,
         detected_at INTEGER NOT NULL,
         confirmed_at INTEGER,
         is_suspicious INTEGER NOT NULL DEFAULT 0,
         UNIQUE(tx_hash, wallet_id)
       )`);

       // 3. incoming_tx_cursors table (6 columns)
       sqlite.exec(`CREATE TABLE incoming_tx_cursors (
         wallet_id TEXT PRIMARY KEY REFERENCES wallets(id) ON DELETE CASCADE,
         chain TEXT NOT NULL,
         network TEXT NOT NULL,
         last_signature TEXT,
         last_block_number INTEGER,
         updated_at INTEGER NOT NULL
       )`);

       // 4. Indexes on incoming_transactions
       sqlite.exec('CREATE INDEX idx_incoming_tx_wallet_detected ON incoming_transactions(wallet_id, detected_at DESC)');
       sqlite.exec('CREATE INDEX idx_incoming_tx_detected_at ON incoming_transactions(detected_at)');
       sqlite.exec('CREATE INDEX idx_incoming_tx_chain_network ON incoming_transactions(chain, network)');
       sqlite.exec("CREATE INDEX idx_incoming_tx_status ON incoming_transactions(status) WHERE status = 'DETECTED'");
     },
   });
   ```
   **IMPORTANT:** Migration DDL uses `CREATE TABLE` (not `CREATE TABLE IF NOT EXISTS`) because this is a fresh table creation. pushSchema DDL uses `CREATE TABLE IF NOT EXISTS` for idempotency on startup.

5. **Update the `pushSchema()` JSDoc** initial schema description to mention 18 tables (not 16), and update the `schema_version` initial insert description from '16 tables' to '18 tables'.
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=@waiaas/daemon` to confirm import compiles.
Run `pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern=migration-chain` to confirm migration chain tests pass (they will fail until Task 2 updates the test fixtures).
  </verify>
  <done>
LATEST_SCHEMA_VERSION is 21. pushSchema DDL includes incoming_transactions (13 cols), incoming_tx_cursors (6 cols), wallets.monitor_incoming column, and 4 new indexes. v21 migration performs identical DDL changes for existing databases. INCOMING_TX_STATUSES from @waiaas/core is used in CHECK constraints (SSoT).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Drizzle schema tables + update migration chain tests + re-exports</name>
  <files>
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/infrastructure/database/index.ts
    packages/daemon/src/__tests__/migration-chain.test.ts
  </files>
  <action>
1. **Update `packages/daemon/src/infrastructure/database/schema.ts`:**

   a. Add `INCOMING_TX_STATUSES` to the existing `@waiaas/core` import.

   b. Add `monitorIncoming` column to the `wallets` table definition:
      ```typescript
      monitorIncoming: integer('monitor_incoming', { mode: 'boolean' }).notNull().default(false),
      ```
      Place it after `ownerApprovalMethod`.

   c. Add `incomingTransactions` table definition after the last existing table (wc_store or similar):
      ```typescript
      // ---------------------------------------------------------------------------
      // Table 16: incoming_transactions -- detected incoming transfers to monitored wallets
      // v27.1: Added for incoming transaction monitoring
      // ---------------------------------------------------------------------------

      export const incomingTransactions = sqliteTable(
        'incoming_transactions',
        {
          id: text('id').primaryKey(),
          txHash: text('tx_hash').notNull(),
          walletId: text('wallet_id').notNull().references(() => wallets.id, { onDelete: 'cascade' }),
          fromAddress: text('from_address').notNull(),
          amount: text('amount').notNull(),
          tokenAddress: text('token_address'),
          chain: text('chain').notNull(),
          network: text('network').notNull(),
          status: text('status').notNull().default('DETECTED'),
          blockNumber: integer('block_number'),
          detectedAt: integer('detected_at', { mode: 'timestamp' }).notNull(),
          confirmedAt: integer('confirmed_at', { mode: 'timestamp' }),
          isSuspicious: integer('is_suspicious', { mode: 'boolean' }).notNull().default(false),
        },
        (table) => [
          index('idx_incoming_tx_wallet_detected').on(table.walletId, table.detectedAt),
          index('idx_incoming_tx_detected_at').on(table.detectedAt),
          index('idx_incoming_tx_chain_network').on(table.chain, table.network),
          index('idx_incoming_tx_status').on(table.status),
          uniqueIndex('idx_incoming_tx_unique').on(table.txHash, table.walletId),
          check('check_incoming_chain', buildCheckSql('chain', CHAIN_TYPES)),
          check('check_incoming_status', buildCheckSql('status', INCOMING_TX_STATUSES)),
        ],
      );
      ```

   d. Add `incomingTxCursors` table definition:
      ```typescript
      // ---------------------------------------------------------------------------
      // Table 17: incoming_tx_cursors -- per-wallet cursor for gap recovery
      // v27.1: Added for incoming transaction monitoring
      // ---------------------------------------------------------------------------

      export const incomingTxCursors = sqliteTable('incoming_tx_cursors', {
        walletId: text('wallet_id').primaryKey().references(() => wallets.id, { onDelete: 'cascade' }),
        chain: text('chain').notNull(),
        network: text('network').notNull(),
        lastSignature: text('last_signature'),
        lastBlockNumber: integer('last_block_number'),
        updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull(),
      });
      ```

   e. Update the file's top JSDoc comment to include the 2 new tables in the table count ("17 tables") and table list.

2. **Update `packages/daemon/src/infrastructure/database/index.ts`:**
   - Add `incomingTransactions` and `incomingTxCursors` to the schema.js re-exports.

3. **Update `packages/daemon/src/__tests__/migration-chain.test.ts`:**

   a. Add 4 new indexes to `EXPECTED_INDEXES` array:
      - `'idx_incoming_tx_chain_network'`
      - `'idx_incoming_tx_detected_at'`
      - `'idx_incoming_tx_status'`
      - `'idx_incoming_tx_wallet_detected'`
      Maintain alphabetical sort order.
      Also add `'idx_incoming_tx_unique'` (the UNIQUE index on tx_hash + wallet_id).

   b. Add 2 new tables to `ALL_TABLES` array:
      - `'incoming_transactions'`
      - `'incoming_tx_cursors'`

   c. Update the T-4 test comment from "All 16 tables" to "All 18 tables" (if present).

   d. Verify the T-2/T-6 schema equivalence tests will pass by ensuring the fresh DB DDL (pushSchema) and migration path produce identical table structures. The UNIQUE(tx_hash, wallet_id) constraint in the migration DDL creates an implicit `sqlite_autoindex_incoming_transactions_1`. Ensure the EXPECTED_INDEXES does NOT include this autoindex (SQLite autoindexes are not named consistently).
  </action>
  <verify>
Run `pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern=migration-chain` to confirm all migration chain tests pass (T-1 through T-11).
Run `pnpm turbo run typecheck --filter=@waiaas/daemon` to confirm Drizzle schema compiles.
Run `pnpm turbo run lint --filter=@waiaas/daemon` to confirm no lint errors.
  </verify>
  <done>
Drizzle schema defines incomingTransactions (13 columns, 5 indexes, 2 CHECK constraints) and incomingTxCursors (6 columns). wallets table has monitorIncoming column. Both tables re-exported from database index.ts. Migration chain tests updated with 5 new indexes and 2 new tables. All tests (T-1 through T-11) pass. Daemon typecheck + lint pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` passes with 0 errors
2. `pnpm turbo run lint --filter=@waiaas/daemon` passes with 0 errors
3. `pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern=migration-chain` passes all tests
4. LATEST_SCHEMA_VERSION is 21 (verified by grep)
5. pushSchema DDL creates incoming_transactions with 13 columns, incoming_tx_cursors with 6 columns, wallets.monitor_incoming column
6. v21 migration up() creates identical tables/indexes for existing databases
7. Drizzle schema has incomingTransactions and incomingTxCursors tables exported
8. EXPECTED_INDEXES in tests includes 5 new incoming TX indexes
9. ALL_TABLES in tests includes 'incoming_transactions' and 'incoming_tx_cursors'
</verification>

<success_criteria>
- LATEST_SCHEMA_VERSION = 21
- Fresh DB (pushSchema) creates incoming_transactions, incoming_tx_cursors, and wallets.monitor_incoming
- Existing DB (v20 -> v21 migration) gets identical schema via ALTER TABLE + CREATE TABLE
- Drizzle ORM schema defines incomingTransactions + incomingTxCursors with correct types, indexes, and CHECK constraints
- Migration chain tests T-1 through T-11 all pass
- Schema equivalence tests (T-2/T-6) confirm fresh and migrated DBs are identical
</success_criteria>

<output>
After completion, create `.planning/phases/224-core-types-db-foundation/224-02-SUMMARY.md`
</output>
