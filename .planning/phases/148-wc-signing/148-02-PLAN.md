---
phase: 148-wc-signing
plan: 02
type: execute
wave: 2
depends_on: ["148-01"]
files_modified:
  - packages/daemon/src/__tests__/wc-signing-bridge.test.ts
  - packages/daemon/src/__tests__/wc-approval-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "WcSigningBridge.requestSignature가 WC 세션 있으면 signClient.request를 호출한다"
    - "WcSigningBridge.requestSignature가 WC 세션 없으면 조용히 반환한다"
    - "EVM 서명 응답 시 verifySIWE 검증 후 approvalWorkflow.approve가 호출된다"
    - "Solana 서명 응답 시 Ed25519 검증 후 approvalWorkflow.approve가 호출된다"
    - "Owner가 WC에서 거부(4001/5000)하면 approvalWorkflow.reject가 호출된다"
    - "WC 타임아웃(8000) 에러 시 reject하지 않고 기존 만료 워커에 위임한다"
    - "approval_channel이 walletconnect로 기록된다"
    - "stage4Wait APPROVAL 분기에서 wcSigningBridge.requestSignature가 fire-and-forget으로 호출된다"
  artifacts:
    - path: "packages/daemon/src/__tests__/wc-signing-bridge.test.ts"
      provides: "WcSigningBridge 단위 테스트 (15-20개)"
      min_lines: 200
    - path: "packages/daemon/src/__tests__/wc-approval-integration.test.ts"
      provides: "stage4Wait + WcSigningBridge 통합 테스트 (5-8개)"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/__tests__/wc-signing-bridge.test.ts"
      to: "packages/daemon/src/services/wc-signing-bridge.ts"
      via: "직접 import + 모킹된 deps"
      pattern: "new WcSigningBridge"
    - from: "packages/daemon/src/__tests__/wc-approval-integration.test.ts"
      to: "packages/daemon/src/pipeline/stages.ts"
      via: "stage4Wait() 호출 + WcSigningBridge mock"
      pattern: "stage4Wait.*wcSigningBridge"
---

<objective>
WcSigningBridge 단위 테스트 + stage4Wait 통합 테스트로 WC 서명 요청/응답/거부/타임아웃 전체 경로 검증

Purpose: 148-01에서 구현한 WC 서명 브릿지의 모든 분기(세션 있음/없음, EVM/Solana, 승인/거부/타임아웃, 에러 핸들링)를 테스트로 검증하고, stage4Wait의 fire-and-forget 연동을 통합 테스트로 확인한다.
Output: wc-signing-bridge.test.ts, wc-approval-integration.test.ts
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/148-wc-signing/148-RESEARCH.md
@.planning/phases/148-wc-signing/148-01-SUMMARY.md

Key source files to reference:
@packages/daemon/src/services/wc-signing-bridge.ts -- 148-01에서 생성된 브릿지
@packages/daemon/src/pipeline/stages.ts -- stage4Wait 수정된 버전
@packages/daemon/src/__tests__/wc-session-service.test.ts -- 기존 WC 테스트 패턴 참고
@packages/daemon/src/__tests__/wc-pairing.test.ts -- 기존 WC 테스트 패턴 참고
@packages/daemon/src/__tests__/approval-workflow.test.ts -- ApprovalWorkflow 테스트 패턴 참고 (있다면)
</context>

<tasks>

<task type="auto">
  <name>Task 1: WcSigningBridge 단위 테스트</name>
  <files>packages/daemon/src/__tests__/wc-signing-bridge.test.ts</files>
  <action>
**새 파일** `packages/daemon/src/__tests__/wc-signing-bridge.test.ts` 생성.

기존 wc-session-service.test.ts 패턴을 참고하여 모킹 전략 수립. `WcSigningBridge`의 deps를 모킹한다:
- `wcSessionService`: `getSignClient()`, `getSessionTopic()`, `getSessionInfo()` 모킹
- `approvalWorkflow`: `approve()`, `reject()` 모킹
- `sqlite`: better-sqlite3 in-memory DB 사용 (`:memory:`)으로 pending_approvals 테이블 생성 후 실제 쿼리 검증
- `signClient.request()`: 모킹 (resolve/reject 제어)

**SQLite 테스트 설정:**
- `better-sqlite3` in-memory DB 생성
- `pending_approvals` 테이블 생성 (최소한의 스키마): `id TEXT PK, tx_id TEXT, expires_at INTEGER, approved_at INTEGER, rejected_at INTEGER, owner_signature TEXT, approval_channel TEXT DEFAULT 'rest_api', required_by INTEGER, created_at INTEGER`
- `transactions` 테이블 생성 (최소): `id TEXT PK, status TEXT, wallet_id TEXT, ...` (approve/reject가 UPDATE하므로 필요)
- `wc_sessions` 테이블도 필요할 수 있음 (getSessionInfo가 DB 조회하므로)

**테스트 케이스 (describe: 'WcSigningBridge'):**

**describe: 'requestSignature - WC 세션 없음':**
1. `should return silently when signClient is null` -- getSignClient() returns null -> signClient.request 미호출
2. `should return silently when no session topic for wallet` -- getSessionTopic() returns null -> signClient.request 미호출
3. `should return silently when no session info for wallet` -- getSessionInfo() returns null -> signClient.request 미호출

**describe: 'requestSignature - EVM (personal_sign)':**
4. `should call signClient.request with personal_sign method` -- chain='ethereum', 검증: request.method === 'personal_sign', params[1] === ownerAddress
5. `should use SIWE message format` -- 검증: params[0]이 0x로 시작하고 hex-encoded SIWE 메시지 포함 ('Approve transaction')
6. `should call approvalWorkflow.approve on successful signature` -- signClient.request resolves -> approve 호출 확인
7. `should verify SIWE signature before approving` -- verifySIWE를 모킹하여 검증 실패 시 approve 미호출 확인. 이를 위해 verifySIWE 모듈을 mock할 수 있다면 mock, 아니면 signClient.request가 invalid signature를 반환하는 시나리오.
8. `should update approval_channel to walletconnect` -- requestSignature 호출 후 DB에서 approval_channel='walletconnect' 확인

**describe: 'requestSignature - Solana (solana_signMessage)':**
9. `should call signClient.request with solana_signMessage method` -- chain='solana', 검증: request.method === 'solana_signMessage'
10. `should send base58-encoded message` -- params.message가 base58 인코딩된 문자열
11. `should call approvalWorkflow.approve on successful signature` -- signClient.request resolves -> approve 호출 확인
12. `should pass pubkey in params` -- params.pubkey === ownerAddress

**describe: 'requestSignature - Owner 거부':**
13. `should call approvalWorkflow.reject on user rejected (code 4001)` -- signClient.request rejects with {code: 4001} -> reject 호출 확인
14. `should call approvalWorkflow.reject on user rejected (code 5000)` -- signClient.request rejects with {code: 5000} -> reject 호출 확인

**describe: 'requestSignature - 타임아웃/네트워크 에러':**
15. `should NOT reject on request expired (code 8000)` -- signClient.request rejects with {code: 8000} -> reject 미호출 (기존 워커가 처리)
16. `should NOT reject on unknown network error` -- signClient.request rejects with generic Error -> reject 미호출
17. `should log warning on errors` -- console.warn 호출 확인

**describe: 'requestSignature - 타임아웃 동기화':**
18. `should use expires_at from pending_approvals for WC expiry` -- pending_approvals.expires_at를 미래 시간으로 설정 -> signClient.request의 expiry 인자가 해당 남은 초와 일치

**모킹 전략:**
- `verifySIWE`는 모듈 모킹이 복잡할 수 있으므로, WcSigningBridge 생성자에서 verifySIWE를 deps로 주입 가능하게 변경하거나, 또는 148-01에서 이미 직접 import 사용 시 vi.mock으로 모킹. vitest의 `vi.mock('../api/middleware/siwe-verify.js', ...)` 패턴 사용.
- `sodium-native`도 `vi.mock` 또는 `createRequire` 패턴을 모킹.
- 실제 모킹이 어려우면 `handleSignatureResponse`를 별도 protected/public 메서드로 분리하여 spy 가능하게 하거나, `(bridge as any)` 접근 패턴 사용 (기존 wc-session-service.test.ts 패턴).

**빌드/실행:**
- vitest 패턴 사용 (기존 테스트와 동일)
- import path 정확히 맞추기 (.js 확장자 포함)
  </action>
  <verify>
- `pnpm test --filter=@waiaas/daemon -- --reporter=verbose wc-signing-bridge` -- 모든 테스트 통과
- 테스트 수 15개 이상
- `pnpm test --filter=@waiaas/daemon` -- 기존 테스트 포함 전체 통과 (회귀 없음)
  </verify>
  <done>
WcSigningBridge의 모든 분기(세션 없음 3개, EVM 승인 5개, Solana 승인 4개, 거부 2개, 타임아웃 3개, 동기화 1개)가 단위 테스트로 검증되고 전체 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: stage4Wait + WcSigningBridge 통합 테스트</name>
  <files>packages/daemon/src/__tests__/wc-approval-integration.test.ts</files>
  <action>
**새 파일** `packages/daemon/src/__tests__/wc-approval-integration.test.ts` 생성.

stage4Wait 함수를 실제로 호출하여 APPROVAL 분기에서 WcSigningBridge.requestSignature가 fire-and-forget으로 호출되는지 검증하는 통합 테스트.

**PipelineContext 모킹:**
- 최소 PipelineContext 객체 생성:
  ```typescript
  const ctx: Partial<PipelineContext> = {
    tier: 'APPROVAL',
    txId: 'test-tx-id',
    walletId: 'test-wallet-id',
    wallet: { publicKey: '...', chain: 'ethereum', environment: 'testnet', defaultNetwork: null },
    approvalWorkflow: mockApprovalWorkflow,
    wcSigningBridge: mockWcSigningBridge,
  };
  ```
- `mockApprovalWorkflow`: `requestApproval` spy (void)
- `mockWcSigningBridge`: `requestSignature` spy (Promise.resolve())

**테스트 케이스 (describe: 'stage4Wait WC integration'):**

1. `should call wcSigningBridge.requestSignature in APPROVAL tier` -- stage4Wait 호출 (PIPELINE_HALTED catch) -> requestSignature 호출 확인, 인자: (walletId, txId, chain)
2. `should call requestApproval before requestSignature` -- 호출 순서 확인: requestApproval이 먼저
3. `should not block pipeline when requestSignature is slow` -- requestSignature가 1초 대기하는 mock -> stage4Wait는 즉시 PIPELINE_HALTED throw (비동기 확인)
4. `should work without wcSigningBridge (backward compat)` -- ctx.wcSigningBridge = undefined -> stage4Wait 정상 동작 (PIPELINE_HALTED), requestSignature 미호출
5. `should not call requestSignature for INSTANT tier` -- tier='INSTANT' -> stage4Wait 반환, requestSignature 미호출
6. `should not call requestSignature for DELAY tier` -- tier='DELAY' -> delayQueue.queueDelay 호출, requestSignature 미호출
7. `should pass wallet.chain to requestSignature` -- chain='solana'로 설정 -> requestSignature의 세 번째 인자가 'solana'

**구현 노트:**
- stage4Wait는 APPROVAL에서 WAIaaSError PIPELINE_HALTED를 throw하므로, 테스트에서 try-catch로 감싸서 에러를 기대.
- `void` fire-and-forget이므로 requestSignature의 Promise는 stage4Wait 반환 후에도 pending 상태일 수 있다. 테스트에서는 mock이 즉시 resolve하므로 문제 없음. 느린 mock 테스트(케이스 3)에서는 stage4Wait throw 확인 후 await로 mock 완료를 기다려야 할 수 있다.
  </action>
  <verify>
- `pnpm test --filter=@waiaas/daemon -- --reporter=verbose wc-approval-integration` -- 모든 테스트 통과
- 테스트 수 5-7개
- `pnpm test --filter=@waiaas/daemon` -- 전체 통과 (기존 + 새 테스트 모두, 회귀 없음)
  </verify>
  <done>
stage4Wait APPROVAL 분기에서 WcSigningBridge가 fire-and-forget으로 호출되고, 파이프라인이 블로킹되지 않으며, 기존 tier(INSTANT/DELAY)에 영향이 없음이 통합 테스트로 검증된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` -- 전체 모노레포 빌드 성공
2. `pnpm test --filter=@waiaas/daemon` -- 전체 테스트 통과 (기존 1,569+ 새 테스트 20-27개)
3. 테스트 커버리지: WcSigningBridge의 requestSignature 메서드의 모든 분기가 테스트됨
4. stage4Wait의 WC 연동이 통합 테스트로 검증됨
</verification>

<success_criteria>
- WcSigningBridge 단위 테스트 15-20개가 전체 통과한다
- stage4Wait 통합 테스트 5-7개가 전체 통과한다
- 기존 1,569개 테스트에 회귀가 없다
- EVM(personal_sign/SIWE)/Solana(solana_signMessage) 양쪽 경로가 테스트된다
- 승인/거부/타임아웃/세션없음 모든 분기가 테스트된다
- fire-and-forget 비블로킹 특성이 통합 테스트로 검증된다
</success_criteria>

<output>
After completion, create `.planning/phases/148-wc-signing/148-02-SUMMARY.md`
</output>
