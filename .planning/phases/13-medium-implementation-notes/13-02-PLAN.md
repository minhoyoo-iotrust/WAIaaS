---
phase: 13-medium-implementation-notes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/39-tauri-desktop-architecture.md
  - .planning/deliverables/28-daemon-lifecycle-cli.md
  - .planning/deliverables/40-telegram-bot-docker.md
autonomous: true

must_haves:
  truths:
    - "Tauri IPC 에러 vs HTTP 에러의 분류표와 ECONNREFUSED 처리 전략이 TAURI-DESK에 문서화됨"
    - "Setup Wizard 5단계와 CLI init 4단계의 차이점(패스워드 길이, 필수/선택 차이)과 통합 근거가 양쪽 문서에 명시됨"
    - "Telegram Tier 2 인증은 TELEGRAM_PRE_APPROVED 패턴으로 대체하며, SIWS 서명은 Desktop/CLI 필수임이 명시됨"
  artifacts:
    - path: ".planning/deliverables/39-tauri-desktop-architecture.md"
      provides: "IPC + HTTP 이중 채널 에러 처리 전략 + Setup Wizard 차이점 노트"
      contains: "구현 노트"
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "CLI init vs Setup Wizard 통합 근거 노트"
      contains: "CLI init.*Setup Wizard"
    - path: ".planning/deliverables/40-telegram-bot-docker.md"
      provides: "Telegram SIWS 대체 방안 (TELEGRAM_PRE_APPROVED) 노트"
      contains: "TELEGRAM_PRE_APPROVED"
  key_links:
    - from: ".planning/deliverables/39-tauri-desktop-architecture.md"
      to: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      via: "Setup Wizard Step 1-2가 CLI init 호출"
      pattern: "CLI init.*최소 초기화"
    - from: ".planning/deliverables/40-telegram-bot-docker.md"
      to: ".planning/deliverables/39-tauri-desktop-architecture.md"
      via: "Tier 2 승인을 Desktop으로 유도"
      pattern: "Desktop.*최종 승인"
---

<objective>
3개 MEDIUM 구현 노트(NOTE-05, NOTE-06, NOTE-07)를 해당 v0.2 설계 문서에 "구현 노트" 섹션으로 추가한다. Tauri 이중 채널 에러 처리, Setup Wizard/CLI init 초기화 순서 정리, Telegram SIWS 서명 대체 방안 등 통합/인증/배포 관련 노트를 작성한다.

Purpose: 클라이언트 통합(Tauri, Telegram) 구현 시 에러 처리 전략과 인증 흐름의 설계 의도를 명확히 하여, 구현 단계에서의 혼란을 방지한다.

Output:
- 39-tauri-desktop-architecture.md (수정 — NOTE-05: IPC+HTTP 이중 채널, NOTE-06: Setup Wizard 순서)
- 28-daemon-lifecycle-cli.md (수정 — NOTE-06: CLI init 순서)
- 40-telegram-bot-docker.md (수정 — NOTE-07: Telegram SIWS 대체)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-medium-implementation-notes/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tauri 이중 채널 + Setup Wizard 순서 + Telegram SIWS 구현 노트 (NOTE-05, NOTE-06, NOTE-07)</name>
  <files>
    .planning/deliverables/39-tauri-desktop-architecture.md
    .planning/deliverables/28-daemon-lifecycle-cli.md
    .planning/deliverables/40-telegram-bot-docker.md
  </files>
  <action>
    각 설계 문서의 마지막 "요구사항 매핑 총괄" 섹션 **직전**에 "구현 노트" 섹션을 추가한다. 문서에 "요구사항 매핑 총괄"이 없으면 문서 마지막에 추가한다. 이미 "구현 노트" 섹션이 13-01에서 추가된 경우(28-daemon-lifecycle-cli.md, 40-telegram-bot-docker.md)에는 기존 섹션에 소제목을 추가한다.

    **NOTE-05 (Tauri IPC + HTTP 이중 채널 전략) — 39-tauri-desktop-architecture.md:**
    구현 노트 섹션에 다음 내용을 추가:
    - 소제목: "IPC + HTTP 이중 채널 에러 처리 전략"
    - 에러 분류 표:

      | 에러 유형 | 원천 | 에러 클래스 | 사용자 표시 |
      |----------|------|-----------|-----------|
      | 데몬 프로세스 관리 실패 | Tauri IPC (invoke) | Rust tauri::Error -> JS catch | "데몬 시작/중지 실패" |
      | API 호출 실패 | HTTP fetch (@waiaas/sdk) | WAIaaSError | SDK 에러 코드별 메시지 |
      | 데몬 미실행 | HTTP fetch | ECONNREFUSED | "데몬이 실행 중이 아닙니다" -> 자동 시작 시도 |
      | IPC 성공 + HTTP 실패 | 혼합 시퀀스 | 복합 | 상태 동기화 후 재시도 안내 |

    - ECONNREFUSED 처리 전략: HTTP 요청 시 ECONNREFUSED 감지 -> `get_daemon_status()`(IPC) 호출 -> 미실행이면 `start_daemon()`(IPC) 시도 -> 성공 후 HTTP 재시도 (최대 1회)
    - 상태 동기화 패턴: IPC `DaemonStatus`와 HTTP `GET /health` 응답을 조합하여 최종 상태 결정. IPC가 "running"인데 /health가 실패하면 "starting" 상태로 간주.
    - React 에러 통합 패턴: useDaemonHealth() hook에서 IPC 상태와 HTTP /health를 폴링하여 통합 상태 제공. 에러 발생 시 Toast 또는 Banner로 통합 표시.

    **NOTE-06 (Setup Wizard vs CLI init 순서 정리) — 39-tauri-desktop-architecture.md + 28-daemon-lifecycle-cli.md:**

    39-tauri-desktop-architecture.md 구현 노트 섹션에 다음 소제목 추가:
    - 소제목: "Setup Wizard와 CLI init 초기화 순서 관계"
    - 차이점 비교 표:

      | 항목 | CLI init (4단계) | Setup Wizard (5단계) | 설계 근거 |
      |------|-----------------|---------------------|----------|
      | 패스워드 최소 길이 | 12자 | 8자 (구현 시 12자 권장) | 보안 우선, 12자로 통일 권장 |
      | 에이전트 생성 | 선택적 | 필수 (Step 2) | Wizard는 즉시 사용 가능 상태 목표 |
      | Owner 지갑 연결 | 선택적 | 필수 (Step 3, WalletConnect) | Wizard는 보안 완전 설정 목표 |
      | 알림 채널 | 선택적 | 필수 (Step 4, 최소 2개) | Wizard는 4-tier 정책 즉시 활성화 |
      | Owner/알림 순서 | 알림 -> Owner | Owner -> 알림 | Wizard: Owner QR 후 알림 설정이 자연스러운 흐름 |

    - 통합 근거: CLI = 최소 초기화(데몬 실행 가능한 최소 상태: 패스워드 + 데이터 디렉토리 + DB), 나머지는 데몬 시작 후 API로 설정 가능. Wizard = CLI init 실행 + 데몬 시작 + API 호출(Owner 연결 + 알림 설정)의 조합.
    - "Wizard Step 1-2는 내부적으로 `waiaas init` 호출, Step 3-4는 데몬 시작 후 REST API 호출"
    - 패스워드 최소 길이: 설계 문서상 CLI 12자 / Wizard 8자이나, 구현 시 양쪽 모두 12자로 통일 권장 (보안 우선). Wizard 설계 변경은 v0.4에서 반영.

    28-daemon-lifecycle-cli.md 구현 노트 섹션에 다음 소제목 추가 (13-01에서 NOTE-08 소제목 이후):
    - 소제목: "CLI init과 Setup Wizard의 역할 분담"
    - CLI init 범위: 데이터 디렉토리 생성, config.toml, SQLite 초기화, 키스토어 초기화, (선택적) 첫 에이전트 생성
    - CLI init은 데몬 미실행 상태에서 수행. Owner 지갑 연결, 알림 채널 설정은 데몬 실행 후 API로 수행.
    - "참조: Setup Wizard 상세는 39-tauri-desktop-architecture.md 구현 노트"
    - 패스워드 최소 길이: CLI 12자 기준 유지. Wizard 측 8자를 12자로 통일 권장.

    **NOTE-07 (Telegram SIWS 서명 방안) — 40-telegram-bot-docker.md:**
    구현 노트 섹션에 다음 소제목 추가 (13-01에서 NOTE-08 소제목 이후):
    - 소제목: "Telegram Tier 2 인증과 SIWS 서명 대체 방안"
    - v0.2 결정: Telegram에서 Tier 2(SIWS/SIWE) 서명 미지원. UX 복잡도(Telegram Mini App + WalletConnect QR + 외부 지갑 서명 -> Bot 전달)가 높아 실용성 부족.
    - 대체 패턴 (TELEGRAM_PRE_APPROVED):
      1. Telegram에서 [Pre-Approve] 버튼 클릭 (Tier 1 chatId 인증)
      2. 트랜잭션 상태: QUEUED -> TELEGRAM_PRE_APPROVED (중간 상태)
      3. Desktop/CLI 알림: "Telegram에서 사전 승인된 거래가 있습니다"
      4. Desktop/CLI에서 ownerAuth(SIWS/SIWE 서명) 수행 -> APPROVED -> EXECUTING
    - Tier 1(chatId)으로 가능한 동작: reject(거부), revoke(세션 취소), kill switch activate(긴급 중지), 읽기 전용 조회
    - Tier 2(ownerAuth) 필수 동작: approve(승인), recover(Kill Switch 복구), create(에이전트/세션 생성), settings(설정 변경) -> 반드시 Desktop/CLI 필요
    - 보안 근거: 자금 이동/시스템 복구는 지갑 서명 필수 원칙 유지. Telegram은 "알림 + 방어적 동작" 채널.
    - v0.3+ 확장 후보: Telegram Mini App + WalletConnect DeepLink 연동으로 Tier 2 직접 수행 검토
  </action>
  <verify>
    각 수정된 문서에서 구현 노트 섹션 확인:
    - `grep "구현 노트" .planning/deliverables/39-tauri-desktop-architecture.md` -> 매치
    - `grep "CLI init.*Setup Wizard" .planning/deliverables/28-daemon-lifecycle-cli.md` -> 매치
    - `grep "TELEGRAM_PRE_APPROVED" .planning/deliverables/40-telegram-bot-docker.md` -> 매치 (기존 + 구현 노트)
    내용 확인:
    - `grep "ECONNREFUSED" .planning/deliverables/39-tauri-desktop-architecture.md` -> 매치
    - `grep "12자.*권장" .planning/deliverables/39-tauri-desktop-architecture.md` -> 매치
    - `grep "Tier 2.*Desktop.*CLI" .planning/deliverables/40-telegram-bot-docker.md` -> 매치
  </verify>
  <done>
    NOTE-05(Tauri IPC+HTTP 에러 분류표, ECONNREFUSED 처리, 상태 동기화 패턴), NOTE-06(Setup Wizard vs CLI init 5단계/4단계 차이점 표, 패스워드 12자 통일 권장, 역할 분담), NOTE-07(TELEGRAM_PRE_APPROVED 패턴 상세, Tier 1/2 동작 분류, 보안 근거)가 해당 설계 문서에 구현 노트로 추가됨. 양쪽 문서 간 크로스레퍼런스 포함.
  </done>
</task>

</tasks>

<verification>
1. 3개 NOTE 항목(NOTE-05, NOTE-06, NOTE-07)이 모두 해당 문서에 구현 노트 섹션으로 추가되었는지 확인
2. NOTE-06이 양쪽 문서(39-tauri + 28-daemon)에 모두 반영되었는지 확인
3. 13-01에서 추가된 구현 노트 섹션(28-daemon의 NOTE-08, 40-telegram의 NOTE-08)과 충돌 없이 소제목이 추가되었는지 확인
4. 구현 노트가 기존 설계를 변경하지 않고 "구현 시 참고" 수준인지 확인
5. NOTE-06 패스워드 길이는 "12자로 통일 권장"으로 표현 (설계 변경이 아닌 권장 사항)
</verification>

<success_criteria>
- 39-tauri-desktop-architecture.md에 IPC/HTTP 에러 분류표 + ECONNREFUSED 처리 전략 + Setup Wizard 차이점 표가 존재
- 28-daemon-lifecycle-cli.md에 CLI init vs Setup Wizard 역할 분담 설명이 존재
- 40-telegram-bot-docker.md에 TELEGRAM_PRE_APPROVED 패턴 상세 + Tier 1/2 동작 분류가 존재
- 수정된 3개 문서 모두 기존 설계가 변경되지 않음 (구현 노트 섹션만 추가/확장)
- 28-daemon과 40-telegram 문서에서 13-01 구현 노트와 13-02 구현 노트가 같은 섹션 내 다른 소제목으로 공존
</success_criteria>

<output>
After completion, create `.planning/phases/13-medium-implementation-notes/13-02-SUMMARY.md`
</output>
