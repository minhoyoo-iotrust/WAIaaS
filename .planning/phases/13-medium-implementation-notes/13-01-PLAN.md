---
phase: 13-medium-implementation-notes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/27-chain-adapter-interface.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/35-notification-architecture.md
  - .planning/deliverables/24-monorepo-data-directory.md
  - .planning/deliverables/38-sdk-mcp-interface.md
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/28-daemon-lifecycle-cli.md
  - .planning/deliverables/40-telegram-bot-docker.md
autonomous: true

must_haves:
  truths:
    - "BalanceInfo.amount lamports/SOL 변환 규칙이 CORE-04에 명시됨 (formatted = balance / 10^decimals + symbol)"
    - "알림 채널 최소 2개 요구와 config.toml enabled=false 기본값 간 관계가 NOTI-ARCH에 명시됨"
    - "MCP 6개 도구 + 3개 리소스와 REST 31개 엔드포인트 간 기능 패리티 매트릭스가 SDK-MCP에 존재함"
    - "36개 에러 코드의 TS/Python SDK 타입 매핑 전략이 SDK-MCP에 정의됨"
    - "에이전트 생명주기 v0.1 5단계와 v0.2 agents.status 매핑이 CORE-02에 검증됨"
    - "Python SDK snake_case 변환 검증 결과가 SDK-MCP에 기록됨"
    - "커서 페이지네이션 표준 파라미터(cursor/nextCursor/limit/order)가 API-SPEC에 명시됨"
    - "Docker graceful shutdown 35초와 10단계 합산 시간의 관계가 CORE-05에 검증됨"
  artifacts:
    - path: ".planning/deliverables/27-chain-adapter-interface.md"
      provides: "BalanceInfo 단위 변환 규칙 구현 노트"
      contains: "구현 노트"
    - path: ".planning/deliverables/38-sdk-mcp-interface.md"
      provides: "MCP 패리티 매트릭스 + SDK 에러 매핑 + Python 네이밍 검증"
      contains: "기능 패리티 매트릭스"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "커서 페이지네이션 표준 + 단위 변환 참조"
      contains: "커서 페이지네이션"
    - path: ".planning/deliverables/35-notification-architecture.md"
      provides: "알림 채널 최소 요구와 정책 연동 규칙"
      contains: "구현 노트"
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "에이전트 상태 v0.1-v0.2 매핑표"
      contains: "구현 노트"
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "Docker graceful shutdown 타임라인 검증"
      contains: "구현 노트"
  key_links:
    - from: ".planning/deliverables/27-chain-adapter-interface.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "BalanceInfo bigint -> REST formatted 변환 공식 참조"
      pattern: "10\\^decimals"
    - from: ".planning/deliverables/38-sdk-mcp-interface.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "31개 REST 엔드포인트와 MCP 도구 매핑"
      pattern: "의도적 미커버"
    - from: ".planning/deliverables/35-notification-architecture.md"
      to: ".planning/deliverables/24-monorepo-data-directory.md"
      via: "알림 enabled/channel 설정과 정책 엔진 연동"
      pattern: "활성 채널.*<.*2"
---

<objective>
8개 MEDIUM 구현 노트(NOTE-01, NOTE-02, NOTE-03, NOTE-04, NOTE-08, NOTE-09, NOTE-10, NOTE-11)를 해당 v0.2 설계 문서에 "구현 노트" 섹션으로 추가한다. 단위 변환 규칙, 기능 패리티 매트릭스, 에러 코드 매핑, 상태 매핑, 네이밍 검증, 페이지네이션 통일 등 데이터 정합성 중심의 노트를 작성한다.

Purpose: 구현 단계에서 문서 간 불일치로 인한 혼란을 방지하기 위해, 매핑/대응 관계와 변환 규칙을 해당 설계 문서에 명시적으로 기록한다.

Output:
- 27-chain-adapter-interface.md (수정 — NOTE-01: 단위 변환 규칙)
- 35-notification-architecture.md (수정 — NOTE-02: 알림 채널 최소 요구)
- 38-sdk-mcp-interface.md (수정 — NOTE-03: MCP 패리티, NOTE-04: SDK 에러 매핑, NOTE-10: Python 네이밍)
- 37-rest-api-complete-spec.md (수정 — NOTE-11: 커서 페이지네이션, NOTE-01 참조 추가)
- 25-sqlite-schema.md (수정 — NOTE-09: 에이전트 상태 매핑)
- 28-daemon-lifecycle-cli.md (수정 — NOTE-08: Docker shutdown 타임라인)
- 24-monorepo-data-directory.md (수정 — NOTE-02 참조 추가)
- 40-telegram-bot-docker.md (수정 — NOTE-08 참조 추가)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-medium-implementation-notes/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 단위 변환/채널/페이지네이션/shutdown 구현 노트 (NOTE-01, NOTE-02, NOTE-08, NOTE-11)</name>
  <files>
    .planning/deliverables/27-chain-adapter-interface.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/35-notification-architecture.md
    .planning/deliverables/24-monorepo-data-directory.md
    .planning/deliverables/28-daemon-lifecycle-cli.md
    .planning/deliverables/40-telegram-bot-docker.md
  </files>
  <action>
    각 설계 문서의 마지막 "요구사항 매핑 총괄" 섹션 **직전**에 "구현 노트" 섹션을 추가한다. 문서에 "요구사항 매핑 총괄"이 없으면 문서 마지막에 추가한다.

    **NOTE-01 (BalanceInfo 단위 변환 규칙) — 27-chain-adapter-interface.md:**
    구현 노트 섹션에 다음 내용을 추가:
    - 소제목: "금액 단위 변환 규칙"
    - 저장/전송 레이어: 모든 금액은 최소 단위(lamports/wei) bigint로 처리
    - API 레이어 변환 공식: `formatted = (Number(balance) / 10**decimals).toFixed(decimals) + ' ' + symbol` (표시 시 trailing zeros는 trimEnd('0')으로 제거)
    - 체인별 변환표: SOL: 1 SOL = 10^9 lamports (decimals=9), ETH: 1 ETH = 10^18 wei (decimals=18)
    - SDK 레이어: 변환 헬퍼 함수 인터페이스 정의 — `formatAmount(balance: bigint, decimals: number): string`, `parseAmount(amount: string, decimals: number): bigint`
    - 참조: "REST API BalanceResponse의 formatted 필드(37-rest-api-complete-spec.md 참조)"
    또한 37-rest-api-complete-spec.md의 BalanceResponse 근처에 "금액 변환 규칙은 27-chain-adapter-interface.md 구현 노트 참조" 1줄 주석 추가.

    **NOTE-02 (알림 채널 최소 요구 명확화) — 35-notification-architecture.md:**
    구현 노트 섹션에 다음 내용을 추가:
    - 소제목: "알림 채널과 정책 엔진 연동 규칙"
    - 핵심 규칙: `notifications.enabled = true` 이고 활성 채널 >= 2일 때만 전체 4-tier(INSTANT/NOTIFY/DELAY/APPROVAL) 정책이 동작
    - 활성 채널 < 2이면: INSTANT 티어만 허용. NOTIFY/DELAY/APPROVAL 정책을 적용하려 하면 PolicyEngine이 거부해야 함
    - 초기화 시나리오: `waiaas init` 직후(채널 0개) -> INSTANT만 허용 -> 사용자가 채널 설정 -> 4-tier 활성화
    - config.toml과의 관계: `enabled = false`(기본값)이면 알림 시스템 자체 비활성, 채널 설정과 무관하게 INSTANT만
    - "참조: config.toml notifications 섹션(24-monorepo-data-directory.md)"
    또한 24-monorepo-data-directory.md의 `[notifications]` 섹션 근처에 "채널 최소 요구 규칙은 35-notification-architecture.md 구현 노트 참조" 1줄 주석 추가.

    **NOTE-08 (Docker graceful shutdown 검증) — 28-daemon-lifecycle-cli.md:**
    구현 노트 섹션에 다음 내용을 추가:
    - 소제목: "Graceful Shutdown 타임라인 검증"
    - 30초 강제 타이머: Step 1에서 `setTimeout(() => process.exit(1), 30_000)` 설정
    - Step 4-5 병렬성: In-flight HTTP 요청에 서명 작업이 포함되면 Step 4에서 이미 대기하므로 Step 5는 추가 대기 불필요
    - 타임라인 표: 정상 종료 ~1.2초, In-flight 있음 ~31.5초, 서명 진행 중 ~33초 -> 모두 35초 Docker stop_grace_period 내
    - 최악 케이스: 30초 강제 타이머 발동으로 exit(1) -> Docker SIGKILL 전 정리 완료
    - "Docker stop_grace_period: 35s = 30s(daemon) + 5s(margin)"
    - "참조: Docker 설정은 40-telegram-bot-docker.md"
    또한 40-telegram-bot-docker.md의 `stop_grace_period: 35s` 근처에 "30초 + 10단계 타임라인 검증은 28-daemon-lifecycle-cli.md 구현 노트 참조" 1줄 주석 추가.

    **NOTE-11 (커서 페이지네이션 파라미터 통일) — 37-rest-api-complete-spec.md:**
    구현 노트 섹션(NOTE-01 참조와 같은 섹션)에 다음 내용을 추가:
    - 소제목: "커서 페이지네이션 표준"
    - 표준 파라미터 4개: 요청 `cursor`(string, optional), `limit`(number, 1~100, default 20), `order`(asc/desc, default desc) + 응답 `nextCursor`(string | null)
    - UUID v7 커서 구현 규칙: `WHERE id < :cursor ORDER BY id DESC LIMIT :limit+1` (오버페치로 hasMore 판단)
    - 페이지네이션 미적용 엔드포인트: GET /v1/owner/agents(소규모), GET /v1/owner/pending-approvals(소규모) -> 전체 반환
    - 클라이언트 가이드: nextCursor가 null이면 마지막 페이지, 첫 요청은 cursor 생략
    - 이 파라미터명(cursor/nextCursor/limit/order)이 현재 모든 리스트 엔드포인트에서 일관됨을 확인함
  </action>
  <verify>
    각 수정된 문서에서 "구현 노트" 섹션이 존재하는지 grep으로 확인:
    - `grep -l "구현 노트" .planning/deliverables/27-chain-adapter-interface.md .planning/deliverables/35-notification-architecture.md .planning/deliverables/28-daemon-lifecycle-cli.md .planning/deliverables/37-rest-api-complete-spec.md`
    - 모두 매치해야 함 (4개 파일)
    참조 링크 확인:
    - `grep "구현 노트 참조" .planning/deliverables/24-monorepo-data-directory.md .planning/deliverables/40-telegram-bot-docker.md .planning/deliverables/37-rest-api-complete-spec.md`
    - 모두 매치해야 함 (3개 파일)
  </verify>
  <done>
    NOTE-01(BalanceInfo 단위 변환), NOTE-02(알림 채널 최소 요구), NOTE-08(Docker shutdown 검증), NOTE-11(커서 페이지네이션 통일)이 해당 설계 문서에 구현 노트로 추가됨. 참조 문서에 크로스레퍼런스 포함.
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP 패리티/SDK 에러 매핑/에이전트 상태/Python 네이밍 구현 노트 (NOTE-03, NOTE-04, NOTE-09, NOTE-10)</name>
  <files>
    .planning/deliverables/38-sdk-mcp-interface.md
    .planning/deliverables/25-sqlite-schema.md
  </files>
  <action>
    **NOTE-03 (MCP 기능 패리티 매트릭스) — 38-sdk-mcp-interface.md:**
    구현 노트 섹션에 다음 내용을 추가:
    - 소제목: "MCP ↔ REST API 기능 패리티 매트릭스"
    - 31개 REST 엔드포인트 전체를 5개 카테고리(Public 3, Session/Agent 5, Session Management 3, Owner 17, Admin 3)로 나열하는 표
    - 각 엔드포인트에 대해: MCP Tool/Resource 매핑 여부, 커버 상태(커버됨/의도적 미커버/v0.3+ 확장 후보), 근거
    - Public API: /health(리소스 system-status), /nonce(도구 get_nonce), /doc(미커버 - Swagger UI는 브라우저 전용)
    - Session API: 5개 전부 커버 (도구 5개 + 리소스 2개)
    - Session Management/Owner/Admin: 전부 "의도적 미커버" — MCP는 AI 에이전트 권한 범위(세션 Bearer)만 노출, Owner/Admin은 보안상 제외
    - "MCP Pitfall 2: Tool 과다 등록 방지" 결정 참조
    - v0.3+ 확장 후보: Streamable HTTP transport 도입 시 MCP 도구 확장 검토

    **NOTE-04 (SDK 에러 타입 매핑 전략) — 38-sdk-mcp-interface.md:**
    동일 구현 노트 섹션에 다음 소제목을 추가:
    - 소제목: "SDK 에러 코드 타입 매핑 전략"
    - TS SDK: `WAIaaSErrorCode` type을 36개 에러 코드의 string literal union으로 정의. `type WAIaaSErrorCode = 'INVALID_TOKEN' | 'TOKEN_EXPIRED' | ...`. WAIaaSError.code 필드 타입을 `WAIaaSErrorCode`로 변경 -> 자동완성/타입체크 활성화.
    - Python SDK: `ErrorCode` string enum을 36개 에러 코드로 정의. `class ErrorCode(str, Enum): INVALID_TOKEN = "INVALID_TOKEN" ...`. WAIaaSError.code 필드 타입을 `ErrorCode`로 변경.
    - 7개 도메인(AUTH 8, SESSION 4, TX 7, POLICY 4, OWNER 4, SYSTEM 6, AGENT 3)별 에러 코드 전체 목록 표
    - 도메인별 에러 서브클래스 불필요: 단일 WAIaaSError + code 필드로 구분 (현행 유지)
    - retryable 판정: HTTP 429, 502, 503, 504 -> retryable=true, 나머지 false (현행 유지)
    - MCP 에러: isError=true + JSON text {code, message} 반환 (현행 유지)

    **NOTE-09 (에이전트 생명주기 매핑) — 25-sqlite-schema.md:**
    구현 노트 섹션에 다음 내용을 추가:
    - 소제목: "에이전트 상태 v0.1 → v0.2 매핑"
    - 5개 상태(CREATING, ACTIVE, SUSPENDED, TERMINATING, TERMINATED) 매핑 표: v0.1 값(lowercase), v0.2 값(UPPERCASE), 의미 변경 요약
    - CREATING: v0.1 Squads 멤버 등록 포함 -> v0.2 키 생성 + 지갑 주소 생성만
    - ACTIVE: v0.1 SpendingLimit 활성 -> v0.2 DatabasePolicyEngine 활성
    - SUSPENDED: v0.1 SpendingLimit 비활성화(온체인) -> v0.2 로컬 정책 차단 + suspension_reason(kill_switch/policy_violation/manual/auto_stop)
    - TERMINATING: v0.1 Squads 멤버 제거 + 자금 회수 -> v0.2 키스토어 제거 + 잔액 반환 안내
    - TERMINATED: 양쪽 모두 불가역 최종 상태
    - SUPERSEDED 참조: "v0.1 15-agent-lifecycle-management.md는 SUPERSEDED 표기됨"
    - 45-enum-unified-mapping.md에서 AgentStatus SSoT 확인 참조

    **NOTE-10 (Python SDK 네이밍 검증) — 38-sdk-mcp-interface.md:**
    동일 구현 노트 섹션에 다음 소제목을 추가:
    - 소제목: "Python SDK snake_case 변환 검증"
    - REST API camelCase -> Python snake_case 변환 일관성 검증 결과: 17개 필드 전부 OK
    - 검증 대상 필드: transactionId, txHash, estimatedFee, createdAt, executedAt, toAddress, nextCursor, queuedAt, expiresAt, sessionId, maxAmountPerTx, maxTotalAmount, maxTransactions, allowedOperations, allowedDestinations, expiresIn, tokenMint
    - Pydantic 규칙: 모든 alias 모델에 `model_config = {"populate_by_name": True}` 필수
    - 에러 코드 무변환 원칙: UPPER_SNAKE_CASE 에러 코드는 Python에서도 그대로 사용 (이미 Python 관례와 일치)
    - Owner API Python SDK: v0.2에서는 TS Owner SDK만 설계됨. Python Owner SDK는 v0.3+ 확장 시 동일 snake_case 규칙 적용
  </action>
  <verify>
    수정된 문서에서 구현 노트 섹션 확인:
    - `grep -c "구현 노트" .planning/deliverables/38-sdk-mcp-interface.md` -> 1 이상
    - `grep -c "구현 노트" .planning/deliverables/25-sqlite-schema.md` -> 1 이상
    내용 확인:
    - `grep "기능 패리티 매트릭스" .planning/deliverables/38-sdk-mcp-interface.md` -> 매치
    - `grep "WAIaaSErrorCode" .planning/deliverables/38-sdk-mcp-interface.md` -> 매치
    - `grep "snake_case 변환 검증" .planning/deliverables/38-sdk-mcp-interface.md` -> 매치
    - `grep "v0.1.*v0.2 매핑" .planning/deliverables/25-sqlite-schema.md` -> 매치
  </verify>
  <done>
    NOTE-03(MCP 패리티 매트릭스 31개 엔드포인트 전체 매핑), NOTE-04(SDK 36개 에러 코드 타입 매핑 전략), NOTE-09(에이전트 5단계 v0.1-v0.2 매핑표), NOTE-10(Python 17개 필드 snake_case 검증)이 해당 설계 문서에 구현 노트로 추가됨.
  </done>
</task>

</tasks>

<verification>
1. 8개 NOTE 항목(NOTE-01, NOTE-02, NOTE-03, NOTE-04, NOTE-08, NOTE-09, NOTE-10, NOTE-11)이 모두 해당 문서에 구현 노트 섹션으로 추가되었는지 확인
2. 크로스레퍼런스가 양방향으로 존재하는지 확인 (NOTE-01: CORE-04 <-> API-SPEC, NOTE-02: NOTI-ARCH <-> CORE-01, NOTE-08: CORE-05 <-> TGBOT)
3. 구현 노트가 기존 설계를 변경하지 않고 "구현 시 참고" 수준인지 확인 (새 인터페이스/타입 정의 없음)
4. 매트릭스/표가 포함된 노트(NOTE-03, NOTE-04, NOTE-09, NOTE-10, NOTE-11)의 데이터가 정확한지 확인
</verification>

<success_criteria>
- 27-chain-adapter-interface.md에 단위 변환 규칙(formatted 공식, 체인별 decimals)이 존재
- 35-notification-architecture.md에 알림 채널 < 2일 때 INSTANT만 허용 규칙이 존재
- 38-sdk-mcp-interface.md에 (1) 31개 엔드포인트 패리티 매트릭스, (2) 36개 에러 코드 타입 매핑, (3) 17개 필드 snake_case 검증이 존재
- 37-rest-api-complete-spec.md에 커서 페이지네이션 표준 파라미터 4개가 명시됨
- 25-sqlite-schema.md에 에이전트 상태 5단계 v0.1-v0.2 매핑표가 존재
- 28-daemon-lifecycle-cli.md에 30초 타이머 vs 10단계 합산 검증표가 존재
- 수정된 8개 문서 모두 기존 설계가 변경되지 않음 (구현 노트 섹션만 추가)
</success_criteria>

<output>
After completion, create `.planning/phases/13-medium-implementation-notes/13-01-SUMMARY.md`
</output>
