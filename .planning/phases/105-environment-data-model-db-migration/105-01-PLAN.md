---
phase: 105-environment-data-model-db-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/68-environment-model-design.md
autonomous: true

must_haves:
  truths:
    - "EnvironmentType enum(testnet/mainnet)이 Zod SSoT 파생 체인(Zod -> TypeScript -> DB CHECK -> Drizzle)으로 정의되어 있다"
    - "환경-네트워크 매핑 테이블이 13개 NETWORK_TYPES 전수 매핑으로 작성되어 있다"
    - "매핑 함수 4개(getNetworksForEnvironment, getDefaultNetwork, deriveEnvironment, validateNetworkEnvironment)의 시그니처와 로직이 의사코드로 명시되어 있다"
    - "키스토어 경로/구조/마이그레이션 변경 불필요 근거가 코드 레벨 분석으로 확정되어 있다"
    - "WalletSchema 변경 설계(network -> environment + defaultNetwork)가 Zod 스키마 수준으로 명시되어 있다"
  artifacts:
    - path: "docs/68-environment-model-design.md"
      provides: "EnvironmentType SSoT 정의 + 환경-네트워크 매핑 + 키스토어 분석 + WalletSchema 변경 설계"
      contains: "EnvironmentType"
  key_links:
    - from: "ENVIRONMENT_TYPES array"
      to: "EnvironmentTypeEnum Zod"
      via: "z.enum(ENVIRONMENT_TYPES)"
      pattern: "Zod SSoT 파생 체인"
    - from: "deriveEnvironment()"
      to: "v6a/v6b 마이그레이션 CASE 분기"
      via: "동일 매핑 로직 SQL 변환"
      pattern: "13개 네트워크 전수 매핑"
---

<objective>
EnvironmentType enum 정의, 환경-네트워크 매핑 함수 설계, WalletSchema 변경 스펙, 키스토어 영향 분석을 하나의 설계 문서(docs/68)로 작성한다.

Purpose: 후속 페이즈(106-파이프라인, 107-정책, 108-API)와 Plan 105-02(DB 마이그레이션)가 참조할 데이터 타입과 매핑 로직의 단일 진실 원천을 확립한다. 코드 구현은 v1.4.6에서 수행하며, 이 플랜은 설계 문서만 생산한다.
Output: docs/68-environment-model-design.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/105-environment-data-model-db-migration/105-RESEARCH.md

# 핵심 참조 파일 (기존 패턴 확인용)
@packages/core/src/enums/chain.ts
@packages/core/src/schemas/wallet.schema.ts
@packages/daemon/src/infrastructure/keystore/keystore.ts
@packages/daemon/src/infrastructure/database/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: EnvironmentType SSoT + 환경-네트워크 매핑 + WalletSchema 변경 설계</name>
  <files>docs/68-environment-model-design.md</files>
  <action>
설계 문서 68번을 생성한다. 다음 섹션을 포함한다:

**섹션 1: EnvironmentType Zod SSoT 파생 체인**
- `ENVIRONMENT_TYPES = ['testnet', 'mainnet'] as const` 정의 (TypeScript pseudocode)
- `EnvironmentTypeEnum = z.enum(ENVIRONMENT_TYPES)` Zod 스키마
- `type EnvironmentType = (typeof ENVIRONMENT_TYPES)[number]` TypeScript 타입
- DB CHECK: `CHECK (environment IN ('testnet', 'mainnet'))` SQL
- Drizzle: `check('check_environment', buildCheckSql('environment', ENVIRONMENT_TYPES))`
- 파일 위치: `packages/core/src/enums/chain.ts`에 추가 (기존 CHAIN_TYPES/NETWORK_TYPES와 동일 파일)
- exports 체인: `chain.ts` -> `enums/index.ts` -> `core/src/index.ts`

**섹션 2: 환경-네트워크 매핑 테이블 (정적 매핑)**
- 4열 매핑 테이블: chain | environment | 허용 네트워크 | 기본 네트워크
  - solana + mainnet -> [mainnet] (기본: mainnet)
  - solana + testnet -> [devnet, testnet] (기본: devnet)
  - ethereum + mainnet -> [ethereum-mainnet, polygon-mainnet, arbitrum-mainnet, optimism-mainnet, base-mainnet] (기본: ethereum-mainnet)
  - ethereum + testnet -> [ethereum-sepolia, polygon-amoy, arbitrum-sepolia, optimism-sepolia, base-sepolia] (기본: ethereum-sepolia)
- 13개 NETWORK_TYPES 전수 커버리지 검증표 (누락 없음 확인)
- 매핑은 순수 함수로 구현 (DB 조회 아님, 코드에 하드코딩)
- 파일 위치: `packages/core/src/enums/chain.ts`에 추가

**섹션 3: 매핑 함수 4개 설계 (의사코드)**
1. `getNetworksForEnvironment(chain, env) -> readonly NetworkType[]`: ENVIRONMENT_NETWORK_MAP 상수에서 조회
2. `getDefaultNetwork(chain, env) -> NetworkType`: ENVIRONMENT_DEFAULT_NETWORK 상수에서 조회
3. `deriveEnvironment(network) -> EnvironmentType`: 네트워크에서 환경 역파생 (mainnet/ethereum-mainnet/polygon-mainnet/... -> 'mainnet', devnet/testnet/ethereum-sepolia/... -> 'testnet'). 이 함수는 DB 마이그레이션(Plan 105-02)의 CASE 분기와 동일 로직
4. `validateNetworkEnvironment(chain, env, network) -> void`: getNetworksForEnvironment로 허용 목록 조회 후 includes 검증. 불일치 시 Error throw (기존 validateChainNetwork 패턴과 동일)

각 함수에 대해: 시그니처, 입출력 예시, 에러 케이스, 의사코드를 포함한다.

**섹션 4: WalletSchema 변경 설계**
- 현재: `WalletSchema.network` (NetworkTypeEnum 검증)
- 변경: `WalletSchema.environment` (EnvironmentTypeEnum 검증) + `WalletSchema.defaultNetwork` (NetworkTypeEnum.nullable() 검증)
- CreateWalletRequestSchema 변경:
  - 현재: `chain` (필수) + `network` (필수)
  - 변경: `chain` (필수) + `environment` (필수) + `network` (선택, 초기 default_network 설정용)
  - `network` 미지정 시 getDefaultNetwork(chain, environment)로 자동 설정
- TransactionSchema 변경: `network` 필드 추가 (NetworkTypeEnum.nullable(), 기존 레코드 호환)
- OpenAPI 스키마 변경 범위 요약 (상세는 Phase 108)

**섹션 5: 키스토어 영향 분석**
- 경로: `keystorePath(walletId)` = `join(keystoreDir, walletId + '.json')` -- walletId만 사용, 환경 무관
- KeystoreFileV1.network: 메타데이터 필드, decryptPrivateKey에서 미사용
- 기존 키 파일: 내부 `"network": "ethereum-sepolia"` 메타데이터 그대로 유지 (동작 영향 없음)
- 신규 키 파일: v1.4.6 구현 시 `environment` 필드 추가는 선택 사항 (v2 파일 포맷 미도입)
- **결론: 키스토어 파일 경로/구조/마이그레이션 모두 변경 불필요**
- 근거 코드 참조 3개: keystorePath(), generateKeyPair(), decryptPrivateKey()

**섹션 6: 설계 결정 요약표**
- 결정 ID(ENV-01~ENV-08), 결정 내용, 근거, 영향 범위를 테이블로 정리
- 핵심 결정: EnvironmentType 2값 하드코딩 (확장 불가 의도적), default_network nullable, 키스토어 변경 없음
  </action>
  <verify>
- docs/68-environment-model-design.md 파일이 존재한다
- 섹션 1~6 모두 포함되어 있다
- 13개 NETWORK_TYPES가 매핑 테이블에서 전수 커버된다
- 매핑 함수 4개의 시그니처와 의사코드가 있다
- WalletSchema 변경 전/후가 Zod 수준으로 명시되어 있다
- 키스토어 분석 결론이 "변경 불필요"로 명시되어 있다
  </verify>
  <done>
- EnvironmentType Zod SSoT 파생 체인이 5단계(Zod->TS->CHECK->Drizzle->OpenAPI)로 정의됨
- 환경-네트워크 매핑 테이블이 4행(2체인x2환경) x 13네트워크 전수 매핑됨
- 매핑 함수 4개가 시그니처 + 의사코드 + 에러 케이스로 설계됨
- WalletSchema/CreateWalletRequestSchema/TransactionSchema 변경이 Zod 수준으로 명시됨
- 키스토어 변경 불필요가 코드 참조 3개로 확정됨
- 설계 결정 8개가 근거와 함께 테이블로 정리됨
  </done>
</task>

</tasks>

<verification>
1. docs/68-environment-model-design.md가 존재하고 6개 섹션을 포함한다
2. ENVIRONMENT_TYPES -> EnvironmentTypeEnum -> EnvironmentType -> CHECK -> Drizzle 파생 체인이 명시적이다
3. 13개 NETWORK_TYPES 전수 매핑 (누락 = 설계 실패)
4. Plan 105-02에서 CASE SQL 작성 시 참조할 deriveEnvironment() 로직이 명확하다
5. Phase 106~108에서 참조할 WalletSchema/TransactionSchema 변경이 완전하다
</verification>

<success_criteria>
- 설계 문서 68번이 단독으로 EnvironmentType 데이터 모델의 완전한 참조가 된다
- DB 마이그레이션(105-02), 파이프라인(106), 정책(107), API(108)가 이 문서만 참조하여 구현할 수 있다
- 키스토어 변경 불필요 결론이 코드 레벨 근거로 확정되어 Phase 106~108에서 키스토어 관련 설계가 불필요하다
</success_criteria>

<output>
After completion, create `.planning/phases/105-environment-data-model-db-migration/105-01-SUMMARY.md`
</output>
