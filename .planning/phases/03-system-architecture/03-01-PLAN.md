---
phase: 03-system-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/08-dual-key-architecture.md
  - .planning/deliverables/09-system-components.md
autonomous: true

must_haves:
  truths:
    - "Owner Key와 Agent Key의 역할, 권한, 저장 방식이 상세히 정의됨"
    - "각 서비스 컴포넌트의 경계와 책임이 명확히 표현됨"
    - "클라우드와 셀프호스트 환경의 인프라 차이가 문서화됨"
  artifacts:
    - path: ".planning/deliverables/08-dual-key-architecture.md"
      provides: "Dual Key 아키텍처 상세 설계"
      contains: "Owner Key, Agent Key, KMS, Nitro Enclave"
    - path: ".planning/deliverables/09-system-components.md"
      provides: "시스템 컴포넌트 다이어그램 및 책임 정의"
      contains: "IKeyManagementService, packages/core, packages/cloud, packages/selfhost"
  key_links:
    - from: "08-dual-key-architecture.md"
      to: "09-system-components.md"
      via: "키 관리 인터페이스가 컴포넌트 설계에 반영"
    - from: "09-system-components.md"
      to: "packages/ 구조"
      via: "모노레포 패키지 구조 정의"
---

<objective>
Dual Key 아키텍처 상세 설계(ARCH-01)와 시스템 컴포넌트 다이어그램(ARCH-02)을 작성한다.

Purpose: Phase 2에서 확정된 AWS KMS + Nitro Enclaves + Squads Protocol 아키텍처를 기반으로, Owner Key와 Agent Key의 상세 역할과 시스템 컴포넌트 구조를 정의하여 Phase 3 후속 문서와 구현의 기반을 마련한다.

Output:
- `.planning/deliverables/08-dual-key-architecture.md` - ARCH-01 Dual Key 아키텍처 상세 설계
- `.planning/deliverables/09-system-components.md` - ARCH-02 시스템 컴포넌트 다이어그램
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-system-architecture/03-CONTEXT.md
@.planning/phases/03-system-architecture/03-RESEARCH.md
@.planning/deliverables/07-recommended-custody-model.md
@.planning/phases/02-custody-model/02-02-SUMMARY.md
@.planning/phases/02-custody-model/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dual Key 아키텍처 상세 설계 문서 작성 (ARCH-01)</name>
  <files>.planning/deliverables/08-dual-key-architecture.md</files>
  <action>
Phase 2 CUST-04 결정과 03-RESEARCH.md 내용을 기반으로 Dual Key 아키텍처 상세 설계 문서를 작성한다.

**문서 구조:**
1. Executive Summary (아키텍처 개요)
2. Owner Key 상세 설계
   - 역할 및 권한 (WALLET_FULL_CONTROL, AGENT_REGISTER/REVOKE, POLICY_MODIFY, EMERGENCY_FREEZE, FUNDS_RECOVERY)
   - 저장 방식: AWS KMS ECC_NIST_EDWARDS25519 (클라우드), libsodium sealed box (셀프호스트)
   - 접근 방식: IAM Role 기반 Instance Profile (CONTEXT.md Claude's Discretion 결정)
   - 로테이션 정책: 연 1회 또는 침해 의심 시 (RESEARCH.md 권장)
   - KMS 키 정책 예시 (MFA 필수, Enclave attestation 조건)
3. Agent Key 상세 설계
   - 역할 및 권한 (POLICY_BOUNDED_EXECUTE만)
   - 저장 방식: Nitro Enclaves (클라우드), 암호화 키스토어 + Argon2id (셀프호스트)
   - 생성 위치: Enclave 내부 생성, KMS로 시드 암호화 백업 (클라우드), 서버 메모리 생성 후 암호화 저장 (셀프호스트)
   - 로테이션 정책: 90일 정기 + 이상 징후 시 즉시 (RESEARCH.md 권장)
   - vsock 통신 프로토콜 정의
4. Squads 멀티시그 통합
   - 2-of-2 구성 (Owner + Agent)
   - 동적 threshold 정책 (소액: Agent 단독, 고액: Owner 필수)
   - spending limits, time locks 설정 방식
   - configAuthority: Owner Key만 설정 변경 가능
5. 키 라이프사이클 관리
   - 생성 -> 활성 -> 로테이션 -> 폐기 상태 전이도
   - 로테이션 시 Squads 멤버 교체 절차
   - 비상 키 폐기 절차
6. 환경별 구현 차이
   - 클라우드 vs 셀프호스트 비교 테이블
   - 보안 수준 차이 명시 (기관급 vs 중소규모)
7. Mermaid 다이어그램
   - 키 저장소 구조도
   - 키 로테이션 시퀀스
   - Squads 멀티시그 구조

**CONTEXT.md 결정 준수:**
- 모놀리식 + 키 관리 인터페이스 추상화
- 보안 최우선 원칙

**작성 언어:** 한글
  </action>
  <verify>
- 문서가 `.planning/deliverables/08-dual-key-architecture.md`에 존재
- Owner Key 섹션에 KMS 키 정책 예시 코드 포함
- Agent Key 섹션에 vsock 통신 프로토콜 정의 포함
- Squads 멀티시그 섹션에 동적 threshold 정책 포함
- 최소 2개의 Mermaid 다이어그램 포함
- 클라우드/셀프호스트 비교 테이블 포함
  </verify>
  <done>
Owner Key와 Agent Key의 역할, 권한, 저장 방식, 로테이션 정책이 환경별로 상세히 정의되고, Squads 통합 방식과 키 라이프사이클이 다이어그램과 함께 문서화됨
  </done>
</task>

<task type="auto">
  <name>Task 2: 시스템 컴포넌트 다이어그램 문서 작성 (ARCH-02)</name>
  <files>.planning/deliverables/09-system-components.md</files>
  <action>
모놀리식 아키텍처 결정과 03-RESEARCH.md의 프로젝트 구조를 기반으로 시스템 컴포넌트 문서를 작성한다.

**문서 구조:**
1. Executive Summary (시스템 개요)
2. 고수준 아키텍처 다이어그램
   - 클라이언트 -> API Gateway -> WAIaaS 서버 -> 블록체인
   - 외부 연동: Squads, Solana RPC (Helius)
3. 모노레포 패키지 구조 (03-RESEARCH.md 참조)
   - packages/core: 공통 코어 (도메인, 인터페이스, 서비스)
   - packages/cloud: 클라우드 환경 (KMS, Enclave)
   - packages/selfhost: 셀프호스트 환경 (암호화 키스토어)
   - packages/api: API 서버 (Fastify)
4. 핵심 인터페이스 정의
   - IKeyManagementService (signWithOwnerKey, signWithAgentKey, getPublicKey 등)
   - IPolicyEngine (evaluate, validate)
   - IBlockchainAdapter (createSmartWallet, buildTransaction, submitTransaction)
5. 컴포넌트별 책임 정의
   | 컴포넌트 | 책임 | 의존성 |
   - WalletService: 지갑 생성, 조회, 설정 변경
   - TransactionService: 트랜잭션 구성, 시뮬레이션, 제출
   - PolicyEngine: 정책 평가, 에스컬레이션 결정
   - KeyManagementService: 키 서명, 로테이션, 조회
6. 데이터 저장소
   - PostgreSQL: 지갑 메타데이터, 트랜잭션 기록, 정책
   - Redis: 세션, 캐시, Rate Limit
   - 암호화 키스토어 (셀프호스트)
7. 배포 환경
   - 클라우드: EC2 + Nitro Enclave, RDS, ElastiCache
   - 셀프호스트: Docker Compose (docker-compose.yml 구조)
8. Mermaid 다이어그램
   - 시스템 컨텍스트 다이어그램 (C4 Level 1)
   - 컨테이너 다이어그램 (C4 Level 2)
   - 패키지 의존성 그래프

**CONTEXT.md 결정 준수:**
- 모놀리식 구조, 키 관리 인터페이스 추상화
- 클라우드/셀프호스트 동일 기능, 인프라만 다름
- 별도 빌드 (공통 코어 + 환경별 빌드/배포)

**작성 언어:** 한글
  </action>
  <verify>
- 문서가 `.planning/deliverables/09-system-components.md`에 존재
- IKeyManagementService 인터페이스 정의 코드 포함
- packages/ 구조가 RESEARCH.md와 일치
- 컴포넌트별 책임 테이블 포함
- 최소 2개의 Mermaid 다이어그램 포함 (C4 Level 1, 2)
- Docker Compose 구조 포함 (셀프호스트)
  </verify>
  <done>
모노레포 패키지 구조와 핵심 인터페이스가 정의되고, 각 컴포넌트의 경계와 책임이 다이어그램과 함께 명확히 문서화됨
  </done>
</task>

</tasks>

<verification>
Phase 03 Plan 01 완료 검증:
1. `.planning/deliverables/08-dual-key-architecture.md` 존재 및 ARCH-01 요구사항 충족
2. `.planning/deliverables/09-system-components.md` 존재 및 ARCH-02 요구사항 충족
3. 두 문서 간 키 관리 인터페이스 연결성 확인
4. CONTEXT.md의 결정 사항이 문서에 반영됨
5. RESEARCH.md의 권장사항이 적용됨
</verification>

<success_criteria>
- ARCH-01: Owner Key와 Agent Key의 역할, 권한, 저장 방식이 환경별로 상세히 정의됨
- ARCH-02: 시스템 컴포넌트의 경계와 책임이 다이어그램으로 명확히 표현됨
- 키 관리 인터페이스 추상화가 컴포넌트 설계에 반영됨
- 모든 문서가 한글로 작성됨
</success_criteria>

<output>
After completion, create `.planning/phases/03-system-architecture/03-01-SUMMARY.md`
</output>
