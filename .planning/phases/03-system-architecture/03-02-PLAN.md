---
phase: 03-system-architecture
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - .planning/deliverables/10-transaction-flow.md
autonomous: true

must_haves:
  truths:
    - "트랜잭션 생성부터 서명, 제출까지 전 과정이 시각화됨"
    - "이중 정책 검증(API + 서명 전) 흐름이 명확히 표현됨"
    - "Fail-safe 동작과 에스컬레이션 경로가 문서화됨"
  artifacts:
    - path: ".planning/deliverables/10-transaction-flow.md"
      provides: "트랜잭션 데이터 흐름 다이어그램"
      contains: "API 정책 검증, Enclave 정책 검증, Squads 온체인 검증"
  key_links:
    - from: "10-transaction-flow.md"
      to: "08-dual-key-architecture.md"
      via: "Agent Key 서명 흐름 참조"
    - from: "10-transaction-flow.md"
      to: "09-system-components.md"
      via: "컴포넌트 간 데이터 흐름"
---

<objective>
트랜잭션 데이터 흐름 다이어그램(ARCH-03)을 작성한다.

Purpose: CONTEXT.md에서 결정된 "두 단계 정책 평가"와 "Fail-safe" 원칙을 기반으로, 트랜잭션 요청부터 온체인 제출까지의 전체 흐름을 시퀀스 다이어그램으로 상세히 문서화한다.

Output:
- `.planning/deliverables/10-transaction-flow.md` - ARCH-03 트랜잭션 데이터 흐름 다이어그램
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-system-architecture/03-CONTEXT.md
@.planning/phases/03-system-architecture/03-RESEARCH.md
@.planning/phases/03-system-architecture/03-01-SUMMARY.md
@.planning/deliverables/08-dual-key-architecture.md
@.planning/deliverables/09-system-components.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 트랜잭션 데이터 흐름 다이어그램 문서 작성 (ARCH-03)</name>
  <files>.planning/deliverables/10-transaction-flow.md</files>
  <action>
CONTEXT.md 결정사항과 03-RESEARCH.md의 Fail-Safe Transaction Flow 패턴을 기반으로 트랜잭션 흐름 문서를 작성한다.

**문서 구조:**
1. Executive Summary
2. 트랜잭션 흐름 개요
   - 요청 수신 -> 1차 정책 검증 -> 트랜잭션 구성 -> 시뮬레이션 -> 2차 정책 검증 + 서명 -> 제출 -> 결과 통보
3. 상세 흐름 (시퀀스 다이어그램)
   - Step 1: API 진입 및 인증
   - Step 2: 서버 정책 엔진 평가 (1차 검증)
   - Step 3: 트랜잭션 구성 (buildTransaction)
   - Step 4: 시뮬레이션 (선택적, simulateTransaction)
   - Step 5: Enclave 정책 검증 + Agent Key 서명 (2차 검증)
   - Step 6: Squads 온체인 정책 적용 (3차 검증 - 온체인)
   - Step 7: 블록체인 제출 (submitTransaction)
   - Step 8: 결과 통보 (동기 응답 + Webhook)
4. 정책 검증 상세
   - 서버 정책 엔진 검증 항목
   - Enclave 내부 정책 검증 항목
   - Squads 온체인 정책 (spending limits, time locks)
   - 왜 이중 검증이 필요한가 (서버 침해 시 Enclave에서 방어)
5. Fail-Safe 동작 모드
   - Enclave 연결 실패 시: 모든 트랜잭션 거부
   - 시뮬레이션 실패 시: 트랜잭션 거부
   - 네트워크 장애 시: 다중 RPC fallback
   - 재시도 정책: 없음 (호출자가 결정)
6. 에스컬레이션 흐름
   - 위반 수준별 에스컬레이션 경로 (LOW -> CRITICAL)
   - LOW: 알림만
   - MEDIUM: Owner 승인 대기
   - HIGH: 즉시 동결 + 알림
   - CRITICAL: Agent Key 해제 + 긴급 잠금
7. 상태 전달 방식
   - 동기 응답: 즉시 결과 반환
   - Webhook: 비동기 알림 (긴 트랜잭션, 대기 큐)
   - 상태 코드 정의 (PENDING, SUBMITTED, CONFIRMED, FAILED, REJECTED)
8. 특수 트랜잭션 흐름
   - 고액 트랜잭션 (Owner 승인 필요)
   - 긴급 회수 (Owner Key 직접 서명)
   - 키 로테이션 트랜잭션
9. Mermaid 다이어그램
   - 정상 흐름 시퀀스 다이어그램
   - 정책 위반 시 시퀀스 다이어그램
   - Fail-safe 동작 시퀀스
   - 에스컬레이션 상태 다이어그램
   - 트랜잭션 상태 머신

**CONTEXT.md 결정 준수:**
- 두 단계 정책 평가 (API + 서명 전)
- 단계별 에스컬레이션
- 재시도 없음 (호출자 결정)
- 동기 응답 + Webhook 둘 다 지원

**작성 언어:** 한글
  </action>
  <verify>
- 문서가 `.planning/deliverables/10-transaction-flow.md`에 존재
- 최소 3개의 Mermaid 시퀀스 다이어그램 포함
- 이중 정책 검증 흐름이 명확히 설명됨
- Fail-safe 동작 모드가 모든 장애 시나리오에 대해 정의됨
- 에스컬레이션 수준별 대응이 테이블로 정리됨
- 트랜잭션 상태 코드가 정의됨
  </verify>
  <done>
트랜잭션 생성-서명-제출 전 과정이 시퀀스 다이어그램으로 시각화되고, 이중 정책 검증, Fail-safe 동작, 에스컬레이션 흐름이 상세히 문서화됨
  </done>
</task>

</tasks>

<verification>
Phase 03 Plan 02 완료 검증:
1. `.planning/deliverables/10-transaction-flow.md` 존재 및 ARCH-03 요구사항 충족
2. CONTEXT.md의 트랜잭션 승인 흐름 결정이 반영됨
3. 03-01 산출물(Dual Key, Components)과의 연결성 확인
4. Fail-safe 원칙이 모든 장애 시나리오에 적용됨
</verification>

<success_criteria>
- ARCH-03: 트랜잭션 흐름 다이어그램에 생성-서명-제출 전 과정이 시각화됨
- 이중 정책 검증(서버 + Enclave)이 시퀀스로 표현됨
- Fail-safe 동작이 장애 시나리오별로 정의됨
- 에스컬레이션 경로가 위반 수준별로 문서화됨
</success_criteria>

<output>
After completion, create `.planning/phases/03-system-architecture/03-02-SUMMARY.md`
</output>
