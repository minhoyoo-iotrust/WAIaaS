---
phase: 12-high-schema-unification
plan: 03
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - .planning/deliverables/29-api-framework-design.md
  - .planning/deliverables/37-rest-api-complete-spec.md
autonomous: true

must_haves:
  truths:
    - "CORS 미들웨어가 tauri://localhost Origin, X-Master-Password 헤더, RateLimit expose 헤더를 포함함"
    - "Health 엔드포인트 status 값이 healthy/degraded/unhealthy로 양쪽 문서에서 일치함"
    - "Rate Limiter 수치가 전역 100, 세션 300, 거래 10 req/min으로 양쪽 문서에서 일치함"
    - "메모 길이 제한이 200자 + Solana 256 bytes 이내 보장 설명으로 통일됨"
    - "SuccessResponse 래퍼 패턴이 잔존하지 않음"
    - "ownerAuth 미들웨어가 API Framework 문서에 반영됨"
  artifacts:
    - path: ".planning/deliverables/29-api-framework-design.md"
      provides: "CORS/Health/Rate Limiter/ownerAuth 통일"
      contains: "tauri://localhost"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "Health status 통일, 메모 제한 명시"
      contains: "healthy"
  key_links:
    - from: ".planning/deliverables/29-api-framework-design.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "CORS 설정, Health 스키마, Rate Limiter 수치가 양쪽에서 동일"
      pattern: "healthy.*unhealthy"
    - from: ".planning/deliverables/29-api-framework-design.md"
      to: ".planning/deliverables/34-owner-wallet-connection.md"
      via: "ownerAuth 미들웨어 참조"
      pattern: "ownerAuth"
---

<objective>
REST API 스펙(37-rest-api)과 API Framework 설계(29-api-framework) 간 불일치 6건을 통일한다.

Purpose: 구현 시 CORS, Health, Rate Limiter, ownerAuth를 어느 문서 기준으로 구현할지 혼란이 발생한다. 두 문서의 스펙을 일치시켜 단일 기준으로 만든다.

Output:
- 29-api-framework-design.md (수정 — CORS, Health, Rate Limiter, ownerAuth)
- 37-rest-api-complete-spec.md (수정 — Health status, 메모 description, SuccessResponse 정리)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-high-schema-unification/12-RESEARCH.md

# 선행 plan SUMMARY 참조 (12-01, 12-02 결과 확인)
@.planning/phases/12-high-schema-unification/12-01-SUMMARY.md
@.planning/phases/12-high-schema-unification/12-02-SUMMARY.md

# 수정 대상 문서
@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/37-rest-api-complete-spec.md

# 참조 문서
@.planning/deliverables/34-owner-wallet-connection.md
@.planning/deliverables/31-solana-adapter-detail.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CORS/Health/Rate Limiter 통일 + ownerAuth 반영</name>
  <files>
    .planning/deliverables/29-api-framework-design.md
  </files>
  <action>
29-api-framework-design.md(CORE-06)를 37-rest-api-complete-spec.md(API-SPEC) 기준으로 업데이트한다. API-SPEC이 최종 통합 스펙이므로 SSoT이다.

**API-02: CORS 미들웨어 업데이트**

CORE-06 섹션 2.3 미들웨어 6 (cors) 코드 블록을 다음으로 교체:
```typescript
cors({
  origin: [`http://localhost:${port}`, `http://127.0.0.1:${port}`, 'tauri://localhost'],
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowHeaders: ['Authorization', 'Content-Type', 'X-Request-ID', 'X-Master-Password'],
  exposeHeaders: ['X-Request-ID', 'Retry-After', 'X-RateLimit-Limit', 'X-RateLimit-Remaining', 'X-RateLimit-Reset'],
  maxAge: 600,
})
```

변경 사항:
- origin에 `tauri://localhost` 추가 (Tauri 2.x WebView 대응, Phase 9 TAURI-DESK)
- allowHeaders에 `X-Master-Password` 추가 (Phase 8 Admin API 대응)
- exposeHeaders에 `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset` 추가

CORS 설정 상세 테이블이 있다면 동일하게 업데이트.

**API-03: Health 스키마 통일**

CORE-06의 Health 스키마에서 status 값을 통일:
- 현재: `z.enum(['healthy', 'unhealthy', 'degraded'])`
- 유지: 그대로 유지 (CORE-06의 `healthy/unhealthy/degraded`가 더 명시적)

단, `/health`와 `/v1/admin/status` 역할 분리를 명확히 문서화:
- `/health` (공개, 인증 불필요): 간단 스키마 — `{ status, version, uptime, timestamp }`
- `/v1/admin/status` (masterAuth 필요): 상세 스키마 — `{ status, version, uptime, timestamp, services, adapters }`

CORE-06의 HealthResponseSchema에 `timestamp: z.string().datetime()` 필드 추가 (API-SPEC에는 있으나 CORE-06에 누락).

**API-04: Rate Limiter 수치 확인**

CORE-06의 Rate Limiter 설정이 이미 전역 100, 세션 300, 거래 10 req/min이므로 수치 자체는 변경 불필요.
단, config.toml 참조 문구를 추가하여 "config.toml [security] 섹션의 rate_limit_global_rpm, rate_limit_session_rpm, rate_limit_tx_rpm으로 조절 가능"이라고 명시.

**API-06: ownerAuth 미들웨어 반영**

CORE-06 미들웨어 순서 테이블(섹션 2.1)에서:
- 현재: "라우트 레벨 미들웨어 (Phase 8에서 상세 설계)" 주석만 존재
- 수정: ownerAuth를 미들웨어 순서에 명시적으로 포함

미들웨어 순서를 API-SPEC 섹션 4.1 기준 9단계로 업데이트:
1. requestId
2. logger
3. shutdownGuard
4. secureHeaders
5. hostGuard
6. cors
7. rateLimiter
8. sessionAuth (라우트 레벨)
9. ownerAuth (라우트 레벨)

ownerAuth에 대해 간략 설명 추가:
- "per-request SIWS/SIWE 서명 기반 인증. 상세는 34-owner-wallet-connection.md 섹션 5 참조"
- "Authorization: Bearer <base64url JSON> 형식, 8단계 검증"
- "적용 대상: Owner 전용 API (approve/reject, kill-switch, sessions 관리)"

"Phase 8에서 상세 설계" 주석을 제거하고 실제 참조로 교체.
  </action>
  <verify>
```bash
# CORS: tauri://localhost 포함
grep "tauri://localhost" .planning/deliverables/29-api-framework-design.md  # 1 이상

# CORS: X-Master-Password 포함
grep "X-Master-Password" .planning/deliverables/29-api-framework-design.md  # 1 이상

# CORS: RateLimit 헤더 포함
grep "X-RateLimit-Limit" .planning/deliverables/29-api-framework-design.md  # 1 이상

# Health: timestamp 필드 포함
grep "timestamp" .planning/deliverables/29-api-framework-design.md  # 1 이상

# ownerAuth: 미들웨어에 반영
grep "ownerAuth" .planning/deliverables/29-api-framework-design.md  # 1 이상

# "Phase 8에서 상세 설계" 주석 제거 확인
grep "Phase 8에서 상세 설계" .planning/deliverables/29-api-framework-design.md  # 0이어야 함
```
  </verify>
  <done>
- CORS 미들웨어에 tauri://localhost, X-Master-Password, RateLimit expose 헤더 포함
- Health 스키마에 timestamp 필드 추가, /health vs /v1/admin/status 역할 분리 문서화
- Rate Limiter config.toml 참조 문구 추가
- ownerAuth 미들웨어가 9단계 순서에 포함, 34-owner-wallet 참조
  </done>
</task>

<task type="auto">
  <name>Task 2: Health status 통일 + 메모 제한 명시 + SuccessResponse 정리</name>
  <files>
    .planning/deliverables/37-rest-api-complete-spec.md
  </files>
  <action>
37-rest-api-complete-spec.md(API-SPEC)에서 CORE-06과 불일치하는 부분을 수정한다.

**API-03: Health status 값 통일**

Health 엔드포인트 응답의 status enum 수정:
- 수정 전: `z.enum(['ok', 'degraded', 'error'])`
- 수정 후: `z.enum(['healthy', 'degraded', 'unhealthy'])`

`ok` -> `healthy`, `error` -> `unhealthy`로 교체. 문서 내 해당 값을 참조하는 모든 곳(예시 응답, 설명 텍스트)도 함께 수정.

Health 응답 예시가 있다면:
```json
{
  "status": "healthy",
  "version": "0.2.0",
  "uptime": 12345,
  "timestamp": "2026-02-06T00:00:00Z"
}
```

**API-01: 메모 길이 제한 통일**

sendTransaction 엔드포인트의 memo Zod 스키마:
- 현재: `z.string().max(200)` (description 없음 또는 불명확)
- 수정: `z.string().max(200)` 유지 + description 추가

description에 다음 내용 명시:
"최대 200자. Solana Memo Program 256 bytes 이내를 보장한다. UTF-8 멀티바이트 문자 사용 시에도 200자 제한으로 256 bytes를 초과하지 않는다. 체인 어댑터에서 바이트 길이 이중 검증 수행."

31-solana-adapter의 256 bytes 제한이 이중 검증 레이어임을 명확히 하여, API 레벨(200 chars)과 체인 레벨(256 bytes) 제한의 관계를 문서화.

**API-05: SuccessResponse 잔존 검색 + 제거**

37-rest-api 전체에서 다음 패턴을 검색:
- `{ data: ..., success: true }` 형태의 래퍼 패턴
- `SuccessResponse` 타입 참조
- `success: true` 필드 포함 응답

이미 섹션 11.3에서 "래퍼 없이 직접 반환" 결정이 명시되어 있으므로, 잔존 래퍼 패턴이 있으면 제거.

**NOTE**: 12-01에서 수정된 agent.status Zod(CREATING 포함 5개)와 KILL_SWITCH 표시 가이드가 유지되는지 확인. 12-01의 변경 사항을 덮어쓰지 않도록 주의.

**추가: Nonce 엔드포인트 경로 명확화**

37-rest-api에서 nonce 엔드포인트가 `/v1/nonce`로 되어 있는지 확인. 만약 `/v1/auth/nonce`가 잔존하면 `/v1/nonce`로 통일. (RESEARCH에서 API-SPEC이 `/v1/nonce` SSoT로 확인됨)
  </action>
  <verify>
```bash
# Health status: ok 제거, healthy 존재
grep "z.enum.*'ok'" .planning/deliverables/37-rest-api-complete-spec.md  # 0이어야 함
grep "'healthy'" .planning/deliverables/37-rest-api-complete-spec.md  # 1 이상

# Health status: error 제거 (Health enum 맥락에서만), unhealthy 존재
grep "'unhealthy'" .planning/deliverables/37-rest-api-complete-spec.md  # 1 이상

# 메모: 256 bytes 언급
grep "256.*bytes\|256.*바이트" .planning/deliverables/37-rest-api-complete-spec.md  # 1 이상

# 메모: max(200) 유지
grep "max(200)" .planning/deliverables/37-rest-api-complete-spec.md  # 1 이상

# SuccessResponse 래퍼: success: true 패턴 부재 확인 (응답 예시에서)
# 주의: 섹션 11.3의 "미사용" 설명에서는 나올 수 있으므로 응답 스키마에서만 확인

# 12-01 보존: CREATING 유지
grep "CREATING" .planning/deliverables/37-rest-api-complete-spec.md  # 1 이상

# Nonce 경로: /v1/nonce
grep "/v1/nonce" .planning/deliverables/37-rest-api-complete-spec.md  # 1 이상
```
  </verify>
  <done>
- Health status가 healthy/degraded/unhealthy로 통일 (ok, error 제거)
- 메모 Zod 스키마에 200자 + Solana 256 bytes 보장 설명이 명시됨
- SuccessResponse 래퍼 패턴 잔존 없음
- 12-01 수정사항(agent.status 5개) 보존
- Nonce 경로 /v1/nonce 확인
  </done>
</task>

</tasks>

<verification>
1. 29-api-framework와 37-rest-api의 CORS 설정이 동일 (origin, allowHeaders, exposeHeaders)
2. 양쪽 Health status enum이 healthy/degraded/unhealthy
3. Rate Limiter 수치가 양쪽 100/300/10 req/min
4. ownerAuth가 미들웨어 순서에 포함, 더 이상 "Phase 8에서 상세 설계" 주석 없음
5. 메모 제한이 200 chars + 256 bytes 이중 검증으로 설명됨
6. SuccessResponse 래퍼 잔존 없음
7. 12-01, 12-02 수정사항이 보존됨
</verification>

<success_criteria>
- API-01 해결: 메모 200자 + Solana 256 bytes 관계 명시
- API-02 해결: CORS 미들웨어 API-SPEC 기준 통일
- API-03 해결: Health status healthy/degraded/unhealthy 통일
- API-04 해결: Rate Limiter req/min 확인, config.toml 참조 추가
- API-05 해결: SuccessResponse 래퍼 잔존 제거
- API-06 해결: ownerAuth 미들웨어 CORE-06에 반영
</success_criteria>

<output>
After completion, create `.planning/phases/12-high-schema-unification/12-03-SUMMARY.md`
</output>
