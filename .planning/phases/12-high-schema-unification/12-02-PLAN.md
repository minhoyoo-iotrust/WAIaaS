---
phase: 12-high-schema-unification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/24-monorepo-data-directory.md
autonomous: true

must_haves:
  truths:
    - "config.toml [security] 섹션에 jwt_secret 필드가 존재하고 Zod min(32) 검증이 있음"
    - "config.toml [security] 섹션의 session_ttl 기본값이 86400 (24시간)임"
    - "config.toml에 [security.auto_stop] 섹션이 존재하고 consecutive_failures_threshold = 3"
    - "config.toml에 nonce_cache_max = 1000, nonce_cache_ttl = 300 설정이 존재함"
    - "config.toml에 [security.kill_switch] recovery_cooldown = 1800 설정이 존재함"
    - "config.toml에 rate_limit 3-level 구조(global 100, session 300, tx 10)가 존재함"
  artifacts:
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "config.toml 누락 설정 추가 (jwt_secret, nonce_cache, kill_switch, auto_stop, rate_limit 3-level)"
      contains: "jwt_secret"
  key_links:
    - from: ".planning/deliverables/24-monorepo-data-directory.md"
      to: ".planning/deliverables/30-session-token-protocol.md"
      via: "session_ttl = 86400, jwt_secret 필드가 SESS-PROTO 결정과 일치"
      pattern: "session_ttl.*86400"
    - from: ".planning/deliverables/24-monorepo-data-directory.md"
      to: ".planning/deliverables/36-killswitch-autostop-evm.md"
      via: "kill_switch recovery_cooldown, auto_stop threshold가 KILL-AUTO-EVM과 일치"
      pattern: "recovery_cooldown.*1800"
    - from: ".planning/deliverables/24-monorepo-data-directory.md"
      to: ".planning/deliverables/29-api-framework-design.md"
      via: "rate_limit 3-level 값이 CORE-06 정의와 일치"
      pattern: "rate_limit_global_rpm.*100"
---

<objective>
config.toml(24-monorepo-data-directory.md)에 누락된 설정 필드를 추가하고 기존 불일치 값을 수정한다.

Purpose: Phase 7-9에서 확정된 설정값(jwt_secret, session_ttl 24h, nonce 캐시, kill switch 쿨다운, auto stop 임계값, rate limit 3-level)이 config.toml SSoT에 반영되지 않아 구현 시 참조 혼란이 발생한다. 이를 일괄 추가/수정하여 config.toml이 모든 설정의 SSoT 역할을 한다.

Output:
- 24-monorepo-data-directory.md (수정 — config.toml 설정 추가 및 수정)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-high-schema-unification/12-RESEARCH.md
@.planning/phases/11-critical-decisions/11-01-SUMMARY.md

# 수정 대상 문서
@.planning/deliverables/24-monorepo-data-directory.md

# 참조 문서 (확정된 설정값 소스)
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/36-killswitch-autostop-evm.md
@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/33-time-lock-approval-mechanism.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: config.toml 누락 설정 추가 (CONF-01~05)</name>
  <files>
    .planning/deliverables/24-monorepo-data-directory.md
  </files>
  <action>
24-monorepo-data-directory.md의 config.toml 관련 섹션을 수정한다. 이 문서에는 config.toml 스펙이 3곳에 정의되어 있다: (1) 키-값 설정 테이블, (2) Zod 스키마 코드, (3) 기본 config.toml 예시. 3곳 모두 동시에 수정해야 한다.

**CONF-01: session_ttl 3600 -> 86400**

기존 `[security]` 섹션에서:
- 키-값 테이블: `session_ttl` 기본값을 `3600` -> `86400`으로 수정, 설명을 "세션 TTL (초) — 24시간"으로 수정
- Zod 스키마: `.default(3600)` -> `.default(86400)`
- config.toml 예시: `session_ttl = 3600` -> `session_ttl = 86400  # 24시간 (최소 300, 최대 604800)`
- 주석에 "Phase 7 SESS-PROTO에서 24시간 기본으로 확정" 추가

**CONF-02: jwt_secret 필드 추가**

`[security]` 섹션에 `session_ttl` 바로 아래에 추가:
- 키-값 테이블에 행 추가:
  | `jwt_secret` | string | `""` | 64자 hex (256비트) | JWT HS256 서명 Secret. `waiaas init` 시 자동 생성 |
- Zod 스키마에 추가: `jwt_secret: z.string().min(32, 'JWT secret은 최소 32자 이상').default('')`
- config.toml 예시에 추가: `jwt_secret = ""  # waiaas init 시 crypto.randomBytes(32).toString('hex') 자동 생성`
- 환경변수 매핑 테이블에 추가: `WAIAAS_SECURITY_JWT_SECRET`

**CONF-03: [security.auto_stop] 섹션 추가**

config.toml에 새 중첩 섹션 추가:
```toml
[security.auto_stop]
consecutive_failures_threshold = 3    # 연속 실패 임계값 (AutoStopEngine CONSECUTIVE_FAILURES 규칙)
```
- 키-값 테이블에 행 추가: `consecutive_failures_threshold` | number | `3` | 양의 정수 | 연속 트랜잭션 실패 시 자동 정지 임계값
- Zod 스키마에 중첩 객체 추가:
  ```typescript
  auto_stop: z.object({
    consecutive_failures_threshold: z.number().int().min(1).max(100).default(3),
  }).default({}),
  ```

추가로 RESEARCH에서 발견된 Delay/Approval 기본값도 포함:
```toml
[security.policy_defaults]
delay_seconds = 300                   # DELAY 티어 기본 쿨다운 (초) — 5분. 최소 60
approval_timeout = 3600               # APPROVAL 티어 기본 승인 대기 (초) — 1시간
```
- 키-값 테이블과 Zod 스키마에도 동일하게 추가

**CONF-04: nonce_cache 설정 추가**

`[security]` 섹션에 추가:
```toml
nonce_cache_max = 1000                # Nonce LRU 캐시 최대 항목 수
nonce_cache_ttl = 300                 # Nonce TTL (초) — 5분
```
- 키-값 테이블에 2행 추가
- Zod 스키마에 추가:
  ```typescript
  nonce_cache_max: z.number().int().min(100).max(10000).default(1000),
  nonce_cache_ttl: z.number().int().min(60).max(600).default(300),
  ```

**CONF-05: [security.kill_switch] 섹션 추가**

```toml
[security.kill_switch]
recovery_cooldown = 1800              # 복구 최소 쿨다운 (초) — 30분
max_recovery_attempts = 3             # 복구 실패 시 최대 재시도 횟수
```
- 키-값 테이블과 Zod 스키마에도 동일하게 추가

**rate_limit 3-level 구조 확장**

기존 `rate_limit_rpm = 60` (또는 유사한 단일 필드)을 3-level로 교체:
```toml
rate_limit_global_rpm = 100           # 전역 RPM (인증 전, IP 기준)
rate_limit_session_rpm = 300          # 세션당 RPM (인증 후)
rate_limit_tx_rpm = 10                # 거래 전송 RPM
```
- 기존 단일 rate_limit 필드를 제거하고 3개로 교체
- Zod 스키마도 3-level로 업데이트
- 환경변수: `WAIAAS_SECURITY_RATE_LIMIT_GLOBAL_RPM`, `WAIAAS_SECURITY_RATE_LIMIT_SESSION_RPM`, `WAIAAS_SECURITY_RATE_LIMIT_TX_RPM`

**환경변수 매핑 테이블 업데이트**

새로 추가된 모든 설정에 대해 `WAIAAS_{SECTION}_{KEY}` 규칙으로 환경변수 매핑을 추가:
- `WAIAAS_SECURITY_JWT_SECRET`
- `WAIAAS_SECURITY_NONCE_CACHE_MAX`
- `WAIAAS_SECURITY_NONCE_CACHE_TTL`
- `WAIAAS_SECURITY_AUTO_STOP_CONSECUTIVE_FAILURES_THRESHOLD`
- `WAIAAS_SECURITY_KILL_SWITCH_RECOVERY_COOLDOWN`
- `WAIAAS_SECURITY_KILL_SWITCH_MAX_RECOVERY_ATTEMPTS`
- `WAIAAS_SECURITY_POLICY_DEFAULTS_DELAY_SECONDS`
- `WAIAAS_SECURITY_POLICY_DEFAULTS_APPROVAL_TIMEOUT`

**수정 패턴 (3곳 동시 수정 필수):**
각 필드 추가/수정 시 반드시 3곳을 함께 수정:
1. 키-값 설정 테이블 (섹션에 따라 위치 다름)
2. Zod 스키마 코드 블록
3. 기본 config.toml 예시 코드 블록

변경 없는 기존 설정(port, hostname 등)은 건드리지 않는다. Phase 11에서 수정된 내용(port 3100, hostname z.union 등)이 유지되는지 확인.
  </action>
  <verify>
다음 grep 검증을 모두 통과:

```bash
# CONF-01: session_ttl = 86400
grep "session_ttl.*86400" .planning/deliverables/24-monorepo-data-directory.md  # 1 이상
grep "session_ttl.*3600" .planning/deliverables/24-monorepo-data-directory.md  # 0 (3600 잔존 없음)

# CONF-02: jwt_secret 존재
grep "jwt_secret" .planning/deliverables/24-monorepo-data-directory.md  # 3 이상 (테이블, Zod, 예시)
grep "WAIAAS_SECURITY_JWT_SECRET" .planning/deliverables/24-monorepo-data-directory.md  # 1 이상

# CONF-03: auto_stop 섹션
grep "consecutive_failures_threshold" .planning/deliverables/24-monorepo-data-directory.md  # 2 이상

# CONF-04: nonce_cache
grep "nonce_cache_max" .planning/deliverables/24-monorepo-data-directory.md  # 2 이상
grep "nonce_cache_ttl" .planning/deliverables/24-monorepo-data-directory.md  # 2 이상

# CONF-05: kill_switch
grep "recovery_cooldown.*1800" .planning/deliverables/24-monorepo-data-directory.md  # 1 이상

# rate_limit 3-level
grep "rate_limit_global_rpm.*100" .planning/deliverables/24-monorepo-data-directory.md  # 1 이상
grep "rate_limit_session_rpm.*300" .planning/deliverables/24-monorepo-data-directory.md  # 1 이상
grep "rate_limit_tx_rpm.*10" .planning/deliverables/24-monorepo-data-directory.md  # 1 이상

# Phase 11 보존: port 3100 유지
grep "3100" .planning/deliverables/24-monorepo-data-directory.md  # 1 이상
```
  </verify>
  <done>
- session_ttl = 86400 (3600 잔존 없음)
- jwt_secret 필드가 테이블/Zod/예시 3곳에 존재
- [security.auto_stop] consecutive_failures_threshold = 3 존재
- nonce_cache_max = 1000, nonce_cache_ttl = 300 존재
- [security.kill_switch] recovery_cooldown = 1800 존재
- rate_limit 3-level (100/300/10) 존재, 기존 단일 rate_limit_rpm 제거
- [security.policy_defaults] delay_seconds, approval_timeout 존재
- 환경변수 매핑 테이블에 모든 신규 필드 포함
- Phase 11 수정사항(port 3100, hostname z.union) 보존
  </done>
</task>

</tasks>

<verification>
1. 24-monorepo-data-directory.md에서 session_ttl 기본값이 86400
2. jwt_secret 필드가 키-값 테이블, Zod 스키마, config.toml 예시 3곳에 존재
3. 중첩 섹션 [security.auto_stop], [security.kill_switch], [security.policy_defaults] 존재
4. nonce_cache_max, nonce_cache_ttl 설정 존재
5. rate_limit 3-level 구조 (global/session/tx) 존재
6. 환경변수 매핑 테이블 업데이트
7. Phase 11 수정사항 보존 (port 3100, hostname z.union)
</verification>

<success_criteria>
- CONF-01 해결: session_ttl = 86400 (24시간)
- CONF-02 해결: jwt_secret 필드 추가, WAIAAS_SECURITY_JWT_SECRET 환경변수 매핑
- CONF-03 해결: consecutive_failures_threshold = 3 설정화
- CONF-04 해결: nonce_cache_max = 1000, nonce_cache_ttl = 300 설정화
- CONF-05 해결: kill_switch recovery_cooldown = 1800 설정화
- 추가: rate_limit 3-level, policy_defaults delay/approval 설정화
</success_criteria>

<output>
After completion, create `.planning/phases/12-high-schema-unification/12-02-SUMMARY.md`
</output>
