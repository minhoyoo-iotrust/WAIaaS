---
phase: 12-high-schema-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/45-enum-unified-mapping.md
autonomous: true

must_haves:
  truths:
    - "모든 Enum의 DB CHECK, Drizzle ORM, Zod 스키마가 1:1 대응하는 통합 대응표가 존재함"
    - "AgentStatus가 DB CHECK 5개 값(CREATING, ACTIVE, SUSPENDED, TERMINATING, TERMINATED)으로 모든 문서에서 일관됨"
    - "PolicyType이 SPENDING_LIMIT, WHITELIST, TIME_RESTRICTION, RATE_LIMIT 4개 값으로 모든 문서에서 일관됨"
    - "KILL_SWITCH는 DB 상태가 아닌 클라이언트 표시 상태(SUSPENDED + suspension_reason)로 정의됨"
    - "TransactionStatus 8개 상태가 대응표에 Phase 11 SSoT 기준으로 기록됨"
  artifacts:
    - path: ".planning/deliverables/45-enum-unified-mapping.md"
      provides: "전체 Enum 통합 대응표 (9개 Enum)"
      contains: "AgentStatus"
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "PolicyType CHECK 제약 수정"
      contains: "WHITELIST"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "AgentStatus Zod enum 수정"
      contains: "CREATING"
  key_links:
    - from: ".planning/deliverables/45-enum-unified-mapping.md"
      to: ".planning/deliverables/25-sqlite-schema.md"
      via: "DB CHECK 값과 대응표 값 일치"
      pattern: "WHITELIST.*RATE_LIMIT"
    - from: ".planning/deliverables/45-enum-unified-mapping.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "Zod enum 값과 대응표 값 일치"
      pattern: "CREATING.*ACTIVE.*SUSPENDED.*TERMINATING.*TERMINATED"
---

<objective>
모든 Enum/상태값의 통합 대응표를 작성하고, DB CHECK 제약과 REST API Zod 스키마의 불일치를 수정한다.

Purpose: 9개 Enum에 대해 DB CHECK, Drizzle ORM, Zod 스키마, TypeScript 타입이 1:1로 대응하는 단일 진실 소스(SSoT) 대응표를 만들어, 구현 단계에서 Enum 값 불일치로 인한 런타임 에러를 원천 방지한다.

Output:
- 45-enum-unified-mapping.md (신규 — 전체 Enum 통합 대응표)
- 25-sqlite-schema.md (수정 — policies.type CHECK 제약)
- 37-rest-api-complete-spec.md (수정 — agent.status Zod enum)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-high-schema-unification/12-RESEARCH.md
@.planning/phases/11-critical-decisions/11-01-SUMMARY.md

# 수정 대상 문서
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/37-rest-api-complete-spec.md

# 참조 문서 (Enum SSoT 확인)
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/deliverables/36-killswitch-autostop-evm.md
@.planning/deliverables/32-transaction-pipeline-api.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enum 통합 대응표 작성 + SQLite/REST API 불일치 수정</name>
  <files>
    .planning/deliverables/45-enum-unified-mapping.md
    .planning/deliverables/25-sqlite-schema.md
    .planning/deliverables/37-rest-api-complete-spec.md
  </files>
  <action>
**1단계: 45-enum-unified-mapping.md 신규 작성**

9개 Enum 각각에 대해 다음 포맷으로 통합 대응표를 작성한다:

| Domain | Enum Name | Values | SSoT 문서 | DB CHECK | Drizzle ORM | Zod Schema | TypeScript Type | 비고 |
|--------|-----------|--------|----------|----------|-------------|------------|----------------|------|

대상 Enum 9개:
1. **TransactionStatus** (CORE-02 + TX-PIPE): PENDING, QUEUED, EXECUTING, SUBMITTED, CONFIRMED, FAILED, CANCELLED, EXPIRED — Phase 11 SSoT 확정
2. **TransactionTier** (CORE-02): INSTANT, NOTIFY, DELAY, APPROVAL
3. **AgentStatus** (CORE-02): CREATING, ACTIVE, SUSPENDED, TERMINATING, TERMINATED — DB CHECK가 SSoT. KILL_SWITCH는 "클라이언트 표시 상태" 섹션에 별도 설명 (status=SUSPENDED + suspension_reason=kill_switch)
4. **PolicyType** (LOCK-MECH): SPENDING_LIMIT, WHITELIST, TIME_RESTRICTION, RATE_LIMIT — Phase 8이 SSoT, CORE-02 수정 필요
5. **NotificationChannelType** (CORE-02): TELEGRAM, DISCORD, NTFY
6. **AuditLogSeverity** (CORE-02): INFO, WARN, ERROR, CRITICAL
7. **AuditLogEventType** (CORE-02): 전체 이벤트 타입 목록 (agent_created, tx_submitted 등)
8. **KillSwitchStatus** (KILL-AUTO-EVM): NORMAL, ACTIVATED, RECOVERING
9. **AutoStopRuleType** (KILL-AUTO-EVM): CONSECUTIVE_FAILURES, TIME_WINDOW, ANOMALY_HOURS, THRESHOLD_PROXIMITY, VELOCITY

각 Enum에 대해:
- DB CHECK 값 (25-sqlite-schema.md에서 추출)
- Drizzle ORM text() 정의 (25-sqlite-schema.md에서 추출)
- Zod enum (37-rest-api-complete-spec.md 또는 해당 Phase 문서에서 추출)
- TypeScript type (z.infer<typeof ...> 패턴)
- 불일치 여부와 수정 방향

"클라이언트 표시 상태" 별도 섹션에서:
- KILL_SWITCH = SUSPENDED + suspension_reason=kill_switch (ENUM-01 해결)
- Phase 11 CRIT-02 참조: TransactionStatus + Tier 조합 표시 가이드

API 경로 SSoT도 기록: `/v1/nonce`가 SSoT (Phase 9 확정, `/v1/auth/nonce`는 Phase 7 구버전)

문서 상단에 "이 문서는 모든 Enum의 단일 진실 소스(SSoT)이다. 구현 시 이 대응표와 일치하지 않는 값은 버그이다." 명시.

**2단계: 25-sqlite-schema.md 수정 (ENUM-02)**

policies 테이블의 CHECK 제약 수정:
- `ALLOWED_ADDRESSES` -> `WHITELIST`
- `AUTO_STOP` 제거, `RATE_LIMIT` 추가
- 수정 전: `CHECK(type IN ('SPENDING_LIMIT', 'ALLOWED_ADDRESSES', 'TIME_RESTRICTION', 'AUTO_STOP'))`
- 수정 후: `CHECK(type IN ('SPENDING_LIMIT', 'WHITELIST', 'TIME_RESTRICTION', 'RATE_LIMIT'))`

Drizzle ORM 정의도 동일하게 수정.

policies 관련 인덱스가 있다면 Phase 8 기준 `idx_policies_agent_enabled` 복합 인덱스와 일치시킨다.

**NOTE**: 수정 시 `AUTO_STOP`이 언급되는 다른 곳(예: 설명 텍스트)도 함께 수정하되, AutoStopEngine은 별도 시스템이므로 해당 언급은 유지. PolicyType으로서의 `AUTO_STOP`만 변경.

**3단계: 37-rest-api-complete-spec.md 수정 (ENUM-01)**

에이전트 응답 Zod 스키마 수정:
- 수정 전: `z.enum(['ACTIVE', 'SUSPENDED', 'TERMINATED', 'KILL_SWITCH'])` (4개)
- 수정 후: `z.enum(['CREATING', 'ACTIVE', 'SUSPENDED', 'TERMINATING', 'TERMINATED'])` (5개, DB CHECK 일치)

`KILL_SWITCH`가 사용되는 모든 곳에서:
- Zod enum에서 제거
- "KILL_SWITCH는 DB 상태가 아닌 클라이언트 표시 상태" 설명 추가 또는 기존 설명 강화
- 기존 admin/status 응답에서도 동일하게 수정

이미 Phase 11에서 추가된 "클라이언트 상태 표시 가이드" 섹션이 있다면, 해당 섹션에서 AgentStatus도 포함하도록 확장:
- status=SUSPENDED + suspension_reason=kill_switch -> 클라이언트 표시: "킬 스위치 발동"
  </action>
  <verify>
다음 grep 검증을 모두 통과:

```bash
# 1. 대응표에 9개 Enum 모두 포함
grep -c "TransactionStatus\|TransactionTier\|AgentStatus\|PolicyType\|NotificationChannelType\|AuditLogSeverity\|AuditLogEventType\|KillSwitchStatus\|AutoStopRuleType" .planning/deliverables/45-enum-unified-mapping.md

# 2. PolicyType: ALLOWED_ADDRESSES가 25-sqlite에서 제거됨
grep -c "ALLOWED_ADDRESSES" .planning/deliverables/25-sqlite-schema.md  # 0이어야 함

# 3. PolicyType: WHITELIST가 25-sqlite에 존재
grep -c "WHITELIST" .planning/deliverables/25-sqlite-schema.md  # 1 이상

# 4. PolicyType: AUTO_STOP가 CHECK 제약에서 제거됨 (AutoStopEngine 언급은 OK)
grep "CHECK.*AUTO_STOP" .planning/deliverables/25-sqlite-schema.md  # 0이어야 함

# 5. AgentStatus: CREATING이 37-rest-api에 존재
grep "CREATING" .planning/deliverables/37-rest-api-complete-spec.md  # 1 이상

# 6. AgentStatus: KILL_SWITCH가 Zod enum에서 제거됨
# (KILL_SWITCH 단어 자체는 설명에 남아있을 수 있으므로 z.enum 라인에서만 확인)
grep "z.enum.*KILL_SWITCH" .planning/deliverables/37-rest-api-complete-spec.md  # 0이어야 함

# 7. RATE_LIMIT이 25-sqlite에 존재
grep "RATE_LIMIT" .planning/deliverables/25-sqlite-schema.md  # 1 이상
```
  </verify>
  <done>
- 45-enum-unified-mapping.md에 9개 Enum의 DB CHECK / Drizzle ORM / Zod / TypeScript 대응표가 존재
- 25-sqlite-schema.md의 policies.type CHECK가 SPENDING_LIMIT, WHITELIST, TIME_RESTRICTION, RATE_LIMIT
- 37-rest-api-complete-spec.md의 agent.status Zod가 CREATING, ACTIVE, SUSPENDED, TERMINATING, TERMINATED (5개)
- KILL_SWITCH는 클라이언트 표시 상태로 분류, Zod enum에서 제거
- 모든 grep 검증 통과
  </done>
</task>

</tasks>

<verification>
1. 45-enum-unified-mapping.md 파일이 존재하고 9개 Enum 대응표를 포함
2. 25-sqlite-schema.md에서 `ALLOWED_ADDRESSES`와 `AUTO_STOP` CHECK가 제거됨
3. 25-sqlite-schema.md에서 `WHITELIST`와 `RATE_LIMIT`이 CHECK에 존재
4. 37-rest-api-complete-spec.md에서 agent.status가 DB CHECK 5개 값과 일치
5. `KILL_SWITCH`가 z.enum 내에서 사용되지 않음 (설명 텍스트에서는 가능)
6. 대응표의 각 Enum 값이 실제 문서의 값과 일치 (교차 검증)
</verification>

<success_criteria>
- ENUM-01 해결: AgentStatus DB 5개 = REST API Zod 5개
- ENUM-02 해결: PolicyType DB 4개 = Phase 8 4개 (WHITELIST, RATE_LIMIT 반영)
- ENUM-03 해결: TransactionStatus 8개 대응표 기록 (이미 통일, 명시적 기록)
- ENUM-04 해결: 9개 Enum 통합 대응표 산출물 생성
</success_criteria>

<output>
After completion, create `.planning/phases/12-high-schema-unification/12-01-SUMMARY.md`
</output>
