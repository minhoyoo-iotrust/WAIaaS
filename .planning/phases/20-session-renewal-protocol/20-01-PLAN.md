---
phase: 20-session-renewal-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/53-session-renewal-protocol.md
  - .planning/deliverables/30-session-token-protocol.md
autonomous: true

must_haves:
  truths:
    - "낙관적 갱신 프로토콜이 정의되어 있다: 에이전트가 sessionAuth만으로 PUT /v1/sessions/:id/renew를 호출하여 새 JWT를 발급받는다"
    - "5종 안전 장치가 명세되어 있다: maxRenewals 30, 절대 수명 30일, 50% 시점 갱신, 거부 윈도우 1h, 갱신 단위 고정"
    - "토큰 회전 메커니즘이 정의되어 있다: 갱신 시 새 JWT 발급 + token_hash 교체"
    - "Owner 사후 거부 플로우가 정의되어 있다: DELETE /v1/sessions/:id 재활용, SESSION_RENEWED/SESSION_RENEWAL_REJECTED 알림"
    - "SessionConstraints에 maxRenewals, renewalRejectWindow 필드가 추가되어 있다"
    - "30-session-token-protocol.md의 수명주기가 4단계에서 5단계(갱신 포함)로 확장되어 있다"
  artifacts:
    - path: ".planning/deliverables/53-session-renewal-protocol.md"
      provides: "세션 갱신 프로토콜 SSoT 문서"
      contains: "PUT /v1/sessions/:id/renew"
    - path: ".planning/deliverables/30-session-token-protocol.md"
      provides: "SessionConstraints 확장, 수명주기 5단계"
      contains: "maxRenewals"
  key_links:
    - from: "53-session-renewal-protocol.md"
      to: "52-auth-model-redesign.md"
      via: "sessionAuth 인증 참조"
    - from: "53-session-renewal-protocol.md"
      to: "30-session-token-protocol.md"
      via: "SessionConstraints 스키마 참조"
    - from: "30-session-token-protocol.md"
      to: "53-session-renewal-protocol.md"
      via: "갱신 단계 상세 위임"
---

<objective>
세션 갱신 프로토콜의 핵심 정의를 수립한다: 신규 SSoT 문서(53-session-renewal-protocol.md)에 낙관적 갱신 패턴, API 스펙, 5종 안전 장치, 토큰 회전, Owner 사후 거부 플로우를 정의하고, 기존 30-session-token-protocol.md에 SessionConstraints 확장과 수명주기 5단계를 반영한다.

Purpose: Phase 20의 5개 요구사항(SESS-01~05) 중 SESS-01(API 스펙), SESS-02(안전 장치 5종), SESS-04(SessionConstraints 확장), SESS-05(Owner 거부 + 알림 이벤트 정의)를 핵심 프로토콜 문서에서 해결한다.
Output: 53-session-renewal-protocol.md (신규), 30-session-token-protocol.md (수정)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 19 outputs (인증 모델 확정)
@.planning/phases/19-auth-owner-redesign/19-01-SUMMARY.md

# Research (Phase 20 설계 결정 사항 전체)
@.planning/phases/20-session-renewal-protocol/20-RESEARCH.md

# 수정 대상 문서
@.planning/deliverables/30-session-token-protocol.md

# 참조 문서
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/37-rest-api-complete-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 53-session-renewal-protocol.md 신규 작성</name>
  <files>.planning/deliverables/53-session-renewal-protocol.md</files>
  <action>
세션 갱신 프로토콜 SSoT 문서를 신규 작성한다. 기존 프로젝트 문서 스타일(한글, 마크다운, 섹션 번호)을 따른다.

**문서 구조 (8개 섹션):**

**섹션 1: 개요**
- 문서 목적: 세션 갱신 프로토콜 정의 (낙관적 갱신 패턴)
- 참조 문서: 30-session-token-protocol.md, 52-auth-model-redesign.md, 25-sqlite-schema.md
- 핵심 원칙: (1) 에이전트 자율 갱신 (sessionAuth만), (2) Owner 사후 거부, (3) 토큰 회전, (4) 5종 안전 장치

**섹션 2: 낙관적 갱신 개념**
- 정의: 에이전트가 먼저 갱신하고 Owner가 사후 거부할 수 있는 비동기 패턴
- 시퀀스 다이어그램: 에이전트 -> WAIaaS 데몬 -> Owner (mermaid 사용)
- 설계 근거: AI 에이전트 자율 운영, Owner 항상 온라인 불가, Self-Hosted 환경

**섹션 3: PUT /v1/sessions/:id/renew API 스펙**
- 인증: sessionAuth (Bearer token)
- 요청: 파라미터 id (UUID), 바디 없음 (갱신 단위 고정)
- 응답 200: { sessionId, token, expiresAt, renewalCount, maxRenewals, absoluteExpiresAt }
- 에러 코드 5개:
  - 403 RENEWAL_LIMIT_REACHED (Guard 1)
  - 403 SESSION_ABSOLUTE_LIFETIME_EXCEEDED (Guard 2)
  - 403 RENEWAL_TOO_EARLY (Guard 3)
  - 403 SESSION_RENEWAL_MISMATCH (JWT sid != :id)
  - 404 SESSION_NOT_FOUND
- Zod 스키마: RenewSessionResponseSchema (20-RESEARCH.md Example 1 참조)
- 추가 제약: JWT의 sid claim과 요청의 :id가 일치해야 함 (자신의 세션만 갱신 가능)
- Kill Switch ACTIVATED 상태에서 차단 (killSwitchGuard 적용 대상)

**섹션 4: 5종 안전 장치**
- 20-RESEARCH.md의 Pattern 3 (5종 안전 장치) 내용을 정식 명세로 작성
- 각 장치별: 이름, 설정값(기본/범위), 검증 시점, 검증 로직(의사 코드), 위반 시 에러 코드 + HTTP 상태
- Guard 1: maxRenewals (기본 30, 범위 0~100, renewal_count >= max_renewals -> 403 RENEWAL_LIMIT_REACHED)
- Guard 2: 절대 수명 (기본 30일=2592000초, config.toml [security].session_absolute_lifetime, now + expiresIn > createdAt + absoluteLifetime -> 403)
- Guard 3: 50% 시점 (now < referenceTime + expiresIn * 0.5 -> 403 RENEWAL_TOO_EARLY, referenceTime = last_renewed_at ?? created_at)
- Guard 4: 거부 윈도우 (기본 3600초, SessionConstraints.renewalRejectWindow, 알림 안내용 -- 검증이 아닌 정보)
- Guard 5: 갱신 단위 고정 (원래 expiresIn 재사용, 에이전트가 임의 연장 불가)
- 검증 순서: Guard 1 -> Guard 2 -> Guard 3 (순서 중요: 가장 비용 낮은 것부터)

**섹션 5: 토큰 회전 메커니즘**
- JWT 불변성 원칙 설명
- 갱신 플로우: (1) sessionAuth 검증, (2) 5종 안전 장치 검증, (3) 새 JWT 발급 (SignJWT + HS256), (4) 새 token_hash 계산, (5) BEGIN IMMEDIATE 트랜잭션 내 DB 업데이트 (token_hash, expires_at, renewal_count++, last_renewed_at), (6) 응답 반환
- 구 토큰 자동 무효화: token_hash 교체로 구 토큰 조회 불가
- 동시 갱신 방어: BEGIN IMMEDIATE가 자연스럽게 직렬화. 두 번째 요청은 token_hash 불일치로 401.
- 코드 패턴: 20-RESEARCH.md Example 2 참조하되 정식 명세 수준으로 작성

**섹션 6: Owner 사후 거부 플로우**
- 거부 메커니즘: 기존 DELETE /v1/sessions/:id 재활용 (masterAuth implicit)
  - 별도 거부 엔드포인트 불필요: 결과 동일(revokedAt 설정), audit_log details JSON으로 구분 가능, 엔드포인트 수 최소화
- 플로우: (1) 갱신 성공 -> SESSION_RENEWED 알림, (2) Owner 확인, (3) Owner가 DELETE /v1/sessions/:id 호출 (거부 윈도우 내 권장, 윈도우 밖에서도 가능), (4) revokedAt 설정 -> SESSION_RENEWAL_REJECTED 알림, (5) 에이전트 다음 요청 시 401 SESSION_REVOKED
- 거부 윈도우 해석: 알림의 "안내 문구"에 불과. Owner는 언제든 세션 폐기 가능. "이 시간 내 확인 권장" 의미.
- usageStats 유지: 갱신은 기간 연장이지 새 세션이 아님. maxTotalAmount, maxTransactions 누적 유지.

**섹션 7: 알림 이벤트 2종**
- SESSION_RENEWED: severity=INFO, 트리거=갱신 성공 시, context 필드(sessionId, agentName, renewalCount, maxRenewals, remainingAbsoluteLife, rejectWindowExpiry)
- SESSION_RENEWAL_REJECTED: severity=WARNING, 트리거=갱신 후 Owner가 세션 폐기 시, context 필드(sessionId, agentName, renewalCount, rejectedAt)
- 메시지 템플릿: Telegram MarkdownV2, Discord Embed, ntfy.sh 각각

**섹션 8: config.toml 설정**
- [security] 섹션에 3개 항목 추가:
  - session_absolute_lifetime = 2592000 (기본 30일, 범위 86400~7776000)
  - default_max_renewals = 30 (기본 30, 범위 0~100)
  - default_renewal_reject_window = 3600 (기본 1시간, 범위 300~86400)
- Zod 스키마 업데이트 (SecurityConfigSchema 확장)
  </action>
  <verify>
문서 내용 확인:
- "PUT /v1/sessions" 문자열 존재
- "RENEWAL_LIMIT_REACHED" 에러 코드 존재
- "SESSION_RENEWED" 알림 이벤트 존재
- "maxRenewals" 필드 존재
- 섹션 1~8 모두 존재
- 30-session-token-protocol.md 참조 존재
  </verify>
  <done>
53-session-renewal-protocol.md가 8개 섹션으로 구성되어 있고, PUT /v1/sessions/:id/renew API 스펙(요청/응답/에러 5개), 5종 안전 장치 상세 명세, 토큰 회전 메커니즘, Owner 사후 거부 플로우, SESSION_RENEWED/SESSION_RENEWAL_REJECTED 알림 이벤트 2종, config.toml 설정 3개가 모두 포함되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 30-session-token-protocol.md 수명주기 확장 + SessionConstraints 갱신 필드 추가</name>
  <files>.planning/deliverables/30-session-token-protocol.md</files>
  <action>
기존 30-session-token-protocol.md를 v0.5 세션 갱신 프로토콜에 맞게 업데이트한다. 19-03의 패턴을 따라 기존 구조 유지 + "(v0.5 변경)" 인라인 마킹.

**변경 1: 섹션 5 (SessionConstraints) -- maxRenewals, renewalRejectWindow 추가**
- 기존 6개 필드 유지
- 2개 필드 추가:
  - maxRenewals: z.number().int().min(0).max(100).optional().default(30) -- "최대 갱신 횟수. 0이면 갱신 불가."
  - renewalRejectWindow: z.number().int().min(300).max(86400).optional().default(3600) -- "갱신 후 Owner 거부 권장 시간 (초)"
- SessionConstraintsSchema Zod 정의 업데이트
- 필드 설명 테이블에 2행 추가

**변경 2: 섹션 7 (세션 수명주기) -- 4단계 -> 5단계**
- 기존 4단계: 생성(ACTIVE) -> 사용(ACTIVE) -> 만료(EXPIRED) -> 폐기(REVOKED)
- 변경 후 5단계: 생성(ACTIVE) -> 사용(ACTIVE) -> **갱신(ACTIVE, renewal)** -> 만료(EXPIRED) -> 폐기(REVOKED)
- 갱신 단계 설명:
  - 트리거: PUT /v1/sessions/:id/renew (sessionAuth)
  - 동작: 5종 안전 장치 검증 -> 토큰 회전 -> renewal_count++ -> 새 expiresAt
  - 상세: 53-session-renewal-protocol.md 참조 (인라인 위임)
- 수명주기 시퀀스 다이어그램 업데이트 (기존 mermaid 다이어그램에 갱신 루프 추가)

**변경 3: 섹션 7.5 (세션 API 엔드포인트 요약) -- PUT /v1/sessions/:id/renew 추가**
- 기존 엔드포인트 테이블에 1행 추가:
  - PUT /v1/sessions/:id/renew | sessionAuth | 세션 갱신 (토큰 회전) | 53-session-renewal-protocol.md

**변경 4: 53-session-renewal-protocol.md 참조 추가**
- 문서 상단 참조 문서 목록에 "53-session-renewal-protocol.md (세션 갱신 프로토콜)" 추가
- 갱신 관련 상세 설명이 필요한 곳에 "상세: 53-session-renewal-protocol.md 참조" 위임 링크

**주의사항:**
- 기존 내용을 삭제하지 않는다. 확장/추가만 한다.
- "(v0.5 변경)" 또는 "(Phase 20 추가)" 마킹으로 변경 지점 명확화
- 기존 sessionAuth 2-stage 검증 로직은 변경 없음 (갱신도 동일한 sessionAuth로 인증)
  </action>
  <verify>
문서 내용 확인:
- "maxRenewals" 필드가 SessionConstraints에 존재
- "renewalRejectWindow" 필드가 SessionConstraints에 존재
- "갱신" 단계가 수명주기에 포함
- "PUT /v1/sessions/:id/renew" 엔드포인트가 요약 테이블에 존재
- "53-session-renewal-protocol.md" 참조가 존재
- 기존 6개 SessionConstraints 필드가 유지됨
  </verify>
  <done>
30-session-token-protocol.md의 SessionConstraints가 8개 필드(기존 6 + maxRenewals + renewalRejectWindow)로 확장되어 있고, 수명주기가 5단계(갱신 포함)로 업데이트되어 있으며, API 엔드포인트 요약에 PUT /v1/sessions/:id/renew가 추가되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 53-session-renewal-protocol.md 존재 + 8개 섹션 구성 확인
2. PUT /v1/sessions/:id/renew 스펙이 sessionAuth로 정의됨 확인
3. 5종 안전 장치 각각의 이름/설정값/에러코드가 명세됨 확인
4. SessionConstraints에 maxRenewals, renewalRejectWindow 2개 필드 추가됨 확인
5. SESSION_RENEWED, SESSION_RENEWAL_REJECTED 알림 이벤트 2종 정의됨 확인
6. 30-session-token-protocol.md 수명주기가 갱신 단계를 포함한 5단계로 확장됨 확인
7. 문서 간 상호 참조 일관성 확인 (53 <-> 30, 53 -> 52)
</verification>

<success_criteria>
- 53-session-renewal-protocol.md가 세션 갱신의 SSoT 역할을 수행 (다른 문서가 이 문서를 참조)
- SESS-01 (API 스펙), SESS-02 (안전 장치 5종), SESS-04 (SessionConstraints 확장), SESS-05 (Owner 거부 + 알림) 커버
- 30-session-token-protocol.md가 v0.5 갱신 프로토콜과 일관
</success_criteria>

<output>
After completion, create `.planning/phases/20-session-renewal-protocol/20-01-SUMMARY.md`
</output>
