---
phase: 20-session-renewal-protocol
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified:
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/35-notification-architecture.md
autonomous: true

must_haves:
  truths:
    - "sessions í…Œì´ë¸”ì— renewal_count, max_renewals, last_renewed_at, absolute_expires_at ì»¬ëŸ¼ì´ ì¶”ê°€ë˜ì–´ ìˆë‹¤"
    - "ë§ˆì´ê·¸ë ˆì´ì…˜ SQL(ALTER TABLE ADD COLUMN 4ê°œ)ì´ ì‘ì„±ë˜ì–´ ìˆë‹¤"
    - "37-rest-api-complete-spec.mdì— PUT /v1/sessions/:id/renew ì—”ë“œí¬ì¸íŠ¸ê°€ ì¶”ê°€ë˜ì–´ ìˆë‹¤"
    - "ì—ëŸ¬ ì½”ë“œ í…Œì´ë¸”ì— RENEWAL_* ì½”ë“œ 5ê°œê°€ ì¶”ê°€ë˜ì–´ ìˆë‹¤"
    - "35-notification-architecture.mdì— SESSION_RENEWED, SESSION_RENEWAL_REJECTED ì´ë²¤íŠ¸ 2ì¢…ì´ ì¶”ê°€ë˜ì–´ ìˆë‹¤"
  artifacts:
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "sessions í…Œì´ë¸” ê°±ì‹  ì»¬ëŸ¼ 4ê°œ, Drizzle ORM ì •ì˜, ë§ˆì´ê·¸ë ˆì´ì…˜ SQL"
      contains: "renewal_count"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "PUT /v1/sessions/:id/renew ì—”ë“œí¬ì¸íŠ¸ ìŠ¤í™, RENEWAL_* ì—ëŸ¬ ì½”ë“œ"
      contains: "RENEWAL_LIMIT_REACHED"
    - path: ".planning/deliverables/35-notification-architecture.md"
      provides: "SESSION_RENEWED, SESSION_RENEWAL_REJECTED ì´ë²¤íŠ¸ ì •ì˜"
      contains: "SESSION_RENEWED"
  key_links:
    - from: "25-sqlite-schema.md"
      to: "53-session-renewal-protocol.md"
      via: "sessions í…Œì´ë¸” ê°±ì‹  ì»¬ëŸ¼ ì°¸ì¡°"
    - from: "37-rest-api-complete-spec.md"
      to: "53-session-renewal-protocol.md"
      via: "ê°±ì‹  ì—”ë“œí¬ì¸íŠ¸ ìƒì„¸ ì°¸ì¡°"
    - from: "35-notification-architecture.md"
      to: "53-session-renewal-protocol.md"
      via: "ê°±ì‹  ì•Œë¦¼ ì´ë²¤íŠ¸ ì°¸ì¡°"
---

<objective>
ì„¸ì…˜ ê°±ì‹  í”„ë¡œí† ì½œì„ ê¸°ì¡´ ì„¤ê³„ ë¬¸ì„œ 3ê°œ(25-sqlite-schema.md, 37-rest-api-complete-spec.md, 35-notification-architecture.md)ì— ë°˜ì˜í•œë‹¤. 20-01ì—ì„œ ìƒì„±í•œ 53-session-renewal-protocol.mdì˜ ì •ì˜ë¥¼ ê° ë¬¸ì„œì˜ í•´ë‹¹ ì„¹ì…˜ì— í†µí•©í•œë‹¤.

Purpose: SESS-03(sessions í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ë³€ê²½)ì„ í•´ê²°í•˜ê³ , SESS-01(API ìŠ¤í™)ê³¼ SESS-05(ì•Œë¦¼ ì´ë²¤íŠ¸)ë¥¼ ê¸°ì¡´ ë¬¸ì„œì— ì „íŒŒí•˜ì—¬ ì„¤ê³„ ë¬¸ì„œ ê°„ ì¼ê´€ì„±ì„ í™•ë³´í•œë‹¤.
Output: 25-sqlite-schema.md (ìˆ˜ì •), 37-rest-api-complete-spec.md (ìˆ˜ì •), 35-notification-architecture.md (ìˆ˜ì •)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 20 Plan 01 ê²°ê³¼ (í”„ë¡œí† ì½œ ì •ì˜ SSoT)
@.planning/phases/20-session-renewal-protocol/20-01-SUMMARY.md
@.planning/deliverables/53-session-renewal-protocol.md

# Research (ìƒì„¸ ì½”ë“œ íŒ¨í„´)
@.planning/phases/20-session-renewal-protocol/20-RESEARCH.md

# ìˆ˜ì • ëŒ€ìƒ ë¬¸ì„œ
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/35-notification-architecture.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 25-sqlite-schema.md sessions í…Œì´ë¸” ê°±ì‹  ì»¬ëŸ¼ ì¶”ê°€</name>
  <files>.planning/deliverables/25-sqlite-schema.md</files>
  <action>
sessions í…Œì´ë¸”ì— ì„¸ì…˜ ê°±ì‹  ì¶”ì ì„ ìœ„í•œ ì»¬ëŸ¼ 4ê°œë¥¼ ì¶”ê°€í•œë‹¤. 19-02ì—ì„œ ì ìš©í•œ íŒ¨í„´ì„ ë”°ë¼ ê¸°ì¡´ êµ¬ì¡° ìœ ì§€ + "(Phase 20 ì¶”ê°€)" ì¸ë¼ì¸ ë§ˆí‚¹.

**ë³€ê²½ 1: ì„¹ì…˜ 2.2 sessions í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ -- ì»¬ëŸ¼ 4ê°œ ì¶”ê°€**
- ê¸°ì¡´ ì»¬ëŸ¼ ìœ ì§€ (id, agent_id, token_hash, constraints, expires_at, revoked_at, created_at)
- 4ê°œ ì»¬ëŸ¼ ì¶”ê°€ (Phase 20 ì¶”ê°€ ë§ˆí‚¹):

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|------|------|-------|------|
| renewal_count | INTEGER | NOT NULL | 0 | ëˆ„ì  ê°±ì‹  íšŸìˆ˜ |
| max_renewals | INTEGER | NOT NULL | 30 | ìµœëŒ€ ê°±ì‹  íšŸìˆ˜ (SessionConstraintsì—ì„œ ë³µì‚¬) |
| last_renewed_at | INTEGER | NULL | NULL | ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê° (Unix epoch ì´ˆ) |
| absolute_expires_at | INTEGER | NOT NULL | - | ì ˆëŒ€ ë§Œë£Œ ì‹œê° (created_at + session_absolute_lifetime) |

**ë³€ê²½ 2: Drizzle ORM ì •ì˜ ì—…ë°ì´íŠ¸**
- sessions sqliteTable ì •ì˜ì— 4ê°œ ì»¬ëŸ¼ ì¶”ê°€:
  ```typescript
  // â”€â”€ Phase 20 ì¶”ê°€: ì„¸ì…˜ ê°±ì‹  ì¶”ì  â”€â”€
  renewalCount: integer('renewal_count').notNull().default(0),
  maxRenewals: integer('max_renewals').notNull().default(30),
  lastRenewedAt: integer('last_renewed_at', { mode: 'timestamp' }),
  absoluteExpiresAt: integer('absolute_expires_at', { mode: 'timestamp' }).notNull(),
  ```

**ë³€ê²½ 3: SQL DDL ì—…ë°ì´íŠ¸**
- CREATE TABLE sessionsì— 4ê°œ ì»¬ëŸ¼ ì¶”ê°€

**ë³€ê²½ 4: ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ì¶”ê°€**
- ê¸°ì¡´ v0.5 ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¹ì…˜(19-02ì—ì„œ ì¶”ê°€ë¨)ì— Phase 20 ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ ì¶”ê°€:
  ```sql
  -- Phase 20: ì„¸ì…˜ ê°±ì‹  ì»¬ëŸ¼ ì¶”ê°€
  ALTER TABLE sessions ADD COLUMN renewal_count INTEGER NOT NULL DEFAULT 0;
  ALTER TABLE sessions ADD COLUMN max_renewals INTEGER NOT NULL DEFAULT 30;
  ALTER TABLE sessions ADD COLUMN last_renewed_at INTEGER;
  ALTER TABLE sessions ADD COLUMN absolute_expires_at INTEGER NOT NULL DEFAULT 0;
  -- absolute_expires_at ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸° (created_at + 30ì¼)
  UPDATE sessions SET absolute_expires_at = created_at + 2592000 WHERE absolute_expires_at = 0;
  ```

**ë³€ê²½ 5: ERD ì—…ë°ì´íŠ¸**
- sessions í…Œì´ë¸” ERDì— 4ê°œ ì»¬ëŸ¼ ì¶”ê°€

**ì£¼ì˜ì‚¬í•­:**
- 19-02ì—ì„œ ì¶”ê°€í•œ agents.owner_address, wallet_connections ë³€ê²½ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
- íƒ€ì„ìŠ¤íƒ¬í”„ëŠ” INTEGER (Unix epoch ì´ˆ) -- CORE-02 í‘œì¤€ ì¤€ìˆ˜
- absolute_expires_atëŠ” ì„¸ì…˜ ìƒì„± ì‹œ ê³„ì‚°í•˜ì—¬ ì €ì¥ (config ë³€ê²½ì´ ê¸°ì¡´ ì„¸ì…˜ì— ì†Œê¸‰ ì ìš©ë˜ì§€ ì•Šë„ë¡)
  </action>
  <verify>
ë¬¸ì„œ ë‚´ìš© í™•ì¸:
- "renewal_count" ì»¬ëŸ¼ì´ sessions í…Œì´ë¸”ì— ì¡´ì¬
- "max_renewals" ì»¬ëŸ¼ì´ sessions í…Œì´ë¸”ì— ì¡´ì¬
- "last_renewed_at" ì»¬ëŸ¼ì´ sessions í…Œì´ë¸”ì— ì¡´ì¬
- "absolute_expires_at" ì»¬ëŸ¼ì´ sessions í…Œì´ë¸”ì— ì¡´ì¬
- Drizzle ORM ì •ì˜ì— 4ê°œ ì»¬ëŸ¼ í¬í•¨
- ë§ˆì´ê·¸ë ˆì´ì…˜ SQLì— ALTER TABLE ADD COLUMN 4ê°œ í¬í•¨
- ê¸°ì¡´ agents.owner_address ë³€ê²½ ìœ ì§€ë¨
  </verify>
  <done>
25-sqlite-schema.mdì˜ sessions í…Œì´ë¸”ì— renewal_count, max_renewals, last_renewed_at, absolute_expires_at 4ê°œ ì»¬ëŸ¼ì´ ì¶”ê°€ë˜ì–´ ìˆê³ , Drizzle ORM ì •ì˜/SQL DDL/ë§ˆì´ê·¸ë ˆì´ì…˜ SQLì´ ëª¨ë‘ ì—…ë°ì´íŠ¸ë˜ì–´ ìˆë‹¤.
  </done>
</task>

<task type="auto">
  <name>Task 2: 37-rest-api-complete-spec.md ê°±ì‹  ì—”ë“œí¬ì¸íŠ¸ + 35-notification-architecture.md ì•Œë¦¼ ì´ë²¤íŠ¸ ì¶”ê°€</name>
  <files>
.planning/deliverables/37-rest-api-complete-spec.md
.planning/deliverables/35-notification-architecture.md
  </files>
  <action>
ë‘ ë¬¸ì„œì— ì„¸ì…˜ ê°±ì‹  ê´€ë ¨ ë³€ê²½ì„ ë°˜ì˜í•œë‹¤. 19-03ì—ì„œ ì ìš©í•œ íŒ¨í„´ì„ ë”°ë¼ ê¸°ì¡´ êµ¬ì¡° ìœ ì§€.

**=== 37-rest-api-complete-spec.md ë³€ê²½ ===**

**ë³€ê²½ 1: ì „ì²´ ì—”ë“œí¬ì¸íŠ¸ ìš”ì•½ í…Œì´ë¸” ì—…ë°ì´íŠ¸**
- ê¸°ì¡´ 31ê°œì—ì„œ 32ê°œë¡œ ì—…ë°ì´íŠ¸ (PUT /v1/sessions/:id/renew ì¶”ê°€)
- Session API ì¹´í…Œê³ ë¦¬ì— ì¶”ê°€:
  | PUT | /v1/sessions/:id/renew | sessionAuth | ì„¸ì…˜ ê°±ì‹  (í† í° íšŒì „) |

**ë³€ê²½ 2: ì¸ì¦ ë§µ ì—…ë°ì´íŠ¸**
- ì„¹ì…˜ 3.4 ì¸ì¦ ë§µ í…Œì´ë¸”ì— ì¶”ê°€:
  | PUT /v1/sessions/:id/renew | sessionAuth | ì„¸ì…˜ ê°±ì‹  |

**ë³€ê²½ 3: ì—ëŸ¬ ì½”ë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸**
- SESSION ë„ë©”ì¸ì— ê°±ì‹  ê´€ë ¨ ì—ëŸ¬ ì½”ë“œ 5ê°œ ì¶”ê°€ (ê¸°ì¡´ SESSION_* ì½”ë“œì™€ ë™ì¼ ë„ë©”ì¸):
  | SESSION_RENEWAL_LIMIT | 403 | ê°±ì‹  íšŸìˆ˜ í•œë„ ì´ˆê³¼ |
  | SESSION_ABSOLUTE_EXPIRED | 403 | ì„¸ì…˜ ì ˆëŒ€ ìˆ˜ëª… ì´ˆê³¼ |
  | SESSION_RENEWAL_TOO_EARLY | 403 | ê°±ì‹  ì‹œì  ë¯¸ë‹¬ (50% ê²½ê³¼ ì „) |
  | SESSION_RENEWAL_MISMATCH | 403 | ì„¸ì…˜ ID ë¶ˆì¼ì¹˜ (JWT sid != :id) |
  | SESSION_NOT_FOUND | 404 | ì„¸ì…˜ ì—†ìŒ |
- ì£¼ì˜: ì—ëŸ¬ ì½”ë“œëª…ì€ 53-session-renewal-protocol.mdì˜ ì •ì˜ì™€ ì •í™•íˆ ì¼ì¹˜ì‹œí‚¨ë‹¤. 53ì—ì„œ RENEWAL_LIMIT_REACHEDë¡œ ì •ì˜í–ˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©. 37 ë¬¸ì„œì˜ ê¸°ì¡´ ë„¤ì´ë° ì»¨ë²¤ì…˜(SESSION_* ì ‘ë‘ì‚¬)ê³¼ 53ì˜ ì—ëŸ¬ ì½”ë“œëª…ì„ í™•ì¸í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€.

**ë³€ê²½ 4: Session API ì„¹ì…˜ì— ê°±ì‹  ì—”ë“œí¬ì¸íŠ¸ ê°„ëµ ìŠ¤í™ ì¶”ê°€**
- 19-03ì—ì„œ "ì„¹ì…˜ 5-9ëŠ” Phase 21 ìœ„ì„" ê²°ì •ì„ ë”°ë¼, ê°„ëµ ìŠ¤í™ë§Œ ì¶”ê°€:
  - ì—”ë“œí¬ì¸íŠ¸: PUT /v1/sessions/:id/renew
  - ì¸ì¦: sessionAuth
  - ìš”ì²­: íŒŒë¼ë¯¸í„° id (UUID), ë°”ë”” ì—†ìŒ
  - ì‘ë‹µ: 200 (RenewSessionResponse), 401/403/404
  - ìƒì„¸: 53-session-renewal-protocol.md ì°¸ì¡°

**=== 35-notification-architecture.md ë³€ê²½ ===**

**ë³€ê²½ 5: NotificationEventType í™•ì¥**
- ê¸°ì¡´ 13ê°œ ì´ë²¤íŠ¸ì— 2ê°œ ì¶”ê°€ (Phase 20 ì¶”ê°€ ë§ˆí‚¹):
  | SESSION_RENEWED | INFO | ì„¸ì…˜ ê°±ì‹  ì™„ë£Œ |
  | SESSION_RENEWAL_REJECTED | WARNING | ì„¸ì…˜ ê°±ì‹  ê±°ë¶€(íê¸°) |

**ë³€ê²½ 6: ì´ë²¤íŠ¸ë³„ ì‹¬ê°ë„ ë§¤í•‘ í…Œì´ë¸” ì—…ë°ì´íŠ¸**
- SESSION_RENEWED: INFO (ì •ë³´ì„±. ê°±ì‹  ì„±ê³µ ì•Œë¦¼.)
- SESSION_RENEWAL_REJECTED: WARNING (ì£¼ì˜. Ownerê°€ ì„¸ì…˜ì„ íê¸°í•¨.)

**ë³€ê²½ 7: ì•Œë¦¼ í˜¸ì¶œ í¬ì¸íŠ¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸**
- 2ê±´ ì¶”ê°€:
  | ì„¸ì…˜ ê°±ì‹  ì„±ê³µ | session-renewal-service | SESSION_RENEWED | sessionId, agentName, renewalCount, maxRenewals, remainingAbsoluteLife, rejectWindowExpiry |
  | ì„¸ì…˜ ê°±ì‹  ê±°ë¶€ | session-service (DELETE) | SESSION_RENEWAL_REJECTED | sessionId, agentName, renewalCount, rejectedAt |

**ë³€ê²½ 8: ë©”ì‹œì§€ í…œí”Œë¦¿ ì¶”ê°€**
- SESSION_RENEWED í…œí”Œë¦¿:
  - Telegram MarkdownV2: "ğŸ”„ *ì„¸ì…˜ ê°±ì‹ *\nì—ì´ì „íŠ¸: {agentName}\nê°±ì‹  íšŸìˆ˜: {renewalCount}/{maxRenewals}\në‚¨ì€ ìˆ˜ëª…: {remainingAbsoluteLife}\nê±°ë¶€ ê°€ëŠ¥ ì‹œí•œ: {rejectWindowExpiry}"
  - Discord Embed: title="ì„¸ì…˜ ê°±ì‹ ", color=0x3498DB(blue)
  - ntfy.sh: priority=3 (default)
- SESSION_RENEWAL_REJECTED í…œí”Œë¦¿:
  - Telegram MarkdownV2: "â›” *ì„¸ì…˜ ê°±ì‹  ê±°ë¶€*\nì—ì´ì „íŠ¸: {agentName}\nê°±ì‹  íšŸìˆ˜: {renewalCount}\nê±°ë¶€ ì‹œê°: {rejectedAt}"
  - Discord Embed: title="ì„¸ì…˜ ê°±ì‹  ê±°ë¶€", color=0xE67E22(orange)
  - ntfy.sh: priority=4 (high)

**ì£¼ì˜ì‚¬í•­:**
- 37-rest-api-complete-spec.mdì˜ ì„¹ì…˜ 5-9 ì—”ë“œí¬ì¸íŠ¸ ìƒì„¸ëŠ” Phase 21 ìœ„ì„ (19-03 ê²°ì • D2 ìœ ì§€)
- 35-notification-architecture.mdì˜ ê¸°ì¡´ 13ê°œ ì´ë²¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- ì—ëŸ¬ ì½”ë“œëª…ì€ 53-session-renewal-protocol.mdì™€ ì •í™•íˆ ì¼ì¹˜
  </action>
  <verify>
37-rest-api-complete-spec.md í™•ì¸:
- "PUT /v1/sessions/:id/renew" ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬
- ì—ëŸ¬ ì½”ë“œ í…Œì´ë¸”ì— RENEWAL ê´€ë ¨ ì½”ë“œ ì¡´ì¬
- ì¸ì¦ ë§µì— ê°±ì‹  ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬

35-notification-architecture.md í™•ì¸:
- "SESSION_RENEWED" ì´ë²¤íŠ¸ ì¡´ì¬
- "SESSION_RENEWAL_REJECTED" ì´ë²¤íŠ¸ ì¡´ì¬
- ë©”ì‹œì§€ í…œí”Œë¦¿ì´ ì¶”ê°€ë¨
- ê¸°ì¡´ 13ê°œ ì´ë²¤íŠ¸ ìœ ì§€ë¨
  </verify>
  <done>
37-rest-api-complete-spec.mdì— PUT /v1/sessions/:id/renew ì—”ë“œí¬ì¸íŠ¸ì™€ ê°±ì‹  ì—ëŸ¬ ì½”ë“œê°€ ì¶”ê°€ë˜ì–´ ìˆê³ , 35-notification-architecture.mdì— SESSION_RENEWED/SESSION_RENEWAL_REJECTED ì´ë²¤íŠ¸ 2ì¢…ê³¼ ë©”ì‹œì§€ í…œí”Œë¦¿ì´ ì¶”ê°€ë˜ì–´ ìˆë‹¤.
  </done>
</task>

</tasks>

<verification>
1. 25-sqlite-schema.mdì— sessions.renewal_count, max_renewals, last_renewed_at, absolute_expires_at 4ê°œ ì»¬ëŸ¼ ì¡´ì¬
2. ë§ˆì´ê·¸ë ˆì´ì…˜ SQLì— ALTER TABLE ADD COLUMN 4ê°œ í¬í•¨
3. 37-rest-api-complete-spec.mdì— PUT /v1/sessions/:id/renew + ì¸ì¦ë§µ + ì—ëŸ¬ì½”ë“œ ì¡´ì¬
4. 35-notification-architecture.mdì— SESSION_RENEWED(INFO) + SESSION_RENEWAL_REJECTED(WARNING) ì¡´ì¬
5. 53-session-renewal-protocol.md ì°¸ì¡°ê°€ ê° ë¬¸ì„œì— ì¡´ì¬
6. 19-02/19-03ì—ì„œ ì¶”ê°€í•œ ë³€ê²½ì‚¬í•­(agents.owner_address ë“±)ì´ ìœ ì§€ë¨
</verification>

<success_criteria>
- SESS-03 (sessions í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ë³€ê²½) ì™„ì „ í•´ê²°
- SESS-01, SESS-05ê°€ ê¸°ì¡´ ì„¤ê³„ ë¬¸ì„œì— ì „íŒŒë˜ì–´ ë¬¸ì„œ ê°„ ì¼ê´€ì„± í™•ë³´
- 5ê°œ ë¬¸ì„œ(53, 30, 25, 37, 35) ì „ì²´ê°€ ì„¸ì…˜ ê°±ì‹  í”„ë¡œí† ì½œì— ëŒ€í•´ ì¼ê´€ëœ ì •ë³´ë¥¼ ì œê³µ
</success_criteria>

<output>
After completion, create `.planning/phases/20-session-renewal-protocol/20-02-SUMMARY.md`
</output>
