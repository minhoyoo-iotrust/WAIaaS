---
phase: 17-cicd-pipeline-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/v0.4/50-cicd-pipeline-coverage-gate.md
autonomous: true

must_haves:
  truths:
    - "4단계 파이프라인(매 커밋/매 PR/nightly/릴리스)의 실행 범위가 명확히 구분되어 각 단계에 포함되는 테스트 유형을 읽고 차이를 설명할 수 있다"
    - "GitHub Actions 워크플로우 4개 YAML + 1 composite action의 트리거, job 구성, needs 의존 관계가 시각화되어 있다"
    - "패키지별 커버리지 게이트 기준(Soft/Hard)과 CI 실패 조건이 정의되어 있고, 전환 메커니즘이 명시되어 있다"
    - "PR 커버리지 코멘트, HTML 리포트, JSON Summary 등 리포트 자동 생성 방식이 명시되어 있다"
    - "Phase 14~16의 모든 테스트 레벨/시나리오가 파이프라인 단계에 빠짐없이 매핑되어 있다"
  artifacts:
    - path: "docs/v0.4/50-cicd-pipeline-coverage-gate.md"
      provides: "CI/CD 파이프라인 설계 + 커버리지 게이트 전략 통합 문서"
      contains: "4단계 파이프라인, GitHub Actions 워크플로우, Job DAG, 커버리지 게이트, 리포트 생성"
  key_links:
    - from: "docs/v0.4/50-cicd-pipeline-coverage-gate.md"
      to: "docs/v0.4/41-test-levels-matrix-coverage.md"
      via: "TLVL-01 6개 테스트 레벨 실행 빈도 -> 파이프라인 4단계 매핑"
      pattern: "Stage 1.*Unit.*매 커밋"
    - from: "docs/v0.4/50-cicd-pipeline-coverage-gate.md"
      to: "docs/v0.4/48-blockchain-test-environment-strategy.md"
      via: "CHAIN-MOCK/E2E/DEVNET -> nightly/릴리스 파이프라인 단계 매핑"
      pattern: "local-validator.*nightly"
    - from: "docs/v0.4/50-cicd-pipeline-coverage-gate.md"
      to: "docs/v0.4/49-enum-config-consistency-verification.md"
      via: "ENUM-SSOT-DERIVE-CHAIN -> PR 단계 enum-verify job 매핑"
      pattern: "enum-verify.*tsc --noEmit"
---

<objective>
Phase 14~16에서 확정한 모든 테스트 전략(6개 레벨, 71건 보안 시나리오, 블록체인 3단계 환경, Enum SSoT 검증)을 GitHub Actions CI/CD 파이프라인으로 통합하는 설계 문서를 작성한다.

Purpose: 구현 단계에서 GitHub Actions 워크플로우 YAML을 바로 작성할 수 있는 수준의 상세 설계를 확정한다. 4단계 파이프라인 구조, 워크플로우 파일 구성, Job DAG, Turborepo 통합, 커버리지 게이트 Soft/Hard 전환 메커니즘, 리포트 자동 생성 방식을 한 문서에 통합한다.

Output: `docs/v0.4/50-cicd-pipeline-coverage-gate.md` (CI/CD 파이프라인 설계 + 커버리지 게이트 통합 문서)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 17 Research (CI/CD 파이프라인 설계 상세 조사)
@.planning/phases/17-cicd-pipeline-design/17-RESEARCH.md

# Phase 14~16 설계 문서 (테스트 레벨, 커버리지, 블록체인, Enum -- 파이프라인 매핑 원본)
@docs/v0.4/41-test-levels-matrix-coverage.md
@docs/v0.4/48-blockchain-test-environment-strategy.md
@docs/v0.4/49-enum-config-consistency-verification.md

# Phase 14~16 핵심 결정 참조 (Summary frontmatter의 decisions 필드)
@.planning/phases/14-test-foundation/14-01-SUMMARY.md
@.planning/phases/16-blockchain-consistency-verification/16-01-SUMMARY.md
@.planning/phases/16-blockchain-consistency-verification/16-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 4단계 파이프라인 구조 + GitHub Actions 워크플로우 설계 작성</name>
  <files>docs/v0.4/50-cicd-pipeline-coverage-gate.md</files>
  <action>
`docs/v0.4/50-cicd-pipeline-coverage-gate.md` 문서를 생성한다. 전체 목차는 아래와 같으며, Task 1에서는 섹션 1~6을 작성한다.

**문서 구조 (전체):**
1. 개요 및 설계 원칙
2. 4단계 파이프라인 구조 (Stage 1~4)
3. Phase 14~16 테스트 레벨 매핑표
4. GitHub Actions 워크플로우 파일 구조
5. Composite Action: 공통 Setup
6. 워크플로우별 상세 설계 (ci.yml / nightly.yml / release.yml / coverage-report.yml)
7. Job DAG 시각화
8. Turborepo 태스크 기반 실행 전략
9. 커버리지 게이트: Soft/Hard 전환 메커니즘
10. 커버리지 리포트 자동 생성 방식
11. 패키지별 커버리지 임계값 상세
12. Pitfalls 및 대응 전략
13. Phase 14~16 결정 사항 정합성 검증표

**섹션별 작성 가이드:**

섹션 1 (개요): v0.4 테스트 전략을 CI/CD로 통합하는 목적, "코드를 작성하지 않는 설계 문서" 성격 명시, Primary recommendation 1문장 (17-RESEARCH.md Summary 참조)

섹션 2 (4단계 파이프라인): 17-RESEARCH.md Pattern 1의 표를 기반으로 Stage 1~4를 상세 기술. 각 단계별로:
- 트리거 (push/PR/schedule/release)
- 포함 테스트 유형 (lint, typecheck, unit, integration, e2e, security, enum, chain, platform)
- 예상 실행 시간
- 실패 시 영향 (커밋 빌드 실패 / PR 머지 차단 / 이슈 알림 / 릴리스 차단)
- Turborepo --affected vs 전체 실행 구분

섹션 3 (매핑표): Phase 14 TLVL-01 6개 레벨 + Phase 15 Security + Phase 16 Chain/Enum을 파이프라인 Stage에 매핑하는 표. 17-RESEARCH.md의 "Phase 14~16 테스트 레벨과의 매핑" 표를 확장하여, 실행 조건(PR only, nightly only 등)을 명확히 기재. 아래 레벨 포함 필수:
  - Unit -> Stage 1 (매 커밋)
  - Integration -> Stage 2 (매 PR)
  - E2E -> Stage 2 (매 PR)
  - Security -> Stage 2 (매 PR)
  - Enum Verification -> Stage 2 (매 PR, tsc --noEmit + Enum 테스트)
  - Chain Integration (Mock RPC) -> Stage 1/2 (Unit/Integration에 포함, --affected)
  - Chain Integration (Local Validator) -> Stage 3 (nightly, solana-test-validator)
  - Chain Integration (Devnet) -> Stage 3 (nightly, max 3건, continue-on-error)
  - Platform (CLI/Docker) -> Stage 4 (릴리스)

섹션 4 (워크플로우 파일 구조): 17-RESEARCH.md Pattern 2의 `.github/` 디렉토리 구조를 그대로 채택. 4개 YAML + 1 composite action. 각 파일의 역할을 1-2문장으로 설명. coverage-report.yml 분리 이유(fork PR 보안)를 명시.

섹션 5 (Composite Action): 17-RESEARCH.md Pattern 3의 `.github/actions/setup/action.yml` 전체 YAML을 포함. inputs에 node-version(default: 22), steps에 pnpm/action-setup@v4 + actions/setup-node@v4(cache: pnpm) + pnpm install --frozen-lockfile + actions/cache@v4(.turbo 디렉토리).

섹션 6 (워크플로우별 상세): 4개 YAML 각각에 대해 17-RESEARCH.md Examples 1~5의 YAML 골격을 기반으로 작성. 단순 복사가 아닌, 아래 개선을 반영:
- **ci.yml**: push + pull_request 트리거 통합. concurrency group 포함. push 시 Stage 1만(lint, typecheck, unit-test). PR 시 Stage 1 + Stage 2(integration, e2e, security, enum-verify, coverage-gate). 각 job에 timeout-minutes 명시. `turbo run --affected` 사용. `--` 뒤에 Jest 플래그 전달 (--ci, --maxWorkers=75%, --runInBand, --forceExit 등 Phase 14 결정 반영). `actions/upload-artifact@v4`로 coverage 결과 업로드.
- **nightly.yml**: schedule(cron UTC 02:30) + workflow_dispatch. full-suite job(전체 패키지 Stage 1+2 실행, --affected 없음), local-validator job(metadaoproject/setup-solana + validator 시작 + health check 30초 + chain 테스트 + cleanup), devnet job(needs: local-validator, continue-on-error: true, max 3건, env WAIAAS_TEST_NETWORK=devnet).
- **release.yml**: release published + workflow_dispatch. full-test-suite(전체 패키지 모든 레벨), chain-integration(needs: full-test-suite, local-validator + devnet), platform-cli, platform-docker(docker build + health check), coverage-report(full coverage 생성).
- **coverage-report.yml**: pull_request 트리거. ArtiomTr/jest-coverage-report-action@v2로 핵심 3-4 패키지(core, daemon, adapter-solana, sdk) PR 코멘트. custom-title로 패키지 구분. 나머지 패키지는 콘솔 로그.

섹션 7 (Job DAG): 17-RESEARCH.md Pattern 5의 ASCII DAG를 포함. ci.yml(push 경로 / PR 경로), nightly.yml, release.yml 각각의 job 의존 관계를 `needs:` 기반으로 시각화. 병렬/순차 구간 명시.

섹션 8 (Turborepo): 17-RESEARCH.md Pattern 4의 turbo.json 태스크 정의를 포함. CI에서의 실행 명령어 4가지(Stage 1~4). `cache: false` 설정 이유(테스트 결과 캐싱 위험). `--affected`(push/PR) vs 전체(nightly/release) 사용 구분.

**반드시 준수할 이전 Phase 결정:**
- Phase 14: TLVL-01 실행 빈도, CI-GATE Soft/Hard, Jest 30 + @swc/jest, turbo.json typecheck task
- Phase 14: --maxWorkers=75%(Unit/Security), --runInBand(Integration), --forceExit(E2E)
- Phase 15: Security 테스트 매 PR
- Phase 16: CHAIN-MOCK-13-SCENARIOS(Unit/Integration), CHAIN-E2E-5-FLOWS(nightly local-validator), CHAIN-DEVNET-LIMIT-3(nightly, max 3), ENUM-SSOT-DERIVE-CHAIN(tsc --noEmit), CONFIG-UNIT-TEST(Unit)

**작성 언어:** 한글 (코드/YAML/기술 용어는 영어 유지)
  </action>
  <verify>
파일 존재 확인: `ls docs/v0.4/50-cicd-pipeline-coverage-gate.md`
섹션 1~8 존재 확인: `grep -c "^##" docs/v0.4/50-cicd-pipeline-coverage-gate.md` >= 8
4단계 파이프라인 표 존재: `grep "Stage 1" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
ci.yml YAML 블록 존재: `grep "ci.yml" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
nightly.yml YAML 블록 존재: `grep "nightly.yml" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
release.yml YAML 블록 존재: `grep "release.yml" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
composite action YAML 존재: `grep "composite" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
Job DAG ASCII 존재: `grep "needs" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
turbo.json 태스크 존재: `grep "turbo.json" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
Phase 14 매핑 존재: `grep "TLVL-01" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
Phase 16 매핑 존재: `grep "CHAIN-MOCK-13" docs/v0.4/50-cicd-pipeline-coverage-gate.md` 또는 `grep "local-validator" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
  </verify>
  <done>
- 4단계 파이프라인(Stage 1~4)의 트리거, 테스트 유형, 예상 시간, 실패 영향이 표로 정리됨
- Phase 14~16 테스트 레벨이 파이프라인 Stage에 빠짐없이 매핑됨
- GitHub Actions 4개 YAML + 1 composite action의 상세 설계가 YAML 골격과 함께 기술됨
- 각 워크플로우의 Job DAG가 ASCII로 시각화되고 병렬/순차 구간이 명확함
- Turborepo turbo.json 태스크 정의와 CI 실행 명령어가 Stage별로 명시됨
  </done>
</task>

<task type="auto">
  <name>Task 2: 커버리지 게이트 + 리포트 자동 생성 + Pitfalls + 정합성 검증표 작성</name>
  <files>docs/v0.4/50-cicd-pipeline-coverage-gate.md</files>
  <action>
Task 1에서 작성한 `docs/v0.4/50-cicd-pipeline-coverage-gate.md`의 섹션 9~13을 이어서 작성한다.

**섹션 9 (커버리지 게이트: Soft/Hard 전환):**
- Soft Gate vs Hard Gate 비교표 (17-RESEARCH.md "Soft Gate vs Hard Gate 구현 상세" 표 기반)
  - Jest coverageThreshold 활성화 상태, CI exit code 처리(`|| true` vs 그대로), PR 코멘트 차이, 전환 방식, 전환 기준, 롤백 방법
- `scripts/coverage-gate.sh` 스크립트 전체 (17-RESEARCH.md Example 3 기반)
  - COVERAGE_GATE_MODE 환경변수(soft|hard, 기본 soft)
  - Hard 모드: exit code 전달 + `::error::` annotation
  - Soft 모드: `|| true` + `::warning::` annotation
- jest.config.ts 루트의 coverageThreshold 구조 (Phase 14 41-doc 기준)
  - global: { branches: 70, functions: 70, lines: 70, statements: 70 }
  - 패키지/모듈별 glob 패턴 임계값 (41-doc 섹션 3.4 전체 참조)
  - Soft Gate 시 주석 처리 방법, Hard Gate 전환 시 주석 해제 방법
  - 패키지별 독립 전환 방법 (특정 glob 패턴만 활성화)

**섹션 10 (커버리지 리포트 자동 생성):**
- 리포트 유형 4가지 표 (17-RESEARCH.md 리포트 유형 표 기반): PR 코멘트, HTML 리포트, JSON Summary, 콘솔 텍스트
- 각 리포트의 생성 위치 (어떤 job에서), 형식, 용도
- Jest coverageReporters 설정: ['text', 'json-summary', 'html', 'lcov']
- collectCoverageFrom 패턴 (src/**/*.ts, 제외: .d.ts, index.ts, testing/**, __tests__/**)
- ArtiomTr/jest-coverage-report-action 설정 상세:
  - 핵심 패키지만 대상 (core, daemon, adapter-solana, sdk)
  - custom-title로 패키지 구분
  - 나머지 패키지(adapter-evm, cli, mcp)는 콘솔 텍스트 리포트로 충분
- actions/upload-artifact@v4로 coverage/ 디렉토리 업로드 (retention-days: 14)

**섹션 11 (패키지별 커버리지 임계값 상세):**
- Phase 14 41-doc의 커버리지 목표를 jest.config.ts coverageThreshold glob 패턴 형태로 변환한 전체 표:
  - @waiaas/core: 90%+ (Critical)
  - @waiaas/daemon 서브모듈: keystore 95%+, session/policy/tx 90%+, middleware 85%+, routes/db/notifications 80%+, lifecycle 75%+
  - @waiaas/adapter-solana: 80%+ (High)
  - @waiaas/adapter-evm: 50%+ (Low)
  - @waiaas/cli: 70%+ (Normal)
  - @waiaas/sdk: 80%+ (High)
  - @waiaas/mcp: 70%+ (Normal)
- 각 패키지의 Soft -> Hard 전환 우선순위 제안: core(1순위) -> daemon/keystore(2순위) -> adapter-solana/sdk(3순위) -> 나머지(4순위)

**섹션 12 (Pitfalls 및 대응 전략):**
17-RESEARCH.md의 6 Pitfalls를 표 형태로 정리. 각 항목:
  - Pitfall 이름
  - 발생 조건
  - 대응 전략 (1-2문장)
  - Warning sign
추가 포함: CI 시간 초과, Devnet rate limit, fork PR 권한, Soft/Hard 전환 시점

**섹션 13 (Phase 14~16 결정 사항 정합성 검증표):**
17-RESEARCH.md의 "Phase 14~16 결정 사항과의 정합성 매핑" 3개 표를 통합하여, 결정 ID + 결정 내용 + CI 매핑 + 구현 방식 열로 구성된 단일 검증표 작성. Phase 14(7건), Phase 15(2건), Phase 16(5건) = 총 14건의 결정이 빠짐없이 매핑되었는지 확인.

**작성 언어:** 한글 (코드/YAML/기술 용어는 영어 유지)
  </action>
  <verify>
섹션 9~13 존재 확인: `grep -c "^##" docs/v0.4/50-cicd-pipeline-coverage-gate.md` >= 13
커버리지 게이트 표 존재: `grep "Soft Gate" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
coverage-gate.sh 코드 존재: `grep "COVERAGE_GATE_MODE" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
coverageThreshold 코드 존재: `grep "coverageThreshold" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
패키지별 임계값 존재: `grep "@waiaas/core" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
ArtiomTr action 존재: `grep "ArtiomTr" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
Pitfalls 섹션 존재: `grep -i "pitfall" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
정합성 검증표 존재: `grep "TLVL-01" docs/v0.4/50-cicd-pipeline-coverage-gate.md` AND `grep "CHAIN-DEVNET-LIMIT-3" docs/v0.4/50-cicd-pipeline-coverage-gate.md`
전체 문서 분량: `wc -l docs/v0.4/50-cicd-pipeline-coverage-gate.md` > 300 lines
  </verify>
  <done>
- Soft/Hard 커버리지 게이트 비교표와 전환 메커니즘(scripts/coverage-gate.sh + jest.config.ts)이 구현 가능한 수준으로 상세 기술됨
- 4가지 리포트 유형(PR 코멘트/HTML/JSON/텍스트)의 생성 위치와 방식이 명시됨
- 패키지별 커버리지 임계값이 jest.config.ts glob 패턴으로 변환되어 있고 전환 우선순위가 제안됨
- 6개 Pitfalls의 발생 조건과 대응 전략이 표로 정리됨
- Phase 14~16 결정 14건이 CI 파이프라인에 빠짐없이 매핑된 정합성 검증표가 존재함
  </done>
</task>

</tasks>

<verification>
전체 Phase 17 검증:
1. `docs/v0.4/50-cicd-pipeline-coverage-gate.md` 파일이 존재하고 섹션 1~13을 포함한다
2. 4단계 파이프라인 표에서 Stage 1~4의 트리거, 테스트 유형, 실행 시간, 실패 영향이 명확하다
3. GitHub Actions 4개 YAML(ci.yml, nightly.yml, release.yml, coverage-report.yml) + 1 composite action 설계가 YAML 골격과 함께 제시된다
4. Job DAG가 ci.yml(push/PR), nightly.yml, release.yml 각각에 대해 ASCII로 시각화된다
5. Turborepo turbo.json 태스크 정의와 Stage별 CI 실행 명령어가 명시된다
6. Soft/Hard 커버리지 게이트 비교표, coverage-gate.sh 스크립트, jest.config.ts coverageThreshold가 포함된다
7. 4가지 리포트 유형과 ArtiomTr action 설정이 명시된다
8. 패키지별 커버리지 임계값 표와 Soft->Hard 전환 우선순위가 있다
9. 6개 Pitfalls와 대응 전략이 표로 있다
10. Phase 14~16 결정 14건의 정합성 검증표가 빠짐없이 작성된다

Requirements 매핑:
- CICD-01: 섹션 2 (4단계 파이프라인) + 섹션 3 (매핑표) + 섹션 8 (Turborepo)
- CICD-02: 섹션 4~7 (워크플로우 구조 + composite action + 상세 설계 + Job DAG)
- CICD-03: 섹션 9~11 (커버리지 게이트 + 리포트 + 패키지별 임계값)
</verification>

<success_criteria>
1. 4단계 파이프라인(매 커밋/매 PR/nightly/릴리스)의 실행 범위가 읽고 차이를 설명할 수 있는 수준으로 정리됨 (CICD-01)
2. GitHub Actions 워크플로우 4개 YAML + 1 composite action이 트리거/job/needs 관계와 함께 설계됨 (CICD-02)
3. 패키지별 커버리지 게이트(Soft/Hard)와 CI 실패 조건이 정의되고, 리포트 자동 생성 4가지 방식이 명시됨 (CICD-03)
4. Phase 14~16 결정 14건이 파이프라인에 빠짐없이 매핑된 정합성 검증표가 존재함
5. 구현 단계에서 워크플로우 YAML을 바로 작성할 수 있는 수준의 상세도가 확보됨
</success_criteria>

<output>
After completion, create `.planning/phases/17-cicd-pipeline-design/17-01-SUMMARY.md`
</output>
