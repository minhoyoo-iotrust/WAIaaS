---
phase: 192-system-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/__tests__/system.test.tsx
autonomous: true
requirements: [NEWPG-05, NEWPG-06, NEWPG-07, NEWPG-08, NEWPG-09]

must_haves:
  truths:
    - "System page renders all 6 sections (API Keys, Oracle, Display Currency, Rate Limit, Log Level, Danger Zone) after loading"
    - "Daemon settings form fields (log level, oracle threshold, rate limit) accept input and trigger dirty state"
    - "Save bar appears when dirty, Save calls apiPut with filtered system entries, Discard clears dirty"
    - "API Keys section shows loading state, empty state (returns null), list with Set/Change/Delete buttons"
    - "API Key edit mode shows password input, Save calls apiPut, Cancel exits edit mode"
    - "API Key delete calls apiDelete and refreshes list"
    - "Shutdown Daemon button opens modal, confirm disabled until 'SHUTDOWN' typed, confirm calls apiPost"
  artifacts:
    - path: "packages/admin/src/__tests__/system.test.tsx"
      provides: "Full system.tsx page test suite"
      min_lines: 500
  key_links:
    - from: "packages/admin/src/__tests__/system.test.tsx"
      to: "packages/admin/src/pages/system.tsx"
      via: "import SystemPage"
      pattern: "import SystemPage from.*pages/system"
    - from: "packages/admin/src/__tests__/system.test.tsx"
      to: "apiGet, apiPut, apiPost, apiDelete"
      via: "vi.mock('../api/client')"
      pattern: "vi\\.mock\\(.*api/client"
---

<objective>
system.tsx 페이지의 모든 섹션(API Keys, Oracle, Display Currency, Global IP Rate Limit, Log Level, Danger Zone) 전체가 테스트로 검증된 상태 달성.

Purpose: v2.3 Admin UI 메뉴 재구성으로 신설된 system.tsx의 테스트 커버리지를 확보하여 v2.4.1 마일스톤의 70% 커버리지 목표 달성에 기여한다.
Output: packages/admin/src/__tests__/system.test.tsx (약 25-30 테스트)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/191-security-walletconnect-tests/191-01-SUMMARY.md
@packages/admin/src/pages/system.tsx
@packages/admin/src/__tests__/security.test.tsx
@packages/admin/src/__tests__/walletconnect.test.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/utils/settings-helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: system.tsx 렌더링 + 설정 폼 + dirty tracking 테스트</name>
  <files>packages/admin/src/__tests__/system.test.tsx</files>
  <action>
system.test.tsx 파일을 생성한다. security.test.tsx와 동일한 mock 패턴을 따른다.

**Mock 설정 (파일 상단, vi.mock 호출):**
- `../api/client` — apiGet, apiPost, apiPut, apiDelete, ApiError (walletconnect.test.tsx 패턴과 동일, apiDelete 포함)
- `../components/toast` — showToast, ToastContainer
- `../auth/store` — masterPassword, isAuthenticated, adminTimeout, daemonShutdown, login, logout, resetInactivityTimer
- `../utils/error-messages` — getErrorMessage: (code) => `Error: ${code}`
- `../components/settings-search` — pendingNavigation: { value: null }, highlightField: { value: '' }
- `../utils/dirty-guard` — registerDirty: vi.fn(), unregisterDirty: vi.fn()
- `../components/currency-select` — CurrencySelect를 간단한 select element로 mock (name, value, onChange props를 받아 select 렌더링). 패턴: `CurrencySelect: ({ name, value, onChange }: any) => <select name={name} value={value} onChange={(e: any) => onChange(e.target.value)}><option value="USD">USD</option><option value="KRW">KRW</option></select>`

**Mock 데이터:**
```typescript
const mockSettingsResponse = {
  daemon: { log_level: 'info' },
  oracle: { cross_validation_threshold: '5' },
  display: { currency: 'USD' },
  security: { rate_limit_global_ip_rpm: '1000' },
};

const mockApiKeys = {
  keys: [
    { providerName: 'coingecko', hasKey: true, maskedKey: 'CG-****abc', requiresApiKey: false, updatedAt: '2026-01-01' },
    { providerName: 'openai', hasKey: false, maskedKey: null, requiresApiKey: true, updatedAt: null },
  ],
};
```

**Helper 함수:**
mockApiCalls(settingsData?, apiKeysData?) — apiGet를 mockImplementation하여:
- path가 '/v1/admin/settings'이면 settingsData 반환
- path가 '/v1/admin/api-keys'이면 apiKeysData 반환
- 그 외 {} 반환

**describe('SystemPage')** 내부에 다음 테스트 그룹 작성:

**describe('rendering')** (NEWPG-05):
1. `shows loading state initially` — render 직후 'Loading settings...' 텍스트 확인
2. `renders all 6 sections after loading` — waitFor 후 'API Keys', 'Oracle', 'Display Currency', 'Global IP Rate Limit', 'Log Level', 'Danger Zone' 헤딩 확인
3. `registers dirty guard on mount` — registerDirty가 id 'system-settings'로 호출되었는지 확인
4. `unregisters dirty guard on unmount` — unmount 후 unregisterDirty('system-settings') 호출 확인

**describe('Daemon settings form')** (NEWPG-06, NEWPG-08):
5. `renders log level select with current value` — waitFor 후 name="daemon.log_level" select가 'info' 값인지 확인
6. `renders oracle threshold field` — name="oracle.cross_validation_threshold" input이 존재하고 값이 5인지 확인
7. `renders rate limit field` — name="security.rate_limit_global_ip_rpm" input이 존재하고 값이 1000인지 확인
8. `renders display currency select` — name="display.currency" select가 'USD' 값인지 확인
9. `changing log level shows save bar` — log_level select를 'debug'로 변경 후 'unsaved change' 텍스트 확인 (save bar 표시). fireEvent.change로 select 변경. 주의: FormField의 onChange는 value를 직접 전달하므로, fireEvent.change(select, { target: { value: 'debug' } })로 변경
10. `changing oracle threshold shows save bar` — oracle threshold input 변경 후 save bar 확인

**describe('save and discard')** (NEWPG-07):
11. `save calls apiPut with filtered system entries` — 필드 변경 후 Save 버튼 클릭, apiPut이 '/v1/admin/settings'로 호출되고 entries에 system 관련 키만 포함되는지 확인. apiPut.mock 검증 시 첫 번째 인자가 '/v1/admin/settings', 두 번째 인자의 settings 배열에 변경한 키가 포함되는지 확인
12. `save success shows toast and clears dirty` — apiPut 성공 후 showToast('success', ...) 호출 확인, save bar 사라짐 확인
13. `save error shows error toast` — apiPut이 ApiError를 throw하도록 mockRejectedValueOnce 설정, Save 클릭 후 showToast('error', ...) 확인
14. `discard clears save bar` — 필드 변경 후 Discard 클릭, save bar 사라짐 확인

**describe('settings fetch error')** (NEWPG-06):
15. `shows error toast on settings fetch failure` — apiGet이 settings 요청에서 ApiError throw하도록 설정, 렌더 후 showToast('error', ...) 확인

각 테스트에서 afterEach(cleanup) 호출. vi.mocked() 패턴으로 mock 타입 안전하게 사용.
  </action>
  <verify>
`pnpm --filter @waiaas/admin test:unit -- --testPathPattern=system.test` 실행하여 Task 1의 ~15개 테스트 전부 통과 확인.
  </verify>
  <done>
렌더링(로딩/6섹션), dirty guard 등록/해제, 4개 설정 폼 필드 값 렌더링, dirty tracking(save bar 표시), save/discard 흐름, fetch 에러 처리가 모두 테스트로 검증된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: API Keys CRUD + Danger Zone 셧다운 테스트</name>
  <files>packages/admin/src/__tests__/system.test.tsx</files>
  <action>
Task 1에서 생성한 system.test.tsx 파일에 다음 describe 블록을 추가한다.

**describe('API Keys section')** (NEWPG-09):
16. `shows loading state for API keys` — apiGet이 api-keys에서 지연되도록 설정 (resolve하지 않거나, apiKeysLoading.value=true인 초기 상태). 'Loading API keys...' 텍스트 확인
17. `renders null when no API keys exist` — mockApiCalls에서 apiKeys를 { keys: [] }로 설정, 렌더 후 'API Keys' 헤딩이 없는지 확인 (queryByText 사용)
18. `renders API key list with provider names` — mockApiCalls에서 mockApiKeys 사용, waitFor 후 'coingecko', 'openai' 텍스트 확인
19. `shows maskedKey for providers with key` — 'CG-****abc' 텍스트 확인, 'Not set' 텍스트도 확인 (openai)
20. `shows Change button for provider with key, Set button for provider without key` — coingecko 행에 'Change' 버튼, openai 행에 'Set' 버튼 확인
21. `shows Delete button only for provider with key` — coingecko 행에 'Delete' 버튼 있음, openai는 Delete 버튼 없음 (getAllByText('Delete').length === 1)
22. `shows Required badge for provider that requires key but has none` — openai 행에 'Required' badge 텍스트 확인
23. `clicking Set opens edit mode with password input` — openai의 'Set' 버튼 클릭 후 password input과 'Save', 'Cancel' 버튼 확인
24. `save API key calls apiPut and refreshes list` — edit mode에서 input에 'new-key' 입력 후 Save 클릭, apiPut이 '/v1/admin/api-keys/openai'와 { apiKey: 'new-key' }로 호출 확인, showToast('success', ...) 확인, apiGet 재호출(fetchApiKeys) 확인
25. `cancel edit mode clears input and exits` — Cancel 클릭 후 edit mode 사라지고 원래 display로 돌아감 확인
26. `delete API key calls apiDelete and refreshes` — coingecko의 'Delete' 클릭, apiDelete가 '/v1/admin/api-keys/coingecko'로 호출 확인, showToast('success', ...) 확인
27. `API key save error shows toast` — apiPut가 ApiError throw하도록 설정, Save 클릭 후 showToast('error', ...) 확인
28. `API key delete error shows toast` — apiDelete가 ApiError throw하도록 설정, Delete 클릭 후 showToast('error', ...) 확인

**describe('Danger Zone - Shutdown')** (NEWPG-05):
29. `renders Shutdown Daemon button` — 'Shutdown Daemon' 버튼 확인
30. `clicking Shutdown Daemon opens confirmation modal` — 버튼 클릭 후 'Type' 텍스트 및 'SHUTDOWN' placeholder input 확인
31. `confirm button disabled until SHUTDOWN typed` — 모달 내 Shutdown confirm 버튼이 disabled, input에 'SHUTDOWN' 입력 후 enabled
32. `shutdown calls apiPost and shows overlay` — confirm 클릭 후 apiPost가 '/v1/admin/shutdown'로 호출 확인, 'Daemon is shutting down...' 텍스트 확인
33. `shutdown error shows toast` — apiPost가 ApiError throw, confirm 후 showToast('error', ...) 확인
34. `cancel modal closes it` — 모달 내 Cancel 버튼 클릭 후 모달 사라짐 확인

모달 테스트 시 참고: Modal 컴포넌트는 open=false이면 null 반환. confirmDisabled={shutdownConfirmText.value !== 'SHUTDOWN'}으로 confirm 버튼이 disabled 제어됨. Modal의 confirm 버튼은 confirmText="Shutdown"으로 렌더링됨.

Task 1에서 사용한 동일한 mock 설정과 helper를 재사용. 각 테스트 전후 cleanup, vi.clearAllMocks 또는 vi.mocked(...).mockClear() 호출.
  </action>
  <verify>
`pnpm --filter @waiaas/admin test:unit -- --testPathPattern=system.test` 실행하여 전체 ~34개 테스트 통과 확인. 추가로 `pnpm --filter @waiaas/admin test:unit` 전체 실행하여 기존 테스트에 regression 없음 확인.
  </verify>
  <done>
API Keys CRUD 전체 흐름(loading/empty/list/edit/save/cancel/delete + 에러 처리)과 Danger Zone 셧다운(모달 열기/확인 텍스트/실행/에러/취소)이 모두 테스트로 검증된다. system.tsx 페이지의 6개 섹션 전체가 테스트 커버리지를 확보한 상태.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin test:unit -- --testPathPattern=system.test` — system.test.tsx 전체 통과
2. `pnpm --filter @waiaas/admin test:unit` — 전체 admin 테스트 통과 (regression 없음)
3. system.test.tsx 파일이 500줄 이상이고 ~30개 이상 테스트 포함
</verification>

<success_criteria>
1. system.tsx 6개 섹션(API Keys, Oracle, Display Currency, Rate Limit, Log Level, Danger Zone) 모두 렌더링 테스트 통과
2. 설정 폼 입력/save/discard/에러 처리 테스트 통과
3. API Keys CRUD(Set/Change/Save/Cancel/Delete) 전체 흐름 테스트 통과
4. Shutdown 모달 double-confirmation 흐름 테스트 통과
5. dirty guard 등록/해제 테스트 통과
6. 전체 admin 테스트 suite에서 regression 없음
</success_criteria>

<output>
After completion, create `.planning/phases/192-system-tests/192-01-SUMMARY.md`
</output>
