---
phase: 184-settings-distribution
plan: 02
type: execute
wave: 2
depends_on: [184-01]
files_modified:
  - packages/admin/src/pages/sessions.tsx
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/pages/notifications.tsx
  - packages/admin/src/pages/security.tsx
autonomous: true
requirements: [DIST-04, DIST-05, DIST-06, TAB-06, FGRP-02, FGRP-03, FGRP-04, NEW-01]

must_haves:
  truths:
    - "Sessions > Settings 탭에서 Lifetime/Rate Limits 2개 FieldGroup으로 세션 설정을 변경/저장할 수 있다"
    - "Sessions > Settings 탭에 session_absolute_lifetime과 session_max_renewals가 신규 노출된다"
    - "Policies > Defaults 탭에서 Delay/Approval Timeout/Default Deny 토글을 변경/저장할 수 있다"
    - "Notifications > Settings 탭에서 Telegram/Other Channels 2개 FieldGroup으로 알림 설정을 변경/저장할 수 있다"
    - "Security > AutoStop Rules 탭에서 Activity Detection/Idle Detection FieldGroup이 적용된다"
    - "각 Settings 탭이 독립적인 dirty signal과 save bar를 보유한다"
  artifacts:
    - path: "packages/admin/src/pages/sessions.tsx"
      provides: "SessionSettingsTab with Lifetime and Rate Limits FieldGroups"
      contains: "function SessionSettingsTab"
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "PolicyDefaultsTab with delay/timeout/deny fields"
      contains: "function PolicyDefaultsTab"
    - path: "packages/admin/src/pages/notifications.tsx"
      provides: "NotificationSettingsTab with Telegram and Other Channels FieldGroups"
      contains: "function NotificationSettingsTab"
    - path: "packages/admin/src/pages/security.tsx"
      provides: "AutoStopTab with Activity Detection and Idle Detection FieldGroups"
      contains: "FieldGroup"
  key_links:
    - from: "sessions.tsx SessionSettingsTab"
      to: "API.ADMIN_SETTINGS"
      via: "apiGet/apiPut for settings fetch and save"
      pattern: "apiPut.*ADMIN_SETTINGS"
    - from: "policies.tsx PolicyDefaultsTab"
      to: "API.ADMIN_SETTINGS"
      via: "apiGet/apiPut for settings fetch and save"
      pattern: "apiPut.*ADMIN_SETTINGS"
    - from: "notifications.tsx NotificationSettingsTab"
      to: "API.ADMIN_SETTINGS"
      via: "apiGet/apiPut for settings fetch and save"
      pattern: "apiPut.*ADMIN_SETTINGS"
---

<objective>
Sessions/Policies/Notifications 페이지의 스텁 설정 탭을 실제 설정 컴포넌트로 교체하고, FieldGroup을 적용한다.

Purpose: 모든 설정이 기능별 맥락에서 변경 가능하고, 관련 필드가 의미 있게 그룹화된다.
Output: 4개 페이지에 설정 탭 구현 + FieldGroup 적용
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/184-settings-distribution/184-01-SUMMARY.md
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/pages/policies.tsx
@packages/admin/src/pages/notifications.tsx
@packages/admin/src/pages/security.tsx
@packages/admin/src/pages/settings.tsx — reference for SecuritySettings, NotificationSettings, TelegramBotSettings source JSX
@packages/admin/src/utils/settings-helpers.ts — has keyToLabel with session_absolute_lifetime and session_max_renewals labels (added in 184-01)
@packages/admin/src/components/field-group.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Sessions Settings tab + Policies Defaults tab</name>
  <files>packages/admin/src/pages/sessions.tsx, packages/admin/src/pages/policies.tsx</files>
  <action>
  **Sessions > Settings tab (sessions.tsx):**

  Add imports:
  - `import { apiPut } from '../api/client';`
  - `import { FormField } from '../components/form';`
  - `import { type SettingsData, keyToLabel, getEffectiveValue, getEffectiveBoolValue } from '../utils/settings-helpers';`
  - `import { FieldGroup } from '../components/field-group';`

  Create `SessionSettingsTab` component before `SessionsPage`:
  - Own signals: `settings = useSignal<SettingsData>({})`, `dirty = useSignal<Record<string, string>>({})`, `saving = useSignal(false)`, `loading = useSignal(true)`
  - `fetchSettings`, `handleFieldChange`, `handleSave` (filter dirty to `security.*` keys matching session-related fields only), `handleDiscard`
  - For handleSave, filter dirty entries where key matches one of: `security.session_ttl`, `security.max_sessions_per_wallet`, `security.max_pending_tx`, `security.rate_limit_session_rpm`, `security.rate_limit_tx_rpm`, `security.session_absolute_lifetime`, `security.session_max_renewals`
  - Two FieldGroups:

  ```
  <FieldGroup legend="Lifetime" description="Session duration and renewal limits">
    session_ttl (number, min 300)
    session_absolute_lifetime (number, min 0) — NEW-01
    session_max_renewals (number, min 0) — NEW-01
    max_sessions_per_wallet (number, min 1, max 100)
  </FieldGroup>

  <FieldGroup legend="Rate Limits" description="Request throttling per session and transaction">
    max_pending_tx (number, min 1, max 100)
    rate_limit_session_rpm (number, min 10)
    rate_limit_tx_rpm (number, min 1)
  </FieldGroup>
  ```

  - Wrap in settings-category container with header "Session Configuration" and description
  - Save bar and loading state same pattern as AutoStopTab
  - `dirtyCount`: filter by the specific session-related security keys listed above

  Replace the stub in SessionsPage:
  ```
  {activeTab.value === 'settings' && <SessionSettingsTab />}
  ```

  **Policies > Defaults tab (policies.tsx):**

  Add imports:
  - `import { type SettingsData, keyToLabel, getEffectiveValue, getEffectiveBoolValue } from '../utils/settings-helpers';`

  Create `PolicyDefaultsTab` component before `PoliciesPage`:
  - Own signals: settings, dirty, saving, loading
  - `fetchSettings`, `handleFieldChange`, `handleSave` (filter dirty to keys: `security.policy_defaults_delay_seconds`, `security.policy_defaults_approval_timeout`, `policy.default_deny_tokens`, `policy.default_deny_contracts`, `policy.default_deny_spenders`)
  - Fields layout:
    - `security.policy_defaults_delay_seconds` (number, min 0) -- label: "Policy Delay (seconds)"
    - `security.policy_defaults_approval_timeout` (number, min 60) -- label: "Approval Timeout (seconds)"
    - 3 checkboxes: `default_deny_tokens`, `default_deny_contracts`, `default_deny_spenders`
      - Note: these use `getEffectiveBoolValue(settings.value, dirty.value, 'security', key)` for reading
      - But dirty key uses `policy.default_deny_*` prefix for saving (matches settings.tsx pattern at lines 593-609)
  - Include info-box explaining default deny: "When enabled, transactions are denied if no matching whitelist policy exists."
  - Save bar pattern same as AutoStopTab
  - `dirtyCount`: count dirty keys matching the 5 policy-defaults keys

  Replace the stub in PoliciesPage:
  ```
  {activeTab.value === 'defaults' && <PolicyDefaultsTab />}
  ```
  </action>
  <verify>
  Run `pnpm turbo run typecheck --filter=@waiaas/admin` to confirm no type errors.
  Verify: `grep -c 'function SessionSettingsTab' packages/admin/src/pages/sessions.tsx` returns 1.
  Verify: `grep -c 'function PolicyDefaultsTab' packages/admin/src/pages/policies.tsx` returns 1.
  Verify: `grep -c 'FieldGroup' packages/admin/src/pages/sessions.tsx` returns at least 2 (Lifetime + Rate Limits).
  Verify stubs removed: `grep -c 'empty-state.*settings will be available' packages/admin/src/pages/sessions.tsx` returns 0.
  Verify stubs removed: `grep -c 'empty-state.*settings will be available' packages/admin/src/pages/policies.tsx` returns 0.
  </verify>
  <done>Sessions Settings tab has Lifetime and Rate Limits FieldGroups with 7 fields (including NEW-01 session_absolute_lifetime and session_max_renewals). Policies Defaults tab has delay/timeout numbers and 3 default deny checkboxes. Both have independent dirty/save state.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Notifications Settings tab + Security AutoStop FieldGroups</name>
  <files>packages/admin/src/pages/notifications.tsx, packages/admin/src/pages/security.tsx</files>
  <action>
  **Notifications > Settings tab (notifications.tsx):**

  Add imports:
  - `import { apiPut } from '../api/client';`
  - `import { FormField } from '../components/form';`
  - `import { type SettingsData, type NotifTestResult, keyToLabel, getEffectiveValue, getEffectiveBoolValue, isCredentialConfigured } from '../utils/settings-helpers';`
  - `import { FieldGroup } from '../components/field-group';`

  Create `NotificationSettingsTab` component before `NotificationsPage`:
  - Own signals: settings, dirty, saving, loading, notifTestResults (NotifTestResult[]), notifTesting (boolean)
  - `fetchSettings`, `handleFieldChange`, `handleSave` (filter dirty to `notifications.*` and `telegram.*` keys), `handleDiscard`
  - `handleNotifTest`: same as settings.tsx lines 205-223

  Two FieldGroups:

  ```
  <FieldGroup legend="Telegram" description="Telegram notification channel and bot configuration">
    notifications.enabled (checkbox, full width)
    notifications.telegram_bot_token (password)
    notifications.telegram_chat_id (text)
    notifications.locale (select: en/ko)
    -- Telegram Bot sub-section:
    telegram.enabled (select: Yes/No)
    telegram.bot_token (password)
    telegram.locale (select: en/ko)
  </FieldGroup>

  <FieldGroup legend="Other Channels" description="Discord, ntfy, Slack, and rate limiting">
    notifications.discord_webhook_url (password)
    notifications.ntfy_server (text)
    notifications.ntfy_topic (text)
    notifications.slack_webhook_url (password)
    notifications.rate_limit_rpm (number, min 1, max 1000)
  </FieldGroup>
  ```

  - After the FieldGroups, add a Test Notification button + results display (copy from settings.tsx lines 411-433)
  - Save bar pattern same as AutoStopTab
  - `dirtyCount`: count dirty keys starting with `notifications.` or `telegram.`

  Replace the stub in NotificationsPage:
  Change `activeTab.value === 'settings' ? <div class="empty-state">...` to `activeTab.value === 'settings' ? <NotificationSettingsTab />`

  Also update the config guidance text at bottom (line 344): change "Configure notification channels in Settings → Notifications section" to "Configure notification channels in the Settings tab above."

  **Security > AutoStop Rules tab FieldGroups (security.tsx):**

  Add import:
  - `import { FieldGroup } from '../components/field-group';`

  Modify `AutoStopTab` to wrap fields in FieldGroups. Current fields:
  - `enabled` (checkbox) -- keep outside groups, at top
  - `consecutive_failures_threshold` (number)
  - `unusual_activity_threshold` (number)
  - `unusual_activity_window_sec` (number)
  - `idle_timeout_sec` (number)
  - `idle_check_interval_sec` (number)

  Restructure the settings-fields-grid section inside settings-category-body:
  1. Keep `enabled` checkbox at top (outside FieldGroups, full width)
  2. Wrap in:
  ```
  <FieldGroup legend="Activity Detection" description="Detects failures and unusual transaction patterns">
    consecutive_failures_threshold
    unusual_activity_threshold
    unusual_activity_window_sec
  </FieldGroup>

  <FieldGroup legend="Idle Detection" description="Monitors inactivity and revokes idle sessions">
    idle_timeout_sec
    idle_check_interval_sec
  </FieldGroup>
  ```
  3. Keep the info-box after the FieldGroups
  4. Remove the outer `settings-fields-grid` div, let each FieldGroup contain its own fields in `field-group-body`. Inside each FieldGroup, wrap fields in a `settings-fields-grid` div for consistent layout.
  </action>
  <verify>
  Run `pnpm turbo run typecheck --filter=@waiaas/admin` to confirm no type errors.
  Run `pnpm turbo run lint --filter=@waiaas/admin` to confirm no lint errors.
  Verify: `grep -c 'function NotificationSettingsTab' packages/admin/src/pages/notifications.tsx` returns 1.
  Verify: `grep -c 'FieldGroup' packages/admin/src/pages/notifications.tsx` returns at least 2 (Telegram + Other Channels).
  Verify: `grep -c 'FieldGroup' packages/admin/src/pages/security.tsx` returns at least 2 (Activity Detection + Idle Detection).
  Verify stubs removed: `grep -c 'empty-state.*settings will be available' packages/admin/src/pages/notifications.tsx` returns 0.
  </verify>
  <done>Notifications Settings tab has Telegram and Other Channels FieldGroups with all notification/telegram fields and Test button. Security AutoStop tab has Activity Detection and Idle Detection FieldGroups. Both have independent dirty/save state. No stub placeholders remain in any page.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/admin` passes
2. `pnpm turbo run lint --filter=@waiaas/admin` passes
3. Sessions > Settings tab shows 2 FieldGroups (Lifetime, Rate Limits) with 7 fields including NEW-01
4. Policies > Defaults tab shows delay, timeout, and 3 default deny checkboxes
5. Notifications > Settings tab shows 2 FieldGroups (Telegram, Other Channels) with all notification fields
6. Security > AutoStop Rules tab shows 2 FieldGroups (Activity Detection, Idle Detection)
7. All settings tabs have independent dirty signals and save bars (TAB-06)
8. No stub placeholders remain: `grep -r 'settings will be available' packages/admin/src/pages/` returns 0 matches
</verification>

<success_criteria>
- Sessions, Policies, Notifications settings tabs all functional
- session_absolute_lifetime and session_max_renewals visible (NEW-01)
- FieldGroups applied to Sessions, Notifications, Security pages (FGRP-02, FGRP-03, FGRP-04)
- Each tab has independent dirty/save (TAB-06)
- No type/lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/184-settings-distribution/184-02-SUMMARY.md`
</output>
