---
phase: 184-settings-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/pages/wallets.tsx
  - packages/admin/src/utils/settings-helpers.ts
  - packages/admin/src/pages/system.tsx
autonomous: true
requirements: [DIST-01, DIST-02, DIST-03, NEW-02, NEW-03]

must_haves:
  truths:
    - "Wallets > RPC Endpoints 탭에서 Solana/EVM RPC URL을 변경하고 Test 버튼으로 테스트하고 Save할 수 있다"
    - "Wallets > Balance Monitoring 탭에서 enabled/interval/thresholds/cooldown를 변경하고 Save할 수 있다"
    - "Wallets > WalletConnect 탭에서 Project ID와 Relay URL을 변경하고 Save할 수 있다"
    - "각 Wallets 설정 탭이 독립적인 dirty signal과 save bar를 보유한다"
    - "System 페이지에 oracle.cross_validation_threshold가 노출되어 있다"
  artifacts:
    - path: "packages/admin/src/pages/wallets.tsx"
      provides: "RpcEndpointsTab, BalanceMonitoringTab, WalletConnectTab components"
      contains: "function RpcEndpointsTab"
    - path: "packages/admin/src/utils/settings-helpers.ts"
      provides: "relay_url label mapping"
      contains: "relay_url"
  key_links:
    - from: "wallets.tsx RpcEndpointsTab"
      to: "API.ADMIN_SETTINGS"
      via: "apiGet/apiPut for settings fetch and save"
      pattern: "apiPut.*ADMIN_SETTINGS"
    - from: "wallets.tsx RpcEndpointsTab"
      to: "API.ADMIN_SETTINGS_TEST_RPC"
      via: "apiPost for RPC endpoint testing"
      pattern: "apiPost.*ADMIN_SETTINGS_TEST_RPC"
---

<objective>
Wallets 페이지의 3개 스텁 탭(RPC Endpoints, Balance Monitoring, WalletConnect)을 실제 설정 컴포넌트로 교체한다.

Purpose: Wallets 맥락에서 RPC/모니터링/WalletConnect 설정을 직접 변경할 수 있게 한다.
Output: wallets.tsx에 3개 설정 탭 컴포넌트 추가, settings-helpers.ts에 relay_url 라벨 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/admin/src/pages/wallets.tsx
@packages/admin/src/pages/settings.tsx — reference for RpcField, RpcSettings, MonitoringSettings, WalletConnectSettings source JSX
@packages/admin/src/pages/security.tsx — reference for AutoStopTab pattern (independent signals, filtered save)
@packages/admin/src/utils/settings-helpers.ts
@packages/admin/src/components/field-group.tsx
@packages/admin/src/pages/system.tsx — verify NEW-03 already present
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add relay_url label to settings-helpers and verify NEW-03</name>
  <files>packages/admin/src/utils/settings-helpers.ts, packages/admin/src/pages/system.tsx</files>
  <action>
  1. In `settings-helpers.ts`, add label mappings to the `keyToLabel` map:
     - `relay_url: 'Relay URL'`
     - `session_absolute_lifetime: 'Absolute Lifetime (seconds)'`
     - `session_max_renewals: 'Max Renewals'`
     (These labels will be used by Plan 02 as well, but adding them here to keep settings-helpers changes in one place.)

  2. Verify that `system.tsx` OracleSection already renders `oracle.cross_validation_threshold` (it does at line 279-287). NEW-03 is already satisfied -- no changes needed to system.tsx.
  </action>
  <verify>
  Run `grep -n 'relay_url' packages/admin/src/utils/settings-helpers.ts` -- should show the new label.
  Run `grep -n 'cross_validation_threshold' packages/admin/src/pages/system.tsx` -- should show existing oracle field.
  </verify>
  <done>settings-helpers.ts contains relay_url, session_absolute_lifetime, session_max_renewals labels. system.tsx already exposes cross_validation_threshold (NEW-03 satisfied).</done>
</task>

<task type="auto">
  <name>Task 2: Implement RPC Endpoints, Balance Monitoring, WalletConnect tabs in wallets.tsx</name>
  <files>packages/admin/src/pages/wallets.tsx</files>
  <action>
  Add 3 tab components inside wallets.tsx, following the established AutoStopTab pattern from security.tsx (independent signals per tab, filtered dirty save).

  **Add imports** at top of wallets.tsx:
  - `import { apiPut } from '../api/client';` (already imported)
  - `import { type SettingsData, type RpcTestResult, keyToLabel, getEffectiveValue, getEffectiveBoolValue, isCredentialConfigured } from '../utils/settings-helpers';`
  - `import { FieldGroup } from '../components/field-group';`

  **1. RpcEndpointsTab component** (add before WalletListContent):
  - Own signals: `settings = useSignal<SettingsData>({})`, `dirty = useSignal<Record<string, string>>({})`, `saving = useSignal(false)`, `loading = useSignal(true)`, `rpcTestResults = useSignal<Record<string, RpcTestResult>>({})`, `rpcTesting = useSignal<Record<string, boolean>>({})`
  - `fetchSettings` fetches from `API.ADMIN_SETTINGS`
  - `handleFieldChange(fullKey, value)` updates dirty signal
  - `handleSave` filters dirty to `rpc.*` keys only, sends via `apiPut(API.ADMIN_SETTINGS, { settings: entries })`
  - `handleDiscard` clears dirty
  - `handleRpcTest(settingKey)` posts to `API.ADMIN_SETTINGS_TEST_RPC` with `{ url, chain }` (chain = settingKey contains 'solana' ? 'solana' : 'evm')
  - Inline `RpcField({ shortKey })` helper with FormField + Test button + result display (copy exact JSX from settings.tsx lines 443-479)
  - Render structure: save bar (if dirtyCount > 0) + settings-category with Solana subgroup and EVM subgroup + EVM Default Network select (copy from settings.tsx lines 504-542)
  - `solanaRpcKeys = ['solana_mainnet', 'solana_devnet', 'solana_testnet']`
  - `evmRpcKeys = ['evm_ethereum_mainnet', 'evm_ethereum_sepolia', 'evm_polygon_mainnet', 'evm_polygon_amoy', 'evm_arbitrum_mainnet', 'evm_arbitrum_sepolia', 'evm_optimism_mainnet', 'evm_optimism_sepolia', 'evm_base_mainnet', 'evm_base_sepolia']`
  - `evmNetworkOptions` same as settings.tsx lines 491-502
  - `dirtyCount = Object.keys(dirty.value).filter(k => k.startsWith('rpc.')).length`
  - Use `getEffectiveValue(settings.value, dirty.value, 'rpc', shortKey)` (pure function form)

  **2. BalanceMonitoringTab component**:
  - Own signals: settings, dirty, saving, loading
  - Same fetch/save/discard pattern, filter dirty to `monitoring.*` keys
  - Fields (copy from settings.tsx lines 911-917):
    - `enabled` (checkbox)
    - `check_interval_sec` (number, min 60, max 86400)
    - `low_balance_threshold_sol` (number, min 0)
    - `low_balance_threshold_eth` (number, min 0)
    - `cooldown_hours` (number, min 1, max 168)
  - Include the info-box from settings.tsx lines 955-959

  **3. WalletConnectTab component**:
  - Own signals: settings, dirty, saving, loading
  - Same fetch/save/discard pattern, filter dirty to `walletconnect.*` keys
  - Fields:
    - `project_id` (text, full width) -- existing field
    - `relay_url` (text, full width) -- NEW-02: new field `walletconnect.relay_url`
  - Include the info-box about cloud.walletconnect.com
  - Add a second info-box: "Relay URL defaults to wss://relay.walletconnect.com if not set."

  **4. Replace stubs in WalletListWithTabs**:
  Replace the 3 stub `<div class="empty-state">` blocks with:
  ```
  {activeTab.value === 'rpc' && <RpcEndpointsTab />}
  {activeTab.value === 'monitoring' && <BalanceMonitoringTab />}
  {activeTab.value === 'walletconnect' && <WalletConnectTab />}
  ```

  **Important patterns to follow:**
  - Use the pure-function form of helpers: `getEffectiveValue(settings.value, dirty.value, cat, key)` not the closure form from old settings.tsx
  - Each tab has its own `useEffect(() => { fetchSettings(); }, []);`
  - Save bar uses exact same CSS: `settings-save-bar`, `settings-save-bar-actions`
  - Save toast message: 'Settings saved and applied'
  </action>
  <verify>
  Run `pnpm turbo run typecheck --filter=@waiaas/admin` to confirm no type errors.
  Run `pnpm turbo run lint --filter=@waiaas/admin` to confirm no lint errors.
  Verify each tab component exists: `grep -c 'function RpcEndpointsTab\|function BalanceMonitoringTab\|function WalletConnectTab' packages/admin/src/pages/wallets.tsx` should return 3.
  Verify stubs removed: `grep -c 'empty-state.*settings will be available' packages/admin/src/pages/wallets.tsx` should return 0.
  </verify>
  <done>Wallets page has 3 functional settings tabs (RPC Endpoints with Test buttons, Balance Monitoring with 5 fields, WalletConnect with Project ID + Relay URL), each with independent dirty/save state. No stub placeholders remain.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/admin` passes
2. `pnpm turbo run lint --filter=@waiaas/admin` passes
3. Wallets page renders 4 tabs: Wallets, RPC Endpoints, Balance Monitoring, WalletConnect
4. Each settings tab loads settings from API, shows fields, tracks dirty changes independently, saves only its category
5. RPC tab has Test buttons for each endpoint
6. WalletConnect tab shows both Project ID and Relay URL (NEW-02)
7. System page shows oracle.cross_validation_threshold (NEW-03 pre-existing)
</verification>

<success_criteria>
- All 3 Wallets settings tabs functional with independent state
- RPC Test buttons work
- NEW-02 (relay_url) exposed in WalletConnect tab
- NEW-03 (cross_validation_threshold) verified present in System page
- No type/lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/184-settings-distribution/184-01-SUMMARY.md`
</output>
