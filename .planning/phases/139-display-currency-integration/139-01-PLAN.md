---
phase: 139-display-currency-integration
plan: "01"
type: execute
wave: 1
depends_on: ["138-02"]
files_modified:
  - packages/admin/src/pages/dashboard.tsx
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/utils/display-currency.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/notifications/templates/message-templates.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/pipeline/sign-only.ts
  - packages/daemon/src/api/routes/x402.ts
autonomous: true

must_haves:
  truths:
    - "Admin 대시보드 Recent Activity 테이블에서 amount 컬럼에 환산 금액이 표시된다"
    - "알림 메시지(TX_REQUESTED, TX_CONFIRMED, TX_SUBMITTED, TX_APPROVAL_REQUIRED, CUMULATIVE_LIMIT_WARNING)에 선택한 통화 환산 금액이 포함된다"
  artifacts:
    - path: "packages/admin/src/utils/display-currency.ts"
      provides: "Admin 환산 표시 유틸리티 (fetchDisplayCurrency, formatWithDisplay)"
      exports: ["fetchDisplayCurrency", "formatWithDisplay"]
    - path: "packages/admin/src/pages/dashboard.tsx"
      provides: "대시보드 환산 표시"
      contains: "formatWithDisplay"
    - path: "packages/daemon/src/notifications/templates/message-templates.ts"
      provides: "알림 메시지에 display_amount 변수 삽입"
      contains: "display_amount"
  key_links:
    - from: "packages/admin/src/pages/dashboard.tsx"
      to: "/v1/admin/status"
      via: "apiGet fetches amountUsd from status response"
      pattern: "amountUsd|amount_usd"
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "ForexRateService.getRate"
      via: "환산 금액을 notify vars에 추가"
      pattern: "display_amount"
    - from: "packages/daemon/src/notifications/templates/message-templates.ts"
      to: "packages/core/src/i18n/en.ts"
      via: "getNotificationMessage template interpolation"
      pattern: "display_amount"
---

<objective>
Admin UI 대시보드/트랜잭션 목록에서 환산 금액을 표시하고, 알림 메시지에 선택한 표시 통화로 환산된 금액을 포함한다.

Purpose: DISP-05 (Admin UI 환산 표시) + DISP-06 (알림 메시지 환산)을 달성하여 사용자가 선호하는 법정 통화로 금액을 확인할 수 있게 한다.
Output: Admin 환산 유틸리티, 대시보드/상태 응답 amountUsd 포함, 알림 메시지 display_amount 변수
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/138-forex-display-currency/138-01-SUMMARY.md
@.planning/phases/138-forex-display-currency/138-02-SUMMARY.md
@packages/core/src/utils/format-currency.ts
@packages/core/src/interfaces/forex-rate.types.ts
@packages/admin/src/pages/dashboard.tsx
@packages/admin/src/api/endpoints.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/notifications/templates/message-templates.ts
@packages/core/src/i18n/en.ts
@packages/core/src/i18n/ko.ts
@packages/daemon/src/pipeline/stages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin UI 환산 표시 (대시보드 + 상태 API amountUsd 포함)</name>
  <files>
    packages/admin/src/utils/display-currency.ts
    packages/admin/src/pages/dashboard.tsx
    packages/admin/src/api/endpoints.ts
    packages/daemon/src/api/routes/admin.ts
  </files>
  <action>
**1. Admin 환산 유틸리티 생성: `packages/admin/src/utils/display-currency.ts`**

Admin UI에서 환산 표시에 사용할 유틸리티를 생성한다. CSP 제약으로 daemon 코드를 import할 수 없으므로, Admin 내부에 독립적인 포매팅+fetch 로직을 둔다.

```typescript
// fetchDisplayCurrency(): GET /v1/admin/settings에서 display.currency 읽기
// -> 캐시: signal 또는 module-level 변수에 5분 캐시
// -> 반환: { currency: CurrencyCode, rate: number | null }
// -> USD일 경우 rate=1 즉시 반환 (forex API 미호출)
// -> USD 아닌 경우 GET /v1/admin/forex/rates?currencies={code}로 rate 조회
// -> 실패 시 null 반환 (graceful fallback)

// formatWithDisplay(amountUsd: number | null, currency: string, rate: number | null): string
// -> amountUsd가 null/undefined면 빈 문자열 반환
// -> rate가 null이면 amountUsd만 "$X.XX" 형식으로 반환 (USD fallback)
// -> 정상 시 formatDisplayCurrency(amountUsd, currency, rate) 호출
//    (core의 formatDisplayCurrency는 Intl.NumberFormat 기반, 138-01에서 구현됨)
// -> 주의: core의 formatDisplayCurrency를 직접 import할 수 없으므로 (CSP),
//    동일 로직을 인라인 구현한다. Intl.NumberFormat 사용, ZERO_DECIMAL/THREE_DECIMAL 세트 동일하게.
```

인라인 구현 시 `packages/core/src/utils/format-currency.ts`의 로직을 정확히 복제:
- ZERO_DECIMAL_CURRENCIES: KRW, JPY, VND, CLP, HUF, PKR
- THREE_DECIMAL_CURRENCIES: KWD, BHD
- USD면 접두사 없음, 비-USD면 "≈" 접두사
- en-US locale 통일

**2. GET /admin/status 응답에 amountUsd 추가: `packages/daemon/src/api/routes/admin.ts`**

`recentTransactions` 매핑(약 608행)에 `amountUsd` 필드를 추가한다.
transactions 테이블의 `amountUsd` 컬럼은 Phase 136에서 추가되었다 (schema.ts의 `amountUsd: real('amount_usd')`).

```typescript
// recentTxRows select에 transactions.amountUsd 추가
const recentTxRows = deps.db
  .select({
    // ... 기존 필드들 ...
    amountUsd: transactions.amountUsd,  // 추가
  })
  ...

// map에서 amountUsd 포함
const recentTransactions = recentTxRows.map((tx) => ({
  // ... 기존 필드들 ...
  amountUsd: tx.amountUsd ?? null,  // 추가
}));
```

동일하게 GET /admin/wallets/:id/transactions 응답(약 1226행)에도 amountUsd 추가:
```typescript
const items = rows.map((tx) => ({
  // ... 기존 필드들 ...
  amountUsd: tx.amountUsd ?? null,  // 추가
}));
```

**3. Admin 대시보드 환산 표시: `packages/admin/src/pages/dashboard.tsx`**

- RecentTransaction 인터페이스에 `amountUsd: number | null` 추가
- 컴포넌트 마운트 시 fetchDisplayCurrency() 호출하여 통화+환율 로드
- txColumns의 'Amount' 컬럼 render에서:
  - tx.amount가 있으면 기존 amount 표시 (예: "1000000")
  - tx.amountUsd가 있으면 괄호 안에 환산 금액 추가: `"1000000 (≈₩725,000)"`
  - amountUsd가 null이면 기존 amount만 표시 (Phase 136 이전 트랜잭션)
  - currency=USD면 "$500.00" 형식으로 표시 (≈ 없음)
- 환산 로직 실패 시 graceful fallback: amount만 표시
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/admin` -- 빌드 성공
2. `npx turbo build --filter=@waiaas/daemon` -- 빌드 성공
3. `npx turbo test --filter=@waiaas/daemon` -- 기존 테스트 통과 확인
4. Admin dashboard.tsx에 amountUsd 관련 렌더링 코드 존재 확인
5. admin.ts의 recentTransactions map에 amountUsd 필드 포함 확인
  </verify>
  <done>
- GET /admin/status의 recentTransactions[].amountUsd 필드가 존재한다
- GET /admin/wallets/:id/transactions의 items[].amountUsd 필드가 존재한다
- Admin 대시보드 Recent Activity 테이블이 amountUsd + display currency로 환산 금액을 표시하는 코드가 존재한다
- 빌드가 성공하고 기존 테스트가 통과한다
  </done>
</task>

<task type="auto">
  <name>Task 2: 알림 메시지에 환산 금액 포함</name>
  <files>
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/daemon/src/notifications/templates/message-templates.ts
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/pipeline/sign-only.ts
    packages/daemon/src/api/routes/x402.ts
  </files>
  <action>
**1. 알림 템플릿에 {display_amount} 변수 추가: `packages/core/src/i18n/en.ts`, `packages/core/src/i18n/ko.ts`**

amount가 포함된 이벤트 템플릿에 `{display_amount}` 변수를 추가한다. display_amount가 비어있으면 변수가 그대로 남지 않도록, 조건부 표시 패턴을 사용한다.

기존 template 시스템은 단순 `{var}` 치환이므로, display_amount가 빈 문자열이면 빈 문자열로 치환된다. 따라서 display_amount 변수를 항상 전달하되, 환산 불가 시 빈 문자열을 넣는다.

en.ts 변경:
```typescript
TX_REQUESTED: { title: 'Transaction Requested', body: 'Wallet {walletId} requested {amount} transfer to {to} {display_amount}' },
TX_CONFIRMED: { title: 'Transaction Confirmed', body: 'Transaction {txId} confirmed. Amount: {amount} {display_amount}' },
TX_SUBMITTED: { title: 'Transaction Submitted', body: 'Transaction {txId} submitted. Hash: {txHash} {display_amount}' },
TX_APPROVAL_REQUIRED: { title: 'Approval Required', body: 'Transaction {txId} requires owner approval. Amount: {amount} to {to} {display_amount}' },
TX_FAILED: { title: 'Transaction Failed', body: 'Transaction {txId} failed: {error} {display_amount}' },
CUMULATIVE_LIMIT_WARNING: { title: 'Cumulative Spending Warning', body: 'Wallet {walletId} {type} spending at {ratio}% of limit (${spent} / ${limit}) {display_amount}' },
```

ko.ts 변경: 동일한 이벤트에 {display_amount} 추가 (한국어 문맥에 맞게).

**주의:** TX_SUBMITTED에 기존 body에 txHash가 없고 txId만 있다. 기존 body를 유지하면서 `{display_amount}`만 끝에 추가한다. 기존 body를 수정하지 않도록 주의.

정확한 변경:
- TX_REQUESTED body: `'... to {to} {display_amount}'` (끝에 추가)
- TX_CONFIRMED body: `'... Amount: {amount} {display_amount}'` (끝에 추가)
- TX_SUBMITTED body: `'... submitted to blockchain {display_amount}'` (끝에 추가)
- TX_APPROVAL_REQUIRED body: `'... to {to} {display_amount}'` (끝에 추가)
- TX_FAILED body: `'... {error} {display_amount}'` (끝에 추가)
- CUMULATIVE_LIMIT_WARNING body: 기존 끝에 `{display_amount}` 추가

**2. getNotificationMessage trim 처리: `packages/daemon/src/notifications/templates/message-templates.ts`**

getNotificationMessage 반환 시 body를 `.trim()` 처리하여, display_amount가 빈 문자열일 때 후행 공백을 제거한다.

```typescript
return { title: title.trim(), body: body.trim() };
```

**3. 파이프라인에서 display_amount 계산 + notify vars에 추가: `packages/daemon/src/pipeline/stages.ts`**

PipelineContext에 forexRateService는 아직 없다. SettingsService와 ForexRateService를 통해 display_amount를 산출해야 한다.

접근: PipelineContext에 `forexRateService` optional 필드를 추가하지 않고, 기존 `settingsService`를 통해 display.currency를 읽고, 새로운 헬퍼 함수로 환산한다.

**방법 A (채택):** stages.ts 상단에 `resolveDisplayAmount` 헬퍼를 만든다:
```typescript
import type { IForexRateService } from '@waiaas/core';
import { formatDisplayCurrency } from '@waiaas/core';

async function resolveDisplayAmount(
  amountUsd: number | null | undefined,
  settingsService?: SettingsService,
  forexRateService?: IForexRateService,
): Promise<string> {
  if (!amountUsd || !settingsService || !forexRateService) return '';
  try {
    const currency = settingsService.get('display.currency') ?? 'USD';
    if (currency === 'USD') return `($${amountUsd.toFixed(2)})`;
    const rate = await forexRateService.getRate(currency as CurrencyCode);
    if (!rate) return `($${amountUsd.toFixed(2)})`;
    return `(${formatDisplayCurrency(amountUsd, currency, rate.rate)})`;
  } catch {
    return '';
  }
}
```

PipelineContext에 `forexRateService?: IForexRateService` 필드를 추가한다.

**트랜잭션 라우트에서 ctx.forexRateService 주입:**
`packages/daemon/src/api/routes/transactions.ts`의 TransactionRouteDeps에 `forexRateService?: IForexRateService` 추가. PipelineContext 빌드 시 `forexRateService: deps.forexRateService` 추가.

`packages/daemon/src/api/server.ts`에서 transactionRoutes deps에 forexRateService를 전달 (adminRoutes에는 이미 전달됨).

**각 notify 호출에 display_amount 추가:**

Stage 1 (TX_REQUESTED, 약 245행):
```typescript
const displayAmount = await resolveDisplayAmount(
  /* amountUsd는 Stage 3에서 기록되므로, Stage 1에서는 아직 없음 */
  undefined, ctx.settingsService, ctx.forexRateService,
);
// -> 빈 문자열 (OK, Stage 1에서는 아직 USD 환산이 안 됨)
```
실제로 Stage 1 시점에서 amountUsd는 아직 미산출이다. TX_REQUESTED 알림에는 display_amount를 빈 문자열로 보낸다. 이는 합리적이다 -- 아직 USD 환산이 완료되지 않은 시점이므로.

Stage 3 이후 (TX_APPROVAL_REQUIRED, CUMULATIVE_LIMIT_WARNING, 약 431-442행):
```typescript
// stage3Policy 내부에서 priceResult가 있으므로 amountUsd 사용 가능
const amountUsdForDisplay = priceResult?.effectiveAmountUsd ?? null;
const displayAmount = await resolveDisplayAmount(amountUsdForDisplay, ctx.settingsService, ctx.forexRateService);
// notify vars에 display_amount: displayAmount 추가
```

Stage 5 (TX_SUBMITTED, 약 696행):
```typescript
// tx DB에서 amountUsd를 읽어 환산
const txRow = await ctx.db.select({ amountUsd: transactions.amountUsd }).from(transactions).where(eq(transactions.id, ctx.txId)).get();
const displayAmount = await resolveDisplayAmount(txRow?.amountUsd ?? null, ctx.settingsService, ctx.forexRateService);
void ctx.notificationService?.notify('TX_SUBMITTED', ctx.walletId, {
  txHash: ctx.submitResult.txHash,
  amount: reqAmount,
  to: reqTo,
  display_amount: displayAmount,
}, { txId: ctx.txId });
```

Stage 6 (TX_CONFIRMED, TX_FAILED, 약 818-832행):
```typescript
// 동일 패턴: DB에서 amountUsd 조회 후 resolveDisplayAmount
```

**Stage 5/6에서 DB 추가 조회 최소화:** amountUsd는 Stage 3에서 기록되므로, Stage 5에 진입한 tx는 이미 amountUsd가 있다. 하지만 ctx에 저장하면 더 효율적. PipelineContext에 `amountUsd?: number` 필드를 추가하고, Stage 3에서 설정한다.

```typescript
// Stage 3에서:
ctx.amountUsd = priceResult?.effectiveAmountUsd ?? undefined;

// Stage 5/6에서:
const displayAmount = await resolveDisplayAmount(ctx.amountUsd ?? null, ctx.settingsService, ctx.forexRateService);
```

**TX_FAILED 알림 (retry 실패 등, 여러 곳):** 모든 TX_FAILED notify에 `display_amount: displayAmount` 추가. displayAmount는 ctx.amountUsd 기반.

**4. sign-only.ts에서 display_amount 추가: `packages/daemon/src/pipeline/sign-only.ts`**

sign-only pipeline의 TX_REQUESTED, TX_SUBMITTED 알림에도 display_amount를 빈 문자열로 추가한다 (sign-only는 amountUsd 산출 미지원이므로).

```typescript
void deps.notificationService?.notify('TX_REQUESTED', walletId, {
  amount: ..., to: ..., type: ...,
  display_amount: '',  // sign-only: no USD conversion
}, { txId });
```

**5. x402.ts에서 display_amount 추가: `packages/daemon/src/api/routes/x402.ts`**

x402 라우트의 모든 notify 호출에 `display_amount: ''`를 추가한다. x402 결제는 이미 USD 기반(EIP-3009)이므로 별도 환산이 불필요하지만, 템플릿 변수 일관성을 위해 빈 문자열을 전달한다.

**6. server.ts에서 transactionRoutes에 forexRateService 전달**

`packages/daemon/src/api/server.ts`의 CreateAppDeps에 forexRateService가 이미 있으므로 (138-02에서 추가), transactionRoutes 생성 시 `forexRateService: deps.forexRateService`를 전달한다.

TransactionRouteDeps에 `forexRateService?: IForexRateService` 추가.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build` -- 전체 빌드 성공
2. `npx turbo test --filter=@waiaas/core` -- i18n 테스트 통과 (template 변경이 Messages 타입과 일치)
3. `npx turbo test --filter=@waiaas/daemon` -- pipeline, notification 테스트 통과
4. stages.ts에 `resolveDisplayAmount` 함수와 `display_amount` 변수가 notify vars에 포함됨 확인
5. en.ts/ko.ts에 `{display_amount}` 플레이스홀더가 관련 이벤트에 추가됨 확인
6. `grep -r 'display_amount' packages/daemon/src/pipeline/` -- 결과 있음
  </verify>
  <done>
- 알림 메시지 템플릿(en/ko)에 {display_amount} 변수가 포함된다
- 파이프라인 Stage 3/5/6에서 amountUsd + forexRate 기반 display_amount가 산출되어 알림에 전달된다
- sign-only, x402 알림에도 display_amount 변수가 빈 문자열로 전달되어 템플릿 일관성이 유지된다
- 빌드 성공, 기존 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` -- 전체 모노레포 빌드 성공 (admin + daemon + core)
2. `npx turbo test` -- 전체 테스트 통과 (기존 실패 제외)
3. Admin 대시보드 코드에 amountUsd 기반 환산 표시 로직 존재
4. 알림 메시지에 display_amount 변수 포함 (빈 문자열 graceful fallback)
5. PipelineContext.forexRateService가 daemon에서 주입됨
</verification>

<success_criteria>
- DISP-05: Admin 대시보드 Recent Activity에 amountUsd 환산 표시 코드가 존재한다
- DISP-06: 알림 메시지 템플릿에 {display_amount}가 포함되고, pipeline에서 ForexRateService를 통해 환산 금액이 산출된다
- 빌드 성공, 기존 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/139-display-currency-integration/139-01-SUMMARY.md`
</output>
