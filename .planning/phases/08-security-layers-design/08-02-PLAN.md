---
phase: 08-security-layers-design
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - .planning/deliverables/34-owner-wallet-connection.md
autonomous: true

must_haves:
  truths:
    - "Owner 지갑 연결 플로우가 WalletConnect v2 QR 방식으로 설계되고, 시퀀스 다이어그램으로 문서화됨 (QR 생성 -> 스캔 -> 페어링 -> 세션 수립)"
    - "ownerAuth 미들웨어가 SIWS/SIWE 서명 검증 로직으로 코드 수준 설계됨 (Phase 7 owner-verifier 재사용)"
    - "Owner 전용 API 엔드포인트 5개가 Zod 요청/응답 스키마로 정의됨 (approve, reject, kill-switch, sessions, settings)"
    - "WalletConnect v2 세션 관리 (페어링, 세션 제안, 세션 유지, 재연결)가 상세 설계됨"
    - "Tauri WebView에서 Reown AppKit 모달을 통한 QR 표시 플로우가 설계됨"
    - "CLI waiaas owner connect 대안 경로 (터미널 QR 코드)가 설계됨"
  artifacts:
    - path: ".planning/deliverables/34-owner-wallet-connection.md"
      provides: "Owner 지갑 연결 프로토콜 전체 설계 -- WalletConnect v2, ownerAuth 미들웨어, Owner API 엔드포인트"
      contains: "ownerAuth"
  key_links:
    - from: "34-owner-wallet-connection.md"
      to: "30-session-token-protocol.md"
      via: "SIWS/SIWE 서명 검증 유틸리티(owner-verifier)를 ownerAuth 미들웨어에서 재사용"
      pattern: "verifySIWS.*verifySIWE"
    - from: "34-owner-wallet-connection.md"
      to: "33-time-lock-approval-mechanism.md"
      via: "APPROVAL 티어 승인 API(POST /v1/owner/approve/:txId)의 인증으로 ownerAuth 사용"
      pattern: "ownerAuth.*approve"
    - from: "34-owner-wallet-connection.md"
      to: "29-api-framework-design.md"
      via: "CORE-06 ownerAuth 라우트 레벨 미들웨어 stub을 Phase 8에서 완성"
      pattern: "ownerAuth.*middleware"
---

<objective>
Owner 지갑 연결 플로우를 완전히 설계한다 -- WalletConnect v2 (Reown) 기반 QR 연결 프로토콜, ownerAuth 미들웨어 상세 설계, Owner 전용 API 엔드포인트(approve, reject, kill-switch, settings), Tauri WebView와 CLI 양쪽 경로의 연결 플로우를 구현 가능한 수준으로 정의한다.

Purpose: Owner는 WAIaaS에서 유일한 인가 주체이다. Owner 지갑 연결은 세션 발급, 거래 승인, Kill Switch 발동, 설정 변경 등 모든 관리 작업의 인증 기반이다. Phase 7에서 정의한 SIWS/SIWE 검증 유틸리티를 ownerAuth 미들웨어로 확장하고, 08-01의 APPROVAL 티어가 사용하는 승인 API를 정의한다.
Output: 설계 문서 1개 -- 34-owner-wallet-connection.md (OWNR-01, OWNR-02, OWNR-03, API-05 충족)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-security-layers-design/08-RESEARCH.md

# 08-01 SUMMARY 참조 (직접 의존)
@.planning/phases/08-security-layers-design/08-01-SUMMARY.md

# Phase 7 참조
@.planning/deliverables/30-session-token-protocol.md (SESS-PROTO: SIWS/SIWE 검증 유틸리티, nonce 관리)
@.planning/deliverables/32-transaction-pipeline-api.md (TX-PIPE: Owner 인증 경로)

# Phase 6 참조
@.planning/deliverables/29-api-framework-design.md (CORE-06: ownerAuth stub, 미들웨어 체계)
@.planning/deliverables/24-monorepo-data-directory.md (CORE-01: config.toml [walletconnect] 섹션)
</context>

<tasks>

<task type="auto">
  <name>Task 1: WalletConnect v2 연결 프로토콜 + ownerAuth 미들웨어 설계</name>
  <files>.planning/deliverables/34-owner-wallet-connection.md</files>
  <action>
  설계 문서 `34-owner-wallet-connection.md`를 작성한다. 문서 ID는 `OWNR-CONN`.

  **섹션 1: 문서 개요 + 요구사항 매핑**
  - 문서 ID, 작성일, 상태, 참조 문서 (SESS-PROTO, TX-PIPE, CORE-06, CORE-01, LOCK-MECH)
  - 요구사항 매핑: OWNR-01 (브라우저 지갑), OWNR-02 (WalletConnect QR), OWNR-03 (서명 승인), API-05 (Owner 엔드포인트)
  - v0.1 -> v0.2 변경: OAuth/API Key 기반 관리 -> Owner 지갑 서명 기반 인가
  - Tauri WebView 제약사항: 브라우저 익스텐션 미지원 -> WalletConnect QR이 유일한 실용 경로

  **섹션 2: WalletConnect v2 아키텍처 개요**
  - WAIaaS 데몬은 dApp(요청자) 역할:
    - @reown/appkit (프론트엔드, Tauri WebView 내) -> QR 코드 표시
    - WalletConnect relay (wss://relay.walletconnect.com) 경유
    - Owner 모바일 지갑(Phantom/MetaMask) -> 서명 승인
  - projectId 관리:
    - config.toml [walletconnect] 섹션: projectId (필수)
    - waiaas init 시 Reown Cloud 발급 안내 메시지
    - 기본값 없음 (사용자 직접 발급)
  - 지원 네임스페이스:
    - Solana: solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp (mainnet), solana:4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z (devnet)
    - EVM (v0.3): eip155:1 (mainnet), eip155:11155111 (sepolia)
  - 지원 메서드:
    - Solana: solana_signMessage (SIWS 서명)
    - EVM: personal_sign (SIWE 서명)

  **섹션 3: Owner 지갑 연결 플로우 -- Tauri Desktop**
  - 전체 시퀀스 다이어그램 (Mermaid sequenceDiagram):
    참여자: OwnerUI(Tauri WebView), AppKit(@reown/appkit), Relay(WalletConnect), OwnerWallet(Phantom/MetaMask Mobile), Daemon(WAIaaS API)
    1. OwnerUI: "지갑 연결" 버튼 클릭
    2. AppKit: WalletConnect URI 생성 -> QR 코드 모달 표시
    3. Owner: 모바일 지갑에서 QR 스캔
    4. OwnerWallet -> Relay -> AppKit: 세션 제안 수락
    5. AppKit: session_connect 이벤트 -> Owner 공개키 추출
    6. OwnerUI -> Daemon: POST /v1/owner/connect { address, chain, wcSessionTopic }
    7. Daemon: owner_wallets 테이블에 연결 정보 저장
    8. 연결 완료 -> 이후 서명 요청 가능
  - Reown AppKit 초기화 코드 패턴 (Tauri WebView에서):
    - createAppKit({ projectId, chains, features }) 호출
    - Solana + EVM 네트워크 설정
    - 이벤트 리스너: connect, disconnect, session_update

  **섹션 4: Owner 지갑 연결 플로우 -- CLI 대안**
  - CLI waiaas owner connect 커맨드:
    1. WalletConnect URI 생성 (Sign Client 직접 사용)
    2. 터미널에 QR 코드 ASCII art 출력 (qrcode-terminal npm)
    3. 모바일 지갑에서 QR 스캔 -> 페어링
    4. 세션 수립 후 Owner 공개키 추출 -> config 저장
  - CLI에서는 @reown/appkit 불필요 -- @walletconnect/sign-client 직접 사용

  **섹션 5: ownerAuth 미들웨어 상세 설계**
  - CORE-06의 ownerAuth stub 완성:
    - 라우트 레벨 미들웨어 (전역이 아님 -- Owner 전용 라우트에만 적용)
    - 인증 방식: Authorization: Bearer {ownerSignaturePayload}
  - ownerSignaturePayload 구조:
    - base64url 인코딩된 JSON: { chain, address, action, nonce, timestamp, signature, message }
    - action: 'approve_tx' | 'reject_tx' | 'kill_switch' | 'manage_sessions' | 'update_settings'
    - timestamp: ISO 8601 (5분 이내만 유효)
    - nonce: LRU 캐시 기반 일회성 (SESS-PROTO와 동일)
  - 검증 로직 (코드 수준):
    1. Authorization 헤더 파싱 -> payload 추출
    2. timestamp 유효성 (5분 이내)
    3. nonce 유효성 (일회성, LRU에서 확인 후 삭제)
    4. chain 분기: solana -> verifySIWS(payload), ethereum -> verifySIWE(payload) (Phase 7 유틸리티 재사용)
    5. 서명자 주소 == 등록된 Owner 주소 확인 (owner_wallets 테이블 조회)
    6. action == 요청된 API 경로의 기대 action 확인
    7. 성공: c.set('ownerAddress', payload.address) + next()
    8. 실패: WaiaasError('UNAUTHORIZED' | 'INVALID_SIGNATURE' | 'OWNER_MISMATCH', 401/403)
  - Owner 서명 메시지 포맷 (SIWS/SIWE 표준 준수):
    - domain: 'localhost:3100'
    - statement: 'WAIaaS Owner Action: {action}'
    - nonce, issuedAt, expirationTime 포함

  </action>
  <verify>
  - 34-owner-wallet-connection.md 파일이 존재하고 문서 ID가 OWNR-CONN
  - WalletConnect v2 연결 플로우가 시퀀스 다이어그램으로 포함됨
  - ownerAuth 미들웨어 검증 로직이 8단계로 코드 수준 설계됨
  - CLI 대안 경로가 설계됨
  - ownerSignaturePayload 구조가 정의됨
  </verify>
  <done>WalletConnect v2 연결 프로토콜과 ownerAuth 미들웨어가 구현 가능한 수준으로 설계됨</done>
</task>

<task type="auto">
  <name>Task 2: Owner 전용 API 엔드포인트 + 세션 관리 + 설정 변경 인터페이스 설계</name>
  <files>.planning/deliverables/34-owner-wallet-connection.md</files>
  <action>
  34-owner-wallet-connection.md에 다음 섹션을 추가한다.

  **섹션 6: Owner 전용 API 엔드포인트 (API-05)**
  - 모든 Owner 엔드포인트는 ownerAuth 미들웨어 적용 (SIWS/SIWE 서명 필수)

  POST /v1/owner/approve/:txId (거래 승인):
  - 인증: ownerAuth (action='approve_tx')
  - 경로 파라미터: txId (거래 UUID)
  - 응답 Zod 스키마: { transactionId, status: 'EXECUTING', approvedAt, approvedBy }
  - 처리: 08-01 APPROVAL 플로우 연동 -- transactions (QUEUED -> EXECUTING) 원자적 전이 + Stage 5a 실행 트리거
  - 에러: TX_NOT_FOUND (404), TX_NOT_PENDING_APPROVAL (409), TX_EXPIRED (410), OWNER_MISMATCH (403)

  POST /v1/owner/reject/:txId (거래 거절):
  - 인증: ownerAuth (action='reject_tx')
  - 경로 파라미터: txId
  - 응답: { transactionId, status: 'CANCELLED', rejectedAt }
  - 처리: DELAY/APPROVAL 티어 모두 -- transactions (QUEUED -> CANCELLED, error='OWNER_REJECTED')
  - 에러: TX_NOT_FOUND (404), TX_NOT_PENDING (409)

  POST /v1/owner/kill-switch (Kill Switch 발동):
  - 인증: ownerAuth (action='kill_switch')
  - 요청: { reason: z.string().max(500) }
  - 응답: { activated: true, timestamp, sessionsRevoked, txCancelled, agentsSuspended }
  - 처리: 08-04 Kill Switch 캐스케이드 연동
  - 에러: KILL_SWITCH_ALREADY_ACTIVE (409)

  GET /v1/owner/pending-approvals (승인 대기 거래 목록):
  - 인증: ownerAuth (action='manage_sessions')
  - 쿼리: agentId (optional), limit, cursor
  - 응답: { transactions: PendingApprovalSummary[], nextCursor? }
  - PendingApprovalSummary: txId, agentId, agentName, type, amount, toAddress, tier, queuedAt, expiresAt

  PUT /v1/owner/policies/:policyId (정책 수정):
  - 인증: ownerAuth (action='update_settings')
  - 요청: { rules?: PolicyRuleSchema, enabled?: boolean, priority?: number }
  - 응답: { policy: PolicySummary, updatedAt }
  - 에러: POLICY_NOT_FOUND (404), INVALID_RULES (400)

  POST /v1/owner/policies (정책 생성):
  - 인증: ownerAuth (action='update_settings')
  - 요청: { agentId?: string, type, rules, priority?, enabled? }
  - 응답: { policy: PolicySummary, createdAt }

  **섹션 7: Owner 지갑 세션 관리**
  - WalletConnect 세션 수명주기:
    - 연결: POST /v1/owner/connect -> owner_wallets INSERT
    - 유지: 세션 ping 30분 주기 (WalletConnect SDK 내장)
    - 재연결: AppKit 자동 재연결 (localStorage 기반 세션 캐시)
    - 해제: DELETE /v1/owner/disconnect -> owner_wallets DELETE + WC 세션 종료
  - owner_wallets 테이블 스키마:
    - id: UUID v7 PK
    - address: TEXT NOT NULL -- Owner 지갑 공개키
    - chain: TEXT NOT NULL -- 'solana' | 'ethereum'
    - wcSessionTopic: TEXT -- WalletConnect 세션 토픽
    - wcPairingTopic: TEXT -- WalletConnect 페어링 토픽
    - connectedAt: TEXT NOT NULL -- ISO 8601
    - lastActiveAt: TEXT -- 마지막 서명 활동
    - metadata: TEXT -- JSON (지갑 이름, 아이콘 등)
  - 다중 Owner 미지원 (v0.2): owner_wallets에 최대 1개 활성 레코드
  - Owner 주소 변경: 기존 연결 해제 -> 새 연결 (모든 에이전트의 ownerAddress 갱신 필요)

  **섹션 8: WalletConnect Relay 장애 대응**
  - Relay 장애 시 APPROVAL 승인 불가 -> 타임아웃 만료 -> EXPIRED (안전 방향)
  - CLI 직접 서명 대안:
    - waiaas owner approve <txId> --signature <base58_sig> --message <siws_message>
    - WalletConnect 없이 서명 전달 (키패어 파일 직접 사용 시)
  - Kill Switch는 WalletConnect 불필요 (로컬 CLI 직접 발동 가능):
    - waiaas kill-switch --reason "emergency"
    - 마스터 패스워드 인증 (키스토어 잠금 해제 수준)

  **섹션 9: 보안 고려사항**
  - WalletConnect projectId 유출: 읽기 전용 식별자이므로 보안 위험 낮음 (relay 접근 허용일 뿐)
  - 서명 재생 공격 방지: nonce 일회성 + timestamp 5분 제한 + action 바인딩
  - Owner 사칭 방지: 서명자 주소 == owner_wallets.address 필수 검증
  - 다중 디바이스: WalletConnect 세션은 1개만 유지 (새 연결 시 기존 해제)
  - Phase 9 Tauri 통합 시 WebView CSP에 relay.walletconnect.com 허용 필요

  </action>
  <verify>
  - Owner 전용 API 6개 엔드포인트가 Zod 스키마로 정의됨 (approve, reject, kill-switch, pending-approvals, policies PUT, policies POST)
  - owner_wallets 테이블 스키마가 정의됨
  - WalletConnect 세션 수명주기가 문서화됨
  - Relay 장애 대응 + CLI 대안이 설계됨
  - 보안 고려사항이 5개 항목으로 명시됨
  </verify>
  <done>Owner 전용 API, 지갑 세션 관리, 장애 대응이 구현 가능한 수준으로 설계됨. OWNR-01~03, API-05 요구사항 모두 충족.</done>
</task>

</tasks>

<verification>
1. 34-owner-wallet-connection.md가 .planning/deliverables/에 존재
2. OWNR-01 (브라우저 지갑): Tauri WebView에서 Reown AppKit 모달 QR 연결 설계됨
3. OWNR-02 (WalletConnect QR): WalletConnect v2 시퀀스 다이어그램 포함
4. OWNR-03 (서명 승인): ownerAuth 미들웨어 + SIWS/SIWE 서명 검증 설계됨
5. API-05 (Owner 엔드포인트): approve/reject/kill-switch + pending-approvals + policies 정의됨
6. CLI 대안 경로(waiaas owner connect)가 설계됨
7. owner_wallets 테이블 스키마가 정의됨
</verification>

<success_criteria>
- Owner 지갑 연결 문서가 9개 섹션으로 구성되어 Phase 8 Success Criteria #2를 충족
- WalletConnect v2 프로토콜이 시퀀스 다이어그램으로 완전히 문서화됨
- ownerAuth 미들웨어가 Phase 7 유틸리티를 재사용하여 코드 수준으로 설계됨
- Owner 전용 API가 Zod 스키마로 설계됨
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-layers-design/08-02-SUMMARY.md`
</output>
