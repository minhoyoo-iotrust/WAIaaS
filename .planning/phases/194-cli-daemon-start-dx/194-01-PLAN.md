---
phase: 194-cli-daemon-start-dx
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/index.ts
  - packages/cli/package.json
  - packages/cli/src/commands/init.ts
  - packages/cli/src/__tests__/cli-commands.test.ts
autonomous: true
requirements: [CLI-01, CLI-02, CLI-03, CLI-04, CLI-05]

must_haves:
  truths:
    - "waiaas --version이 package.json의 실제 semver 버전을 표시한다 (0.0.0 아님)"
    - "CLI package.json에 engines.node >= 22.0.0 필드가 존재한다"
    - "waiaas init 완료 메시지에 마스터 패스워드 설정 방법이 안내된다"
    - "init 생성 config.toml에 주석 처리된 섹션 예시가 포함된다"
    - "init 시 권한 오류가 발생하면 친절한 에러 메시지가 출력된다"
  artifacts:
    - path: "packages/cli/src/index.ts"
      provides: "Dynamic version from package.json"
      contains: "createRequire.*package.json|import.*package.json"
    - path: "packages/cli/package.json"
      provides: "Node.js engine constraint"
      contains: "engines.*node.*22"
    - path: "packages/cli/src/commands/init.ts"
      provides: "Password guidance, config template with commented sections, permission error handling"
      contains: "master.*password|WAIAAS_MASTER_PASSWORD|\\[security\\]|\\[rpc\\]|\\[notifications\\]|EACCES|permission"
    - path: "packages/cli/src/__tests__/cli-commands.test.ts"
      provides: "Tests for init config template, password guidance, permission errors"
  key_links:
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/package.json"
      via: "createRequire or import for version field"
      pattern: "version"
    - from: "packages/cli/src/commands/init.ts"
      to: "console output"
      via: "password guidance in completion message"
      pattern: "WAIAAS_MASTER_PASSWORD"
---

<objective>
CLI 첫 실행 경험 개선: --version에서 실제 버전 표시, engines.node 선언, init 시 패스워드 안내/템플릿 보강/에러 핸들링.

Purpose: 사용자가 `npm install -g @waiaas/cli` 후 `waiaas --version`, `waiaas init`을 실행할 때 발생하는 마찰 5건을 제거한다.
Output: 수정된 CLI 엔트리포인트, init 커맨드, 패키지 메타데이터, 업데이트된 테스트.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/objectives/m25-00-dx-polish.md
@packages/cli/src/index.ts
@packages/cli/src/commands/init.ts
@packages/cli/package.json
@packages/cli/src/__tests__/cli-commands.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI --version 동적 버전 + engines.node 필드</name>
  <files>packages/cli/src/index.ts, packages/cli/package.json</files>
  <action>
1. **packages/cli/src/index.ts**: `.version('0.0.0')` 하드코딩을 package.json에서 동적으로 읽도록 변경.
   - ESM에서 JSON import를 위해 `createRequire`를 사용한다:
     ```ts
     import { createRequire } from 'node:module';
     const require = createRequire(import.meta.url);
     const pkg = require('../package.json') as { version: string };
     ```
   - `.version(pkg.version)` 으로 변경.
   - 주의: `import ... from '../package.json' with { type: 'json' }` 대신 `createRequire`를 사용하는 이유는 TypeScript의 resolveJsonModule + ESM 조합에서 빌드 시 package.json이 dist/에 복사되지 않는 문제를 피하기 위함.

2. **packages/cli/package.json**: `engines` 필드를 추가한다:
   ```json
   "engines": {
     "node": ">=22.0.0"
   }
   ```
   `"files"` 배열 아래에 위치시킨다. 또한 `"files"` 배열에 `"package.json"` 항목이 없어도 npm은 항상 package.json을 포함하므로 추가 불필요.
  </action>
  <verify>
- `cd packages/cli && pnpm build` 성공
- `node dist/index.js --version` 출력이 `2.3.0`과 일치 (0.0.0 아님)
- `node -e "const pkg = require('./packages/cli/package.json'); console.log(pkg.engines?.node)"` 출력이 `>=22.0.0`
  </verify>
  <done>
- `waiaas --version`이 package.json version 필드와 동일한 semver 버전을 출력한다.
- package.json에 `engines.node >= 22.0.0`이 선언되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: init 패스워드 안내 + config 템플릿 + 권한 에러 핸들링</name>
  <files>packages/cli/src/commands/init.ts, packages/cli/src/__tests__/cli-commands.test.ts</files>
  <action>
1. **packages/cli/src/commands/init.ts** — `DEFAULT_CONFIG` 상수를 보강:
   - 기존 `[daemon]`, `[database]` 섹션 유지.
   - 아래에 주석 처리된 섹션 예시를 추가:
     ```toml
     # [security]
     # policy_defaults_delay = 0
     # policy_defaults_approval_timeout = 3600

     # [rpc]
     # solana_devnet = "https://api.devnet.solana.com"
     # ethereum_sepolia = "https://rpc.sepolia.org"

     # [notifications]
     # enabled = false
     # telegram_bot_token = ""
     # telegram_chat_id = ""
     ```
   - 마지막에 `# Full reference: https://github.com/minhoyoo-iotrust/WAIaaS#configuration` 주석.

2. **packages/cli/src/commands/init.ts** — 완료 메시지 보강:
   - 기존 `console.log('Next: waiaas start')` 앞에 패스워드 설정 안내 추가:
     ```
     Set your master password before starting:
       export WAIAAS_MASTER_PASSWORD="your-secure-password"
     Or use a password file:
       echo "your-secure-password" > ~/.waiaas/master-password.txt
       export WAIAAS_MASTER_PASSWORD_FILE=~/.waiaas/master-password.txt
     ```
   - 기존 `Next: waiaas start` 라인은 유지.

3. **packages/cli/src/commands/init.ts** — `mkdirSync`와 `writeFileSync` 호출을 try/catch로 감싼다:
   - `EACCES`/`EPERM` 에러 코드를 감지하여 친절한 메시지 출력:
     ```
     Permission denied: Cannot create ${path}
     Try: sudo mkdir -p ${dataDir} && sudo chown $(whoami) ${dataDir}
     ```
   - 다른 에러는 원래 메시지와 함께 재throw.

4. **packages/cli/src/__tests__/cli-commands.test.ts** — `initCommand` 테스트 블록에 추가:
   - config.toml에 `# [security]`, `# [rpc]`, `# [notifications]` 주석 섹션 존재 확인 테스트.
   - 완료 출력에 `WAIAAS_MASTER_PASSWORD` 문자열 포함 확인 테스트.
   - 권한 오류 테스트: 읽기전용 디렉토리에서 init 시도 → "Permission denied" 포함 메시지 확인 (이 테스트는 process.exit mock 사용).

주의: 기존 테스트 (`creates data directory`, `skips config.toml creation`, `creates directory with 0o700 permissions`, `generated config.toml contains [daemon]`)는 수정하지 않거나 config.toml 내용 변경에 맞춰 최소한으로 조정한다.
  </action>
  <verify>
- `cd packages/cli && pnpm test` 전체 통과
- `pnpm turbo run typecheck --filter=@waiaas/cli` 성공
- 신규 테스트 3건 이상 통과
  </verify>
  <done>
- init 완료 메시지에 `WAIAAS_MASTER_PASSWORD` 환경변수 안내가 포함된다.
- 생성된 config.toml에 `# [security]`, `# [rpc]`, `# [notifications]` 주석 섹션이 존재한다.
- 권한 오류 시 `Permission denied` 메시지와 해결 방법이 출력된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run build --filter=@waiaas/cli` 성공
2. `pnpm turbo run test --filter=@waiaas/cli` 전체 통과
3. `pnpm turbo run typecheck --filter=@waiaas/cli` 성공
4. `node packages/cli/dist/index.js --version` 출력이 `2.3.0` (0.0.0 아님)
</verification>

<success_criteria>
- waiaas --version이 0.0.0이 아닌 패키지 실제 버전을 출력한다.
- engines.node >= 22.0.0이 package.json에 선언되어 있다.
- waiaas init 완료 시 마스터 패스워드 설정 안내가 출력된다.
- 생성되는 config.toml에 [security], [rpc], [notifications] 주석 예시가 포함된다.
- 권한 오류 시 원인과 해결 방법을 안내하는 메시지가 출력된다.
- 모든 기존 + 신규 테스트 통과.
</success_criteria>

<output>
After completion, create `.planning/phases/194-cli-daemon-start-dx/194-01-SUMMARY.md`
</output>
