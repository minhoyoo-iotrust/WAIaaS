---
phase: 194-cli-daemon-start-dx
plan: 02
type: execute
wave: 2
depends_on: [194-01]
files_modified:
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/cli/src/commands/start.ts
  - packages/cli/src/__tests__/cli-commands.test.ts
autonomous: true
requirements: [DAEMON-01, DAEMON-02, DAEMON-03]

must_haves:
  truths:
    - "포트 충돌 시 'Port N is already in use' 메시지가 출력된다"
    - "기본 모드에서 Step 1~6 내부 로그가 출력되지 않는다"
    - "데몬 시작 완료 메시지에 Admin UI URL이 포함된다"
  artifacts:
    - path: "packages/daemon/src/lifecycle/daemon.ts"
      provides: "Step 로그 debug 하향 + EADDRINUSE 에러 래핑"
      contains: "console\\.debug|EADDRINUSE|already in use"
    - path: "packages/cli/src/commands/start.ts"
      provides: "Admin UI URL 출력 + 포트 충돌 에러 포맷팅"
      contains: "admin|Admin UI|already in use"
    - path: "packages/cli/src/__tests__/cli-commands.test.ts"
      provides: "startCommand 테스트: Admin UI URL, Step 로그 미출력"
  key_links:
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "console.debug"
      via: "모든 Step N 로그를 debug 레벨로 변경"
      pattern: "console\\.debug.*Step"
    - from: "packages/cli/src/commands/start.ts"
      to: "packages/daemon/src/lifecycle/daemon.ts"
      via: "startDaemon() 호출 후 성공 메시지에 Admin UI URL 포함"
      pattern: "/admin"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "@hono/node-server serve"
      via: "EADDRINUSE 에러 감지 및 사용자 친화적 메시지 변환"
      pattern: "EADDRINUSE|already in use"
---

<objective>
데몬 시작 경험 개선: 포트 충돌 시 명확한 에러 메시지, 내부 Step 로그 debug 하향, 시작 완료 시 Admin UI URL 표시.

Purpose: 데몬 시작 시 불필요한 내부 로그 노출을 줄이고, 포트 충돌 에러를 사용자가 즉시 이해할 수 있게 하며, Admin UI 접속 URL을 안내하여 첫 사용자의 다음 행동을 유도한다.
Output: 수정된 daemon lifecycle, start 커맨드, 업데이트된 테스트.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/194-cli-daemon-start-dx/194-01-SUMMARY.md
@internal/objectives/m25-00-dx-polish.md
@packages/daemon/src/lifecycle/daemon.ts
@packages/cli/src/commands/start.ts
@packages/cli/src/__tests__/cli-commands.test.ts
@packages/daemon/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Step 로그 debug 하향 + EADDRINUSE 에러 래핑</name>
  <files>packages/daemon/src/lifecycle/daemon.ts</files>
  <action>
1. **Step 로그 debug 하향**: `_startInternal()` 메서드 내 모든 `console.log('Step N:...')` 호출을 `console.debug('Step N:...')`로 변경한다. 대상:
   - `console.log('Step 1: Config loaded, daemon lock acquired')` → `console.debug(...)`
   - `console.log('Step 2: Database initialized')` → `console.debug(...)`
   - `console.log('Step 2: Schema migration needed...')` → `console.debug(...)`
   - `console.log('Step 2: Settings imported...')` → `console.debug(...)`
   - `console.log('Step 2b: Master password verified...')` (3개) → `console.debug(...)`
   - `console.log('Step 3: Keystore infrastructure...')` (2개) → `console.debug(...)`
   - `console.log('Step 4: AdapterPool...')` → `console.debug(...)`
   - `console.log('Step 4b: Workflow instances...')` → `console.debug(...)`
   - `console.log('Step 4c: JWT secret...')` → `console.debug(...)`
   - `console.log('Step 4c-2: KillSwitch...')` → `console.debug(...)`
   - `console.log('Step 4c-3: AutoStop...')` (2개) → `console.debug(...)`
   - `console.log('Step 4c-4: Balance monitor...')` (2개) → `console.debug(...)`
   - `console.log('Step 4c-5: Telegram...')` (2개) → `console.debug(...)`
   - `console.log('Step 4c-6: WalletConnect...')` (2개) → `console.debug(...)`
   - `console.log('Step 4c-7: WcSigningBridge...')` → `console.debug(...)`
   - `console.log('Step 4d: NotificationService...')` → `console.debug(...)`
   - `console.log('Step 4e: PriceOracle...')` → `console.debug(...)`
   - `console.log('Step 4e-2: ForexRate...')` → `console.debug(...)`
   - `console.log('Step 4f: ActionProvider...')` (2개) → `console.debug(...)`
   - `console.log('Step 4g: VersionCheck...')` → `console.debug(...)`
   - `console.log('Step 5: HTTP server...')` → `console.debug(...)`
   - `console.log('Step 6: Workers started...')` → `console.debug(...)`
   - `console.log('Step 6: Version check...')` (2개) → `console.debug(...)`

   **예외 — 유지할 console.log**: `console.log('WAIaaS daemon ready (PID: ${process.pid})')` 이 마지막 한 줄은 `console.log`로 유지. 이것이 사용자에게 보이는 유일한 시작 메시지.

   **fail-soft warn 유지**: `console.warn('Step N (fail-soft):...')` 호출은 모두 `console.warn`으로 유지한다 (경고는 사용자가 알아야 하므로).

   **shutdown 로그 유지**: `shutdown()` 메서드 내 `console.log`는 변경하지 않는다.

   **console.error 유지**: `console.error('Step 2: Schema incompatible...')`는 유지.

2. **EADDRINUSE 에러 래핑**: Step 5 HTTP server start 부분에서, `serve()` 호출이 즉시 에러를 throw하지 않는다 — `@hono/node-server`의 `serve()`는 내부 Node.js `http.createServer().listen()`을 사용하며, EADDRINUSE는 비동기 'error' 이벤트로 발생한다. 따라서:
   - `serve()` 반환값은 Node.js `http.Server` 인스턴스이다.
   - `serve()` 호출 후 `this.httpServer`에 'error' 이벤트 리스너를 등록하여 EADDRINUSE를 감지한다.
   - 또한 Step 5의 `withTimeout` 내에서 서버가 실제로 'listening' 상태가 될 때까지 기다리는 Promise를 추가한다:
     ```ts
     const server = serve({ fetch: app.fetch, hostname, port });
     this.httpServer = server;

     await new Promise<void>((resolve, reject) => {
       const onListening = () => {
         server.removeListener('error', onError);
         resolve();
       };
       const onError = (err: NodeJS.ErrnoException) => {
         server.removeListener('listening', onListening);
         if (err.code === 'EADDRINUSE') {
           reject(new Error(`Port ${port} is already in use. Try a different port or stop the other process.`));
         } else {
           reject(err);
         }
       };
       // @hono/node-server serve() returns a Node.js http.Server
       server.once('listening', onListening);
       server.once('error', onError);
     });
     ```
   - 이렇게 하면 포트 충돌 시 `withTimeout`이 reject되어 `_startInternal`이 throw하고, `start()` → `startDaemon()` → `startCommand()` catch 블록에서 사용자에게 표시된다.

3. **마지막 시작 메시지에 Admin UI URL 추가**: 기존 `console.log('WAIaaS daemon ready (PID: ${process.pid})')` 을 다음으로 변경:
   ```ts
   console.log(
     `WAIaaS daemon ready on http://${this._config!.daemon.hostname}:${this._config!.daemon.port} (PID: ${process.pid})\n` +
     `  Admin UI: http://${this._config!.daemon.hostname}:${this._config!.daemon.port}/admin`
   );
   ```
  </action>
  <verify>
- `cd packages/daemon && pnpm build` 성공
- `pnpm turbo run typecheck --filter=@waiaas/daemon` 성공
- daemon.ts에 `console.log('Step` 패턴이 없고 `console.debug('Step` 패턴만 존재 (grep 확인)
- daemon.ts에 `EADDRINUSE` 문자열이 존재
- daemon.ts에 `/admin` 문자열이 존재
  </verify>
  <done>
- daemon.ts의 모든 Step N 로그가 console.debug로 하향되어 기본 모드에서 미출력된다.
- 포트 충돌 시 "Port N is already in use" 메시지가 throw된다.
- 시작 완료 시 Admin UI URL이 포함된 메시지가 출력된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: start 커맨드 에러 포맷팅 + 테스트 업데이트</name>
  <files>packages/cli/src/commands/start.ts, packages/cli/src/__tests__/cli-commands.test.ts</files>
  <action>
1. **packages/cli/src/commands/start.ts** — 시작 성공 메시지 수정:
   - 기존: `console.log('WAIaaS daemon started on 127.0.0.1:3100 (PID: ${process.pid})')` — 이 라인 제거.
   - daemon.ts 자체가 "WAIaaS daemon ready" + Admin UI URL을 출력하므로 start.ts에서 중복 출력하지 않는다.
   - catch 블록에서 에러 메시지를 그대로 출력하되, 포트 충돌 에러의 경우 추가로 `Use --log-level debug for detailed startup logs` 힌트를 출력한다:
     ```ts
     } catch (err) {
       const msg = (err as Error).message;
       console.error(`Failed to start daemon: ${msg}`);
       if (msg.includes('already in use')) {
         console.error('Hint: Check what is using the port with: lsof -i :3100');
       }
       process.exit(1);
     }
     ```

2. **packages/cli/src/__tests__/cli-commands.test.ts** — `startCommand` 테스트 블록 업데이트:
   - 기존 `it('calls startDaemon with dataDir and password')` 테스트에서 성공 시 출력 assertion이 있다면 daemon.ts의 출력으로 변경 (start.ts가 자체 출력을 제거했으므로).
   - **신규 테스트**: `it('outputs port conflict hint when EADDRINUSE')` — mockStartDaemon이 "Port 3100 is already in use" 에러를 throw → stderr에 "already in use" + "lsof" 포함 확인.
   - **신규 테스트**: `it('does not print Step logs on successful start (daemon uses console.debug)')` — mockStartDaemon 성공 후, mockStdout에 `Step 1:`, `Step 4` 등이 포함되지 않음을 확인. (참고: console.debug는 별도 stream이므로 console.log spy에 안 잡힌다.)

주의: 194-01에서 initCommand 테스트가 수정되었으므로 해당 부분은 건드리지 않는다. startCommand 섹션만 수정한다.
  </action>
  <verify>
- `cd packages/cli && pnpm test` 전체 통과
- `pnpm turbo run typecheck --filter=@waiaas/cli` 성공
- 신규 테스트 2건 이상 통과
  </verify>
  <done>
- start 커맨드가 포트 충돌 에러 시 "already in use" 메시지와 lsof 힌트를 출력한다.
- 기본 모드에서 Step 1~6 로그가 console.log에 나타나지 않는다.
- 시작 성공 시 Admin UI URL이 포함된 메시지가 출력된다 (daemon.ts에서).
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run build --filter=@waiaas/daemon --filter=@waiaas/cli` 성공
2. `pnpm turbo run test --filter=@waiaas/cli` 전체 통과
3. `pnpm turbo run typecheck --filter=@waiaas/daemon --filter=@waiaas/cli` 성공
4. `grep -c "console\.log('Step" packages/daemon/src/lifecycle/daemon.ts` → 0
5. `grep -c "console\.debug('Step" packages/daemon/src/lifecycle/daemon.ts` → 20+
6. `grep "EADDRINUSE\|already in use" packages/daemon/src/lifecycle/daemon.ts` → 일치
7. `grep "/admin" packages/daemon/src/lifecycle/daemon.ts` → 일치
</verification>

<success_criteria>
- 포트 충돌 시 "Port N is already in use" 메시지 + lsof 힌트가 출력된다.
- 기본 모드에서 내부 Step 1~6 로그가 보이지 않는다 (debug 레벨).
- 시작 완료 메시지에 Admin UI URL (http://127.0.0.1:3100/admin)이 포함된다.
- 모든 기존 + 신규 테스트 통과.
</success_criteria>

<output>
After completion, create `.planning/phases/194-cli-daemon-start-dx/194-02-SUMMARY.md`
</output>
