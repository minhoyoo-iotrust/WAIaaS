---
phase: 16-blockchain-consistency-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/v0.4/48-blockchain-test-environment-strategy.md
autonomous: true

must_haves:
  truths:
    - "Solana 3단계(Mock RPC / Local Validator / Devnet) 환경별 실행 범위와 시나리오가 구분되어 있다"
    - "Mock RPC 13개 시나리오가 입력(RPC 메서드+파라미터)-출력(응답/에러) 형태로 명세되어 있다"
    - "Local Validator E2E 5개 흐름이 단계별로 정의되어 있다"
    - "EvmAdapterStub 테스트 범위(타입 준수 + 13메서드 throw)가 정의되어 있다"
  artifacts:
    - path: "docs/v0.4/48-blockchain-test-environment-strategy.md"
      provides: "블록체인 테스트 3단계 환경 전략 + Mock RPC 시나리오 + Local Validator E2E + EVM Stub"
      contains: "Mock RPC 시나리오"
  key_links:
    - from: "docs/v0.4/48-blockchain-test-environment-strategy.md"
      to: "docs/v0.4/41-test-levels-coverage-matrix.md"
      via: "테스트 레벨별 실행 범위 참조 (TLVL-01 Chain Integration)"
      pattern: "Chain Integration"
    - from: "docs/v0.4/48-blockchain-test-environment-strategy.md"
      to: "docs/v0.4/42-mock-boundaries-interfaces-contracts.md"
      via: "Mock 경계 매트릭스 참조 (블록체인 RPC Mock 방식)"
      pattern: "MockChainAdapter"
    - from: "docs/v0.4/48-blockchain-test-environment-strategy.md"
      to: "docs/v0.2/31-solana-adapter-detail.md"
      via: "SolanaAdapter 13메서드 에러 매핑 참조"
      pattern: "SolanaAdapter"
---

<objective>
Solana 블록체인 의존성을 3단계(Mock RPC / Local Validator / Devnet)로 격리하는 테스트 환경 전략을 확정하고, Mock RPC 13개 시나리오, Local Validator E2E 5개 흐름, EVM Adapter Stub 테스트 범위를 명세한다.

Purpose: 구현 단계에서 "어떤 블록체인 시나리오를 어떤 환경에서 테스트하는가"가 즉시 참조 가능한 상태를 만든다.
Output: `docs/v0.4/48-blockchain-test-environment-strategy.md` -- CHAIN-01, CHAIN-02, CHAIN-03, CHAIN-04 요구사항 충족
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-blockchain-consistency-verification/16-RESEARCH.md

# Phase 14 deliverables (테스트 레벨, Mock 경계)
@docs/v0.4/41-test-levels-coverage-matrix.md
@docs/v0.4/42-mock-boundaries-interfaces-contracts.md

# v0.2 Solana/EVM 설계 문서
@docs/v0.2/31-solana-adapter-detail.md
@docs/v0.2/27-chain-adapter-interface.md
@docs/v0.2/36-killswitch-autostop-evm.md
@docs/v0.2/32-transaction-pipeline-api.md

# Phase 15 보안 시나리오 (블록체인 관련 경계값 참조)
@docs/v0.4/47-boundary-values-e2e-chains.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Solana 3단계 테스트 환경 전략 + Mock RPC 시나리오 명세</name>
  <files>docs/v0.4/48-blockchain-test-environment-strategy.md</files>
  <action>
  `docs/v0.4/48-blockchain-test-environment-strategy.md` 문서를 생성한다. 한글로 작성하며, 다음 구조를 포함한다:

  **섹션 1: Solana 3단계 테스트 환경 (CHAIN-01)**
  - 3단계 환경 표: Level 1 Mock RPC / Level 2 Local Validator / Level 3 Devnet
  - 각 환경별: 용도, 실행 환경, 속도, 실행 빈도(Phase 14 TLVL-01 기준), 결정성, Mock 대상, 적용 테스트 레벨
  - Phase 14 결정 준수 확인: Unit/Integration/Security는 Mock, Chain Integration은 실제 노드
  - 환경 간 역할 분담 매트릭스 (어떤 검증을 어디서 하는가)

  **섹션 2: Mock RPC 시나리오 명세 (CHAIN-02)**
  - 16-RESEARCH.md의 13개 시나리오를 입력-출력 형태로 상세 명세한다
  - 각 시나리오 표:
    - 번호, 시나리오명, 카테고리(성공/실패/지연/중복)
    - 입력: RPC 메서드, 파라미터(있으면), 선행 상태
    - 출력: Mock 응답 JSON 구조, 기대 에러 코드
    - 검증 항목: SolanaAdapter가 어떤 ChainError/결과를 반환해야 하는지
    - 참조: 31-solana-adapter-detail.md 에러 매핑 또는 Phase 15 시나리오 ID
  - Mock RPC Transport 구현 가이드:
    - `createMockRpcTransport()` 팩토리 함수 시그니처 (16-RESEARCH.md Pattern 2 기반)
    - Stateless vs Stateful 모드 선택 기준 (테스트 레벨별)
    - `calls` 배열을 통한 호출 검증 패턴
    - 패키지 위치: `packages/core/src/testing/mock-rpc-transport.ts` (7패키지 모노레포에서 공유)
  - 시나리오 커버리지 매핑: 13개 시나리오가 SolanaAdapter 13개 메서드 중 어떤 것을 커버하는지 크로스 레퍼런스 표

  **섹션 3: Local Validator E2E 흐름 (CHAIN-03)**
  - 16-RESEARCH.md의 5개 E2E 흐름을 단계별로 상세화한다
  - 각 흐름:
    - 전제 조건(solana-test-validator 실행 중, airdrop 완료)
    - Given-When-Then 형태의 단계별 정의
    - 예상 시간, 타임아웃 설정
    - 검증 항목 (각 단계의 반환값/상태)
  - CI 실행 가이드:
    - solana-test-validator 시작/종료 스크립트 패턴
    - `--reset --quiet --rpc-port` 플래그
    - health check 폴링 (최대 30초)
    - beforeAll/afterAll 패턴
  - Devnet 역할:
    - 최대 2-3건만 (SOL 전송 + 잔액 + 헬스)
    - Rate limit 대응 (`--runInBand`, 재시도 3회)
    - 네트워크 불안정 허용 (FLAKY 마킹)
  - Airdrop 전략 표 (Local Validator: 10 SOL beforeAll, Devnet: 2 SOL per test + 재시도)
  </action>
  <verify>
  파일이 존재하고, 다음을 포함하는지 확인:
  - "3단계" 또는 "Mock RPC" / "Local Validator" / "Devnet" 3가지 모두 언급
  - 13개 Mock RPC 시나리오 각각에 입력/출력 명세
  - 5개 Local Validator E2E 흐름의 Given-When-Then 또는 단계별 정의
  - Phase 14 TLVL-01 실행 빈도와의 정합성 확인 (매 커밋/매 PR/nightly 구분)
  </verify>
  <done>
  CHAIN-01 충족: 3단계 환경별 실행 범위와 시나리오가 구분되어 있다.
  CHAIN-02 충족: 13개 Mock RPC 시나리오가 입력-출력 형태로 명세되어 있다.
  CHAIN-03 충족: 5개 Local Validator E2E 흐름이 단계별로 정의되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: EVM Adapter Stub 테스트 범위 + 요구사항 크로스 체크</name>
  <files>docs/v0.4/48-blockchain-test-environment-strategy.md</files>
  <action>
  동일 문서 `docs/v0.4/48-blockchain-test-environment-strategy.md`에 EVM 섹션과 요약 섹션을 추가한다:

  **섹션 4: EVM Adapter Stub 테스트 범위 (CHAIN-04)**
  - 16-RESEARCH.md의 EVM 테스트 5항목을 상세화:
    1. IChainAdapter 타입 준수: `tsc --noEmit`으로 `implements IChainAdapter` 확인 (빌드타임)
    2. `isConnected()` -> false 반환 (Unit)
    3. `getHealth()` -> `{ healthy: false, latency: -1 }` 반환 (Unit)
    4. 11개 메서드(connect/disconnect 제외)가 `ChainError { code: 'CHAIN_NOT_SUPPORTED' }` throw (Unit)
    5. AdapterRegistry 등록/조회 `registry.get('ethereum')` (Unit)
  - 각 항목에 테스트 레벨, 검증 방법, 기대 결과 명시
  - Contract Test 적용 가이드: Phase 14 CONTRACT-TEST-FACTORY-PATTERN에 따라 `chainAdapterContractTests(factory, { skipNetworkTests: true })` 실행. 대부분 CHAIN_NOT_SUPPORTED throw 확인이 됨을 명시.

  **섹션 5: 요구사항 충족 매트릭스**
  - CHAIN-01 ~ CHAIN-04 각 요구사항이 문서의 어떤 섹션에서 충족되는지 크로스 레퍼런스 표
  - Phase 14 결정(TLVL-01 실행 빈도, MOCK 경계)과의 정합성 체크리스트
  - Phase 15 보안 시나리오(SEC-05 경계값 중 블록체인 관련)와의 교차 참조

  **섹션 6: 구현 가이드 요약**
  - Mock RPC Transport 패키지 위치, 의존성
  - Local Validator 셋업 스크립트 개요
  - Devnet 테스트 제한 사항
  - EvmAdapterStub 테스트 파일 위치 제안
  </action>
  <verify>
  파일에 다음이 포함되는지 확인:
  - EvmAdapterStub 5개 테스트 항목의 상세 명세
  - CHAIN-01~04 요구사항 충족 매트릭스
  - Contract Test 적용 가이드 (skipNetworkTests: true)
  </verify>
  <done>
  CHAIN-04 충족: EVM 테스트 범위가 정의되어 있다 (IChainAdapter 타입 준수 + CHAIN_NOT_SUPPORTED throw 확인).
  문서 전체가 CHAIN-01~04 모든 요구사항을 커버하며, Phase 14/15와 정합성이 확인된 상태.
  </done>
</task>

</tasks>

<verification>
- [ ] `docs/v0.4/48-blockchain-test-environment-strategy.md` 파일 존재
- [ ] CHAIN-01: Solana 3단계 환경 표가 있고 각 환경의 실행 범위/시나리오가 구분됨
- [ ] CHAIN-02: 13개 Mock RPC 시나리오가 입력-출력 형태로 명세됨
- [ ] CHAIN-03: 5개 Local Validator E2E 흐름이 Given-When-Then 또는 단계별로 정의됨
- [ ] CHAIN-04: EvmAdapterStub 5개 테스트 항목이 명세됨
- [ ] Phase 14 TLVL-01 실행 빈도와 정합 (Unit 매커밋, E2E 매PR, Chain Integration nightly)
- [ ] Phase 14 MOCK 경계와 정합 (Unit/Integration은 MockChainAdapter, Chain Integration은 실제)
- [ ] Phase 15 보안 시나리오와 충돌 없음 (SEC-05 블록체인 경계값 참조 확인)
</verification>

<success_criteria>
1. Solana 3단계 환경별 실행 범위와 시나리오가 표로 구분되어, 어떤 테스트를 어디서 실행하는지 즉시 조회 가능
2. Mock RPC 13개 시나리오 각각에 RPC 메서드, 파라미터, 응답 JSON, 기대 결과가 명세되어 구현 시 복사-붙여넣기 수준으로 활용 가능
3. Local Validator E2E 5개 흐름이 단계별로 정의되어, 테스트 코드 작성 시 흐름을 그대로 따라갈 수 있음
4. EvmAdapterStub 테스트 범위가 명확하여, 5개 검증 항목을 즉시 테스트 코드로 변환 가능
</success_criteria>

<output>
After completion, create `.planning/phases/16-blockchain-consistency-verification/16-01-SUMMARY.md`
</output>
