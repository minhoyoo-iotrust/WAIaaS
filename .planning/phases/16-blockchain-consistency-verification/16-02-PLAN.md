---
phase: 16-blockchain-consistency-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/v0.4/49-enum-config-consistency-verification.md
autonomous: true

must_haves:
  truths:
    - "9개 Enum SSoT 동기화 검증 방법이 빌드타임 우선으로 정의되어 있다"
    - "as const 배열 -> TypeScript 타입 -> Zod enum -> Drizzle text enum -> DB CHECK 단방향 파생 체인이 명세되어 있다"
    - "config.toml 3단계 로딩(기본값/TOML/환경변수) 검증 전략이 테스트 케이스 수준으로 정의되어 있다"
    - "NOTE-01~11 중 테스트 필요 4건과 불필요 7건이 분류되고, 테스트 매핑이 완료되어 있다"
  artifacts:
    - path: "docs/v0.4/49-enum-config-consistency-verification.md"
      provides: "Enum SSoT 빌드타임 검증 + config.toml 테스트 전략 + NOTE 매핑"
      contains: "as const"
  key_links:
    - from: "docs/v0.4/49-enum-config-consistency-verification.md"
      to: "docs/v0.3/45-enum-unified-mapping.md"
      via: "9개 Enum 정의를 검증 대상으로 참조"
      pattern: "TRANSACTION_STATUSES"
    - from: "docs/v0.4/49-enum-config-consistency-verification.md"
      to: "docs/v0.2/24-monorepo-data-directory.md"
      via: "config.toml 전체 키-값 구조, 환경변수 매핑 표 참조"
      pattern: "config\\.toml"
    - from: "docs/v0.4/49-enum-config-consistency-verification.md"
      to: "docs/v0.4/41-test-levels-coverage-matrix.md"
      via: "테스트 레벨별 검증 방법 참조"
      pattern: "빌드타임|Unit|Integration"
---

<objective>
v0.3에서 확보한 9개 Enum SSoT의 빌드타임 자동 검증 방법을 확정하고, config.toml 3단계 로딩 테스트 전략과 NOTE-01~11의 테스트 케이스 매핑을 완료한다. 사용자가 명시적으로 선택한 "빌드타임 우선" 전략에 따라 TypeScript 컴파일러를 1차 방어선으로 설계한다.

Purpose: 구현 단계에서 Enum 불일치와 설정 오류를 빌드타임에 즉시 발견할 수 있는 검증 체계를 확정한다.
Output: `docs/v0.4/49-enum-config-consistency-verification.md` -- ENUM-01, ENUM-02, ENUM-03 요구사항 충족
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-blockchain-consistency-verification/16-RESEARCH.md

# v0.3 SSoT 문서 (검증 대상 기준)
@docs/v0.3/45-enum-unified-mapping.md
@docs/v0.2/24-monorepo-data-directory.md

# Phase 14 deliverables (테스트 레벨)
@docs/v0.4/41-test-levels-coverage-matrix.md
@docs/v0.4/42-mock-boundaries-interfaces-contracts.md

# v0.2 DB 스키마 (Drizzle 정의)
@docs/v0.2/25-sqlite-schema.md

# Phase 13 NOTE-01~11이 포함된 산출물
@docs/v0.3/43-cross-cutting-consistency-map.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enum SSoT 빌드타임 검증 전략 + DB CHECK 자동화</name>
  <files>docs/v0.4/49-enum-config-consistency-verification.md</files>
  <action>
  `docs/v0.4/49-enum-config-consistency-verification.md` 문서를 생성한다. 한글로 작성하며, 다음 구조를 포함한다:

  **섹션 1: Enum SSoT 파생 체인 아키텍처 (ENUM-01)**
  - 단방향 파생 다이어그램: `as const 배열` -> `TypeScript 타입` -> `Zod enum` -> `Drizzle text enum` -> `DB CHECK SQL`
  - [LOCKED] 빌드타임 우선 전략: TypeScript 컴파일러(`tsc --noEmit`) + lint 규칙으로 Enum 불일치 즉시 차단
  - 9개 Enum 전체 목록 (45-enum-unified-mapping.md 기준):
    1. TransactionStatus (8값)
    2. TransactionTier (4값)
    3. AgentStatus (5값)
    4. PolicyType (4값)
    5. NotificationChannelType (3값)
    6. AuditLogSeverity (3값)
    7. KillSwitchStatus (3값)
    8. AutoStopRuleType (5값)
    9. AuditLogEventType (별도 패턴 - CHECK 없이 TEXT)
  - 각 Enum에 대해 4곳(TypeScript/Zod/Drizzle/DB CHECK)의 파생 코드 패턴 명시
  - AuditLogEventType 특수 처리: CHECK 제약 없이 TEXT 저장 (설계 의도). `as const` 오브젝트로 관리하되 DB CHECK 미적용. 테스트에서는 사용하는 이벤트 타입이 const object에 포함되는지만 검증.

  **섹션 2: 빌드타임 검증 메커니즘 (ENUM-01 상세)**
  - 1차 방어: `tsc --noEmit` -- 배열 불일치 시 타입 에러 (turbo.json typecheck 태스크로 이미 설정됨)
  - 2차 방어: `z.enum(SSoT_ARRAY)`에서 다른 값 사용 시 컴파일 에러
  - 3차 방어: Drizzle `text('col', { enum: [...SSoT_ARRAY] })` 타입 불일치 감지
  - 4차 방어 (런타임 보완): DB CHECK SQL 생성 유틸리티 `generateCheckConstraint(column, values)` -- SSoT 배열로부터 자동 생성
  - DB CHECK 자동화 판단:
    - `drizzle-kit generate` 산출물에 CHECK 포함 여부를 구현 시 확인하라는 가이드
    - CHECK가 자동 생성되지 않으면: 커스텀 마이그레이션 SQL에서 SSoT 배열 참조
    - 또는: 테스트에서 `PRAGMA table_info` + `sqlite_master`로 CHECK 파싱 후 SSoT 비교
  - Enum 변경 프로세스: SSoT 배열 수정 -> `tsc --noEmit` 통과 확인 -> `drizzle-kit generate`로 마이그레이션 생성 -> CHECK SQL 업데이트

  **섹션 3: Enum 검증 테스트 케이스 (ENUM-01 검증)**
  - 빌드타임 테스트 (tsc):
    - SSoT 배열과 Zod enum이 동일한 값 세트인지 (tsc가 강제)
    - SSoT 배열과 Drizzle text enum이 동일한 값 세트인지 (tsc가 강제)
    - 잘못된 값을 타입에 할당 시 컴파일 에러 발생 확인
  - 런타임 테스트 (Unit):
    - `generateCheckConstraint()` 출력이 기대 SQL과 일치하는지
    - Zod enum에 SSoT에 없는 값 parse 시 에러 발생하는지
    - 9개 Enum의 SSoT 배열 길이/값이 45-enum-unified-mapping.md와 일치하는지 (스냅샷 테스트)
  - Integration 테스트 (DB 레벨):
    - 실제 SQLite 테이블의 CHECK 제약이 SSoT 배열과 일치하는지 (`sqlite_master` 파싱)
    - SSoT에 없는 값 INSERT 시 CHECK 제약 위반 에러 발생하는지
  </action>
  <verify>
  파일이 존재하고, 다음을 포함하는지 확인:
  - "as const" 배열이 SSoT로 명시됨
  - 9개 Enum 전체 목록과 각각의 파생 체인
  - 빌드타임 1차~4차 방어 메커니즘
  - AuditLogEventType 특수 처리 명시
  - Enum 검증 테스트 케이스 (빌드타임 + 런타임 + Integration)
  </verify>
  <done>
  ENUM-01 충족: 9개 Enum의 DB CHECK = Drizzle = Zod = TypeScript 동기화 검증 방법이 빌드타임 우선 전략으로 자동화 가능한 수준으로 정의되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: config.toml 검증 전략 + NOTE-01~11 매핑</name>
  <files>docs/v0.4/49-enum-config-consistency-verification.md</files>
  <action>
  동일 문서 `docs/v0.4/49-enum-config-consistency-verification.md`에 config.toml과 NOTE 매핑 섹션을 추가한다:

  **섹션 4: config.toml 3단계 로딩 검증 전략 (ENUM-02)**
  - 3단계 로딩 순서: 하드코딩 기본값 -> config.toml 파싱(smol-toml) -> 환경변수 오버라이드
  - Zod 스키마 검증: `AppConfigSchema` (DaemonConfig + KeystoreConfig + DatabaseConfig + RpcConfig + NotificationsConfig + SecurityConfig)
  - 테스트 케이스 표 (Given-When-Then 형태):
    1. 기본값만: config.toml 없는 경우 -> 모든 필드 기본값 (port=3100, hostname=127.0.0.1 등)
    2. 부분 오버라이드: port만 있는 config.toml -> port 오버라이드, 나머지 기본값
    3. 환경변수 우선순위: WAIAAS_DAEMON_PORT=5000 + config.toml port=4000 -> 5000 적용
    4. Docker 환경: WAIAAS_DAEMON_HOSTNAME=0.0.0.0 -> hostname 오버라이드 허용
    5. 중첩 섹션: WAIAAS_SECURITY_POLICY_DEFAULTS_DELAY_SECONDS=600 -> security.policy_defaults.delay_seconds=600
    6. 잘못된 값: port=-1 -> Zod 검증 에러 (min(1024) 위반)
    7. 범위 밖: shutdown_timeout=999 -> Zod 검증 에러 (max(300) 위반)
    8. 빈 문자열 환경변수: WAIAAS_DAEMON_PORT="" -> 기본값 또는 에러 (구현 시 결정)
  - 24-monorepo-data-directory.md 섹션 3.2의 환경변수 매핑 표를 SSoT로 사용
  - 환경변수 -> TOML 경로 매핑 규칙: `WAIAAS_` 프리픽스 제거 -> `_`를 `.`으로 변환 -> 소문자화
  - 테스트 레벨: Unit (memfs/mock으로 config.toml 모킹, process.env 조작)

  **섹션 5: NOTE-01~11 테스트 매핑 (ENUM-03)**
  - 16-RESEARCH.md의 NOTE 분류를 기반으로 전체 매핑 표 작성:
    - NOTE-01 (BalanceInfo 단위 변환): O -- Unit 테스트. formatAmount/parseAmount. SOL(9 decimals), ETH(18 decimals). 경계값: 0, 1 lamport, MAX_SAFE_INTEGER, BigInt 범위. 파일: `packages/core/test/unit/format-amount.test.ts`
    - NOTE-02 (알림 채널-정책 연동): O -- Integration 테스트. 활성 채널 0/1/2에서 PolicyEngine 동작 차이. Phase 15 SEC-02-09 시나리오에 흡수 가능 여부 명시.
    - NOTE-03 (MCP-REST 패리티): X -- 문서/매트릭스. MCP 구현 시 커버. 추적만.
    - NOTE-04 (SDK 에러 코드 타입): X -- TypeScript 타입으로 강제. tsc --noEmit이 1차 방어선.
    - NOTE-05 (Tauri IPC+HTTP 에러): X -- Phase 18 범위 (Platform 테스트).
    - NOTE-06 (Setup Wizard vs CLI init): X -- Phase 18 범위 (Platform 테스트).
    - NOTE-07 (Telegram SIWS 대체): X -- 설계 가이드. Telegram Bot 구현 시 커버.
    - NOTE-08 (Docker shutdown 타임라인): O (조건부) -- config.toml 테스트에 흡수. shutdown_timeout 30초 값 범위(5-300) 검증. Docker stop_grace_period 35초와의 관계는 문서 참조만.
    - NOTE-09 (에이전트 상태 v0.1->v0.2): X -- 과거 이력. v0.2 Enum은 이미 SSoT.
    - NOTE-10 (Python SDK snake_case): X -- SDK 구현 시 커버. Phase 16 범위 밖.
    - NOTE-11 (커서 페이지네이션): O -- E2E 테스트에 흡수. UUID v7 커서, cursor/nextCursor 검증. 경계값: 빈 목록, 1건, limit+1건.
  - 테스트 필요 4건(NOTE-01, 02, 08, 11)의 상세 테스트 케이스:
    - 각 NOTE에 3-5개 Given-When-Then 형태 케이스
    - 기존 시나리오에 흡수 가능한 경우 흡수 대상 명시
    - 신규 테스트 파일이 필요한 경우 파일 경로 제안
  - 추적성 매트릭스: NOTE ID -> 테스트 파일/시나리오 ID -> 테스트 레벨

  **섹션 6: 요구사항 충족 매트릭스**
  - ENUM-01~03 각 요구사항이 문서의 어떤 섹션에서 충족되는지 크로스 레퍼런스 표
  - Phase 14 결정과의 정합성 체크 (테스트 레벨, Mock 경계)
  - v0.3 SSoT 문서(45-enum, 24-monorepo)와의 정합성 확인
  </action>
  <verify>
  파일에 다음이 포함되는지 확인:
  - config.toml 테스트 케이스 8건 이상 (기본값/부분오버라이드/환경변수/Docker/중첩/에러)
  - NOTE-01~11 전체 매핑 표 (테스트 필요 4건 + 불필요 7건)
  - 테스트 필요 NOTE의 상세 Given-When-Then 케이스
  - ENUM-01~03 요구사항 충족 매트릭스
  </verify>
  <done>
  ENUM-02 충족: config.toml 검증 전략이 기본값/부분 오버라이드/Docker 환경변수/중첩 섹션/Zod 검증 포함하여 정의되어 있다.
  ENUM-03 충족: NOTE-01~11 중 4건이 테스트 케이스로 매핑되고, 7건이 테스트 불필요로 분류/근거화되어 있다.
  문서 전체가 ENUM-01~03 모든 요구사항을 커버하며, 빌드타임 우선 전략이 관철된 상태.
  </done>
</task>

</tasks>

<verification>
- [ ] `docs/v0.4/49-enum-config-consistency-verification.md` 파일 존재
- [ ] ENUM-01: 9개 Enum SSoT 파생 체인 명세 + 빌드타임 검증 메커니즘 + 테스트 케이스
- [ ] ENUM-01: [LOCKED] 빌드타임 우선 전략 적용 확인 (tsc --noEmit이 1차 방어선)
- [ ] ENUM-01: AuditLogEventType 특수 처리 (CHECK 미적용) 명시
- [ ] ENUM-02: config.toml 테스트 케이스 8건 이상 (기본값/부분/환경변수/Docker/중첩/에러)
- [ ] ENUM-02: 환경변수 매핑 규칙과 24-monorepo SSoT 참조
- [ ] ENUM-03: NOTE-01~11 전체 매핑 (테스트 필요 4건 + 불필요 7건)
- [ ] ENUM-03: 테스트 필요 NOTE의 Given-When-Then 케이스
- [ ] Phase 14 테스트 레벨과 정합 (빌드타임 -> Unit -> Integration)
- [ ] v0.3 SSoT 문서와 정합 (45-enum, 24-monorepo가 검증 대상 기준)
</verification>

<success_criteria>
1. 9개 Enum의 `as const -> TypeScript -> Zod -> Drizzle -> DB CHECK` 파생 체인이 명세되어, 구현 시 이 패턴을 그대로 적용할 수 있음
2. 빌드타임 검증이 1차 방어선으로 명확히 설계되어, `tsc --noEmit` 실행만으로 Enum 불일치를 즉시 발견할 수 있음
3. config.toml 8개 테스트 케이스가 Given-When-Then 형태로 정의되어, 테스트 코드로 직접 변환 가능
4. NOTE-01~11 전체가 테스트 필요/불필요로 분류되고, 필요한 4건의 테스트 케이스와 추적성이 확보됨
</success_criteria>

<output>
After completion, create `.planning/phases/16-blockchain-consistency-verification/16-02-SUMMARY.md`
</output>
