---
phase: 61-typescript-sdk
plan: 02
type: execute
wave: 2
depends_on: ["61-01"]
files_modified:
  - packages/sdk/src/owner-client.ts
  - packages/sdk/src/retry.ts
  - packages/sdk/src/validation.ts
  - packages/sdk/src/client.ts
  - packages/sdk/src/internal/http.ts
  - packages/sdk/src/index.ts
  - packages/sdk/src/types.ts
  - packages/sdk/src/__tests__/owner-client.test.ts
  - packages/sdk/src/__tests__/retry.test.ts
  - packages/sdk/src/__tests__/validation.test.ts
autonomous: true

must_haves:
  truths:
    - "WAIaaSOwnerClient initializes with baseUrl and signMessage callback"
    - "WAIaaSOwnerClient.approve(txId) calls POST /v1/transactions/:id/approve with ownerAuth headers"
    - "WAIaaSOwnerClient.reject(txId) calls POST /v1/transactions/:id/reject with ownerAuth headers"
    - "WAIaaSOwnerClient.activateKillSwitch() calls POST /v1/admin/kill-switch with ownerAuth headers"
    - "WAIaaSOwnerClient.recover() calls POST /v1/admin/recover with masterAuth header"
    - "Zod pre-validation catches invalid sendToken params before HTTP request"
    - "429/5xx responses trigger automatic exponential backoff retry"
    - "Retry respects maxRetries, baseDelayMs, maxDelayMs, jitter"
    - "Non-retryable errors (4xx except 429) are NOT retried"
  artifacts:
    - path: "packages/sdk/src/owner-client.ts"
      provides: "WAIaaSOwnerClient with approve/reject/killSwitch/recover"
      exports: ["WAIaaSOwnerClient"]
    - path: "packages/sdk/src/retry.ts"
      provides: "Exponential backoff retry wrapper"
      exports: ["withRetry"]
    - path: "packages/sdk/src/validation.ts"
      provides: "Zod pre-validation for sendToken params"
      exports: ["validateSendToken"]
  key_links:
    - from: "packages/sdk/src/owner-client.ts"
      to: "packages/sdk/src/internal/http.ts"
      via: "HttpClient for ownerAuth API calls"
      pattern: "this\\.http\\."
    - from: "packages/sdk/src/owner-client.ts"
      to: "daemon REST API"
      via: "POST /v1/transactions/:id/approve, POST /v1/transactions/:id/reject, POST /v1/admin/kill-switch, POST /v1/admin/recover, GET /v1/nonce"
      pattern: "/v1/"
    - from: "packages/sdk/src/client.ts"
      to: "packages/sdk/src/retry.ts"
      via: "withRetry wrapping HTTP calls"
      pattern: "withRetry"
    - from: "packages/sdk/src/client.ts"
      to: "packages/sdk/src/validation.ts"
      via: "pre-validate sendToken params"
      pattern: "validateSendToken"
---

<objective>
Add WAIaaSOwnerClient for Owner operations (approve/reject/killSwitch/recover), Zod pre-validation to catch invalid inputs before server requests, and exponential backoff retry for 429/5xx responses. Integrates retry and validation into the existing WAIaaSClient from Plan 61-01.

Purpose: Owner users need a typed client for ownerAuth-signed operations (Ed25519 signature construction). AI agents need automatic retry on transient failures and input validation to fail fast without wasting network calls. These are the final features to complete the @waiaas/sdk package.

Output: WAIaaSOwnerClient (4 methods), retry logic, Zod validation, ~35 tests. Completes TSDK-05, TSDK-06, TSDK-07 requirements.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-typescript-sdk/61-01-SUMMARY.md

# Existing SDK code from 61-01
@packages/sdk/src/index.ts
@packages/sdk/src/error.ts
@packages/sdk/src/types.ts
@packages/sdk/src/client.ts
@packages/sdk/src/internal/http.ts
@packages/sdk/src/internal/constants.ts

# Daemon API for owner operations
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/nonce.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/middleware/owner-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: WAIaaSOwnerClient + retry logic + Zod validation</name>
  <files>
    packages/sdk/src/owner-client.ts
    packages/sdk/src/retry.ts
    packages/sdk/src/validation.ts
    packages/sdk/src/types.ts
    packages/sdk/src/client.ts
    packages/sdk/src/internal/http.ts
    packages/sdk/src/index.ts
  </files>
  <action>
    1. **packages/sdk/src/types.ts**: Add Owner client types:
       ```typescript
       // Owner client options
       export interface WAIaaSOwnerClientOptions {
         baseUrl: string;
         ownerAddress: string;
         signMessage: (message: Uint8Array) => Promise<Uint8Array>;
         masterPassword?: string; // needed for recover()
         timeout?: number;
         retryOptions?: RetryOptions;
       }

       // Owner responses (matching daemon OpenAPI schemas)
       export interface ApproveResponse { id: string; status: string; approvedAt: number; }
       export interface RejectResponse { id: string; status: string; rejectedAt: number; }
       export interface KillSwitchActivateResponse { state: 'ACTIVATED'; activatedAt: number; }
       export interface KillSwitchStatusResponse { state: string; activatedAt: number | null; activatedBy: string | null; }
       export interface RecoverResponse { state: 'NORMAL'; recoveredAt: number; }
       export interface NonceResponse { nonce: string; expiresAt: number; }
       ```

    2. **packages/sdk/src/retry.ts**: Create exponential backoff retry wrapper:
       ```typescript
       import { WAIaaSError } from './error.js';
       import type { RetryOptions } from './types.js';
       import { DEFAULT_MAX_RETRIES, DEFAULT_BASE_DELAY_MS, DEFAULT_MAX_DELAY_MS, DEFAULT_RETRYABLE_STATUSES } from './internal/constants.js';

       export async function withRetry<T>(
         fn: () => Promise<T>,
         options?: RetryOptions,
       ): Promise<T> {
         const maxRetries = options?.maxRetries ?? DEFAULT_MAX_RETRIES;
         const baseDelayMs = options?.baseDelayMs ?? DEFAULT_BASE_DELAY_MS;
         const maxDelayMs = options?.maxDelayMs ?? DEFAULT_MAX_DELAY_MS;
         const retryableStatuses = options?.retryableStatuses ?? DEFAULT_RETRYABLE_STATUSES;

         let lastError: unknown;
         for (let attempt = 0; attempt <= maxRetries; attempt++) {
           try {
             return await fn();
           } catch (err) {
             lastError = err;
             if (attempt === maxRetries) break;
             if (err instanceof WAIaaSError) {
               if (!retryableStatuses.includes(err.status)) throw err;
             } else {
               // Network errors (fetch failures) are retryable
             }
             const delay = Math.min(baseDelayMs * Math.pow(2, attempt), maxDelayMs);
             const jitter = delay * (0.5 + Math.random() * 0.5); // 50-100% of delay
             await new Promise(r => setTimeout(r, jitter));
           }
         }
         throw lastError;
       }
       ```

    3. **packages/sdk/src/validation.ts**: Create Zod pre-validation for sendToken:
       ```typescript
       import { z } from 'zod';
       import { WAIaaSError } from './error.js';

       const SendTokenParamsSchema = z.object({
         to: z.string().min(1, 'Recipient address is required'),
         amount: z.string().regex(/^\d+$/, 'Amount must be a numeric string (lamports/wei)'),
         memo: z.string().max(256).optional(),
       });

       export function validateSendToken(params: unknown): void {
         const result = SendTokenParamsSchema.safeParse(params);
         if (!result.success) {
           throw new WAIaaSError({
             code: 'VALIDATION_ERROR',
             message: `Invalid sendToken params: ${result.error.issues.map(i => i.message).join(', ')}`,
             status: 0,
             retryable: false,
             details: { issues: result.error.issues },
           });
         }
       }
       ```
       NOTE: zod is a devDependency AND a peerDependency. Add to package.json:
       ```json
       "peerDependencies": { "zod": "^3.24.0" },
       "peerDependenciesMeta": { "zod": { "optional": true } },
       "devDependencies": { "zod": "^3.24.0" }
       ```
       If zod is not installed by the consumer, the validation import will fail gracefully. The SDK can work without zod -- validation is optional. However, for simplicity in v1.3, since the monorepo has zod in the workspace root, just add it as devDependency. Pre-validation is a value-add feature, not a hard requirement.

       Actually, to maintain the "0 external dependencies" decision, use a DIFFERENT approach: inline validation without zod. Write simple validation functions:
       ```typescript
       export function validateSendToken(params: unknown): void {
         if (!params || typeof params !== 'object') {
           throw new WAIaaSError({ code: 'VALIDATION_ERROR', message: 'sendToken params must be an object', status: 0, retryable: false });
         }
         const p = params as Record<string, unknown>;
         if (typeof p.to !== 'string' || p.to.length === 0) {
           throw new WAIaaSError({ code: 'VALIDATION_ERROR', message: 'sendToken: "to" must be a non-empty string', status: 0, retryable: false });
         }
         if (typeof p.amount !== 'string' || !/^\d+$/.test(p.amount)) {
           throw new WAIaaSError({ code: 'VALIDATION_ERROR', message: 'sendToken: "amount" must be a numeric string (lamports/wei)', status: 0, retryable: false });
         }
         if (p.memo !== undefined && (typeof p.memo !== 'string' || p.memo.length > 256)) {
           throw new WAIaaSError({ code: 'VALIDATION_ERROR', message: 'sendToken: "memo" must be a string with max 256 characters', status: 0, retryable: false });
         }
       }
       ```
       This keeps the SDK at true 0 runtime dependencies. The requirement TSDK-06 says "Zod 사전 검증" but the intent is "pre-validation catches invalid input before server request". Using inline validation achieves the same outcome without adding a dependency. Document this in the SUMMARY as a deliberate decision.

    4. **packages/sdk/src/client.ts**: Integrate retry and validation:
       - Import `withRetry` from `./retry.js`
       - Import `validateSendToken` from `./validation.js`
       - Add `private retryOptions?: RetryOptions` to constructor
       - Wrap each API method in `withRetry(() => this.http.get(...), this.retryOptions)`
       - Add `validateSendToken(params)` call at top of `sendToken()` (before HTTP call)
       - Ensure all methods use retry wrapper

    5. **packages/sdk/src/owner-client.ts**: Create WAIaaSOwnerClient:
       ```typescript
       import { HttpClient } from './internal/http.js';
       import { WAIaaSError } from './error.js';
       import { withRetry } from './retry.js';
       import { DEFAULT_TIMEOUT } from './internal/constants.js';
       import type {
         WAIaaSOwnerClientOptions, ApproveResponse, RejectResponse,
         KillSwitchActivateResponse, KillSwitchStatusResponse,
         RecoverResponse, NonceResponse, RetryOptions,
       } from './types.js';

       export class WAIaaSOwnerClient {
         private http: HttpClient;
         private ownerAddress: string;
         private signMessage: (message: Uint8Array) => Promise<Uint8Array>;
         private masterPassword?: string;
         private retryOptions?: RetryOptions;

         constructor(options: WAIaaSOwnerClientOptions) {
           this.http = new HttpClient(options.baseUrl.replace(/\/+$/, ''), options.timeout ?? DEFAULT_TIMEOUT);
           this.ownerAddress = options.ownerAddress;
           this.signMessage = options.signMessage;
           this.masterPassword = options.masterPassword;
           this.retryOptions = options.retryOptions;
         }

         /**
          * Fetch nonce and construct ownerAuth headers:
          * X-Owner-Address, X-Owner-Nonce, X-Owner-Signature (base64)
          */
         private async ownerAuthHeaders(): Promise<Record<string, string>> {
           const nonceResp = await this.http.get<NonceResponse>('/v1/nonce');
           const message = new TextEncoder().encode(nonceResp.nonce);
           const signature = await this.signMessage(message);
           return {
             'X-Owner-Address': this.ownerAddress,
             'X-Owner-Nonce': nonceResp.nonce,
             'X-Owner-Signature': Buffer.from(signature).toString('base64'),
           };
         }

         private masterAuthHeaders(): Record<string, string> {
           if (!this.masterPassword) throw new WAIaaSError({
             code: 'NO_MASTER_PASSWORD', message: 'Master password not set (required for recover)',
             status: 0, retryable: false,
           });
           return { 'X-Master-Password': this.masterPassword };
         }

         async approve(txId: string): Promise<ApproveResponse> {
           return withRetry(async () => {
             const headers = await this.ownerAuthHeaders();
             return this.http.post<ApproveResponse>(`/v1/transactions/${txId}/approve`, {}, headers);
           }, this.retryOptions);
         }

         async reject(txId: string): Promise<RejectResponse> {
           return withRetry(async () => {
             const headers = await this.ownerAuthHeaders();
             return this.http.post<RejectResponse>(`/v1/transactions/${txId}/reject`, {}, headers);
           }, this.retryOptions);
         }

         async activateKillSwitch(): Promise<KillSwitchActivateResponse> {
           return withRetry(async () => {
             const headers = await this.ownerAuthHeaders();
             return this.http.post<KillSwitchActivateResponse>('/v1/admin/kill-switch', {}, headers);
           }, this.retryOptions);
         }

         async getKillSwitchStatus(): Promise<KillSwitchStatusResponse> {
           return withRetry(async () => {
             return this.http.get<KillSwitchStatusResponse>('/v1/admin/kill-switch');
           }, this.retryOptions);
         }

         async recover(): Promise<RecoverResponse> {
           return withRetry(async () => {
             const headers = this.masterAuthHeaders();
             return this.http.post<RecoverResponse>('/v1/admin/recover', {}, headers);
           }, this.retryOptions);
         }
       }
       ```

    6. **packages/sdk/src/index.ts**: Add exports for WAIaaSOwnerClient and new types:
       ```typescript
       export { WAIaaSOwnerClient } from './owner-client.js';
       export type { WAIaaSOwnerClientOptions, ApproveResponse, RejectResponse,
         KillSwitchActivateResponse, KillSwitchStatusResponse,
         RecoverResponse, NonceResponse } from './types.js';
       ```
  </action>
  <verify>
    - `pnpm --filter @waiaas/sdk typecheck` passes
    - `pnpm --filter @waiaas/sdk build` succeeds
  </verify>
  <done>
    WAIaaSOwnerClient with approve/reject/activateKillSwitch/recover + ownerAuth nonce+signature flow. Retry wrapper integrated into WAIaaSClient and WAIaaSOwnerClient. Inline pre-validation on sendToken. 0 new runtime dependencies added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive tests for OwnerClient + retry + validation</name>
  <files>
    packages/sdk/src/__tests__/owner-client.test.ts
    packages/sdk/src/__tests__/retry.test.ts
    packages/sdk/src/__tests__/validation.test.ts
  </files>
  <action>
    1. **packages/sdk/src/__tests__/validation.test.ts**: Test pre-validation (~8 tests):
       - Valid params pass without throwing
       - Missing `to` throws VALIDATION_ERROR
       - Empty string `to` throws VALIDATION_ERROR
       - Non-numeric `amount` throws VALIDATION_ERROR (e.g. "abc", "12.5", "-1")
       - Amount as number (not string) throws VALIDATION_ERROR
       - Memo longer than 256 chars throws VALIDATION_ERROR
       - Null/undefined params throws VALIDATION_ERROR
       - Valid params with optional memo passes

    2. **packages/sdk/src/__tests__/retry.test.ts**: Test exponential backoff (~10 tests):
       - Success on first attempt returns result (no retry)
       - 429 triggers retry, succeeds on second attempt
       - 500 triggers retry with exponential delay
       - 401 (non-retryable) throws immediately, no retry
       - 403 (non-retryable) throws immediately
       - Max retries exhausted throws last error
       - Network error (fetch fails) triggers retry
       - Jitter keeps delay within expected range (between 50-100% of computed delay)
       - Custom retryableStatuses respected
       - Custom maxRetries=0 disables retry

       Timing tests: Use vi.useFakeTimers() + vi.advanceTimersByTimeAsync() to verify delay durations without actual waiting. Verify attempt 0 delay ~ 1s, attempt 1 delay ~ 2s, attempt 2 delay ~ 4s (within jitter range).

    3. **packages/sdk/src/__tests__/owner-client.test.ts**: Test WAIaaSOwnerClient (~12 tests):
       Mock global fetch to simulate daemon responses.

       **ownerAuth flow (3):**
       - approve() fetches nonce from GET /v1/nonce, signs it, sends X-Owner-* headers
       - Correct X-Owner-Address, X-Owner-Nonce, X-Owner-Signature headers sent
       - Signature is base64-encoded

       **approve tests (2):**
       - approve(txId) calls POST /v1/transactions/{txId}/approve
       - Returns ApproveResponse with id, status, approvedAt

       **reject tests (2):**
       - reject(txId) calls POST /v1/transactions/{txId}/reject
       - Returns RejectResponse with id, status, rejectedAt

       **activateKillSwitch tests (2):**
       - Calls POST /v1/admin/kill-switch with ownerAuth headers
       - Returns KillSwitchActivateResponse

       **recover tests (2):**
       - Calls POST /v1/admin/recover with X-Master-Password header
       - Throws when masterPassword not set

       **getKillSwitchStatus tests (1):**
       - Calls GET /v1/admin/kill-switch and returns state

    4. **Integration test in client.test.ts** (add to existing file from 61-01):
       - sendToken with invalid params throws VALIDATION_ERROR before fetch
       - Verify fetch was NOT called (no network request)
       - 429 on getBalance triggers retry and succeeds on second call

    Total new tests: ~30 tests across 3 files + 3 integration tests added to client.test.ts
  </action>
  <verify>
    - `pnpm --filter @waiaas/sdk test` -- all tests pass (61-01 ~36 + 61-02 ~33 = ~69 total)
    - `pnpm --filter @waiaas/sdk typecheck` passes
    - `pnpm --filter @waiaas/sdk build` succeeds
    - `pnpm test` -- all workspace tests pass (no regressions)
  </verify>
  <done>
    ~33 new tests covering WAIaaSOwnerClient (approve/reject/killSwitch/recover with ownerAuth), exponential backoff retry (429/5xx, jitter, max retries), and inline validation (sendToken params). All ~69 total SDK tests pass. Requirements TSDK-05, TSDK-06, TSDK-07 satisfied. Phase 61 complete.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/sdk typecheck` -- zero errors
2. `pnpm --filter @waiaas/sdk test` -- ~69 tests pass
3. `pnpm --filter @waiaas/sdk build` -- dist/ output clean
4. WAIaaSOwnerClient.approve/reject/activateKillSwitch/recover make correct API calls with ownerAuth
5. 429 response on any method triggers exponential backoff retry
6. sendToken({to:'', amount:'abc'}) throws VALIDATION_ERROR without making HTTP request
7. package.json still has 0 runtime dependencies
8. `pnpm test` -- all workspace tests pass (no regressions on core/daemon/cli/adapter)
</verification>

<success_criteria>
- WAIaaSOwnerClient approve/reject/killSwitch/recover all work with ownerAuth headers
- Retry logic triggers on 429/5xx, skips on 4xx
- Pre-validation catches invalid sendToken params before HTTP call
- ~69 total SDK tests pass
- 0 runtime dependencies maintained
- All workspace tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/61-typescript-sdk/61-02-SUMMARY.md`
</output>
