---
phase: 61-typescript-sdk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/sdk/package.json
  - packages/sdk/tsconfig.json
  - packages/sdk/src/index.ts
  - packages/sdk/src/error.ts
  - packages/sdk/src/types.ts
  - packages/sdk/src/internal/http.ts
  - packages/sdk/src/internal/constants.ts
  - packages/sdk/src/client.ts
  - packages/sdk/src/__tests__/client.test.ts
  - packages/sdk/src/__tests__/error.test.ts
  - pnpm-workspace.yaml
autonomous: true

must_haves:
  truths:
    - "WAIaaSClient initializes with baseUrl and sessionToken"
    - "getBalance() returns wallet balance (agentId, chain, balance, decimals, symbol)"
    - "getAddress() returns wallet address (agentId, chain, address)"
    - "getAssets() returns asset list (agentId, chain, assets[])"
    - "sendToken() sends TRANSFER request and returns {id, status}"
    - "getTransaction() returns transaction detail by ID"
    - "listTransactions() returns paginated transaction list with cursor"
    - "listPendingTransactions() returns pending transactions"
    - "renewSession() returns renewed token and expiresAt"
    - "WAIaaSError contains code, message, status, retryable, hint properties"
    - "setSessionToken() / clearSessionToken() update internal token"
  artifacts:
    - path: "packages/sdk/package.json"
      provides: "@waiaas/sdk package with 0 runtime dependencies (only zod devDep for types)"
      contains: "@waiaas/sdk"
    - path: "packages/sdk/src/client.ts"
      provides: "WAIaaSClient class with 9 methods"
      exports: ["WAIaaSClient"]
    - path: "packages/sdk/src/error.ts"
      provides: "WAIaaSError for SDK consumers"
      exports: ["WAIaaSError"]
    - path: "packages/sdk/src/internal/http.ts"
      provides: "fetch wrapper with JSON parsing and error mapping"
      exports: ["httpClient"]
    - path: "packages/sdk/src/types.ts"
      provides: "SDK type definitions for responses and options"
      exports: ["WAIaaSClientOptions", "BalanceResponse", "AddressResponse", "AssetsResponse", "SendTokenParams", "SendTokenResponse", "TransactionResponse", "TransactionListResponse", "PendingTransactionsResponse", "RenewSessionResponse"]
  key_links:
    - from: "packages/sdk/src/client.ts"
      to: "packages/sdk/src/internal/http.ts"
      via: "httpClient calls for all API methods"
      pattern: "this\\.http\\."
    - from: "packages/sdk/src/internal/http.ts"
      to: "packages/sdk/src/error.ts"
      via: "maps non-2xx responses to WAIaaSError"
      pattern: "WAIaaSError"
    - from: "packages/sdk/src/client.ts"
      to: "daemon REST API"
      via: "GET /v1/wallet/balance, GET /v1/wallet/address, GET /v1/wallet/assets, POST /v1/transactions/send, GET /v1/transactions/:id, GET /v1/transactions, GET /v1/transactions/pending, PUT /v1/sessions/:id/renew"
      pattern: "/v1/"
---

<objective>
Create the @waiaas/sdk package with WAIaaSClient class that wraps the 33-endpoint REST API for AI agent developers. This plan covers the core agent client (wallet queries, token sending, transaction history, session renewal) plus the SDK error class and HTTP fetch layer.

Purpose: AI agents need a typed, zero-dependency TypeScript SDK to interact with the WAIaaS daemon programmatically. The SDK abstracts HTTP calls, provides WAIaaSError with code/message/status/retryable/hint for programmatic error handling, and uses Node.js 22 built-in fetch (no external HTTP libraries).

Output: @waiaas/sdk package with WAIaaSClient (9 methods), WAIaaSError, typed responses, HTTP layer, ~40 tests
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-rest-api-expansion/59-01-SUMMARY.md
@.planning/phases/59-rest-api-expansion/59-02-SUMMARY.md

# Existing codebase patterns
@packages/core/package.json
@packages/core/tsconfig.json
@packages/core/src/errors/base-error.ts
@packages/core/src/errors/error-codes.ts
@packages/core/src/schemas/transaction.schema.ts
@packages/core/src/schemas/session.schema.ts
@packages/core/src/schemas/asset.schema.ts
@packages/core/src/schemas/agent.schema.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/transactions.ts
@tsconfig.base.json
@pnpm-workspace.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold @waiaas/sdk package + WAIaaSError + HTTP layer + types</name>
  <files>
    packages/sdk/package.json
    packages/sdk/tsconfig.json
    packages/sdk/src/index.ts
    packages/sdk/src/error.ts
    packages/sdk/src/types.ts
    packages/sdk/src/internal/http.ts
    packages/sdk/src/internal/constants.ts
    packages/sdk/src/__tests__/error.test.ts
    pnpm-workspace.yaml
  </files>
  <action>
    1. **pnpm-workspace.yaml**: Already has `packages/*` glob, so packages/sdk/ is auto-detected. No change needed.

    2. **packages/sdk/package.json**: Create ESM-only package following @waiaas/core pattern:
       - name: `@waiaas/sdk`, version `0.0.0`, type: `module`
       - main: `dist/index.js`, types: `dist/index.d.ts`
       - exports map: `.` -> import + types
       - scripts: build (tsc), test (vitest run), lint, typecheck, clean
       - **ZERO runtime dependencies** -- do NOT add zod as a dependency. The SDK uses its own lightweight validation in Plan 61-02, or imports zod as devDependency only for testing.
       - devDependencies: vitest (workspace reference)
       - engines: node >= 22.0.0

    3. **packages/sdk/tsconfig.json**: Extend ../../tsconfig.base.json, composite: true, outDir: dist, rootDir: src. Same pattern as @waiaas/core.

    4. **packages/sdk/src/error.ts**: Create SDK-side WAIaaSError class (standalone, NOT importing from @waiaas/core):
       ```typescript
       export class WAIaaSError extends Error {
         readonly code: string;
         readonly status: number;
         readonly retryable: boolean;
         readonly details?: Record<string, unknown>;
         readonly requestId?: string;
         readonly hint?: string;

         constructor(opts: {
           code: string;
           message: string;
           status: number;
           retryable: boolean;
           details?: Record<string, unknown>;
           requestId?: string;
           hint?: string;
         }) { ... }

         get isRetryable(): boolean { return this.retryable; }

         static fromResponse(body: unknown, status: number): WAIaaSError {
           // Parse error response body { code, message, retryable, details, requestId, hint }
           // Fallback for non-JSON responses
         }
       }
       ```
       This is a SEPARATE class from @waiaas/core's WAIaaSError. The SDK must have zero dependency on @waiaas/core. The fromResponse() static method parses API error JSON into the class.

    5. **packages/sdk/src/types.ts**: Define response types matching the daemon's OpenAPI schemas:
       ```typescript
       // Client options
       export interface WAIaaSClientOptions {
         baseUrl: string;
         sessionToken?: string;
         timeout?: number; // default 30000ms
         retryOptions?: RetryOptions;
       }
       export interface RetryOptions {
         maxRetries?: number;     // default 3
         baseDelayMs?: number;    // default 1000
         maxDelayMs?: number;     // default 30000
         retryableStatuses?: number[]; // default [429, 500, 502, 503, 504]
       }

       // Wallet responses
       export interface BalanceResponse {
         agentId: string; chain: string; network: string; address: string;
         balance: string; decimals: number; symbol: string;
       }
       export interface AddressResponse {
         agentId: string; chain: string; network: string; address: string;
       }
       export interface AssetInfo {
         mint: string; symbol: string; name: string; balance: string;
         decimals: number; isNative: boolean; usdValue?: number;
       }
       export interface AssetsResponse {
         agentId: string; chain: string; network: string; assets: AssetInfo[];
       }

       // Transaction types
       export interface SendTokenParams { to: string; amount: string; memo?: string; }
       export interface SendTokenResponse { id: string; status: string; }
       export interface TransactionResponse {
         id: string; agentId: string; type: string; status: string;
         tier: string | null; chain: string; toAddress: string | null;
         amount: string | null; txHash: string | null; error: string | null;
         createdAt: number | null;
       }
       export interface TransactionListResponse {
         items: TransactionResponse[]; cursor: string | null; hasMore: boolean;
       }
       export interface ListTransactionsParams { cursor?: string; limit?: number; }
       export interface PendingTransactionsResponse { items: TransactionResponse[]; }

       // Session types
       export interface RenewSessionResponse {
         id: string; token: string; expiresAt: number; renewalCount: number;
       }
       ```

    6. **packages/sdk/src/internal/constants.ts**: Default values:
       ```typescript
       export const DEFAULT_TIMEOUT = 30_000;
       export const DEFAULT_BASE_DELAY_MS = 1000;
       export const DEFAULT_MAX_DELAY_MS = 30_000;
       export const DEFAULT_MAX_RETRIES = 3;
       export const DEFAULT_RETRYABLE_STATUSES = [429, 500, 502, 503, 504];
       export const SDK_VERSION = '0.0.0';
       export const USER_AGENT = `waiaas-sdk/${SDK_VERSION}`;
       ```

    7. **packages/sdk/src/internal/http.ts**: Create HttpClient class wrapping Node.js 22 fetch:
       ```typescript
       export class HttpClient {
         constructor(private baseUrl: string, private timeout: number) {}

         setBaseUrl(url: string): void { ... }

         async request<T>(method: string, path: string, opts?: {
           body?: unknown;
           headers?: Record<string, string>;
           signal?: AbortSignal;
         }): Promise<T> {
           const url = `${this.baseUrl}${path}`;
           const controller = new AbortController();
           const timeoutId = setTimeout(() => controller.abort(), this.timeout);
           try {
             const res = await fetch(url, {
               method,
               headers: {
                 'Content-Type': 'application/json',
                 'User-Agent': USER_AGENT,
                 ...opts?.headers,
               },
               body: opts?.body ? JSON.stringify(opts.body) : undefined,
               signal: opts?.signal ?? controller.signal,
             });
             if (!res.ok) {
               const body = await res.json().catch(() => null);
               throw WAIaaSError.fromResponse(body, res.status);
             }
             return (await res.json()) as T;
           } finally {
             clearTimeout(timeoutId);
           }
         }

         async get<T>(path: string, headers?: Record<string, string>): Promise<T> { ... }
         async post<T>(path: string, body: unknown, headers?: Record<string, string>): Promise<T> { ... }
         async put<T>(path: string, body: unknown, headers?: Record<string, string>): Promise<T> { ... }
         async delete<T>(path: string, headers?: Record<string, string>): Promise<T> { ... }
       }
       ```
       The HttpClient is intentionally simple. Retry logic will be added in Plan 61-02 as a wrapper/decorator.

    8. **packages/sdk/src/index.ts**: Public API barrel export:
       ```typescript
       export { WAIaaSClient } from './client.js';
       export { WAIaaSError } from './error.js';
       export type { WAIaaSClientOptions, RetryOptions, BalanceResponse, AddressResponse,
         AssetsResponse, AssetInfo, SendTokenParams, SendTokenResponse,
         TransactionResponse, TransactionListResponse, ListTransactionsParams,
         PendingTransactionsResponse, RenewSessionResponse } from './types.js';
       // WAIaaSOwnerClient will be added in 61-02
       ```

    9. **packages/sdk/src/__tests__/error.test.ts**: Test WAIaaSError:
       - fromResponse() with valid JSON body creates correct code/message/status/retryable/hint
       - fromResponse() with non-JSON body creates fallback error
       - fromResponse() with partial body uses defaults
       - Properties are all readonly
       - isRetryable getter works
       - name property is 'WAIaaSError'

    10. Run `pnpm install` to link the new package in the workspace.
  </action>
  <verify>
    - `ls packages/sdk/package.json` exists
    - `pnpm --filter @waiaas/sdk typecheck` passes
    - `pnpm --filter @waiaas/sdk test` passes (error tests)
    - package.json has ZERO runtime dependencies
  </verify>
  <done>
    @waiaas/sdk package scaffolded with WAIaaSError (code/message/status/retryable/hint), typed responses matching daemon OpenAPI schemas, HTTP fetch layer, and 6+ error tests passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: WAIaaSClient implementation + comprehensive tests</name>
  <files>
    packages/sdk/src/client.ts
    packages/sdk/src/__tests__/client.test.ts
  </files>
  <action>
    1. **packages/sdk/src/client.ts**: Implement WAIaaSClient class:
       ```typescript
       import { HttpClient } from './internal/http.js';
       import { DEFAULT_TIMEOUT } from './internal/constants.js';
       import type {
         WAIaaSClientOptions, BalanceResponse, AddressResponse, AssetsResponse,
         SendTokenParams, SendTokenResponse, TransactionResponse,
         TransactionListResponse, ListTransactionsParams,
         PendingTransactionsResponse, RenewSessionResponse,
       } from './types.js';

       export class WAIaaSClient {
         private http: HttpClient;
         private sessionToken: string | undefined;
         private sessionId: string | undefined;

         constructor(options: WAIaaSClientOptions) {
           this.http = new HttpClient(
             options.baseUrl.replace(/\/+$/, ''),  // strip trailing slash
             options.timeout ?? DEFAULT_TIMEOUT,
           );
           this.sessionToken = options.sessionToken;
         }

         // --- Token management ---
         setSessionToken(token: string): void { this.sessionToken = token; }
         clearSessionToken(): void { this.sessionToken = undefined; this.sessionId = undefined; }

         private authHeaders(): Record<string, string> {
           if (!this.sessionToken) throw new WAIaaSError({ code: 'NO_TOKEN', message: 'No session token set', status: 0, retryable: false });
           return { Authorization: `Bearer ${this.sessionToken}` };
         }

         // --- Wallet queries ---
         async getBalance(): Promise<BalanceResponse> {
           return this.http.get<BalanceResponse>('/v1/wallet/balance', this.authHeaders());
         }

         async getAddress(): Promise<AddressResponse> {
           return this.http.get<AddressResponse>('/v1/wallet/address', this.authHeaders());
         }

         async getAssets(): Promise<AssetsResponse> {
           return this.http.get<AssetsResponse>('/v1/wallet/assets', this.authHeaders());
         }

         // --- Transaction operations ---
         async sendToken(params: SendTokenParams): Promise<SendTokenResponse> {
           return this.http.post<SendTokenResponse>(
             '/v1/transactions/send',
             params,
             this.authHeaders(),
           );
         }

         async getTransaction(id: string): Promise<TransactionResponse> {
           return this.http.get<TransactionResponse>(`/v1/transactions/${id}`, this.authHeaders());
         }

         async listTransactions(params?: ListTransactionsParams): Promise<TransactionListResponse> {
           const query = new URLSearchParams();
           if (params?.cursor) query.set('cursor', params.cursor);
           if (params?.limit) query.set('limit', String(params.limit));
           const qs = query.toString();
           return this.http.get<TransactionListResponse>(
             `/v1/transactions${qs ? `?${qs}` : ''}`,
             this.authHeaders(),
           );
         }

         async listPendingTransactions(): Promise<PendingTransactionsResponse> {
           return this.http.get<PendingTransactionsResponse>(
             '/v1/transactions/pending',
             this.authHeaders(),
           );
         }

         // --- Session management ---
         async renewSession(): Promise<RenewSessionResponse> {
           if (!this.sessionId) {
             // Extract session ID from JWT payload (base64 decode middle segment)
             this.sessionId = this.extractSessionId();
           }
           const result = await this.http.put<RenewSessionResponse>(
             `/v1/sessions/${this.sessionId}/renew`,
             {},
             this.authHeaders(),
           );
           // Auto-update token after successful renewal
           this.sessionToken = result.token;
           return result;
         }

         private extractSessionId(): string {
           if (!this.sessionToken) throw new WAIaaSError({ code: 'NO_TOKEN', message: 'No session token set', status: 0, retryable: false });
           try {
             const payload = this.sessionToken.split('.')[1];
             if (!payload) throw new Error('Invalid token format');
             const decoded = JSON.parse(
               Buffer.from(payload, 'base64url').toString('utf-8'),
             );
             if (!decoded.sessionId) throw new Error('No sessionId in token');
             return decoded.sessionId as string;
           } catch {
             throw new WAIaaSError({
               code: 'INVALID_TOKEN', message: 'Cannot extract session ID from token',
               status: 0, retryable: false,
             });
           }
         }
       }
       ```

    2. **packages/sdk/src/__tests__/client.test.ts**: Comprehensive tests using a mock HTTP server approach. Use Vitest's vi.fn() to mock global fetch:

       **Initialization tests (3):**
       - Constructs with baseUrl and sessionToken
       - Strips trailing slash from baseUrl
       - Throws WAIaaSError when calling method without token set

       **getBalance tests (3):**
       - Returns BalanceResponse on 200
       - Sends Authorization Bearer header
       - Throws WAIaaSError on 401

       **getAddress tests (2):**
       - Returns AddressResponse on 200
       - Sends correct GET /v1/wallet/address path

       **getAssets tests (2):**
       - Returns AssetsResponse with assets array on 200
       - Sends correct GET /v1/wallet/assets path

       **sendToken tests (3):**
       - Returns SendTokenResponse on 200/201
       - Sends POST body with to/amount/memo
       - Throws WAIaaSError with hint on 400

       **getTransaction tests (2):**
       - Returns TransactionResponse on 200
       - Includes transaction ID in path

       **listTransactions tests (3):**
       - Returns paginated list on 200
       - Passes cursor and limit as query params
       - Works with no params (empty query string)

       **listPendingTransactions tests (2):**
       - Returns pending items array on 200
       - Calls correct /v1/transactions/pending path

       **renewSession tests (4):**
       - Extracts sessionId from JWT and calls PUT /v1/sessions/:id/renew
       - Auto-updates sessionToken after successful renewal
       - Throws on invalid token format
       - Re-uses cached sessionId on subsequent calls

       **Token management tests (3):**
       - setSessionToken() updates internal token
       - clearSessionToken() clears token and sessionId
       - After setSessionToken(), next call uses new token in headers

       **HTTP layer tests (3):**
       - Timeout AbortController fires after configured timeout
       - Non-JSON error response creates fallback WAIaaSError
       - User-Agent header sent with SDK version

       Mocking strategy: Override global fetch with vi.fn() that returns mock Response objects. Each test sets up specific mock responses. Use vi.restoreAllMocks() in afterEach.

       Total: ~30 test cases
  </action>
  <verify>
    - `pnpm --filter @waiaas/sdk typecheck` passes
    - `pnpm --filter @waiaas/sdk test` passes (all ~36 tests)
    - `pnpm --filter @waiaas/sdk build` succeeds
  </verify>
  <done>
    WAIaaSClient class with 9 API methods (getBalance, getAddress, getAssets, sendToken, getTransaction, listTransactions, listPendingTransactions, renewSession) + token management (setSessionToken, clearSessionToken) + auto token renewal on renewSession(). ~36 tests passing. Requirements TSDK-01 through TSDK-04 and TSDK-08 satisfied.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/sdk typecheck` -- TypeScript compilation passes
2. `pnpm --filter @waiaas/sdk test` -- All tests pass (~36)
3. `pnpm --filter @waiaas/sdk build` -- Build output in dist/
4. package.json has 0 runtime dependencies
5. WAIaaSError has code, message, status, retryable, hint properties
6. WAIaaSClient.getBalance/getAddress/getAssets/sendToken/getTransaction/listTransactions/listPendingTransactions/renewSession all work
7. setSessionToken/clearSessionToken update internal state
8. renewSession auto-updates token
</verification>

<success_criteria>
- @waiaas/sdk package exists in workspace with 0 runtime dependencies
- WAIaaSClient instantiates with {baseUrl, sessionToken} and calls 9 REST API methods
- WAIaaSError has code, message, status, retryable, hint properties
- All ~36 tests pass
- TypeScript build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/61-typescript-sdk/61-01-SUMMARY.md`
</output>
