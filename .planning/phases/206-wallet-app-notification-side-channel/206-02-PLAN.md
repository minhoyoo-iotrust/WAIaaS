---
phase: 206-wallet-app-notification-side-channel
plan: 02
type: tdd
wave: 2
depends_on: ["206-01"]
files_modified:
  - packages/daemon/src/services/signing-sdk/channels/wallet-notification-channel.ts
  - packages/daemon/src/services/signing-sdk/channels/index.ts
  - packages/daemon/src/services/signing-sdk/index.ts
  - packages/daemon/src/notifications/notification-service.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/wallet-notification-channel.test.ts
autonomous: true
requirements:
  - DAEMON-01
  - DAEMON-02
  - DAEMON-03
  - DAEMON-04
  - DAEMON-05
  - DAEMON-06

must_haves:
  truths:
    - "WalletNotificationChannel publishes NotificationMessage to waiaas-notify-{walletName} ntfy topic as base64url-encoded body"
    - "security_alert category uses ntfy priority 5, all others use priority 3"
    - "Side channel only sends to wallets with owner_approval_method='sdk_ntfy'"
    - "Non-UUID walletId (system/empty) triggers broadcast to all sdk_ntfy wallets with correct per-wallet walletId"
    - "Side channel failure does not affect existing NotificationService sendWithFallback/broadcast results"
    - "NotificationService.notify() calls side channel in parallel with existing channels"
    - "signing_sdk.enabled=false suppresses side channel delivery"
    - "signing_sdk.notifications_enabled=false suppresses side channel delivery"
    - "signing_sdk.notify_categories filters events by category (empty array = all)"
  artifacts:
    - path: "packages/daemon/src/services/signing-sdk/channels/wallet-notification-channel.ts"
      provides: "WalletNotificationChannel class"
      exports: ["WalletNotificationChannel"]
    - path: "packages/daemon/src/__tests__/wallet-notification-channel.test.ts"
      provides: "Unit tests for all DAEMON-01 through DAEMON-06 scenarios"
  key_links:
    - from: "packages/daemon/src/notifications/notification-service.ts"
      to: "packages/daemon/src/services/signing-sdk/channels/wallet-notification-channel.ts"
      via: "notifySideChannel() called from notify()"
      pattern: "walletNotificationChannel"
    - from: "packages/daemon/src/services/signing-sdk/channels/wallet-notification-channel.ts"
      to: "packages/core/src/schemas/signing-protocol.ts"
      via: "import NotificationMessage, EVENT_CATEGORY_MAP"
      pattern: "EVENT_CATEGORY_MAP"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/services/signing-sdk/channels/wallet-notification-channel.ts"
      via: "Instantiation during Step 4c-8 signing SDK lifecycle"
      pattern: "WalletNotificationChannel"
---

<objective>
Implement the daemon-side WalletNotificationChannel and integrate it with NotificationService.

Purpose: Enable the daemon to push all notification events to sdk_ntfy wallets via a dedicated ntfy side channel, independently from existing Telegram/ntfy/Slack channels.
Output: WalletNotificationChannel class, NotificationService integration, daemon lifecycle wiring, and comprehensive tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/206-wallet-app-notification-side-channel/206-01-SUMMARY.md
@packages/daemon/src/notifications/notification-service.ts
@packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts
@packages/daemon/src/services/signing-sdk/approval-channel-router.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/infrastructure/settings/settings-service.ts
@packages/core/src/schemas/signing-protocol.ts
@packages/core/src/enums/notification.ts
@packages/daemon/src/notifications/templates/message-templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WalletNotificationChannel with TDD tests</name>
  <files>
    packages/daemon/src/services/signing-sdk/channels/wallet-notification-channel.ts
    packages/daemon/src/services/signing-sdk/channels/index.ts
    packages/daemon/src/services/signing-sdk/index.ts
    packages/daemon/src/__tests__/wallet-notification-channel.test.ts
  </files>
  <action>
1. **RED phase**: Create `packages/daemon/src/__tests__/wallet-notification-channel.test.ts` with these test cases:

   Set up mock for fetch (globalThis.fetch = vi.fn()) and mock SettingsService (Map-based).
   Create a mock SQLite that returns wallets with `owner_approval_method` and `name` columns.

   Test cases:
   a) **DAEMON-01**: publishes NotificationMessage to `waiaas-notify-{walletName}` ntfy topic. Mock fetch, call `notify()`, verify fetch was called with correct URL (`{ntfyServer}/waiaas-notify-{walletName}`), body is base64url-encoded NotificationMessage JSON, and the decoded body matches NotificationMessageSchema.
   b) **DAEMON-03**: skips wallets where owner_approval_method != 'sdk_ntfy'. Create 2 wallets in mock DB (one sdk_ntfy, one telegram_bot). Call notify() with the telegram_bot wallet's ID. Verify fetch was NOT called.
   c) **DAEMON-04**: non-UUID walletId ('system') broadcasts to ALL sdk_ntfy wallets. Mock DB with 3 wallets (2 sdk_ntfy, 1 walletconnect). Call notify() with walletId='system'. Verify fetch called 2 times with correct walletName topics and each message.walletId is set to the real wallet UUID.
   d) **DAEMON-05**: security_alert category uses priority 5, others use priority 3. Call notify() with KILL_SWITCH_ACTIVATED (security_alert), verify fetch headers include `Priority: 5`. Call with TX_CONFIRMED (transaction), verify `Priority: 3`.
   e) **DAEMON-06**: failure does not throw -- wrap in try/catch is implicit. Mock fetch to reject. Call notify(). Verify it resolves without throwing (returns void).
   f) **SETTINGS-01/02**: when signing_sdk.enabled='false' or signing_sdk.notifications_enabled='false', notify() does not call fetch.
   g) **SETTINGS-03**: when notify_categories='["transaction"]', only transaction-category events trigger fetch. security_alert events are filtered out.

2. **GREEN phase**: Create `packages/daemon/src/services/signing-sdk/channels/wallet-notification-channel.ts`:

   ```ts
   /**
    * WalletNotificationChannel -- pushes all notification events to sdk_ntfy wallets
    * via dedicated ntfy side channel (waiaas-notify-{walletName}).
    *
    * Independent from existing NotificationService channels[]. Runs in parallel,
    * isolated by try/catch to never affect existing channel delivery.
    *
    * @see packages/core/src/schemas/signing-protocol.ts (NotificationMessage)
    */

   import type { NotificationEventType } from '@waiaas/core';
   import {
     EVENT_CATEGORY_MAP,
     type NotificationMessage,
     NOTIFICATION_CATEGORIES,
   } from '@waiaas/core';
   import type { SettingsService } from '../../../infrastructure/settings/settings-service.js';
   import type Database from 'better-sqlite3';

   const DEFAULT_NTFY_SERVER = 'https://ntfy.sh';
   const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

   export interface WalletNotificationChannelDeps {
     sqlite: Database.Database;
     settingsService: SettingsService;
   }

   export class WalletNotificationChannel {
     private readonly sqlite: Database.Database;
     private readonly settings: SettingsService;

     constructor(deps: WalletNotificationChannelDeps) {
       this.sqlite = deps.sqlite;
       this.settings = deps.settingsService;
     }

     /**
      * Send notification to wallet side channel.
      * - Checks signing_sdk.enabled + signing_sdk.notifications_enabled
      * - Checks notify_categories filter
      * - Resolves target wallets (single or broadcast for non-UUID walletId)
      * - Publishes NotificationMessage as base64url to ntfy
      *
      * NEVER throws -- all errors are caught and logged.
      */
     async notify(
       eventType: NotificationEventType,
       walletId: string,
       title: string,
       body: string,
       details?: Record<string, unknown>,
     ): Promise<void> {
       try {
         // Gate 1: signing_sdk.enabled
         if (this.settings.get('signing_sdk.enabled') !== 'true') return;
         // Gate 2: signing_sdk.notifications_enabled
         if (this.settings.get('signing_sdk.notifications_enabled') !== 'true') return;

         // Gate 3: category filter
         const category = EVENT_CATEGORY_MAP[eventType];
         if (!category) return;
         const filterJson = this.settings.get('signing_sdk.notify_categories');
         if (filterJson && filterJson !== '[]') {
           try {
             const allowedCategories = JSON.parse(filterJson) as string[];
             if (Array.isArray(allowedCategories) && allowedCategories.length > 0) {
               if (!allowedCategories.includes(category)) return;
             }
           } catch { /* invalid JSON = allow all */ }
         }

         // Resolve target wallets
         const targets = this.resolveTargetWallets(walletId);
         if (targets.length === 0) return;

         // Resolve ntfy server
         const ntfyServer = this.getNtfyServer();

         // Determine priority
         const priority = category === 'security_alert' ? 5 : 3;

         // Send to all targets in parallel
         await Promise.allSettled(
           targets.map((t) =>
             this.publishNotification(ntfyServer, t.walletName, {
               version: '1',
               eventType,
               walletId: t.walletId,
               walletName: t.walletName,
               category,
               title,
               body,
               details,
               timestamp: Math.floor(Date.now() / 1000),
             }, priority),
           ),
         );
       } catch {
         // DAEMON-06: never throw
       }
     }

     private resolveTargetWallets(walletId: string): Array<{ walletId: string; walletName: string }> {
       if (UUID_REGEX.test(walletId)) {
         // Single wallet -- check if sdk_ntfy
         const row = this.sqlite.prepare(
           'SELECT id, name, owner_approval_method FROM wallets WHERE id = ?',
         ).get(walletId) as { id: string; name: string; owner_approval_method: string | null } | undefined;
         if (!row || row.owner_approval_method !== 'sdk_ntfy') return [];
         return [{ walletId: row.id, walletName: row.name }];
       }

       // Non-UUID (system, empty, etc.) -- broadcast to all sdk_ntfy wallets
       const rows = this.sqlite.prepare(
         "SELECT id, name FROM wallets WHERE owner_approval_method = 'sdk_ntfy' AND status = 'ACTIVE'",
       ).all() as Array<{ id: string; name: string }>;
       return rows.map((r) => ({ walletId: r.id, walletName: r.name }));
     }

     private async publishNotification(
       ntfyServer: string,
       walletName: string,
       message: NotificationMessage,
       priority: number,
     ): Promise<void> {
       const topic = `waiaas-notify-${walletName}`;
       const json = JSON.stringify(message);
       const encoded = Buffer.from(json, 'utf-8').toString('base64url');

       const url = `${ntfyServer}/${topic}`;
       await fetch(url, {
         method: 'POST',
         body: encoded,
         headers: {
           'Priority': String(priority),
           'Title': message.title,
           'Tags': `waiaas,${message.category}`,
         },
       });
     }

     private getNtfyServer(): string {
       try {
         return this.settings.get('notifications.ntfy_server') || DEFAULT_NTFY_SERVER;
       } catch {
         return DEFAULT_NTFY_SERVER;
       }
     }
   }
   ```

3. Export from channels/index.ts: add `export { WalletNotificationChannel } from './wallet-notification-channel.js';` and `export type { WalletNotificationChannelDeps } from './wallet-notification-channel.js';`

4. Export from signing-sdk/index.ts: add `export { WalletNotificationChannel } from './channels/index.js';` and `export type { WalletNotificationChannelDeps } from './channels/index.js';`

5. Run tests, iterate until all pass.
  </action>
  <verify>
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon run test -- --run wallet-notification-channel`
    All 7+ test cases pass.
  </verify>
  <done>
    WalletNotificationChannel class exists with notify() method.
    All DAEMON-01 through DAEMON-06 requirements are implemented and tested.
    SETTINGS-01, SETTINGS-02, SETTINGS-03 gating logic is tested.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate WalletNotificationChannel into NotificationService and daemon lifecycle</name>
  <files>
    packages/daemon/src/notifications/notification-service.ts
    packages/daemon/src/lifecycle/daemon.ts
  </files>
  <action>
1. **NotificationService integration (DAEMON-02)**:

   In `packages/daemon/src/notifications/notification-service.ts`:

   a) Add import: `import type { WalletNotificationChannel } from '../services/signing-sdk/channels/wallet-notification-channel.js';`

   b) Add a private field: `private walletNotificationChannel: WalletNotificationChannel | null = null;`

   c) Add a public setter method:
   ```ts
   /** Set the wallet notification side channel (injected by daemon lifecycle). */
   setWalletNotificationChannel(channel: WalletNotificationChannel | null): void {
     this.walletNotificationChannel = channel;
   }
   ```

   d) In the `notify()` method, add the side channel invocation at the TOP of the method, BEFORE the `if (this.channels.length === 0) return;` early-return guard. This ensures the wallet side channel fires independently even when no traditional notification channels (Telegram/ntfy/Slack) are configured (DAEMON-02: independent parallel operation):
   ```ts
   // Side channel: wallet app notification (independent of traditional channels, never blocks)
   // Placed BEFORE the channels.length guard so it fires even with zero configured channels.
   if (this.walletNotificationChannel) {
     const { title: sideTitle, body: sideBody } = getNotificationMessage(eventType, this.config.locale, vars);
     // Fire-and-forget with try/catch isolation (DAEMON-06)
     this.walletNotificationChannel.notify(eventType, walletId, sideTitle, sideBody, details).catch(() => {});
   }

   if (this.channels.length === 0) return; // No traditional channels configured
   ```

   Note: The side channel call is fire-and-forget, placed before the early-return guard. It does not affect the return value or error handling of the existing channels (DAEMON-02, DAEMON-06). Even if zero traditional channels are configured, the wallet app side channel still operates independently.

2. **Daemon lifecycle wiring**:

   In `packages/daemon/src/lifecycle/daemon.ts`, inside the Step 4c-8 Signing SDK lifecycle block (after `ApprovalChannelRouter` instantiation and the `console.debug('Step 4c-8: Signing SDK initialized')` line):

   a) Add import: The signing-sdk index.ts already re-exports WalletNotificationChannel, so the dynamic import already has it available.

   b) After `this.approvalChannelRouter = new ApprovalChannelRouter(...)`:
   ```ts
   // Wallet Notification Side Channel (v2.7)
   const walletNotifChannel = new WalletNotificationChannel({
     sqlite: this.sqlite!,
     settingsService: this._settingsService!,
   });
   this.notificationService?.setWalletNotificationChannel(walletNotifChannel);
   console.debug('Step 4c-8: WalletNotificationChannel injected into NotificationService');
   ```

   The `WalletNotificationChannel` import comes from the same `await import('../services/signing-sdk/index.js')` that already imports `NtfySigningChannel`, `ApprovalChannelRouter`, etc.

   c) IMPORTANT: In the `else` branch where signing SDK is disabled (`console.debug('Step 4c-8: Signing SDK disabled')`), do NOT create the WalletNotificationChannel. The channel's own `notify()` already gates on `signing_sdk.enabled`, but we avoid unnecessary instantiation.
  </action>
  <verify>
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon run build` -- compiles without errors.
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon run test -- --run notification-service` -- existing tests still pass.
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon run test -- --run signing-sdk-lifecycle` -- existing lifecycle tests still pass.
  </verify>
  <done>
    NotificationService.notify() calls WalletNotificationChannel.notify() in parallel with existing channels.
    Side channel failure cannot affect existing channel delivery.
    Daemon lifecycle creates and injects WalletNotificationChannel when signing SDK is enabled.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon run test -- --run wallet-notification-channel` -- all new tests pass
2. `pnpm --filter @waiaas/daemon run test -- --run notification-service` -- existing tests unbroken
3. `pnpm --filter @waiaas/daemon run test -- --run signing-sdk-lifecycle` -- existing lifecycle tests unbroken
4. `pnpm --filter @waiaas/daemon run build` -- compiles
</verification>

<success_criteria>
- WalletNotificationChannel publishes base64url NotificationMessage to waiaas-notify-{walletName}
- security_alert gets priority 5, others get priority 3
- Only sdk_ntfy wallets receive notifications
- Non-UUID walletId broadcasts to all sdk_ntfy wallets with real wallet IDs
- Side channel runs independently of existing channels (try/catch isolation)
- signing_sdk.enabled=false and notifications_enabled=false both suppress delivery
- notify_categories JSON array filters by category
</success_criteria>

<output>
After completion, create `.planning/phases/206-wallet-app-notification-side-channel/206-02-SUMMARY.md`
</output>
