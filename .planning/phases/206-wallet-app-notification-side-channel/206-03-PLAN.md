---
phase: 206-wallet-app-notification-side-channel
plan: 03
type: tdd
wave: 2
depends_on: ["206-01"]
files_modified:
  - packages/wallet-sdk/src/channels/ntfy.ts
  - packages/wallet-sdk/src/channels/index.ts
  - packages/wallet-sdk/src/index.ts
  - packages/wallet-sdk/src/__tests__/channels.test.ts
autonomous: true
requirements:
  - SDK-01
  - SDK-02

must_haves:
  truths:
    - "subscribeToNotifications(topic, callback, serverUrl?) subscribes to ntfy SSE and delivers parsed NotificationMessage objects via callback"
    - "parseNotification(data) decodes base64url → JSON → Zod-validated NotificationMessage"
    - "parseNotification rejects malformed data (invalid base64, invalid JSON, schema failure)"
    - "subscribeToNotifications returns { unsubscribe() } to close the SSE connection"
  artifacts:
    - path: "packages/wallet-sdk/src/channels/ntfy.ts"
      provides: "subscribeToNotifications and parseNotification functions"
      exports: ["subscribeToNotifications", "parseNotification"]
    - path: "packages/wallet-sdk/src/__tests__/channels.test.ts"
      provides: "Tests for subscribeToNotifications SSE parsing and parseNotification validation"
  key_links:
    - from: "packages/wallet-sdk/src/channels/ntfy.ts"
      to: "packages/core/src/schemas/signing-protocol.ts"
      via: "import NotificationMessageSchema"
      pattern: "NotificationMessageSchema"
    - from: "packages/wallet-sdk/src/index.ts"
      to: "packages/wallet-sdk/src/channels/index.ts"
      via: "export subscribeToNotifications, parseNotification"
      pattern: "subscribeToNotifications"
---

<objective>
Add subscribeToNotifications() and parseNotification() to the @waiaas/wallet-sdk package.

Purpose: Enable wallet apps to subscribe to real-time notification events from the daemon side channel and parse/validate incoming messages.
Output: Two new SDK functions with full test coverage.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/206-wallet-app-notification-side-channel/206-01-SUMMARY.md
@packages/wallet-sdk/src/channels/ntfy.ts
@packages/wallet-sdk/src/channels/index.ts
@packages/wallet-sdk/src/index.ts
@packages/wallet-sdk/src/__tests__/channels.test.ts
@packages/core/src/schemas/signing-protocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement parseNotification and subscribeToNotifications in wallet-sdk</name>
  <files>
    packages/wallet-sdk/src/channels/ntfy.ts
    packages/wallet-sdk/src/channels/index.ts
    packages/wallet-sdk/src/index.ts
    packages/wallet-sdk/src/__tests__/channels.test.ts
  </files>
  <action>
1. **RED phase**: Add tests to `packages/wallet-sdk/src/__tests__/channels.test.ts`:

   Add a new describe block for `parseNotification`:

   ```ts
   import { parseNotification } from '../channels/ntfy.js';

   describe('parseNotification', () => {
     it('decodes a valid base64url NotificationMessage', () => {
       const msg = {
         version: '1',
         eventType: 'TX_CONFIRMED',
         walletId: '01958f3a-1234-7000-8000-abcdef123456',
         walletName: 'trading-bot',
         category: 'transaction',
         title: 'Transaction Confirmed',
         body: 'Your transaction was confirmed on-chain',
         timestamp: 1707000000,
       };
       const encoded = Buffer.from(JSON.stringify(msg), 'utf-8').toString('base64url');
       const result = parseNotification(encoded);
       expect(result.version).toBe('1');
       expect(result.eventType).toBe('TX_CONFIRMED');
       expect(result.walletName).toBe('trading-bot');
       expect(result.category).toBe('transaction');
     });

     it('throws on invalid base64url', () => {
       expect(() => parseNotification('!!!invalid!!!')).toThrow();
     });

     it('throws on valid base64url but invalid JSON', () => {
       const encoded = Buffer.from('not-json', 'utf-8').toString('base64url');
       expect(() => parseNotification(encoded)).toThrow();
     });

     it('throws on valid JSON but schema mismatch', () => {
       const encoded = Buffer.from(JSON.stringify({ foo: 'bar' }), 'utf-8').toString('base64url');
       expect(() => parseNotification(encoded)).toThrow();
     });

     it('accepts optional details field', () => {
       const msg = {
         version: '1',
         eventType: 'KILL_SWITCH_ACTIVATED',
         walletId: '01958f3a-0000-7000-8000-000000000000',
         walletName: 'main-wallet',
         category: 'security_alert',
         title: 'Kill Switch',
         body: 'Kill switch was activated',
         details: { triggeredBy: 'admin' },
         timestamp: 1707000000,
       };
       const encoded = Buffer.from(JSON.stringify(msg), 'utf-8').toString('base64url');
       const result = parseNotification(encoded);
       expect(result.details).toEqual({ triggeredBy: 'admin' });
     });
   });
   ```

   Add a describe block for `subscribeToNotifications`:

   ```ts
   import { subscribeToNotifications } from '../channels/ntfy.js';

   describe('subscribeToNotifications', () => {
     it('returns an object with unsubscribe method', () => {
       // Mock fetch to return a never-resolving stream
       const mockFetch = vi.fn().mockReturnValue(new Promise(() => {}));
       globalThis.fetch = mockFetch as typeof fetch;

       const sub = subscribeToNotifications('test-topic', () => {});
       expect(sub).toHaveProperty('unsubscribe');
       expect(typeof sub.unsubscribe).toBe('function');
       sub.unsubscribe();
     });

     it('calls fetch with correct SSE URL', async () => {
       const mockFetch = vi.fn().mockReturnValue(new Promise(() => {}));
       globalThis.fetch = mockFetch as typeof fetch;

       const sub = subscribeToNotifications('my-topic', () => {}, 'https://custom.ntfy.sh');
       // Give event loop time
       await new Promise((r) => setTimeout(r, 50));

       expect(mockFetch).toHaveBeenCalledWith(
         'https://custom.ntfy.sh/my-topic/sse',
         expect.objectContaining({ signal: expect.any(AbortSignal) }),
       );

       sub.unsubscribe();
     });
   });
   ```

2. **GREEN phase**: In `packages/wallet-sdk/src/channels/ntfy.ts`, add after the existing `subscribeToRequests` function:

   ```ts
   import type { NotificationMessage } from '@waiaas/core';
   import { NotificationMessageSchema } from '@waiaas/core';
   ```

   Add `parseNotification`:
   ```ts
   /**
    * Parse and validate a base64url-encoded NotificationMessage.
    *
    * Decodes the base64url string → parses JSON → validates against NotificationMessageSchema.
    *
    * @param data - base64url-encoded NotificationMessage JSON string
    * @returns Validated NotificationMessage object
    * @throws Error if decoding, parsing, or validation fails
    */
   export function parseNotification(data: string): NotificationMessage {
     const json = Buffer.from(data, 'base64url').toString('utf-8');
     const parsed: unknown = JSON.parse(json);
     return NotificationMessageSchema.parse(parsed);
   }
   ```

   Add `subscribeToNotifications`:
   ```ts
   /**
    * Subscribe to notification events via ntfy SSE stream.
    *
    * Listens for new messages on the specified ntfy topic and parses them
    * as NotificationMessage objects via parseNotification().
    * Valid messages trigger the callback.
    *
    * @param topic - ntfy topic name (e.g., 'waiaas-notify-trading-bot')
    * @param callback - Function called for each valid NotificationMessage received
    * @param serverUrl - ntfy server URL (defaults to https://ntfy.sh)
    * @returns Object with unsubscribe() method to close the SSE connection
    */
   export function subscribeToNotifications(
     topic: string,
     callback: (message: NotificationMessage) => void,
     serverUrl: string = DEFAULT_SERVER_URL,
   ): { unsubscribe: () => void } {
     const abortController = new AbortController();
     let reconnectAttempts = 0;

     async function connect(): Promise<void> {
       if (abortController.signal.aborted) return;

       try {
         const url = `${serverUrl}/${topic}/sse`;
         const res = await fetch(url, {
           signal: abortController.signal,
         });

         if (!res.ok || !res.body) {
           throw new Error(`SSE connection failed: HTTP ${String(res.status)}`);
         }

         reconnectAttempts = 0;

         const reader = res.body.getReader();
         const decoder = new TextDecoder();
         let buffer = '';

         while (!abortController.signal.aborted) {
           const { done, value } = await reader.read();
           if (done) break;

           buffer += decoder.decode(value, { stream: true });
           const lines = buffer.split('\n');
           buffer = lines.pop() ?? '';

           for (const line of lines) {
             if (!line.startsWith('data: ')) continue;

             const dataStr = line.slice(6).trim();
             if (!dataStr) continue;

             try {
               const event = JSON.parse(dataStr) as { message?: string };
               if (!event.message) continue;

               const notification = parseNotification(event.message);
               callback(notification);
             } catch {
               // Ignore malformed messages
             }
           }
         }
       } catch (_err) {
         if (abortController.signal.aborted) return;

         reconnectAttempts++;
         if (reconnectAttempts <= MAX_RECONNECT_ATTEMPTS) {
           await new Promise((resolve) =>
             setTimeout(resolve, RECONNECT_DELAY_MS),
           );
           void connect();
         }
       }
     }

     void connect();

     return {
       unsubscribe(): void {
         abortController.abort();
       },
     };
   }
   ```

3. Export from `packages/wallet-sdk/src/channels/index.ts`:
   Add: `export { subscribeToNotifications, parseNotification } from './ntfy.js';`

4. Export from `packages/wallet-sdk/src/index.ts`:
   Add `subscribeToNotifications` and `parseNotification` to the channel exports block:
   ```ts
   export {
     sendViaNtfy,
     subscribeToRequests,
     sendViaTelegram,
     subscribeToNotifications,
     parseNotification,
   } from './channels/index.js';
   ```

   Update the JSDoc comment at the top to include the two new functions:
   ```
    *   - subscribeToNotifications(topic, callback, serverUrl?) - SSE subscription for notifications
    *   - parseNotification(data) - Decode and validate base64url NotificationMessage
   ```

5. Run tests, iterate until all pass.
  </action>
  <verify>
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/wallet-sdk run test -- --run channels`
    All parseNotification and subscribeToNotifications tests pass.
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/wallet-sdk run build` -- compiles without errors.
  </verify>
  <done>
    parseNotification(data) decodes base64url → JSON → Zod-validated NotificationMessage.
    subscribeToNotifications(topic, callback, serverUrl?) subscribes to ntfy SSE and delivers NotificationMessage via callback.
    Both functions are exported from @waiaas/wallet-sdk public API.
    Existing tests for sendViaNtfy, subscribeToRequests, sendViaTelegram still pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/wallet-sdk run test -- --run channels` -- all tests pass (existing + new)
2. `pnpm --filter @waiaas/wallet-sdk run build` -- compiles
3. `pnpm --filter @waiaas/wallet-sdk run test` -- full test suite green
</verification>

<success_criteria>
- parseNotification decodes and validates NotificationMessage from base64url
- subscribeToNotifications connects to ntfy SSE and invokes callback for each valid message
- Invalid/malformed messages are silently ignored
- unsubscribe() cleanly closes the SSE connection
- Both functions are exported from @waiaas/wallet-sdk
</success_criteria>

<output>
After completion, create `.planning/phases/206-wallet-app-notification-side-channel/206-03-SUMMARY.md`
</output>
