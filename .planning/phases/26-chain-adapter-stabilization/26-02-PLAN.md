---
phase: 26-chain-adapter-stabilization
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - .planning/deliverables/26-keystore-spec.md
  - .planning/deliverables/31-solana-adapter-detail.md
autonomous: true

must_haves:
  truths:
    - "26-keystore-spec.md 섹션 3.3의 Birthday Problem 계산이 정확한 수식 P = 1 - e^(-n^2/(2N)), N=2^96으로 정정되어 있다"
    - "WAIaaS 키스토어의 매번 새 salt = 매번 새 AES 키 특성에 의해 nonce 충돌이 구조적으로 불가능함이 분석되어 있다"
    - "31-solana-adapter-detail.md 섹션 11.2의 priority fee TTL 30초에 Nyquist 기준 근거가 명시되어 있다"
    - "제출 실패 시 1.5배 fee bump 1회 재시도 전략이 31-solana-adapter-detail.md에 추가되어 있다"
  artifacts:
    - path: ".planning/deliverables/26-keystore-spec.md"
      provides: "AES-GCM nonce 충돌 확률 정정 (CHAIN-03)"
      contains: "1 - e^(-n"
    - path: ".planning/deliverables/31-solana-adapter-detail.md"
      provides: "Priority fee TTL 근거 + bump 전략 (CHAIN-04)"
      contains: "Nyquist"
  key_links:
    - from: "26-keystore-spec.md 섹션 3.3"
      to: "NIST SP 800-38D"
      via: "Birthday Problem 정확 공식"
      pattern: "2\\^96"
    - from: "31-solana-adapter-detail.md 섹션 11.2"
      to: "Nyquist-Shannon"
      via: "샘플링 정리 적용"
      pattern: "Nyquist"
    - from: "31-solana-adapter-detail.md submitTransaction"
      to: "fee bump 재시도"
      via: "1.5배 bump + 새 blockhash"
      pattern: "fee.*bump|1\\.5"
---

<objective>
Keystore AES-GCM nonce 충돌 확률의 수학적 정정과 Priority fee 캐시 TTL의 이론적 근거를 확립한다.

Purpose: CHAIN-03(CRITICAL)의 부정확한 보안 수학을 정정하고, CHAIN-04(MEDIUM)의 fee 전략을 보완하여, 구현자가 정확한 보안 근거와 재시도 로직을 갖춘 코드를 작성할 수 있게 한다.
Output: 26-keystore-spec.md와 31-solana-adapter-detail.md에 [v0.7 보완] 태그로 설계 보완이 반영된 문서
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-chain-adapter-stabilization/26-RESEARCH.md
@.planning/phases/26-chain-adapter-stabilization/26-01-SUMMARY.md
@.planning/deliverables/26-keystore-spec.md
@.planning/deliverables/31-solana-adapter-detail.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Keystore AES-GCM nonce 충돌 확률 Birthday Problem 정정</name>
  <files>.planning/deliverables/26-keystore-spec.md</files>
  <action>
26-keystore-spec.md 섹션 3.3 "Nonce 재사용 방지 전략 (C-01 대응)"을 정정한다. [v0.7 보완] 태그를 붙인다.

기존 내용 (부정확):
```
96비트 랜덤 nonce의 충돌 확률 (Birthday Problem):
- 2^32 (약 40억) 회 암호화 시 충돌 확률 ~ 2^-32
- WAIaaS 키스토어는 에이전트당 최대 수십 회 재암호화 (패스워드 변경)
- 실질적 충돌 위험: 무시 가능
```

교체 내용:

1. **방지 전략 테이블은 유지** (4가지 전략: 매번 새 nonce, 매번 새 salt, 카운터 미사용, 키당 암호화 1회)

2. **"안전 마진 계산" 부분을 완전 교체** -- [v0.7 보완] 태그 추가:

   **[v0.7 보완] 충돌 확률 정밀 분석:**

   Birthday Problem 정확 공식:
   ```
   P(collision) = 1 - e^(-n(n-1) / (2N))
                ~ 1 - e^(-n^2 / (2N))    (n >> 1일 때)

   여기서:
     n = 동일 AES 키로 수행한 암호화 횟수
     N = nonce 공간 크기 = 2^96 ~ 7.92 x 10^28
   ```

   NIST SP 800-38D 권장 한계:
   - P(collision) < 2^-32 (~ 2.33 x 10^-10)
   - 이를 만족하는 최대 n ~ 2^32 (약 43억 회)

   **WAIaaS 실사용 패턴 분석:**

   WAIaaS 키스토어는 매 암호화마다 새 CSPRNG salt(16바이트)를 생성하고,
   Argon2id로 새 AES-256 키를 파생한다. 따라서:

   a. 동일 AES 키로의 암호화 횟수 = 1회 (키스토어 파일 생성 또는 재암호화 1회)
   b. 패스워드 변경 시 새 salt -> 새 AES 키 -> Birthday Problem 전제(동일 키) 미충족
   c. n=1이면 충돌 불가 (자기 자신과의 충돌은 정의상 불가능)

   **결론: WAIaaS 키스토어에서 AES-GCM nonce 충돌은 구조적으로 불가능하다.**

   **보수적 가정 분석** (salt 고정 시나리오 -- 실제로는 불가능):

   | 시나리오 | n (암호화 횟수) | P(collision) | 판정 |
   |---------|----------------|--------------|------|
   | 에이전트 1개, 변경 100회 | 100 | ~ 6.3 x 10^-26 | 무시 가능 |
   | 에이전트 100개, 각 100회 | 10,000 | ~ 6.3 x 10^-22 | 무시 가능 |
   | NIST 한계 (참고) | 2^32 ~ 4.3 x 10^9 | ~ 2.33 x 10^-10 | NIST 허용 상한 |
   | 50% 충돌 (참고) | 2^48 ~ 2.8 x 10^14 | ~ 50% | Birthday bound |

3. **문서 헤더에 v0.7 업데이트 날짜 추가**

주의: 기존 섹션 3.4 (재암호화 시나리오) 이후의 내용은 변경하지 않는다. 섹션 3.3의 "안전 마진 계산" 블록만 교체한다.
  </action>
  <verify>
grep "1 - e" .planning/deliverables/26-keystore-spec.md 로 정확한 Birthday Problem 공식이 존재하는지 확인.
grep "2\^96" .planning/deliverables/26-keystore-spec.md 로 96비트 nonce 공간이 명시되었는지 확인.
grep "구조적으로 불가능" .planning/deliverables/26-keystore-spec.md 로 핵심 결론이 있는지 확인.
grep "NIST SP 800-38D" .planning/deliverables/26-keystore-spec.md 로 참조가 있는지 확인.
grep "v0.7 보완" .planning/deliverables/26-keystore-spec.md 로 태그가 있는지 확인.
기존 섹션 3.4 이후 내용이 변경되지 않았는지 diff로 확인.
  </verify>
  <done>
26-keystore-spec.md 섹션 3.3의 충돌 확률 계산이 정확한 Birthday Problem 공식(P ~ 1-e^(-n^2/(2N)), N=2^96)으로 정정되고, WAIaaS의 매번 새 salt 설계에 의한 구조적 불가능성이 분석되었다.
  </done>
</task>

<task type="auto">
  <name>Task 2: Priority fee TTL Nyquist 근거 + 1.5배 fee bump 재시도 전략</name>
  <files>.planning/deliverables/31-solana-adapter-detail.md</files>
  <action>
31-solana-adapter-detail.md를 수정하여 CHAIN-04 요구사항을 해소한다. [v0.7 보완] 태그를 붙인다.

주의: 이 문서는 Plan 26-01에서 이미 수정되었으므로, 26-01-SUMMARY.md를 읽어 변경 사항을 파악한 후 작업한다. 이 Task에서 수정하는 섹션(11.2, 8)은 Plan 26-01이 수정한 섹션(7, 10, 11.3)과 겹치지 않으므로 충돌 없음.

1. **섹션 11.2 캐시 전략 테이블 보완**:
   - 기존 priority fee 행의 "근거" 컬럼을 확장:
     기존: "getRecentPrioritizationFees는 150 슬롯(~60초) 통계를 반환. 30초 캐시는 네트워크 혼잡도 변화에 적절히 반응"
     교체: "(v0.7 보완) Nyquist 기준. 아래 상세 참조"

   - 테이블 아래에 [v0.7 보완] 서브섹션 추가:

     **[v0.7 보완] Priority Fee TTL 30초의 Nyquist 기준 근거:**

     Nyquist-Shannon 샘플링 정리: 대역 제한 신호를 왜곡 없이 복원하려면 최소 신호 주파수의 2배로 샘플링해야 한다 (f_s >= 2 * f_max).

     적용:
     - getRecentPrioritizationFees는 최근 150 슬롯(~ 60초)의 통계를 반환
     - 이 60초 윈도우가 fee 변화의 "주기"에 해당
     - Nyquist 최소 샘플링 주기 = 60초 / 2 = 30초
     - TTL 30초 = Nyquist 최소 샘플링 주기

     비교 테이블:
     | TTL | Nyquist 판정 | 트레이드오프 |
     |-----|-------------|------------|
     | 15초 | 오버샘플링 (4x) | 불필요한 RPC 호출 증가 |
     | **30초** | **적정 (2x, Nyquist 최소)** | **fee 변화 추적 + RPC 부담 균형** |
     | 60초 | 언더샘플링 (1x) | fee 변화 절반 놓침 (앨리어싱) |

2. **섹션 8 (submitTransaction) 뒤에 fee bump 재시도 서브섹션 추가**:

   **[v0.7 보완] 제출 실패 시 1.5배 Fee Bump 1회 재시도 전략:**

   플로우:
   ```
   submitTransaction() 실패
       |
       v
   [실패 원인 분류]
       |
       +-- BlockhashNotFound -> blockhash 만료 -> buildTransaction() 재실행 (기존 전략)
       |
       +-- InsufficientFeeForTransaction / 우선순위 부족 ->
       |       |
       |       v
       |   [Fee Bump 재시도 (v0.7 추가)]
       |   1. 현재 priority fee * 1.5 (50% 인상)
       |   2. 새 buildTransaction() (새 blockhash + bumped fee)
       |   3. simulateTransaction() -> signTransaction() -> submitTransaction()
       |   4. 재시도 횟수: 최대 1회 (무한 재시도 방지)
       |   5. bump 후에도 실패 시 -> TRANSACTION_FAILED 반환
       |
       +-- 기타 에러 -> 기존 에러 처리 유지
   ```

   설계 제약 테이블:
   | 제약 | 값 | 근거 |
   |------|-----|------|
   | 최대 재시도 횟수 | 1회 | fee escalation 무한 루프 방지 |
   | bump 계수 | 1.5배 고정 | 업계 관행 (50~100% 인상이 일반적), 설정 가능하게 하지 않음 -- 단순성 우선 |
   | 새 blockhash 필수 | yes | 기존 blockhash 만료 위험 방지 |
   | 감사 기록 | audit_log에 기록 | fee_bump_attempted, original_fee, bumped_fee 필드 |

   fee bump 실패 감지 조건에 대한 현실적 주의사항 추가:
   - Solana RPC는 "priority fee 부족"을 명시적 에러로 반환하지 않는 경우가 있음
   - waitForConfirmation 타임아웃 + 네트워크 혼잡 감지(최근 fee 중간값 급등) 시에도 fee bump 적용 가능
   - 구현 시 구체적인 감지 조건은 RPC 에러 코드 매핑에서 확정

3. **섹션 10.1 에러 매핑에 fee 관련 에러 코드 추가** (Plan 26-01이 추가한 BLOCKHASH_STALE과 별도):
   - SOLANA_INSUFFICIENT_FEE: "Priority fee 부족으로 제출 실패. fee bump 재시도 대상." retryable: true
   - 이 에러 발생 시 fee bump 전략으로 라우팅되는 것을 명시

주의: Plan 26-01에서 이미 추가된 내용(checkBlockhashFreshness, refreshBlockhash, BLOCKHASH_STALE)과 중복/충돌하지 않도록 주의한다. 이 Task는 섹션 11.2, 8 하위, 10.1의 fee 관련 에러만 수정한다.
  </action>
  <verify>
grep "Nyquist" .planning/deliverables/31-solana-adapter-detail.md 로 Nyquist 근거가 존재하는지 확인.
grep "1.5" .planning/deliverables/31-solana-adapter-detail.md 로 bump 계수가 명시되었는지 확인.
grep "fee.*bump\|Fee.*Bump\|fee_bump" .planning/deliverables/31-solana-adapter-detail.md 로 fee bump 전략이 존재하는지 확인.
grep "INSUFFICIENT_FEE" .planning/deliverables/31-solana-adapter-detail.md 로 에러 코드가 추가되었는지 확인.
grep "v0.7 보완" .planning/deliverables/31-solana-adapter-detail.md 로 태그 개수 확인 (Plan 26-01 태그 + 이 Task 태그 합계).
  </verify>
  <done>
31-solana-adapter-detail.md에 priority fee TTL 30초의 Nyquist 기준 근거가 명시되고, 제출 실패 시 1.5배 fee bump 1회 재시도 전략이 설계 제약과 함께 추가되었다.
  </done>
</task>

</tasks>

<verification>
1. 26-keystore-spec.md 섹션 3.3에 정확한 Birthday Problem 공식(P ~ 1-e^(-n^2/(2N)))이 기술되어 있다
2. WAIaaS의 매번 새 salt 설계에 의한 nonce 충돌 구조적 불가능성이 분석되어 있다
3. NIST SP 800-38D 참조와 보수적 가정 분석 테이블이 존재한다
4. 31-solana-adapter-detail.md 섹션 11.2에 Nyquist 기준 근거가 명시되어 있다
5. fee bump 1회 재시도 전략이 플로우 다이어그램과 설계 제약 테이블로 정의되어 있다
6. SOLANA_INSUFFICIENT_FEE 에러 코드가 에러 매핑에 추가되어 있다
7. Plan 26-01에서 추가된 내용과 충돌이 없다
</verification>

<success_criteria>
- CHAIN-03 해소: 26-keystore-spec.md의 nonce 충돌 확률이 정확한 Birthday Problem 수식으로 정정되고 실제 사용 패턴 분석이 추가됨
- CHAIN-04 해소: Priority fee TTL 30초의 Nyquist 기준 근거가 명시되고, 1.5배 fee bump 1회 재시도 전략이 추가됨
- 두 문서 모두 기존 설계를 파괴하지 않고 보완만 수행됨
- 모든 보완에 [v0.7 보완] 태그가 부착됨
</success_criteria>

<output>
After completion, create `.planning/phases/26-chain-adapter-stabilization/26-02-SUMMARY.md`
</output>
