---
phase: 26-chain-adapter-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/31-solana-adapter-detail.md
  - .planning/deliverables/27-chain-adapter-interface.md
autonomous: true

must_haves:
  truths:
    - "31-solana-adapter-detail.md의 signTransaction 섹션에 getBlockHeight() 기반 blockhash freshness guard가 스펙으로 추가되어 있다"
    - "refreshBlockhash() 유틸리티 메서드가 Option A(메시지 객체 캐싱) 방식으로 31-solana-adapter-detail.md에 설계되어 있다"
    - "IChainAdapter가 getCurrentNonce/resetNonceTracker 포함 19개 메서드로 확장되어 27-chain-adapter-interface.md에 반영되어 있다"
    - "UnsignedTransaction.nonce가 명시적 optional 필드로 27-chain-adapter-interface.md에 승격되어 있다"
  artifacts:
    - path: ".planning/deliverables/31-solana-adapter-detail.md"
      provides: "Blockhash freshness guard 스펙 (CHAIN-01)"
      contains: "[v0.7 보완]"
    - path: ".planning/deliverables/27-chain-adapter-interface.md"
      provides: "EVM nonce 인터페이스 확장 (CHAIN-02)"
      contains: "getCurrentNonce"
  key_links:
    - from: "31-solana-adapter-detail.md signTransaction"
      to: "getBlockHeight RPC"
      via: "checkBlockhashFreshness private method"
      pattern: "getBlockHeight"
    - from: "27-chain-adapter-interface.md IChainAdapter"
      to: "UnsignedTransaction.nonce"
      via: "명시적 optional 필드 승격"
      pattern: "nonce\\?.*number"
    - from: "31-solana-adapter-detail.md"
      to: "27-chain-adapter-interface.md UnsignedTransaction"
      via: "refreshBlockhash 메서드"
      pattern: "refreshBlockhash"
---

<objective>
Solana blockhash 경쟁 조건을 설계 수준에서 해소하고, EVM nonce 관리를 타입 안전하게 확장한다.

Purpose: CHAIN-01(CRITICAL)과 CHAIN-02(CRITICAL) 두 가지 구현 장애 요소를 해소하여, 체인 어댑터 구현 시 blockhash 만료와 nonce 관리 문제로 인한 런타임 장애를 방지한다.
Output: 31-solana-adapter-detail.md와 27-chain-adapter-interface.md에 [v0.7 보완] 태그로 설계 보완이 반영된 문서
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-chain-adapter-stabilization/26-RESEARCH.md
@.planning/deliverables/31-solana-adapter-detail.md
@.planning/deliverables/27-chain-adapter-interface.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Solana blockhash freshness guard + refreshBlockhash 설계 추가</name>
  <files>.planning/deliverables/31-solana-adapter-detail.md</files>
  <action>
31-solana-adapter-detail.md를 수정하여 CHAIN-01 요구사항을 해소한다. 모든 보완 내용에 [v0.7 보완] 태그를 붙인다.

1. **섹션 1.3 메서드 매핑 테이블 업데이트**: 17개 -> "17개 (v0.7에서 IChainAdapter는 19개로 확장, 추가 2개는 EVM 전용)" 주석 추가

2. **섹션 7 (signTransaction) 보완 -- checkBlockhashFreshness 추가**:
   - signTransaction 메서드 내부에 [v0.7 보완] 서브섹션을 추가
   - 기존 expiresAt Date 비교(1차 검증) 유지
   - 2차 검증으로 getBlockHeight() 기반 정밀 검증 추가:
     ```typescript
     private async checkBlockhashFreshness(
       lastValidBlockHeight: bigint,
       thresholdSeconds: number = 20,
     ): Promise<void>
     ```
   - currentBlockHeight를 rpc.getBlockHeight({ commitment }).send()로 조회
   - remainingBlocks = lastValidBlockHeight - currentBlockHeight
   - remainingSeconds = remainingBlocks * 0.4 (슬롯당 ~400ms)
   - remainingSeconds < thresholdSeconds이면 BLOCKHASH_STALE 에러 throw (retryable: true)
   - remainingBlocks <= 0이면 BLOCKHASH_EXPIRED 에러 throw (retryable: true)
   - FRESHNESS_THRESHOLD_SECONDS = 20초 근거 명시: blockhash 수명 60초 - sign(1초) - submit(2초) - 대기(2초) - 안전마진(15초)

3. **섹션 7 이후에 refreshBlockhash 서브섹션 추가** (또는 섹션 5 buildTransaction 하위에 적절히 배치):
   - [v0.7 보완] refreshBlockhash(tx: UnsignedTransaction): Promise<UnsignedTransaction>
   - Option A 채택: 메시지 객체를 metadata에 캐싱하여 재사용
   - 새 blockhash 조회 (blockhashCache 무효화)
   - transactionMessage 객체에 setTransactionMessageLifetimeUsingBlockhash로 교체
   - compileTransactionMessage로 재컴파일
   - 새 expiresAt = now + 50초 계산
   - 새 lastValidBlockHeight를 metadata에 저장
   - 주의사항: instruction은 변경하지 않음. fee 변동이 크면 buildTransaction 완전 재실행 권장
   - buildTransaction에서 transactionMessage 객체를 metadata._compiledMessage로 보관하도록 설계 추가

4. **섹션 10.1 에러 매핑 테이블에 BLOCKHASH_STALE 추가**:
   - 기존 BLOCKHASH_EXPIRED(이미 만료)와 구분
   - BLOCKHASH_STALE: 수명 부족, 갱신 권장 (retryable: true)
   - 호출자 복구 전략 차이 명시: EXPIRED -> buildTransaction 재실행, STALE -> refreshBlockhash 호출

5. **섹션 11.3 Blockhash 만료 대응 전략 보완**:
   - 기존 전략 유지하면서 [v0.7 보완] 추가
   - signTransaction 직전에 checkBlockhashFreshness 호출 추가
   - STALE 시 refreshBlockhash -> re-sign -> submit 플로우 다이어그램 추가
   - "핵심 원칙" 목록에 "signTransaction() 직전 getBlockHeight() 기반 freshness guard 적용" 추가

6. **섹션 2.2 클래스 선언의 private 필드에 추가**:
   - FRESHNESS_THRESHOLD_SECONDS = 20 상수

주의: getSlot()이 아닌 getBlockHeight()를 사용해야 한다. slot과 block height는 다르며, skipped 슬롯이 있으면 slot > blockHeight이 된다. lastValidBlockHeight는 block height 기준이므로 반드시 getBlockHeight()로 비교.
  </action>
  <verify>
grep -c "v0.7 보완" .planning/deliverables/31-solana-adapter-detail.md 로 [v0.7 보완] 태그가 최소 5회 이상 나타나는지 확인.
grep "checkBlockhashFreshness" .planning/deliverables/31-solana-adapter-detail.md 로 freshness guard 메서드가 존재하는지 확인.
grep "refreshBlockhash" .planning/deliverables/31-solana-adapter-detail.md 로 갱신 유틸리티가 존재하는지 확인.
grep "BLOCKHASH_STALE" .planning/deliverables/31-solana-adapter-detail.md 로 새 에러 코드가 존재하는지 확인.
grep "getBlockHeight" .planning/deliverables/31-solana-adapter-detail.md 로 block height 기반 검증이 있는지 확인.
grep "getSlot" 로 검색하여 잘못된 API 사용이 없는지 확인 (freshness guard 컨텍스트에서).
  </verify>
  <done>
31-solana-adapter-detail.md에 checkBlockhashFreshness(getBlockHeight 기반, 20초 임계값), refreshBlockhash(Option A, 메시지 캐싱), BLOCKHASH_STALE 에러 코드가 [v0.7 보완] 태그와 함께 추가되어, sign 시점 blockhash 만료 경쟁 조건이 설계 수준에서 해소되었다.
  </done>
</task>

<task type="auto">
  <name>Task 2: IChainAdapter EVM nonce 인터페이스 확장 + UnsignedTransaction.nonce 승격</name>
  <files>.planning/deliverables/27-chain-adapter-interface.md</files>
  <action>
27-chain-adapter-interface.md를 수정하여 CHAIN-02 요구사항을 해소한다. 모든 보완 내용에 [v0.7 보완] 태그를 붙인다.

1. **섹션 2.4 UnsignedTransaction 타입에 nonce 필드 추가**:
   - 기존 필드 목록 끝에 [v0.7 보완] nonce 필드 추가:
     ```typescript
     /**
      * [v0.7 보완] EVM 트랜잭션 nonce.
      * EVM 체인에서만 사용. Solana는 undefined.
      * 기존 metadata에서 승격된 명시적 필드.
      * buildTransaction()이 자동 설정하며, 외부에서 override 가능.
      */
     nonce?: number
     ```
   - metadata에서 nonce를 사용하는 기존 코드 패턴이 있으면 "nonce는 v0.7부터 명시적 필드로 승격. metadata.nonce 대신 tx.nonce 사용" 주석 추가

2. **섹션 3 IChainAdapter 인터페이스 본문에 메서드 2개 추가** (기존 17개 뒤에):
   ```typescript
   /**
    * [18] [v0.7 보완] 주소의 현재 유효 nonce를 반환한다.
    * EVM: max(onchainPendingNonce, localTrackerNonce)
    * Solana: 0 반환 (Solana는 nonce 기반이 아님, blockhash 기반)
    * @param address - 조회 대상 주소
    * @returns 현재 유효 nonce (EVM), 0 (Solana)
    */
   getCurrentNonce(address: string): Promise<number>

   /**
    * [19] [v0.7 보완] nonce 트래커를 리셋한다.
    * 제출 실패/stuck 트랜잭션 복구 시 사용.
    * address 미지정 시 전체 리셋.
    * Solana: no-op
    * @param address - 리셋 대상 주소 (생략 시 전체)
    */
   resetNonceTracker(address?: string): void
   ```

3. **섹션 3.1 메서드 요약 테이블 업데이트**:
   - 17개 -> 19개로 변경
   - 18번 getCurrentNonce, 19번 resetNonceTracker 행 추가
   - 카테고리: "Nonce 관리 (v0.7 추가)"

4. **섹션 6 Solana Adapter 명세에 no-op 구현 추가**:
   - 섹션 6 하위에 [v0.7 보완] Nonce 관리 (Solana: no-op) 서브섹션
   - getCurrentNonce: return 0 (Solana는 blockhash 기반, nonce 개념 없음)
   - resetNonceTracker: no-op

5. **섹션 7 EVM Adapter 명세에 구현 설계 추가**:
   - 섹션 7.8 Nonce 관리 전략에 [v0.7 보완] 추가
   - getCurrentNonce 구현: getTransactionCount(pending) vs localTracker의 max 반환
   - resetNonceTracker 구현: nonceTracker Map에서 해당 주소 삭제 (전체이면 clear)
   - viem createNonceManager 패턴 참고 주석 추가 (직접 사용은 아님)

6. **섹션 4.2 Solana 에러 코드에 BLOCKHASH_STALE 추가** (Task 1과 연동):
   - 기존 SOLANA_BLOCKHASH_EXPIRED와 구분
   - SOLANA_BLOCKHASH_STALE: "Blockhash 잔여 수명 부족. refreshBlockhash() 호출 권장." retryable: true
   - 복구 전략: EXPIRED -> buildTransaction 재실행, STALE -> refreshBlockhash 호출

7. **문서 헤더 업데이트**:
   - v0.7 업데이트 날짜 추가
   - 섹션 1.1 메서드 개수 17 -> 19 반영 (관련 텍스트)

주의: nonce는 optional 필드(nonce?: number)이므로 Solana 어댑터에서는 항상 undefined. 파이프라인에서 nonce 접근 시 반드시 tx.nonce !== undefined 가드 사용. 이 주의사항도 문서에 명시.
  </action>
  <verify>
grep -c "v0.7 보완" .planning/deliverables/27-chain-adapter-interface.md 로 [v0.7 보완] 태그가 최소 5회 이상 나타나는지 확인.
grep "getCurrentNonce" .planning/deliverables/27-chain-adapter-interface.md 로 메서드가 존재하는지 확인.
grep "resetNonceTracker" .planning/deliverables/27-chain-adapter-interface.md 로 메서드가 존재하는지 확인.
grep "nonce?: number" .planning/deliverables/27-chain-adapter-interface.md 로 UnsignedTransaction 필드 승격이 있는지 확인.
grep "BLOCKHASH_STALE" .planning/deliverables/27-chain-adapter-interface.md 로 새 에러 코드가 있는지 확인.
grep "19" .planning/deliverables/27-chain-adapter-interface.md | head -5 로 메서드 개수가 19로 업데이트되었는지 확인.
  </verify>
  <done>
27-chain-adapter-interface.md에 IChainAdapter가 getCurrentNonce/resetNonceTracker 포함 19개 메서드로 확장되고, UnsignedTransaction.nonce가 명시적 optional 필드로 승격되고, BLOCKHASH_STALE 에러 코드가 추가되어, EVM nonce 관리가 타입 안전하게 설계되었다.
  </done>
</task>

</tasks>

<verification>
1. 31-solana-adapter-detail.md에 [v0.7 보완] 태그가 있는 blockhash freshness guard 스펙이 존재한다
2. 27-chain-adapter-interface.md의 IChainAdapter가 19개 메서드를 포함한다
3. UnsignedTransaction에 nonce?: number 필드가 명시적으로 선언되어 있다
4. BLOCKHASH_STALE 에러 코드가 두 문서 모두에 반영되어 있다
5. refreshBlockhash() 유틸리티가 Option A(메시지 캐싱) 방식으로 설계되어 있다
6. getBlockHeight()가 사용되고 getSlot()이 freshness guard에서 사용되지 않았다
</verification>

<success_criteria>
- CHAIN-01 해소: Solana signTransaction 직전 blockhash 잔여 수명을 getBlockHeight 기반으로 검사하는 freshness guard가 31-solana-adapter-detail.md에 [v0.7 보완]으로 추가됨
- CHAIN-02 해소: IChainAdapter가 19개 메서드로 확장되고 UnsignedTransaction.nonce가 명시적 optional 필드로 27-chain-adapter-interface.md에 반영됨
- 두 문서 모두 기존 설계를 파괴하지 않고 보완만 수행됨
</success_criteria>

<output>
After completion, create `.planning/phases/26-chain-adapter-stabilization/26-01-SUMMARY.md`
</output>
