---
phase: 66-infra-build-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["66-01"]
files_modified:
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/api/middleware/csp.ts
  - packages/daemon/src/api/middleware/index.ts
  - packages/daemon/src/api/middleware/kill-switch-guard.ts
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/health.ts
  - packages/daemon/src/__tests__/api-server.test.ts
  - packages/daemon/src/__tests__/api-admin-endpoints.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /admin returns 200 with Content-Type text/html containing the SPA index.html"
    - "GET /admin/any-path returns 200 with index.html (SPA fallback)"
    - "config admin_ui = false causes GET /admin to return 404"
    - "GET /admin response includes Content-Security-Policy header with script-src 'self'"
    - "Kill Switch ACTIVATED state allows GET /admin to return 200 (bypass)"
    - "GET /v1/admin/status response includes adminTimeout field (integer)"
    - "Version in GET /v1/admin/status and GET /health reflects actual package.json version, not '0.0.0'"
    - "config.toml [daemon] section accepts admin_ui (boolean) and admin_timeout (int 60-7200) keys"
  artifacts:
    - path: "packages/daemon/src/api/middleware/csp.ts"
      provides: "CSP middleware for /admin/* paths"
      contains: "Content-Security-Policy"
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "admin_ui and admin_timeout config keys in daemon section"
      contains: "admin_ui"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "adminTimeout field in AdminStatusResponseSchema"
      contains: "adminTimeout"
  key_links:
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/public/admin/"
      via: "serveStatic middleware for /admin/* paths"
      pattern: "serveStatic"
    - from: "packages/daemon/src/api/middleware/csp.ts"
      to: "packages/daemon/src/api/server.ts"
      via: "CSP middleware registered for /admin/* before serveStatic"
      pattern: "Content-Security-Policy"
    - from: "packages/daemon/src/api/middleware/kill-switch-guard.ts"
      to: "/admin path bypass"
      via: "path.startsWith check includes /admin"
      pattern: "/admin"
    - from: "packages/daemon/src/infrastructure/config/loader.ts"
      to: "packages/daemon/src/api/server.ts"
      via: "config.daemon.admin_ui controls whether static serving is registered"
      pattern: "admin_ui"
---

<objective>
Add daemon static file serving for the Admin SPA at /admin, CSP security headers, Kill Switch bypass for /admin paths, config.toml extension with admin_ui/admin_timeout keys, adminTimeout in status API, and fix version hardcoding.

Purpose: Enable the daemon to serve the built Admin UI at /admin with proper security headers, conditional toggle, and Kill Switch resilience -- completing the server-side infrastructure for the Admin Web UI.

Output: Modified daemon server.ts with serveStatic, new CSP middleware, updated kill-switch-guard, extended config loader, enhanced admin status response, and version from package.json.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.3.2-admin-ui-impl.md
@.planning/phases/66-infra-build-pipeline/66-01-SUMMARY.md

# Existing daemon files to modify
@packages/daemon/src/api/server.ts
@packages/daemon/src/api/middleware/kill-switch-guard.ts
@packages/daemon/src/api/middleware/index.ts
@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/routes/health.ts
@packages/daemon/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSP middleware + config extension + version fix</name>
  <files>
    packages/daemon/src/api/middleware/csp.ts
    packages/daemon/src/api/middleware/index.ts
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/routes/health.ts
    packages/daemon/src/__tests__/api-server.test.ts
    packages/daemon/src/__tests__/api-admin-endpoints.test.ts
  </files>
  <action>
**1. Create CSP middleware (`packages/daemon/src/api/middleware/csp.ts`):**

New file. A Hono middleware that sets Content-Security-Policy header on responses for /admin paths:

```ts
/**
 * CSP middleware: Content-Security-Policy header for Admin UI paths.
 *
 * Applied to /admin/* routes only. Uses strict CSP:
 * - default-src 'none'
 * - script-src 'self'
 * - style-src 'self' 'unsafe-inline'
 * - connect-src 'self'
 * - img-src 'self' data:
 * - font-src 'self'
 * - base-uri 'self'
 * - form-action 'self'
 *
 * @see docs/67-admin-web-ui-spec.md section 3
 */

import { createMiddleware } from 'hono/factory';

const CSP_VALUE = [
  "default-src 'none'",
  "script-src 'self'",
  "style-src 'self' 'unsafe-inline'",
  "connect-src 'self'",
  "img-src 'self' data:",
  "font-src 'self'",
  "base-uri 'self'",
  "form-action 'self'",
].join('; ');

export const cspMiddleware = createMiddleware(async (c, next) => {
  await next();
  c.res.headers.set('Content-Security-Policy', CSP_VALUE);
});
```

**2. Export CSP from middleware barrel (`packages/daemon/src/api/middleware/index.ts`):**

Add export: `export { cspMiddleware } from './csp.js';`

**3. Extend config loader (`packages/daemon/src/infrastructure/config/loader.ts`):**

Add two new keys to the `daemon` section in `DaemonConfigSchema`:
- `admin_ui`: `z.boolean().default(true)` -- enables/disables admin UI serving
- `admin_timeout`: `z.number().int().min(60).max(7200).default(900)` -- inactivity timeout in seconds (default 15min)

These go inside the existing `daemon: z.object({...})` alongside port, hostname, etc.

**4. Add adminTimeout to AdminStatusResponseSchema (`packages/daemon/src/api/routes/openapi-schemas.ts`):**

Add `adminTimeout: z.number().int()` field to the `AdminStatusResponseSchema` object (after `killSwitchState`).

**5. Update AdminRouteDeps and admin status handler (`packages/daemon/src/api/routes/admin.ts`):**

- Add `adminTimeout: number` to `AdminRouteDeps` interface
- In the GET /admin/status handler, include `adminTimeout: deps.adminTimeout` in the response JSON object (after killSwitchState, before timestamp)

**6. Fix version hardcoding (INFRA-07):**

The version `'0.0.0'` is hardcoded in 3 places. Fix all of them to read from the daemon package.json:

a) In `packages/daemon/src/api/routes/health.ts`:
   - Import `createRequire` from `node:module`, then `const require = createRequire(import.meta.url)` and `const pkg = require('../../package.json') as { version: string }` at module level.
   - Alternatively (simpler since resolveJsonModule is enabled but verbatimModuleSyntax blocks default JSON import in ESM): Use `readFileSync` + `JSON.parse` at module top to read `../../package.json` relative to the source file. But since the compiled code runs from `dist/`, the path needs to be `../package.json` relative to the compiled `dist/api/routes/health.js`. Best approach: use `createRequire(import.meta.url)` which resolves correctly at runtime.
   - Actually, the cleanest approach for this codebase: add a `DAEMON_VERSION` constant exported from a small utility file, or pass version via the function/deps pattern. Since health.ts is a standalone Hono instance (not using deps pattern), the simplest fix is to use `createRequire`:
     ```ts
     import { createRequire } from 'node:module';
     const require = createRequire(import.meta.url);
     const { version: DAEMON_VERSION } = require('../../../package.json') as { version: string };
     ```
     (from dist/api/routes/ back to package.json is 3 levels up)
   - Replace `version: '0.0.0'` with `version: DAEMON_VERSION` in the health route handler.

b) In `packages/daemon/src/api/server.ts`:
   - Same approach: import createRequire, resolve package.json
     ```ts
     import { createRequire } from 'node:module';
     const require = createRequire(import.meta.url);
     const { version: DAEMON_VERSION } = require('../../package.json') as { version: string };
     ```
     (from dist/api/ back to package.json is 2 levels up)
   - Replace `version: '0.0.0'` in the adminRoutes deps with `version: DAEMON_VERSION`
   - Replace `version: '0.0.0'` in the `app.doc('/doc', {...})` call with `version: DAEMON_VERSION`

c) Update test files that assert `version: '0.0.0'`:
   - In `packages/daemon/src/__tests__/api-server.test.ts`: change `expect(body.version).toBe('0.0.0')` to `expect(body.version).toMatch(/^\d+\.\d+\.\d+/)`
   - In `packages/daemon/src/__tests__/api-admin-endpoints.test.ts`: change `expect(body.version).toBe('0.0.0')` to `expect(body.version).toMatch(/^\d+\.\d+\.\d+/)`
  </action>
  <verify>
1. `pnpm --filter @waiaas/daemon typecheck` passes (no TS errors in new/modified files)
2. `pnpm --filter @waiaas/daemon test` passes (existing tests still green, updated version assertions pass)
3. Verify CSP middleware file exists: `cat packages/daemon/src/api/middleware/csp.ts` shows Content-Security-Policy
4. Verify config schema: `grep 'admin_ui' packages/daemon/src/infrastructure/config/loader.ts` shows the new config key
5. Verify AdminStatusResponseSchema: `grep 'adminTimeout' packages/daemon/src/api/routes/openapi-schemas.ts` shows the new field
  </verify>
  <done>
- CSP middleware created with strict policy (default-src 'none', script-src 'self')
- Config loader extended with admin_ui (boolean, default true) and admin_timeout (int 60-7200, default 900)
- AdminStatusResponseSchema includes adminTimeout field
- AdminRouteDeps has adminTimeout, status handler returns it
- Version hardcoding fixed: health.ts, server.ts, and OpenAPI doc all read from package.json
- Test assertions updated to match dynamic version
  </done>
</task>

<task type="auto">
  <name>Task 2: Add static file serving + SPA fallback + Kill Switch bypass in server.ts</name>
  <files>
    packages/daemon/src/api/server.ts
    packages/daemon/src/api/middleware/kill-switch-guard.ts
  </files>
  <action>
**1. Update Kill Switch guard (`packages/daemon/src/api/middleware/kill-switch-guard.ts`):**

Add bypass for `/admin` paths (in addition to existing `/v1/admin/` bypass). The admin SPA at `/admin` and `/admin/*` must load even when kill switch is activated (so the admin can use the UI to recover).

In the `createKillSwitchGuard` middleware, add a check BEFORE the `getState()` call:
```ts
// Admin SPA paths bypass kill switch (need to serve UI for recovery)
if (c.req.path === '/admin' || c.req.path.startsWith('/admin/')) {
  await next();
  return;
}
```

This should be added after the existing `/health` bypass and existing `/v1/admin/` bypass (or combine the `/v1/admin/` and `/admin` checks logically). The key distinction:
- `/v1/admin/*` = API endpoints for admin operations (already bypassed)
- `/admin` and `/admin/*` = static SPA files (new bypass)

**2. Add static file serving in `createApp()` (`packages/daemon/src/api/server.ts`):**

Import serveStatic and CSP middleware:
```ts
import { serveStatic } from '@hono/node-server/serve-static';
import { cspMiddleware } from './middleware/index.js';
```

After all existing route registrations (after the `app.doc('/doc', ...)` call), conditionally register admin UI serving based on `config.daemon.admin_ui`:

```ts
// Register Admin UI static serving (conditional on config)
if (deps.config?.daemon?.admin_ui !== false) {
  // CSP headers for admin paths
  app.use('/admin/*', cspMiddleware);

  // Serve static files from public/admin/
  app.use('/admin/*', serveStatic({
    root: './public/admin/',
    rewriteRequestPath: (path: string) => path.replace(/^\/admin/, ''),
  }));

  // SPA fallback: any /admin/* path that didn't match a static file -> index.html
  app.get('/admin/*', serveStatic({
    root: './public/admin/',
    path: 'index.html',
  }));

  // Redirect /admin to /admin/ for consistency
  app.get('/admin', (c) => c.redirect('/admin/'));
}
```

Important implementation notes:
- `@hono/node-server/serve-static` is the correct import for Node.js runtime (tech decision #13). Do NOT use `hono/serve-static` which is for Cloudflare/Deno.
- The `root` path is relative to the process working directory. Since the daemon runs from the package root, `./public/admin/` resolves to `packages/daemon/public/admin/` at runtime. However, when running from dist/, we need `root` relative to CWD. The Hono Node.js serveStatic uses `path.resolve(root)` from CWD.
- Actually, since `@hono/node-server` v1.19+ the `root` in serveStatic is resolved relative to the project root (CWD). When the daemon is started via CLI (`waiaas start`), the CWD is the data directory, but the static files are in the package directory. This needs careful handling.
- **Resolution**: Use `path.resolve()` with `import.meta.url` to resolve the static directory path relative to the module file. Compute the absolute path to `public/admin/`:
  ```ts
  import { fileURLToPath } from 'node:url';
  import { dirname, join } from 'node:path';

  const __filename = fileURLToPath(import.meta.url);
  const __dirname = dirname(__filename);
  // From dist/api/server.js -> ../../public/admin
  const ADMIN_STATIC_ROOT = join(__dirname, '..', '..', 'public', 'admin');
  ```
  Then use `root: ADMIN_STATIC_ROOT` in serveStatic. But check `@hono/node-server/serve-static` API -- it may accept `root` as absolute path. If not, use the approach that works.
- Actually, the simplest Hono Node.js serveStatic pattern is:
  ```ts
  app.use('/admin/*', serveStatic({ root: ADMIN_STATIC_ROOT }));
  ```
  Where the middleware strips the matched prefix and serves from the root directory. Check the `@hono/node-server` serveStatic docs for exact API. The `rewriteRequestPath` option can strip `/admin` prefix.

- **SPA fallback note**: The Admin UI uses hash routing (`preact-router` + hash history, tech decision #14), so the server-side fallback to index.html is mainly a safety net for direct URL access. With hash routing, all navigation happens client-side via `#/path`.

- CSP middleware is registered BEFORE serveStatic so the headers are set on the response.

**3. Pass adminTimeout to adminRoutes in server.ts:**

In the admin routes registration block, add `adminTimeout` to the deps:
```ts
adminRoutes({
  // ... existing deps ...
  version: DAEMON_VERSION,
  adminTimeout: deps.config?.daemon?.admin_timeout ?? 900,
}),
```
  </action>
  <verify>
1. `pnpm --filter @waiaas/daemon build` succeeds
2. `pnpm --filter @waiaas/daemon test` passes
3. Manual verification (if daemon can be started):
   - Start daemon with default config -> `curl http://127.0.0.1:3100/admin` returns 200 with HTML
   - Check response headers include `Content-Security-Policy: ... script-src 'self' ...`
   - `curl http://127.0.0.1:3100/v1/admin/status` (with auth) includes `adminTimeout` in response
4. Kill switch guard: verify the code has both `/admin` and `/v1/admin/` bypass paths
  </verify>
  <done>
- serveStatic serves admin SPA at /admin from packages/daemon/public/admin/
- CSP headers applied to /admin/* responses
- SPA fallback returns index.html for unmatched /admin/* paths
- admin_ui = false config disables static serving (404)
- Kill Switch bypass includes /admin and /admin/* paths
- adminTimeout passed from config to admin status response
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds (turbo builds admin -> daemon in correct order)
2. `pnpm test` passes (all 784+ existing tests, updated version assertions)
3. CSP middleware exists and exports from barrel
4. Config loader has admin_ui + admin_timeout keys
5. AdminStatusResponse includes adminTimeout
6. Kill switch guard bypasses /admin paths
7. server.ts conditionally serves static files based on admin_ui config
8. Version reads from package.json (no more '0.0.0' hardcoding)
</verification>

<success_criteria>
- GET /admin returns SPA index.html with CSP headers
- GET /admin with admin_ui=false returns 404
- Kill Switch ACTIVATED + GET /admin returns 200
- GET /v1/admin/status includes adminTimeout field
- Version is actual package.json version, not '0.0.0'
- Config.toml [daemon] supports admin_ui and admin_timeout
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/66-infra-build-pipeline/66-02-SUMMARY.md`
</output>
