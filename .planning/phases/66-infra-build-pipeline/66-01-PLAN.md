---
phase: 66-infra-build-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/package.json
  - packages/admin/tsconfig.json
  - packages/admin/vite.config.ts
  - packages/admin/index.html
  - packages/admin/src/main.tsx
  - packages/admin/src/app.tsx
  - packages/admin/src/styles/global.css
  - turbo.json
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "`pnpm --filter @waiaas/admin build` succeeds and produces dist/index.html + dist/assets/*.js + dist/assets/*.css"
    - "Build artifacts are copied to packages/daemon/public/admin/ via postbuild script"
    - "turbo.json ensures @waiaas/daemon#build depends on @waiaas/admin#build"
    - "packages/daemon/public/admin/ is git-ignored"
    - "Admin package has 0 runtime dependencies (all devDependencies)"
  artifacts:
    - path: "packages/admin/package.json"
      provides: "Preact + Vite dev dependencies, build + postbuild scripts"
      contains: "@waiaas/admin"
    - path: "packages/admin/vite.config.ts"
      provides: "Vite build config with Preact preset, modulePreload polyfill disabled"
      contains: "modulePreload"
    - path: "packages/admin/index.html"
      provides: "SPA entry HTML with root div and script module"
    - path: "packages/admin/src/main.tsx"
      provides: "Preact render mount point"
      contains: "render"
    - path: "turbo.json"
      provides: "Explicit build dependency for daemon on admin"
      contains: "@waiaas/daemon#build"
  key_links:
    - from: "packages/admin/vite.config.ts"
      to: "packages/admin/index.html"
      via: "Vite build entry point"
      pattern: "build.*modulePreload"
    - from: "packages/admin/package.json postbuild"
      to: "packages/daemon/public/admin/"
      via: "cp -r dist/* ../daemon/public/admin/"
      pattern: "postbuild"
    - from: "turbo.json"
      to: "@waiaas/daemon#build"
      via: "dependsOn includes @waiaas/admin#build"
      pattern: "@waiaas/admin#build"
---

<objective>
Scaffold the @waiaas/admin Preact package with Vite build pipeline, configure turbo.json for build ordering, and ensure build artifacts are copied to daemon/public/admin/.

Purpose: Establish the frontend build infrastructure so that `pnpm build` produces a working SPA bundle that the daemon can serve as static files. This is the foundation for all subsequent Admin UI work.

Output: packages/admin/ package with Vite config, entry HTML, minimal Preact app shell, postbuild copy script, turbo.json build dependency, and gitignore entry.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.3.2-admin-ui-impl.md

# Existing files for reference
@packages/daemon/package.json
@turbo.json
@.gitignore
@tsconfig.base.json
@pnpm-workspace.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create @waiaas/admin package with Vite + Preact build config</name>
  <files>
    packages/admin/package.json
    packages/admin/tsconfig.json
    packages/admin/vite.config.ts
    packages/admin/index.html
    packages/admin/src/main.tsx
    packages/admin/src/app.tsx
    packages/admin/src/styles/global.css
  </files>
  <action>
Create the `packages/admin/` package directory with the following files:

**packages/admin/package.json:**
- name: `@waiaas/admin`
- version: `0.0.0`
- private: true (not published to npm)
- type: `module`
- scripts:
  - `build`: `vite build`
  - `postbuild`: `mkdir -p ../daemon/public/admin && cp -r dist/* ../daemon/public/admin/`
  - `dev`: `vite` (for local development)
  - `clean`: `rm -rf dist`
- devDependencies (all dev, 0 runtime):
  - `preact`: `^10.25.0`
  - `@preact/preset-vite`: `^2.9.0`
  - `@preact/signals`: `^2.0.0`
  - `preact-router`: `^4.1.0`
  - `vite`: `^6.1.0`
  - `typescript`: `^5.7.0`
- No `main`, `types`, `exports`, or `files` fields (this package is never imported by others)

**packages/admin/tsconfig.json:**
- Extend `../../tsconfig.base.json` but override for Preact JSX:
  - `compilerOptions.jsx`: `react-jsx`
  - `compilerOptions.jsxImportSource`: `preact`
  - `compilerOptions.outDir`: `dist`
  - `compilerOptions.rootDir`: `src`
  - Remove `verbatimModuleSyntax` (override to false or omit -- Preact JSX transform is incompatible)
  - `compilerOptions.module`: `ESNext`
  - `compilerOptions.moduleResolution`: `bundler`
  - `compilerOptions.noUnusedLocals`: false (development convenience)
  - `compilerOptions.noUnusedParameters`: false (development convenience)
- include: `["src"]`
- Do NOT set `composite: true` (not a project reference target)

**packages/admin/vite.config.ts:**
```ts
import { defineConfig } from 'vite';
import preact from '@preact/preset-vite';

export default defineConfig({
  plugins: [preact()],
  build: {
    outDir: 'dist',
    modulePreload: { polyfill: false }, // CSP script-src 'self' compatibility (tech decision #15)
    target: 'es2022',
    sourcemap: false,  // production build, no sourcemaps for admin
  },
  // Base path for assets -- admin is served at /admin/
  base: '/admin/',
});
```

**packages/admin/index.html:**
Minimal HTML5 document:
- `<!DOCTYPE html>`, lang="en", charset utf-8, viewport meta
- Title: "WAIaaS Admin"
- `<div id="app"></div>`
- `<script type="module" src="/src/main.tsx"></script>`

**packages/admin/src/main.tsx:**
```tsx
import { render } from 'preact';
import { App } from './app';
import './styles/global.css';

render(<App />, document.getElementById('app')!);
```

**packages/admin/src/app.tsx:**
Minimal placeholder app component that renders "WAIaaS Admin" heading. This will be replaced in Phase 67 with routing and auth guard. For now:
```tsx
export function App() {
  return <div><h1>WAIaaS Admin</h1><p>Loading...</p></div>;
}
```

**packages/admin/src/styles/global.css:**
Minimal CSS reset + CSS variables stub (will be expanded in Phase 67):
```css
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --color-bg: #0f1117;
  --color-surface: #1a1d27;
  --color-text: #e1e4eb;
  --color-primary: #3b82f6;
  --color-error: #ef4444;
  --color-success: #22c55e;
  --font-sans: system-ui, -apple-system, sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', monospace;
}
body { font-family: var(--font-sans); background: var(--color-bg); color: var(--color-text); }
```

After creating files, run `pnpm install` from the workspace root to install the new devDependencies.
  </action>
  <verify>
1. `cd /path/to/WAIaaS && pnpm install` succeeds (lockfile updates)
2. `pnpm --filter @waiaas/admin build` succeeds
3. `ls packages/admin/dist/index.html` exists
4. `ls packages/admin/dist/assets/` contains .js and .css files
5. `ls packages/daemon/public/admin/index.html` exists (postbuild copy worked)
6. Check packages/admin/package.json has 0 `dependencies` (only `devDependencies`)
  </verify>
  <done>
- `@waiaas/admin` package exists with Vite + Preact build config
- `pnpm --filter @waiaas/admin build` produces dist/index.html + assets
- postbuild copies output to packages/daemon/public/admin/
- All dependencies are devDependencies (0 runtime deps)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure turbo.json build dependency + gitignore + daemon package.json</name>
  <files>
    turbo.json
    .gitignore
    packages/daemon/package.json
  </files>
  <action>
**turbo.json:**
Add explicit build dependency so daemon build waits for admin build. The current `^build` only handles workspace dependency edges, but admin is NOT a dependency of daemon in package.json -- only a build artifact is copied. Add package-specific task config:

```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "@waiaas/admin#build": {
      "dependsOn": [],
      "outputs": ["dist/**"]
    },
    "@waiaas/daemon#build": {
      "dependsOn": ["@waiaas/admin#build", "^build"],
      "outputs": ["dist/**"]
    },
    "test": {
      "dependsOn": ["build"],
      "outputs": []
    },
    "lint": {
      "outputs": []
    },
    "typecheck": {
      "dependsOn": ["^build"],
      "outputs": []
    },
    "clean": {
      "cache": false
    }
  }
}
```

Key points:
- `@waiaas/admin#build` has no `^build` dependency (admin has no workspace deps)
- `@waiaas/daemon#build` explicitly depends on `@waiaas/admin#build` plus existing `^build`
- All other tasks remain unchanged

**.gitignore:**
Add entry for admin build artifacts in daemon:
```
# Admin UI build artifacts (copied by @waiaas/admin postbuild)
packages/daemon/public/
```

**packages/daemon/package.json:**
Add `"public"` to the `files` array so the admin UI is included in the npm package:
```json
"files": [
  "dist",
  "public"
]
```
  </action>
  <verify>
1. `pnpm build` succeeds (turbo builds admin before daemon)
2. `git status` shows `packages/daemon/public/admin/` is NOT tracked (gitignored)
3. Verify turbo.json is valid JSON and contains `@waiaas/daemon#build` with `@waiaas/admin#build` in dependsOn
4. Verify packages/daemon/package.json `files` array includes `"public"`
  </verify>
  <done>
- turbo.json ensures admin builds before daemon via explicit `@waiaas/daemon#build` dependency
- Build artifacts in packages/daemon/public/ are git-ignored
- daemon package.json includes `public` in files array for npm packaging
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin build` succeeds
2. `ls packages/daemon/public/admin/index.html` exists
3. `pnpm build` completes (turbo builds admin first, then daemon)
4. `packages/daemon/public/admin/` is in .gitignore (not tracked by git)
5. No runtime dependencies in packages/admin/package.json
</verification>

<success_criteria>
- @waiaas/admin package scaffolded with Preact + Vite
- Build produces dist/index.html + assets/*.js + assets/*.css
- postbuild copies to packages/daemon/public/admin/
- turbo.json orders admin build before daemon build
- Build artifacts git-ignored, daemon package.json includes public/
</success_criteria>

<output>
After completion, create `.planning/phases/66-infra-build-pipeline/66-01-SUMMARY.md`
</output>
