---
phase: 122-mcp-multichain-dx
plan: 02
type: execute
wave: 2
depends_on: ["122-01"]
files_modified:
  - packages/daemon/src/api/routes/wallet.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/__tests__/api-wallet-network.test.ts
  - packages/mcp/src/tools/get-balance.ts
  - packages/mcp/src/tools/get-assets.ts
  - packages/mcp/src/__tests__/tools.test.ts
  - packages/sdk/src/client.ts
  - packages/sdk/src/types.ts
  - packages/sdk/src/__tests__/client.test.ts
  - python-sdk/waiaas/client.py
  - python-sdk/waiaas/models.py
  - python-sdk/tests/test_client.py
  - skills/wallet.skill.md
autonomous: true

must_haves:
  truths:
    - "GET /v1/wallet/balance?network=all이 환경 내 모든 네트워크 잔액을 배열로 반환한다"
    - "GET /v1/wallet/assets?network=all이 환경 내 모든 네트워크 토큰 자산을 배열로 반환한다"
    - "일부 네트워크 RPC 실패 시 성공한 네트워크 잔액만 반환하고 실패 네트워크는 에러 표시한다"
    - "MCP get_balance/get_assets에 network=all 옵션이 동작한다"
    - "wallet.skill.md에 network=all, set_default_network, wallet info가 반영된다"
    - "기존 network 미지정/특정 네트워크 지정 동작이 변경되지 않는다"
  artifacts:
    - path: "packages/daemon/src/api/routes/wallet.ts"
      provides: "network=all 분기 처리 (balance + assets)"
      contains: "network.*all|allSettled"
    - path: "packages/daemon/src/__tests__/api-wallet-network.test.ts"
      provides: "network=all 통합 테스트"
      contains: "network=all"
    - path: "skills/wallet.skill.md"
      provides: "업데이트된 스킬 문서"
      contains: "network=all"
  key_links:
    - from: "packages/daemon/src/api/routes/wallet.ts"
      to: "@waiaas/core getNetworksForEnvironment"
      via: "import and call for network enumeration"
      pattern: "getNetworksForEnvironment"
    - from: "packages/daemon/src/api/routes/wallet.ts"
      to: "Promise.allSettled"
      via: "parallel RPC calls"
      pattern: "allSettled"
    - from: "packages/mcp/src/tools/get-balance.ts"
      to: "GET /v1/wallet/balance?network=all"
      via: "apiClient.get with network=all query"
      pattern: "network.*all"
---

<objective>
GET /v1/wallet/balance?network=all 및 GET /v1/wallet/assets?network=all로 환경 내 모든 네트워크의 잔액/자산을 한 번에 조회할 수 있게 하고, MCP/SDK에서도 동일하게 지원하며, wallet.skill.md를 업데이트한다.

Purpose: AI 에이전트가 "잔액 확인해줘"라고 요청받으면 한 번의 호출로 모든 네트워크 잔액을 볼 수 있어야 한다 (이슈 021). 스킬 파일 동기화 필수 (CLAUDE.md 인터페이스 싱크 규칙).
Output: daemon API 2개 분기 추가, MCP 도구 설명 업데이트 2개, SDK 메서드 타입 추가, 스킬 파일 업데이트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/122-mcp-multichain-dx/122-01-SUMMARY.md

@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/wallets.ts
@packages/daemon/src/__tests__/api-wallet-network.test.ts
@packages/core/src/enums/chain.ts
@packages/mcp/src/tools/get-balance.ts
@packages/mcp/src/tools/get-assets.ts
@packages/sdk/src/client.ts
@packages/sdk/src/types.ts
@python-sdk/waiaas/client.py
@python-sdk/waiaas/models.py
@skills/wallet.skill.md
@objectives/issues/v1.4.6-021-multichain-aggregate-balance.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: daemon network=all 분기 + 부분 실패 처리 + 테스트</name>
  <files>
    packages/daemon/src/api/routes/wallet.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/__tests__/api-wallet-network.test.ts
  </files>
  <action>
  **1. wallet.ts: GET /wallet/balance에 network=all 분기 추가**

  기존 walletBalanceRoute 핸들러에서 `queryNetwork === 'all'` 분기를 추가한다:

  ```typescript
  router.openapi(walletBalanceRoute, async (c) => {
    const walletId = c.get('walletId' as never) as string;
    const wallet = await resolveWalletById(deps.db, walletId);

    if (!deps.adapterPool || !deps.config) {
      throw new WAIaaSError('CHAIN_ERROR', { message: 'Chain adapter not available' });
    }

    const { network: queryNetwork } = c.req.valid('query');

    // --- network=all: 환경 내 모든 네트워크 잔액을 배열로 반환 ---
    if (queryNetwork === 'all') {
      const networks = getNetworksForEnvironment(
        wallet.chain as ChainType,
        wallet.environment as EnvironmentType,
      );

      const results = await Promise.allSettled(
        networks.map(async (net) => {
          const rpcUrl = resolveRpcUrl(
            deps.config!.rpc as unknown as Record<string, string>,
            wallet.chain,
            net.network,
          );
          const adapter = await deps.adapterPool!.resolve(
            wallet.chain as ChainType,
            net.network as NetworkType,
            rpcUrl,
          );
          const balanceInfo = await adapter.getBalance(wallet.publicKey);
          return {
            network: net.network,
            balance: balanceInfo.balance.toString(),
            decimals: balanceInfo.decimals,
            symbol: balanceInfo.symbol,
          };
        }),
      );

      const balances = results.map((r, i) => {
        if (r.status === 'fulfilled') {
          return r.value;
        }
        return {
          network: networks[i]!.network,
          error: r.reason instanceof Error ? r.reason.message : 'Unknown error',
        };
      });

      return c.json({ walletId: wallet.id, chain: wallet.chain, environment: wallet.environment, balances }, 200);
    }

    // --- 기존 동작: 특정 네트워크 또는 기본 네트워크 ---
    // (기존 코드 유지)
  });
  ```

  `getNetworksForEnvironment`를 `@waiaas/core`에서 import한다. 이미 wallets.ts에서 사용 중이므로 패턴을 따른다.

  **2. wallet.ts: GET /wallet/assets에 network=all 분기 추가**

  동일한 패턴으로 assets에도 적용:

  ```typescript
  if (queryNetwork === 'all') {
    const networks = getNetworksForEnvironment(...);

    const results = await Promise.allSettled(
      networks.map(async (net) => {
        // resolve adapter, wire ERC-20 tokens if EVM, call getAssets
        // 기존 assets 핸들러의 ERC-20 wiring 로직을 함수로 추출하여 재사용
        const rpcUrl = resolveRpcUrl(...);
        const adapter = await deps.adapterPool!.resolve(...);

        // ERC-20 token wiring (EVM only)
        if (wallet.chain === 'ethereum' && 'setAllowedTokens' in adapter) {
          // 기존 로직 재사용 (tokenRegistryService + ALLOWED_TOKENS policy)
        }

        const assets = await adapter.getAssets(wallet.publicKey);
        return {
          network: net.network,
          assets: assets.map(a => ({
            mint: a.mint,
            symbol: a.symbol,
            name: a.name,
            balance: a.balance.toString(),
            decimals: a.decimals,
            isNative: a.isNative,
            usdValue: a.usdValue,
          })),
        };
      }),
    );

    const networkAssets = results.map((r, i) => {
      if (r.status === 'fulfilled') return r.value;
      return { network: networks[i]!.network, error: r.reason?.message ?? 'Unknown error' };
    });

    return c.json({ walletId: wallet.id, chain: wallet.chain, environment: wallet.environment, networkAssets }, 200);
  }
  ```

  NOTE: ERC-20 토큰 와이어링 로직이 중복되므로, 기존 핸들러의 코드를 헬퍼 함수 `wireEvmTokens(adapter, wallet, deps)` 로 추출하여 재사용한다.

  **3. OpenAPI 스키마 업데이트** (`packages/daemon/src/api/routes/openapi-schemas.ts`):

  network=all 응답은 기존 단일 객체와 다른 형태. OpenAPI route에서 `network` query parameter의 describe를 업데이트하여 `'all'` 값이 지원됨을 명시. 응답 스키마는 200에서 union 타입이 되므로, 기존 스키마를 유지하면서 별도 문서화 (OpenAPI union은 복잡하므로 runtime에서 분기 처리).

  실용적 접근: `walletBalanceRoute`와 `walletAssetsRoute`의 query schema에서 network 필드의 describe를 업데이트:
  ```typescript
  network: z.string().optional().describe(
    "Network to query. Use 'all' to get balances for all networks in the wallet's environment."
  ),
  ```

  **4. 통합 테스트** (`packages/daemon/src/__tests__/api-wallet-network.test.ts`):

  파일 하단에 새 describe 블록 추가:

  ```typescript
  describe('GET /v1/wallet/balance?network=all', () => {
    it('returns balances array for all environment networks', async () => {
      // Setup: EVM testnet wallet with session
      // GET /v1/wallet/balance?network=all
      // Expect: { balances: [...] } 배열, 환경 내 네트워크 수만큼
    });

    it('returns error for networks with RPC failure', async () => {
      // Setup: mock adapter pool where one network throws
      // Expect: 성공 네트워크 balance + 실패 네트워크 error 표시
    });

    it('maintains backward compatibility for specific network', async () => {
      // GET /v1/wallet/balance?network=ethereum-sepolia
      // Expect: 기존 단일 객체 응답 (walletId, chain, network, balance, ...)
    });
  });

  describe('GET /v1/wallet/assets?network=all', () => {
    it('returns assets array for all environment networks', async () => {
      // GET /v1/wallet/assets?network=all
      // Expect: { networkAssets: [...] } 배열
    });
  });
  ```

  테스트에서 AdapterPool mock이 필요하다. 기존 테스트 패턴에서 mock adapter를 사용하는 방법을 참조한다. api-wallet-network.test.ts에서 이미 mock AdapterPool을 사용하고 있으므로, `resolve()` 메서드가 네트워크별로 다른 결과를 반환하도록 설정한다. RPC 실패 시나리오는 특정 네트워크에서 getBalance()가 throw하도록 mock한다.
  </action>
  <verify>
  1. `pnpm --filter @waiaas/daemon build` 성공
  2. `pnpm --filter @waiaas/daemon test` 통과 (network=all 4개 테스트 포함)
  3. 기존 balance/assets 테스트가 회귀 없이 통과
  </verify>
  <done>
  - GET /v1/wallet/balance?network=all이 환경 내 모든 네트워크 잔액을 배열로 반환한다
  - GET /v1/wallet/assets?network=all이 환경 내 모든 네트워크 자산을 배열로 반환한다
  - 일부 네트워크 RPC 실패 시 성공한 네트워크만 정상 반환하고 실패 네트워크는 error 표시
  - 기존 동작 (미지정/특정 네트워크) 하위호환 유지
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP/SDK network=all 지원 + wallet.skill.md 업데이트</name>
  <files>
    packages/mcp/src/tools/get-balance.ts
    packages/mcp/src/tools/get-assets.ts
    packages/mcp/src/__tests__/tools.test.ts
    packages/sdk/src/client.ts
    packages/sdk/src/types.ts
    packages/sdk/src/__tests__/client.test.ts
    python-sdk/waiaas/client.py
    python-sdk/waiaas/models.py
    python-sdk/tests/test_client.py
    skills/wallet.skill.md
  </files>
  <action>
  **1. MCP get_balance 도구 설명 업데이트** (`packages/mcp/src/tools/get-balance.ts`):

  기존 network 파라미터의 describe를 업데이트:
  ```typescript
  network: z.string().optional().describe(
    "Query balance for specific network. Use 'all' to get balances for all networks. Defaults to wallet default network."
  ),
  ```

  도구 핸들러는 변경 불필요 -- network=all 값이 그대로 query parameter로 전달되면 daemon이 처리한다.

  **2. MCP get_assets 도구 설명 업데이트** (`packages/mcp/src/tools/get-assets.ts`):

  동일 패턴:
  ```typescript
  network: z.string().optional().describe(
    "Query assets for specific network. Use 'all' to get assets for all networks. Defaults to wallet default network."
  ),
  ```

  **3. MCP 도구 테스트 추가** (`packages/mcp/src/__tests__/tools.test.ts`):

  ```typescript
  describe('get_balance tool with network=all', () => {
    it('passes network=all query parameter', async () => {
      const responses = new Map([
        ['GET:/v1/wallet/balance?network=all', { ok: true, data: { balances: [{ network: 'devnet', balance: '100' }] } }],
      ]);
      const apiClient = createMockApiClient(responses);
      const handler = getToolHandler(registerGetBalance, apiClient);
      const result = await handler({ network: 'all' });
      expect(apiClient.get).toHaveBeenCalledWith('/v1/wallet/balance?network=all');
    });
  });
  ```

  **4. TS SDK 타입 추가** (`packages/sdk/src/types.ts`):

  ```typescript
  // Multi-network balance (network=all)
  export interface MultiNetworkBalanceEntry {
    network: string;
    balance?: string;
    decimals?: number;
    symbol?: string;
    error?: string;
  }

  export interface MultiNetworkBalanceResponse {
    walletId: string;
    chain: string;
    environment: string;
    balances: MultiNetworkBalanceEntry[];
  }

  // Multi-network assets (network=all)
  export interface MultiNetworkAssetsEntry {
    network: string;
    assets?: AssetInfo[];
    error?: string;
  }

  export interface MultiNetworkAssetsResponse {
    walletId: string;
    chain: string;
    environment: string;
    networkAssets: MultiNetworkAssetsEntry[];
  }
  ```

  **5. TS SDK 클라이언트 업데이트** (`packages/sdk/src/client.ts`):

  기존 getBalance/getAssets는 그대로 두되, network='all'을 전달하면 다른 타입이 반환되므로 오버로드 또는 별도 메서드를 추가:

  **별도 메서드 방식 (타입 안전성 우선)**:
  ```typescript
  async getAllBalances(): Promise<MultiNetworkBalanceResponse> {
    return withRetry(
      () => this.http.get<MultiNetworkBalanceResponse>(
        '/v1/wallet/balance?network=all',
        this.authHeaders(),
      ),
      this.retryOptions,
    );
  }

  async getAllAssets(): Promise<MultiNetworkAssetsResponse> {
    return withRetry(
      () => this.http.get<MultiNetworkAssetsResponse>(
        '/v1/wallet/assets?network=all',
        this.authHeaders(),
      ),
      this.retryOptions,
    );
  }
  ```

  이슈 021의 설계 결정 근거와 일치: "SDK 타입 안전성: 반환 타입 예측 가능". 기존 getBalance/getAssets에 'all' 문자열을 전달하면 타입 불일치가 발생하므로 별도 메서드가 적절하다.

  **6. TS SDK 테스트** (`packages/sdk/src/__tests__/client.test.ts`):

  ```typescript
  describe('getAllBalances', () => {
    it('calls GET /v1/wallet/balance?network=all', async () => {
      // Mock + verify
    });
  });

  describe('getAllAssets', () => {
    it('calls GET /v1/wallet/assets?network=all', async () => {
      // Mock + verify
    });
  });
  ```

  **7. Python SDK 모델/클라이언트 추가** (`python-sdk/waiaas/models.py` + `client.py`):

  ```python
  # models.py
  class MultiNetworkBalance(BaseModel):
      network: str
      balance: Optional[str] = None
      decimals: Optional[int] = None
      symbol: Optional[str] = None
      error: Optional[str] = None

  class MultiNetworkBalanceResponse(BaseModel):
      wallet_id: str = Field(alias="walletId")
      chain: str
      environment: str
      balances: list[MultiNetworkBalance]
      model_config = {"populate_by_name": True}

  class MultiNetworkAssets(BaseModel):
      network: str
      assets: Optional[list[AssetInfo]] = None
      error: Optional[str] = None

  class MultiNetworkAssetsResponse(BaseModel):
      wallet_id: str = Field(alias="walletId")
      chain: str
      environment: str
      network_assets: list[MultiNetworkAssets] = Field(alias="networkAssets")
      model_config = {"populate_by_name": True}
  ```

  ```python
  # client.py
  async def get_all_balances(self) -> MultiNetworkBalanceResponse:
      """GET /v1/wallet/balance?network=all -- Get balances for all networks."""
      resp = await self._request("GET", "/v1/wallet/balance", params={"network": "all"})
      return MultiNetworkBalanceResponse.model_validate(resp.json())

  async def get_all_assets(self) -> MultiNetworkAssetsResponse:
      """GET /v1/wallet/assets?network=all -- Get assets for all networks."""
      resp = await self._request("GET", "/v1/wallet/assets", params={"network": "all"})
      return MultiNetworkAssetsResponse.model_validate(resp.json())
  ```

  Python 테스트도 추가.

  **8. wallet.skill.md 업데이트** (`skills/wallet.skill.md`):

  다음 내용을 적절한 위치에 추가/수정:

  1. Section 2 "Wallet Query" 에 `GET /v1/wallet/balance?network=all` 문서 추가:
     ```markdown
     ### GET /v1/wallet/balance?network=all -- Get All Network Balances

     Returns native balances for all networks in the wallet's environment. Useful for getting a complete picture of the wallet's holdings across all chains.

     Response (200):
     ```json
     {
       "walletId": "...",
       "chain": "ethereum",
       "environment": "testnet",
       "balances": [
         { "network": "ethereum-sepolia", "balance": "500000000000000000", "decimals": 18, "symbol": "ETH" },
         { "network": "polygon-amoy", "balance": "1200000000000000000", "decimals": 18, "symbol": "POL" },
         { "network": "arbitrum-sepolia", "error": "RPC timeout" }
       ]
     }
     ```
     ```

  2. `PUT /v1/wallet/default-network` 세션 스코프 엔드포인트 문서 추가 (122-01에서 생성)

  3. `waiaas wallet info` CLI 명령어 문서 추가

  4. `set_default_network` MCP 도구 문서 추가

  5. 버전을 1.4.8로 업데이트
  </action>
  <verify>
  1. `pnpm --filter @waiaas/mcp build && pnpm --filter @waiaas/mcp test` 통과
  2. `pnpm --filter @waiaas/sdk build && pnpm --filter @waiaas/sdk test` 통과
  3. `cd python-sdk && python -m pytest tests/` 통과
  4. `grep -c 'network=all' skills/wallet.skill.md` >= 1
  5. `grep -c 'set_default_network\|set-default-network\|wallet info' skills/wallet.skill.md` >= 3
  6. 전체: `pnpm build` 성공
  </verify>
  <done>
  - GET /v1/wallet/balance?network=all과 GET /v1/wallet/assets?network=all이 MCP/SDK에서 사용 가능
  - MCP get_balance/get_assets 도구 설명에 network=all 안내 추가
  - TS SDK getAllBalances()/getAllAssets(), Python SDK get_all_balances()/get_all_assets() 메서드 추가
  - wallet.skill.md에 network=all, set_default_network, wallet info, PUT /v1/wallet/default-network 반영
  - 이슈 021 완전 해결, SKIL-01 충족
  </done>
</task>

</tasks>

<verification>
1. **MCDX-01**: MCP set_default_network + CLI set-default-network + SDK setDefaultNetwork 동작
2. **MCDX-02**: CLI `waiaas wallet info` 출력에 chain, environment, address, defaultNetwork, availableNetworks 포함
3. **MCDX-03**: TS SDK getWalletInfo() + Python SDK get_wallet_info() 동작
4. **MCDX-04**: GET /v1/wallet/balance?network=all이 배열 응답 반환
5. **MCDX-05**: GET /v1/wallet/assets?network=all이 배열 응답 반환
6. **MCDX-06**: MCP get_balance/get_assets에서 network='all' 전달 시 배열 응답
7. **MCDX-07**: 부분 실패 시 에러 네트워크와 성공 네트워크가 함께 반환
8. **SKIL-01**: wallet.skill.md에 신규 기능 문서화
9. 전체 빌드: `pnpm build` 성공, 기존 테스트 회귀 없음
</verification>

<success_criteria>
- 8개 요구사항(MCDX-01~07, SKIL-01) 모두 충족
- MCP 도구 14개 (기존 13 + set_default_network)
- daemon 엔드포인트 +1 (PUT /v1/wallet/default-network)
- TS SDK 메서드 +4 (setDefaultNetwork, getWalletInfo, getAllBalances, getAllAssets)
- Python SDK 메서드 +4 (set_default_network, get_wallet_info, get_all_balances, get_all_assets)
- CLI 서브커맨드 +2 (wallet info, wallet set-default-network)
- 신규 테스트 ~15개 추가, 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/122-mcp-multichain-dx/122-02-SUMMARY.md`
</output>
