---
phase: 122-mcp-multichain-dx
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/tools/set-default-network.ts
  - packages/mcp/src/server.ts
  - packages/mcp/src/__tests__/tools.test.ts
  - packages/cli/src/index.ts
  - packages/cli/src/commands/wallet.ts
  - packages/sdk/src/client.ts
  - packages/sdk/src/types.ts
  - packages/sdk/src/index.ts
  - packages/sdk/src/__tests__/client.test.ts
  - python-sdk/waiaas/client.py
  - python-sdk/waiaas/models.py
  - python-sdk/tests/test_client.py
autonomous: true

must_haves:
  truths:
    - "MCP set_default_network 도구로 기본 네트워크를 변경할 수 있다"
    - "CLI `waiaas wallet set-default-network <network>` 명령어로 기본 네트워크를 변경할 수 있다"
    - "TS SDK client.setDefaultNetwork('polygon-amoy')가 동작한다"
    - "Python SDK client.set_default_network('polygon-amoy')가 동작한다"
    - "환경 불일치 네트워크 지정 시 에러가 반환된다"
  artifacts:
    - path: "packages/mcp/src/tools/set-default-network.ts"
      provides: "set_default_network MCP tool registration"
      exports: ["registerSetDefaultNetwork"]
    - path: "packages/cli/src/commands/wallet.ts"
      provides: "wallet subcommand group with info + set-default-network"
      exports: ["walletInfoCommand", "walletSetDefaultNetworkCommand"]
    - path: "packages/sdk/src/client.ts"
      provides: "setDefaultNetwork method"
      contains: "setDefaultNetwork"
    - path: "python-sdk/waiaas/client.py"
      provides: "set_default_network method"
      contains: "set_default_network"
  key_links:
    - from: "packages/mcp/src/tools/set-default-network.ts"
      to: "PUT /v1/wallets/:id/default-network"
      via: "apiClient.put"
      pattern: "wallets.*default-network"
    - from: "packages/mcp/src/server.ts"
      to: "packages/mcp/src/tools/set-default-network.ts"
      via: "registerSetDefaultNetwork import and call"
      pattern: "registerSetDefaultNetwork"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/wallet.ts"
      via: "commander subcommand group"
      pattern: "wallet.*set-default-network"
---

<objective>
set_default_network MCP 도구, CLI 명령어, SDK 메서드를 추가하여 모든 인터페이스에서 기본 네트워크를 변경할 수 있게 한다.

Purpose: REST API(`PUT /v1/wallets/:id/default-network`)는 이미 존재하지만, MCP/CLI/SDK에서 접근할 수 없어 에이전트와 개발자가 기본 네트워크를 변경할 수 없다 (이슈 022).
Output: MCP 도구 1개, CLI 명령어 1개, TS SDK 메서드 1개, Python SDK 메서드 1개
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/mcp/src/tools/get-wallet-info.ts
@packages/mcp/src/tools/get-balance.ts
@packages/mcp/src/server.ts
@packages/mcp/src/api-client.ts
@packages/mcp/src/__tests__/tools.test.ts
@packages/cli/src/index.ts
@packages/sdk/src/client.ts
@packages/sdk/src/types.ts
@python-sdk/waiaas/client.py
@python-sdk/waiaas/models.py
@packages/daemon/src/api/routes/wallets.ts
@objectives/issues/v1.4.6-022-set-default-network-mcp-cli.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP set_default_network 도구 + CLI wallet 서브커맨드</name>
  <files>
    packages/mcp/src/tools/set-default-network.ts
    packages/mcp/src/server.ts
    packages/mcp/src/__tests__/tools.test.ts
    packages/cli/src/index.ts
    packages/cli/src/commands/wallet.ts
  </files>
  <action>
  **1. MCP set_default_network 도구 (`packages/mcp/src/tools/set-default-network.ts`)**

  기존 get-wallet-info.ts 패턴을 따라 새 파일 생성:

  ```typescript
  import { z } from 'zod';
  import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
  import { type ApiClient, toToolResult } from '../api-client.js';
  import { type WalletContext, withWalletPrefix } from '../server.js';

  export function registerSetDefaultNetwork(server: McpServer, apiClient: ApiClient, walletContext?: WalletContext): void {
    server.tool(
      'set_default_network',
      withWalletPrefix('Change the default network for this wallet.', walletContext?.walletName),
      {
        network: z.string().describe('New default network (e.g., polygon-amoy, ethereum-sepolia).'),
      },
      async (args) => {
        // Step 1: GET /v1/wallet/address to get walletId
        const addressResult = await apiClient.get<{ walletId: string }>('/v1/wallet/address');
        if (!addressResult.ok) {
          return toToolResult(addressResult);
        }
        const walletId = addressResult.data.walletId;

        // Step 2: PUT /v1/wallets/:id/default-network
        const result = await apiClient.put<Record<string, unknown>>(
          `/v1/wallets/${walletId}/default-network`,
          { network: args.network },
        );
        return toToolResult(result);
      },
    );
  }
  ```

  NOTE: set_default_network은 session-scoped `/v1/wallet/address`로 walletId를 얻은 뒤, master-auth `/v1/wallets/:id/default-network`를 호출한다. 그러나 MCP 클라이언트는 sessionAuth 토큰만 가지고 있다. 이 호출은 sessionAuth 토큰으로 masterAuth 엔드포인트에 요청하므로 **인증 실패**할 수 있다.

  **해결책**: 세션 스코프 PUT 엔드포인트 `/v1/wallet/default-network`를 daemon에 추가하는 게 가장 깔끔하지만, 이 플랜의 스코프를 넘는다. 대신 **MCP API 클라이언트가 walletId를 알고 있으므로**, 다른 접근을 취한다:

  실제로 get_wallet_info에서 이미 같은 패턴(sessionAuth로 `/v1/wallets/:id/networks` 호출)을 사용하고 있다. server.ts를 확인해보면 `/v1/wallets/:id/default-network`는 masterAuth가 적용된다. 따라서 두 가지 방법:

  **방법 A (채택)**: daemon의 wallet.ts 라우터에 session-scoped `PUT /v1/wallet/default-network` 엔드포인트를 추가한다. 이는 sessionAuth 컨텍스트에서 walletId를 자동으로 얻으므로 가장 깔끔하다. wallet.ts의 기존 walletBalanceRoute 패턴과 동일:

  `packages/daemon/src/api/routes/wallet.ts`에 추가:
  ```typescript
  // PUT /wallet/default-network route definition (sessionAuth)
  const walletDefaultNetworkRoute = createRoute({
    method: 'put',
    path: '/wallet/default-network',
    tags: ['Wallet'],
    summary: 'Change wallet default network',
    request: {
      body: {
        content: {
          'application/json': {
            schema: z.object({
              network: z.string(),
            }),
          },
        },
      },
    },
    responses: {
      200: {
        description: 'Default network updated',
        content: {
          'application/json': {
            schema: z.object({
              id: z.string(),
              defaultNetwork: z.string(),
              previousNetwork: z.string().nullable(),
            }),
          },
        },
      },
      ...buildErrorResponses(['WALLET_NOT_FOUND', 'ENVIRONMENT_NETWORK_MISMATCH']),
    },
  });
  ```

  Handler는 wallets.ts의 기존 PUT /wallets/:id/default-network 핸들러 로직을 재사용:
  - c.get('walletId')로 세션에서 walletId 추출
  - resolveWalletById(deps.db, walletId)
  - TERMINATED 체크
  - validateNetworkEnvironment(chain, env, network) 검증
  - DB UPDATE + 응답

  `files_modified`에 `packages/daemon/src/api/routes/wallet.ts`도 추가한다.

  **MCP 도구 구현 (단순화)**:
  ```typescript
  // set_default_network: 세션 스코프 PUT /v1/wallet/default-network 사용
  async (args) => {
    const result = await apiClient.put<Record<string, unknown>>(
      '/v1/wallet/default-network',
      { network: args.network },
    );
    return toToolResult(result);
  }
  ```

  **2. server.ts에 등록** (`packages/mcp/src/server.ts`):

  - `import { registerSetDefaultNetwork } from './tools/set-default-network.js';` 추가
  - `createMcpServer()` 안에 `registerSetDefaultNetwork(server, apiClient, walletContext);` 호출 추가
  - 주석의 도구 수를 13 -> 14로 업데이트

  **3. MCP 도구 테스트** (`packages/mcp/src/__tests__/tools.test.ts`):

  파일 하단에 테스트 추가:
  ```typescript
  import { registerSetDefaultNetwork } from '../tools/set-default-network.js';

  describe('set_default_network tool', () => {
    it('calls PUT /v1/wallet/default-network with correct params', async () => {
      const responses = new Map<string, ApiResult<unknown>>([
        ['PUT:/v1/wallet/default-network', { ok: true, data: { id: 'w-1', defaultNetwork: 'polygon-amoy', previousNetwork: 'ethereum-sepolia' } }],
      ]);
      const apiClient = createMockApiClient(responses);
      const handler = getToolHandler(registerSetDefaultNetwork, apiClient);
      const result = await handler({ network: 'polygon-amoy' });
      expect(apiClient.put).toHaveBeenCalledWith('/v1/wallet/default-network', { network: 'polygon-amoy' });
      const parsed = JSON.parse(result.content[0].text);
      expect(parsed.defaultNetwork).toBe('polygon-amoy');
    });
  });
  ```

  **4. CLI wallet 서브커맨드 (`packages/cli/src/commands/wallet.ts`)**:

  새 파일 생성. commander 13.x 패턴 (index.ts 참조):

  ```typescript
  /**
   * `waiaas wallet` subcommand group:
   *   wallet info                          -- Show wallet details
   *   wallet set-default-network <network> -- Change default network
   */

  export interface WalletCommandOptions {
    baseUrl: string;
    password: string;
    walletId?: string;
  }
  ```

  `walletInfoCommand(opts)`:
  - GET /health 확인
  - master password resolving
  - GET /v1/wallets -> 월렛 리스트에서 첫 번째 또는 --wallet로 지정된 월렛 선택
  - GET /v1/wallets/:id/networks -> 네트워크 목록
  - 포맷팅 출력:
    ```
    Wallet: my-evm-wallet
      Chain:            ethereum
      Environment:      testnet
      Address:          0xAbC...789
      Default Network:  ethereum-sepolia
      Available:        ethereum-sepolia, polygon-amoy, ...
      Status:           ACTIVE
    ```

  `walletSetDefaultNetworkCommand(opts, network)`:
  - GET /v1/wallets -> 월렛 선택
  - PUT /v1/wallets/:id/default-network { network }
  - 성공/실패 메시지 출력

  **5. CLI index.ts에 wallet 서브커맨드 등록** (`packages/cli/src/index.ts`):

  ```typescript
  import { walletInfoCommand, walletSetDefaultNetworkCommand } from './commands/wallet.js';

  const wallet = program.command('wallet').description('Wallet management commands');

  wallet
    .command('info')
    .description('Show wallet details')
    .option('--base-url <url>', 'Daemon base URL', 'http://127.0.0.1:3100')
    .option('--wallet <id>', 'Wallet ID (auto-detected if only one)')
    .option('--password <password>', 'Master password')
    .action(async (opts) => {
      await walletInfoCommand({
        baseUrl: opts.baseUrl ?? 'http://127.0.0.1:3100',
        password: opts.password,
        walletId: opts.wallet,
      });
    });

  wallet
    .command('set-default-network')
    .description('Change wallet default network')
    .argument('<network>', 'Network to set as default (e.g., polygon-amoy)')
    .option('--base-url <url>', 'Daemon base URL', 'http://127.0.0.1:3100')
    .option('--wallet <id>', 'Wallet ID (auto-detected if only one)')
    .option('--password <password>', 'Master password')
    .action(async (network, opts) => {
      await walletSetDefaultNetworkCommand({
        baseUrl: opts.baseUrl ?? 'http://127.0.0.1:3100',
        password: opts.password,
        walletId: opts.wallet,
      }, network);
    });
  ```

  **6. daemon wallet.ts에 PUT /v1/wallet/default-network 추가** (`packages/daemon/src/api/routes/wallet.ts`):

  기존 walletRoutes 함수 안에 세 번째 라우트로 등록. 기존 wallets.ts의 PUT /wallets/:id/default-network 핸들러 로직을 그대로 적용하되, walletId는 세션 컨텍스트에서 가져온다. `import { validateNetworkEnvironment } from '@waiaas/core'`는 이미 임포트되어 있으므로 활용.
  </action>
  <verify>
  1. `pnpm --filter @waiaas/mcp build` 성공
  2. `pnpm --filter @waiaas/mcp test` 통과 (set_default_network 테스트 포함)
  3. `pnpm --filter @waiaas/cli build` 성공
  4. `pnpm --filter @waiaas/daemon build` 성공
  5. `pnpm --filter @waiaas/daemon test` 통과 (기존 테스트 회귀 없음)
  </verify>
  <done>
  - MCP set_default_network 도구가 등록되고 PUT /v1/wallet/default-network를 호출한다
  - CLI `waiaas wallet info`와 `waiaas wallet set-default-network <network>` 명령어가 동작한다
  - daemon에 PUT /v1/wallet/default-network 세션 스코프 엔드포인트가 추가됨
  </done>
</task>

<task type="auto">
  <name>Task 2: TS SDK + Python SDK setDefaultNetwork/getWalletInfo 메서드</name>
  <files>
    packages/sdk/src/client.ts
    packages/sdk/src/types.ts
    packages/sdk/src/index.ts
    packages/sdk/src/__tests__/client.test.ts
    python-sdk/waiaas/client.py
    python-sdk/waiaas/models.py
    python-sdk/tests/test_client.py
  </files>
  <action>
  **1. TS SDK 타입 추가** (`packages/sdk/src/types.ts`):

  ```typescript
  // Wallet Info
  export interface WalletInfoResponse {
    walletId: string;
    chain: string;
    network: string;
    environment: string;
    address: string;
    networks: Array<{ network: string; isDefault: boolean }>;
  }

  // Set Default Network
  export interface SetDefaultNetworkResponse {
    id: string;
    defaultNetwork: string;
    previousNetwork: string | null;
  }
  ```

  **2. TS SDK 메서드 추가** (`packages/sdk/src/client.ts`):

  `getWalletInfo()`: GET /v1/wallet/address -> walletId 추출 -> GET /v1/wallets/:walletId/networks -> 결합 반환. MCP get_wallet_info와 동일한 API 조합 패턴.

  ```typescript
  async getWalletInfo(): Promise<WalletInfoResponse> {
    const address = await withRetry(
      () => this.http.get<AddressResponse>('/v1/wallet/address', this.authHeaders()),
      this.retryOptions,
    );
    const networks = await withRetry(
      () => this.http.get<{ networks: Array<{ network: string; isDefault: boolean }> }>(
        `/v1/wallets/${address.walletId}/networks`,
        this.authHeaders(),
      ),
      this.retryOptions,
    );
    return {
      walletId: address.walletId,
      chain: address.chain,
      network: address.network,
      environment: (address as Record<string, unknown>).environment as string ?? '',
      address: address.address,
      networks: networks.networks ?? [],
    };
  }
  ```

  주의: AddressResponse에 environment 필드가 없을 수 있다. daemon의 GET /v1/wallet/address 응답을 확인하면 `{ walletId, chain, network, environment, address }`를 반환한다. AddressResponse 타입에 `environment` 필드를 추가한다:

  ```typescript
  export interface AddressResponse {
    walletId: string;
    chain: string;
    network: string;
    environment?: string;  // v1.4.8 추가
    address: string;
  }
  ```

  `setDefaultNetwork(network)`:
  ```typescript
  async setDefaultNetwork(network: string): Promise<SetDefaultNetworkResponse> {
    return withRetry(
      () => this.http.put<SetDefaultNetworkResponse>(
        '/v1/wallet/default-network',
        { network },
        this.authHeaders(),
      ),
      this.retryOptions,
    );
  }
  ```

  **3. TS SDK index.ts에 타입 export 추가** (`packages/sdk/src/index.ts`):
  WalletInfoResponse, SetDefaultNetworkResponse 타입 export 추가.

  **4. TS SDK 테스트** (`packages/sdk/src/__tests__/client.test.ts`):

  기존 패턴을 따라:
  ```typescript
  describe('setDefaultNetwork', () => {
    it('calls PUT /v1/wallet/default-network', async () => {
      // Mock http.put to return { id, defaultNetwork, previousNetwork }
      // Verify correct path and body
    });
  });

  describe('getWalletInfo', () => {
    it('combines address and networks APIs', async () => {
      // Mock http.get for /v1/wallet/address -> { walletId, chain, network, environment, address }
      // Mock http.get for /v1/wallets/:id/networks -> { networks: [...] }
      // Verify combined response
    });
  });
  ```

  **5. Python SDK 모델 추가** (`python-sdk/waiaas/models.py`):

  ```python
  class WalletNetworkInfo(BaseModel):
      network: str
      is_default: bool = Field(alias="isDefault")
      model_config = {"populate_by_name": True}

  class WalletInfo(BaseModel):
      wallet_id: str = Field(alias="walletId")
      chain: str
      network: str
      environment: str
      address: str
      networks: list[WalletNetworkInfo]
      model_config = {"populate_by_name": True}

  class SetDefaultNetworkResponse(BaseModel):
      id: str
      default_network: str = Field(alias="defaultNetwork")
      previous_network: Optional[str] = Field(default=None, alias="previousNetwork")
      model_config = {"populate_by_name": True}
  ```

  **6. Python SDK 클라이언트 메서드** (`python-sdk/waiaas/client.py`):

  ```python
  async def get_wallet_info(self) -> WalletInfo:
      """GET /v1/wallet/address + GET /v1/wallets/:id/networks combined."""
      addr_resp = await self._request("GET", "/v1/wallet/address")
      addr = WalletAddress.model_validate(addr_resp.json())
      net_resp = await self._request("GET", f"/v1/wallets/{addr.wallet_id}/networks")
      net_data = net_resp.json()
      return WalletInfo(
          walletId=addr.wallet_id,
          chain=addr.chain,
          network=addr.network,
          environment=net_data.get("environment", ""),
          address=addr.address,
          networks=net_data.get("networks", []),
      )

  async def set_default_network(self, network: str) -> SetDefaultNetworkResponse:
      """PUT /v1/wallet/default-network -- Change default network."""
      resp = await self._request("PUT", "/v1/wallet/default-network", json_body={"network": network})
      return SetDefaultNetworkResponse.model_validate(resp.json())
  ```

  `__init__.py`에 WalletInfo, WalletNetworkInfo, SetDefaultNetworkResponse export 추가.

  **7. Python SDK 테스트** (`python-sdk/tests/test_client.py`):

  기존 패턴 (httpx mock) 따라:
  ```python
  async def test_set_default_network():
      # Mock PUT /v1/wallet/default-network -> 200
      # Verify SetDefaultNetworkResponse 반환

  async def test_get_wallet_info():
      # Mock GET /v1/wallet/address + GET /v1/wallets/:id/networks
      # Verify WalletInfo 반환 (chain, environment, networks 포함)
  ```
  </action>
  <verify>
  1. `pnpm --filter @waiaas/sdk build` 성공
  2. `pnpm --filter @waiaas/sdk test` 통과 (신규 2개 테스트 포함)
  3. `cd python-sdk && python -m pytest tests/` 통과 (신규 2개 테스트 포함)
  </verify>
  <done>
  - TS SDK에 setDefaultNetwork()과 getWalletInfo() 메서드가 추가된다
  - Python SDK에 set_default_network()과 get_wallet_info() 메서드가 추가된다
  - 양쪽 SDK에 테스트가 추가되고 통과한다
  - 이슈 022, 023(SDK 부분) 해결
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon build && pnpm --filter @waiaas/daemon test` -- daemon PUT /v1/wallet/default-network 엔드포인트 동작
2. `pnpm --filter @waiaas/mcp build && pnpm --filter @waiaas/mcp test` -- MCP set_default_network 도구 동작
3. `pnpm --filter @waiaas/cli build` -- CLI wallet 서브커맨드 빌드 성공
4. `pnpm --filter @waiaas/sdk build && pnpm --filter @waiaas/sdk test` -- SDK 메서드 동작
5. `cd python-sdk && python -m pytest tests/` -- Python SDK 메서드 동작
6. 전체 빌드: `pnpm build` 성공
</verification>

<success_criteria>
- MCP set_default_network 도구가 14번째 도구로 등록됨
- CLI `waiaas wallet info`와 `waiaas wallet set-default-network <network>` 존재
- TS SDK setDefaultNetwork() + getWalletInfo() 존재 + 테스트 통과
- Python SDK set_default_network() + get_wallet_info() 존재 + 테스트 통과
- daemon PUT /v1/wallet/default-network 세션 스코프 엔드포인트 존재
- 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/122-mcp-multichain-dx/122-01-SUMMARY.md`
</output>
