---
phase: 34-자금-회수-보안-분기-설계
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/27-chain-adapter-interface.md
autonomous: true

must_haves:
  truths:
    - "POST /v1/owner/agents/:agentId/withdraw API 스펙(요청/응답/인증/HTTP 상태)이 37-rest-api에 명세되어 있다"
    - "WithdrawService 도메인 서비스 패턴(OwnerState 검증 → scope 분기 → sweepAll/sendNative → 응답 매핑)이 명세되어 있다"
    - "scope 'all'(네이티브+SPL+rent)과 'native'(네이티브만) 분기가 명세되어 있다"
    - "부분 실패 시 HTTP 207 Multi-Status 응답과 failed 배열 구조가 명세되어 있다"
    - "유예 구간(owner_verified=0)에서 withdraw 비활성화 보안 정책이 명세되어 있다"
    - "sweepAll Solana 실행 순서(토큰 배치 → SOL 마지막)와 scope native의 fee 차감 로직이 27-chain-adapter에 명세되어 있다"
  artifacts:
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "withdraw API 엔드포인트 완전 스펙 + WithdrawService 서비스 설계"
      contains: "POST /v1/owner/agents/:agentId/withdraw"
    - path: ".planning/deliverables/27-chain-adapter-interface.md"
      provides: "sweepAll Solana 실행 순서 상세 + scope native sendNative 설계"
      contains: "WithdrawService"
  key_links:
    - from: "37-rest-api-complete-spec.md withdraw API"
      to: "27-chain-adapter-interface.md sweepAll"
      via: "WithdrawService가 scope에 따라 sweepAll() 또는 sendNative() 호출"
    - from: "37-rest-api-complete-spec.md WITHDRAW_LOCKED_ONLY"
      to: "34-owner-wallet-connection.md H-02"
      via: "resolveOwnerState() === LOCKED 검증 (32-02 확정)"
---

<objective>
POST /v1/owner/agents/:agentId/withdraw API 완전 스펙과 WithdrawService 도메인 서비스 설계를 37-rest-api-complete-spec.md에 추가하고, sweepAll Solana 실행 순서 상세와 scope "native" 로직을 27-chain-adapter-interface.md에 보완한다.

Purpose: Phase 34 Success Criteria 1-4를 충족하여, 자금 회수 API와 실행 로직이 구현 가능 수준으로 명세된다.
Output: 37-rest-api-complete-spec.md에 withdraw 섹션 추가, 27-chain-adapter-interface.md에 WithdrawService + scope native 보완.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# v0.8 objectives (withdraw 전체 설계 §5)
@objectives/v0.8-optional-owner-progressive-security.md

# Phase 31 sweepAll 시그니처 + SolanaAdapter 구현 지침 확정
@.planning/phases/31-데이터-모델-타입-기반-설계/31-02-SUMMARY.md

# Phase 32 H-02 withdraw 방어 (LOCKED에서만 활성화) 확정
@.planning/phases/32-owner-생명주기-설계/32-02-SUMMARY.md

# Target files
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/27-chain-adapter-interface.md

# Reference: sweepAll 시그니처 + SweepResult 타입 (Phase 31 확정)
@.planning/deliverables/25-sqlite-schema.md

# Reference: H-02 withdraw 방어 메커니즘
@.planning/deliverables/34-owner-wallet-connection.md

# Research
@.planning/phases/34-자금-회수-보안-분기-설계/34-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: withdraw API 엔드포인트 + WithdrawService 서비스 설계를 37-rest-api-complete-spec.md에 반영</name>
  <files>.planning/deliverables/37-rest-api-complete-spec.md</files>
  <action>
37-rest-api-complete-spec.md에 [v0.8] 태그로 withdraw 관련 내용을 추가한다. 문서 내 적절한 위치(Owner 관련 섹션 또는 엔드포인트 목록 끝)에 새 섹션을 삽입한다.

**추가할 내용:**

1. **POST /v1/owner/agents/:agentId/withdraw 엔드포인트 스펙:**
   - 요청 스키마 (Zod-OpenAPI 패턴):
     ```typescript
     const WithdrawRequestSchema = z.object({
       scope: z.enum(['all', 'native']).default('all'),
     })
     ```
   - 응답 스키마 (WithdrawResponseSchema):
     ```typescript
     z.object({
       totalTransactions: z.number().int().nonnegative(),
       nativeRecovered: z.string(),  // lamports -> SOL 문자열
       tokensRecovered: z.array(z.object({
         symbol: z.string(),
         amount: z.string(),
         mint: z.string(),
       })),
       rentRecovered: z.string().optional(),  // scope "all"일 때만
       failed: z.array(z.object({
         mint: z.string(),
         error: z.string(),
       })),
     })
     ```
   - HTTP 상태 코드: 200(전량 성공), 207(부분 성공 - failed 비어있지 않음), 403(WITHDRAW_LOCKED_ONLY | AGENT_SUSPENDED), 404(AGENT_NOT_FOUND | NO_OWNER), 500(SWEEP_TOTAL_FAILURE)
   - 인증: masterAuth(implicit) -- 수신 주소가 owner_address로 고정이므로 ownerAuth 불필요 (v0.8 objectives §5.2 근거)
   - params: agentId (UUID v7)

2. **인증 맵 테이블 업데이트:**
   - 기존 엔드포인트 수에 +1 추가 (36 -> 37개)
   - `POST /v1/owner/agents/:agentId/withdraw | masterAuth | Owner(LOCKED) 자금 회수`

3. **에러 코드 매트릭스 추가:**
   | 에러 코드 | HTTP | 조건 |
   |-----------|------|------|
   | AGENT_NOT_FOUND | 404 | agentId에 해당하는 에이전트 없음 |
   | NO_OWNER | 404 | agents.owner_address IS NULL |
   | WITHDRAW_LOCKED_ONLY | 403 | resolveOwnerState() !== LOCKED (유예 구간 포함) |
   | AGENT_SUSPENDED | 403 | agents.status === SUSPENDED |
   | SWEEP_TOTAL_FAILURE | 500 | 모든 전송 실패 (failed 배열 = 전체) |

4. **WithdrawService 도메인 서비스 설계:**
   - 책임: OwnerState 검증(LOCKED만) → scope 분기 → IChainAdapter 호출 → SweepResult→HTTP 응답 매핑 → 감사 로그
   - 코드 패턴 (의사 코드):
     ```typescript
     class WithdrawService {
       async withdraw(agentId: string, scope: 'all' | 'native'): Promise<WithdrawResult> {
         const agent = getAgent(db, agentId)
         if (!agent) throw notFound('AGENT_NOT_FOUND')
         if (!agent.ownerAddress) throw notFound('NO_OWNER')
         if (agent.status === 'SUSPENDED') throw forbidden('AGENT_SUSPENDED')
         if (resolveOwnerState(agent) !== 'LOCKED') throw forbidden('WITHDRAW_LOCKED_ONLY')

         const result = scope === 'all'
           ? await chainAdapter.sweepAll(agent.publicKey, agent.ownerAddress)
           : await this.sendNative(agent)

         auditLog(scope === 'all' && result.failed.length === 0
           ? 'FUND_WITHDRAWN' : result.failed.length > 0
           ? 'FUND_PARTIALLY_WITHDRAWN' : 'FUND_WITHDRAWN',
           { agentId, scope, ...result })

         return result
       }
     }
     ```
   - scope "all": IChainAdapter.sweepAll(from, to) 호출 -- 정책 엔진 우회 (31-02 확정)
   - scope "native": 잔액 조회 → `잔액 - estimatedFee` 계산 → sendNative(from, to, amount) 호출 -- tx fee 미고려 방지 (34-RESEARCH Pitfall 3)
   - SweepResult → HTTP 응답 매핑:
     - failed.length === 0 → 200
     - failed.length > 0 && transactions.length > 0 → 207
     - transactions.length === 0 → throw 500 SWEEP_TOTAL_FAILURE
   - 감사 로그 이벤트: FUND_WITHDRAWN(성공/부분 성공), FUND_WITHDRAWAL_FAILED(전체 실패)

5. **Kill Switch 상태에서의 withdraw 처리 (Open Question):**
   - 두 가지 방안 명시 (구현 시 결정):
     - 방안 A: killSwitchGuard 허용 목록에 POST /v1/owner/agents/:agentId/withdraw 추가 (4→5개)
     - 방안 B: CLI/데몬 내부에서 직접 실행 (API 우회)
   - Phase 35 DX에서 CLI withdraw 명령 설계 시 함께 결정

**반드시 지켜야 할 것:**
- 기존 37 문서의 Zod-OpenAPI 패턴(createRoute + z.object)과 일관된 스타일
- HTTP 상태 코드는 v0.7 Phase 29 HTTP status 매트릭스와 일관
- 인증 맵 테이블에 정확한 엔드포인트 수 반영
- [v0.8] 태그로 변경 사항 표시
- 수신 주소 owner_address 고정 근거(§5.2)를 명시하여 ownerAuth 불필요 이유 설명

**하지 말 것:**
- ownerAuth를 요구하는 설계 (수신 주소 고정으로 불필요 -- v0.8 결정)
- SweepResult 타입 재정의 (25-sqlite-schema §4.12.2에 이미 정의됨 -- 참조만)
- sweepAll에 scope 파라미터 추가 (IChainAdapter는 저수준 -- 31-02 결정, scope는 WithdrawService 레벨)
  </action>
  <verify>
37-rest-api-complete-spec.md에서 다음을 확인:
1. "POST /v1/owner/agents" 문자열이 존재한다
2. "WithdrawRequestSchema" 또는 "scope.*all.*native" 패턴이 존재한다
3. "207" HTTP 상태 코드가 명세되어 있다
4. "WITHDRAW_LOCKED_ONLY" 에러 코드가 존재한다
5. "WithdrawService" 서비스 설계가 존재한다
6. 인증 맵에 withdraw 엔드포인트가 추가되어 있다
7. "FUND_WITHDRAWN" 감사 로그 이벤트가 명세되어 있다
  </verify>
  <done>
37-rest-api-complete-spec.md에 POST /v1/owner/agents/:agentId/withdraw 엔드포인트(요청/응답/인증/HTTP 상태/에러 코드), WithdrawService 도메인 서비스 패턴(OwnerState 검증 → scope 분기 → sweepAll/sendNative → HTTP 응답 매핑), 감사 로그 이벤트, 인증 맵 업데이트가 [v0.8] 태그로 추가되어 있다.
WITHDRAW-01, WITHDRAW-02, WITHDRAW-03, WITHDRAW-04, WITHDRAW-05, WITHDRAW-08 충족.
  </done>
</task>

<task type="auto">
  <name>Task 2: sweepAll Solana 실행 순서 상세 + scope native 로직을 27-chain-adapter-interface.md에 보완</name>
  <files>.planning/deliverables/27-chain-adapter-interface.md</files>
  <action>
27-chain-adapter-interface.md에서 Phase 31에서 추가된 sweepAll 관련 섹션(§3.2 sweepAll 시그니처, §6.11 SolanaAdapter.sweepAll 구현 지침)을 [v0.8] 태그로 보완한다.

**보완할 내용:**

1. **sweepAll Solana 실행 순서 상세 (§6.11 보완):**
   - 기존 31-02에서 확정된 순서(getAssets → 토큰 배치 → SOL 마지막)를 더 구체화:
     ```
     실행 순서:
     1. getAssets(address) → AssetInfo[] 조회 (v0.6 57-asset-query)
     2. SPL 토큰 필터링: type === 'spl-token' && balance > 0
     3. 토큰별 transfer + closeAccount 배치:
        - buildBatch() (v0.6 60-batch-transaction) 활용
        - Solana: min 2 / max 20 instructions per tx (1232 byte 제한)
        - 배치 실패 시 개별 토큰 fallback (partial sweep 허용)
        - closeAccount로 rent 회수 (SweepResult.rentRecovered에 합산)
     4. 잔여 SOL 전량 전송:
        - getBalance(address) → 현재 SOL 잔액
        - estimateFee(transferTx) → 예상 fee
        - amount = balance - estimatedFee
        - sendTransaction(signedTx) → SOL 전송
        - 마지막 tx이므로 fee 정확 계산 가능
     ```

2. **SOL 마지막 전송 근거 (WITHDRAW-07):**
   - 토큰 전송 + closeAccount에 SOL tx fee가 필요
   - SOL을 먼저 전송하면 이후 토큰 전송 fee 부족으로 실패
   - 모든 토큰 처리 완료 후 잔여 SOL에서 마지막 tx fee만 차감하여 최대 회수

3. **scope "native" 전용 로직 (WithdrawService 수준):**
   - WithdrawService에서 scope "native" 처리 시 IChainAdapter의 기존 메서드 활용:
     ```typescript
     // WithdrawService.sendNative() 의사 코드
     async sendNative(agent: Agent): Promise<WithdrawResult> {
       const balance = await chainAdapter.getBalance(agent.publicKey)
       if (balance === '0') return { totalTransactions: 0, nativeRecovered: '0', tokensRecovered: [], failed: [] }
       const fee = await chainAdapter.estimateFee({ type: 'transfer', to: agent.ownerAddress, amount: balance })
       const amount = BigInt(balance) - BigInt(fee)
       if (amount <= 0n) throw new InternalError('INSUFFICIENT_FOR_FEE')
       const txHash = await chainAdapter.sendNative(agent.publicKey, agent.ownerAddress, amount.toString())
       return { totalTransactions: 1, nativeRecovered: amount.toString(), tokensRecovered: [], failed: [] }
     }
     ```
   - scope "native"는 sweepAll()을 호출하지 않음 -- 기존 getBalance + estimateFee + sendNative 조합
   - scope "native"는 IChainAdapter 메서드 추가 없음 (기존 메서드 조합으로 충분)

4. **부분 실패 처리 상세:**
   - 배치 내 특정 instruction 실패 시 해당 토큰만 failed 배열에 추가
   - 배치 전체 실패 시 개별 토큰 전송으로 재시도 (fallback)
   - 개별 전송도 실패 시 failed 배열에 { mint, error } 추가
   - 모든 토큰 실패해도 SOL 전송은 시도 (SweepResult.transactions에 SOL만 포함 가능)
   - 최종 SweepResult: transactions + nativeRecovered + tokensRecovered + rentRecovered + failed

5. **EVM sweepAll 참고 (EvmStub):**
   - v0.8에서는 Solana만 구현. EVM은 EvmStub에서 NOT_IMPLEMENTED 유지
   - EVM sweepAll 구현 시 고려사항 메모만 추가: ERC-20 approve + transferFrom 또는 직접 transfer, native ETH 마지막 전송 (gas fee 보장)

**반드시 지켜야 할 것:**
- 기존 §6.11 섹션의 구조를 유지하면서 상세 내용 보완 (새 섹션 추가가 아닌 기존 섹션 확장)
- [v0.8] 태그로 Phase 34에서 추가된 내용 표시
- sweepAll 시그니처(§3.2)는 31-02에서 확정됨 -- 변경하지 말 것
- scope는 WithdrawService 레벨 -- IChainAdapter에 scope 파라미터 추가하지 말 것

**하지 말 것:**
- IChainAdapter.sweepAll 시그니처 변경 (31-02 확정)
- sweepAll에 scope 파라미터 추가 (WithdrawService 레벨 -- Anti-pattern)
- EVM sweepAll 구현 설계 (v0.8 범위 외)
  </action>
  <verify>
27-chain-adapter-interface.md에서 다음을 확인:
1. sweepAll Solana 실행 순서가 4단계(getAssets → SPL 배치 → closeAccount → SOL 마지막)로 상세화되어 있다
2. "scope.*native" 또는 "sendNative" 로직이 WithdrawService 수준으로 명세되어 있다
3. "estimatedFee" 또는 "balance - fee" 패턴이 scope native에서 명시되어 있다
4. 부분 실패 처리(배치 실패 → 개별 fallback → failed 배열)가 명세되어 있다
5. SOL 마지막 전송 근거(tx fee 보장)가 명시되어 있다
  </verify>
  <done>
27-chain-adapter-interface.md에 sweepAll Solana 실행 순서(getAssets → SPL 배치 전송+closeAccount → SOL 마지막), scope "native" WithdrawService 로직(getBalance - estimateFee), 부분 실패 처리(배치→개별 fallback), SOL 마지막 전송 근거가 [v0.8] 태그로 보완되어 있다.
WITHDRAW-07 충족 (SOL 마지막 전송). scope "all"/"native" 분기 상세화.
  </done>
</task>

</tasks>

<verification>
Phase 34 Success Criteria 1-4 충족 확인:
1. [SC-1] POST /v1/owner/agents/:agentId/withdraw API 스펙이 37에 명세되어 있다
2. [SC-2] sweepAll Solana 실행 순서(토큰 배치 → SOL 마지막)와 HTTP 207이 명세되어 있다
3. [SC-3] scope "all"과 "native" 분기가 명세되어 있다
4. [SC-4] 유예 구간 withdraw 비활성화(WITHDRAW_LOCKED_ONLY)가 명세되어 있다

요구사항 매핑 확인:
- WITHDRAW-01: POST /v1/owner/agents/:agentId/withdraw API (Task 1)
- WITHDRAW-02: 수신 주소 owner_address 고정 (Task 1 인증 근거)
- WITHDRAW-03: scope "all" 전량 회수 (Task 1 + Task 2)
- WITHDRAW-04: scope "native" 분기 (Task 1 + Task 2)
- WITHDRAW-05: HTTP 207 + failed 배열 (Task 1)
- WITHDRAW-07: SOL 마지막 전송 (Task 2)
- WITHDRAW-08: 유예 구간 비활성화 (Task 1 WITHDRAW_LOCKED_ONLY)
</verification>

<success_criteria>
- 37-rest-api-complete-spec.md에 withdraw API 완전 스펙 + WithdrawService 설계 + 에러 코드 + 감사 로그가 추가되어 있다
- 27-chain-adapter-interface.md에 sweepAll Solana 상세 순서 + scope native + 부분 실패 처리가 보완되어 있다
- 모든 [v0.8] 태그가 적용되어 변경 추적이 가능하다
- WITHDRAW-01~05, WITHDRAW-07, WITHDRAW-08 총 7개 요구사항 충족
</success_criteria>

<output>
After completion, create `.planning/phases/34-자금-회수-보안-분기-설계/34-01-SUMMARY.md`
</output>
