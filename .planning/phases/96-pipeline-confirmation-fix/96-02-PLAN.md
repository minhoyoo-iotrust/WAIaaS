---
phase: 96-pipeline-confirmation-fix
plan: 02
type: execute
wave: 2
depends_on: ["96-01"]
files_modified:
  - packages/adapters/solana/src/adapter.ts
  - packages/adapters/solana/src/__tests__/solana-adapter.test.ts
autonomous: true

must_haves:
  truths:
    - "Solana waitForConfirmation이 RPC 에러 시 throw 대신 'submitted' 상태를 반환한다"
    - "기존 정상 경로(확인 성공, 타임아웃)에 대한 회귀가 없다"
  artifacts:
    - path: "packages/adapters/solana/src/adapter.ts"
      provides: "waitForConfirmation RPC 에러 시 fallback 반환"
      contains: "return.*submitted"
  key_links:
    - from: "packages/adapters/solana/src/adapter.ts"
      to: "packages/core/src/interfaces/chain-adapter.types.ts"
      via: "SubmitResult type import"
      pattern: "status.*submitted"
---

<objective>
Solana adapter의 waitForConfirmation에도 EVM과 동일한 fallback 패턴을 적용한다 (PIPE-03).

Purpose: Solana adapter의 waitForConfirmation은 RPC 에러 시 WAIaaSError를 throw하여 Stage 6에서 FAILED 처리될 수 있다. EVM adapter와 동일하게 에러 시 'submitted'를 반환하여 일관된 동작을 보장한다.
Output: Solana adapter fallback 패턴, 테스트 업데이트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/96-pipeline-confirmation-fix/96-01-SUMMARY.md
@objectives/bug-reports/v1.4.1-BUG-015-evm-confirmation-timeout-marks-failed.md
@packages/adapters/solana/src/adapter.ts
@packages/adapters/solana/src/__tests__/solana-adapter.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Solana adapter waitForConfirmation fallback 패턴 적용 + 테스트 수정</name>
  <files>
    packages/adapters/solana/src/adapter.ts
    packages/adapters/solana/src/__tests__/solana-adapter.test.ts
  </files>
  <action>
1. `packages/adapters/solana/src/adapter.ts` waitForConfirmation (lines 410-445): catch 블록에서 throw 대신 'submitted' 반환:

   현재 코드 (lines 432-437):
   ```typescript
   } catch (error) {
     throw new WAIaaSError('CHAIN_ERROR', {
       message: `Failed to check confirmation: ${error instanceof Error ? error.message : String(error)}`,
       cause: error instanceof Error ? error : undefined,
     });
   }
   ```

   수정:
   ```typescript
   } catch {
     // RPC error during polling: return submitted (don't mark as failed)
     // Stage 6 will keep SUBMITTED status, tx may confirm later
     return { txHash, status: 'submitted' };
   }
   ```

   이유: RPC 에러(rate limit, 연결 끊김 등)는 트랜잭션 실패가 아님. 이미 SUBMITTED된 트랜잭션의 상태를 유지해야 함. Stage 6이 이제 반환값 기반으로 동작하므로(Plan 01에서 수정), throw 대신 'submitted' 반환이 올바른 패턴.

   Solana의 경우 getSignatureStatuses 자체가 fallback 역할을 하므로(이미 polling 중), 별도의 fallback receipt 조회는 불필요. 단순히 throw를 return으로 변경하면 됨.

2. `packages/adapters/solana/src/__tests__/solana-adapter.test.ts` 수정:
   - "waitForConfirmation() resolves to confirmed" (line 385) — 그대로 유지 (정상 경로)
   - "waitForConfirmation() handles timeout gracefully" (line 408) — 그대로 유지 (타임아웃 경로)
   - "waitForConfirmation() throws CHAIN_ERROR on RPC failure during polling" (line 627) — 수정: throw 대신 { status: 'submitted' } 반환을 검증. 테스트 이름도 "returns submitted on RPC failure during polling"으로 변경.
   - "not-connected guard" 테스트 (line ~597-603): `waitForConfirmation`에 대한 `rejects.toThrow(WAIaaSError)` 부분이 있다면, 이는 ensureConnected() 가드이므로 그대로 유지 (연결 안 된 상태는 여전히 throw가 맞음). 단, waitForConfirmation 내부에 ensureConnected()가 없다면 이 테스트에서 waitForConfirmation 관련 assertion만 제거.

   주의: not-connected guard 테스트에서 `adapter.waitForConfirmation('test')` 호출이 있는데 (line 603), waitForConfirmation 내부에 ensureConnected() 호출이 없으면 이 assertion이 실패할 수 있음. adapter.ts를 확인하여:
   - ensureConnected()가 있으면: 그대로 유지
   - ensureConnected()가 없으면: 해당 assertion 라인 제거하거나 waitForConfirmation 시작에 ensureConnected() 추가 (getRpc() 호출이 이미 연결 확인을 할 수 있음)
  </action>
  <verify>
    cd packages/adapters/solana && npx vitest run --reporter=verbose 2>&1 | tail -30
  </verify>
  <done>
    - Solana waitForConfirmation이 RPC 에러 시 WAIaaSError를 throw하지 않고 { status: 'submitted' }를 반환한다
    - 기존 정상 경로(confirmed) 테스트가 통과한다
    - 기존 타임아웃 경로(submitted) 테스트가 통과한다
    - RPC 에러 경로 테스트가 새 동작(submitted 반환)을 검증한다
  </done>
</task>

</tasks>

<verification>
1. `cd packages/adapters/solana && npx vitest run --reporter=verbose` — Solana adapter 테스트 전체 통과
2. `cd packages/daemon && npx vitest run src/__tests__/pipeline.test.ts --reporter=verbose` — Stage 6 테스트 여전히 통과 (Solana 변경이 Stage 6에 영향 없음)
3. `npx vitest run --reporter=verbose 2>&1 | grep -E '(FAIL|PASS|Tests)'` — 전체 테스트에서 새로운 실패 없음
</verification>

<success_criteria>
- Solana waitForConfirmation이 RPC 에러 시 throw 대신 submitted를 반환한다
- 기존 정상 경로와 타임아웃 경로에 회귀가 없다
- Stage 6과의 통합이 올바르게 동작한다 (throw하지 않으므로 Stage 6이 submitted 경로를 탐)
</success_criteria>

<output>
After completion, create `.planning/phases/96-pipeline-confirmation-fix/96-02-SUMMARY.md`
</output>
