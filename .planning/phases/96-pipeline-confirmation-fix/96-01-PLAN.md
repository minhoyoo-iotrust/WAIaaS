---
phase: 96-pipeline-confirmation-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/chain-adapter.types.ts
  - packages/adapters/evm/src/adapter.ts
  - packages/daemon/src/pipeline/stages.ts
  - packages/adapters/evm/src/__tests__/evm-adapter.test.ts
  - packages/daemon/src/__tests__/pipeline.test.ts
  - packages/daemon/src/__tests__/pipeline-notification.test.ts
autonomous: true

must_haves:
  truths:
    - "EVM waitForConfirmation이 타임아웃/RPC 에러 시 getTransactionReceipt fallback으로 온체인 상태를 정확히 반환한다"
    - "stage6Confirm이 waitForConfirmation 반환값(confirmed/failed/submitted)에 따라 DB 상태를 정확히 분기한다"
    - "SUBMITTED 상태인 트랜잭션이 확인 실패로 인해 FAILED로 잘못 덮어쓰여지지 않는다"
    - "기존 정상 경로(타임아웃 없는 확인)에 대한 회귀가 없다"
  artifacts:
    - path: "packages/core/src/interfaces/chain-adapter.types.ts"
      provides: "SubmitResult.status에 'failed' 추가"
      contains: "'failed'"
    - path: "packages/adapters/evm/src/adapter.ts"
      provides: "waitForConfirmation fallback receipt 조회"
      contains: "getTransactionReceipt"
    - path: "packages/daemon/src/pipeline/stages.ts"
      provides: "stage6Confirm 반환값 기반 3-way 분기"
      contains: "result.status === 'confirmed'"
  key_links:
    - from: "packages/adapters/evm/src/adapter.ts"
      to: "packages/core/src/interfaces/chain-adapter.types.ts"
      via: "SubmitResult type import"
      pattern: "status.*failed"
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "packages/adapters/evm/src/adapter.ts"
      via: "waitForConfirmation return value"
      pattern: "result\\.status"
---

<objective>
EVM 트랜잭션 확인 타임아웃 시 온체인 성공 건을 FAILED로 처리하는 BUG-015를 수정한다.

Purpose: 온체인에서 성공한 트랜잭션이 데몬 DB에 FAILED로 기록되면 AI 에이전트가 트랜잭션 상태를 신뢰할 수 없다. waitForConfirmation에 fallback receipt 조회를 추가하고, stage6Confirm이 반환값에 따라 DB 상태를 정확히 분기하도록 수정한다.
Output: SubmitResult 타입 확장, EVM adapter fallback, Stage 6 상태 분기, 관련 테스트 5개+
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/bug-reports/v1.4.1-BUG-015-evm-confirmation-timeout-marks-failed.md
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/adapters/evm/src/adapter.ts
@packages/daemon/src/pipeline/stages.ts
@packages/adapters/evm/src/__tests__/evm-adapter.test.ts
@packages/daemon/src/__tests__/pipeline.test.ts
@packages/daemon/src/__tests__/pipeline-notification.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SubmitResult 타입 확장 + EVM adapter fallback receipt 조회 추가</name>
  <files>
    packages/core/src/interfaces/chain-adapter.types.ts
    packages/adapters/evm/src/adapter.ts
    packages/adapters/evm/src/__tests__/evm-adapter.test.ts
  </files>
  <action>
1. `packages/core/src/interfaces/chain-adapter.types.ts` line 58: SubmitResult.status 타입에 `'failed'` 추가:
   ```typescript
   status: 'submitted' | 'confirmed' | 'finalized' | 'failed';
   ```
   온체인 revert 감지를 위해 필요. 기존 'submitted'/'confirmed'/'finalized' 사용처에 영향 없음 (union 확장은 하위 호환).

2. `packages/adapters/evm/src/adapter.ts` waitForConfirmation (lines 401-423): catch 블록을 fallback receipt 조회 패턴으로 교체:
   ```typescript
   async waitForConfirmation(txHash: string, timeoutMs = 30_000): Promise<SubmitResult> {
     const client = this.getClient();
     try {
       const receipt = await client.waitForTransactionReceipt({
         hash: txHash as `0x${string}`,
         timeout: timeoutMs,
       });
       return {
         txHash,
         status: receipt.status === 'success' ? 'confirmed' : 'failed',
         blockNumber: receipt.blockNumber,
         fee: receipt.gasUsed * receipt.effectiveGasPrice,
       };
     } catch (error) {
       // Timeout or RPC error: fallback to direct receipt query
       try {
         const receipt = await client.getTransactionReceipt({
           hash: txHash as `0x${string}`,
         });
         return {
           txHash,
           status: receipt.status === 'success' ? 'confirmed' : 'failed',
           blockNumber: receipt.blockNumber,
           fee: receipt.gasUsed * receipt.effectiveGasPrice,
         };
       } catch {
         // Receipt not found: tx still pending
         return { txHash, status: 'submitted' };
       }
     }
   }
   ```
   핵심 변경:
   - 기존: `receipt.status === 'success' ? 'confirmed' : 'submitted'` → 수정: `... : 'failed'` (revert된 tx는 failed)
   - 기존: 타임아웃만 catch, 나머지 throw → 수정: 모든 에러에서 `getTransactionReceipt` fallback 시도
   - 기존: fallback 없음 → 수정: receipt 직접 조회로 온체인 상태 확인, receipt 없으면 'submitted'

3. `packages/adapters/evm/src/__tests__/evm-adapter.test.ts`: 기존 2개 테스트 유지 + 3개 추가:
   - 기존 "returns confirmed status" 테스트: 그대로 유지 (정상 경로 회귀 방지)
   - 기존 "returns submitted on timeout" 테스트: mockClient.getTransactionReceipt도 reject하도록 수정 (fallback도 실패해야 submitted)
   - 새 테스트: "타임아웃 시 fallback receipt로 confirmed 반환" — waitForTransactionReceipt reject, getTransactionReceipt가 { status: 'success' } 반환 → result.status === 'confirmed'
   - 새 테스트: "RPC 에러 시 fallback receipt 없으면 submitted 반환" — 둘 다 reject → result.status === 'submitted'
   - 새 테스트: "receipt.status가 reverted면 failed 반환" — waitForTransactionReceipt가 { status: 'reverted' } 반환 → result.status === 'failed'

   mockClient에 `getTransactionReceipt` mock이 없다면 추가 필요. viem의 publicClient.getTransactionReceipt는 이미 존재하는 메서드.
  </action>
  <verify>
    cd packages/adapters/evm && npx vitest run --reporter=verbose 2>&1 | tail -30
    cd packages/core && npx vitest run --reporter=verbose 2>&1 | tail -20
  </verify>
  <done>
    - SubmitResult.status 타입이 'submitted' | 'confirmed' | 'finalized' | 'failed' 4가지를 포함한다
    - EVM waitForConfirmation이 타임아웃/RPC 에러 시 getTransactionReceipt fallback을 시도한다
    - fallback receipt 성공 시 confirmed/failed를, 실패 시 submitted를 반환한다
    - 기존 정상 경로 테스트가 통과한다
    - 새 테스트 3개가 모두 통과한다
  </done>
</task>

<task type="auto">
  <name>Task 2: Stage 6 반환값 기반 3-way 분기 + 테스트 수정</name>
  <files>
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/__tests__/pipeline.test.ts
    packages/daemon/src/__tests__/pipeline-notification.test.ts
  </files>
  <action>
1. `packages/daemon/src/pipeline/stages.ts` stage6Confirm (lines 679-720): try-catch 구조를 반환값 기반 분기로 교체:
   ```typescript
   export async function stage6Confirm(ctx: PipelineContext): Promise<void> {
     const reqAmount = getRequestAmount(ctx.request);
     const reqTo = getRequestTo(ctx.request);

     const result = await ctx.adapter.waitForConfirmation(ctx.submitResult!.txHash, 30_000);

     if (result.status === 'confirmed' || result.status === 'finalized') {
       // On-chain confirmed
       const executedAt = new Date(Math.floor(Date.now() / 1000) * 1000);
       await ctx.db
         .update(transactions)
         .set({ status: 'CONFIRMED', executedAt })
         .where(eq(transactions.id, ctx.txId));

       void ctx.notificationService?.notify('TX_CONFIRMED', ctx.walletId, {
         txHash: ctx.submitResult!.txHash,
         amount: reqAmount,
         to: reqTo,
       }, { txId: ctx.txId });

     } else if (result.status === 'failed') {
       // On-chain revert
       await ctx.db
         .update(transactions)
         .set({ status: 'FAILED', error: 'Transaction reverted on-chain' })
         .where(eq(transactions.id, ctx.txId));

       void ctx.notificationService?.notify('TX_FAILED', ctx.walletId, {
         reason: 'Transaction reverted on-chain',
         amount: reqAmount,
       }, { txId: ctx.txId });

       throw new WAIaaSError('CHAIN_ERROR', {
         message: 'Transaction reverted on-chain',
       });

     } else {
       // status === 'submitted': still pending, NOT failed
       // Keep SUBMITTED status (already set by Stage 5)
       // Do NOT overwrite to FAILED — tx may confirm later
       // No notification: no state change occurred
     }
   }
   ```
   핵심 변경:
   - try-catch 제거 → waitForConfirmation은 더 이상 throw하지 않음 (adapter가 내부에서 catch)
   - 반환값 3분기: confirmed → CONFIRMED, failed → FAILED (revert), submitted → 상태 유지
   - submitted 경로: throw 안 함 (실패가 아님), DB 업데이트 안 함 (이미 SUBMITTED)

2. `packages/daemon/src/__tests__/pipeline.test.ts` Stage 6 테스트 수정:
   - "should update DB to CONFIRMED on success" — 그대로 유지 (mock adapter가 { status: 'confirmed' } 반환)
   - "should mark FAILED on confirmation error" — 수정: mock adapter가 throw 대신 `{ txHash, status: 'submitted' }` 반환하도록 변경. DB 상태가 SUBMITTED(FAILED 아님)인지 검증. stage6Confirm이 throw하지 않는지 검증.
   - 새 테스트: "should mark FAILED when waitForConfirmation returns failed (on-chain revert)" — mock adapter가 { txHash, status: 'failed' } 반환, DB 상태 FAILED 검증, WAIaaSError throw 검증
   - 새 테스트: "should keep SUBMITTED when waitForConfirmation returns submitted" — mock adapter가 { txHash, status: 'submitted' } 반환, DB 상태 SUBMITTED 유지 검증, throw 안 하는지 검증

3. `packages/daemon/src/__tests__/pipeline-notification.test.ts` 수정:
   - "TX_CONFIRMED notification" — 그대로 유지
   - "TX_FAILED on confirmation failure" — 수정: mock adapter가 throw 대신 `{ txHash, status: 'failed' }` 반환하도록 변경. TX_FAILED 알림의 reason이 'Transaction reverted on-chain'인지 검증.
   - "Pipeline stages without notificationService" — 그대로 유지 (mock adapter가 confirmed 반환)
  </action>
  <verify>
    cd packages/daemon && npx vitest run src/__tests__/pipeline.test.ts src/__tests__/pipeline-notification.test.ts --reporter=verbose 2>&1 | tail -40
  </verify>
  <done>
    - stage6Confirm이 try-catch 대신 반환값 기반 3-way 분기를 사용한다
    - confirmed 반환 시 DB가 CONFIRMED로, failed 반환 시 FAILED로 업데이트된다
    - submitted 반환 시 DB 상태가 SUBMITTED로 유지되며 throw하지 않는다
    - 기존 테스트가 수정된 동작에 맞게 업데이트되어 통과한다
    - 새 테스트 2개(pipeline.test.ts)가 통과한다
    - 알림 테스트가 새 동작에 맞게 통과한다
  </done>
</task>

</tasks>

<verification>
1. `cd packages/core && npx vitest run --reporter=verbose` — SubmitResult 타입 변경으로 인한 회귀 없음
2. `cd packages/adapters/evm && npx vitest run --reporter=verbose` — EVM adapter 테스트 전체 통과
3. `cd packages/daemon && npx vitest run src/__tests__/pipeline.test.ts src/__tests__/pipeline-notification.test.ts --reporter=verbose` — Stage 6 테스트 전체 통과
4. `npx vitest run --reporter=verbose 2>&1 | grep -E '(FAIL|PASS|Tests)'` — 전체 테스트 스위트에서 새로운 실패 없음
</verification>

<success_criteria>
- EVM waitForConfirmation이 타임아웃 후 getTransactionReceipt fallback으로 온체인 상태를 정확히 반환한다
- stage6Confirm이 confirmed/failed/submitted 3가지 상태에 따라 DB를 정확히 기록한다
- 이미 SUBMITTED인 트랜잭션이 확인 실패로 FAILED로 덮어쓰이지 않는다
- 기존 정상 경로에 대한 회귀가 없다 (전체 테스트 통과)
</success_criteria>

<output>
After completion, create `.planning/phases/96-pipeline-confirmation-fix/96-01-SUMMARY.md`
</output>
