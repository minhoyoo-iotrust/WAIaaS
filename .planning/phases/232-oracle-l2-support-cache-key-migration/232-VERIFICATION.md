---
phase: 232-oracle-l2-support-cache-key-migration
verified: 2026-02-22T05:30:00Z
status: passed
score: 7/7 must-haves verified
re_verification: false
---

# Phase 232: Oracle L2 Support + Cache Key Migration Verification Report

**Phase Goal:** 가격 오라클이 CAIP-19 기반 캐시 키를 사용하여 L2 네트워크(Polygon, Arbitrum, Optimism, Base) 토큰 가격을 정확히 조회할 수 있는 상태
**Verified:** 2026-02-22T05:30:00Z
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths (Plan 01)

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | `buildCacheKey('ethereum-mainnet', 'native')` returns `'eip155:1/slip44:60'` | VERIFIED | `price-cache.ts` delegates to `nativeAssetId(network)`. Test in `price-cache.test.ts` line 238 asserts exact value. |
| 2 | `buildCacheKey('polygon-mainnet', '0xAddr')` returns `'eip155:137/erc20:0xaddr'` | VERIFIED | Tested at `price-cache.test.ts` line 247. tokenAssetId handles lowercase internally. |
| 3 | `buildCacheKey('mainnet', 'EPjFWdd5...')` returns Solana CAIP-19 with base58 preserved | VERIFIED | Tested at `price-cache.test.ts` line 230. |
| 4 | `COINGECKO_PLATFORM_MAP` has 6 mainnet entries including all 4 L2 networks | VERIFIED | `coingecko-platform-ids.ts` lines 29-37: mainnet, ethereum-mainnet, polygon-mainnet, arbitrum-mainnet, optimism-mainnet, base-mainnet. |
| 5 | `getCoinGeckoPlatform('polygon-mainnet')` returns `{ platformId: 'polygon-pos', nativeCoinId: 'matic-network' }` | VERIFIED | Confirmed in source at line 33. Test 13 in `coingecko-oracle.test.ts` verifies URL uses `polygon-pos`. |
| 6 | `PYTH_FEED_IDS` keys are CAIP-19 strings generated by `nativeAssetId`/`tokenAssetId` | VERIFIED | `pyth-feed-ids.ts` lines 27-32 use programmatic calls. BTC synthetic key removed. 4 entries total. |
| 7 | All oracle files compile clean with new `buildCacheKey(network, address)` signature | VERIFIED | Zero legacy `buildCacheKey(chain,...)` or `getCoinGeckoPlatform(chain,...)` calls found in oracle directory. 4 commits landed cleanly. |

### Observable Truths (Plan 02)

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | `buildCacheKey` tests verify CAIP-19 output for ethereum-mainnet, polygon-mainnet, mainnet | VERIFIED | `price-cache.test.ts` lines 225-255: 6 buildCacheKey tests with explicit CAIP-19 string assertions. |
| 2 | CoinGecko oracle L2 test verifies Polygon USDC uses `polygon-pos` platformId | VERIFIED | `coingecko-oracle.test.ts` lines 327-350: Test 13 asserts URL contains `/simple/token_price/polygon-pos` and does NOT contain `/simple/token_price/ethereum`. |
| 3 | Pyth oracle test verifies getPrice for SOL/native uses CAIP-19 cache key to find feed ID | VERIFIED | `pyth-oracle.test.ts` line 50: token includes `network: 'mainnet'`. resolveNetwork + buildCacheKey produce CAIP-19 key to look up feed. |
| 4 | OracleChain test verifies CAIP-19 cache key format | VERIFIED | `oracle-chain.test.ts` lines 16, 45-57: imports `buildCacheKey`, SOL_TOKEN and ETH_TOKEN include network field. |
| 5 | Cross-validation test confirms `getFeedId(buildCacheKey(network, address))` returns correct feed ID for all 4 entries | VERIFIED | `price-cache.test.ts` lines 276-309: 5 cross-validation tests. Test at line 293 loops all 4 entries and asserts `PYTH_FEED_IDS.size === 4`. |
| 6 | `resolveEffectiveAmountUsd` passes network to `priceOracle.getPrice` for TOKEN_TRANSFER | VERIFIED | `resolve-effective-amount-usd.ts` lines 97-102: `network: network as NetworkType | undefined` threaded to TokenRef. `stages.ts` line 329 passes `ctx.resolvedNetwork`. |
| 7 | All existing oracle tests pass with updated expectations (no regressions) | VERIFIED | Zero legacy `chain:address` key assertions in test files. Commits dc5aff88 + ef4add5d completed with no issues noted. |

**Score:** 7/7 Plan 01 truths verified, 7/7 Plan 02 truths verified

---

## Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `packages/daemon/src/infrastructure/oracle/price-cache.ts` | `buildCacheKey(network, address)` + `resolveNetwork` | VERIFIED | Both functions exported. Uses `nativeAssetId`/`tokenAssetId`. Lines 38-63. |
| `packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts` | 6-entry NetworkType-keyed platform map with L2 networks | VERIFIED | All 6 entries present including polygon-pos, arbitrum-one, optimistic-ethereum, base. Lines 29-37. |
| `packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts` | PYTH_FEED_IDS with CAIP-19 keys + NATIVE_FEED_MAP with NetworkType keys | VERIFIED | Uses `nativeAssetId`/`tokenAssetId` for keys. NATIVE_FEED_MAP uses NetworkType. Lines 25-43. |
| `packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts` | Network-aware getPrice/getPrices with batch grouping by network | VERIFIED | `resolveNetwork` called in all three public methods. Batch groups by resolved network. Lines 53-147. |
| `packages/daemon/src/infrastructure/oracle/pyth-oracle.ts` | resolveNetwork before buildCacheKey in all oracle methods | VERIFIED | `resolveNetwork(token.chain, token.network)` called before `buildCacheKey`. Lines 71-72, 119-120. |
| `packages/daemon/src/infrastructure/oracle/oracle-chain.ts` | resolveNetwork before buildCacheKey in all oracle methods | VERIFIED | resolveNetwork called at lines 94, 118, 139. `buildCacheKey(network, ...)` used consistently. |
| `packages/daemon/src/infrastructure/oracle/index.ts` | Export `resolveNetwork` from barrel | VERIFIED | Line 16 exports `resolveNetwork` alongside `buildCacheKey`. |
| `packages/daemon/src/__tests__/price-cache.test.ts` | buildCacheKey CAIP-19 output tests + resolveNetwork + cross-validation | VERIFIED | 6 buildCacheKey tests, 4 resolveNetwork tests, 5 PYTH_FEED_IDS cross-validation tests. All with CAIP-19 assertions. |
| `packages/daemon/src/__tests__/coingecko-oracle.test.ts` | L2 token price query tests via CoinGecko | VERIFIED | POLYGON_USDC fixture at line 42. Test 13 (polygon-pos) and Test 14 (L1+L2 separate batch calls) verified. |
| `packages/daemon/src/__tests__/pyth-oracle.test.ts` | Pyth oracle tests with CAIP-19 cache keys | VERIFIED | `network: 'mainnet'` field included in token fixtures. |
| `packages/daemon/src/__tests__/oracle-chain.test.ts` | OracleChain tests with CAIP-19 cache keys | VERIFIED | `network` field on SOL_TOKEN and ETH_TOKEN fixtures. `buildCacheKey` imported and used. |
| `packages/daemon/src/pipeline/resolve-effective-amount-usd.ts` | Network-aware TokenRef construction for oracle calls | VERIFIED | Optional `network?` param at line 73. Passed to `priceOracle.getPrice` in TOKEN_TRANSFER (line 101) and BATCH (line 216). |
| `packages/daemon/src/pipeline/stages.ts` | Pass `ctx.resolvedNetwork` to `resolveEffectiveAmountUsd` | VERIFIED | Line 329: `resolveEffectiveAmountUsd(req, txType, ctx.wallet.chain, ctx.priceOracle, ctx.resolvedNetwork)`. |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| `price-cache.ts` | `@waiaas/core` caip module | `import nativeAssetId, tokenAssetId` | WIRED | Line 14: `import { nativeAssetId, tokenAssetId } from '@waiaas/core'`. Core exports confirmed at `packages/core/src/caip/index.ts:19`. |
| `pyth-feed-ids.ts` | `price-cache.ts` | PYTH_FEED_IDS keys use `nativeAssetId()`/`tokenAssetId()` | WIRED | Lines 27-32 use programmatic calls. Keys match `buildCacheKey` output by construction. |
| `coingecko-oracle.ts` | `price-cache.ts` | All `buildCacheKey` calls pass resolved network | WIRED | `resolveNetwork` called before every `buildCacheKey` call. `getCoinGeckoPlatform(network)` used throughout. Zero legacy `buildCacheKey(chain,...)` calls. |
| `price-cache.test.ts` | `price-cache.ts` | Tests verify `buildCacheKey` + `resolveNetwork` output correctness | WIRED | Test file imports both functions and PYTH_FEED_IDS. Cross-validation tests at lines 276-309. |
| `coingecko-oracle.test.ts` | `coingecko-oracle.ts` | Tests verify L2 network platform resolution | WIRED | `POLYGON_USDC` fixture with `network: 'polygon-mainnet'`. URL assertion confirms `polygon-pos` in Test 13. |
| `resolve-effective-amount-usd.ts` | `oracle-chain.ts` | TOKEN_TRANSFER passes `network` in TokenRef | WIRED | `network: network as NetworkType | undefined` at line 101. Pipeline `stages.ts` line 329 threads `ctx.resolvedNetwork`. |

---

## Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|------------|-------------|--------|----------|
| ORCL-01 | 232-01 | Price oracle cache key uses CAIP-19 format instead of legacy `${chain}:${address}` | SATISFIED | `buildCacheKey` produces CAIP-19 via `nativeAssetId`/`tokenAssetId`. Zero legacy format in oracle code. |
| ORCL-02 | 232-01 | CoinGecko platform ID map expanded to cover L2 networks (polygon-pos, arbitrum-one, optimistic-ethereum, base) | SATISFIED | 6-entry `COINGECKO_PLATFORM_MAP` with all 4 L2 platforms confirmed in source. |
| ORCL-03 | 232-02 | L2 token prices can be resolved via CoinGecko using CAIP-2 based platform mapping | SATISFIED | Test 13 + Test 14 in `coingecko-oracle.test.ts` verify Polygon USDC resolves via `polygon-pos` platform. Network threading through pipeline confirmed. |
| ORCL-04 | 232-01 | PYTH_FEED_IDS key format updated atomically with cache key migration | SATISFIED | `pyth-feed-ids.ts` uses `nativeAssetId`/`tokenAssetId` for all 4 entries. Cross-validation tests confirm keys match `buildCacheKey` output. BTC synthetic entry removed. |

All 4 requirements from REQUIREMENTS.md (checked as Complete at phase 232) are satisfied. No orphaned requirements detected.

---

## Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| None found | — | — | — | — |

Scanned all 13 artifacts. No TODOs, FIXMEs, placeholder returns, or stub implementations found. `forex-rate-service.ts` contains `chain:address` in a doc comment only (line 8) — not active code, not in scope for this phase.

---

## Human Verification Required

None. All observable truths are verifiable programmatically:
- Cache key format is deterministic and tested with exact string assertions.
- CoinGecko platform routing is verified via fetch URL assertions in mocked tests.
- Pyth feed ID lookup is verified via cross-validation tests with known feed IDs.
- Network threading is verified via `expect.objectContaining({ network: 'polygon-mainnet' })` assertions.

---

## Gaps Summary

No gaps found. Phase goal fully achieved:

1. `buildCacheKey` produces CAIP-19 URIs via `nativeAssetId`/`tokenAssetId` from `@waiaas/core` — wired and tested.
2. `COINGECKO_PLATFORM_MAP` has all 6 required NetworkType-keyed entries — confirmed in source.
3. `PYTH_FEED_IDS` keys are atomically migrated to programmatic CAIP-19 generation — 4 entries, BTC synthetic removed, cross-validation tests verify atomicity.
4. All 9 `buildCacheKey` call sites across 3 oracle files migrated from `chain` to resolved `network`.
5. Pipeline (`resolve-effective-amount-usd.ts` + `stages.ts`) threads `ctx.resolvedNetwork` to oracle for accurate L2 token pricing.
6. All 4 commits verified in git log (4d4a2094, 2ab5d6c3, dc5aff88, ef4add5d).

---

_Verified: 2026-02-22T05:30:00Z_
_Verifier: Claude (gsd-verifier)_
