---
phase: 232-oracle-l2-support-cache-key-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/oracle/price-cache.ts
  - packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts
  - packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts
  - packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
  - packages/daemon/src/infrastructure/oracle/pyth-oracle.ts
  - packages/daemon/src/infrastructure/oracle/oracle-chain.ts
autonomous: true
requirements: [ORCL-01, ORCL-02, ORCL-04]

must_haves:
  truths:
    - "buildCacheKey('ethereum-mainnet', 'native') returns 'eip155:1/slip44:60' (CAIP-19 format)"
    - "buildCacheKey('polygon-mainnet', '0xAddr') returns 'eip155:137/erc20:0xaddr' (L2 CAIP-19 with lowercased address)"
    - "buildCacheKey('mainnet', 'EPjFWdd5...') returns 'solana:5eykt.../token:EPjFWdd5...' (Solana base58 preserved)"
    - "COINGECKO_PLATFORM_MAP has 6 mainnet entries: mainnet, ethereum-mainnet, polygon-mainnet, arbitrum-mainnet, optimism-mainnet, base-mainnet"
    - "getCoinGeckoPlatform('polygon-mainnet') returns { platformId: 'polygon-pos', nativeCoinId: 'matic-network' }"
    - "PYTH_FEED_IDS keys are CAIP-19 strings generated by nativeAssetId/tokenAssetId"
    - "getFeedId(buildCacheKey('mainnet', 'native')) returns the SOL/USD Pyth feed ID"
    - "All oracle files compile clean with new buildCacheKey(network, address) signature"
  artifacts:
    - path: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      provides: "buildCacheKey(network, address) + resolveNetwork(chain, network?) helper"
      contains: "nativeAssetId|tokenAssetId"
    - path: "packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts"
      provides: "6-entry NetworkType-keyed CoinGecko platform map with L2 networks"
      contains: "polygon-pos|arbitrum-one|optimistic-ethereum|base"
    - path: "packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts"
      provides: "PYTH_FEED_IDS with CAIP-19 keys + NATIVE_FEED_MAP with NetworkType keys"
      contains: "nativeAssetId|tokenAssetId"
  key_links:
    - from: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      to: "@waiaas/core caip module"
      via: "import nativeAssetId, tokenAssetId"
      pattern: "import.*nativeAssetId.*tokenAssetId.*from.*@waiaas/core"
    - from: "packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts"
      to: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      via: "PYTH_FEED_IDS keys must match buildCacheKey output format"
      pattern: "nativeAssetId\\("
    - from: "packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts"
      to: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      via: "All buildCacheKey calls pass network (resolved from token)"
      pattern: "buildCacheKey\\(.*network"
---

<objective>
Rewrite buildCacheKey to produce CAIP-19 URIs, expand the CoinGecko platform map for L2 networks, and atomically update PYTH_FEED_IDS keys to match.

Purpose: Enable the price oracle to distinguish tokens on different L2 networks (same address, different chain) via CAIP-19 cache keys, and support CoinGecko price queries for Polygon/Arbitrum/Optimism/Base.

Output: All oracle source files updated with new buildCacheKey signature, expanded platform map, and CAIP-19 Pyth feed keys. Compiles clean.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/232-oracle-l2-support-cache-key-migration/232-RESEARCH.md
@.planning/phases/231-core-caip-module-network-map/231-02-SUMMARY.md

# Source files (read before modifying)
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts
@packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts
@packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
@packages/daemon/src/infrastructure/oracle/pyth-oracle.ts
@packages/daemon/src/infrastructure/oracle/oracle-chain.ts

# Phase 231 CAIP module (SSoT for CAIP-19 generation)
@packages/core/src/caip/asset-helpers.ts
@packages/core/src/caip/network-map.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite buildCacheKey + resolveNetwork helper + expand CoinGecko platform map + update PYTH_FEED_IDS keys</name>
  <files>
    packages/daemon/src/infrastructure/oracle/price-cache.ts
    packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts
    packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts
  </files>
  <action>
    **price-cache.ts:**
    1. Import `nativeAssetId`, `tokenAssetId` from `@waiaas/core` and `NetworkType`, `ChainType` types.
    2. Add a `resolveNetwork(chain: ChainType, network?: NetworkType): NetworkType` helper function:
       - If `network` is provided, return it directly.
       - If not, default: `chain === 'solana' ? 'mainnet' : 'ethereum-mainnet'`
       - Export this function (callers in other oracle files + pipeline need it).
    3. Rewrite `buildCacheKey` signature from `(chain: string, address: string)` to `(network: NetworkType, address: string)`:
       - If `address === 'native'`, return `nativeAssetId(network)`.
       - Otherwise, return `tokenAssetId(network, address)`.
       - Remove the manual EVM lowercase logic (tokenAssetId handles it internally).
       - Update JSDoc to document CAIP-19 output format.

    **coingecko-platform-ids.ts:**
    1. Rekey `COINGECKO_PLATFORM_MAP` from ChainType keys to NetworkType keys:
       - `'mainnet'`: `{ platformId: 'solana', nativeCoinId: 'solana' }`
       - `'ethereum-mainnet'`: `{ platformId: 'ethereum', nativeCoinId: 'ethereum' }`
       - `'polygon-mainnet'`: `{ platformId: 'polygon-pos', nativeCoinId: 'matic-network' }`
       - `'arbitrum-mainnet'`: `{ platformId: 'arbitrum-one', nativeCoinId: 'ethereum' }`
       - `'optimism-mainnet'`: `{ platformId: 'optimistic-ethereum', nativeCoinId: 'ethereum' }`
       - `'base-mainnet'`: `{ platformId: 'base', nativeCoinId: 'ethereum' }`
    2. Update `getCoinGeckoPlatform` parameter name from `chain` to `network` (string type stays for flexibility).
    3. Update JSDoc comments to reflect NetworkType keying (remove "L2 out of scope" comment).

    **pyth-feed-ids.ts:**
    1. Import `nativeAssetId`, `tokenAssetId` from `@waiaas/core` and `NetworkType` type.
    2. Rewrite `PYTH_FEED_IDS` keys to use programmatic CAIP-19 generation:
       - `nativeAssetId('mainnet')` -> SOL/USD feed ID (unchanged hex value)
       - `nativeAssetId('ethereum-mainnet')` -> ETH/USD feed ID (unchanged hex value)
       - `tokenAssetId('mainnet', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v')` -> USDC/USD
       - `tokenAssetId('mainnet', 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB')` -> USDT/USD
       - REMOVE the `'ethereum:native_btc'` entry -- it is a synthetic key with no valid CAIP-19 mapping and no real on-chain token. BTC pricing can use WBTC's actual ERC-20 address if needed in the future.
    3. Rekey `NATIVE_FEED_MAP` from `ChainType` to `NetworkType`:
       - `'mainnet'` -> SOL/USD feed (was `'solana'`)
       - `'ethereum-mainnet'` -> ETH/USD feed (was `'ethereum'`)
    4. Update `getNativeFeedId` parameter from `chain: ChainType` to `network: NetworkType`.
    5. Export the `resolveNetwork` helper from `price-cache.ts` re-export if not already accessible.

    CRITICAL: All three files must be modified in the same commit to maintain key format atomicity (Pitfall 1 from research). If buildCacheKey outputs CAIP-19 but PYTH_FEED_IDS still uses legacy keys, all Pyth lookups silently fail.
  </action>
  <verify>
    Run `pnpm turbo run typecheck --filter=@waiaas/daemon` and confirm zero type errors in the three modified files. Grep for legacy buildCacheKey(chain, address) calls to confirm none remain in these files.
  </verify>
  <done>
    buildCacheKey produces CAIP-19 URIs using nativeAssetId/tokenAssetId. COINGECKO_PLATFORM_MAP has 6 NetworkType-keyed entries including 4 L2 networks. PYTH_FEED_IDS keys use programmatic CAIP-19 generation matching buildCacheKey output. NATIVE_FEED_MAP uses NetworkType keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all oracle callers to new buildCacheKey(network, address) signature</name>
  <files>
    packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
    packages/daemon/src/infrastructure/oracle/pyth-oracle.ts
    packages/daemon/src/infrastructure/oracle/oracle-chain.ts
  </files>
  <action>
    **coingecko-oracle.ts:**
    1. Import `resolveNetwork` from `./price-cache.js`.
    2. In `getPrice(token)`:
       - Resolve network: `const network = resolveNetwork(token.chain, token.network);`
       - Change `getCoinGeckoPlatform(token.chain)` to `getCoinGeckoPlatform(network)`.
       - Change `token.chain === 'ethereum'` address lowering to check `isEvm(token.chain)` or keep as-is (both work since CoinGecko API always wants lowercase for EVM). The key insight: CoinGecko returns lowercase keys in response, so the address lowering in the API query is still needed for the response lookup.
    3. In `getNativePrice(chain)`:
       - Add optional `network?: NetworkType` parameter or change to accept NetworkType.
       - Actually, since getNativePrice is part of IPriceOracle interface (which takes ChainType), keep the signature but resolve network internally: `const network = resolveNetwork(chain);`
       - Use `getCoinGeckoPlatform(network)` instead of `getCoinGeckoPlatform(chain)`.
    4. In `getPrices(tokens)`:
       - Change the batch grouping from `token.chain` to the resolved network (or the CoinGecko platformId).
       - For each token: `const network = resolveNetwork(token.chain, token.network);`
       - Group by network (or platformId) instead of chain.
       - Update `buildCacheKey(token.chain, 'native')` to `buildCacheKey(resolveNetwork(token.chain, token.network), 'native')` for native tokens.
       - Update `buildCacheKey(chain, token.address)` to `buildCacheKey(network, token.address)` in `fetchBatchTokenPrices`.
    5. In `fetchBatchTokenPrices`:
       - Change parameter from `chain: string` to `network: string` (or NetworkType).
       - Update `getCoinGeckoPlatform(chain)` to `getCoinGeckoPlatform(network)`.
       - Keep the `chain === 'ethereum'` address lowering -- but it should use `isEvm` check. Since all EVM L2s have `chain: 'ethereum'`, the existing check works. Alternatively, check if the network starts with 'eip155' concepts. Simplest: keep `chain === 'ethereum'` since it correctly identifies all EVM tokens.

    **pyth-oracle.ts:**
    1. Import `resolveNetwork` from `./price-cache.js`.
    2. In `getPrice(token)`:
       - Resolve network: `const network = resolveNetwork(token.chain, token.network);`
       - Change `buildCacheKey(token.chain, token.address)` to `buildCacheKey(network, token.address)`.
    3. In `getPrices(tokens)`:
       - For each token: resolve network and use `buildCacheKey(network, token.address)`.
    4. In `getNativePrice(chain)`:
       - Resolve network internally: `const network = resolveNetwork(chain);`
       - Pass `network` to getPrice via the token object -- or since getPrice now resolves network itself, just ensure the token has network set. Actually, since `getNativePrice` constructs a minimal TokenRef `{ address: 'native', decimals, chain }`, and getPrice then calls resolveNetwork which defaults correctly, this works without changes. But it's cleaner to pass network explicitly.

    **oracle-chain.ts:**
    1. Import `resolveNetwork` from `./price-cache.js`.
    2. In `getPrice(token)`:
       - Resolve network: `const network = resolveNetwork(token.chain, token.network);`
       - Change `buildCacheKey(token.chain, token.address)` to `buildCacheKey(network, token.address)`.
    3. In `getPrices(tokens)`:
       - For each token: resolve network and use `buildCacheKey(network, token.address)`.
    4. In `getNativePrice(chain)`:
       - Resolve network internally and pass to getPrice.

    IMPORTANT: After updating all three files, run typecheck to ensure no residual calls to the old buildCacheKey(chain, address) signature remain.
  </action>
  <verify>
    Run `pnpm turbo run typecheck --filter=@waiaas/daemon` -- zero errors. Run `grep -rn 'buildCacheKey(token\.chain' packages/daemon/src/infrastructure/oracle/` -- zero matches (all migrated to network).
  </verify>
  <done>
    All 9 buildCacheKey call sites across coingecko-oracle, pyth-oracle, and oracle-chain now use `buildCacheKey(network, address)` with resolved NetworkType. CoinGecko batch queries group by network/platformId instead of chain. getNativePrice resolves network internally. Full compilation passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` passes with zero errors.
2. `grep -rn "buildCacheKey(token\.chain\|buildCacheKey(chain" packages/daemon/src/infrastructure/oracle/` returns zero matches (all call sites migrated).
3. `grep -rn "getCoinGeckoPlatform(chain\|getCoinGeckoPlatform(token\.chain" packages/daemon/src/infrastructure/oracle/` returns zero matches.
4. The PYTH_FEED_IDS Map has exactly 4 entries (BTC removed), all with CAIP-19 keys.
5. COINGECKO_PLATFORM_MAP has exactly 6 entries (mainnet, ethereum-mainnet, polygon-mainnet, arbitrum-mainnet, optimism-mainnet, base-mainnet).
</verification>

<success_criteria>
- All 6 oracle source files compile clean with the new CAIP-19 cache key format.
- buildCacheKey produces CAIP-19 URIs for all input combinations (native + token, EVM + Solana, L1 + L2).
- PYTH_FEED_IDS keys match buildCacheKey output (atomic consistency).
- CoinGecko platform map covers 6 mainnet networks including 4 L2s.
- No legacy `chain:address` key format remains in oracle code.
</success_criteria>

<output>
After completion, create `.planning/phases/232-oracle-l2-support-cache-key-migration/232-01-SUMMARY.md`
</output>
