---
phase: 132-rest-api-policy-audit-log
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/services/x402/x402-domain-policy.ts
  - packages/daemon/src/__tests__/x402-domain-policy.test.ts
  - packages/daemon/src/infrastructure/config/loader.ts
autonomous: true

must_haves:
  truths:
    - "X402_ALLOWED_DOMAINS 정책이 없으면 x402 결제가 기본 거부된다"
    - "정확한 도메인 매칭과 와일드카드(*.example.com) 매칭이 동작한다"
    - "와일드카드 *.example.com은 example.com 자체를 허용하지 않고 sub.example.com만 허용한다 (dot-boundary)"
    - "도메인 비교는 대소문자 무시(case-insensitive)로 수행된다"
    - "config.toml [x402] 섹션으로 enabled(기본 true)와 request_timeout(기본 30초)을 설정할 수 있다"
  artifacts:
    - path: "packages/daemon/src/services/x402/x402-domain-policy.ts"
      provides: "matchDomain + evaluateX402Domain 함수"
      exports: ["matchDomain", "evaluateX402Domain"]
    - path: "packages/daemon/src/__tests__/x402-domain-policy.test.ts"
      provides: "도메인 정책 평가 테스트"
      min_lines: 80
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "[x402] 섹션 스키마 + KNOWN_SECTIONS 확장"
      contains: "x402"
  key_links:
    - from: "packages/daemon/src/services/x402/x402-domain-policy.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "policies 테이블에서 X402_ALLOWED_DOMAINS 타입 조회"
      pattern: "type.*X402_ALLOWED_DOMAINS"
    - from: "packages/daemon/src/infrastructure/config/loader.ts"
      to: "DaemonConfigSchema"
      via: "x402 섹션 추가"
      pattern: "x402.*enabled.*request_timeout"
---

<objective>
X402_ALLOWED_DOMAINS 정책 평가 모듈을 TDD로 구현하고, config.toml [x402] 섹션을 추가한다.

Purpose: x402 결제 전 도메인 화이트리스트 검증은 보안의 첫 관문이다. 기본 거부 원칙으로 허용되지 않은 도메인에 대한 결제를 차단한다. 와일드카드 매칭의 정확성이 보안에 직결되므로 TDD로 구현한다.
Output: x402-domain-policy.ts (matchDomain, evaluateX402Domain), 테스트, config.toml [x402] 섹션
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/132-rest-api-policy-audit-log/132-RESEARCH.md
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/infrastructure/config/loader.ts
</context>

<feature>
  <name>X402_ALLOWED_DOMAINS 도메인 정책 평가 + config.toml [x402] 섹션</name>
  <files>packages/daemon/src/services/x402/x402-domain-policy.ts, packages/daemon/src/__tests__/x402-domain-policy.test.ts, packages/daemon/src/infrastructure/config/loader.ts</files>
  <behavior>
    도메인 매칭 (matchDomain):
    - matchDomain("api.example.com", "api.example.com") -> true (정확한 매칭)
    - matchDomain("API.Example.COM", "api.example.com") -> true (대소문자 무시)
    - matchDomain("*.example.com", "sub.example.com") -> true (와일드카드 매칭)
    - matchDomain("*.example.com", "a.b.example.com") -> true (다중 서브도메인)
    - matchDomain("*.example.com", "example.com") -> false (dot-boundary: 루트 도메인 불허)
    - matchDomain("*.com", "anything.com") -> true (TLD 와일드카드)
    - matchDomain("other.com", "api.example.com") -> false (불일치)

    정책 평가 (evaluateX402Domain):
    - 정책 없음 -> { allowed: false, reason: 'x402 payments disabled...' }
    - 정책 있음 + 도메인 허용 -> null (다음 평가 계속)
    - 정책 있음 + 도메인 불허 -> { allowed: false, reason: "Domain 'evil.com' not in..." }

    config.toml [x402] 섹션:
    - 빈 [x402] -> { enabled: true, request_timeout: 30 }
    - [x402] enabled = false -> { enabled: false, request_timeout: 30 }
    - [x402] request_timeout = 60 -> { enabled: true, request_timeout: 60 }
    - request_timeout < 5 또는 > 120 -> Zod validation error
    - WAIAAS_X402_ENABLED=false 환경변수 오버라이드 동작
  </behavior>
  <implementation>
    1. x402-domain-policy.ts 구현:
       - matchDomain(pattern: string, target: string): boolean
         - 패턴과 타겟을 모두 toLowerCase() 변환
         - 정확한 매칭: p === t -> true
         - 와일드카드: p.startsWith('*.') -> suffix = p.slice(1), t.endsWith(suffix) && t.length > suffix.length
         - 나머지: false
       - evaluateX402Domain(resolved: PolicyRow[], targetDomain: string): PolicyEvaluation | null
         - resolved에서 type === 'X402_ALLOWED_DOMAINS' 정책 찾기
         - 정책 없음: { allowed: false, tier: 'INSTANT', reason: 'x402 payments disabled: no X402_ALLOWED_DOMAINS policy configured' }
         - 정책의 rules.domains에서 matchDomain으로 매칭
         - 매칭 실패: { allowed: false, tier: 'INSTANT', reason: `Domain '${targetDomain}' not in allowed x402 domains list` }
         - 매칭 성공: null (다음 평가 계속)
       - PolicyRow는 DatabasePolicyEngine의 기존 타입과 동일한 인터페이스를 로컬 정의 (private type이므로 import 불가)

    2. config.toml [x402] 섹션 (loader.ts):
       - DaemonConfigSchema에 x402 섹션 추가:
         ```
         x402: z.object({
           enabled: z.boolean().default(true),
           request_timeout: z.number().int().min(5).max(120).default(30),
         }).default({})
         ```
       - KNOWN_SECTIONS에 'x402' 추가
       - 기존 테스트가 [x402] 섹션을 unknown section으로 거부하지 않도록 확인

    주의: DatabasePolicyEngine 자체를 수정하지 않는다. X402_ALLOWED_DOMAINS는 트랜잭션 정책이 아닌 도메인 정책이므로 별도 모듈에서 독립 평가한다. Research Pitfall 1 참조.
  </implementation>
</feature>

<verification>
```bash
# 테스트 실행
npx vitest run packages/daemon/src/__tests__/x402-domain-policy.test.ts

# TypeScript 컴파일 확인
npx tsc --noEmit -p packages/daemon/tsconfig.json

# 기존 config 테스트 통과 확인
npx vitest run packages/daemon/src/__tests__/config-loader.test.ts

# 전체 daemon 테스트 회귀 확인
npx vitest run --project daemon
```
</verification>

<success_criteria>
- matchDomain이 정확한 매칭, 와일드카드 매칭, dot-boundary 규칙, 대소문자 무시를 올바르게 처리한다
- evaluateX402Domain이 정책 없음 시 기본 거부, 도메인 허용/불허를 올바르게 판별한다
- DaemonConfigSchema에 x402.enabled와 x402.request_timeout이 존재하고 기본값이 적용된다
- KNOWN_SECTIONS에 'x402'가 포함되어 detectNestedSections에서 거부되지 않는다
- 기존 daemon 테스트가 모두 통과한다 (회귀 없음)
</success_criteria>

<output>
After completion, create `.planning/phases/132-rest-api-policy-audit-log/132-01-SUMMARY.md`
</output>
