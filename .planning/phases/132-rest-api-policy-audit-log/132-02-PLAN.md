---
phase: 132-rest-api-policy-audit-log
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/services/x402/x402-usd-resolver.ts
  - packages/daemon/src/__tests__/x402-usd-resolver.test.ts
autonomous: true

must_haves:
  truths:
    - "USDC 결제는 $1 직접 환산되어 Oracle 호출 없이 USD 금액이 계산된다"
    - "기타 토큰은 IPriceOracle을 통해 USD 환산된다"
    - "USDC 주소는 USDC_DOMAINS 상수에서 verifyingContract로 확인된다"
    - "Oracle 없이 비-USDC 토큰이면 USD 0으로 처리된다 (INSTANT 통과)"
  artifacts:
    - path: "packages/daemon/src/services/x402/x402-usd-resolver.ts"
      provides: "resolveX402UsdAmount 함수"
      exports: ["resolveX402UsdAmount"]
    - path: "packages/daemon/src/__tests__/x402-usd-resolver.test.ts"
      provides: "x402 USD 환산 테스트"
      min_lines: 40
  key_links:
    - from: "packages/daemon/src/services/x402/x402-usd-resolver.ts"
      to: "packages/daemon/src/services/x402/payment-signer.ts"
      via: "USDC_DOMAINS import"
      pattern: "USDC_DOMAINS"
---

<objective>
x402 결제 금액의 USD 환산 모듈을 TDD로 구현한다.

Purpose: x402 결제에서 SPENDING_LIMIT 정책 평가를 위해 결제 금액을 USD로 환산해야 한다. USDC는 $1 직접 환산하고 기타 토큰은 IPriceOracle을 사용하는 독립 모듈을 구현한다. X4POL-04 요구사항.
Output: x402-usd-resolver.ts (resolveX402UsdAmount)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/132-rest-api-policy-audit-log/132-RESEARCH.md
@packages/daemon/src/services/x402/payment-signer.ts
@packages/daemon/src/pipeline/resolve-effective-amount-usd.ts
</context>

<feature>
  <name>x402 결제 금액 USD 환산</name>
  <files>packages/daemon/src/services/x402/x402-usd-resolver.ts, packages/daemon/src/__tests__/x402-usd-resolver.test.ts</files>
  <behavior>
    USDC 결제 (6 decimals, $1 직접 환산):
    - resolveX402UsdAmount("1000000", "0x...usdc-address", "eip155:8453", oracle) -> 1.0 (USDC $1)
    - resolveX402UsdAmount("500000", "0x...usdc-address", "eip155:8453", oracle) -> 0.5 ($0.50)
    - resolveX402UsdAmount("100000000", "0x...usdc-address", "eip155:1", oracle) -> 100.0 ($100)
    - USDC 판별: USDC_DOMAINS[caip2Network].verifyingContract와 asset 비교 (case-insensitive)

    비-USDC 토큰 (IPriceOracle 사용):
    - resolveX402UsdAmount("1000000000000000000", "0xOtherToken", "eip155:1", oracleReturns2000) -> 2000.0
    - resolveX402UsdAmount("1000000000000000000", "0xOtherToken", "eip155:1", undefined) -> 0 (Oracle 없음)

    Solana USDC:
    - resolveX402UsdAmount("1000000", "EPjFW...usdc", "solana:5eykt4...", oracle) -> 1.0

    Oracle 에러 시:
    - Oracle throws -> 0 반환 (안전 폴백, INSTANT 통과)
  </behavior>
  <implementation>
    x402-usd-resolver.ts 구현:
    ```typescript
    import { USDC_DOMAINS } from './payment-signer.js';
    import type { IPriceOracle } from '@waiaas/core';
    import { parseCaip2 } from '@waiaas/core';

    export async function resolveX402UsdAmount(
      amount: string,
      asset: string,
      caip2Network: string,
      priceOracle?: IPriceOracle,
    ): Promise<number> {
      // 1. USDC 주소 확인 (USDC_DOMAINS에서 verifyingContract 비교)
      const usdcDomain = USDC_DOMAINS[caip2Network];
      if (usdcDomain && usdcDomain.verifyingContract.toLowerCase() === asset.toLowerCase()) {
        // USDC: 6 decimals, $1 직접 환산
        return Number(amount) / 1_000_000;
      }

      // 2. 비-USDC: IPriceOracle 사용 (없으면 0)
      if (!priceOracle) return 0;

      // CAIP-2에서 chain 추출
      const { namespace } = parseCaip2(caip2Network);
      const chain = namespace === 'eip155' ? 'ethereum' : 'solana';

      try {
        // x402 PaymentRequirements에는 decimals가 없으므로 기본값 사용
        // EVM: 18, Solana: 9 (가장 일반적)
        const decimals = chain === 'ethereum' ? 18 : 9;
        const priceInfo = await priceOracle.getPrice({
          address: asset,
          decimals,
          chain: chain as any,
        });
        const humanAmount = Number(amount) / Math.pow(10, decimals);
        return humanAmount * priceInfo.usdPrice;
      } catch {
        return 0; // 안전 폴백 (unknown price, INSTANT 통과)
      }
    }
    ```

    주의: USDC_DOMAINS는 payment-signer.ts에서 이미 7개 EVM 체인 + Solana를 포함한다. 그 중 Solana USDC의 키가 CAIP-2 형식인지 확인이 필요하다. USDC_DOMAINS의 키가 CAIP-2가 아닌 경우 별도 매핑이 필요할 수 있다 -- 구현 시 payment-signer.ts를 확인하고 대응한다.
  </implementation>
</feature>

<verification>
```bash
# 테스트 실행
npx vitest run packages/daemon/src/__tests__/x402-usd-resolver.test.ts

# TypeScript 컴파일 확인
npx tsc --noEmit -p packages/daemon/tsconfig.json

# 전체 daemon 테스트 회귀 확인
npx vitest run --project daemon
```
</verification>

<success_criteria>
- USDC 결제가 Oracle 호출 없이 $1 기준으로 정확하게 환산된다
- 비-USDC 토큰이 IPriceOracle을 통해 USD 환산된다
- Oracle 미제공 시 USD 0이 반환된다 (안전 폴백)
- Oracle 에러 시 예외를 삼키고 0을 반환한다
- 기존 daemon 테스트가 모두 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/132-rest-api-policy-audit-log/132-02-SUMMARY.md`
</output>
