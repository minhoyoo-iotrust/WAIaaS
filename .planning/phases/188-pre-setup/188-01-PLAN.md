---
phase: 188-pre-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - packages/core/package.json
  - packages/daemon/package.json
  - packages/cli/package.json
  - packages/sdk/package.json
  - packages/mcp/package.json
  - packages/skills/package.json
  - packages/admin/package.json
  - packages/adapters/solana/package.json
  - packages/adapters/evm/package.json
  - .github/workflows/release.yml
autonomous: true
requirements:
  - PREP-01
  - PREP-02
  - PREP-03

must_haves:
  truths:
    - "9개 package.json의 repository.url이 git+https://github.com/minhoyoo-iotrust/WAIaaS.git 이다"
    - "루트 package.json에 repository 필드가 object 형식으로 존재하며 directory 필드는 없다"
    - "8개 서브 패키지의 repository.directory 값이 각각의 실제 패키지 경로와 일치한다"
    - "release.yml deploy 잡에 npm >= 11.5.1 보장 스텝이 Build 뒤, Setup npmrc 앞에 존재한다"
    - "npm 버전이 11.5.1 미만이면 업그레이드하고, 이상이면 스킵한다"
  artifacts:
    - path: "package.json"
      provides: "Root repository metadata"
      contains: "git+https://github.com/minhoyoo-iotrust/WAIaaS.git"
    - path: "packages/core/package.json"
      provides: "Core package repository metadata"
      contains: "git+https://github.com/minhoyoo-iotrust/WAIaaS.git"
    - path: ".github/workflows/release.yml"
      provides: "npm CLI version upgrade step"
      contains: "Ensure npm >= 11.5.1"
  key_links:
    - from: "package.json (repository.url)"
      to: "GitHub remote (minhoyoo-iotrust/WAIaaS)"
      via: "Exact case-sensitive URL match"
      pattern: "git\\+https://github\\.com/minhoyoo-iotrust/WAIaaS\\.git"
    - from: ".github/workflows/release.yml (deploy job)"
      to: "npm publish (Phase 189)"
      via: "npm CLI >= 11.5.1 guaranteed before publish step"
      pattern: "npm install -g npm@latest"
---

<objective>
9개 package.json의 repository 필드를 실제 GitHub 원격(minhoyoo-iotrust/WAIaaS)과 일치시키고, release.yml deploy 잡에서 npm CLI >= 11.5.1을 보장하는 스텝을 추가한다.

Purpose: Phase 189(OIDC 전환)에서 `npm publish --provenance` 시 repository.url과 OIDC 토큰의 저장소 정보가 일치해야 provenance 검증(Sigstore)이 성공한다. npm CLI >= 11.5.1은 Trusted Publishing OIDC 지원의 필수 요구사항이다.
Output: 9개 수정된 package.json + release.yml deploy 잡 npm 업그레이드 스텝
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/188-pre-setup/188-CONTEXT.md
@.planning/phases/188-pre-setup/188-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 9개 package.json repository 필드 수정</name>
  <files>
    package.json
    packages/core/package.json
    packages/daemon/package.json
    packages/cli/package.json
    packages/sdk/package.json
    packages/mcp/package.json
    packages/skills/package.json
    packages/admin/package.json
    packages/adapters/solana/package.json
    packages/adapters/evm/package.json
  </files>
  <action>
    9개 package.json 파일의 repository 필드를 수정한다. 대소문자(case sensitivity)가 provenance 검증에 중요하므로 정확히 `minhoyoo-iotrust/WAIaaS`를 사용해야 한다.

    **루트 package.json:**
    - 현재 repository 필드가 없음. `"license": "MIT"` 뒤에 추가:
    ```json
    "repository": {
      "type": "git",
      "url": "git+https://github.com/minhoyoo-iotrust/WAIaaS.git"
    },
    ```
    - `directory` 필드 없음 (모노레포 루트이므로 생략, 유저 결정)

    **8개 서브 패키지 (core, daemon, cli, sdk, mcp, skills, admin, adapters/solana, adapters/evm):**
    - 현재 `"url": "https://github.com/minho-yoo/waiaas.git"` → `"url": "git+https://github.com/minhoyoo-iotrust/WAIaaS.git"` 로 변경
    - `type`, `directory` 필드는 그대로 유지 (이미 정확함)
    - 즉, URL 한 줄만 교체하면 됨

    **주의사항:**
    - npm pkg fix 사용 금지 -- 직접 Edit 도구로 수정 (포맷팅 유지)
    - 기존 들여쓰기(2-space)와 필드 순서 유지
    - `bugs`, `homepage` 등 다른 필드는 변경하지 않음 (이 phase 범위 밖)
  </action>
  <verify>
    아래 커맨드로 모든 package.json의 repository.url이 올바른지 확인:
    ```bash
    grep -r '"url":' package.json packages/*/package.json packages/adapters/*/package.json | grep repository -A1 || true
    # 또는
    node -e "
      const fs = require('fs');
      const pkgs = [
        'package.json',
        'packages/core/package.json',
        'packages/daemon/package.json',
        'packages/cli/package.json',
        'packages/sdk/package.json',
        'packages/mcp/package.json',
        'packages/skills/package.json',
        'packages/admin/package.json',
        'packages/adapters/solana/package.json',
        'packages/adapters/evm/package.json',
      ];
      const expected = 'git+https://github.com/minhoyoo-iotrust/WAIaaS.git';
      let ok = true;
      for (const p of pkgs) {
        const pkg = JSON.parse(fs.readFileSync(p, 'utf-8'));
        if (pkg.repository?.url !== expected) { console.error('FAIL:', p, pkg.repository?.url); ok = false; }
        else { console.log('OK:', p); }
      }
      if (!ok) process.exit(1);
      console.log('All 9 package.json repository.url correct');
    "
    ```
    루트 package.json에 `directory` 필드가 없는지 확인.
    8개 서브 패키지의 `directory` 필드가 실제 경로와 일치하는지 확인.
  </verify>
  <done>
    9개 package.json 모두 `"url": "git+https://github.com/minhoyoo-iotrust/WAIaaS.git"` 형식이고, 루트에는 directory가 없고, 8개 서브 패키지에는 정확한 directory가 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: release.yml deploy 잡에 npm CLI 버전 보장 스텝 추가</name>
  <files>
    .github/workflows/release.yml
  </files>
  <action>
    release.yml의 deploy 잡에서 Build 스텝과 Setup npmrc 스텝 사이에 npm 버전 확인+업그레이드 스텝을 추가한다.

    현재 deploy 잡 스텝 순서:
    1. Checkout
    2. Setup
    3. Build
    4. Setup npmrc  ← 여기 앞에 삽입
    5. pnpm publish
    6. Deploy summary

    삽입할 스텝:
    ```yaml
      - name: Ensure npm >= 11.5.1
        run: |
          CURRENT=$(npm --version)
          REQUIRED="11.5.1"
          echo "Current npm: $CURRENT, Required: >= $REQUIRED"
          if [ "$(printf '%s\n' "$REQUIRED" "$CURRENT" | sort -V | head -n1)" != "$REQUIRED" ]; then
            echo "Upgrading npm to latest..."
            npm install -g npm@latest
            echo "Upgraded to: $(npm --version)"
          else
            echo "npm version sufficient"
          fi
    ```

    **주의사항:**
    - deploy 잡에만 추가 (publish-check 잡에는 추가하지 않음 -- dry-run이므로 불필요, 유저 결정)
    - `sort -V`는 Ubuntu 러너(GNU coreutils)에서 사용 가능
    - 업그레이드 실패 시 `set -e` (GitHub Actions 기본)에 의해 잡 전체 실패
    - 기존 들여쓰기(6 spaces for step content)와 포맷 유지
  </action>
  <verify>
    release.yml에서 deploy 잡의 스텝 순서가 올바른지 확인:
    ```bash
    grep -A2 "name:" .github/workflows/release.yml | grep -E "(Checkout|Setup|Build|Ensure npm|Setup npmrc|pnpm publish|Deploy summary)"
    ```
    "Ensure npm >= 11.5.1" 스텝이 "Build" 뒤, "Setup npmrc" 앞에 있는지 확인.
    YAML 문법이 유효한지 확인 (indentation 오류 없음).
  </verify>
  <done>
    release.yml deploy 잡에 npm >= 11.5.1 보장 스텝이 Build 뒤, Setup npmrc 앞에 정확히 삽입되어 있고, YAML 구문 오류가 없다.
  </done>
</task>

</tasks>

<verification>
Phase 188 전체 검증:

1. **PREP-01 검증 (repository.url):**
   - 9개 package.json 모두 `git+https://github.com/minhoyoo-iotrust/WAIaaS.git` URL 사용
   - `minho-yoo/waiaas` 참조가 repository.url에 남아있지 않음

2. **PREP-02 검증 (npm CLI 버전):**
   - release.yml deploy 잡에 "Ensure npm >= 11.5.1" 스텝 존재
   - 스텝이 Build 뒤, publish 관련 스텝 앞에 위치
   - publish-check 잡에는 해당 스텝 없음

3. **PREP-03 검증 (directory 필드):**
   - 루트 package.json에 directory 필드 없음
   - 8개 서브 패키지의 directory 필드가 실제 경로와 일치:
     - core → packages/core
     - daemon → packages/daemon
     - cli → packages/cli
     - sdk → packages/sdk
     - mcp → packages/mcp
     - skills → packages/skills
     - admin → packages/admin
     - adapters/solana → packages/adapters/solana
     - adapters/evm → packages/adapters/evm

4. **포맷팅 검증:**
   - package.json 파일들의 들여쓰기/필드 순서가 repository 필드 외에 변경되지 않음
   - release.yml YAML 문법 유효
</verification>

<success_criteria>
- 9개 package.json 모두 `repository.url`이 `git+https://github.com/minhoyoo-iotrust/WAIaaS.git`
- 루트 package.json에 `repository` 필드가 object 형식으로 존재 (directory 없음)
- 8개 서브 패키지의 `repository.directory`가 실제 경로와 일치
- release.yml deploy 잡에 npm >= 11.5.1 보장 스텝 존재 (Build 뒤, Setup npmrc 앞)
- publish-check 잡은 변경 없음
- `pnpm turbo run lint` 및 `pnpm turbo run typecheck` 통과 (package.json은 JSON 파일이므로 lint 대상 아님, release.yml도 lint 대상 아님 -- 기존 통과 상태 유지 확인)
</success_criteria>

<output>
After completion, create `.planning/phases/188-pre-setup/188-01-SUMMARY.md`
</output>
