---
phase: 154-blockchain-3level
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/adapters/evm/src/__tests__/chain/evm-anvil.chain.test.ts
  - packages/adapters/evm/src/__tests__/chain/helpers/anvil-setup.ts
  - packages/adapters/solana/src/__tests__/chain/solana-devnet.chain.test.ts
autonomous: true
must_haves:
  truths:
    - "Level 2 Anvil EVM E2E가 ETH 전송, ERC-20 전송, gas 추정을 실제 로컬 EVM 노드에서 검증한다"
    - "Level 3 Devnet 3건이 continue-on-error로 실행되며 실패해도 전체 빌드를 중단하지 않는다"
    - "pnpm test:chain --filter @waiaas/adapter-evm으로 EVM chain 테스트가 실행된다"
  artifacts:
    - path: "packages/adapters/evm/src/__tests__/chain/evm-anvil.chain.test.ts"
      provides: "Level 2 Anvil EVM E2E 테스트 (ETH/ERC-20/gas)"
      contains: "ETH transfer, ERC-20 deploy+transfer, gas estimation verification"
    - path: "packages/adapters/evm/src/__tests__/chain/helpers/anvil-setup.ts"
      provides: "Anvil health check + funded account helpers"
      exports: ["isAnvilRunning", "ANVIL_RPC_URL", "ANVIL_FUNDED_PRIVATE_KEY"]
    - path: "packages/adapters/solana/src/__tests__/chain/solana-devnet.chain.test.ts"
      provides: "Level 3 Devnet 3건 (SOL 전송/잔액/헬스 체크)"
      contains: "continue-on-error pattern, devnet airdrop with retry"
  key_links:
    - from: "evm-anvil.chain.test.ts"
      to: "EvmAdapter"
      via: "real connect('http://127.0.0.1:8545')"
      pattern: "adapter\\.connect.*127\\.0\\.0\\.1:8545"
    - from: "solana-devnet.chain.test.ts"
      to: "SolanaAdapter"
      via: "real connect('https://api.devnet.solana.com')"
      pattern: "api\\.devnet\\.solana\\.com"
---

<objective>
Level 2 EVM Anvil 통합 테스트 + Level 3 Solana Devnet 3건 테스트 구현

Purpose: 설계 문서 48의 CHAIN-03 (EVM Anvil), CHAIN-04 (Devnet) 요구사항을 충족하여 EVM 체인의 실제 로컬 노드 검증과 Solana Devnet 네트워크 호환성을 확보한다.
Output: EVM Anvil E2E 테스트 1개 + Anvil 헬퍼 1개 + Devnet 테스트 1개
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.7-quality-cicd.md
@docs/v0.4/48-blockchain-test-environment-strategy.md
@packages/adapters/evm/src/adapter.ts
@packages/adapters/evm/src/__tests__/evm-adapter.test.ts
@packages/adapters/evm/src/abi/erc20.js
@packages/adapters/solana/src/adapter.ts
@packages/core/src/errors/chain-error.ts
@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@.planning/phases/153-contract-test/153-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Level 2 EVM Anvil 통합 테스트 (ETH/ERC-20/gas)</name>
  <files>
    packages/adapters/evm/src/__tests__/chain/helpers/anvil-setup.ts
    packages/adapters/evm/src/__tests__/chain/evm-anvil.chain.test.ts
  </files>
  <action>
    **1) Anvil 셋업 헬퍼** (`helpers/anvil-setup.ts`)

    Anvil (Foundry의 로컬 EVM 노드)이 실행 중인지 확인하고, 테스트용 상수를 제공하는 헬퍼:

    ```typescript
    export const ANVIL_RPC_URL = 'http://127.0.0.1:8545';
    export const ANVIL_CHAIN_ID = 31337;

    // Anvil 기본 funded accounts (10000 ETH each)
    // anvil --accounts 10 기본 설정
    export const ANVIL_FUNDED_PRIVATE_KEY =
      '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';
    export const ANVIL_FUNDED_ADDRESS =
      '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266';

    // 두 번째 계정 (수신용)
    export const ANVIL_SECOND_PRIVATE_KEY =
      '0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d';
    export const ANVIL_SECOND_ADDRESS =
      '0x70997970C51812dc3A010C7d01b50e0d17dc79C8';

    /**
     * Anvil이 실행 중인지 확인 (eth_blockNumber RPC 호출).
     * 실패 시 false 반환 (test.skip에 활용).
     */
    export async function isAnvilRunning(
      rpcUrl = ANVIL_RPC_URL,
      maxWaitMs = 3000,
    ): Promise<boolean>;

    /**
     * 간단한 ERC-20 토큰 컨트랙트를 Anvil에 배포하고 주소를 반환한다.
     * Viem의 deployContract 대신 raw transaction으로 배포하거나,
     * 또는 EvmAdapter를 통하지 않고 viem 직접 사용.
     * 테스트용 SimpleERC20 바이트코드를 하드코딩하거나 solc 컴파일 결과를 사용.
     *
     * NOTE: 가장 실용적인 접근은 viem의 walletClient + testActions를 사용하여
     * 간단한 ERC-20를 배포하는 것. Anvil은 테스트용이므로 복잡한 설정 불필요.
     */
    ```

    - `isAnvilRunning()`: fetch로 JSON-RPC eth_blockNumber 호출, 응답 확인. 실패 시 false.
    - Anvil 기본 계정 0,1 사용 (10000 ETH 사전 할당). 별도 faucet/airdrop 불필요.

    **2) Level 2 EVM Anvil E2E 테스트** (`evm-anvil.chain.test.ts`)

    설계 문서 48 섹션 4 및 objectives의 CHAIN-03 요구사항에 따라 EVM Anvil 통합 테스트를 구현한다.

    **전제 조건:**
    - `beforeAll`에서 `isAnvilRunning()` 호출, false면 전체 describe.skip
    - Anvil은 `anvil` 명령으로 실행 (Foundry 설치 필요)
    - EvmAdapter는 'anvil' 또는 'sepolia' 네트워크로 생성. 실제 EvmAdapter 생성자 시그니처 확인 필요 — `new EvmAdapter(network: NetworkType)` 형태일 것. anvil에 해당하는 적절한 NetworkType을 사용하거나, 'sepolia' 등 테스트넷 타입으로 생성 후 로컬 RPC에 connect.

    **테스트 케이스:**

    ```
    E2E-A1: ETH 전송 전체 흐름 (~5초)
      - EvmAdapter connect(ANVIL_RPC_URL)
      - buildTransaction({ from: ANVIL_FUNDED_ADDRESS, to: ANVIL_SECOND_ADDRESS, amount: 1_000_000_000_000_000_000n }) // 1 ETH
      - simulateTransaction(tx) -> success === true
      - signTransaction(tx, privateKeyBytes) -> Uint8Array, length > 0
      - submitTransaction(signedTx) -> txHash 존재, status === 'submitted'
      - waitForConfirmation(txHash, 30_000) -> status === 'confirmed'
      검증: 수신 계정 잔액 증가, 송신 계정 잔액 감소 (getBalance로 확인)

    E2E-A2: ERC-20 토큰 전송 (~10초)
      접근 방식: viem의 walletClient를 직접 사용하여 간단한 ERC-20 배포 + mint 후,
      EvmAdapter.buildTokenTransfer()로 토큰 전송 테스트.

      Option A (권장): Anvil의 hardhat_setCode 또는 anvil_impersonateAccount + 기존 ERC-20 바이트코드 배포
      Option B: 사전 컴파일된 SimpleERC20 바이트코드 상수를 helpers에 포함

      단계:
      1. viem walletClient로 SimpleERC20 배포 (name, symbol, decimals, mint 함수)
      2. deployer에게 1000 토큰 mint
      3. EvmAdapter.buildTokenTransfer({ from, to, amount: 100n * 10n**decimals, token: { address: deployed, decimals, symbol } })
      4. simulateTransaction -> signTransaction -> submitTransaction -> waitForConfirmation
      검증: 수신 계정의 토큰 잔액이 100 토큰

      NOTE: ERC-20 배포가 복잡하면, 대안으로 Anvil의 `anvil_setStorageAt` RPC로 ERC-20 상태를 직접 주입하거나, 단순히 buildTokenTransfer의 트랜잭션 빌드 + 서명까지만 검증하고 실제 전송은 ETH 전송으로 대체 가능. 실행 시간과 복잡도를 고려하여 판단.

    E2E-A3: Gas 추정 검증 (~3초)
      - estimateFee({ from: ANVIL_FUNDED_ADDRESS, to: ANVIL_SECOND_ADDRESS, amount: 1_000_000_000_000_000n })
      - 검증: fee > 0n, typeof fee === 'bigint'
      - gas safety margin (120/100) 적용 확인: estimatedGas가 21000 근처 (단순 전송)
      - fee = gasLimit * gasPrice 구조인지 또는 FeeEstimate 타입인지 확인
    ```

    **EvmAdapter 생성자 NetworkType 문제:**
    EvmAdapter 생성자는 `new EvmAdapter(network: NetworkType)` 형태. Anvil은 chainId 31337이므로 적절한 NetworkType을 찾아야 한다. adapter.ts를 읽어 connect()에서 chain 설정을 어떻게 하는지 확인한 후 적절한 접근을 사용한다. 'sepolia'로 생성 후 로컬 URL에 connect하면 chainId 불일치가 발생할 수 있으므로 주의. evm-chain-map.ts를 참조하여 적절한 매핑을 사용하거나, 'sepolia' + ANVIL_RPC_URL 조합이 작동하는지 확인.

    **Private Key 형식:**
    EvmAdapter.signTransaction()은 `Uint8Array` 형태의 private key를 받음. Anvil의 hex private key를 32-byte Uint8Array로 변환하여 전달. viem의 hexToBytes 사용.

    **주의사항:**
    - vi.mock('viem') 하지 않음 — 실제 viem 사용
    - Anvil 미실행 시 전체 skip (CI에서 nightly만 실행)
    - 테스트 간 순차 실행 (nonce 충돌 방지)
    - 각 테스트 타임아웃 30초
    - afterAll에서 disconnect
  </action>
  <verify>
    1. `anvil &` 실행 후 `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/adapters/evm/src/__tests__/chain/evm-anvil.chain.test.ts` -- ETH 전송 + ERC-20 + gas 추정 E2E 통과
    2. Anvil 미실행 시 전체 skip (0 tests failed)
    3. `pnpm test:chain --filter @waiaas/adapter-evm` -- Turborepo 태스크 실행 확인
  </verify>
  <done>
    Level 2 Anvil EVM E2E가 ETH 전송 전체 흐름, ERC-20 토큰 전송, gas 추정을 실제 로컬 EVM 노드에서 검증하며, Anvil 미실행 시 graceful skip된다
  </done>
</task>

<task type="auto">
  <name>Task 2: Level 3 Solana Devnet 3건 (continue-on-error)</name>
  <files>
    packages/adapters/solana/src/__tests__/chain/solana-devnet.chain.test.ts
  </files>
  <action>
    설계 문서 48 섹션 3.5의 Devnet 3건 테스트를 구현한다.

    **핵심 원칙: continue-on-error**
    - 모든 테스트가 실패해도 전체 빌드를 중단하지 않는다
    - 네트워크 불안정으로 인한 실패를 허용하되, 실패 사유를 로깅한다
    - CI에서 nightly/release에만 실행, `continue-on-error: true` 설정

    **구현 방식:**
    각 테스트를 try/catch로 래핑하고, 네트워크 에러 시 console.warn 후 test.skip 또는 expect.soft 사용.
    또는 vitest의 `test.fails` / `test.skip` 조건부 패턴 활용.

    가장 깔끔한 접근: `DEVNET_ENABLED` 환경변수 체크 + 전체 describe.skipIf:
    ```typescript
    const DEVNET_ENABLED = process.env.WAIAAS_TEST_DEVNET === 'true';
    describe.skipIf(!DEVNET_ENABLED)('Level 3: Solana Devnet', () => { ... });
    ```

    각 테스트 내부에서도 네트워크 에러 시 graceful 처리:
    ```typescript
    it('SOL 전송 + 확인', async () => {
      try {
        // ... test logic
      } catch (err) {
        if (isNetworkError(err)) {
          console.warn('[Devnet] Network error, skipping:', err.message);
          return; // pass with warning
        }
        throw err; // re-throw non-network errors
      }
    });
    ```

    **3건 테스트:**

    ```
    Devnet-1: SOL 전송 + 확인
      - SolanaAdapter connect('https://api.devnet.solana.com')
      - 새 Ed25519 키페어 생성
      - requestAirdrop 2 SOL (최대 3회 재시도, 2초 간격)
      - buildTransaction({ from, to, amount: 100_000n }) // 0.0001 SOL (최소 금액)
      - simulateTransaction -> signTransaction -> submitTransaction -> waitForConfirmation
      검증: status === 'confirmed' || 'finalized'

    Devnet-2: 잔액 조회
      - Devnet-1에서 사용한 계정의 잔액 조회
      - getBalance(address) -> balance > 0n
      검증: decimals === 9, symbol === 'SOL'

    Devnet-3: 헬스 체크
      - getHealth() -> { healthy: true, latencyMs: number }
      검증: healthy === true, latencyMs > 0 (실제 네트워크 레이턴시)
    ```

    **Airdrop 재시도 로직:**
    ```typescript
    async function airdropWithRetry(
      address: string,
      lamports: bigint,
      maxRetries = 3,
      retryDelayMs = 2000
    ): Promise<void> {
      for (let i = 0; i < maxRetries; i++) {
        try {
          // createSolanaRpc -> requestAirdrop -> send
          // waitForConfirmation (Devnet은 실제 블록 생성 대기 필요)
          return;
        } catch (err) {
          if (i === maxRetries - 1) throw err;
          console.warn(`[Devnet] Airdrop attempt ${i + 1} failed, retrying in ${retryDelayMs}ms...`);
          await new Promise(r => setTimeout(r, retryDelayMs));
        }
      }
    }
    ```

    **네트워크 에러 판별:**
    ```typescript
    function isNetworkError(err: unknown): boolean {
      if (err instanceof Error) {
        const msg = err.message.toLowerCase();
        return msg.includes('timeout') ||
               msg.includes('network') ||
               msg.includes('econnrefused') ||
               msg.includes('rate limit') ||
               msg.includes('429') ||
               msg.includes('503') ||
               msg.includes('airdrop');
      }
      return false;
    }
    ```

    **주의사항:**
    - DEVNET_ENABLED 환경변수 미설정 시 전체 skip (기본 비활성)
    - `--runInBand` 동등 설정: vitest의 `test.sequential` 또는 pool 설정
    - 테스트 타임아웃 60초 (Devnet 레이턴시 고려)
    - Devnet RPC URL: `https://api.devnet.solana.com`
    - afterAll에서 disconnect
    - console.warn으로 네트워크 상태 로깅 (CI 디버깅용)
    - Devnet-1, Devnet-2는 순서 의존 (같은 계정 사용)이므로 sequential 실행 보장
    - Devnet-3 (헬스 체크)는 독립적이므로 선행 가능하나, 단순화를 위해 순차 실행
  </action>
  <verify>
    1. `WAIAAS_TEST_DEVNET=true npx vitest run packages/adapters/solana/src/__tests__/chain/solana-devnet.chain.test.ts --testTimeout=60000` -- 3건 실행 (네트워크 상태에 따라 PASS 또는 graceful skip/warn)
    2. 환경변수 미설정 시 전체 skip 확인: `npx vitest run packages/adapters/solana/src/__tests__/chain/solana-devnet.chain.test.ts` -- 0 tests run (skip)
    3. Devnet 네트워크 에러 시 테스트가 에러를 throw하지 않고 warn 후 통과하거나 skip됨
  </verify>
  <done>
    Level 3 Devnet 3건(SOL 전송/잔액 조회/헬스 체크)이 WAIAAS_TEST_DEVNET=true일 때만 실행되고, 네트워크 에러 시 graceful 처리하여 전체 빌드를 중단하지 않는다
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/adapters/evm/src/__tests__/chain/` -- EVM chain 테스트 실행 (Anvil 실행 시 E2E 통과)
2. `npx vitest run packages/adapters/solana/src/__tests__/chain/solana-devnet.chain.test.ts` -- 환경변수 미설정 시 skip
3. `pnpm test:chain` -- Turborepo 태스크로 전체 chain 테스트 통합 실행
4. Anvil/validator 미실행 + DEVNET 미활성 시 0 failures (모두 graceful skip)
</verification>

<success_criteria>
- Level 2 Anvil EVM E2E가 ETH 전송, ERC-20 전송, gas 추정을 로컬 Anvil 노드에서 검증
- Level 3 Devnet 3건이 환경변수 제어로 활성화되고, 네트워크 에러 시 continue-on-error 동작
- Anvil/Devnet 미가용 시 모든 테스트가 graceful skip (CI 빌드 실패 없음)
- test:chain Turborepo 태스크로 EVM + Solana chain 테스트 통합 실행 가능
</success_criteria>

<output>
After completion, create `.planning/phases/154-blockchain-3level/154-02-SUMMARY.md`
</output>
