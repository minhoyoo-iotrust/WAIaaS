---
phase: 24-higher-abstraction-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/61-price-oracle-spec.md
autonomous: true

must_haves:
  truths:
    - "IPriceOracle 인터페이스가 getPrice/getPrices/getNativePrice/getCacheStats 4개 메서드로 정의되어 있고, CoinGecko/Pyth/Chainlink 3개 구현체의 설계가 포함되어 있다"
    - "5분 TTL 인메모리 캐싱 전략이 명세되어 있고, stale 허용(staleMaxAge 30분) + 외부 API 장애 시 Phase 22-23 과도기 전략 fallback이 설계되어 있다"
    - "기존 네이티브 금액 기준 SPENDING_LIMIT이 USD 기준으로 확장되어 있고, resolveEffectiveAmountUsd()가 5개 TransactionType 모두에 대한 USD 변환 로직을 포함한다"
    - "SpendingLimitRuleSchema에 instant_max_usd/notify_max_usd/delay_max_usd 필드가 추가되어 있고, USD 미설정 시 네이티브 기준 fallback이 명세되어 있다"
    - "가격 조작 공격 방어(다중 소스 교차 검증, +-50% 변동 감지), 오라클 장애 시나리오, 테스트 레벨/Mock 전략이 정의되어 있다"
  artifacts:
    - path: "docs/61-price-oracle-spec.md"
      provides: "CHAIN-EXT-06 가격 오라클 스펙 (IPriceOracle, 캐싱, USD 기준 정책, fallback)"
      contains: "IPriceOracle"
  key_links:
    - from: "docs/61-price-oracle-spec.md"
      to: "docs/33-time-lock-approval-mechanism.md"
      via: "DatabasePolicyEngine.evaluate() Stage 3 resolveEffectiveAmountUsd() 통합"
      pattern: "resolveEffectiveAmountUsd"
    - from: "docs/61-price-oracle-spec.md"
      to: "docs/58-contract-call-spec.md"
      via: "PolicyEvaluationInput.usdAmount 필드, 5개 TransactionType의 USD 변환"
      pattern: "PolicyEvaluationInput"
    - from: "docs/61-price-oracle-spec.md"
      to: "docs/56-token-transfer-extension-spec.md"
      via: "TOKEN_TRANSFER의 0n -> USD 동적 금액 전환, SPENDING_LIMIT 토큰 적용"
      pattern: "TOKEN_TRANSFER.*USD"
---

<objective>
IPriceOracle 인터페이스와 CoinGecko/Pyth/Chainlink 구현체를 설계하고, 5분 TTL 캐싱 + stale fallback 전략을 정의하며, 기존 네이티브 금액 기준 정책 평가를 USD 기준으로 확장하는 가격 오라클 스펙을 작성한다.

Purpose: Phase 22-23에서 TOKEN_TRANSFER=0n, APPROVE=0n으로 과도기 처리한 금액 기반 정책 평가를 해소한다. 토큰 종류와 무관하게 USD 기준으로 동일한 4-tier 분류(INSTANT/NOTIFY/DELAY/APPROVAL)를 적용하여, SPENDING_LIMIT 정책이 모든 자산에 대해 일관되게 작동하도록 한다.
Output: docs/61-price-oracle-spec.md (CHAIN-EXT-06)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/24-higher-abstraction-layer/24-RESEARCH.md

# Phase 22-23 핵심 산출물 (현재 정책 평가 구조 참조)
@docs/58-contract-call-spec.md
@docs/56-token-transfer-extension-spec.md
@docs/59-approve-management-spec.md
@docs/60-batch-transaction-spec.md

# 정책 엔진 + 파이프라인 기반 설계
@docs/33-time-lock-approval-mechanism.md
@docs/32-transaction-pipeline-api.md

# Enum SSoT
@docs/45-enum-unified-mapping.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: IPriceOracle 인터페이스 + 구현체 설계 + 캐싱/fallback 전략</name>
  <files>docs/61-price-oracle-spec.md</files>
  <action>
docs/61-price-oracle-spec.md 파일을 생성한다. 한글로 작성하며, 기존 Phase 22-23 설계 문서(58, 59, 60)의 포맷과 동일한 구조를 따른다. 아래 섹션을 모두 포함해야 한다.

**문서 헤더:**
- 문서 ID: CHAIN-EXT-06
- Phase: 24 (상위 추상화 레이어 설계)
- 참조: 58 (ContractCallRequest), 56 (토큰 전송), 59 (Approve), 60 (배치), 33 (정책 엔진), 32 (파이프라인), 45 (Enum), 24-RESEARCH.md
- 요구사항 매핑: ORACLE-01 ~ ORACLE-04

**섹션 1: 개요**
- 목적: Phase 22-23 과도기(TOKEN_TRANSFER=0n, APPROVE=0n)를 해소하는 USD 기준 정책 평가
- 핵심 설계 원칙: (1) 캐시 없이 외부 API 직접 호출 금지, (2) 단일 소스 의존 금지, (3) USD 변환 실패 시 트랜잭션 거부 금지(fallback), (4) IChainAdapter와 독립(오라클은 서비스 레이어에 위치)

**섹션 2: IPriceOracle 인터페이스 (ORACLE-01)**
- TokenRef Zod 스키마: address, symbol?(fallback), decimals, chain
- PriceInfo Zod 스키마: usdPrice, confidence?, source, fetchedAt, expiresAt, isStale
- 4개 메서드: getPrice(token), getPrices(tokens) 배치, getNativePrice(chain), getCacheStats()
- 에러 타입: PriceNotAvailableError, PriceStaleWarning
- 네이티브 토큰 별도 처리: SOL/ETH는 CoinGecko simple/price 엔드포인트 사용 (token_price가 아닌)
- 24-RESEARCH.md의 코드 예시를 기반으로 하되, 문서 스펙 형태로 정리

**섹션 3: 구현체 설계 (ORACLE-01)**
- CoinGeckoOracle (기본): Demo API 30 calls/min, /simple/token_price/{platformId}, /simple/price for 네이티브, x-cg-demo-api-key 인증, Solana platfomId='solana', EVM platformId='ethereum'
- PythOracle (Solana 대안): Hermes /v2/updates/price/latest, 30 req/10s, Pyth feed ID 매핑 필요, confidence interval 활용
- ChainlinkOracle (EVM 대안): AggregatorV3Interface latestRoundData() 온체인 RPC 읽기, viem readContract, 피드 주소 하드코딩 매핑
- JupiterPriceOracle (Solana DEX 기반, 선택): api.jup.ag/price/v3, API 키 필요
- 구현체별 장단점 비교 표, 기본 조합 권장: CoinGecko(기본) + Pyth(Solana fallback) + Chainlink(EVM fallback)
- OracleChain 패턴: 다중 소스 순차 시도 (Primary -> Fallback1 -> Fallback2 -> stale cache)

**섹션 4: 캐싱 전략 (ORACLE-02)**
- 인메모리 Map<cacheKey, CacheEntry> 구조
- cacheKey: `${chain}:${address}` (네이티브는 `${chain}:native`)
- TTL: 5분 (300,000ms), staleMaxAge: 30분 (1,800,000ms)
- staleWhileRevalidate: true (TTL 만료 후 stale 반환하면서 백그라운드 갱신)
- 캐시 크기 제한: maxEntries 1000 (LRU eviction)
- 배치 조회 최적화: getPrices()에서 캐시 히트 필터 후 미스만 외부 호출
- 캐시 통계: hits, misses, staleHits, size, evictions

**섹션 5: Fallback 전략 (ORACLE-02)**
- 3단계 fallback: (1) Primary 소스 -> (2) Fallback 소스 -> (3) Stale 캐시
- stale 데이터 허용 조건: staleMaxAge(30분) 이내, isStale=true 표시
- stale 데이터 + NOTIFY 강제: stale 가격으로 INSTANT 티어 판정 시 최소 NOTIFY로 상향
- 완전 장애 (모든 소스 실패 + stale 없음): Phase 22-23 과도기 전략으로 fallback -- TOKEN_TRANSFER=NOTIFY, APPROVE=TIER_OVERRIDE, CONTRACT_CALL=APPROVAL, BATCH=개별 정책
- 급격한 가격 변동 감지: 이전 캐시 대비 +-50% 변동 시 PriceSpikeWarning + 보수적 티어 상향

**섹션 6: USD 기준 정책 평가 확장 (ORACLE-03)**
- PolicyEvaluationInput 확장: usdAmount?: number 필드 추가
- resolveEffectiveAmountUsd() 함수: 5개 TransactionType별 USD 변환 로직
  - TRANSFER: nativePrice * amount -> USD
  - TOKEN_TRANSFER: tokenPrice * amount -> USD (Phase 22-23의 0n 해소)
  - CONTRACT_CALL: nativePrice * value -> USD (value가 0이면 0)
  - APPROVE: tokenPrice * approveAmount -> USD 참고값 (TIER_OVERRIDE 우선, 참고용 감사 로그 기록)
  - BATCH: 개별 instruction USD 합산 (일부 실패 시 성공한 것만 합산 + 실패 포함 시 NOTIFY 이상 강제)
- SpendingLimitRuleSchema 확장: instant_max_usd, notify_max_usd, delay_max_usd (optional, 미설정 시 네이티브 기준 사용)
- 평가 우선순위: USD 임계값 설정 시 USD 우선, 미설정 시 네이티브 기준
- evaluateSpendingLimitUsd() 알고리즘: 기존 evaluateSpendingLimit()과 병행, USD 티어와 네이티브 티어 중 더 높은(보수적) 티어 채택
- 기존 33-time-lock-approval-mechanism.md의 DatabasePolicyEngine.evaluate() 11단계에서 Stage 3 확장 지점 명시

**섹션 7: 가격 변동 감지 + 보안 (ORACLE-04)**
- 가격 조작 공격 방어:
  - 다중 소스 교차 검증: CoinGecko 가격과 Pyth/Chainlink 가격의 +-10% 이내 일치 여부 확인
  - 급격한 변동 감지: 이전 캐시 대비 +-50% 변동 시 경고 + 보수적 판단(높은 티어)
  - VWAP 개념 없음 (설계 단순화) -- 5분 TTL 캐시로 순간 조작 완화
- 오라클 장애 대응: 완전 fallback 경로, 헬스체크 엔드포인트(GET /v1/admin/oracle-status)
- 에러 코드: PRICE_NOT_AVAILABLE, PRICE_STALE, PRICE_SPIKE_DETECTED
- 네이티브 토큰 가격 실패: 네이티브 토큰(SOL/ETH)은 안정적 가격 소스가 많으므로 실패 확률 낮음, 그래도 실패 시 네이티브 기준 SPENDING_LIMIT으로 fallback

**섹션 8: 테스트 레벨 / Mock / 보안 시나리오 (ORACLE-04)**
- 단위 테스트: MockPriceOracle(고정 가격 반환), 캐시 TTL 만료 시뮬레이션, stale fallback 검증
- 통합 테스트: CoinGeckoOracle + MockHTTP (nock/msw), rate limit 시뮬레이션, 다중 소스 교차 검증
- 보안 시나리오 (최소 10개):
  - 가격 조작: 급격한 가격 변동 감지 후 보수적 티어 적용
  - 오라클 전체 장애: fallback 경로 동작 확인
  - 캐시 오염: stale 데이터로 장기 운영 시 동작
  - USD 변환 실패 시 과도기 전략 동작
  - 네이티브 토큰 가격 실패 + 토큰 전송 시나리오
  - 무한 루프 방지: fallback 체인에서 순환 참조 없음
  - 0가격 토큰 (스캠/죽은 토큰): usdPrice=0 처리
  - 극단적 가격: BTC $100K+ 또는 밈코인 $0.000001 정밀도
  - 다중 토큰 배치에서 일부만 가격 조회 성공
  - CoinGecko rate limit 도달 시 degradation

**섹션 9: Phase 25 수정 가이드**
- 수정 필요 문서 목록: 33 (정책 엔진에 resolveEffectiveAmountUsd 통합), 32 (파이프라인 Stage 3 확장 지점), 45 (PolicyType에 관련 없으나 PriceSource enum 추가 가능)
- 수정 범위 요약 (상세는 Phase 25에서)

**부록 A: CoinGecko API 레퍼런스**
- /simple/price 엔드포인트 (네이티브 토큰)
- /simple/token_price/{platformId} 엔드포인트 (토큰)
- 인증 헤더, rate limit, 응답 포맷

**부록 B: 기존 문서 변경 영향 분석**
- 각 기존 문서(33, 32, 56, 58, 59, 60)에 미치는 변경 요약

분량: ~1500-2000줄 목표. 24-RESEARCH.md의 코드 예시와 아키텍처 다이어그램을 설계 스펙 수준으로 정제하여 포함한다. TypeScript 인터페이스/타입 정의는 설계 문서이므로 구현 참조용 의사코드로 작성한다.
  </action>
  <verify>
1. docs/61-price-oracle-spec.md 파일이 존재하고 1200줄 이상이다
2. ORACLE-01 ~ ORACLE-04 4개 요구사항이 모두 섹션에 매핑되어 있다 (요구사항 매핑 표 확인)
3. IPriceOracle 인터페이스에 getPrice/getPrices/getNativePrice/getCacheStats 4개 메서드가 정의되어 있다
4. TokenRef, PriceInfo Zod 스키마가 정의되어 있다
5. CoinGecko/Pyth/Chainlink 3개 구현체 설계가 포함되어 있다
6. 5분 TTL + staleMaxAge 30분 캐싱 전략이 명세되어 있다
7. resolveEffectiveAmountUsd()에서 5개 TransactionType(TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH) 모두의 USD 변환 로직이 포함되어 있다
8. SpendingLimitRuleSchema에 instant_max_usd/notify_max_usd/delay_max_usd 필드가 추가되어 있다
9. 보안 시나리오가 10개 이상 정의되어 있다
10. Phase 22-23 과도기 전략 fallback이 명시되어 있다
  </verify>
  <done>
IPriceOracle 인터페이스가 4개 메서드와 3개 구현체로 설계되어 있고, 5분 TTL 캐싱 + stale 30분 fallback이 명세되어 있으며, USD 기준 정책 평가(resolveEffectiveAmountUsd + SpendingLimitRuleSchema USD 확장)가 5개 TransactionType 모두에 대해 설계되어 있고, 보안 시나리오 10개 이상이 정의되어 있다
  </done>
</task>

</tasks>

<verification>
1. docs/61-price-oracle-spec.md가 존재하고 CHAIN-EXT-06 문서 ID를 포함한다
2. ORACLE-01 ~ ORACLE-04 요구사항이 모두 커버되어 있다:
   - ORACLE-01: IPriceOracle 인터페이스 + CoinGecko/Pyth/Chainlink 구현 옵션 + PriceInfo 스키마
   - ORACLE-02: 5분 TTL 캐싱 + stale 허용/거부 fallback 전략
   - ORACLE-03: USD 기준 정책 평가 확장 (resolveEffectiveAmountUsd + SpendingLimitRuleSchema)
   - ORACLE-04: 테스트 레벨/Mock/보안 시나리오 (가격 조작, 오라클 장애 등)
3. 기존 Phase 22-23 설계(58, 56, 59, 60)와의 일관성 확인: TransactionType 5개, PolicyType 10개 참조 일치
4. 기존 정책 엔진(33-time-lock)의 evaluate() 11단계와 통합 지점이 명시되어 있다
</verification>

<success_criteria>
- IPriceOracle 인터페이스가 CoinGecko/Pyth/Chainlink 구현 옵션과 함께 정의되어 있고, 5분 TTL 캐싱 + stale 허용/거부 fallback 전략이 명세되어 있다
- 기존 네이티브 금액 기준 정책 평가가 USD 금액 기준으로 확장되어 있고, 토큰 종류 무관하게 동일한 티어 분류가 적용된다
- 가격 조작 공격 방어, 오라클 장애 대응, 테스트 시나리오가 포함되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/24-higher-abstraction-layer/24-01-SUMMARY.md`
</output>
