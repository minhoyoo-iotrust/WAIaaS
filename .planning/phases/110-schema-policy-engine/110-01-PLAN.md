---
phase: 110-schema-policy-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/enums/policy.ts
  - packages/core/src/schemas/wallet.schema.ts
  - packages/core/src/schemas/transaction.schema.ts
  - packages/core/src/schemas/policy.schema.ts
  - packages/core/src/schemas/index.ts
  - packages/core/src/interfaces/IPolicyEngine.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/wallets.ts
  - packages/daemon/src/api/routes/policies.ts
autonomous: true

must_haves:
  truths:
    - "CreateWalletRequestSchema에 environment 파라미터(testnet/mainnet)가 있고, network가 제거되었다"
    - "TransactionRequestSchema 5-type(TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH) 모두 network optional 파라미터를 수용한다"
    - "POLICY_TYPES SSoT 배열에 ALLOWED_NETWORKS가 11번째로 포함되어 있다"
    - "AllowedNetworksRulesSchema가 정의되어 POLICY_RULES_SCHEMAS 맵에 등록되어 있다"
    - "CreatePolicyRequestSchema에 network optional 파라미터가 있다"
    - "WalletSchema에 environment + defaultNetwork 필드가 있고, network 필드가 없다"
    - "IPolicyEngine.evaluate()의 transaction 파라미터에 network? 필드가 있다"
  artifacts:
    - path: "packages/core/src/enums/policy.ts"
      provides: "ALLOWED_NETWORKS in POLICY_TYPES"
      contains: "ALLOWED_NETWORKS"
    - path: "packages/core/src/schemas/wallet.schema.ts"
      provides: "WalletSchema with environment + defaultNetwork"
      contains: "environment"
    - path: "packages/core/src/schemas/transaction.schema.ts"
      provides: "5-type schemas with network optional"
      contains: "NetworkTypeEnum"
    - path: "packages/core/src/schemas/policy.schema.ts"
      provides: "AllowedNetworksRulesSchema + CreatePolicyRequest.network"
      contains: "AllowedNetworksRulesSchema"
  key_links:
    - from: "packages/core/src/schemas/policy.schema.ts"
      to: "packages/core/src/enums/policy.ts"
      via: "PolicyTypeEnum includes ALLOWED_NETWORKS"
      pattern: "ALLOWED_NETWORKS"
    - from: "packages/core/src/schemas/wallet.schema.ts"
      to: "packages/core/src/enums/chain.ts"
      via: "EnvironmentTypeEnum import"
      pattern: "EnvironmentTypeEnum"
    - from: "packages/daemon/src/api/routes/wallets.ts"
      to: "packages/core/src/schemas/wallet.schema.ts"
      via: "CreateWalletRequestSchema.environment -> wallets.environment INSERT"
      pattern: "environment"
---

<objective>
Wallet/Transaction/Policy Zod 스키마를 환경 모델로 전환하고, ALLOWED_NETWORKS PolicyType SSoT를 추가한다.

Purpose: Phase 109에서 DB 레이어가 환경 모델로 전환되었으므로, Zod 스키마 레이어를 DB와 일치시키고 ALLOWED_NETWORKS 11번째 PolicyType의 Zod 정의를 확립한다. 이를 통해 API 요청/응답이 environment/network 파라미터를 수용할 수 있는 기반이 만들어진다.

Output: 7개 소스 파일 수정, 빌드 통과, 기존 테스트 회귀 없음
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/109-db-migration-environment-ssot/109-01-SUMMARY.md
@.planning/phases/109-db-migration-environment-ssot/109-02-SUMMARY.md

# Design reference for ALLOWED_NETWORKS rules schema + policy scope
@docs/71-policy-engine-network-extension-design.md (sections 2.1-2.3, 3.2)

# Current source files to modify
@packages/core/src/enums/policy.ts
@packages/core/src/schemas/wallet.schema.ts
@packages/core/src/schemas/transaction.schema.ts
@packages/core/src/schemas/policy.schema.ts
@packages/core/src/schemas/index.ts
@packages/core/src/interfaces/IPolicyEngine.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/routes/wallets.ts
@packages/daemon/src/api/routes/policies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zod 스키마 환경 모델 전환 + ALLOWED_NETWORKS PolicyType SSoT</name>
  <files>
    packages/core/src/enums/policy.ts
    packages/core/src/schemas/wallet.schema.ts
    packages/core/src/schemas/transaction.schema.ts
    packages/core/src/schemas/policy.schema.ts
    packages/core/src/schemas/index.ts
    packages/core/src/interfaces/IPolicyEngine.ts
  </files>
  <action>
**1. POLICY_TYPES SSoT 확장 (policy.ts)**

`packages/core/src/enums/policy.ts`의 POLICY_TYPES 배열에 `'ALLOWED_NETWORKS'`를 11번째 항목으로 추가:

```typescript
export const POLICY_TYPES = [
  'SPENDING_LIMIT',
  'WHITELIST',
  'TIME_RESTRICTION',
  'RATE_LIMIT',
  'ALLOWED_TOKENS',
  'CONTRACT_WHITELIST',
  'METHOD_WHITELIST',
  'APPROVED_SPENDERS',
  'APPROVE_AMOUNT_LIMIT',
  'APPROVE_TIER_OVERRIDE',
  'ALLOWED_NETWORKS',
] as const;
```

자동 파생: PolicyType union, PolicyTypeEnum Zod enum, DB CHECK 제약 모두 SSoT에서 파생되므로 추가 변경 불필요.

**2. WalletSchema 환경 모델 전환 (wallet.schema.ts)**

- `WalletSchema`: `network: NetworkTypeEnum` 제거, `environment: EnvironmentTypeEnum` + `defaultNetwork: NetworkTypeEnum.nullable()` 추가
- `CreateWalletRequestSchema`: `network` 제거, `environment: EnvironmentTypeEnum.default('testnet')` 추가
- import에 `EnvironmentTypeEnum` 추가 (from `../enums/index.js`)

변경 후 WalletSchema:
```typescript
export const WalletSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1).max(100),
  chain: ChainTypeEnum,
  environment: EnvironmentTypeEnum,
  defaultNetwork: NetworkTypeEnum.nullable(),
  publicKey: z.string(),
  status: WalletStatusEnum,
  ownerAddress: z.string().nullable(),
  ownerVerified: z.boolean(),
  createdAt: z.number().int(),
  updatedAt: z.number().int(),
});

export const CreateWalletRequestSchema = z.object({
  name: z.string().min(1).max(100),
  chain: ChainTypeEnum.default('solana'),
  environment: EnvironmentTypeEnum.default('testnet'),
});
```

**3. TransactionRequestSchema 5-type network 파라미터 (transaction.schema.ts)**

각 5-type 스키마에 `network: NetworkTypeEnum.optional()` 필드를 추가:
- `TransferRequestSchema`: `network` 추가
- `TokenTransferRequestSchema`: `network` 추가
- `ContractCallRequestSchema`: `network` 추가
- `ApproveRequestSchema`: `network` 추가
- `BatchRequestSchema`: `network` 추가 (batch 레벨에서 네트워크 지정, 개별 instruction은 동일 네트워크)

import에 `NetworkTypeEnum` 추가 (from `../enums/chain.js`).

TransactionSchema에도 `network: NetworkTypeEnum.nullable()` 추가 (DB 조회 결과 매핑용).

기존 SendTransactionRequestSchema는 하위호환을 위해 변경하지 않음.

**4. AllowedNetworksRulesSchema + CreatePolicyRequest.network (policy.schema.ts)**

docs/71 섹션 2.1 설계 기반:

```typescript
import { NetworkTypeEnum } from '../enums/chain.js';

/** ALLOWED_NETWORKS: rules.networks array (permitted networks for wallet). */
const AllowedNetworksRulesSchema = z.object({
  networks: z.array(z.object({
    network: NetworkTypeEnum,
    name: z.string().optional(),
  })).min(1, 'At least one network required'),
});
```

POLICY_RULES_SCHEMAS 맵에 `ALLOWED_NETWORKS: AllowedNetworksRulesSchema` 추가.

CreatePolicyRequestSchema에 `network: NetworkTypeEnum.optional()` 필드 추가 (superRefine 이전).

PolicySchema에도 `network: NetworkTypeEnum.nullable()` 추가 (응답 스키마용).

**5. IPolicyEngine.evaluate() 시그니처 확장 (IPolicyEngine.ts)**

transaction 파라미터에 `network?: string` 추가:

```typescript
evaluate(
  walletId: string,
  transaction: {
    type: string;
    amount: string;
    toAddress: string;
    chain: string;
    network?: string;  // NEW: for ALLOWED_NETWORKS + network scoping
  },
): Promise<PolicyEvaluation>;
```

optional이므로 기존 호출부는 타입 에러 없이 동작.

**6. schemas/index.ts 업데이트**

새로 export되는 타입이 있으면 barrel re-export 추가. AllowedNetworksRulesSchema는 internal(const)이므로 export 불필요. CreateWalletRequest, Wallet 타입은 이미 export 중이므로 변경 없음.
  </action>
  <verify>
1. `cd packages/core && pnpm build` 성공 (타입 에러 없음)
2. `cd packages/daemon && pnpm build` 성공 (wallet.schema.ts 변경이 import하는 모든 파일에 반영)
3. `grep -r 'ALLOWED_NETWORKS' packages/core/src/enums/policy.ts` 확인
4. `grep 'environment' packages/core/src/schemas/wallet.schema.ts` 확인
  </verify>
  <done>
- POLICY_TYPES에 ALLOWED_NETWORKS 11번째 항목 포함
- WalletSchema에 environment + defaultNetwork 필드 존재, network 필드 제거
- CreateWalletRequestSchema에 environment 파라미터 존재 (default: testnet)
- 5-type TransactionRequestSchema 모두 network optional 파라미터 포함
- AllowedNetworksRulesSchema 정의 + POLICY_RULES_SCHEMAS 등록 완료
- CreatePolicyRequestSchema에 network optional 파라미터 포함
- PolicySchema에 network nullable 필드 포함
- IPolicyEngine.evaluate() transaction에 network? 필드 포함
- 빌드 통과
  </done>
</task>

<task type="auto">
  <name>Task 2: Route 레이어 environment/network 적용 + 빌드/테스트 회귀 확인</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/wallets.ts
    packages/daemon/src/api/routes/policies.ts
  </files>
  <action>
**1. wallets.ts CREATE 라우트 environment 전환**

POST /wallets 핸들러를 environment 기반으로 변환:

- `parsed.network` 대신 `parsed.environment`를 읽어 월렛 생성
- `getDefaultNetwork(chain, environment)`로 defaultNetwork 결정
- `validateChainNetwork` 대신 `validateNetworkEnvironment`를 사용할 필요는 없음 -- environment에서 defaultNetwork는 항상 유효하므로 검증 불필요
- INSERT에서 `environment: parsed.environment`, `defaultNetwork: getDefaultNetwork(chain, parsed.environment)` 사용
- 기존 `deriveEnvironment(network)` 호출을 제거하고 직접 `parsed.environment` 사용
- import 변경: `getDefaultNetwork` 추가, `deriveEnvironment` 유지 (다른 곳에서 사용 가능)

응답에서 `network` -> `defaultNetwork` 매핑 (하위호환: API 응답은 아직 `network` 필드로 반환, 값은 defaultNetwork).

GET /wallets 리스트와 GET /wallets/:id 디테일 응답도 동일 패턴 유지 (`network: wallet.defaultNetwork!`는 이미 Phase 109에서 변경됨).

**2. policies.ts CREATE 라우트 network 파라미터**

POST /policies 핸들러에서 `parsed.network` (새 필드)를 DB INSERT에 전달:

```typescript
deps.db.insert(policies).values({
  id,
  walletId: parsed.walletId ?? null,
  type: parsed.type,
  rules: JSON.stringify(parsed.rules),
  priority: parsed.priority,
  enabled: parsed.enabled,
  network: parsed.network ?? null,  // NEW
  createdAt: now,
  updatedAt: now,
}).run();
```

응답에도 `network` 필드 추가:
```typescript
return c.json({
  id,
  walletId: parsed.walletId ?? null,
  type: parsed.type,
  rules: parsed.rules,
  priority: parsed.priority,
  enabled: parsed.enabled,
  network: parsed.network ?? null,  // NEW
  createdAt: nowSec,
  updatedAt: nowSec,
}, 201);
```

GET /policies 리스트 응답에도 `network: row.network` 추가.

PUT /policies/:id 응답에도 `network: updated.network` 추가.

**3. openapi-schemas.ts 응답 스키마에 network/environment 추가**

- `PolicyResponseSchema`에 `network: z.string().nullable()` 추가
- `WalletCrudResponseSchema`, `WalletDetailResponseSchema`, `WalletOwnerResponseSchema`에 `environment: z.string()` 추가 (network 필드는 하위호환으로 유지)
- `WalletDetailResponseSchema`에 `defaultNetwork: z.string().nullable()` 추가

**4. 빌드 + 테스트 회귀 확인**

- `pnpm build` 전체 모노레포 빌드
- 빌드 실패 시 타입 에러 수정 (wallet.schema.ts 변경으로 Wallet 타입이 달라져서 다른 파일에서 `.network` 참조가 타입 에러를 발생시킬 수 있음 -- 이미 Phase 109에서 `.defaultNetwork!`로 변환했으므로 영향 최소)
- `pnpm test` 전체 테스트 실행
- 실패 테스트가 있으면 스키마 변경에 맞게 수정 (CreateWalletRequest를 사용하는 테스트가 `network` 대신 `environment`를 보내야 할 수 있음)
  </action>
  <verify>
1. `pnpm build` 전체 모노레포 빌드 성공
2. `pnpm test` 전체 테스트 통과 (또는 기존 실패만 유지)
3. `grep 'environment' packages/daemon/src/api/routes/wallets.ts` -- environment 기반 월렛 생성 확인
4. `grep 'network.*parsed' packages/daemon/src/api/routes/policies.ts` -- network 파라미터 INSERT 확인
  </verify>
  <done>
- POST /wallets가 environment 파라미터로 월렛 생성 (기존 network 파라미터 제거)
- POST /policies가 network 파라미터를 DB에 저장
- GET /policies 응답에 network 필드 포함
- OpenAPI 응답 스키마에 environment/network 필드 반영
- 전체 빌드 통과
- 기존 테스트 회귀 없음 (또는 스키마 변경에 맞게 수정)
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` -- 전체 모노레포 빌드 통과
2. `pnpm test` -- 기존 테스트 회귀 없음 (pre-existing failures만 유지)
3. POLICY_TYPES SSoT에 ALLOWED_NETWORKS 포함 확인
4. WalletSchema에 environment + defaultNetwork 존재, network 제거 확인
5. 5-type TransactionRequestSchema에 network optional 확인
6. AllowedNetworksRulesSchema가 POLICY_RULES_SCHEMAS에 등록 확인
7. CreatePolicyRequestSchema에 network optional 확인
8. POST /wallets 핸들러가 environment 기반으로 동작 확인
9. POST /policies 핸들러가 network 파라미터를 INSERT 확인
</verification>

<success_criteria>
- Zod 스키마가 DB 스키마(Phase 109)와 완전히 일치
- ALLOWED_NETWORKS PolicyType SSoT 확립
- API 라우트가 새 스키마를 사용하여 environment/network 파라미터를 처리
- 전체 빌드 + 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/110-schema-policy-engine/110-01-SUMMARY.md`
</output>
