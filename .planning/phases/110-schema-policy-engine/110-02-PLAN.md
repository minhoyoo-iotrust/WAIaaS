---
phase: 110-schema-policy-engine
plan: 02
type: tdd
wave: 2
depends_on: ["110-01"]
files_modified:
  - packages/daemon/src/pipeline/database-policy-engine.ts
  - packages/daemon/src/__tests__/allowed-networks-policy.test.ts
autonomous: true

must_haves:
  truths:
    - "ALLOWED_NETWORKS 정책이 없으면 모든 네트워크에서 트랜잭션이 통과한다 (permissive default)"
    - "ALLOWED_NETWORKS 정책이 있을 때 목록에 없는 네트워크의 트랜잭션이 POLICY_VIOLATION으로 거부된다"
    - "네트워크 스코프 정책이 4단계 override 우선순위(wallet+network > wallet+null > global+network > global+null)로 평가된다"
    - "기존 network=NULL 정책만 있을 때 4단계 resolveOverrides가 기존 2단계와 동일한 결과를 반환한다 (하위호환)"
    - "evaluateAndReserve() raw SQL에 network 필터가 추가되어 네트워크 스코프 정책이 정확히 로드된다"
  artifacts:
    - path: "packages/daemon/src/pipeline/database-policy-engine.ts"
      provides: "evaluateAllowedNetworks + 4-level resolveOverrides + evaluateAndReserve network filter"
      contains: "evaluateAllowedNetworks"
    - path: "packages/daemon/src/__tests__/allowed-networks-policy.test.ts"
      provides: "ALLOWED_NETWORKS + 4-level override + backward compat tests"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "packages/core/src/enums/policy.ts"
      via: "ALLOWED_NETWORKS policy type evaluation"
      pattern: "ALLOWED_NETWORKS"
    - from: "packages/daemon/src/pipeline/database-policy-engine.ts"
      to: "evaluateAndReserve raw SQL"
      via: "AND (network = ? OR network IS NULL) filter"
      pattern: "network.*IS NULL"
---

<objective>
ALLOWED_NETWORKS 정책 평가 로직 + 4단계 override resolveOverrides() + evaluateAndReserve() network 필터를 TDD로 구현한다.

Purpose: Phase 110의 핵심 비즈니스 로직. 네트워크 단위 정책 평가와 4단계 우선순위 override를 통해 "특정 네트워크만 허용/차단"하는 정책 기능을 확립한다.

Output: evaluateAllowedNetworks() + 4-level resolveOverrides() + evaluateAndReserve() network SQL 구현, 20+ 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/110-schema-policy-engine/110-01-SUMMARY.md

# Design reference -- docs/71 sections 2.4-2.6, 3.3-3.4, 4.1-4.5
@docs/71-policy-engine-network-extension-design.md

# Current source file to modify
@packages/daemon/src/pipeline/database-policy-engine.ts

# Test patterns from existing policy engine tests
@packages/daemon/src/__tests__/policy-engine.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- ALLOWED_NETWORKS + 4-level override + evaluateAndReserve network 테스트</name>
  <files>packages/daemon/src/__tests__/allowed-networks-policy.test.ts</files>
  <action>
`packages/daemon/src/__tests__/allowed-networks-policy.test.ts` 파일을 생성하여 다음 테스트를 작성한다.

기존 `policy-engine.test.ts`의 테스트 패턴(in-memory SQLite + Drizzle + 직접 INSERT)을 따른다.

**테스트 그룹 1: evaluateAllowedNetworks (5개)**

| # | 테스트 | 기대 결과 |
|---|--------|---------|
| 1 | ALLOWED_NETWORKS 정책 미설정 + 임의 network='polygon-amoy' | allowed=true, tier='INSTANT' (permissive default) |
| 2 | ALLOWED_NETWORKS 설정 ['ethereum-sepolia', 'polygon-amoy'] + network='polygon-amoy' | allowed=true (목록에 있음) |
| 3 | ALLOWED_NETWORKS 설정 ['ethereum-sepolia'] + network='polygon-amoy' | allowed=false, reason에 'not in allowed networks' 포함 |
| 4 | ALLOWED_NETWORKS + network 미전달 (undefined) | allowed=true (network 없으면 검사 skip) |
| 5 | ALLOWED_NETWORKS 평가가 모든 5-type에서 동작 | TRANSFER, TOKEN_TRANSFER(+ALLOWED_TOKENS), CONTRACT_CALL(+CONTRACT_WHITELIST), APPROVE(+APPROVED_SPENDERS) 모두에서 네트워크 차단 시 denied |

**테스트 그룹 2: resolveOverrides 4단계 (6개)**

| # | 테스트 | 기대 결과 |
|---|--------|---------|
| 1 | 기존 정책만 (모든 network=NULL) | 기존 2단계와 동일 (wallet > global) |
| 2 | wallet+network(P4) > wallet+null(P2) | P4 적용 |
| 3 | global+network(P3) > global+null(P1) | P3 적용 |
| 4 | wallet+null(P2) > global+network(P3) | P2 적용 (2순위가 3순위보다 높음) |
| 5 | 4단계 모두 존재 시 wallet+network(1순위) 선택 | P4 적용 |
| 6 | 1순위 없을 때 2순위(wallet+null) fallback | P2 적용 |

SPENDING_LIMIT 정책으로 테스트 (instant_max 값이 다른 4개 정책을 INSERT하고, evaluate 결과 tier로 어떤 정책이 적용되었는지 판별).

**테스트 그룹 3: evaluateAndReserve network SQL (3개)**

| # | 테스트 | 기대 결과 |
|---|--------|---------|
| 1 | network 파라미터 있을 때 해당 network 정책 + NULL 정책 모두 로드 | 4단계 override 결과 적용 |
| 2 | network 파라미터 없을 때 (기존 동작) | network=NULL 정책만 로드 + 기존과 동일한 결과 |
| 3 | evaluateAndReserve에서 ALLOWED_NETWORKS 거부 시 reserved_amount 미설정 | allowed=false 반환, 트랜잭션 reserved_amount NULL |

**테스트 그룹 4: evaluateBatch network (2개)**

| # | 테스트 | 기대 결과 |
|---|--------|---------|
| 1 | BATCH에서 ALLOWED_NETWORKS 차단 시 전체 배치 거부 | allowed=false |
| 2 | BATCH에서 네트워크 허용 시 기존 로직 동작 | Phase A/B 정상 |

총 16+ 테스트. 모든 테스트는 FAIL해야 함 (evaluateAllowedNetworks, 4-level resolveOverrides, network SQL 미구현 상태).

테스트 파일에서 DB 셋업: `pushSchema()`로 최신 스키마 적용 -> 테스트 월렛/정책/트랜잭션 INSERT.

**주의:**
- PolicyRow 인터페이스에 `network` 필드가 아직 없으므로, 테스트에서 raw SQL INSERT로 `network` 컬럼에 값 직접 삽입
- evaluate() 호출 시 `transaction.network` 필드 전달
- evaluateAndReserve() 호출 시 `transaction.network` 필드 전달
  </action>
  <verify>
1. `pnpm --filter @waiaas/daemon test -- --testPathPattern=allowed-networks-policy` 실행
2. 새 테스트 16개 이상이 FAIL (RED 상태)
3. 기존 테스트는 영향 없음
  </verify>
  <done>
- 16+ 테스트가 작성되어 있고, 모두 FAIL (RED 상태)
- ALLOWED_NETWORKS permissive default, 네트워크 차단, 5-type 평가 테스트 존재
- 4단계 override 우선순위 6개 테스트 존재
- evaluateAndReserve network SQL 3개 테스트 존재
- evaluateBatch network 2개 테스트 존재
  </done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- evaluateAllowedNetworks + 4-level resolveOverrides + evaluateAndReserve SQL 구현</name>
  <files>packages/daemon/src/pipeline/database-policy-engine.ts</files>
  <action>
`packages/daemon/src/pipeline/database-policy-engine.ts`를 수정하여 모든 테스트를 통과시킨다.

**1. PolicyRow 인터페이스 확장**

```typescript
interface PolicyRow {
  id: string;
  walletId: string | null;
  type: string;
  rules: string;
  priority: number;
  enabled: boolean | null;
  network: string | null;  // NEW: nullable (NULL = all networks)
}
```

**2. TransactionParam에 network 추가**

```typescript
interface TransactionParam {
  type: string;
  amount: string;
  toAddress: string;
  chain: string;
  network?: string;  // NEW: resolvedNetwork for ALLOWED_NETWORKS + network scoping
  tokenAddress?: string;
  contractAddress?: string;
  selector?: string;
  spenderAddress?: string;
  approveAmount?: string;
}
```

**3. AllowedNetworksRules 인터페이스 추가**

```typescript
interface AllowedNetworksRules {
  networks: Array<{ network: string; name?: string }>;
}
```

**4. evaluateAllowedNetworks() 구현** (docs/71 섹션 2.4 의사코드 기반)

- 모든 5-type에 적용 (TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH)
- ALLOWED_NETWORKS 정책 미설정 시 null 반환 (permissive default)
- 정책 설정 시 resolvedNetwork가 rules.networks[].network에 있는지 case-insensitive 비교
- 없으면 `{ allowed: false, tier: 'INSTANT', reason: "Network '...' not in allowed networks list. Allowed: ..." }`

**5. resolveOverrides() 4단계 확장** (docs/71 섹션 3.4 의사코드 기반)

기존 2단계 resolveOverrides를 4단계로 확장. 시그니처 변경:

```typescript
private resolveOverrides(
  rows: PolicyRow[],
  walletId: string,
  resolvedNetwork?: string,
): PolicyRow[]
```

4단계 순서 (낮은 우선순위부터 삽입, 높은 우선순위가 덮어씀):
1. global + all-networks (walletId=NULL, network=NULL)
2. global + network-specific (walletId=NULL, network=resolvedNetwork)
3. wallet + all-networks (walletId=W, network=NULL)
4. wallet + network-specific (walletId=W, network=resolvedNetwork)

typeMap[type] 단일 키 유지 (복합키 사용하지 않음 -- PLCY-D03).

**6. evaluate() 메서드 변경**

- resolveOverrides 호출에 `transaction.network` 전달
- Step 4 (WHITELIST) 직후 Step 4a.5로 ALLOWED_NETWORKS 평가 추가:
  ```typescript
  if (transaction.network) {
    const allowedNetworksResult = this.evaluateAllowedNetworks(resolved, transaction.network);
    if (allowedNetworksResult !== null) return allowedNetworksResult;
  }
  ```
- Drizzle SELECT에서 policies.network 컬럼도 조회되도록 확인 (이미 schema.ts에 있으므로 자동)

**7. evaluateAndReserve() raw SQL 변경** (docs/71 섹션 4.4)

SELECT에 `network` 컬럼 추가:
```sql
SELECT id, wallet_id AS walletId, type, rules, priority, enabled, network
FROM policies
WHERE (wallet_id = ? OR wallet_id IS NULL)
  AND (network = ? OR network IS NULL)
  AND enabled = 1
ORDER BY priority DESC
```

바인딩: `[walletId, transaction.network ?? null]`

resolveOverrides 호출에 `transaction.network` 전달.

WHITELIST 직후 ALLOWED_NETWORKS 평가 추가 (evaluate()와 동일 패턴).

**8. evaluateBatch() 변경** (docs/71 섹션 4.5)

- policies SELECT에 network 필터 추가 (OR 조건으로 Drizzle where)
- resolveOverrides 호출에 `instructions[0]?.network` 전달
- Phase A 전에 ALLOWED_NETWORKS 평가 추가

**9. evaluateInstructionPolicies()에 ALLOWED_NETWORKS 평가 추가 (선택적)**

BATCH의 Phase A에서 개별 instruction 평가 시 ALLOWED_NETWORKS는 이미 batch 레벨에서 평가되므로 instruction 레벨에서는 skip 가능. 하지만 일관성을 위해 추가해도 무방 -- 결과에 영향 없음 (이미 통과한 상태).

**주의사항:**
- evaluate()의 Drizzle SELECT에 network 필터를 추가해야 함. 현재는 `or(eq(policies.walletId, walletId), isNull(policies.walletId))` 조건만 있는데, `and(..., or(resolvedNetwork ? eq(policies.network, resolvedNetwork) : isNull(policies.network), isNull(policies.network)))` 형태로 확장
- 하지만 evaluate()에서는 모든 정책을 로드한 후 resolveOverrides에서 필터링하는 것이 더 안전 (evaluate는 이미 ORM을 쓰므로 SQL 최적화보다 정확성 우선). evaluateAndReserve()만 raw SQL 필터 필수.
- 최종적으로 evaluate()의 Drizzle WHERE도 network 필터 추가하면 불필요한 행 로드를 줄일 수 있지만, resolveOverrides()가 이미 필터링하므로 선택적. 성능보다 정확성.
  </action>
  <verify>
1. `pnpm --filter @waiaas/daemon test -- --testPathPattern=allowed-networks-policy` -- 모든 테스트 PASS (GREEN)
2. `pnpm --filter @waiaas/daemon test -- --testPathPattern=policy-engine` -- 기존 정책 엔진 테스트 회귀 없음
3. `pnpm test` -- 전체 테스트 통과
4. `pnpm build` -- 전체 빌드 통과
  </verify>
  <done>
- evaluateAllowedNetworks() 구현: permissive default, 네트워크 차단, case-insensitive 비교
- resolveOverrides() 4단계 구현: wallet+network > wallet+null > global+network > global+null
- evaluate() Step 4a.5에서 ALLOWED_NETWORKS 평가
- evaluateAndReserve() raw SQL에 `AND (network = ? OR network IS NULL)` 필터
- evaluateBatch() network 필터 + ALLOWED_NETWORKS 평가
- PolicyRow.network 필드 추가
- TransactionParam.network 필드 추가
- 모든 테스트 PASS, 기존 테스트 회귀 없음
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` -- 전체 모노레포 빌드 통과
2. `pnpm test` -- 전체 테스트 통과 (pre-existing failures만 유지)
3. ALLOWED_NETWORKS permissive default 동작 확인 (테스트)
4. 4단계 override 우선순위 동작 확인 (테스트)
5. evaluateAndReserve network SQL 필터 동작 확인 (테스트)
6. 기존 policy-engine.test.ts 회귀 없음 확인
7. evaluateBatch network 동작 확인
</verification>

<success_criteria>
- ALLOWED_NETWORKS 정책으로 특정 네트워크만 허용/차단 가능
- 네트워크 스코프 정책이 4단계 우선순위로 정확히 평가
- evaluateAndReserve TOCTOU-safe 경로에서도 네트워크 필터 동작
- 16+ 신규 테스트 + 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/110-schema-policy-engine/110-02-SUMMARY.md`
</output>
