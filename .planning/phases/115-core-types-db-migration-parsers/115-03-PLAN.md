---
phase: 115-core-types-db-migration-parsers
plan: 03
type: tdd
wave: 2
depends_on: ["115-01"]
files_modified:
  - packages/adapters/evm/src/tx-parser.ts
  - packages/adapters/evm/src/adapter.ts
  - packages/adapters/evm/src/index.ts
  - packages/adapters/evm/src/__tests__/evm-sign-only.test.ts
autonomous: true

must_haves:
  truths:
    - "EvmAdapter.parseTransaction()이 hex unsigned tx를 받아 ParsedTransaction으로 변환한다"
    - "ETH transfer (no calldata)가 NATIVE_TRANSFER로 식별되고 to/amount가 추출된다"
    - "ERC-20 transfer(address,uint256) 호출이 TOKEN_TRANSFER로 식별된다"
    - "ERC-20 approve(address,uint256) 호출이 APPROVE로 식별된다"
    - "임의 contract call이 CONTRACT_CALL로 분류되고 function selector가 method로 추출된다"
    - "EvmAdapter.signExternalTransaction()이 unsigned tx에 서명하여 SignedTransaction을 반환한다"
    - "잘못된 rawTx는 INVALID_RAW_TRANSACTION ChainError를 발생시킨다"
  artifacts:
    - path: "packages/adapters/evm/src/tx-parser.ts"
      provides: "EVM tx parsing utilities"
      contains: "parseEvmTransaction"
    - path: "packages/adapters/evm/src/adapter.ts"
      provides: "parseTransaction + signExternalTransaction implementations"
      contains: "parseTransaction"
    - path: "packages/adapters/evm/src/__tests__/evm-sign-only.test.ts"
      provides: "Tests for parse + sign-only"
      contains: "parseTransaction"
  key_links:
    - from: "packages/adapters/evm/src/tx-parser.ts"
      to: "packages/adapters/evm/src/adapter.ts"
      via: "parseEvmTransaction import"
      pattern: "parseEvmTransaction"
    - from: "packages/adapters/evm/src/adapter.ts"
      to: "@waiaas/core"
      via: "ParsedTransaction/SignedTransaction type imports"
      pattern: "ParsedTransaction|SignedTransaction"
---

<objective>
EvmAdapter에 parseTransaction()과 signExternalTransaction()을 구현한다. tx-parser.ts에 EVM unsigned tx 파싱 유틸리티를 분리하고, adapter.ts에서 IChainAdapter 인터페이스 메서드로 통합한다.

Purpose: EVM 체인에서 외부 dApp이 빌드한 unsigned tx를 파싱하여 정책 평가에 필요한 operation 정보를 추출하고, 서명할 수 있게 한다.
Output: tx-parser.ts (파싱 유틸리티), adapter.ts 확장 (2개 메서드), 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/115-core-types-db-migration-parsers/115-RESEARCH.md
@.planning/phases/115-core-types-db-migration-parsers/115-01-SUMMARY.md

@packages/adapters/evm/src/adapter.ts
@packages/adapters/evm/src/abi/erc20.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/errors/chain-error.ts
</context>

<feature>
  <name>EVM parseTransaction + signExternalTransaction</name>
  <files>
    packages/adapters/evm/src/tx-parser.ts
    packages/adapters/evm/src/adapter.ts
    packages/adapters/evm/src/index.ts
    packages/adapters/evm/src/__tests__/evm-sign-only.test.ts
  </files>
  <behavior>
    **parseTransaction(rawTx: string) -> ParsedTransaction:**

    Cases:
    - hex(EIP-1559 ETH transfer, no data) -> { operations: [{ type: 'NATIVE_TRANSFER', to: addr, amount: value }], rawTx }
    - hex(EIP-1559 tx with ERC-20 transfer calldata) -> { operations: [{ type: 'TOKEN_TRANSFER', token: toAddr, to: decodedRecipient, amount: decodedAmount }], rawTx }
    - hex(EIP-1559 tx with ERC-20 approve calldata) -> { operations: [{ type: 'APPROVE', token: toAddr, to: decodedSpender, amount: decodedAmount }], rawTx }
    - hex(tx with unknown calldata) -> { operations: [{ type: 'CONTRACT_CALL', programId: toAddr, method: selectorHex }], rawTx }
    - hex(ETH transfer with value + calldata) -> { operations: [{ type: 'CONTRACT_CALL', programId: toAddr, method: selectorHex }], rawTx }
      (value 포함 + calldata 존재 시 CONTRACT_CALL 우선)
    - "0xinvalid" -> throws ChainError('INVALID_RAW_TRANSACTION', 'evm')
    - "not hex at all" -> throws ChainError('INVALID_RAW_TRANSACTION', 'evm')

    **signExternalTransaction(rawTx: string, privateKey: Uint8Array) -> SignedTransaction:**

    Cases:
    - hex(valid unsigned tx) + matching privateKey -> { signedTransaction: signedHex }
    - "0xinvalid" + any key -> throws ChainError('INVALID_RAW_TRANSACTION', 'evm')
    - NOTE: EVM unsigned tx에는 from 필드가 없으므로 WALLET_NOT_SIGNER 검증은 불필요.
      Pipeline (Phase 117)에서 세션-월렛 소유권으로 검증한다.
  </behavior>
  <implementation>
    **tx-parser.ts** (NEW file, ~80 lines):

    1. Import from viem: `parseTransaction` (as `viemParseTransaction` to avoid naming conflict), `type Hex`
    2. Import `ParsedTransaction`, `ParsedOperation` from @waiaas/core
    3. Import `ChainError` from @waiaas/core
    4. Define function selector constants:
       ```typescript
       const ERC20_TRANSFER_SELECTOR = '0xa9059cbb'; // transfer(address,uint256)
       const ERC20_APPROVE_SELECTOR = '0x095ea7b3';  // approve(address,uint256)
       ```
    5. Export function `parseEvmTransaction(rawTx: string): ParsedTransaction`:
       - Wrap viem `parseTransaction(rawTx as Hex)` in try/catch -> ChainError('INVALID_RAW_TRANSACTION', 'evm') on failure
       - Extract `{ to, value, data }` from parsed result
       - If `!data || data === '0x'`: NATIVE_TRANSFER with `to` and `value ?? 0n`
       - Else: extract selector = `data.slice(0, 10)` (first 4 bytes with 0x prefix)
         - If selector === ERC20_TRANSFER_SELECTOR:
           - Decode recipient: `'0x' + data.slice(34, 74)` (address from ABI encoding, offset 10+24=34, length 40)
           - Decode amount: `BigInt('0x' + data.slice(74, 138))` (uint256 from ABI encoding)
           - Return TOKEN_TRANSFER with token=to, to=recipient, amount
         - If selector === ERC20_APPROVE_SELECTOR:
           - Decode spender: `'0x' + data.slice(34, 74)`
           - Decode amount: `BigInt('0x' + data.slice(74, 138))`
           - Return APPROVE with token=to, to=spender, amount
         - Else: CONTRACT_CALL with programId=to, method=selector
       - Return `{ operations, rawTx }`

    **adapter.ts** additions (~40 lines):

    1. Import `ParsedTransaction`, `SignedTransaction` from @waiaas/core
    2. Import `parseEvmTransaction` from './tx-parser.js'
    3. Add `parseTransaction(rawTx: string)` method: delegate to `parseEvmTransaction(rawTx)` (no RPC needed)
    4. Add `signExternalTransaction(rawTx: string, privateKey: Uint8Array)` method:
       - Convert privateKey to hex: ``0x${Buffer.from(privateKey).toString('hex')}`` as Hex
       - Create account via `privateKeyToAccount(privateKeyHex)`
       - Parse the raw tx via `viemParseTransaction(rawTx as Hex)` (try/catch -> INVALID_RAW_TRANSACTION)
       - Sign via `account.signTransaction({ ...parsed, type: parsed.type ?? 'eip1559' })` -- reuse existing signTransaction pattern
       - Return `{ signedTransaction: signedHex }`
       - NOTE: viem의 parseTransaction은 이미 adapter.ts에 import되어 있으므로 이름 충돌에 주의.
         adapter.ts 내에서 viem의 parseTransaction을 `parseTransaction as viemParseTransaction` 같은 별칭으로 import하거나,
         또는 tx-parser.ts만 사용하고 adapter의 signExternalTransaction에서는 직접 viem을 호출.
         기존 signTransaction 메서드가 이미 `parseTransaction`을 사용하므로, IChainAdapter의 `parseTransaction` 메서드명과 충돌함.
         **해결:** 기존 viem import의 `parseTransaction`을 `viemParseTransaction`으로 rename하거나,
         메서드 내에서 `this.parseTransaction()`이 아닌 함수 직접 호출로 구분.
         가장 깔끔한 방법: viem import를 `parseTransaction as viemParseTransaction`으로 변경.

    **index.ts**: 필요시 tx-parser 모듈 재export (adapter가 내부적으로 사용하므로 필수는 아님)

    **Test fixtures strategy:**
    - Use viem's `serializeTransaction()` to create test fixtures:
      - ETH transfer: `serializeTransaction({ type: 'eip1559', to, value, chainId, nonce, gas, maxFeePerGas, maxPriorityFeePerGas })`
      - ERC-20 transfer: same + `data: encodeFunctionData({ abi: ERC20_ABI, functionName: 'transfer', args: [recipient, amount] })`
      - ERC-20 approve: same + `data: encodeFunctionData({ abi: ERC20_ABI, functionName: 'approve', args: [spender, amount] })`
      - Unknown contract call: same + `data: '0xdeadbeef...'`
    - For signExternalTransaction, use `privateKeyToAccount` to generate test key pair
    - For error cases: '0xzzzz', 'not-hex', empty string
  </implementation>
</feature>

<verification>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run build --filter=@waiaas/adapter-evm` -- 빌드 성공
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run test --filter=@waiaas/adapter-evm -- --grep "sign-only"` -- 모든 테스트 통과
3. parseTransaction: ETH transfer, ERC-20 transfer, ERC-20 approve, CONTRACT_CALL 식별 테스트
4. signExternalTransaction: 정상 서명, INVALID_RAW_TRANSACTION 에러 테스트
5. `npx turbo run test --filter=@waiaas/adapter-evm` -- 기존 테스트도 모두 통과 (viem import rename 후)
</verification>

<success_criteria>
- EvmAdapter가 IChainAdapter의 22개 메서드를 모두 구현 (20 기존 + 2 신규)
- parseTransaction이 NATIVE_TRANSFER, TOKEN_TRANSFER, APPROVE, CONTRACT_CALL을 정확히 식별
- signExternalTransaction이 올바른 EIP-1559 서명을 생성하고 hex 반환
- 에러 경로 테스트: INVALID_RAW_TRANSACTION
- viem parseTransaction import rename 후 기존 EVM adapter 테스트 전부 통과
</success_criteria>

<output>
After completion, create `.planning/phases/115-core-types-db-migration-parsers/115-03-SUMMARY.md`
</output>
