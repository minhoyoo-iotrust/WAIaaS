---
phase: 115-core-types-db-migration-parsers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/enums/transaction.ts
  - packages/core/src/interfaces/chain-adapter.types.ts
  - packages/core/src/interfaces/IChainAdapter.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/errors/error-codes.ts
  - packages/core/src/errors/chain-error.ts
  - packages/core/src/index.ts
  - packages/daemon/src/infrastructure/database/migrate.ts
autonomous: true

must_haves:
  truths:
    - "TransactionStatus에 SIGNED가 포함되고 TransactionType에 SIGN이 포함된다"
    - "ParsedTransaction, ParsedOperation, SignedTransaction 타입이 @waiaas/core에서 export된다"
    - "IChainAdapter에 parseTransaction()과 signExternalTransaction() 메서드가 선언된다"
    - "DB migration v9가 transactions 테이블의 CHECK 제약을 SIGNED/SIGN 포함으로 업데이트한다"
    - "INVALID_TRANSACTION, WALLET_NOT_SIGNER, UNSUPPORTED_TX_TYPE, CHAIN_ID_MISMATCH 에러 코드가 존재한다"
    - "ChainErrorCode에 INVALID_RAW_TRANSACTION, WALLET_NOT_SIGNER가 추가된다"
  artifacts:
    - path: "packages/core/src/enums/transaction.ts"
      provides: "SIGNED status, SIGN type in SSoT arrays"
      contains: "SIGNED"
    - path: "packages/core/src/interfaces/chain-adapter.types.ts"
      provides: "ParsedTransaction, ParsedOperation, SignedTransaction types"
      contains: "ParsedTransaction"
    - path: "packages/core/src/interfaces/IChainAdapter.ts"
      provides: "parseTransaction + signExternalTransaction methods"
      contains: "parseTransaction"
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v9 migration + LATEST_SCHEMA_VERSION=9"
      contains: "version: 9"
    - path: "packages/core/src/errors/error-codes.ts"
      provides: "4 new TX domain error codes"
      contains: "INVALID_TRANSACTION"
    - path: "packages/core/src/errors/chain-error.ts"
      provides: "2 new PERMANENT ChainErrorCodes"
      contains: "INVALID_RAW_TRANSACTION"
  key_links:
    - from: "packages/core/src/enums/transaction.ts"
      to: "packages/daemon/src/infrastructure/database/migrate.ts"
      via: "inList(TRANSACTION_STATUSES) / inList(TRANSACTION_TYPES)"
      pattern: "inList\\(TRANSACTION_(STATUSES|TYPES)\\)"
    - from: "packages/core/src/interfaces/chain-adapter.types.ts"
      to: "packages/core/src/interfaces/IChainAdapter.ts"
      via: "ParsedTransaction/SignedTransaction type imports"
      pattern: "ParsedTransaction|SignedTransaction"
    - from: "packages/core/src/interfaces/chain-adapter.types.ts"
      to: "packages/core/src/index.ts"
      via: "re-export from index"
      pattern: "ParsedTransaction"
---

<objective>
Core 타입 확장 + DB 마이그레이션 v9: SIGNED 상태/SIGN 타입을 SSoT 열거형에 추가하고, ParsedTransaction/ParsedOperation/SignedTransaction 타입을 정의하며, IChainAdapter에 2개 메서드를 선언하고, 4개 에러 코드 + 2개 ChainErrorCode를 추가한다. DB migration v9로 transactions 테이블 CHECK 제약을 갱신한다.

Purpose: 모든 downstream 구현(SolanaAdapter, EvmAdapter, Pipeline, REST API)이 의존하는 타입 기반과 DB 스키마를 먼저 확립한다.
Output: 확장된 core 패키지 타입들, v9 migration, 업데이트된 에러 코드들
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/115-core-types-db-migration-parsers/115-RESEARCH.md

@packages/core/src/enums/transaction.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/errors/error-codes.ts
@packages/core/src/errors/chain-error.ts
@packages/core/src/index.ts
@packages/daemon/src/infrastructure/database/migrate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SSoT 열거형 확장 + 타입 정의 + 에러 코드 추가</name>
  <files>
    packages/core/src/enums/transaction.ts
    packages/core/src/interfaces/chain-adapter.types.ts
    packages/core/src/interfaces/IChainAdapter.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/errors/error-codes.ts
    packages/core/src/errors/chain-error.ts
    packages/core/src/index.ts
  </files>
  <action>
    1. **packages/core/src/enums/transaction.ts**: TRANSACTION_STATUSES 배열 끝에 `'SIGNED'` 추가 (9->10개). TRANSACTION_TYPES 배열 끝에 `'SIGN'` 추가 (5->6개). 기존 `as const`, Zod enum 파생 코드는 자동 업데이트됨.

    2. **packages/core/src/interfaces/chain-adapter.types.ts**: 파일 끝(BatchParams 아래)에 3개 인터페이스 추가:
    ```typescript
    // ---------------------------------------------------------------------------
    // v1.4.7 sign-only types for parseTransaction / signExternalTransaction
    // ---------------------------------------------------------------------------

    /** Operation type identified from an unsigned transaction. */
    export type ParsedOperationType =
      | 'NATIVE_TRANSFER'
      | 'TOKEN_TRANSFER'
      | 'CONTRACT_CALL'
      | 'APPROVE'
      | 'UNKNOWN';

    /** A single operation extracted from an unsigned transaction. */
    export interface ParsedOperation {
      /** Operation type. */
      type: ParsedOperationType;
      /** Recipient or target address. */
      to?: string;
      /** Transfer/approve amount in smallest unit. */
      amount?: bigint;
      /** Token address (mint for Solana, contract for EVM). */
      token?: string;
      /** Program/contract address (for CONTRACT_CALL). */
      programId?: string;
      /** Method selector or discriminator (hex string). */
      method?: string;
    }

    /** Result of parsing an unsigned external transaction. */
    export interface ParsedTransaction {
      /** List of operations in the transaction. */
      operations: ParsedOperation[];
      /** Original raw transaction string (base64 for Solana, hex for EVM). */
      rawTx: string;
    }

    /** Result of signing an external transaction. */
    export interface SignedTransaction {
      /** Signed transaction (base64 for Solana, hex for EVM). */
      signedTransaction: string;
      /** Transaction hash if computable before submission. */
      txHash?: string;
    }
    ```

    3. **packages/core/src/interfaces/IChainAdapter.ts**:
    - import에 `ParsedTransaction`, `SignedTransaction` 추가 (chain-adapter.types.ts에서)
    - 인터페이스 끝(`sweepAll` 아래)에 새 섹션 추가:
    ```typescript
    // -- Sign-only operations (2) -- v1.4.7

    /** Parse an unsigned external transaction into structured operations. */
    parseTransaction(rawTx: string): Promise<ParsedTransaction>;

    /** Sign an unsigned external transaction with wallet's private key. */
    signExternalTransaction(rawTx: string, privateKey: Uint8Array): Promise<SignedTransaction>;
    ```
    - 인터페이스 주석의 메서드 카운트 업데이트: `Total: 20` -> `Total: 22`, `v1.4.7 scope: +2 methods (sign-only parse/sign). Total: 22.` 추가

    4. **packages/core/src/interfaces/index.ts**: `ParsedTransaction`, `ParsedOperation`, `ParsedOperationType`, `SignedTransaction` 타입 export 추가

    5. **packages/core/src/errors/error-codes.ts**: TX 도메인 섹션 끝(ENVIRONMENT_NETWORK_MISMATCH 뒤)에 4개 에러 코드 추가:
    ```typescript
    INVALID_TRANSACTION: {
      code: 'INVALID_TRANSACTION',
      domain: 'TX',
      httpStatus: 400,
      retryable: false,
      message: 'Invalid raw transaction format',
    },
    WALLET_NOT_SIGNER: {
      code: 'WALLET_NOT_SIGNER',
      domain: 'TX',
      httpStatus: 400,
      retryable: false,
      message: 'Wallet is not a signer in this transaction',
    },
    UNSUPPORTED_TX_TYPE: {
      code: 'UNSUPPORTED_TX_TYPE',
      domain: 'TX',
      httpStatus: 400,
      retryable: false,
      message: 'Unsupported transaction type',
    },
    CHAIN_ID_MISMATCH: {
      code: 'CHAIN_ID_MISMATCH',
      domain: 'TX',
      httpStatus: 400,
      retryable: false,
      message: 'Transaction chain ID does not match requested network',
    },
    ```
    TX 도메인 주석 업데이트: `(20)` -> `(24)`

    6. **packages/core/src/errors/chain-error.ts**:
    - ChainErrorCode 타입 union에 PERMANENT 카테고리 끝(BATCH_SIZE_EXCEEDED 뒤)에 2개 추가: `'INVALID_RAW_TRANSACTION'`, `'WALLET_NOT_SIGNER'`
    - CHAIN_ERROR_CATEGORIES 맵에 2개 추가: `INVALID_RAW_TRANSACTION: 'PERMANENT'`, `WALLET_NOT_SIGNER: 'PERMANENT'`
    - 주석 업데이트: PERMANENT 카운트 `19` -> `21`, 전체 `27` -> `29`

    7. **packages/core/src/index.ts**: interfaces re-export에 `ParsedTransaction`, `ParsedOperation`, `ParsedOperationType`, `SignedTransaction` 추가. 에러 코드 주석 카운트도 `68` -> `72` (실제 69->73)로 업데이트.
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run build --filter=@waiaas/core` 성공 확인. TypeScript 컴파일 에러 없음.
  </verify>
  <done>
    TRANSACTION_STATUSES에 SIGNED(10개), TRANSACTION_TYPES에 SIGN(6개)이 포함된다. ParsedTransaction/ParsedOperation/SignedTransaction이 @waiaas/core에서 export된다. IChainAdapter에 parseTransaction/signExternalTransaction 선언이 있다. ERROR_CODES에 4개 신규 코드, ChainErrorCode에 2개 신규 코드가 추가된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: DB 마이그레이션 v9 + LATEST_SCHEMA_VERSION 업데이트</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
  </files>
  <action>
    1. **LATEST_SCHEMA_VERSION**: `8` -> `9`로 변경 (line 54).

    2. **v9 Migration 추가**: v8 migration 블록 뒤(MIGRATIONS.push 이전, `runMigrations` 함수 정의 전)에 새 migration 추가:

    ```typescript
    // ---------------------------------------------------------------------------
    // v9: Add SIGNED status and SIGN type to transactions CHECK constraints
    // ---------------------------------------------------------------------------
    // SSoT arrays TRANSACTION_STATUSES/TRANSACTION_TYPES에 새 값이 추가되었으므로
    // transactions 테이블의 CHECK 제약을 갱신해야 한다. SQLite는 ALTER CHECK 불가 -> 12-step 재생성.
    // 이 마이그레이션은 transactions 테이블만 재생성한다 (다른 테이블에 영향 없음).

    MIGRATIONS.push({
      version: 9,
      description: 'Add SIGNED status and SIGN type to transactions CHECK constraints',
      managesOwnTransaction: true,
      up: (sqlite) => {
        // Step 1: Begin transaction
        sqlite.exec('BEGIN');

        try {
          // Step 2: Create transactions_new with updated CHECK constraints
          sqlite.exec(`CREATE TABLE transactions_new (
      id TEXT PRIMARY KEY,
      wallet_id TEXT NOT NULL REFERENCES wallets(id) ON DELETE RESTRICT,
      session_id TEXT REFERENCES sessions(id) ON DELETE SET NULL,
      chain TEXT NOT NULL,
      tx_hash TEXT,
      type TEXT NOT NULL CHECK (type IN (${inList(TRANSACTION_TYPES)})),
      amount TEXT,
      to_address TEXT,
      token_mint TEXT,
      contract_address TEXT,
      method_signature TEXT,
      spender_address TEXT,
      approved_amount TEXT,
      parent_id TEXT REFERENCES transactions_new(id) ON DELETE CASCADE,
      batch_index INTEGER,
      status TEXT NOT NULL DEFAULT 'PENDING' CHECK (status IN (${inList(TRANSACTION_STATUSES)})),
      tier TEXT CHECK (tier IS NULL OR tier IN (${inList(POLICY_TIERS)})),
      queued_at INTEGER,
      executed_at INTEGER,
      created_at INTEGER NOT NULL,
      reserved_amount TEXT,
      error TEXT,
      metadata TEXT,
      network TEXT CHECK (network IS NULL OR network IN (${inList(NETWORK_TYPES)}))
    )`);

          // Step 3: Copy existing data
          sqlite.exec(`INSERT INTO transactions_new (id, wallet_id, session_id, chain, tx_hash, type, amount, to_address, token_mint, contract_address, method_signature, spender_address, approved_amount, parent_id, batch_index, status, tier, queued_at, executed_at, created_at, reserved_amount, error, metadata, network)
      SELECT id, wallet_id, session_id, chain, tx_hash, type, amount, to_address, token_mint, contract_address, method_signature, spender_address, approved_amount, parent_id, batch_index, status, tier, queued_at, executed_at, created_at, reserved_amount, error, metadata, network FROM transactions`);

          // Step 4: Drop old table
          sqlite.exec('DROP TABLE transactions');

          // Step 5: Rename new table
          sqlite.exec('ALTER TABLE transactions_new RENAME TO transactions');

          // Step 6: Recreate all 8 existing indexes
          sqlite.exec('CREATE INDEX idx_transactions_wallet_status ON transactions(wallet_id, status)');
          sqlite.exec('CREATE INDEX idx_transactions_session_id ON transactions(session_id)');
          sqlite.exec('CREATE UNIQUE INDEX idx_transactions_tx_hash ON transactions(tx_hash)');
          sqlite.exec('CREATE INDEX idx_transactions_queued_at ON transactions(queued_at)');
          sqlite.exec('CREATE INDEX idx_transactions_created_at ON transactions(created_at)');
          sqlite.exec('CREATE INDEX idx_transactions_type ON transactions(type)');
          sqlite.exec('CREATE INDEX idx_transactions_contract_address ON transactions(contract_address)');
          sqlite.exec('CREATE INDEX idx_transactions_parent_id ON transactions(parent_id)');

          // Step 7: Commit
          sqlite.exec('COMMIT');
        } catch (err) {
          sqlite.exec('ROLLBACK');
          throw err;
        }

        // Step 8: Re-enable foreign keys and verify integrity
        sqlite.pragma('foreign_keys = ON');
        const fkErrors = sqlite.pragma('foreign_key_check') as unknown[];
        if (fkErrors.length > 0) {
          throw new Error(`FK integrity violation after v9: ${JSON.stringify(fkErrors)}`);
        }
      },
    });
    ```

    **핵심 포인트:**
    - `parent_id TEXT REFERENCES transactions_new(id)` -- 자기 참조 FK는 새 테이블을 참조
    - 8개 인덱스 전부 재생성 (v7 migration과 동일한 인덱스 목록)
    - `inList(TRANSACTION_TYPES)`와 `inList(TRANSACTION_STATUSES)`는 SSoT 배열을 사용하므로 Task 1에서 추가한 SIGN/SIGNED가 자동 포함됨
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run build --filter=@waiaas/daemon` 성공 확인.
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo run test --filter=@waiaas/daemon -- --grep migration` 실행하여 기존 마이그레이션 테스트 통과 확인.
    LATEST_SCHEMA_VERSION이 9인지 grep으로 확인: `grep 'LATEST_SCHEMA_VERSION' packages/daemon/src/infrastructure/database/migrate.ts`
  </verify>
  <done>
    LATEST_SCHEMA_VERSION=9이고, v9 migration이 transactions 테이블을 12-step 패턴으로 재생성하며 SIGNED/SIGN 값이 CHECK 제약에 포함된다. 기존 v2~v8 마이그레이션 테스트가 계속 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `npx turbo run build --filter=@waiaas/core` -- TypeScript 빌드 성공
2. `npx turbo run build --filter=@waiaas/daemon` -- daemon 빌드 성공 (core 의존성 포함)
3. `grep -c 'SIGNED' packages/core/src/enums/transaction.ts` -- 1 이상
4. `grep -c 'SIGN' packages/core/src/enums/transaction.ts` -- 2 이상 (SIGN + SIGNED)
5. `grep 'parseTransaction' packages/core/src/interfaces/IChainAdapter.ts` -- 메서드 선언 존재
6. `grep 'signExternalTransaction' packages/core/src/interfaces/IChainAdapter.ts` -- 메서드 선언 존재
7. `grep 'LATEST_SCHEMA_VERSION = 9' packages/daemon/src/infrastructure/database/migrate.ts` -- 버전 9
8. `grep 'INVALID_TRANSACTION' packages/core/src/errors/error-codes.ts` -- 에러 코드 존재
9. `grep 'INVALID_RAW_TRANSACTION' packages/core/src/errors/chain-error.ts` -- ChainErrorCode 존재
</verification>

<success_criteria>
- @waiaas/core 빌드 성공 + 새 타입 4개 export
- @waiaas/daemon 빌드 성공 + migration v9 포함
- SSoT 열거형: TRANSACTION_STATUSES 10개, TRANSACTION_TYPES 6개
- IChainAdapter: 22 메서드 (20+2)
- ERROR_CODES: 73개 (69+4)
- ChainErrorCode: 29개 (27+2)
- LATEST_SCHEMA_VERSION = 9
</success_criteria>

<output>
After completion, create `.planning/phases/115-core-types-db-migration-parsers/115-01-SUMMARY.md`
</output>
