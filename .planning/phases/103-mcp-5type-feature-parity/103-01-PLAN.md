---
phase: 103-mcp-5type-feature-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/tools/call-contract.ts
  - packages/mcp/src/tools/approve-token.ts
  - packages/mcp/src/tools/send-batch.ts
  - packages/mcp/src/server.ts
  - packages/mcp/src/tools/send-token.ts
autonomous: true

must_haves:
  truths:
    - "MCP call_contract tool accepts CONTRACT_CALL params and posts to /v1/transactions/send"
    - "MCP approve_token tool accepts APPROVE params and posts to /v1/transactions/send"
    - "MCP send_batch tool accepts BATCH instructions array and posts to /v1/transactions/send"
    - "All 3 new tools are registered in createMcpServer and usable via MCP protocol"
  artifacts:
    - path: "packages/mcp/src/tools/call-contract.ts"
      provides: "call_contract MCP tool"
      exports: ["registerCallContract"]
    - path: "packages/mcp/src/tools/approve-token.ts"
      provides: "approve_token MCP tool"
      exports: ["registerApproveToken"]
    - path: "packages/mcp/src/tools/send-batch.ts"
      provides: "send_batch MCP tool"
      exports: ["registerSendBatch"]
    - path: "packages/mcp/src/server.ts"
      provides: "MCP server with 10 tools + 3 resources"
      contains: "registerCallContract"
  key_links:
    - from: "packages/mcp/src/tools/call-contract.ts"
      to: "/v1/transactions/send"
      via: "apiClient.post"
      pattern: "apiClient\\.post\\('/v1/transactions/send'"
    - from: "packages/mcp/src/tools/approve-token.ts"
      to: "/v1/transactions/send"
      via: "apiClient.post"
      pattern: "apiClient\\.post\\('/v1/transactions/send'"
    - from: "packages/mcp/src/tools/send-batch.ts"
      to: "/v1/transactions/send"
      via: "apiClient.post"
      pattern: "apiClient\\.post\\('/v1/transactions/send'"
    - from: "packages/mcp/src/server.ts"
      to: "packages/mcp/src/tools/call-contract.ts"
      via: "import + registerCallContract()"
      pattern: "registerCallContract\\(server, apiClient"
---

<objective>
Implement 3 new MCP tools (call_contract, approve_token, send_batch) to achieve feature parity with the REST API and TS/Python SDK for CONTRACT_CALL, APPROVE, and BATCH transaction types. This resolves BUG-017 where MCP agents were unnecessarily restricted from these transaction types.

Purpose: MCP agents can currently only perform TRANSFER and TOKEN_TRANSFER transactions. The REST API and SDK support all 5 types. The policy engine (CONTRACT_WHITELIST, APPROVED_SPENDERS, default-deny) provides the same security regardless of call path (MCP/SDK/API), making the MCP restriction unnecessary.

Output: 3 new tool files + server.ts registration update + send-token.ts comment cleanup
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing tool patterns to follow exactly
@packages/mcp/src/tools/send-token.ts
@packages/mcp/src/tools/get-balance.ts
@packages/mcp/src/server.ts
@packages/mcp/src/api-client.ts

# Transaction type schemas (CONTRACT_CALL, APPROVE, BATCH parameter definitions)
@packages/core/src/schemas/transaction.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create call_contract, approve_token, send_batch MCP tool files</name>
  <files>
    packages/mcp/src/tools/call-contract.ts
    packages/mcp/src/tools/approve-token.ts
    packages/mcp/src/tools/send-batch.ts
  </files>
  <action>
Create 3 new tool files following the exact same pattern as send-token.ts (import z, McpServer, ApiClient, toToolResult, WalletContext, withWalletPrefix).

**call-contract.ts** (`registerCallContract`):
- Tool name: `call_contract`
- Description: `withWalletPrefix('Call a whitelisted smart contract. Requires CONTRACT_WHITELIST policy. For EVM: provide calldata (hex). For Solana: provide programId + instructionData + accounts.', walletContext?.walletName)`
- Parameters (from ContractCallRequestSchema in core):
  - `to`: z.string() -- contract address (required)
  - `calldata`: z.string().optional() -- hex-encoded calldata (EVM)
  - `abi`: z.array(z.record(z.unknown())).optional() -- ABI fragment for decoding (EVM)
  - `value`: z.string().optional() -- native token value in wei (EVM)
  - `programId`: z.string().optional() -- program ID (Solana)
  - `instructionData`: z.string().optional() -- base64-encoded (Solana)
  - `accounts`: z.array(z.object({ pubkey: z.string(), isSigner: z.boolean(), isWritable: z.boolean() })).optional() -- (Solana)
- Handler: Build body with `type: 'CONTRACT_CALL'`, include all non-undefined optional fields, POST to `/v1/transactions/send`, return `toToolResult(result)`

**approve-token.ts** (`registerApproveToken`):
- Tool name: `approve_token`
- Description: `withWalletPrefix('Approve a spender to transfer tokens on your behalf. Requires APPROVED_SPENDERS policy.', walletContext?.walletName)`
- Parameters (from ApproveRequestSchema in core):
  - `spender`: z.string() -- spender address (required)
  - `token`: z.object({ address: z.string(), decimals: z.number(), symbol: z.string() }) -- token info (required)
  - `amount`: z.string() -- approval amount in smallest unit (required)
- Handler: Build body with `type: 'APPROVE'` + spender + token + amount, POST to `/v1/transactions/send`, return `toToolResult(result)`

**send-batch.ts** (`registerSendBatch`):
- Tool name: `send_batch`
- Description: `withWalletPrefix('Send multiple instructions in a single atomic transaction (Solana only, 2-20 instructions).', walletContext?.walletName)`
- Parameters (from BatchRequestSchema in core):
  - `instructions`: z.array(z.record(z.unknown())).min(2).max(20) -- array of instruction objects (each is a TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE without the type field at instruction level)
- Handler: Build body with `type: 'BATCH'` + instructions, POST to `/v1/transactions/send`, return `toToolResult(result)`

NOTE: Use `z.record(z.unknown())` for instruction items rather than the full union schema -- the daemon's pipeline Stage 1 performs proper Zod validation on the request body. The MCP tool just needs to pass through the data. This avoids duplicating complex nested schemas.

Each file should have a JSDoc comment at the top explaining the tool purpose (follow send-token.ts style).
  </action>
  <verify>
    TypeScript compilation: `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx tsc -p packages/mcp/tsconfig.json --noEmit 2>&1 | head -20`
    Each file exports a register function: `grep -r "export function register" packages/mcp/src/tools/call-contract.ts packages/mcp/src/tools/approve-token.ts packages/mcp/src/tools/send-batch.ts`
  </verify>
  <done>
    3 tool files exist, each exports a registerXxx function, each calls apiClient.post('/v1/transactions/send') with correct type field, TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Register new tools in server.ts and clean up send-token.ts comment</name>
  <files>
    packages/mcp/src/server.ts
    packages/mcp/src/tools/send-token.ts
  </files>
  <action>
**server.ts changes:**
1. Add 3 imports at the tool registration section:
   ```typescript
   import { registerCallContract } from './tools/call-contract.js';
   import { registerApproveToken } from './tools/approve-token.js';
   import { registerSendBatch } from './tools/send-batch.js';
   ```
2. In `createMcpServer()`, after the existing 7 tool registrations, add 3 new registrations:
   ```typescript
   registerCallContract(server, apiClient, walletContext);
   registerApproveToken(server, apiClient, walletContext);
   registerSendBatch(server, apiClient, walletContext);
   ```
3. Update the JSDoc comment from "7 tools + 3 resources" to "10 tools + 3 resources"
4. Update the inline comment from "Register 7 tools" to "Register 10 tools"

**send-token.ts changes:**
1. Remove the MCPSDK-04 comment block at the top that says "CONTRACT_CALL, APPROVE, and BATCH are deliberately NOT exposed via MCP for security (MCPSDK-04)."
2. Replace with: "Supports TRANSFER (native) and TOKEN_TRANSFER (SPL/ERC-20) types. For contract calls, approvals, and batch transactions, use the dedicated call_contract, approve_token, and send_batch tools."
  </action>
  <verify>
    TypeScript compilation: `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx tsc -p packages/mcp/tsconfig.json --noEmit`
    Registration check: `grep -c "register.*server, apiClient" packages/mcp/src/server.ts` should show 10
    No MCPSDK-04 reference: `grep "MCPSDK-04" packages/mcp/src/tools/send-token.ts` should return nothing
  </verify>
  <done>
    server.ts registers 10 tools, JSDoc/comments updated, send-token.ts no longer references MCPSDK-04, TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -p packages/mcp/tsconfig.json --noEmit` -- zero errors
2. `grep -r "registerCallContract\|registerApproveToken\|registerSendBatch" packages/mcp/src/server.ts` -- all 3 present
3. `grep "MCPSDK-04" packages/mcp/src/` -- no results (removed)
4. Each new tool file contains `apiClient.post('/v1/transactions/send'` and `toToolResult`
</verification>

<success_criteria>
- 3 new tool files created with correct structure
- server.ts imports and registers all 10 tools
- send-token.ts MCPSDK-04 comment removed
- TypeScript compiles without errors
- All existing tests still pass: `npx vitest run --project mcp`
</success_criteria>

<output>
After completion, create `.planning/phases/103-mcp-5type-feature-parity/103-01-SUMMARY.md`
</output>
