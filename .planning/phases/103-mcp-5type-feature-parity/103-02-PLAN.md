---
phase: 103-mcp-5type-feature-parity
plan: 02
type: execute
wave: 2
depends_on: ["103-01"]
files_modified:
  - packages/mcp/src/__tests__/tools.test.ts
  - .planning/deliverables/38-sdk-mcp-interface.md
  - objectives/bug-reports/v1.4.1-BUG-017-mcp-contract-call-blocked.md
autonomous: true

must_haves:
  truths:
    - "call_contract tool tests verify correct API call with CONTRACT_CALL type and EVM/Solana params"
    - "approve_token tool tests verify correct API call with APPROVE type and spender/token/amount"
    - "send_batch tool tests verify correct API call with BATCH type and instructions array"
    - "Design document 38 no longer contains MCPSDK-04 restriction; feature parity principle is stated"
    - "BUG-017 is marked RESOLVED"
  artifacts:
    - path: "packages/mcp/src/__tests__/tools.test.ts"
      provides: "Tests for all 10 MCP tools"
      contains: "call_contract tool"
    - path: ".planning/deliverables/38-sdk-mcp-interface.md"
      provides: "Updated design document with feature parity"
      contains: "feature parity"
    - path: "objectives/bug-reports/v1.4.1-BUG-017-mcp-contract-call-blocked.md"
      provides: "Resolved bug report"
      contains: "RESOLVED"
  key_links:
    - from: "packages/mcp/src/__tests__/tools.test.ts"
      to: "packages/mcp/src/tools/call-contract.ts"
      via: "import registerCallContract"
      pattern: "import.*registerCallContract"
    - from: "packages/mcp/src/__tests__/tools.test.ts"
      to: "packages/mcp/src/tools/approve-token.ts"
      via: "import registerApproveToken"
      pattern: "import.*registerApproveToken"
---

<objective>
Add comprehensive tests for the 3 new MCP tools (call_contract, approve_token, send_batch), update design document 38 to revoke MCPSDK-04 and establish feature parity principle, and close BUG-017.

Purpose: Tests verify that the new tools correctly relay parameters to the daemon API. The design document update formally revokes the erroneous security restriction. BUG-017 closure completes the tracking trail.

Output: Extended test suite + design doc update + bug report closure
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan artifacts
@.planning/phases/103-mcp-5type-feature-parity/103-01-SUMMARY.md

# Existing test patterns
@packages/mcp/src/__tests__/tools.test.ts

# Bug report to close
@objectives/bug-reports/v1.4.1-BUG-017-mcp-contract-call-blocked.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for call_contract, approve_token, send_batch tools</name>
  <files>packages/mcp/src/__tests__/tools.test.ts</files>
  <action>
Extend the existing tools.test.ts with 3 new describe blocks following the exact same testing pattern (createMockApiClient, getToolHandler, assert apiClient.post called with correct body, verify toToolResult output).

Add imports at the top:
```typescript
import { registerCallContract } from '../tools/call-contract.js';
import { registerApproveToken } from '../tools/approve-token.js';
import { registerSendBatch } from '../tools/send-batch.js';
```

**describe('call_contract tool'):**

1. `'calls POST /v1/transactions/send with CONTRACT_CALL type and EVM params'`
   - Handler args: `{ to: '0xContractAddr', calldata: '0xabcdef', value: '1000' }`
   - Assert apiClient.post called with: `{ type: 'CONTRACT_CALL', to: '0xContractAddr', calldata: '0xabcdef', value: '1000' }`
   - Assert result contains data (parsed from content text)

2. `'calls POST with Solana params (programId, instructionData, accounts)'`
   - Handler args: `{ to: 'ProgramAddr', programId: 'Prog1', instructionData: 'base64data', accounts: [{ pubkey: 'pk1', isSigner: true, isWritable: true }] }`
   - Assert body contains type: 'CONTRACT_CALL', programId, instructionData, accounts

3. `'returns error with isError on policy rejection'`
   - Mock response: `{ ok: false, error: { code: 'CONTRACT_NOT_WHITELISTED', message: 'Contract not in whitelist', retryable: false } }`
   - Assert result.isError === true, parsed code is 'CONTRACT_NOT_WHITELISTED'

4. `'omits undefined optional fields from body'`
   - Handler args: `{ to: '0xAddr' }` (only required field)
   - Assert body is `{ type: 'CONTRACT_CALL', to: '0xAddr' }` (no calldata, abi, value, programId, etc.)

**describe('approve_token tool'):**

1. `'calls POST /v1/transactions/send with APPROVE type'`
   - Handler args: `{ spender: '0xSpenderAddr', token: { address: '0xTokenAddr', decimals: 18, symbol: 'USDT' }, amount: '1000000' }`
   - Assert body: `{ type: 'APPROVE', spender: '0xSpenderAddr', token: { address: '0xTokenAddr', decimals: 18, symbol: 'USDT' }, amount: '1000000' }`

2. `'returns error on SPENDER_NOT_APPROVED policy rejection'`
   - Mock: `{ ok: false, error: { code: 'SPENDER_NOT_APPROVED', message: 'Spender not in approved list', retryable: false } }`
   - Assert isError true

**describe('send_batch tool'):**

1. `'calls POST /v1/transactions/send with BATCH type and instructions'`
   - Handler args: `{ instructions: [{ to: 'addr1', amount: '100' }, { to: 'addr2', amount: '200' }] }`
   - Assert body: `{ type: 'BATCH', instructions: [{ to: 'addr1', amount: '100' }, { to: 'addr2', amount: '200' }] }`

2. `'returns error on BATCH_NOT_SUPPORTED for EVM'`
   - Mock: `{ ok: false, error: { code: 'BATCH_NOT_SUPPORTED', message: 'Batch not supported on EVM', retryable: false } }`
   - Assert isError true

**Update 'tool registration with McpServer' describe block:**
- Add 3 new registration tests (same pattern as existing 7):
  - `'registers call_contract tool without error'`
  - `'registers approve_token tool without error'`
  - `'registers send_batch tool without error'`
  </action>
  <verify>
    Run MCP tests: `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run --project mcp 2>&1 | tail -20`
    All tests pass including the new ones.
  </verify>
  <done>
    11 new test cases added (4 call_contract + 2 approve_token + 2 send_batch + 3 registration), all tests pass, existing tests unbroken
  </done>
</task>

<task type="auto">
  <name>Task 2: Update design document 38 (MCPSDK-04 revocation) and close BUG-017</name>
  <files>
    .planning/deliverables/38-sdk-mcp-interface.md
    objectives/bug-reports/v1.4.1-BUG-017-mcp-contract-call-blocked.md
  </files>
  <action>
**Design document 38 updates:**

The design document is very large. Make targeted edits to:

1. Find the MCP tool count references. In section 5.3.1 (or wherever the "6 tools" count appears), update to "10 tools" or add the 3 new tools to the table. The table in section 5.3.1 lists 6 tools -- add 3 rows:
   - `| 8 | call_contract | POST /v1/transactions/send | 컨트랙트 호출 (CONTRACT_CALL) | to, calldata?, abi?, value?, programId?, instructionData?, accounts? |`
   - `| 9 | approve_token | POST /v1/transactions/send | 토큰 승인 (APPROVE) | spender, token, amount |`
   - `| 10 | send_batch | POST /v1/transactions/send | 배치 트랜잭션 (BATCH) | instructions[] |`

2. Find the feature parity table (section 8 or wherever the "컨트랙트 호출 (v0.6)" row shows `--` for MCP column). Update:
   - `컨트랙트 호출 (v0.6)` MCP column: `--` -> `call_contract`
   - `토큰 승인 (v0.6)` MCP column: `--` -> `approve_token`
   - `배치 (v0.6)` MCP column: `--` -> `send_batch`

3. Find the "6개로 제한" comment about MCP tool count and update to reflect 10 tools.

4. Find createMcpServer() section and update "6 tool + 3 resource" references to "10 tool + 3 resource".

5. Add a new decision note at an appropriate location (near the existing MCPSDK decisions or at the bottom of the MCP section):
   ```
   > **[v1.4.4] MCPSDK-04 철회 (Phase 103):** MCP에서 CONTRACT_CALL/APPROVE/BATCH를 차단하던 보안 정책(MCPSDK-04)을 철회한다.
   > 근거: MCP/SDK/API 세 경로 모두 AI 에이전트가 호출하므로 프롬프트 인젝션 공격 표면이 동일하다.
   > 실제 보안은 정책 엔진(CONTRACT_WHITELIST, APPROVED_SPENDERS, 기본 거부)이 호출 경로와 무관하게 적용한다.
   > MCP만 차단하는 것은 보안 효과 없이 DX를 저하시킨다. **Feature Parity 원칙: MCP/SDK/API는 동일한 트랜잭션 타입을 지원한다.**
   ```

6. In the REST API coverage table (if present), update the `/v1/transactions/send` row to show MCP now covers CONTRACT_CALL/APPROVE/BATCH via dedicated tools.

**BUG-017 closure:**

At the bottom of `objectives/bug-reports/v1.4.1-BUG-017-mcp-contract-call-blocked.md`:
1. Change `*상태: OPEN*` to `*상태: RESOLVED*`
2. Add resolution note:
   ```
   *해결: 2026-02-14*
   *해결 방법: Phase 103에서 call_contract, approve_token, send_batch 3개 MCP 도구 추가. MCPSDK-04 결정 철회. 설계 문서 38 feature parity 원칙으로 대체.*
   ```
  </action>
  <verify>
    Grep for feature parity: `grep -c "feature parity\|Feature Parity\|MCPSDK-04 철회" .planning/deliverables/38-sdk-mcp-interface.md` -- at least 1 match
    BUG-017 resolved: `grep "RESOLVED" objectives/bug-reports/v1.4.1-BUG-017-mcp-contract-call-blocked.md`
    MCP tools updated in doc: `grep "call_contract\|approve_token\|send_batch" .planning/deliverables/38-sdk-mcp-interface.md | wc -l` -- at least 3 matches
  </verify>
  <done>
    Design document 38 updated with MCPSDK-04 revocation and feature parity principle, tool count updated from 6/7 to 10, feature parity table shows all 5 types with MCP tool names, BUG-017 marked RESOLVED
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run --project mcp` -- all tests pass (existing + 11 new)
2. `grep "MCPSDK-04 철회" .planning/deliverables/38-sdk-mcp-interface.md` -- decision recorded
3. `grep "RESOLVED" objectives/bug-reports/v1.4.1-BUG-017-mcp-contract-call-blocked.md` -- bug closed
4. `grep -c "call_contract\|approve_token\|send_batch" .planning/deliverables/38-sdk-mcp-interface.md` -- >= 6 matches
</verification>

<success_criteria>
- 11 new test cases pass (4+2+2+3) covering all 3 new tools
- All existing MCP tests still pass
- Design document 38 formally revokes MCPSDK-04 with justification
- Feature parity table shows MCP support for all 5 transaction types
- BUG-017 status is RESOLVED with resolution date and method
</success_criteria>

<output>
After completion, create `.planning/phases/103-mcp-5type-feature-parity/103-02-SUMMARY.md`
</output>
