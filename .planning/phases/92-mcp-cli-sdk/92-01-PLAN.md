---
phase: 92-mcp-cli-sdk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/server.ts
  - packages/mcp/src/index.ts
  - packages/mcp/src/session-manager.ts
  - packages/mcp/src/tools/send-token.ts
  - packages/mcp/src/tools/get-balance.ts
  - packages/mcp/src/tools/get-address.ts
  - packages/mcp/src/tools/get-assets.ts
  - packages/mcp/src/tools/list-transactions.ts
  - packages/mcp/src/tools/get-transaction.ts
  - packages/mcp/src/tools/get-nonce.ts
  - packages/mcp/src/resources/wallet-balance.ts
  - packages/mcp/src/resources/wallet-address.ts
  - packages/mcp/src/resources/system-status.ts
  - packages/mcp/src/__tests__/server.test.ts
  - packages/mcp/src/__tests__/session-manager.test.ts
  - packages/mcp/src/__tests__/tools.test.ts
  - packages/cli/src/index.ts
  - packages/cli/src/commands/mcp-setup.ts
  - packages/cli/src/utils/slug.ts
  - packages/cli/src/__tests__/mcp-setup.test.ts
  - packages/cli/src/__tests__/slug.test.ts
autonomous: true

must_haves:
  truths:
    - "WalletContext interface exists and AgentContext is 0 occurrences in MCP package"
    - "withWalletPrefix function exists and withAgentPrefix is 0 occurrences"
    - "CLI --wallet flag is recognized and --agent is not"
    - "WAIAAS_WALLET_ID and WAIAAS_WALLET_NAME env vars are read by MCP entrypoint"
    - "mcp-tokens/<walletId> path is used for token storage"
    - "CLI mcp setup output shows WAIAAS_WALLET_ID in config snippet"
  artifacts:
    - path: "packages/mcp/src/server.ts"
      provides: "WalletContext interface + withWalletPrefix function"
      contains: "WalletContext"
    - path: "packages/cli/src/index.ts"
      provides: "CLI --wallet flag"
      contains: "--wallet"
    - path: "packages/mcp/src/session-manager.ts"
      provides: "walletId option for token path isolation"
      contains: "walletId"
    - path: "packages/cli/src/commands/mcp-setup.ts"
      provides: "WAIAAS_WALLET_ID env var in config snippet"
      contains: "WAIAAS_WALLET_ID"
  key_links:
    - from: "packages/mcp/src/index.ts"
      to: "packages/mcp/src/server.ts"
      via: "WalletContext import + walletName property"
      pattern: "WalletContext|walletName"
    - from: "packages/mcp/src/index.ts"
      to: "packages/mcp/src/session-manager.ts"
      via: "walletId option for token path"
      pattern: "walletId.*WAIAAS_WALLET_ID"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/mcp-setup.ts"
      via: "wallet option passed to mcpSetupCommand"
      pattern: "wallet.*opts\\.wallet"
---

<objective>
MCP 서버와 CLI의 모든 agent 용어를 wallet으로 변경한다.

Purpose: MCP WalletContext 인터페이스, withWalletPrefix, CLI --wallet 플래그, WAIAAS_WALLET_ID/WAIAAS_WALLET_NAME 환경변수, mcp-tokens/<walletId> 경로가 wallet 용어를 사용하도록 하여, AI 에이전트가 walletId 기반으로 지갑에 접근할 수 있게 한다.
Output: MCP 패키지 13개 소스 + 3개 테스트 + CLI 패키지 3개 소스 + 2개 테스트 갱신
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP server + tools + resources + entrypoint + session-manager rename</name>
  <files>
    packages/mcp/src/server.ts
    packages/mcp/src/index.ts
    packages/mcp/src/session-manager.ts
    packages/mcp/src/tools/send-token.ts
    packages/mcp/src/tools/get-balance.ts
    packages/mcp/src/tools/get-address.ts
    packages/mcp/src/tools/get-assets.ts
    packages/mcp/src/tools/list-transactions.ts
    packages/mcp/src/tools/get-transaction.ts
    packages/mcp/src/tools/get-nonce.ts
    packages/mcp/src/resources/wallet-balance.ts
    packages/mcp/src/resources/wallet-address.ts
    packages/mcp/src/resources/system-status.ts
    packages/cli/src/index.ts
    packages/cli/src/commands/mcp-setup.ts
    packages/cli/src/utils/slug.ts
  </files>
  <action>
    **MCP server.ts:**
    - Rename `AgentContext` interface to `WalletContext`, field `agentName` to `walletName`
    - Rename `withAgentPrefix` to `withWalletPrefix`, param `agentName` to `walletName`
    - Rename `agentContext` param to `walletContext` in `createMcpServer`
    - Update all references: `agentContext?.agentName` -> `walletContext?.walletName`
    - Update JSDoc comment: "AgentContext" -> "WalletContext", "agentName" -> "walletName"

    **MCP index.ts (entrypoint):**
    - `WAIAAS_AGENT_ID` -> `WAIAAS_WALLET_ID`
    - `WAIAAS_AGENT_NAME` -> `WAIAAS_WALLET_NAME`
    - `AGENT_ID` const -> `WALLET_ID`
    - `AGENT_NAME` const -> `WALLET_NAME`
    - `agentId` -> `walletId` in SessionManager options
    - `agentName` -> `walletName` in createMcpServer call and log message
    - Log message: "Agent:" -> "Wallet:" in console.error

    **MCP session-manager.ts:**
    - `SessionManagerOptions.agentId` -> `walletId`
    - `this.agentId` -> `this.walletId`
    - Comments: "agentId" -> "walletId", "Per-agent" -> "Per-wallet"
    - `resolveTokenPath()` comment: "agentId set: DATA_DIR/mcp-tokens/<agentId>" -> "walletId set: DATA_DIR/mcp-tokens/<walletId>"
    - Legacy path comment: keep backward-compat reference (TOKEN-03)
    - `readMcpToken()`: `this.agentId` -> `this.walletId`

    **MCP 7 tools (send-token, get-balance, get-address, get-assets, list-transactions, get-transaction, get-nonce):**
    - Each file: `import { type AgentContext, withAgentPrefix }` -> `import { type WalletContext, withWalletPrefix }`
    - Parameter type `agentContext?: AgentContext` -> `walletContext?: WalletContext`
    - `withAgentPrefix(...)` -> `withWalletPrefix(...)`
    - `agentContext?.agentName` -> `walletContext?.walletName`
    - Description text: "agent wallet" -> "wallet" where it appears (e.g., "Send SOL/ETH or tokens from the agent wallet" -> "Send SOL/ETH or tokens from the wallet")
    - JSDoc comments: "agent wallet" -> "wallet"

    **MCP 3 resources (wallet-balance, wallet-address, system-status):**
    - Same import/type/function rename pattern as tools
    - Description text: "agent wallet" -> "wallet"

    **CLI index.ts:**
    - `.option('--agent <id>', 'Agent ID...')` -> `.option('--wallet <id>', 'Wallet ID (auto-detected if only one)')`
    - `.option('--all', 'Set up all agents at once')` -> `.option('--all', 'Set up all wallets at once')`
    - `agent?: string` -> `wallet?: string` in opts type
    - `agent: opts.agent` -> `wallet: opts.wallet` in mcpSetupCommand call

    **CLI mcp-setup.ts:**
    - `McpSetupOptions.agent` -> `.wallet`
    - `AgentInfo` interface -> `WalletInfo`
    - `fetchAgents` function -> `fetchWallets`
    - `/v1/agents` -> `/v1/wallets` in fetch URL
    - Error messages: "agents" -> "wallets" (e.g., "No agents found" -> "No wallets found", "Multiple agents found. Specify --agent" -> "Multiple wallets found. Specify --wallet")
    - `setupAgent` function -> `setupWallet`, `agentId` param -> `walletId`
    - Session creation body: `agentId: opts.agentId` -> `walletId: opts.walletId`
    - Token path: `mcp-tokens/<agentId>` keeps same structure but var name changes to walletId
    - `buildConfigEntry`: `agentId` -> `walletId`, `agentName` -> `walletName`
    - Environment variables in config: `WAIAAS_AGENT_ID` -> `WAIAAS_WALLET_ID`, `WAIAAS_AGENT_NAME` -> `WAIAAS_WALLET_NAME`
    - Step 7 print: "Agent: ${agentId}" -> "Wallet: ${walletId}"
    - All local variable names: `agentId` -> `walletId`, `agentName` -> `walletName`
    - `opts.all && opts.agent` -> `opts.all && opts.wallet`
    - `opts.agent` -> `opts.wallet` throughout
    - JSDoc: all "agent" references -> "wallet"

    **CLI slug.ts:**
    - `toSlug` fallback: `return slug || 'agent'` -> `return slug || 'wallet'`
    - Comments: "agent name" -> "wallet name", "agent names" -> "wallet names"
    - `resolveSlugCollisions` param type comment: "agents" -> "wallets"
    - JSDoc: "Convert agent name" -> "Convert wallet name"
    - `agentId` references in JSDoc -> `walletId`

    **IMPORTANT:** In `createMcpServer` (server.ts), update all 10 registration calls to pass `walletContext` instead of `agentContext`.
  </action>
  <verify>
    Run `grep -r 'AgentContext\|withAgentPrefix\|agentContext\|WAIAAS_AGENT_ID\|WAIAAS_AGENT_NAME' packages/mcp/src/ packages/cli/src/ --include='*.ts' | grep -v __tests__ | grep -v node_modules` and confirm 0 results.
    Run `npx tsc --noEmit -p packages/mcp/tsconfig.json` and `npx tsc --noEmit -p packages/cli/tsconfig.json` both pass.
  </verify>
  <done>
    All 16 MCP + CLI source files use wallet terminology. No AgentContext, withAgentPrefix, WAIAAS_AGENT_ID, or WAIAAS_AGENT_NAME remain in source (excluding tests). TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP + CLI test files wallet terminology update + test pass</name>
  <files>
    packages/mcp/src/__tests__/server.test.ts
    packages/mcp/src/__tests__/session-manager.test.ts
    packages/mcp/src/__tests__/tools.test.ts
    packages/cli/src/__tests__/mcp-setup.test.ts
    packages/cli/src/__tests__/slug.test.ts
  </files>
  <action>
    **MCP server.test.ts:**
    - Import rename: `withAgentPrefix` -> `withWalletPrefix`, `AgentContext` not imported (if was)
    - All test descriptions: "agentName" -> "walletName", "withAgentPrefix" -> "withWalletPrefix"
    - Test calls: `withAgentPrefix(...)` -> `withWalletPrefix(...)`
    - `createMcpServer(apiClient, { agentName: 'trading-bot' })` -> `createMcpServer(apiClient, { walletName: 'trading-bot' })`
    - Test description text: "agentName 미설정 시" -> "walletName 미설정 시", "agentName 설정 시" -> "walletName 설정 시"

    **MCP session-manager.test.ts:**
    - `agentId` option -> `walletId` in all SessionManager constructor calls
    - Test descriptions: "agentId" -> "walletId"
    - Path expectations: `mcp-tokens/agent-1` stays same (value is ID, not label) -- but the option name changes
    - describe block: "agentId token path" -> "walletId token path"
    - Variable `agt` in JWT payloads: leave as-is if it's testing JWT claim (agt was renamed to wlt in Phase 91, but test may use sub)
    - Check JWT payloads: `{ agt: 'agent-1' }` -> `{ wlt: 'agent-1' }` if testing new JWT format (Phase 91 changed JWT claim)

    **MCP tools.test.ts:**
    - `agentId: 'agent-1'` in mock response data -> `walletId: 'wallet-1'` (matches daemon response field changes from Phase 91)

    **CLI mcp-setup.test.ts:**
    - All `agentId` / `agentName` / `agents` references:
      - `createSuccessFetchMock(agentId, agentName)` -> `createSuccessFetchMock(walletId, walletName)`
      - `/v1/agents` in URL checks -> `/v1/wallets`
      - `{ id: agentId, name: agentName }` -> `{ id: walletId, name: walletName }`
      - `body.agentId` -> `body.walletId`
      - `agent: 'my-custom-agent'` -> `wallet: 'my-custom-wallet'`
      - Error messages: "Multiple agents found" -> "Multiple wallets found"
      - Error messages: "No agents found" -> "No wallets found"
      - Output expectations: "Auto-detected agent:" -> "Auto-detected wallet:"
      - Output expectations: "Agent:" -> "Wallet:"
      - `WAIAAS_AGENT_ID` -> `WAIAAS_WALLET_ID`
      - `WAIAAS_AGENT_NAME` -> `WAIAAS_WALLET_NAME`
    - Test description text: "auto-detect agent" -> "auto-detect wallet", "--agent flag" -> "--wallet flag", etc.
    - Comment "multi-agent support" -> "multi-wallet support"

    **CLI slug.test.ts:**
    - `'agent'` fallback expectations -> `'wallet'`
    - Comments: "multi-agent" -> "multi-wallet"
    - Test descriptions: "returns 'agent' for empty string" -> "returns 'wallet' for empty string" etc.
    - Variable names `agents` -> `wallets` in test data
    - `agents[0]!.id` -> `wallets[0]!.id` etc.
    - `agentId first 8 chars` -> `walletId first 8 chars`

    Run `pnpm test --filter @waiaas/mcp --filter @waiaas/cli` to verify all tests pass.
  </action>
  <verify>
    `pnpm test --filter @waiaas/mcp --filter @waiaas/cli` passes.
    `grep -r 'AgentContext\|withAgentPrefix\|WAIAAS_AGENT_ID\|WAIAAS_AGENT_NAME\|fetchAgents\b' packages/mcp/ packages/cli/ --include='*.ts' | grep -v node_modules` returns 0 results.
  </verify>
  <done>
    All MCP and CLI tests pass with wallet terminology. Zero occurrences of AgentContext, withAgentPrefix, WAIAAS_AGENT_ID, WAIAAS_AGENT_NAME, or fetchAgents in the MCP and CLI packages.
  </done>
</task>

</tasks>

<verification>
1. `grep -r 'AgentContext\|withAgentPrefix\|WAIAAS_AGENT_ID\|WAIAAS_AGENT_NAME' packages/mcp/ packages/cli/ --include='*.ts' | grep -v node_modules` returns 0 results
2. `grep -r 'fetchAgents\b' packages/mcp/ packages/cli/ --include='*.ts' | grep -v node_modules` returns 0 results
3. `pnpm test --filter @waiaas/mcp --filter @waiaas/cli` all tests pass
4. `npx tsc --noEmit -p packages/mcp/tsconfig.json && npx tsc --noEmit -p packages/cli/tsconfig.json` both pass
</verification>

<success_criteria>
- WalletContext interface exists in MCP server.ts, AgentContext 0건
- withWalletPrefix function exists, withAgentPrefix 0건
- CLI --wallet flag works, --agent 미존재
- WAIAAS_WALLET_ID/WAIAAS_WALLET_NAME env vars used by MCP entrypoint
- mcp-tokens/<walletId> path used for token storage
- All MCP + CLI tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/92-mcp-cli-sdk/92-01-SUMMARY.md`
</output>
