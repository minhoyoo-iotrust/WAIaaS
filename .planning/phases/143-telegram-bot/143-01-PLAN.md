---
phase: 143-telegram-bot
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
  - packages/daemon/src/infrastructure/telegram/telegram-api.ts
  - packages/daemon/src/infrastructure/telegram/telegram-types.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/telegram-bot-service.test.ts
autonomous: true

must_haves:
  truths:
    - "telegram_users 테이블이 DB 마이그레이션 v15로 생성된다"
    - "TelegramBotService가 Long Polling으로 getUpdates를 호출하여 명령을 수신한다"
    - "/start 명령으로 chat_id가 telegram_users에 PENDING으로 등록된다"
    - "/help 명령으로 사용 가능한 명령어 도움말이 출력된다"
    - "/status 명령으로 데몬 상태와 월렛 요약이 조회된다"
    - "DaemonLifecycle에서 TelegramBotService가 fail-soft로 초기화된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v15 telegram_users 마이그레이션"
      contains: "CREATE TABLE.*telegram_users"
    - path: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      provides: "Long Polling 봇 서비스"
      exports: ["TelegramBotService"]
    - path: "packages/daemon/src/infrastructure/telegram/telegram-api.ts"
      provides: "Telegram Bot API fetch 래퍼"
      exports: ["TelegramApi"]
    - path: "packages/daemon/src/infrastructure/telegram/telegram-types.ts"
      provides: "Telegram API 타입 정의"
  key_links:
    - from: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      to: "packages/daemon/src/infrastructure/telegram/telegram-api.ts"
      via: "TelegramApi 인스턴스"
      pattern: "TelegramApi"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      via: "Step 4c-5 fail-soft 초기화"
      pattern: "TelegramBotService"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "MIGRATIONS.push v15 + telegramUsers Drizzle 테이블"
      pattern: "version: 15"
---

<objective>
TelegramBotService 코어 인프라를 구축하고 기본 명령어(/start, /help, /status)를 구현한다.

Purpose: Telegram Bot의 Long Polling 기반 메시지 수신 인프라, DB 마이그레이션(telegram_users 테이블), config/settings 통합, DaemonLifecycle 연동을 완성하여 이후 Plan 02/03에서 인증 및 추가 명령어를 구현할 기반을 마련한다.
Output: TelegramBotService + telegram_users 마이그레이션 + /start, /help, /status 명령어 동작
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@objectives/v1.6-desktop-telegram-docker.md

# 패턴 참조
@packages/daemon/src/services/kill-switch-service.ts (SQLite 직접 접근 패턴)
@packages/daemon/src/services/autostop-service.ts (서비스 패턴 + EventBus)
@packages/daemon/src/notifications/channels/telegram.ts (기존 TelegramChannel - 알림 전용)
@packages/daemon/src/infrastructure/database/migrate.ts (마이그레이션 패턴)
@packages/daemon/src/infrastructure/database/schema.ts (Drizzle 스키마)
@packages/daemon/src/infrastructure/config/loader.ts (config.toml 스키마)
@packages/daemon/src/infrastructure/settings/setting-keys.ts (SETTING_DEFINITIONS)
@packages/daemon/src/lifecycle/daemon.ts (DaemonLifecycle 초기화)
@packages/core/src/i18n/en.ts (i18n 메시지 구조)
@packages/core/src/i18n/ko.ts (i18n 한글 메시지)
@packages/core/src/enums/notification.ts (NotificationEventType)
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB 마이그레이션 v15 + Drizzle 스키마 + config/settings 확장</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
  </files>
  <action>
    1. **migrate.ts** -- v15 마이그레이션 추가:
       ```
       MIGRATIONS.push({
         version: 15,
         description: 'Create telegram_users table for Telegram Bot user management',
         up: (sqlite) => {
           sqlite.exec(`CREATE TABLE IF NOT EXISTS telegram_users (
             chat_id INTEGER PRIMARY KEY,
             username TEXT,
             role TEXT NOT NULL DEFAULT 'PENDING' CHECK (role IN ('PENDING', 'ADMIN', 'READONLY')),
             registered_at INTEGER NOT NULL,
             approved_at INTEGER
           )`);
           sqlite.exec('CREATE INDEX IF NOT EXISTS idx_telegram_users_role ON telegram_users(role)');
         },
       });
       ```
       LATEST_SCHEMA_VERSION을 14에서 15로 변경.
       getCreateTableStatements()에 Table 13: telegram_users DDL 추가.
       getCreateIndexStatements()에 idx_telegram_users_role 추가.

    2. **schema.ts** -- telegramUsers Drizzle 테이블 추가 (Table 13):
       ```typescript
       export const telegramUsers = sqliteTable(
         'telegram_users',
         {
           chatId: integer('chat_id').primaryKey(),
           username: text('username'),
           role: text('role').notNull().default('PENDING'),
           registeredAt: integer('registered_at', { mode: 'timestamp' }).notNull(),
           approvedAt: integer('approved_at', { mode: 'timestamp' }),
         },
         (table) => [
           index('idx_telegram_users_role').on(table.role),
           check('check_telegram_role', sql`role IN ('PENDING', 'ADMIN', 'READONLY')`),
         ],
       );
       ```
       파일 상단 주석의 테이블 수를 11에서 12로 변경 (telegram_users 추가).

    3. **loader.ts** -- DaemonConfigSchema에 telegram 섹션 추가 (기존 notifications 섹션과 별도):
       ```typescript
       telegram: z.object({
         enabled: z.boolean().default(false),
         bot_token: z.string().default(''),
         locale: z.enum(['en', 'ko']).default('en'),
       }).default({}),
       ```
       KNOWN_SECTIONS 배열에 'telegram' 추가.
       주의: 기존 notifications.telegram_bot_token은 알림 발송 전용이고, telegram.bot_token은 Bot 수신 전용이지만 동일 토큰을 사용할 수 있다. 별도 섹션으로 분리하여 Bot 서비스 활성화를 독립적으로 제어한다.

    4. **setting-keys.ts** -- telegram 카테고리 SETTING_DEFINITIONS 추가:
       ```typescript
       // --- telegram category (Bot service settings) ---
       { key: 'telegram.enabled', category: 'telegram', configPath: 'telegram.enabled', defaultValue: 'false', isCredential: false },
       { key: 'telegram.bot_token', category: 'telegram', configPath: 'telegram.bot_token', defaultValue: '', isCredential: true },
       { key: 'telegram.locale', category: 'telegram', configPath: 'telegram.locale', defaultValue: 'en', isCredential: false },
       ```
       SETTING_CATEGORIES 배열에 'telegram' 추가.
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/migration-chain.test.ts` -- 마이그레이션 체인 테스트 통과
    `pnpm -C packages/daemon exec tsc --noEmit` -- 타입 체크 통과
    `pnpm -C packages/core exec tsc --noEmit` -- core 타입 체크 통과
  </verify>
  <done>
    telegram_users 테이블이 v15 마이그레이션으로 생성되고, LATEST_SCHEMA_VERSION=15이며, Drizzle 스키마/config.toml/Admin Settings에 telegram 관련 정의가 존재한다. 기존 마이그레이션 체인 테스트가 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: TelegramBotService Long Polling + /start, /help, /status + DaemonLifecycle + i18n</name>
  <files>
    packages/daemon/src/infrastructure/telegram/telegram-types.ts
    packages/daemon/src/infrastructure/telegram/telegram-api.ts
    packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
    packages/daemon/src/infrastructure/telegram/index.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/__tests__/telegram-bot-service.test.ts
  </files>
  <action>
    1. **telegram-types.ts** -- Telegram Bot API 타입 정의 (Zod 불필요, 내부 인터페이스):
       ```typescript
       export interface TelegramUpdate {
         update_id: number;
         message?: TelegramMessage;
         callback_query?: TelegramCallbackQuery;
       }
       export interface TelegramMessage {
         message_id: number;
         from?: TelegramUser;
         chat: TelegramChat;
         text?: string;
         date: number;
       }
       export interface TelegramUser {
         id: number;
         is_bot: boolean;
         first_name: string;
         username?: string;
       }
       export interface TelegramChat { id: number; type: string; }
       export interface TelegramCallbackQuery {
         id: string;
         from: TelegramUser;
         message?: TelegramMessage;
         data?: string;
       }
       export interface TelegramInlineKeyboardButton {
         text: string;
         callback_data?: string;
       }
       export interface TelegramInlineKeyboardMarkup {
         inline_keyboard: TelegramInlineKeyboardButton[][];
       }
       export type TelegramUserRole = 'PENDING' | 'ADMIN' | 'READONLY';
       ```

    2. **telegram-api.ts** -- Telegram Bot API fetch 래퍼 (sendMessage, getUpdates, answerCallbackQuery):
       ```typescript
       export class TelegramApi {
         constructor(private botToken: string) {}

         async getUpdates(offset: number, timeout: number): Promise<TelegramUpdate[]> {
           const url = `https://api.telegram.org/bot${this.botToken}/getUpdates`;
           const res = await fetch(url, {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ offset, timeout, allowed_updates: ['message', 'callback_query'] }),
             signal: AbortSignal.timeout((timeout + 5) * 1000),
           });
           if (!res.ok) throw new Error(`Telegram API error: ${res.status}`);
           const data = await res.json() as { ok: boolean; result: TelegramUpdate[] };
           if (!data.ok) throw new Error('Telegram API returned ok=false');
           return data.result;
         }

         async sendMessage(chatId: number, text: string, replyMarkup?: TelegramInlineKeyboardMarkup): Promise<void> {
           const url = `https://api.telegram.org/bot${this.botToken}/sendMessage`;
           const body: Record<string, unknown> = { chat_id: chatId, text, parse_mode: 'MarkdownV2' };
           if (replyMarkup) body.reply_markup = replyMarkup;
           const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
           if (!res.ok) { const b = await res.text(); throw new Error(`sendMessage failed: ${res.status} ${b}`); }
         }

         async answerCallbackQuery(callbackQueryId: string, text?: string): Promise<void> {
           const url = `https://api.telegram.org/bot${this.botToken}/answerCallbackQuery`;
           const body: Record<string, unknown> = { callback_query_id: callbackQueryId };
           if (text) body.text = text;
           await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
         }
       }
       ```
       AbortSignal.timeout 사용 (Node.js 22 내장). 외부 라이브러리 없음.

    3. **telegram-bot-service.ts** -- 핵심 Bot 서비스:
       - **생성자 DI**: `{ sqlite, api, locale, notificationService?, killSwitchService?, settingsService? }`
         - sqlite: better-sqlite3 Database (직접 SQL, KillSwitchService 패턴 동일)
       - **Long Polling 루프** (`start()`):
         - `this.running = true`, while 루프에서 `api.getUpdates(offset, 30)` 호출
         - 성공 시 각 update 처리, offset = lastUpdate.update_id + 1
         - 에러 시 지수 백오프 (1s, 2s, 4s, 8s, 16s, max 30s), 성공 시 backoff 리셋
         - `stop()` 호출 시 `this.running = false`로 루프 종료
       - **명령 라우터** (`handleUpdate(update)`):
         - message.text가 '/' 시작이면 명령 파싱 (첫 단어 = 명령, 나머지 = 인자)
         - callback_query면 콜백 데이터 파싱 (Plan 02에서 구현, 여기선 stub)
         - 각 명령 핸들러에 분기: handleStart, handleHelp, handleStatus
       - **handleStart(chatId, username)**:
         - sqlite로 telegram_users에 INSERT OR IGNORE (chat_id PK, role='PENDING', registered_at=now)
         - 이미 등록된 경우 환영 메시지, 신규 등록이면 "관리자 승인 대기" 메시지
         - i18n: `getMessages(locale).telegram.bot_welcome` / `bot_pending_approval`
       - **handleHelp(chatId)**:
         - 사용 가능 명령어 목록 전송 (i18n)
       - **handleStatus(chatId)**:
         - 데몬 상태: process.uptime(), kill switch 상태, 월렛 수/활성 수
         - sqlite로 `SELECT COUNT(*) FROM wallets`, `SELECT COUNT(*) FROM wallets WHERE status='ACTIVE'`
         - sqlite로 `SELECT COUNT(*) FROM sessions WHERE revoked_at IS NULL AND expires_at > unixepoch()` (활성 세션)
         - Kill Switch 상태: killSwitchService?.getState() 결과
         - 결과를 MarkdownV2 포매팅하여 전송
       - **MarkdownV2 이스케이프** 유틸: 기존 TelegramChannel.formatMarkdownV2 패턴 재사용
         `const escape = (s: string) => s.replace(/([_*[\]()~`>#+\-=|{}.!\\])/g, '\\$1');`

    4. **index.ts** -- barrel export:
       ```typescript
       export { TelegramBotService } from './telegram-bot-service.js';
       export { TelegramApi } from './telegram-api.js';
       export type { TelegramUserRole } from './telegram-types.js';
       ```

    5. **i18n en.ts / ko.ts** -- Messages 인터페이스에 telegram 섹션 추가:
       Messages 인터페이스(en.ts)에 추가:
       ```typescript
       telegram: {
         bot_welcome: string;
         bot_pending_approval: string;
         bot_already_registered: string;
         bot_help: string;
         bot_status_header: string;
         bot_status_body: string;
         bot_unauthorized: string;
         bot_admin_only: string;
         bot_pending_list_header: string;
         bot_pending_empty: string;
         bot_approve_success: string;
         bot_reject_success: string;
         bot_tx_not_found: string;
         bot_killswitch_confirm: string;
         bot_killswitch_success: string;
         bot_killswitch_cancelled: string;
         bot_wallets_header: string;
         bot_wallets_empty: string;
         bot_newsession_select: string;
         bot_newsession_created: string;
         keyboard_approve: string;
         keyboard_reject: string;
         keyboard_yes: string;
         keyboard_no: string;
       };
       ```
       영문 메시지 값:
       - bot_welcome: "Welcome to WAIaaS Bot\\! Your chat has been registered\\."
       - bot_pending_approval: "Your registration is pending admin approval\\."
       - bot_already_registered: "You are already registered\\."
       - bot_help: 전체 명령어 목록 (MarkdownV2)
       - bot_status_header: "Daemon Status"
       - bot_status_body: "Uptime: {uptime}\\nKill Switch: {killSwitch}\\nWallets: {walletCount} \\({activeCount} active\\)\\nSessions: {sessionCount} active"
       - bot_unauthorized: "You are not authorized\\. Please contact admin\\."
       - bot_admin_only: "This command requires admin privileges\\."
       - (나머지는 Plan 02/03에서 사용하지만 미리 정의)

       한글 메시지(ko.ts)도 동일 키로 한글 값 작성.

    6. **daemon.ts** -- Step 4c-5: TelegramBotService 초기화 (fail-soft):
       - Step 4c-4 (BalanceMonitor) 뒤에 추가
       - 필드 추가: `private telegramBotService: TelegramBotService | null = null;`
       - config.telegram.enabled && config.telegram.bot_token이 있을 때만 초기화
       - `const { TelegramBotService, TelegramApi } = await import('../infrastructure/telegram/index.js');`
       - `const api = new TelegramApi(config.telegram.bot_token);`
       - `this.telegramBotService = new TelegramBotService({ sqlite, api, locale: config.telegram.locale ?? config.notifications.locale ?? 'en', killSwitchService, notificationService, settingsService });`
       - `this.telegramBotService.start();` (비동기 Long Polling 시작, await하지 않음 -- fire-and-forget)
       - console.log('Step 4c-5: Telegram Bot started');
       - shutdown()에서 `this.telegramBotService?.stop(); this.telegramBotService = null;` 추가 (AutoStop/BalanceMonitor와 동일 위치)

    7. **telegram-bot-service.test.ts** -- 테스트 (15-20개):
       - TelegramApi mock (getUpdates, sendMessage, answerCallbackQuery)
       - better-sqlite3 인메모리 DB + pushSchema
       - /start: 신규 등록 시 telegram_users INSERT + PENDING role 확인 + 환영 메시지 sendMessage 호출
       - /start: 중복 등록 시 이미 등록 메시지
       - /help: sendMessage에 명령어 목록 포함 확인
       - /status: uptime, kill switch 상태, 월렛 수 포함 확인
       - Long Polling: getUpdates 반환 후 offset 증가 확인
       - Long Polling: getUpdates 에러 시 백오프 증가 확인 (1s -> 2s -> 4s)
       - Long Polling: 성공 후 백오프 리셋 확인
       - stop() 호출 시 running=false 전환 확인
       - i18n: locale='ko' 시 한글 메시지 확인
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-service.test.ts` -- 모든 테스트 통과
    `pnpm -C packages/daemon exec tsc --noEmit` -- 타입 체크 통과
    `pnpm -C packages/core exec tsc --noEmit` -- core i18n 타입 체크 통과 (Messages 인터페이스 확장)
  </verify>
  <done>
    TelegramBotService가 Long Polling으로 getUpdates를 호출하고, /start로 chat_id가 PENDING으로 등록되며, /help로 명령어 목록, /status로 데몬 상태+월렛 요약이 MarkdownV2 포매팅으로 전송된다. DaemonLifecycle Step 4c-5에서 fail-soft 초기화된다. 15개 이상 테스트가 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm -C packages/core exec tsc --noEmit` -- core 패키지 타입 체크
2. `pnpm -C packages/daemon exec tsc --noEmit` -- daemon 패키지 타입 체크
3. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/migration-chain.test.ts` -- 마이그레이션 체인 (v1→v15 전체 경로)
4. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-service.test.ts` -- Bot 서비스 테스트
5. `pnpm -C packages/daemon exec vitest run` -- daemon 전체 테스트 회귀 없음
</verification>

<success_criteria>
- telegram_users 테이블이 v15 마이그레이션으로 생성되고 체인 테스트 통과
- TelegramBotService가 Long Polling 루프를 실행하고 지수 백오프 재연결 지원
- /start, /help, /status 3개 명령어가 i18n(en/ko) 메시지로 응답
- DaemonLifecycle Step 4c-5에서 fail-soft 초기화/shutdown 정리
- 15개 이상 신규 테스트 통과, 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/143-telegram-bot/143-01-SUMMARY.md`
</output>
