---
phase: 143-telegram-bot
plan: 03
type: execute
wave: 3
depends_on: ["143-02"]
files_modified:
  - packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
  - packages/daemon/src/infrastructure/telegram/telegram-keyboard.ts
  - packages/daemon/src/__tests__/telegram-bot-advanced.test.ts
  - packages/daemon/src/__tests__/telegram-reconnect.test.ts
autonomous: true

must_haves:
  truths:
    - "/killswitch 명령이 확인 대화(Yes/No 인라인 키보드)를 보여주고, Yes 클릭 시 Kill Switch가 발동된다"
    - "/newsession 명령이 월렛 선택 인라인 키보드를 보여주고, 선택 시 세션이 발급된다"
    - "네트워크 단절 시 지수 백오프(1s, 2s, 4s, max 30s)로 자동 재연결된다"
    - "모든 Bot 메시지가 config.toml locale 설정에 따라 en/ko로 출력된다"
    - "Kill Switch 확인 후 No를 클릭하면 발동이 취소된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/telegram/telegram-keyboard.ts"
      provides: "인라인 키보드 빌더 유틸"
      exports: ["buildConfirmKeyboard", "buildWalletSelectKeyboard", "buildApprovalKeyboard"]
    - path: "packages/daemon/src/__tests__/telegram-bot-advanced.test.ts"
      provides: "/killswitch, /newsession, i18n 테스트"
    - path: "packages/daemon/src/__tests__/telegram-reconnect.test.ts"
      provides: "지수 백오프 재연결 테스트"
  key_links:
    - from: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      to: "packages/daemon/src/services/kill-switch-service.ts"
      via: "killSwitchService.activateWithCascade()"
      pattern: "activateWithCascade"
    - from: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      to: "packages/daemon/src/infrastructure/telegram/telegram-keyboard.ts"
      via: "buildConfirmKeyboard, buildWalletSelectKeyboard"
      pattern: "buildConfirmKeyboard|buildWalletSelectKeyboard"
---

<objective>
Kill Switch 확인 대화, 세션 발급, 인라인 키보드 빌더, 재연결 로직을 구현하여 Telegram Bot 기능을 완성한다.

Purpose: /killswitch(확인 대화 후 Kill Switch 발동)과 /newsession(월렛 선택 후 세션 발급) 명령어를 추가하고, 인라인 키보드 빌더를 분리하며, Long Polling 재연결 지수 백오프를 정교하게 테스트하여 Phase 143 전체 요구사항을 충족한다.
Output: /killswitch, /newsession 명령어 + 인라인 키보드 빌더 + 재연결 테스트 + i18n 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/143-telegram-bot/143-01-SUMMARY.md
@.planning/phases/143-telegram-bot/143-02-SUMMARY.md

# 패턴 참조
@packages/daemon/src/services/kill-switch-service.ts (activateWithCascade, getState)
@packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts (기존 서비스 -- Plan 01/02에서 구현)
@packages/daemon/src/infrastructure/telegram/telegram-types.ts (타입 정의)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 인라인 키보드 빌더 + /killswitch 확인 대화 + /newsession 월렛 선택</name>
  <files>
    packages/daemon/src/infrastructure/telegram/telegram-keyboard.ts
    packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
    packages/daemon/src/infrastructure/telegram/index.ts
    packages/daemon/src/__tests__/telegram-bot-advanced.test.ts
  </files>
  <action>
    1. **telegram-keyboard.ts** -- 인라인 키보드 빌더 유틸:
       ```typescript
       import type { TelegramInlineKeyboardMarkup } from './telegram-types.js';
       import type { Messages } from '@waiaas/core';

       /** Kill Switch 확인 키보드 (Yes/No 버튼) */
       export function buildConfirmKeyboard(msgs: Messages['telegram']): TelegramInlineKeyboardMarkup {
         return {
           inline_keyboard: [[
             { text: msgs.keyboard_yes, callback_data: 'killswitch:confirm' },
             { text: msgs.keyboard_no, callback_data: 'killswitch:cancel' },
           ]],
         };
       }

       /** 월렛 선택 키보드 (월렛 ID/이름 버튼 목록) */
       export function buildWalletSelectKeyboard(
         wallets: Array<{ id: string; name: string }>,
       ): TelegramInlineKeyboardMarkup {
         return {
           inline_keyboard: wallets.map((w) => [
             { text: `${w.name}`, callback_data: `newsession:${w.id}` },
           ]),
         };
       }

       /** 거래 승인/거부 키보드 (Approve/Reject 버튼) */
       export function buildApprovalKeyboard(
         txId: string,
         msgs: Messages['telegram'],
       ): TelegramInlineKeyboardMarkup {
         return {
           inline_keyboard: [[
             { text: msgs.keyboard_approve, callback_data: `approve:${txId}` },
             { text: msgs.keyboard_reject, callback_data: `reject:${txId}` },
           ]],
         };
       }
       ```
       index.ts barrel export에 추가.

    2. **telegram-bot-service.ts** -- /killswitch, /newsession 추가 + 기존 /pending에 buildApprovalKeyboard 적용:
       - **handleKillswitch(chatId)**:
         - Kill Switch 현재 상태 조회: `killSwitchService.getState()`
         - 이미 SUSPENDED/LOCKED이면 "이미 활성화 상태" 메시지 전송
         - ACTIVE이면 확인 대화 전송:
           - `api.sendMessage(chatId, msgs.bot_killswitch_confirm, buildConfirmKeyboard(msgs))`
           - (확인 키보드 callback_data로 'killswitch:confirm' / 'killswitch:cancel')
       - **callback_query 'killswitch:confirm'** 처리:
         - `killSwitchService.activateWithCascade('telegram:' + chatId)`
         - 성공 시: bot_killswitch_success 메시지 + answerCallbackQuery
         - 실패 시: 에러 메시지 (이미 활성화 등)
       - **callback_query 'killswitch:cancel'** 처리:
         - bot_killswitch_cancelled 메시지 + answerCallbackQuery
       - **handleNewSession(chatId)**:
         - ACTIVE 월렛 목록 조회: `SELECT id, name FROM wallets WHERE status = 'ACTIVE'`
         - 월렛 없으면 bot_wallets_empty 메시지
         - 월렛 있으면 선택 키보드: `api.sendMessage(chatId, msgs.bot_newsession_select, buildWalletSelectKeyboard(wallets))`
       - **callback_query 'newsession:{walletId}'** 처리:
         - 세션 생성: uuid v7 세션 ID, JWT HS256 토큰 생성
         - sqlite 직접 INSERT: sessions 테이블에 새 세션 삽입
           - wallet_id, token_hash(SHA-256), expires_at(config TTL), constraints(null), renewal_count(0), max_renewals(30), absolute_expires_at, created_at
         - JwtSecretManager가 필요하므로 생성자 DI에 jwtSecretManager 추가
         - 또는: sqlite로 직접 sessions 레코드만 삽입하고, 실제 JWT 토큰은 REST API로 생성하도록 안내하는 방식.
         - **구현 결정**: 보안상 Telegram에서 직접 JWT를 생성하는 것은 복잡도가 높다. 대신 REST API의 POST /v1/sessions를 내부 호출하지 않고, sqlite로 세션 레코드를 삽입한 뒤 세션 ID만 반환하고 "이 세션 ID로 REST API를 통해 토큰을 획득하세요"라고 안내한다.
         - 실제로 더 단순한 구현: DaemonLifecycle에서 주입받는 jwtSecretManager + masterPassword로 JWT 생성.
           ```
           import { createHmac } from 'node:crypto';
           import { SignJWT } from 'jose';
           ```
           - JWT 생성: jose로 HS256 서명 (jwtSecretManager.getActiveSecret() 사용)
           - 토큰 해시: `createHash('sha256').update(token).digest('hex')` -> sessions.token_hash
           - 세션 INSERT -> 토큰을 사용자에게 전송 (MarkdownV2 monospace)
         - 감사 로그 INSERT: event_type='SESSION_ISSUED_VIA_TELEGRAM'
       - **기존 /pending의 인라인 키보드**: buildApprovalKeyboard() 사용하도록 리팩토링

    3. **telegram-bot-advanced.test.ts** -- 테스트 (15-20개):
       - buildConfirmKeyboard: Yes/No 버튼 + callback_data 확인
       - buildWalletSelectKeyboard: 월렛 3개 -> 3행 키보드
       - buildApprovalKeyboard: Approve/Reject 버튼
       - /killswitch: ACTIVE 상태 -> 확인 키보드 전송 확인
       - /killswitch: 이미 SUSPENDED -> "이미 활성화" 메시지
       - callback killswitch:confirm -> activateWithCascade 호출 + 성공 메시지
       - callback killswitch:cancel -> 취소 메시지
       - /newsession: ACTIVE 월렛 2개 -> 선택 키보드 전송
       - /newsession: 월렛 없음 -> 빈 목록 메시지
       - callback newsession:{walletId} -> 세션 생성 + 토큰 전송
       - callback newsession:{walletId} -> sessions 테이블에 레코드 삽입 확인
       - callback newsession:{invalidId} -> 월렛 미존재 에러
       - i18n locale='en' -> 영문 메시지 확인
       - i18n locale='ko' -> 한글 메시지 확인 (keyboard_approve = "승인")
       - /pending에서 buildApprovalKeyboard 사용 확인
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-advanced.test.ts` -- 모든 테스트 통과
    `pnpm -C packages/daemon exec tsc --noEmit` -- 타입 체크 통과
  </verify>
  <done>
    /killswitch가 확인 대화(Yes/No 키보드) 후 Kill Switch를 발동하고, /newsession이 월렛 선택 키보드로 세션을 발급하며, 인라인 키보드 빌더가 3개 유틸 함수로 분리되어 있다. i18n이 en/ko 모두 동작한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: Long Polling 재연결 지수 백오프 테스트 + 전체 통합 검증</name>
  <files>
    packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
    packages/daemon/src/__tests__/telegram-reconnect.test.ts
  </files>
  <action>
    1. **telegram-bot-service.ts** -- 재연결 로직 정교화:
       - Long Polling 루프의 에러 처리를 명확히 분리:
         - 네트워크 에러 (fetch 실패, timeout): 지수 백오프 적용
         - Telegram API 에러 (401 Unauthorized, 409 Conflict): 재시도하지 않고 로그만 남김
         - 최대 백오프 30초 (MAX_BACKOFF = 30_000)
         - 백오프 계산: `Math.min(baseDelay * Math.pow(2, retryCount), MAX_BACKOFF)`
         - baseDelay = 1000ms
         - 성공 시 retryCount = 0으로 리셋
       - 3회 연속 실패 시 console.warn 로그: `Telegram Bot: ${retryCount} consecutive failures, retrying in ${backoff}ms`
       - 로깅 과다 방지: 매 실패마다 로그하지 않고, retryCount가 3의 배수일 때만 warn 로그

    2. **telegram-reconnect.test.ts** -- 재연결 지수 백오프 테스트 (10개):
       - 에러 1회 후 재연결: backoff 1초
       - 에러 2회 연속: backoff 2초
       - 에러 3회 연속: backoff 4초
       - 에러 5회 연속: backoff 16초
       - 에러 6회 이상: backoff max 30초 (cap)
       - 성공 후 에러: backoff 리셋 -> 1초부터 다시 시작
       - Telegram API 401 에러: 재시도하지 않고 stop
       - stop() 호출 시 polling 루프 즉시 종료
       - 네트워크 에러 후 성공적 재연결: 정상 update 처리 확인
       - 3회 실패 시 경고 로그 발생 확인

    3. **전체 통합 확인**:
       - 기존 telegram-bot-service.test.ts (Plan 01) + telegram-bot-auth.test.ts (Plan 02) + 이 테스트들이 모두 통과하는지 확인
       - daemon 전체 테스트 회귀 없음
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-reconnect.test.ts` -- 모든 테스트 통과
    `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-service.test.ts src/__tests__/telegram-bot-auth.test.ts src/__tests__/telegram-bot-advanced.test.ts src/__tests__/telegram-reconnect.test.ts` -- Telegram Bot 전체 테스트 통과
    `pnpm -C packages/daemon exec vitest run` -- daemon 전체 테스트 회귀 없음
  </verify>
  <done>
    Long Polling 재연결이 지수 백오프(1s, 2s, 4s, max 30s)로 동작하고, 성공 시 리셋되며, 401 에러 시 정지한다. Phase 143 전체 14개 요구사항(TGBOT-01~14)이 구현되어 있고 전체 Telegram Bot 테스트가 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm -C packages/core exec tsc --noEmit` -- core 패키지 타입 체크
2. `pnpm -C packages/daemon exec tsc --noEmit` -- daemon 패키지 타입 체크
3. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-service.test.ts` -- Plan 01 테스트
4. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-auth.test.ts` -- Plan 02 인증 테스트
5. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-advanced.test.ts` -- Plan 03 고급 명령어 테스트
6. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-reconnect.test.ts` -- 재연결 테스트
7. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-admin-api.test.ts` -- Plan 02 Admin API 테스트
8. `pnpm -C packages/daemon exec vitest run` -- daemon 전체 테스트 회귀 없음

**TGBOT 요구사항 매핑 최종 확인:**
| 요구사항 | 구현 위치 |
|---------|----------|
| TGBOT-01 Long Polling | Plan 01 Task 2 (telegram-bot-service.ts) |
| TGBOT-02 /start | Plan 01 Task 2 |
| TGBOT-03 /status | Plan 01 Task 2 |
| TGBOT-04 /pending | Plan 02 Task 1 |
| TGBOT-05 /approve | Plan 02 Task 1 |
| TGBOT-06 /reject | Plan 02 Task 1 |
| TGBOT-07 /killswitch | Plan 03 Task 1 |
| TGBOT-08 /wallets | Plan 02 Task 1 |
| TGBOT-09 /newsession | Plan 03 Task 1 |
| TGBOT-10 /help | Plan 01 Task 2 |
| TGBOT-11 2-Tier auth | Plan 02 Task 1 |
| TGBOT-12 지수 백오프 | Plan 03 Task 2 |
| TGBOT-13 i18n | Plan 01 Task 2 + Plan 03 Task 1 |
| TGBOT-14 DB migration | Plan 01 Task 1 |
</verification>

<success_criteria>
- /killswitch: 확인 대화(Yes/No) -> Yes 시 Kill Switch 발동, No 시 취소
- /newsession: 월렛 선택 키보드 -> 선택 시 세션 토큰 발급
- 지수 백오프: 1s, 2s, 4s, 8s, 16s, max 30s, 성공 시 리셋
- i18n: en/ko 전체 Bot 메시지 출력 확인
- Telegram Bot 전체 4개 테스트 파일 통과 (총 55개 이상 신규 테스트)
- daemon 전체 테스트 회귀 없음
- TGBOT-01~14 전체 요구사항 커버
</success_criteria>

<output>
After completion, create `.planning/phases/143-telegram-bot/143-03-SUMMARY.md`
</output>
