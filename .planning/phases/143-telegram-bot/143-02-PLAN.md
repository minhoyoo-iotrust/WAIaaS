---
phase: 143-telegram-bot
plan: 02
type: execute
wave: 2
depends_on: ["143-01"]
files_modified:
  - packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
  - packages/daemon/src/infrastructure/telegram/telegram-auth.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/schemas/admin.ts
  - packages/daemon/src/__tests__/telegram-bot-auth.test.ts
  - packages/daemon/src/__tests__/telegram-admin-api.test.ts
autonomous: true

must_haves:
  truths:
    - "ADMIN role 사용자는 /wallets, /pending, /approve, /reject 모든 명령을 사용할 수 있다"
    - "READONLY role 사용자는 /status, /help, /wallets만 사용할 수 있고 /approve, /reject는 거부된다"
    - "PENDING role 사용자는 /start, /help만 사용할 수 있고 나머지 명령은 거부된다"
    - "/pending 명령이 APPROVAL 대기 거래 목록을 인라인 키보드(Approve/Reject)와 함께 보여준다"
    - "/approve {txId}로 대기 거래가 승인되고 /reject {txId}로 거부된다"
    - "/wallets 명령이 모든 월렛 목록(이름, 체인, 상태)을 보여준다"
    - "Admin REST API로 telegram_users 목록 조회 및 role 변경이 가능하다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/telegram/telegram-auth.ts"
      provides: "2-Tier 인증 미들웨어"
      exports: ["TelegramAuth", "READONLY_COMMANDS", "ADMIN_COMMANDS"]
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "telegram_users REST API 2개 엔드포인트"
      contains: "telegram-users"
    - path: "packages/daemon/src/__tests__/telegram-bot-auth.test.ts"
      provides: "2-Tier 인증 + /wallets, /pending, /approve, /reject 테스트"
  key_links:
    - from: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      to: "packages/daemon/src/infrastructure/telegram/telegram-auth.ts"
      via: "명령 실행 전 checkPermission 호출"
      pattern: "TelegramAuth"
    - from: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      to: "pending_approvals DB 테이블"
      via: "sqlite 직접 쿼리"
      pattern: "pending_approvals"
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "telegram_users DB 테이블"
      via: "Drizzle ORM"
      pattern: "telegramUsers"
---

<objective>
2-Tier 인증 시스템과 월렛/거래 관련 명령어(/wallets, /pending, /approve, /reject)를 구현하고, Admin REST API로 telegram_users 관리 기능을 추가한다.

Purpose: Telegram Bot이 실제 유용한 관리 도구로 동작하기 위해 권한 체계(ADMIN/READONLY/PENDING)를 적용하고, 원격에서 거래 승인/거부와 월렛 목록 조회가 가능하게 한다. Admin UI(Phase 144)에서 사용할 REST API도 함께 추가한다.
Output: 2-Tier 인증 + 4개 명령어 + Admin API 2개 엔드포인트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/143-telegram-bot/143-01-SUMMARY.md

# 패턴 참조
@packages/daemon/src/api/routes/admin.ts (Admin 라우트 패턴)
@packages/daemon/src/infrastructure/database/schema.ts (telegramUsers 테이블 -- Plan 01에서 추가)
@packages/daemon/src/workflow/approval-workflow.ts (승인/거부 패턴)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 2-Tier 인증 + /wallets, /pending, /approve, /reject 명령어</name>
  <files>
    packages/daemon/src/infrastructure/telegram/telegram-auth.ts
    packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
    packages/daemon/src/__tests__/telegram-bot-auth.test.ts
  </files>
  <action>
    1. **telegram-auth.ts** -- 2-Tier 인증 모듈:
       ```typescript
       export const PUBLIC_COMMANDS = ['/start', '/help'] as const;
       export const READONLY_COMMANDS = ['/status', '/wallets'] as const;
       export const ADMIN_COMMANDS = ['/pending', '/approve', '/reject', '/killswitch', '/newsession'] as const;

       export class TelegramAuth {
         constructor(private sqlite: Database) {}

         /** chat_id의 role을 DB에서 조회. 미등록이면 null 반환. */
         getRole(chatId: number): TelegramUserRole | null {
           const row = this.sqlite
             .prepare('SELECT role FROM telegram_users WHERE chat_id = ?')
             .get(chatId) as { role: string } | undefined;
           return (row?.role as TelegramUserRole) ?? null;
         }

         /** 명령 실행 권한 확인. 반환: { allowed: boolean; reason?: string } */
         checkPermission(chatId: number, command: string): { allowed: boolean; reason?: string } {
           // /start, /help는 누구나 가능 (미등록 포함)
           if (PUBLIC_COMMANDS.includes(command as any)) return { allowed: true };

           const role = this.getRole(chatId);
           if (!role) return { allowed: false, reason: 'not_registered' };
           if (role === 'PENDING') return { allowed: false, reason: 'pending_approval' };

           // READONLY: /status, /wallets만 허용
           if (role === 'READONLY') {
             if (READONLY_COMMANDS.includes(command as any)) return { allowed: true };
             return { allowed: false, reason: 'admin_only' };
           }

           // ADMIN: 모든 명령 허용
           return { allowed: true };
         }

         /** role 변경 (Admin API에서 호출). PENDING -> ADMIN/READONLY */
         updateRole(chatId: number, newRole: 'ADMIN' | 'READONLY'): boolean {
           const now = Math.floor(Date.now() / 1000);
           const result = this.sqlite
             .prepare('UPDATE telegram_users SET role = ?, approved_at = ? WHERE chat_id = ?')
             .run(newRole, now, chatId);
           return result.changes > 0;
         }

         /** 등록된 사용자 목록 조회 (Admin API용) */
         listUsers(): Array<{ chatId: number; username: string | null; role: string; registeredAt: number; approvedAt: number | null }> {
           return this.sqlite
             .prepare('SELECT chat_id, username, role, registered_at, approved_at FROM telegram_users ORDER BY registered_at DESC')
             .all() as any[];
         }
       }
       ```

    2. **telegram-bot-service.ts** -- 기존 서비스에 인증 + 4개 명령어 추가:
       - 생성자에 TelegramAuth 인스턴스 생성 (sqlite로부터)
       - `handleUpdate()`에서 명령 처리 전 `auth.checkPermission()` 호출
         - allowed=false이면 reason에 따라 i18n 메시지 전송 (bot_unauthorized / bot_pending_approval / bot_admin_only)
       - **handleWallets(chatId)** -- /wallets:
         - `SELECT id, name, chain, environment, status FROM wallets ORDER BY created_at DESC`
         - 결과를 MarkdownV2 포매팅: 각 월렛 "- {name} ({chain}/{environment}) [{status}]"
         - 월렛 없으면 bot_wallets_empty 메시지
       - **handlePending(chatId)** -- /pending:
         - `SELECT t.id, t.type, t.amount, t.to_address, t.chain, pa.expires_at FROM transactions t JOIN pending_approvals pa ON t.id = pa.tx_id WHERE t.status = 'QUEUED' AND pa.approved_at IS NULL AND pa.rejected_at IS NULL AND pa.expires_at > unixepoch() ORDER BY pa.created_at ASC`
         - 각 거래에 대해 인라인 키보드 (2버튼: [Approve txId] [Reject txId]) 첨부
         - 인라인 키보드 callback_data: `approve:{txId}` / `reject:{txId}`
         - 대기 거래 없으면 bot_pending_empty 메시지
       - **handleApprove(chatId, txId)** -- /approve {txId}:
         - txId 유효성 검증: pending_approvals에서 해당 tx 존재 + 미승인/미거부 확인
         - `UPDATE pending_approvals SET approved_at = unixepoch() WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL`
         - `UPDATE transactions SET status = 'EXECUTING' WHERE id = ? AND status = 'QUEUED'`
         - 성공 시 bot_approve_success 메시지, 실패 시 bot_tx_not_found 메시지
         - 감사 로그 INSERT: event_type='TX_APPROVED_VIA_TELEGRAM', actor='telegram:{chatId}'
       - **handleReject(chatId, txId)** -- /reject {txId}:
         - `UPDATE pending_approvals SET rejected_at = unixepoch() WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL`
         - `UPDATE transactions SET status = 'CANCELLED', error = 'Rejected via Telegram' WHERE id = ? AND status = 'QUEUED'`
         - 성공 시 bot_reject_success 메시지, 실패 시 bot_tx_not_found
         - 감사 로그 INSERT
       - **callback_query 처리** 추가:
         - `handleUpdate()`에서 update.callback_query 존재 시 data 파싱
         - `approve:{txId}` -> handleApprove(from.id, txId)
         - `reject:{txId}` -> handleReject(from.id, txId)
         - answerCallbackQuery 호출 (토스트 피드백)
         - 인라인 키보드에서도 auth.checkPermission 적용

    3. **telegram-bot-auth.test.ts** -- 테스트 (20개 이상):
       - TelegramAuth.getRole: 미등록 null, PENDING/ADMIN/READONLY 반환
       - TelegramAuth.checkPermission: /start 미등록 허용, /status PENDING 거부, /status READONLY 허용, /approve READONLY 거부, /approve ADMIN 허용
       - TelegramAuth.updateRole: PENDING->ADMIN 성공, 미존재 chatId false
       - TelegramAuth.listUsers: 목록 반환 확인
       - /wallets: 월렛 2개 등록 후 목록 반환 확인
       - /wallets: 월렛 없을 때 빈 목록 메시지
       - /pending: APPROVAL 대기 거래 2건 조회 + 인라인 키보드 포함 확인
       - /pending: 대기 거래 없을 때 빈 목록 메시지
       - /approve: 유효한 txId 승인 -> pending_approvals.approved_at 설정 + transactions.status='EXECUTING'
       - /approve: 무효한 txId -> bot_tx_not_found 메시지
       - /reject: 유효한 txId 거부 -> transactions.status='CANCELLED'
       - callback_query: approve:TX-001 -> handleApprove 호출 + answerCallbackQuery
       - callback_query: reject:TX-001 -> handleReject 호출
       - READONLY 사용자가 /approve 시도 -> bot_admin_only 메시지
       - PENDING 사용자가 /status 시도 -> bot_pending_approval 메시지
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-auth.test.ts` -- 모든 테스트 통과
    `pnpm -C packages/daemon exec tsc --noEmit` -- 타입 체크 통과
  </verify>
  <done>
    2-Tier 인증이 적용되어 ADMIN/READONLY/PENDING role에 따라 명령 실행이 제어되고, /wallets로 월렛 목록 조회, /pending으로 대기 거래 인라인 키보드 조회, /approve와 /reject로 거래 승인/거부가 동작한다. callback_query를 통한 인라인 키보드 인터랙션이 지원된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin REST API -- telegram_users 관리 엔드포인트</name>
  <files>
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/schemas/admin.ts
    packages/daemon/src/__tests__/telegram-admin-api.test.ts
  </files>
  <action>
    1. **admin.ts (schemas)** -- OpenAPI Zod 스키마 추가:
       ```typescript
       // Telegram Users
       export const TelegramUserSchema = z.object({
         chat_id: z.number(),
         username: z.string().nullable(),
         role: z.enum(['PENDING', 'ADMIN', 'READONLY']),
         registered_at: z.number(),
         approved_at: z.number().nullable(),
       });

       export const TelegramUsersResponseSchema = z.object({
         users: z.array(TelegramUserSchema),
         total: z.number(),
       });

       export const TelegramUserUpdateRequestSchema = z.object({
         role: z.enum(['ADMIN', 'READONLY']),
       });

       export const TelegramUserUpdateResponseSchema = z.object({
         success: z.boolean(),
         chat_id: z.number(),
         role: z.enum(['ADMIN', 'READONLY']),
       });
       ```

    2. **admin.ts (routes)** -- 2개 엔드포인트 추가:
       - **GET /v1/admin/telegram-users** (masterAuth):
         - sqlite 직접 쿼리: `SELECT chat_id, username, role, registered_at, approved_at FROM telegram_users ORDER BY registered_at DESC`
         - 응답: { users: [...], total: count }
       - **PUT /v1/admin/telegram-users/:chatId** (masterAuth):
         - body: { role: 'ADMIN' | 'READONLY' }
         - sqlite 직접: `UPDATE telegram_users SET role = ?, approved_at = ? WHERE chat_id = ?`
         - changes === 0 이면 404 USER_NOT_FOUND
         - 성공: { success: true, chat_id, role }
       - createRoute() + OpenAPI 스키마 등록 (기존 admin 라우트 패턴 따름)
       - DELETE /v1/admin/telegram-users/:chatId도 추가: telegram_users에서 삭제

    3. **telegram-admin-api.test.ts** -- 테스트 (10개):
       - GET /v1/admin/telegram-users: 빈 목록 반환
       - GET /v1/admin/telegram-users: 등록된 사용자 2명 반환 확인
       - PUT /v1/admin/telegram-users/123: PENDING->ADMIN 성공 + approved_at 설정
       - PUT /v1/admin/telegram-users/123: PENDING->READONLY 성공
       - PUT /v1/admin/telegram-users/999: 미존재 chatId -> 404
       - PUT /v1/admin/telegram-users/123: invalid role -> 400
       - DELETE /v1/admin/telegram-users/123: 삭제 성공
       - DELETE /v1/admin/telegram-users/999: 미존재 -> 404
       - masterAuth 미인증 -> 401
       - 라우트 등록 확인 (OpenAPI /doc에 표시)
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-admin-api.test.ts` -- 모든 테스트 통과
    `pnpm -C packages/daemon exec tsc --noEmit` -- 타입 체크 통과
  </verify>
  <done>
    Admin REST API로 telegram_users 목록 조회(GET), role 변경(PUT), 삭제(DELETE)가 가능하다. OpenAPI 스키마가 /doc에 등록되어 있다. Phase 144 Admin UI에서 이 API를 사용하여 Telegram 사용자를 관리할 수 있다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm -C packages/daemon exec tsc --noEmit` -- 타입 체크
2. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-bot-auth.test.ts` -- 2-Tier 인증 + 명령어 테스트
3. `pnpm -C packages/daemon exec vitest run --reporter=verbose src/__tests__/telegram-admin-api.test.ts` -- Admin API 테스트
4. `pnpm -C packages/daemon exec vitest run` -- daemon 전체 테스트 회귀 없음
</verification>

<success_criteria>
- 2-Tier 인증: ADMIN은 모든 명령, READONLY는 /status+/help+/wallets, PENDING은 /start+/help만 허용
- /wallets: 모든 월렛 목록(이름, 체인, 환경, 상태) 출력
- /pending: APPROVAL 대기 거래 목록 + 인라인 키보드(Approve/Reject)
- /approve, /reject: 거래 승인/거부 + 감사 로그
- callback_query: 인라인 키보드 버튼 클릭으로 승인/거부
- Admin API: GET/PUT/DELETE /v1/admin/telegram-users
- 30개 이상 신규 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/143-telegram-bot/143-02-SUMMARY.md`
</output>
