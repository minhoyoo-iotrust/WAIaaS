---
phase: 100-settings-infra
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/index.ts
  - packages/daemon/src/infrastructure/settings/settings-crypto.ts
  - packages/daemon/src/__tests__/settings-schema-migration.test.ts
autonomous: true

must_haves:
  truths:
    - "settings 테이블이 schema_version 5 마이그레이션으로 생성되고, 기존 DB가 데이터 손실 없이 마이그레이션된다"
    - "credential 값(bot token, webhook URL)이 AES-GCM으로 암호화 저장되고, 평문으로 DB에 노출되지 않는다"
    - "settings 테이블에 key, value, encrypted, category, updated_at 컬럼이 있다"
    - "새로 생성된 DB(fresh)에서도 settings 테이블이 존재한다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "settings Drizzle ORM table definition"
      contains: "export const settings"
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v5 migration for settings table + LATEST_SCHEMA_VERSION = 5"
      contains: "version: 5"
    - path: "packages/daemon/src/infrastructure/settings/settings-crypto.ts"
      provides: "AES-256-GCM encrypt/decrypt for credential values"
      exports: ["encryptSettingValue", "decryptSettingValue"]
    - path: "packages/daemon/src/__tests__/settings-schema-migration.test.ts"
      provides: "Migration v5 tests + crypto tests"
      min_lines: 80
  key_links:
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "schema_version table"
      via: "MIGRATIONS.push version 5"
      pattern: "version: 5"
    - from: "packages/daemon/src/infrastructure/database/schema.ts"
      to: "packages/daemon/src/infrastructure/database/index.ts"
      via: "barrel export"
      pattern: "export.*settings"
    - from: "packages/daemon/src/infrastructure/settings/settings-crypto.ts"
      to: "node:crypto"
      via: "AES-256-GCM createCipheriv/createDecipheriv"
      pattern: "aes-256-gcm"
---

<objective>
settings key-value 테이블을 Drizzle 스키마에 추가하고, schema_version 5 마이그레이션을 등록하며, credential 값을 AES-GCM으로 암호화/복호화하는 유틸리티를 구현한다.

Purpose: Phase 100의 핵심 인프라 -- DB 저장소 + 암호화 기능을 먼저 구축해야 Phase 100-02의 SettingsService가 이 위에 구축된다.
Output: settings 테이블 (Drizzle + DDL + migration) + settings-crypto 모듈 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/connection.ts
@packages/daemon/src/infrastructure/database/index.ts
@packages/daemon/src/infrastructure/keystore/crypto.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: settings 테이블 Drizzle 스키마 + DDL + v5 마이그레이션</name>
  <files>
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/infrastructure/database/index.ts
  </files>
  <action>
1. **schema.ts** -- Table 10 뒤에 settings 테이블 추가 (새 Table 11):
```typescript
// Table 11: settings -- daemon operational settings (key-value)
export const settings = sqliteTable(
  'settings',
  {
    key: text('key').primaryKey(),          // e.g., 'notifications.telegram_bot_token'
    value: text('value').notNull(),          // plain or AES-GCM encrypted (base64 JSON)
    encrypted: integer('encrypted', { mode: 'boolean' }).notNull().default(false),
    category: text('category').notNull(),    // 'notifications' | 'rpc' | 'security' | 'daemon' | 'walletconnect'
    updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull(),
  },
  (table) => [
    index('idx_settings_category').on(table.category),
  ],
);
```
파일 상단 주석도 "9 tables" -> "10 tables + settings" 로 업데이트한다.

2. **migrate.ts** -- settings 테이블 DDL을 `getCreateTableStatements()`에 추가:
```sql
CREATE TABLE IF NOT EXISTS settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  encrypted INTEGER NOT NULL DEFAULT 0 CHECK (encrypted IN (0, 1)),
  category TEXT NOT NULL,
  updated_at INTEGER NOT NULL
)
```
index도 `getCreateIndexStatements()`에 추가:
```sql
CREATE INDEX IF NOT EXISTS idx_settings_category ON settings(category)
```

`LATEST_SCHEMA_VERSION`을 4 -> 5로 변경.

v5 마이그레이션을 `MIGRATIONS.push`로 등록:
```typescript
MIGRATIONS.push({
  version: 5,
  description: 'Create settings table for operational config DB storage',
  up: (sqlite) => {
    sqlite.exec(`CREATE TABLE IF NOT EXISTS settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  encrypted INTEGER NOT NULL DEFAULT 0 CHECK (encrypted IN (0, 1)),
  category TEXT NOT NULL,
  updated_at INTEGER NOT NULL
)`);
    sqlite.exec('CREATE INDEX IF NOT EXISTS idx_settings_category ON settings(category)');
  },
});
```

migrate.ts 상단 주석도 "10 tables" -> "11 tables" 업데이트.

3. **index.ts** -- barrel export에 `settings` 추가:
```typescript
export {
  wallets, sessions, transactions, policies, pendingApprovals,
  auditLog, keyValueStore, notificationLogs, tokenRegistry, settings,
} from './schema.js';
```
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec tsc --noEmit` 컴파일 성공.
`pnpm --filter @waiaas/daemon test -- --run migration-runner` 기존 마이그레이션 테스트 통과.
  </verify>
  <done>
settings 테이블이 Drizzle 스키마, DDL, v5 마이그레이션으로 정의되고, LATEST_SCHEMA_VERSION=5, barrel export에 settings가 포함된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: settings-crypto AES-GCM 암호화 모듈 + 통합 테스트</name>
  <files>
    packages/daemon/src/infrastructure/settings/settings-crypto.ts
    packages/daemon/src/__tests__/settings-schema-migration.test.ts
  </files>
  <action>
1. **settings-crypto.ts** -- credential 값 AES-GCM 암호화/복호화 유틸리티:
- 기존 `keystore/crypto.ts`의 Argon2id KDF는 개인 키 보호용(300ms+ 무거운 KDF). Settings credential 암호화는 반복 조회가 잦으므로 가벼운 방식 사용.
- master password에서 HKDF(SHA-256)로 settings 전용 32-byte 서브키를 도출한다. salt는 고정 문자열 'waiaas-settings-v1'을 사용 (매번 동일 마스터 패스워드에서 동일 키 생성 -- 복호화 가능하게).
- `encryptSettingValue(plaintext: string, masterPassword: string): string` -- AES-256-GCM 암호화 후 `{iv, ciphertext, authTag}`을 JSON -> base64 인코딩하여 반환.
- `decryptSettingValue(encrypted: string, masterPassword: string): string` -- base64 -> JSON 파싱 -> AES-256-GCM 복호화 후 평문 반환.
- `deriveSettingsKey(masterPassword: string): Buffer` -- HKDF(SHA-256) 도출. `node:crypto`의 hkdfSync 사용.

```typescript
import { randomBytes, createCipheriv, createDecipheriv, hkdfSync } from 'node:crypto';

const SETTINGS_HKDF_SALT = 'waiaas-settings-v1';
const SETTINGS_HKDF_INFO = 'settings-encryption';

export function deriveSettingsKey(masterPassword: string): Buffer {
  return Buffer.from(
    hkdfSync('sha256', masterPassword, SETTINGS_HKDF_SALT, SETTINGS_HKDF_INFO, 32)
  );
}

interface EncryptedValue {
  iv: string;    // hex
  ct: string;    // hex (ciphertext)
  tag: string;   // hex (authTag)
}

export function encryptSettingValue(plaintext: string, masterPassword: string): string {
  const key = deriveSettingsKey(masterPassword);
  const iv = randomBytes(12);
  const cipher = createCipheriv('aes-256-gcm', key, iv);
  const ct = Buffer.concat([cipher.update(plaintext, 'utf8'), cipher.final()]);
  const tag = cipher.getAuthTag();
  key.fill(0);  // zero key
  const obj: EncryptedValue = {
    iv: iv.toString('hex'),
    ct: ct.toString('hex'),
    tag: tag.toString('hex'),
  };
  return Buffer.from(JSON.stringify(obj)).toString('base64');
}

export function decryptSettingValue(encrypted: string, masterPassword: string): string {
  const key = deriveSettingsKey(masterPassword);
  const obj: EncryptedValue = JSON.parse(Buffer.from(encrypted, 'base64').toString('utf8'));
  const decipher = createDecipheriv('aes-256-gcm', key, Buffer.from(obj.iv, 'hex'));
  decipher.setAuthTag(Buffer.from(obj.tag, 'hex'));
  const plain = Buffer.concat([
    decipher.update(Buffer.from(obj.ct, 'hex')),
    decipher.final(),
  ]);
  key.fill(0);  // zero key
  return plain.toString('utf8');
}
```

- `CREDENTIAL_KEYS` set을 export하여 어떤 settings key가 암호화 대상인지 정의:
```typescript
export const CREDENTIAL_KEYS = new Set([
  'notifications.telegram_bot_token',
  'notifications.discord_webhook_url',
  'security.jwt_secret',
]);
```

2. **settings-schema-migration.test.ts** -- 통합 테스트:
- **v5 마이그레이션 테스트**: v4 상태 DB를 생성하고 runMigrations 호출 시 settings 테이블이 생성되는지 확인.
- **fresh DB 테스트**: pushSchema 호출 시 settings 테이블이 포함되고, schema_version에 5가 기록되는지 확인.
- **기존 DB 데이터 보존 테스트**: v4 DB에 wallets/sessions 데이터가 있는 상태에서 v5 마이그레이션 후 데이터가 보존되는지 확인.
- **settings-crypto 테스트**: encrypt -> decrypt 라운드트립, 잘못된 패스워드로 복호화 실패, 빈 문자열 암호화.
- **CREDENTIAL_KEYS 테스트**: credential 키에 telegram_bot_token, discord_webhook_url이 포함되는지 확인.

테스트 패턴은 기존 `migration-runner.test.ts`와 `keystore.test.ts`를 따른다.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run settings-schema-migration` 모든 테스트 통과.
  </verify>
  <done>
settings-crypto 모듈이 AES-256-GCM + HKDF로 credential을 암호화/복호화하고, v5 마이그레이션이 기존 DB를 무손실 업그레이드하며, 모든 테스트가 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon exec tsc --noEmit` -- 타입 체크 통과
2. `pnpm --filter @waiaas/daemon test -- --run` -- 기존 테스트 + 새 테스트 전체 통과 (기존 known failures 제외)
3. `pnpm --filter @waiaas/daemon test -- --run migration-runner` -- 기존 마이그레이션 테스트 회귀 없음
4. `pnpm --filter @waiaas/daemon test -- --run settings-schema-migration` -- 새 테스트 전체 통과
5. settings 테이블 DDL과 Drizzle 스키마가 일치 확인
</verification>

<success_criteria>
- settings 테이블이 fresh DB와 기존 v4 DB 양쪽에서 정상 생성
- LATEST_SCHEMA_VERSION = 5, schema_version 테이블에 v5 기록
- encryptSettingValue + decryptSettingValue 라운드트립 성공
- 잘못된 패스워드로 복호화 시 에러 throw
- CREDENTIAL_KEYS가 telegram_bot_token, discord_webhook_url, jwt_secret 포함
- 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/100-settings-infra/100-01-SUMMARY.md`
</output>
