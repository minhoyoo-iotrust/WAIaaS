---
phase: 100-settings-infra
plan: 02
type: execute
wave: 2
depends_on: ["100-01"]
files_modified:
  - packages/daemon/src/infrastructure/settings/settings-service.ts
  - packages/daemon/src/infrastructure/settings/index.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/settings-service.test.ts
autonomous: true

must_haves:
  truths:
    - "설정 조회 시 DB > config.toml > 환경변수 > 기본값 순서로 fallback이 동작한다"
    - "데몬 최초 기동 시 config.toml에 설정된 운영 설정 값이 DB로 자동 import된다"
    - "DB에 이미 값이 있으면 config.toml import가 덮어쓰지 않는다"
    - "credential 키(telegram_bot_token 등)를 set할 때 자동으로 AES-GCM 암호화되어 저장된다"
    - "credential 키를 get할 때 자동으로 AES-GCM 복호화되어 평문으로 반환된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      provides: "SettingsService class with get/set/getAll/importFromConfig"
      exports: ["SettingsService"]
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "SETTING_DEFINITIONS with key, category, defaultValue, isCredential"
      exports: ["SETTING_DEFINITIONS", "SETTING_CATEGORIES"]
    - path: "packages/daemon/src/infrastructure/settings/index.ts"
      provides: "Barrel export for settings module"
      exports: ["SettingsService", "SETTING_DEFINITIONS", "CREDENTIAL_KEYS"]
    - path: "packages/daemon/src/lifecycle/daemon.ts"
      provides: "Settings auto-import hook in Step 2"
      contains: "settingsService.importFromConfig"
    - path: "packages/daemon/src/__tests__/settings-service.test.ts"
      provides: "SettingsService unit tests"
      min_lines: 120
  key_links:
    - from: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "Drizzle insert/select on settings table"
      pattern: "schema\\.settings"
    - from: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-crypto.ts"
      via: "encrypt/decrypt for credential values"
      pattern: "encryptSettingValue|decryptSettingValue"
    - from: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      to: "packages/daemon/src/infrastructure/config/loader.ts"
      via: "DaemonConfig for fallback chain"
      pattern: "DaemonConfig"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      via: "importFromConfig on first boot"
      pattern: "importFromConfig"
---

<objective>
SettingsService를 구현하여 DB > config.toml > 환경변수 > 기본값 fallback 체인을 제공하고, 데몬 최초 기동 시 config.toml 운영 설정을 DB로 자동 import한다.

Purpose: 이 서비스가 Phase 101(REST API + hot-reload)과 Phase 102(Admin UI)의 기반이 된다. 설정을 DB에 저장함으로써 config.toml 파일 수정 없이 Admin UI에서 설정을 변경할 수 있게 된다.
Output: SettingsService 클래스 + setting-keys 정의 + daemon.ts import 훅 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/index.ts
@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/lifecycle/daemon.ts
@.planning/phases/100-settings-infra/100-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SettingsService + setting-keys 정의 + barrel export</name>
  <files>
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/infrastructure/settings/settings-service.ts
    packages/daemon/src/infrastructure/settings/index.ts
  </files>
  <action>
1. **setting-keys.ts** -- 운영 설정 키 정의 (SSoT):
- `SETTING_CATEGORIES` -- 설정 카테고리 배열: `['notifications', 'rpc', 'security', 'daemon', 'walletconnect']`
- `SettingDefinition` interface: `{ key: string; category: string; configPath: string; defaultValue: string; isCredential: boolean }`
  - `key`: DB 저장 키 (예: 'notifications.telegram_bot_token')
  - `category`: 카테고리 (예: 'notifications')
  - `configPath`: config.toml에서 읽을 경로 (예: 'notifications.telegram_bot_token')
  - `defaultValue`: 기본값 (DaemonConfigSchema의 .default()와 동일한 값)
  - `isCredential`: true면 AES-GCM 암호화 저장
- `SETTING_DEFINITIONS` 배열 정의. 아래 키를 포함:

**notifications 카테고리:**
- notifications.enabled (boolean string, default: 'false')
- notifications.telegram_bot_token (credential, default: '')
- notifications.telegram_chat_id (default: '')
- notifications.discord_webhook_url (credential, default: '')
- notifications.ntfy_server (default: 'https://ntfy.sh')
- notifications.ntfy_topic (default: '')
- notifications.locale (default: 'en')
- notifications.rate_limit_rpm (default: '20')

**rpc 카테고리** (Solana 3 + EVM 10 + evm_default_network):
- rpc.solana_mainnet, rpc.solana_devnet, rpc.solana_testnet
- rpc.evm_ethereum_mainnet, rpc.evm_ethereum_sepolia, rpc.evm_polygon_mainnet, rpc.evm_polygon_amoy
- rpc.evm_arbitrum_mainnet, rpc.evm_arbitrum_sepolia, rpc.evm_optimism_mainnet, rpc.evm_optimism_sepolia
- rpc.evm_base_mainnet, rpc.evm_base_sepolia
- rpc.evm_default_network

**security 카테고리:**
- security.session_ttl, security.max_sessions_per_wallet, security.max_pending_tx
- security.rate_limit_global_ip_rpm, security.rate_limit_session_rpm, security.rate_limit_tx_rpm
- security.policy_defaults_delay_seconds, security.policy_defaults_approval_timeout

**daemon 카테고리:**
- daemon.log_level

**walletconnect 카테고리:**
- walletconnect.project_id

각 키의 defaultValue는 `DaemonConfigSchema`의 `.default()` 값과 일치시킨다(문자열로 변환).

2. **settings-service.ts** -- SettingsService 클래스:
```typescript
export class SettingsService {
  constructor(opts: {
    db: BetterSQLite3Database<typeof schema>;
    config: DaemonConfig;
    masterPassword: string;
  })

  /** 단일 설정 조회: DB > config.toml > default fallback */
  get(key: string): string

  /** 단일 설정 저장: credential이면 AES-GCM 암호화 */
  set(key: string, value: string): void

  /** 전체 설정 조회 (카테고리별 그룹). credential은 복호화된 값 반환 */
  getAll(): Record<string, Record<string, string>>

  /** 전체 설정 조회 (마스킹). credential 값은 boolean (빈 문자열 아니면 true) */
  getAllMasked(): Record<string, Record<string, string | boolean>>

  /** config.toml 운영 설정을 DB로 import (DB에 없는 키만) */
  importFromConfig(): { imported: number; skipped: number }

  /** 여러 설정을 일괄 저장 */
  setMany(entries: Array<{ key: string; value: string }>): void
}
```

**get(key) 구현 로직:**
1. DB에서 settings 테이블 조회 (key로 SELECT)
2. DB에 값이 있으면: encrypted=true이면 `decryptSettingValue`로 복호화, 아니면 그대로 반환
3. DB에 없으면: `SETTING_DEFINITIONS`에서 해당 키의 `configPath` 확인
4. config.toml 값에서 해당 경로 조회: `this.config[section][field]` (section = configPath의 첫 부분, field = 나머지)
5. config.toml에도 없으면: `SETTING_DEFINITIONS`의 `defaultValue` 반환
6. 정의되지 않은 키면: throw WAIaaSError INVALID_REQUEST

참고: config.toml 값은 loadConfig()가 이미 환경변수 override를 적용했으므로, DaemonConfig 객체를 참조하면 "config.toml > 환경변수 > 기본값" fallback이 자동 포함된다. 따라서 get() fallback은 실질적으로 "DB > (config.toml + 환경변수 + 기본값)"이 된다.

**set(key, value) 구현 로직:**
1. key가 `SETTING_DEFINITIONS`에 존재하는지 확인, 없으면 throw
2. 해당 키의 `isCredential` 확인
3. isCredential=true이면 `encryptSettingValue(value, masterPassword)`로 암호화
4. DB에 UPSERT (INSERT OR REPLACE):
```typescript
db.insert(schema.settings).values({
  key, value: storedValue, encrypted: isCredential,
  category: definition.category,
  updatedAt: new Date(),
}).onConflictDoUpdate({
  target: schema.settings.key,
  set: { value: storedValue, encrypted: isCredential, updatedAt: new Date() },
}).run();
```

**importFromConfig() 구현 로직:**
1. SETTING_DEFINITIONS를 순회
2. 각 키에 대해 DB에 이미 값이 있는지 확인 (SELECT)
3. DB에 없는 경우에만: config.toml 값(`this.config[section][field]`)을 읽어서 set() 호출
4. config.toml 값이 default와 같거나 빈 문자열이면 skip (DB에 불필요한 기본값을 채우지 않는다)
5. imported 카운트 반환

3. **index.ts** -- barrel export:
```typescript
export { SettingsService } from './settings-service.js';
export { SETTING_DEFINITIONS, SETTING_CATEGORIES } from './setting-keys.js';
export type { SettingDefinition } from './setting-keys.js';
export { encryptSettingValue, decryptSettingValue, CREDENTIAL_KEYS } from './settings-crypto.js';
```
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec tsc --noEmit` 컴파일 성공.
  </verify>
  <done>
SettingsService가 DB > config.toml > default fallback으로 설정을 조회하고, credential은 자동 암호화/복호화되며, importFromConfig()로 config.toml 값을 DB에 import한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: daemon.ts import 훅 + SettingsService 테스트</name>
  <files>
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/__tests__/settings-service.test.ts
  </files>
  <action>
1. **daemon.ts** -- Step 2 (Database initialization) 끝에 settings auto-import 추가:
Step 2의 pushSchema(sqlite) 바로 뒤, "Step 2: Database initialized" 로그 직전에:

```typescript
// Auto-import config.toml operational settings into DB (first boot only)
const { SettingsService } = await import('../infrastructure/settings/index.js');
const settingsService = new SettingsService({
  db: this._db!,
  config: this._config!,
  masterPassword,
});
const importResult = settingsService.importFromConfig();
if (importResult.imported > 0) {
  console.log(`Step 2: Settings imported from config.toml (${importResult.imported} keys)`);
}
```

또한 DaemonLifecycle 클래스에 `private settingsService: ... | null = null;` 프로퍼티를 추가하고, 위에서 생성한 settingsService를 저장한다. 이 인스턴스는 Phase 101에서 createApp()에 전달될 예정이다.

2. **settings-service.test.ts** -- SettingsService 단위/통합 테스트:

테스트 구조 (vitest):
```
describe('SettingsService')
  describe('get()')
    it('returns DB value when exists')
    it('returns config.toml value when DB empty')
    it('returns default when DB empty and config is default')
    it('decrypts credential value from DB')
    it('throws for unknown key')
  describe('set()')
    it('stores plain value for non-credential')
    it('encrypts credential value')
    it('updates existing value (upsert)')
  describe('setMany()')
    it('stores multiple values')
  describe('importFromConfig()')
    it('imports non-default config.toml values into DB')
    it('skips keys already in DB')
    it('skips keys with default values')
    it('encrypts credential values during import')
    it('returns count of imported and skipped')
  describe('getAll()')
    it('returns all settings grouped by category')
    it('decrypts credential values')
  describe('getAllMasked()')
    it('masks credential values as boolean')
  describe('fallback chain')
    it('DB value overrides config.toml value')
    it('config.toml value overrides default')
```

테스트 셋업:
- in-memory SQLite (`createDatabase(':memory:')`) + `pushSchema(sqlite)` 로 fresh DB 생성
- DaemonConfig는 `DaemonConfigSchema.parse({})` 로 기본값 생성, 일부 필드 오버라이드
- masterPassword는 테스트용 고정 문자열 'test-master-password'
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run settings-service` 모든 테스트 통과.
`pnpm --filter @waiaas/daemon test -- --run lifecycle` 기존 lifecycle 테스트 회귀 없음 (flaky 건은 기존 known failure).
  </verify>
  <done>
daemon 시작 시 config.toml 운영 설정이 DB로 자동 import되고, SettingsService의 fallback 체인이 DB > config.toml > default 순서로 동작하며, credential은 자동 암호화/복호화된다. 모든 테스트 통과.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon exec tsc --noEmit` -- 타입 체크 통과
2. `pnpm --filter @waiaas/daemon test -- --run settings-service` -- 새 테스트 전체 통과
3. `pnpm --filter @waiaas/daemon test -- --run` -- 전체 테스트 통과 (known failures 제외)
4. SettingsService.get('notifications.telegram_bot_token')이 DB에 암호화 저장된 값을 복호화하여 반환하는지 확인
5. importFromConfig()가 config.toml의 non-default 값만 DB에 import하고 기존 값을 덮어쓰지 않는지 확인
6. fallback 순서: DB에 값 set -> get으로 DB 값 확인 -> DB 삭제 -> get으로 config.toml 값 확인
</verification>

<success_criteria>
- SettingsService.get()이 DB > config.toml > default fallback 순서로 동작
- SettingsService.set()이 credential 키를 자동 AES-GCM 암호화하여 저장
- importFromConfig()가 non-default config.toml 값만 DB에 import
- importFromConfig()가 DB 기존 값을 덮어쓰지 않음
- daemon.ts Step 2에서 settings auto-import가 실행됨
- 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/100-settings-infra/100-02-SUMMARY.md`
</output>
