---
phase: 02-custody-model
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - .planning/deliverables/07-recommended-custody-model.md
  - .planning/deliverables/01-tech-stack-decision.md
  - objectives/01-basic-concepts.md
autonomous: true

must_haves:
  truths:
    - "WAIaaS 권장 커스터디 모델이 근거와 함께 제안됨"
    - "AWS KMS + Nitro Enclaves + Squads Protocol 조합이 권장됨"
    - "각 구성 요소의 역할과 선택 근거가 명시됨"
    - "위험 요소와 완화 방안이 포함됨"
    - "Phase 1 Turnkey 결정이 직접 구축으로 철회됨"
  artifacts:
    - path: ".planning/deliverables/07-recommended-custody-model.md"
      provides: "WAIaaS 권장 커스터디 모델 제안서 (CUST-04)"
      contains: "AWS KMS|Nitro Enclaves|Squads Protocol|Dual Key"
    - path: ".planning/deliverables/01-tech-stack-decision.md"
      provides: "Turnkey 철회 반영된 기술 스택 문서"
      contains: "직접 구축|철회"
  key_links:
    - from: ".planning/deliverables/07-recommended-custody-model.md"
      to: ".planning/deliverables/04-custody-model-comparison.md"
      via: "모델 비교 결과 참조"
    - from: ".planning/deliverables/07-recommended-custody-model.md"
      to: ".planning/deliverables/06-ai-agent-custody-considerations.md"
      via: "AI 에이전트 요구사항 반영"
---

<objective>
CUST-01, CUST-02, CUST-03 분석 결과를 종합하여 WAIaaS에 권장하는 커스터디 모델을 제안하고, Phase 1에서 선택한 Turnkey 프로바이더 결정을 직접 구축으로 철회한다.

Purpose: 커스터디 모델 분석 Phase의 최종 결론 도출 및 기존 결정 업데이트
Output: CUST-04 권장 모델 제안서, TECH-01 문서 Turnkey 결정 철회 반영
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-custody-model/02-CONTEXT.md
@.planning/phases/02-custody-model/02-RESEARCH.md

# 이전 Plan 결과물 참조 필요
@.planning/deliverables/04-custody-model-comparison.md
@.planning/deliverables/05-provider-comparison.md
@.planning/deliverables/06-ai-agent-custody-considerations.md
@.planning/deliverables/01-tech-stack-decision.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: WAIaaS 권장 커스터디 모델 제안서 작성 (CUST-04)</name>
  <files>.planning/deliverables/07-recommended-custody-model.md</files>
  <action>
    WAIaaS에 권장하는 커스터디 모델 제안서를 작성한다.

    **선행 조건 확인 (필수):**
    작성 시작 전, Plan 02-01, 02-02 결과물이 존재하고 필요한 내용이 포함되어 있는지 확인:
    ```bash
    # 04-custody-model-comparison.md 존재 및 내용 확인
    ls -la .planning/deliverables/04-custody-model-comparison.md
    grep -q "MPC-TSS\|Custodial\|Non-custodial" .planning/deliverables/04-custody-model-comparison.md

    # 06-ai-agent-custody-considerations.md 존재 및 내용 확인
    ls -la .planning/deliverables/06-ai-agent-custody-considerations.md
    grep -q "자율적 트랜잭션\|에이전트-서버\|장애 복구" .planning/deliverables/06-ai-agent-custody-considerations.md
    ```
    위 확인이 실패하면, 해당 파일이 Plan 02-01, 02-02에서 정상 생성되었는지 확인 후 진행.

    **문서 구조:**

    1. **Executive Summary**
       - 권장 모델: 하이브리드 KMS + TEE + 온체인 멀티시그
       - 핵심 구성: AWS KMS (ED25519) + Nitro Enclaves + Squads Protocol
       - 선택 이유 한 문단 요약

    2. **권장 아키텍처 개요**
       ```
       ┌─────────────────────────────────────────┐
       │         Squads Smart Wallet             │
       │   (Solana Program - Multisig)           │
       ├─────────────────────────────────────────┤
       │  - Owner 권한: Owner Key (AWS KMS)      │
       │  - Agent 권한: Agent Key (Nitro TEE)    │
       │  - 정책: 온체인 강제 (한도, 시간)       │
       └─────────────────────────────────────────┘
       ```
       - Dual Key Architecture 설명
       - 각 구성 요소의 역할

    3. **구성 요소별 상세 분석**

       **3.1 Owner Key 관리: AWS KMS (ED25519)**
       - 역할: 소유자 마스터 키, 자금 회수, 에이전트 중지, 키 교체
       - 선택 근거:
         * FIPS 140-2 Level 3 검증
         * ED25519 공식 지원 (2025년 11월)
         * Solana 트랜잭션 직접 서명 가능
         * IAM 기반 접근 제어
         * CloudTrail 감사 로그
       - 구현 방식: solana-kms-signer 라이브러리 활용
       - 비용: ~$1/10,000 서명 요청

       **3.2 Agent Key 런타임: AWS Nitro Enclaves**
       - 역할: 에이전트 키 격리 실행, 정책 기반 자율 서명
       - 선택 근거:
         * 하드웨어 수준 메모리 격리
         * 호스트 OS에서 접근 차단
         * Attestation 기반 검증
         * Coinbase, Fireblocks 등 실사용 검증
       - 구현 방식:
         * Enclave 내부에서 Agent Key 생성
         * KMS로 암호화된 시드 외부 백업
         * 정책 검증 후 서명 (Enclave 내부에서만)
       - 비용: EC2 비용만 (Enclave 추가 비용 없음)

       **3.3 온체인 권한 제어: Squads Protocol v4**
       - 역할: 멀티시그, 스마트 월렛, 온체인 정책 강제
       - 선택 근거:
         * $10B+ 자산 보호 실적
         * Formal verification 완료
         * OtterSec, Trail of Bits 감사
         * Spending limits, time locks 기본 제공
       - 구현 방식:
         * 2-of-2 (Owner + Agent) 또는 1-of-2 구성
         * 금액 기반 동적 threshold
         * 화이트리스트 프로그램 제한

    4. **선택 근거 종합**
       CUST-01 ~ CUST-03 분석 결과 기반:
       - Custodial 배제 이유: 수탁 규제 복잡, 외부 의존
       - Pure Non-custodial 배제 이유: 에이전트 키 노출 위험
       - Pure MPC 배제 이유: 서명 지연 (4라운드), 운영 복잡도
       - 하이브리드 선택 이유:
         * Owner Key는 KMS (고보안, 낮은 빈도)
         * Agent Key는 TEE (빠른 서명, 격리)
         * 온체인 정책으로 이중 보호

    5. **AI 에이전트 요구사항 충족 매핑**
       CUST-02 요구사항별 대응:
       | 요구사항 | 권장 모델의 대응 |
       - 자율적 트랜잭션: Agent Key (TEE) 정책 범위 내 자율 서명
       - 소유자 통제권: Owner Key (KMS) 언제든 중지/회수 가능
       - 에이전트-서버 분리: Agent Key (Enclave) + Owner Key (KMS)
       - 장애 복구: KMS 암호화 시드 백업, Squads guardian
       - 자율성 제한: Squads 온체인 정책 + 서버 정책 이중 검증

    6. **구현 로드맵**
       Phase 3 (시스템 아키텍처)로 이어질 구현 순서:
       1. AWS KMS ED25519 키 생성 및 IAM 설정
       2. Nitro Enclave 기반 Agent Key 서비스 구축
       3. Squads Smart Wallet 생성 및 권한 설정
       4. 정책 엔진 (서버 + 온체인) 구현
       5. 장애 복구 메커니즘 구현

    7. **위험 요소 및 완화 방안**
       | 위험 | 영향 | 완화 방안 |
       - KMS 키 접근 상실: IAM 역할 분리, 백업 계정
       - Enclave 이미지 변조: PCR 화이트리스트, attestation 검증
       - Squads 프로그램 취약점: 최신 버전 사용, 감사 보고서 확인
       - 네트워크 분리 공격: 다중 RPC, 상태 모니터링

    8. **비용 분석**
       | 구성 요소 | 월간 예상 비용 | 비고 |
       - AWS KMS: ~$10-50 (서명 빈도 따라)
       - EC2 + Nitro: ~$200-500 (인스턴스 크기)
       - Squads: 트랜잭션 수수료만
       - 총계: ~$250-600/월 (초기 운영)
       vs 외부 프로바이더: 트랜잭션당 과금, 벤더 락인

    9. **대안 검토**
       - 대안 A: CloudHSM (HSM 전용): 비용 높음 (~$1.6/시간), 초기 불필요
       - 대안 B: 자체 MPC 구현: 복잡도 높음, 유지보수 부담
       - 대안 C: 외부 프로바이더: 벤더 락인, 커스터마이징 제한

    10. **결론**
        권장 모델 최종 요약 및 다음 단계 (Phase 3)로의 연결

    **참고 자료:**
    - 02-RESEARCH.md의 "Primary recommendation" 및 "Architecture Patterns"
    - 04-custody-model-comparison.md의 비교 매트릭스
    - 06-ai-agent-custody-considerations.md의 요구사항

    **작성 원칙:**
    - 결론 선행, 근거 후행 (Executive Summary → 상세 분석)
    - 각 선택에 "왜"를 명시
    - 위험 요소를 숨기지 않고 완화 방안과 함께 제시
    - 비용을 정량적으로 제시 (변동 가능 명시)
  </action>
  <verify>
    - 파일 생성 확인: ls -la .planning/deliverables/07-recommended-custody-model.md
    - "AWS KMS", "Nitro Enclaves", "Squads Protocol" 키워드 포함 확인
    - 구성 요소별 선택 근거 섹션 확인
    - 위험 요소 및 완화 방안 테이블 확인
    - 비용 분석 섹션 확인
  </verify>
  <done>
    - 07-recommended-custody-model.md 파일이 생성됨
    - AWS KMS + Nitro Enclaves + Squads Protocol 권장이 명시됨
    - 각 구성 요소의 역할과 선택 근거가 상세히 설명됨
    - CUST-01~03 분석 결과가 선택 근거로 참조됨
    - AI 에이전트 요구사항 충족 매핑이 포함됨
    - 위험 요소와 완화 방안이 테이블로 정리됨
    - 비용 분석이 정량적으로 제시됨
  </done>
</task>

<task type="auto">
  <name>Task 2: Phase 1 Turnkey 결정 철회 반영</name>
  <files>.planning/deliverables/01-tech-stack-decision.md, objectives/01-basic-concepts.md</files>
  <action>
    02-CONTEXT.md의 결정에 따라 Phase 1에서 선택한 Turnkey 프로바이더 결정을 철회하고 직접 구축 방향으로 문서를 업데이트한다.

    **01-tech-stack-decision.md 수정:**

    1. 문서 상단에 "수정 이력" 섹션 추가:
       ```markdown
       ## 수정 이력

       | 날짜 | 변경 내용 | 근거 |
       |------|----------|------|
       | 2026-02-04 | Turnkey 프로바이더 선택 → 직접 구축으로 철회 | Phase 2 커스터디 모델 분석 결과, 외부 프로바이더 의존 배제 결정 |
       ```

    2. "키 관리 프로바이더" 섹션 수정:
       - 기존: "Turnkey 선택: TEE 기반 보안..."
       - 변경: "[철회됨] Turnkey 선택 → 직접 구축 (Phase 2에서 결정)"
       - 새로운 키 관리 방향 추가:
         * AWS KMS (ED25519) - Owner Key 관리
         * AWS Nitro Enclaves - Agent Key 런타임
         * Squads Protocol - 온체인 권한 제어
       - 상세 설계는 07-recommended-custody-model.md 참조 안내

    3. "클라우드 인프라" 섹션 유지:
       - AWS 선택은 유지 (Turnkey 때문이 아닌 KMS/Nitro 때문)
       - 근거 업데이트: "AWS KMS ED25519 지원, Nitro Enclaves 제공"

    **objectives/01-basic-concepts.md 수정 (만약 Turnkey 관련 내용이 있다면):**
    - Turnkey 관련 언급이 있으면 직접 구축 방향으로 수정
    - 없으면 수정 불필요

    **수정 원칙:**
    - 기존 문서의 구조 유지
    - 변경 사항만 최소한으로 수정
    - 철회 이유와 새로운 방향을 명확히 명시
    - 수정 이력으로 추적 가능하게 기록
  </action>
  <verify>
    - 01-tech-stack-decision.md에 "철회" 또는 "수정 이력" 키워드 확인:
      ```bash
      grep -E "철회|수정 이력" .planning/deliverables/01-tech-stack-decision.md
      ```
    - 새로운 키 관리 방향 (AWS KMS, Nitro Enclaves, Squads) 포함 확인:
      ```bash
      grep -E "AWS KMS|Nitro Enclaves|Squads" .planning/deliverables/01-tech-stack-decision.md
      ```
    - Turnkey 관련 내용이 철회로 표시되었는지 확인:
      ```bash
      grep -E "\[철회됨\].*Turnkey|Turnkey.*철회" .planning/deliverables/01-tech-stack-decision.md
      ```
    - 문서 무결성 확인 (기존 다른 섹션 유지):
      ```bash
      # 기존 섹션들이 유지되었는지 확인
      grep -E "## (언어|프레임워크|데이터베이스|클라우드)" .planning/deliverables/01-tech-stack-decision.md
      ```
  </verify>
  <done>
    - 01-tech-stack-decision.md의 Turnkey 관련 내용이 철회로 표시됨
    - 새로운 키 관리 방향 (직접 구축)이 추가됨
    - 수정 이력 섹션이 추가되어 변경 사항 추적 가능
    - AWS 클라우드 선택 근거가 업데이트됨
  </done>
</task>

</tasks>

<verification>
1. CUST-04 요구사항 충족:
   - WAIaaS에 권장하는 커스터디 모델이 제안됨
   - 선택 근거와 트레이드오프가 명시됨

2. 02-CONTEXT.md "Phase 1 Turnkey 결정 철회 필요" 충족:
   - 01-tech-stack-decision.md에서 Turnkey 결정이 철회됨
   - 직접 구축 방향이 반영됨

3. Phase 2 종합:
   - CUST-01, CUST-02, CUST-03 결과가 CUST-04에 종합됨
   - Phase 3 시스템 아키텍처로 연결될 기반 마련
</verification>

<success_criteria>
- [ ] 07-recommended-custody-model.md 파일 생성됨 (최소 400줄)
- [ ] 권장 모델 (AWS KMS + Nitro + Squads)이 명확히 제시됨
- [ ] 구성 요소별 선택 근거가 상세히 설명됨
- [ ] AI 에이전트 요구사항 충족 매핑이 포함됨
- [ ] 위험 요소와 완화 방안이 최소 4개 포함됨
- [ ] 비용 분석이 정량적으로 제시됨
- [ ] 01-tech-stack-decision.md에 Turnkey 철회가 반영됨
- [ ] 수정 이력 섹션이 추가됨
- [ ] 모든 내용이 한글로 작성됨
</success_criteria>

<output>
After completion, create `.planning/phases/02-custody-model/02-03-SUMMARY.md`
</output>
