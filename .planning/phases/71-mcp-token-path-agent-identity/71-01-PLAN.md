---
phase: 71-mcp-token-path-agent-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/session-manager.ts
  - packages/mcp/src/server.ts
  - packages/mcp/src/index.ts
  - packages/mcp/src/tools/send-token.ts
  - packages/mcp/src/tools/get-balance.ts
  - packages/mcp/src/tools/get-address.ts
  - packages/mcp/src/tools/get-nonce.ts
  - packages/mcp/src/tools/get-transaction.ts
  - packages/mcp/src/tools/list-transactions.ts
  - packages/mcp/src/resources/wallet-balance.ts
  - packages/mcp/src/resources/wallet-address.ts
  - packages/mcp/src/resources/system-status.ts
  - packages/mcp/src/__tests__/session-manager.test.ts
  - packages/mcp/src/__tests__/tools.test.ts
  - packages/mcp/src/__tests__/resources.test.ts
  - packages/mcp/src/__tests__/server.test.ts
autonomous: true

must_haves:
  truths:
    - "WAIAAS_AGENT_ID 설정 시 SessionManager가 DATA_DIR/mcp-tokens/<agentId> 경로에서 토큰을 읽고 쓴다"
    - "WAIAAS_AGENT_ID 미설정 시 기존 DATA_DIR/mcp-token 경로로 동작한다 (하위 호환)"
    - "새 경로에 토큰이 없고 기존 mcp-token 파일이 존재하면 fallback으로 로드한다"
    - "토큰 갱신 시 agentId에 해당하는 경로에 저장한다"
    - "WAIAAS_AGENT_NAME 설정 시 MCP 서버 이름이 waiaas-{agentName}이 된다"
    - "WAIAAS_AGENT_NAME 미설정 시 서버 이름이 waiaas-wallet을 유지한다"
    - "agentName 설정 시 도구/리소스 description에 에이전트 이름이 포함된다"
  artifacts:
    - path: "packages/mcp/src/session-manager.ts"
      provides: "agentId-aware token path routing + fallback"
      contains: "mcp-tokens"
    - path: "packages/mcp/src/server.ts"
      provides: "agentName-aware server naming + description injection"
      contains: "agentName"
    - path: "packages/mcp/src/index.ts"
      provides: "WAIAAS_AGENT_ID + WAIAAS_AGENT_NAME env var wiring"
      contains: "WAIAAS_AGENT_ID"
  key_links:
    - from: "packages/mcp/src/index.ts"
      to: "packages/mcp/src/session-manager.ts"
      via: "agentId option in constructor"
      pattern: "agentId.*WAIAAS_AGENT_ID"
    - from: "packages/mcp/src/index.ts"
      to: "packages/mcp/src/server.ts"
      via: "agentName option in createMcpServer"
      pattern: "agentName.*WAIAAS_AGENT_NAME"
    - from: "packages/mcp/src/session-manager.ts"
      to: "readFile/writeFile"
      via: "resolveTokenPath computes mcp-tokens/<agentId> or mcp-token"
      pattern: "mcp-tokens"
---

<objective>
SessionManager 토큰 경로를 에이전트별로 분리하고, createMcpServer에 에이전트 컨텍스트를 전달하여 서버 이름과 도구/리소스 description에 에이전트 이름을 포함시킨다.

Purpose: 하나의 WAIaaS 데몬에 여러 에이전트를 MCP로 동시 연결할 때 토큰 파일 충돌 방지 + Claude Desktop에서 어떤 에이전트 서버인지 식별 가능하게 한다.
Output: SessionManager agentId 토큰 경로 분리, createMcpServer agentName 식별, 6개 도구 + 3개 리소스 description 주입, index.ts 환경변수 연동, 테스트.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/mcp/src/session-manager.ts
@packages/mcp/src/server.ts
@packages/mcp/src/index.ts
@packages/mcp/src/api-client.ts
@packages/mcp/src/tools/send-token.ts
@packages/mcp/src/tools/get-balance.ts
@packages/mcp/src/tools/get-address.ts
@packages/mcp/src/tools/get-nonce.ts
@packages/mcp/src/tools/get-transaction.ts
@packages/mcp/src/tools/list-transactions.ts
@packages/mcp/src/resources/wallet-balance.ts
@packages/mcp/src/resources/wallet-address.ts
@packages/mcp/src/resources/system-status.ts
@packages/mcp/src/__tests__/session-manager.test.ts
@packages/mcp/src/__tests__/tools.test.ts
@packages/mcp/src/__tests__/resources.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SessionManager agentId 토큰 경로 분리 + fallback + 테스트</name>
  <files>
    packages/mcp/src/session-manager.ts
    packages/mcp/src/__tests__/session-manager.test.ts
  </files>
  <action>
**SessionManagerOptions에 agentId 추가:**
- `SessionManagerOptions` 인터페이스에 `agentId?: string` 필드 추가.
- 생성자에서 `this.agentId = options.agentId` 저장.

**private resolveTokenPath() 메서드 추가:**
- `agentId`가 설정된 경우: `join(this.dataDir!, 'mcp-tokens', this.agentId)` 반환.
- `agentId`가 미설정인 경우: `join(this.dataDir!, 'mcp-token')` 반환 (기존 동작).

**private legacyTokenPath() 메서드 추가:**
- 항상 `join(this.dataDir!, 'mcp-token')` 반환 (fallback용).

**readMcpToken() 수정:**
- 현재: `join(this.dataDir!, 'mcp-token')` 하드코딩.
- 변경: `this.resolveTokenPath()` 사용.
- **fallback 로직 추가 (TOKEN-03):** `agentId`가 설정된 경우, `resolveTokenPath()` 경로에서 readFile 실패하면 (ENOENT), `legacyTokenPath()`에서 한 번 더 시도. 성공하면 그 토큰을 반환. 실패하면 원래 에러 throw.
- fallback 성공 시: `console.error(\`${LOG_PREFIX} Loaded token from legacy path (fallback)\`)` 로깅.

**writeMcpToken() 수정:**
- 현재: `join(this.dataDir!, 'mcp-token')` 하드코딩.
- 변경: `this.resolveTokenPath()` 사용 (TOKEN-04: 갱신 시 항상 agentId 경로에 저장).
- `mkdir(dirname(filePath), { recursive: true })` 이미 있으므로 `mcp-tokens/` 디렉토리 자동 생성됨.

**테스트 추가 (`session-manager.test.ts`):**
새로운 `describe('agentId token path')` 블록 추가:

1. `agentId 설정 시 mcp-tokens/<agentId> 경로에서 토큰 로드`:
   - `SessionManager({ baseUrl, dataDir: '/tmp/waiaas', agentId: 'agent-1' })` 생성.
   - `mockedReadFile`이 `/tmp/waiaas/mcp-tokens/agent-1` 경로로 호출되는지 확인.
   - 상태가 `active`인지 확인.

2. `agentId 미설정 시 기존 mcp-token 경로 사용 (하위 호환)`:
   - `SessionManager({ baseUrl, dataDir: '/tmp/waiaas' })` 생성 (agentId 없음).
   - `mockedReadFile`이 `/tmp/waiaas/mcp-token` 경로로 호출되는지 확인.

3. `agentId 설정 + 새 경로에 토큰 없음 + 기존 mcp-token 존재 시 fallback 로드`:
   - `mockedReadFile`: 첫 호출 (agent 경로) ENOENT 에러, 두 번째 호출 (legacy 경로) 유효 토큰 반환.
   - `sm.start()` 후 `getState() === 'active'`, `getToken()`이 fallback 토큰과 일치.

4. `agentId 설정 + 새 경로에 토큰 있음 → fallback 시도 안 함`:
   - `mockedReadFile`: 첫 호출 성공.
   - `readFile`이 1번만 호출되는지 확인 (fallback path 접근 안 함).

5. `토큰 갱신 시 agentId 경로에 저장`:
   - `vi.useFakeTimers()`, 갱신 성공 시나리오.
   - `mockedWriteFile`이 `/tmp/waiaas/mcp-tokens/agent-1.tmp` 경로로 호출되는지 확인.
   - `mockedRename`이 `.tmp` → `/tmp/waiaas/mcp-tokens/agent-1`으로 호출되는지 확인.

6. `agentId 설정 + 양쪽 모두 토큰 없음 → error 상태`:
   - 두 경로 모두 ENOENT 에러.
   - envToken도 없음. `getState() === 'error'`.

**주의:** 기존 테스트가 깨지지 않도록 agentId가 없는 케이스(기존 테스트)는 그대로 유지. `readMcpToken`의 경로 변경이 기존 테스트에 영향을 주지 않는지 확인 -- 기존 테스트에서는 agentId 없으므로 `join(dataDir, 'mcp-token')`으로 동일하게 동작.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/mcp test` 실행하여 기존 + 새 테스트 모두 통과 확인.
  </verify>
  <done>
- agentId 설정 시 `DATA_DIR/mcp-tokens/<agentId>` 경로에서 토큰 읽기/쓰기.
- agentId 미설정 시 기존 `DATA_DIR/mcp-token` 경로 유지.
- 새 경로 토큰 없음 + 기존 경로 존재 시 fallback 로드 동작.
- 갱신 시 agentId 경로에 저장.
- 6개 신규 테스트 통과 + 기존 테스트 regression 없음.
  </done>
</task>

<task type="auto">
  <name>Task 2: createMcpServer agentContext + 도구/리소스 description + index.ts 환경변수 + 서버 테스트</name>
  <files>
    packages/mcp/src/server.ts
    packages/mcp/src/index.ts
    packages/mcp/src/tools/send-token.ts
    packages/mcp/src/tools/get-balance.ts
    packages/mcp/src/tools/get-address.ts
    packages/mcp/src/tools/get-nonce.ts
    packages/mcp/src/tools/get-transaction.ts
    packages/mcp/src/tools/list-transactions.ts
    packages/mcp/src/resources/wallet-balance.ts
    packages/mcp/src/resources/wallet-address.ts
    packages/mcp/src/resources/system-status.ts
    packages/mcp/src/__tests__/server.test.ts
    packages/mcp/src/__tests__/tools.test.ts
    packages/mcp/src/__tests__/resources.test.ts
  </files>
  <action>
**AgentContext 타입 정의 (server.ts):**
```typescript
export interface AgentContext {
  agentName?: string;  // e.g., 'trading-bot'
}
```

**createMcpServer 시그니처 변경:**
- `createMcpServer(apiClient: ApiClient, agentContext?: AgentContext): McpServer`
- 서버 이름: `agentContext?.agentName ? \`waiaas-${agentContext.agentName}\` : 'waiaas-wallet'`
- `agentContext`를 각 register 함수에 전달.

**도구 register 함수 시그니처 변경 (6개 모두):**
각 register 함수에 `agentContext?: AgentContext` 세 번째 매개변수 추가.
description 생성 로직:
- `agentName`이 있으면: description 앞에 `[{agentName}] ` 프리픽스 추가.
- 예: `[trading-bot] Send SOL or tokens from the agent wallet to a destination address...`
- `agentName`이 없으면: 기존 description 유지.

구체적으로:
- `send-token.ts`: `registerSendToken(server, apiClient, agentContext?)` → description에 프리픽스.
- `get-balance.ts`: `registerGetBalance(server, apiClient, agentContext?)` → description에 프리픽스.
- `get-address.ts`: `registerGetAddress(server, apiClient, agentContext?)` → description에 프리픽스.
- `list-transactions.ts`: `registerListTransactions(server, apiClient, agentContext?)` → description에 프리픽스.
- `get-transaction.ts`: `registerGetTransaction(server, apiClient, agentContext?)` → description에 프리픽스.
- `get-nonce.ts`: `registerGetNonce(server, apiClient, agentContext?)` → description에 프리픽스.

**리소스 register 함수 시그니처 변경 (3개 모두):**
- `wallet-balance.ts`: `registerWalletBalance(server, apiClient, agentContext?)` → description에 프리픽스.
  - 예: `[trading-bot] Current balance of the agent wallet`
- `wallet-address.ts`: `registerWalletAddress(server, apiClient, agentContext?)` → description에 프리픽스.
- `system-status.ts`: `registerSystemStatus(server, apiClient, agentContext?)` → description에 프리픽스.

**description 프리픽스 헬퍼 (server.ts에 정의):**
```typescript
export function withAgentPrefix(description: string, agentName?: string): string {
  return agentName ? `[${agentName}] ${description}` : description;
}
```
각 tool/resource 파일에서 `import { withAgentPrefix } from '../server.js'`로 사용.

**index.ts 환경변수 연동:**
- `WAIAAS_AGENT_ID` 환경변수 읽기: `const AGENT_ID = process.env['WAIAAS_AGENT_ID'];`
- `WAIAAS_AGENT_NAME` 환경변수 읽기: `const AGENT_NAME = process.env['WAIAAS_AGENT_NAME'];`
- SessionManager 생성 시: `agentId: AGENT_ID` 전달.
- createMcpServer 호출 시: `createMcpServer(apiClient, { agentName: AGENT_NAME })` 전달.
- AGENT_NAME 존재 시 로그: `console.error(\`[waiaas-mcp] Agent: ${AGENT_NAME} (id: ${AGENT_ID ?? 'default'})\`)`

**새 테스트 파일: server.test.ts:**
```
describe('createMcpServer', () => {
  1. 'agentName 미설정 시 서버 이름이 waiaas-wallet':
     - `createMcpServer(mockApiClient)` 호출.
     - 서버의 name 속성이 'waiaas-wallet'인지 확인 (McpServer 생성자 인자).

  2. 'agentName 설정 시 서버 이름이 waiaas-{agentName}':
     - `createMcpServer(mockApiClient, { agentName: 'trading-bot' })` 호출.
     - 서버의 name이 'waiaas-trading-bot'인지 확인.

  3. 'agentName 설정 시 도구 description에 에이전트 프리픽스 포함':
     - McpServer.tool() 호출을 스파이로 캡처.
     - description 인자에 '[trading-bot]' 프리픽스가 있는지 확인.

  4. 'agentName 설정 시 리소스 description에 에이전트 프리픽스 포함':
     - McpServer.resource() 호출을 스파이로 캡처.
     - description 인자에 '[trading-bot]' 프리픽스가 있는지 확인.

  5. 'agentName 미설정 시 description에 프리픽스 없음':
     - McpServer.tool() 호출 캡처, description에 '[' 프리픽스 없는지 확인.
})
```

**구현 전략:** `createMcpServer`를 스파이 서버로 테스트하기 어려울 수 있으므로, 대안으로 McpServer를 모킹하지 않고 `withAgentPrefix` 유틸 함수만 유닛 테스트하고, 나머지는 실제 McpServer 인스턴스 생성으로 smoke test. McpServer 내부 등록된 도구 목록에 접근하기 어려우면, server.ts에서 McpServer 생성자를 스파이하거나 `tool()` 호출을 인터셉트하는 방식 사용 (기존 tools.test.ts의 `getToolHandler` 패턴 참조).

**기존 테스트 호환성:**
- `tools.test.ts`의 `getToolHandler` 헬퍼: 현재 `registerFn(server, apiClient)` 호출. agentContext 매개변수 추가 후에도 `undefined`로 전달되므로 기존 테스트 동작 유지됨 (기본값 없음 = 프리픽스 없음).
- `resources.test.ts`: 동일하게 기존 테스트 영향 없음.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/mcp test` 실행하여 모든 테스트 통과 확인.
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/mcp build` 실행하여 빌드 성공 확인.
  </verify>
  <done>
- agentName 설정 시 서버 이름 `waiaas-{agentName}`, 미설정 시 `waiaas-wallet`.
- agentName 설정 시 6개 도구 + 3개 리소스 description에 `[agentName]` 프리픽스.
- agentName 미설정 시 기존 description 유지.
- index.ts에서 WAIAAS_AGENT_ID, WAIAAS_AGENT_NAME 환경변수를 SessionManager와 createMcpServer에 전달.
- 서버 이름/description 테스트 5개 + withAgentPrefix 유닛 테스트 통과.
- 빌드 성공, 기존 테스트 regression 없음.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/mcp test` -- 전체 테스트 통과 (기존 + 신규)
2. `pnpm --filter @waiaas/mcp build` -- 타입 체크 + 빌드 성공
3. 수동 확인: `WAIAAS_AGENT_ID=agent-1 WAIAAS_AGENT_NAME=trading-bot node packages/mcp/dist/index.js` 실행 시 stderr에 `Agent: trading-bot (id: agent-1)` 로그 출력
</verification>

<success_criteria>
- TOKEN-01: agentId 설정 시 `DATA_DIR/mcp-tokens/<agentId>` 경로 사용
- TOKEN-02: agentId 미설정 시 `DATA_DIR/mcp-token` 경로 유지 (하위 호환)
- TOKEN-03: 새 경로 토큰 없음 + 기존 `mcp-token` 존재 시 fallback 로드
- TOKEN-04: 갱신 시 agentId 경로에 저장
- MCPS-01: `WAIAAS_AGENT_NAME` 설정 시 서버 이름 `waiaas-{agentName}`
- MCPS-02: `WAIAAS_AGENT_NAME` 미설정 시 서버 이름 `waiaas-wallet` 유지
- MCPS-03: 도구/리소스 description에 에이전트 이름 포함
- 기존 테스트 regression 없음
</success_criteria>

<output>
After completion, create `.planning/phases/71-mcp-token-path-agent-identity/71-01-SUMMARY.md`
</output>
