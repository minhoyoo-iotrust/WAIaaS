---
phase: 35-dx-설계-문서-통합
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/54-cli-flow-redesign.md
autonomous: true

must_haves:
  truths:
    - "agent create --owner가 선택 옵션으로 명세되어 있다 (DX-01)"
    - "set-owner, remove-owner, withdraw CLI 명령어가 명세되어 있다 (DX-02, DX-03)"
    - "--quickstart가 --owner 없이 --chain만으로 동작하는 스펙이 명세되어 있다 (DX-04)"
    - "Owner 미등록 에이전트의 agent info 출력에 등록 안내 메시지가 명세되어 있다 (DX-05)"
    - "Kill Switch withdraw Open Question이 방안 A로 결정되어 반영되어 있다"
  artifacts:
    - path: ".planning/deliverables/54-cli-flow-redesign.md"
      provides: "v0.8 CLI 플로우 전면 갱신 (22개 위치)"
      contains: "[v0.8]"
  key_links:
    - from: "54-cli-flow-redesign.md set-owner 명령"
      to: "34-owner-wallet-connection.md 섹션 10.6"
      via: "OwnerLifecycleService 인증 맵 1:1 매핑"
    - from: "54-cli-flow-redesign.md withdraw 명령"
      to: "37-rest-api §8.18 withdraw API"
      via: "REST API 호출부 매핑"
---

<objective>
54-cli-flow-redesign.md를 v0.8 Owner 선택적 모델에 맞게 전면 갱신한다.

Purpose: v0.5에서 --owner 필수로 설계된 CLI 문서를 v0.8의 --owner 선택으로 전환하고, set-owner/remove-owner/withdraw 3개 신규 CLI 명령어를 추가하여, 구현 시점에 CLI DX가 명확한 기준으로 존재하도록 한다.
Output: 54-cli-flow-redesign.md v0.8 전면 갱신 (22개 위치 변경, 3개 대규모 신규 섹션)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/deliverables/54-cli-flow-redesign.md
@.planning/deliverables/34-owner-wallet-connection.md (섹션 10 Owner 생명주기)
@.planning/deliverables/37-rest-api-complete-spec.md (§8.18 withdraw API)
@.planning/deliverables/36-killswitch-autostop-evm.md (killSwitchGuard 허용 경로)
@.planning/phases/34-자금-회수-보안-분기-설계/34-01-SUMMARY.md (Kill Switch withdraw Open Question)
@.planning/phases/35-dx-설계-문서-통합/35-RESEARCH.md (22개 변경 위치 상세 분석)
@objectives/v0.8-optional-owner-progressive-security.md (§3 CLI 변경, §5 자금 회수)
</context>

<tasks>

<task type="auto">
  <name>Task 1: agent create --owner 선택 전환 + 기존 섹션 v0.8 갱신</name>
  <files>.planning/deliverables/54-cli-flow-redesign.md</files>
  <action>
54-cli-flow-redesign.md에서 아래 12개 소-중 규모 위치를 v0.8로 갱신한다. 모든 변경 부분에 [v0.8] 태그를 부착한다.

**갱신 대상 (소규모 12개):**

1. **섹션 1.2 요구사항 매핑**: DX-02 "owner Required" → "owner Optional (선택)"
2. **섹션 1.4 변경 요약**: "owner_address NOT NULL 근거" → "nullable 전환 근거, v0.8 Owner 선택적 모델"
3. **섹션 2.2 init 플로우**: 다음 단계 예시 `agent create --owner <addr>` → `agent create` (--owner 선택)
4. **섹션 2.3 출력 예시**: `waiaas agent create --owner <owner-address>` → `waiaas agent create` 또는 `waiaas agent create --owner <addr>`
5. **섹션 2.8 제거 단계**: NOT NULL 필수 근거 → nullable 전환 근거
6. **섹션 3.3 동작 설명**: ownerAddress 필수 Body → ownerAddress 선택적 Body
7. **섹션 3.5 에러 처리**: --owner 미지정 에러 항목 제거, Owner 미등록 시 안내 메시지 추가
8. **섹션 3.6 parseArgs**: `owner: required validation` → `owner: optional`
9. **섹션 3.7 API 호출**: ownerAddress 필수 → ownerAddress 선택적 (undefined 허용)
10. **섹션 6.7 비대화형 예시**: `--owner` 필수 → 선택
11. **섹션 6.8 구현 수도코드**: `options.owner` 필수 체크 제거, undefined일 때 ownerAddress 미전달
12. **부록 A 검증 체크리스트**: NOT NULL 참조 → nullable 참조

**갱신 대상 (중규모 7개):**

13. **섹션 3.2 커맨드 인터페이스**: `Required: --owner` → `Options: --owner (선택)` [v0.8]
14. **섹션 3.4 출력 예시**: Owner 있는 경우만 → Owner 없음 + 있음 두 가지 출력 예시. Owner 없음 출력에 등록 안내 메시지 포함.
15. **섹션 6.2 커맨드 인터페이스**: --quickstart의 `Required: --owner` → `Options: --owner (선택)` [v0.8]
16. **섹션 6.3 필수 옵션**: --owner 필수 → --chain만 필수, --owner 선택
17. **섹션 6.5 출력 예시**: Owner 항상 표시 → Owner 유무별 두 가지 출력 (Owner 없음 시 등록 안내)
18. **섹션 8 마이그레이션**: NOT NULL 마이그레이션 참조 → nullable 마이그레이션 참조 (31-01에서 정의된 테이블 재생성 패턴)
19. **agent info 출력 확장** (섹션 5.1 또는 적절한 위치): Owner 미등록 시 안내 메시지 출력 예시 신규 추가 (DX-05)

**agent info 출력 예시 (신규):**
```
$ waiaas agent info trading-bot

Agent: trading-bot
  ID:       01950288-...
  Chain:    solana
  Network:  devnet
  Address:  9bKrTD...
  Status:   ACTIVE
  Owner:    (미등록)

  [v0.8] Owner 지갑을 등록하면 대액 거래 승인, 자금 회수 등
  추가 보안 기능을 사용할 수 있습니다:
    waiaas agent set-owner trading-bot <owner-address>
```

Owner 등록 완료 시:
```
  Owner:    9wB3Lz... (verified)    # LOCKED
  Owner:    9wB3Lz... (pending)     # GRACE
```

**완료 후 검증**: 문서 내 "NOT NULL" + "owner" 조합 키워드 검색하여 v0.5 잔존 참조 없음을 확인.
  </action>
  <verify>
grep -c "\[v0.8\]" .planning/deliverables/54-cli-flow-redesign.md 결과가 19개 이상 (기존 0 + 신규 19개 이상). "NOT NULL" + "owner_address" 동시 출현 횟수가 0이거나 v0.8 변경 맥락 내에서만 사용.
  </verify>
  <done>
54-cli-flow-redesign.md의 19개 소-중 규모 위치가 v0.8로 갱신되고, agent info Owner 미등록 안내 메시지가 명세되어 있다. --owner가 모든 곳에서 선택 옵션이다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 대규모 신규 섹션 3개 추가 (agent create 출력 분기, Owner 커맨드, --quickstart 간소화)</name>
  <files>.planning/deliverables/54-cli-flow-redesign.md</files>
  <action>
54-cli-flow-redesign.md에 아래 3개 대규모 변경을 적용한다.

**1. 섹션 3 agent create 출력 분기 (대규모):**
- Owner 없이 생성한 경우의 전체 출력 예시 (등록 안내 메시지 포함)
- Owner와 함께 생성한 경우의 전체 출력 예시 (기존과 유사 + GRACE 상태 명시)
- `createAgent()` 함수 수도코드에서 ownerAddress?: string 선택 처리

**2. 섹션 5 커맨드 표에 3개 신규 CLI 명령 추가 (대규모):**

a) `waiaas agent set-owner <agent-name|id> <address>`:
   - 인증: masterAuth(implicit). LOCKED 상태에서는 ownerAuth + masterAuth 필요 (34 문서 §10.3 인증 맵 준수)
   - 동작: POST /v1/agents/:agentId/owner (34 문서 §10.6 REST API 매핑)
   - 에러: AGENT_NOT_FOUND, INVALID_OWNER_ADDRESS, OWNER_CHANGE_REQUIRES_CURRENT_OWNER (LOCKED), 503 SYSTEM_LOCKED (Kill Switch)
   - 출력 예시 (성공/에러)

b) `waiaas agent remove-owner <agent-name|id>`:
   - 인증: masterAuth(implicit)
   - 동작: DELETE /v1/agents/:agentId/owner (34 문서 §10.6 REST API 매핑)
   - 제약: GRACE 상태에서만 동작 (LOCKED에서 불가 -- DX-03, OWNER-06)
   - 에러: AGENT_NOT_FOUND, OWNER_NOT_FOUND, OWNER_REMOVAL_BLOCKED (LOCKED), 503 SYSTEM_LOCKED
   - 출력 예시 (성공/에러)

c) `waiaas owner withdraw --agent <agent-name|id> [--scope all|native]`:
   - 인증: masterAuth(implicit) -- 수신 주소 owner_address 고정이므로 (34-01 결정)
   - 동작: POST /v1/owner/agents/:agentId/withdraw (37-rest-api §8.18)
   - scope 기본값: "all" (네이티브 + SPL 토큰 + rent)
   - 제약: LOCKED(owner_verified=1) 상태에서만 동작 (WITHDRAW-08 보안 정책)
   - Kill Switch 상태 동작: **허용** -- killSwitchGuard 허용 경로에 withdraw 추가 (방안 A 채택)
     - 근거: Kill Switch 발동 시 자금 회수가 가장 시급한 조치. CLI 직접 실행(방안 B)은 데몬 API 우회로 일관성 저하.
     - 36-killswitch에 반영 필요 사항 메모: killSwitchGuard 5번째 허용 경로 `POST /v1/owner/agents/:agentId/withdraw` 추가
   - 에러: NO_OWNER, WITHDRAW_LOCKED_ONLY (GRACE), SWEEP_TOTAL_FAILURE, INSUFFICIENT_FOR_FEE
   - 출력 예시 (성공: scope all, 부분 실패: HTTP 207)
   - [v0.8] 태그 부착

**3. 섹션 6 --quickstart 간소화 (대규모):**
- --quickstart 필수 옵션: --chain만 (--owner 제거)
- `waiaas init --quickstart --chain solana` 전체 4스테이지 출력 예시 (Owner 없음)
- `waiaas init --quickstart --chain solana --owner <addr>` 출력 예시 (Owner 있음)
- Stage 3(agent create) 수도코드에서 ownerAddress가 undefined일 때의 분기 명시
- Quickstart 완료 후 Owner 등록 안내 메시지 (--owner 미지정 시)

**Kill Switch withdraw 결정 기록:**
섹션 또는 변경 이력에 다음을 명시:
> [v0.8] Kill Switch withdraw: 방안 A 채택 -- killSwitchGuard 허용 경로에 withdraw 추가.
> 근거: 자금 회수는 Kill Switch 발동 시 가장 시급한 보안 조치이며, 기존 API 인프라를 재사용한다.
  </action>
  <verify>
1. 54 문서에서 "set-owner" 검색 시 CLI 명령어 스펙이 존재한다.
2. 54 문서에서 "remove-owner" 검색 시 CLI 명령어 스펙이 존재하고 GRACE 제약이 명시되어 있다.
3. 54 문서에서 "withdraw" 검색 시 `waiaas owner withdraw` CLI 명령어 스펙이 존재한다.
4. --quickstart 섹션에서 "--owner" 가 Optional로 표기되고 --chain만 필수이다.
5. Kill Switch withdraw 방안 A 채택이 문서에 기록되어 있다.
  </verify>
  <done>
set-owner, remove-owner, withdraw 3개 신규 CLI 명령어가 인증/동작/에러/출력 수준으로 상세 명세되어 있다. --quickstart가 --chain만으로 동작한다. Kill Switch withdraw가 방안 A(killSwitchGuard 허용)로 결정되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 54-cli-flow-redesign.md에서 [v0.8] 태그 검색 -- 22개 이상 변경 위치에 태그 부착
2. "NOT NULL" + "owner_address" 잔존 검색 -- 0건 (v0.8 변경 맥락 제외)
3. DX-01: agent create --owner가 Optional (Required 아님)
4. DX-02: set-owner CLI 명령어 존재
5. DX-03: remove-owner CLI 명령어 존재, GRACE 제약 명시
6. DX-04: --quickstart --chain만으로 동작
7. DX-05: agent info Owner 미등록 안내 메시지 존재
8. Kill Switch withdraw 방안 A 결정 기록 존재
</verification>

<success_criteria>
- 54-cli-flow-redesign.md가 v0.8 기준으로 전면 갱신되어 [v0.8] 태그 22개 이상 포함
- DX-01~DX-05 전체 요구사항이 충족됨
- 34 문서 §10.3 인증 맵과 CLI 명령어 인증이 1:1 대응
- Kill Switch withdraw Open Question이 방안 A로 결정되어 기록됨
</success_criteria>

<output>
After completion, create `.planning/phases/35-dx-설계-문서-통합/35-01-SUMMARY.md`
</output>
