---
phase: 35-dx-설계-문서-통합
plan: 02
type: execute
wave: 2
depends_on: [35-01]
files_modified:
  - objectives/v0.8-optional-owner-progressive-security.md
autonomous: true

must_haves:
  truths:
    - "API x OwnerState(NONE/GRACE/LOCKED) 매트릭스가 SSoT로 작성되어 있다 (INTEG-02)"
    - "매트릭스 내용이 Phase 31-34 각 문서의 동작 분기와 일치한다"
    - "매트릭스가 35-01에서 결정된 CLI 명령어(set-owner, remove-owner, withdraw)를 포함한다"
    - "GRACE에서 APPROVAL 거래 시 ownerAuth 승인 대기 + 첫 사용 시 LOCKED 자동 전이가 정확히 표기되어 있다"
  artifacts:
    - path: "objectives/v0.8-optional-owner-progressive-security.md"
      provides: "Owner 상태 분기 매트릭스 SSoT 섹션"
      contains: "Owner 상태 분기 매트릭스"
  key_links:
    - from: "매트릭스 APPROVAL 행"
      to: "33-time-lock §Step 9.5"
      via: "다운그레이드 조건 (NONE: DELAY, GRACE: ownerAuth→LOCKED, LOCKED: ownerAuth)"
    - from: "매트릭스 withdraw 행"
      to: "37-rest-api §8.18 + 34-01 WithdrawService"
      via: "LOCKED only, GRACE 불가"
    - from: "매트릭스 Kill Switch 복구 행"
      to: "36-killswitch + 34-02 복구 분기"
      via: "Owner 없음 24h vs Owner 있음 30min"
---

<objective>
Owner 상태 분기 매트릭스를 SSoT로 작성하여 14개 설계 문서의 일관성 기준점을 확립한다.

Purpose: Phase 31-34에서 각 문서에 분산 반영된 Owner 상태별 동작 분기를 단일 매트릭스로 통합하여, 문서 간 불일치를 방지하고 구현 시 참조할 단일 진실 원천을 확보한다. 매트릭스는 v0.8 objective 문서에 추가하여 마일스톤 수준 SSoT로 기능한다.
Output: objectives/v0.8-optional-owner-progressive-security.md에 Owner 상태 분기 매트릭스 SSoT 섹션 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v0.8-optional-owner-progressive-security.md

# Phase 31-34 산출물 (동작 분기 근거)
@.planning/deliverables/33-time-lock-approval-mechanism.md (Step 9.5 다운그레이드 분기)
@.planning/deliverables/34-owner-wallet-connection.md (섹션 10 Owner 생명주기, 인증 맵)
@.planning/deliverables/37-rest-api-complete-spec.md (§8.18 withdraw)
@.planning/deliverables/36-killswitch-autostop-evm.md (복구 분기)
@.planning/deliverables/53-session-renewal-protocol.md (세션 갱신 분기)
@.planning/deliverables/35-notification-architecture.md (알림 분기)
@.planning/deliverables/52-auth-model-redesign.md (ownerAuth Step 8.5)
@.planning/deliverables/32-transaction-pipeline-api.md (Stage 4 알림 분기)

# 35-01 CLI 결정 참조
@.planning/phases/35-dx-설계-문서-통합/35-01-SUMMARY.md
@.planning/phases/35-dx-설계-문서-통합/35-RESEARCH.md (Open Question 3: GRACE APPROVAL 동작)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Owner 상태 분기 매트릭스 SSoT 작성</name>
  <files>objectives/v0.8-optional-owner-progressive-security.md</files>
  <action>
objectives/v0.8-optional-owner-progressive-security.md에 새로운 섹션 "## 부록: Owner 상태 분기 매트릭스 (SSoT)"를 추가한다. 문서 최하단(기존 내용 뒤)에 배치한다.

**매트릭스 구조:**
행: 기능/API 엔드포인트 (약 18-20개 행)
열: NONE (Owner 없음) | GRACE (유예: owner_address 있음, owner_verified=0) | LOCKED (잠금: owner_verified=1)

**매트릭스에 포함할 행 (근거 문서):**

| 기능 | NONE | GRACE | LOCKED | 근거 |
|------|------|-------|--------|------|
| 에이전트 생성 `POST /v1/agents` | ownerAddress 선택적 | - | - | 32-01 |
| INSTANT 거래 | 즉시 실행 | 즉시 실행 | 즉시 실행 | 33-01 |
| NOTIFY 거래 | 즉시 + 알림 | 즉시 + 알림 | 즉시 + 알림 | 33-01 |
| DELAY 거래 | 쿨다운 + 알림 | 쿨다운 + 알림 | 쿨다운 + 알림 | 33-01 |
| APPROVAL 거래 | **DELAY 다운그레이드** | ownerAuth 승인 대기 (첫 사용 시 LOCKED 전이) | ownerAuth 승인 대기 | 33-01 Step 9.5 |
| 다운그레이드 알림 | TX_DOWNGRADED_DELAY | 해당 없음 (정상 APPROVAL) | 해당 없음 | 33-02 |
| 자금 회수 `withdraw` | **불가** (Owner 없음) | **불가** (LOCKED만) | masterAuth | 34-01, WITHDRAW-08 |
| Kill Switch 발동 | masterAuth | masterAuth | masterAuth 또는 ownerAuth | 36-killswitch |
| Kill Switch 복구 대기 | masterAuth + **24h** | masterAuth + **24h** | ownerAuth + masterAuth + **30min** | 34-02 |
| Kill Switch withdraw | **불가** | **불가** | masterAuth (killSwitchGuard 허용) | 35-01 방안 A |
| 세션 갱신 | 즉시 확정 | 즉시 확정 | [거부하기] 활성 | 34-02, SECURITY-03/04 |
| Owner 등록 `set-owner` | masterAuth | - (이미 등록) | - (이미 등록) | 32-01 §10.3 |
| Owner 변경 `set-owner` | - | masterAuth | ownerAuth + masterAuth | 32-01 §10.3 |
| Owner 해제 `remove-owner` | - (Owner 없음) | masterAuth | **불가** (OWNER-06) | 32-01 §10.3 |
| `agent info` 출력 | 등록 안내 메시지 | Owner 주소 + "(pending)" | Owner 주소 + "(verified)" | 35-01, DX-05 |
| `--quickstart` | --chain만 필수 | - | - | 35-01, DX-04 |
| APPROVAL 승인 알림 | 해당 없음 (다운그레이드) | [승인]/[거부] 버튼 | [승인]/[거부] 버튼 | 33-02 |
| 세션 갱신 알림 | 해당 없음 | 해당 없음 | [거부하기] 버튼 | 34-02 |

**GRACE APPROVAL 정확한 동작 (Research Open Question 3 결론):**
- GRACE 상태에서 APPROVAL 거래 → owner_address가 존재하므로 다운그레이드 미발생 (33-01 Step 9.5 조건: `!agent.owner_address`)
- ownerAuth 서명 요청 → Owner가 처음 서명하면 Step 8.5에서 markOwnerVerified() 호출 → 자동 LOCKED 전이
- 매트릭스에 "ownerAuth 승인 대기 (첫 사용 시 LOCKED 전이)" 로 정확히 표기

**매트릭스 작성 후 교차 검증:**
- 각 행의 동작을 근거 문서와 대조하여 불일치 없음을 확인
- STATE.md 결정 사항과 매트릭스가 일관적인지 확인
- 특히: GRACE withdraw 불가 (H-02), LOCKED remove-owner 불가 (OWNER-06), Kill Switch 복구 시간 분기 (34-02)

**매트릭스 서문:**
> 이 매트릭스는 v0.8 Owner 선택적 모델의 전체 동작 분기를 정의하는 SSoT(Single Source of Truth)이다.
> 14개 설계 문서의 v0.8 변경 사항은 이 매트릭스와 일관되어야 한다.
> Phase 31-34 산출물에서 확정된 동작을 통합하였다.

**매트릭스 하단 각주:**
- [1] DELAY 다운그레이드: APPROVAL → DELAY 전환, delaySeconds = SPENDING_LIMIT.delay_seconds || 300초 (최소 60초)
- [2] ownerAuth 첫 사용 시 LOCKED 전이: Step 8.5 markOwnerVerified() 자동 호출
- [3] Kill Switch withdraw 허용: killSwitchGuard 5번째 허용 경로 (35-01 결정)
- [4] LOCKED remove-owner 불가: 보안 다운그레이드 방지 (OWNER-06)
  </action>
  <verify>
1. objectives/v0.8 문서에 "Owner 상태 분기 매트릭스" 섹션이 존재한다.
2. 매트릭스에 최소 15개 이상의 행이 있다.
3. NONE/GRACE/LOCKED 3개 열이 모든 행에 명시되어 있다.
4. "SSoT" 키워드가 매트릭스 섹션에 포함되어 있다.
5. 각주가 4개 이상 존재한다.
  </verify>
  <done>
Owner 상태 분기 매트릭스가 SSoT로 작성되어 objectives/v0.8 문서에 존재하고, Phase 31-34 각 문서의 동작 분기와 일관되며, 35-01에서 결정된 CLI 명령어를 포함한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 매트릭스-문서 간 교차 검증 + v0.8 objective 본문 CLI 섹션 보강</name>
  <files>objectives/v0.8-optional-owner-progressive-security.md</files>
  <action>
매트릭스 작성 후 기존 v0.8 objective 본문의 CLI 관련 섹션(§3 CLI/DX 변경, §4, §5 등)을 검토하여, 매트릭스와 불일치하는 부분이 있으면 [v0.8-SSoT] 태그로 보강한다.

**교차 검증 항목:**
1. §3 CLI 변경 섹션에서 set-owner, remove-owner, withdraw CLI 명령어가 35-01 결정과 일치하는지 확인
2. §5 자금 회수 섹션에서 Kill Switch withdraw 방안 A 결정이 반영되어 있는지 확인. 반영되어 있지 않으면 주석 또는 참조 추가.
3. §3에서 --quickstart 간소화 내용이 매트릭스와 일치하는지 확인

**보강이 필요한 경우만 수정.** 이미 일치하면 수정 없이 통과.

**추가:** v0.8 objective 문서의 "영향 문서 14개 목록" 섹션이 있다면, Phase 35 실행 후 "35-03에서 반영 완료" 상태로 업데이트할 수 있도록 체크리스트 형식 확인.
  </action>
  <verify>
1. objectives/v0.8 문서 전체에서 매트릭스와 본문 간 모순이 없다.
2. Kill Switch withdraw 방안 A가 §5에 반영되었거나 매트릭스에서 참조된다.
  </verify>
  <done>
매트릭스와 v0.8 objective 본문 간 일관성이 확보되고, Kill Switch withdraw 결정이 문서에 기록되어 있다.
  </done>
</task>

</tasks>

<verification>
1. Owner 상태 분기 매트릭스가 objectives/v0.8 문서에 SSoT로 존재 (INTEG-02)
2. 매트릭스가 최소 15행 x 3열(NONE/GRACE/LOCKED) 구조
3. GRACE APPROVAL = "ownerAuth 승인 대기 (첫 사용 시 LOCKED 전이)" 표기
4. GRACE withdraw = "불가" 표기 (H-02 방어)
5. LOCKED remove-owner = "불가" 표기 (OWNER-06)
6. Kill Switch 복구 시간 분기 (24h vs 30min) 표기
7. Kill Switch withdraw = "masterAuth (killSwitchGuard 허용)" 표기
8. 매트릭스 서문에 SSoT 선언 포함
</verification>

<success_criteria>
- Owner 상태 분기 매트릭스가 SSoT 선언과 함께 objectives/v0.8에 존재
- 매트릭스 내용이 Phase 31-34 결정 사항 25건과 일관
- 35-03 통합 작업의 기준점으로 활용 가능
</success_criteria>

<output>
After completion, create `.planning/phases/35-dx-설계-문서-통합/35-02-SUMMARY.md`
</output>
