---
phase: 35-dx-설계-문서-통합
plan: 03
type: execute
wave: 3
depends_on: [35-01, 35-02]
files_modified:
  - .planning/deliverables/30-session-token-protocol.md
  - .planning/deliverables/31-solana-adapter-detail.md
  - .planning/deliverables/40-telegram-bot-docker.md
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/52-auth-model-redesign.md
  - .planning/deliverables/33-time-lock-approval-mechanism.md
  - .planning/deliverables/34-owner-wallet-connection.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/27-chain-adapter-interface.md
  - .planning/deliverables/36-killswitch-autostop-evm.md
  - .planning/deliverables/53-session-renewal-protocol.md
  - .planning/deliverables/35-notification-architecture.md
  - .planning/deliverables/32-transaction-pipeline-api.md
  - docs/57-asset-query-fee-estimation-spec.md
  - docs/60-batch-transaction-spec.md
  - docs/61-price-oracle-spec.md
autonomous: true

must_haves:
  truths:
    - "14개 기존 설계 문서에 [v0.8] 태그로 변경 사항이 반영되어 있다 (INTEG-01)"
    - "4개 미변경 문서(30, 31, 40, +54는 35-01에서 완료)에 첫 v0.8 태그가 추가되어 있다"
    - "3개 참조 문서(57, 60, 61)에 sweepAll/다운그레이드 관련 교차 참조가 추가되어 있다"
    - "기존 10개 문서의 v0.8 태그가 35-02 매트릭스와 일관된다"
    - "killSwitchGuard에 withdraw 5번째 허용 경로가 반영되어 있다 (35-01 결정)"
  artifacts:
    - path: ".planning/deliverables/30-session-token-protocol.md"
      provides: "세션 갱신 Owner 분기 v0.8 참조"
      contains: "[v0.8]"
    - path: ".planning/deliverables/31-solana-adapter-detail.md"
      provides: "sweepAll Solana 구현 v0.8 참조"
      contains: "[v0.8]"
    - path: ".planning/deliverables/40-telegram-bot-docker.md"
      provides: "다운그레이드 알림, 거부 버튼 v0.8 참조"
      contains: "[v0.8]"
    - path: ".planning/deliverables/36-killswitch-autostop-evm.md"
      provides: "killSwitchGuard 5번째 허용 경로 (withdraw)"
      contains: "withdraw"
  key_links:
    - from: "30-session 세션 갱신"
      to: "53-session-renewal Owner 분기"
      via: "[v0.8] 교차 참조"
    - from: "31-solana sweepAll"
      to: "27-chain-adapter §6.11"
      via: "Solana 4단계 구현 참조"
    - from: "36-killswitch killSwitchGuard"
      to: "37-rest-api §8.18 withdraw"
      via: "5번째 허용 경로"
---

<objective>
14개 기존 설계 문서에 v0.8 Owner 선택적 모델을 통합 반영하고, 3개 참조 문서에 교차 참조를 추가한다.

Purpose: Phase 31-34에서 개별 반영된 v0.8 변경을 전체 문서 수준에서 교차 검증하고, 아직 v0.8이 반영되지 않은 4개 문서에 첫 변경을 적용하여, 모든 설계 문서가 35-02 매트릭스 SSoT와 일관되도록 한다.
Output: 14개 설계 문서 + 3개 참조 문서에 v0.8 통합 반영 완료
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# SSoT 매트릭스 (35-02 산출물)
@.planning/phases/35-dx-설계-문서-통합/35-02-SUMMARY.md
@objectives/v0.8-optional-owner-progressive-security.md (부록: Owner 상태 분기 매트릭스)

# 35-01 결정 사항 (Kill Switch withdraw 방안 A 등)
@.planning/phases/35-dx-설계-문서-통합/35-01-SUMMARY.md

# 14개 대상 설계 문서 -- 읽기 전용 참조
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/27-chain-adapter-interface.md
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/31-solana-adapter-detail.md
@.planning/deliverables/32-transaction-pipeline-api.md
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/deliverables/34-owner-wallet-connection.md
@.planning/deliverables/35-notification-architecture.md
@.planning/deliverables/36-killswitch-autostop-evm.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/40-telegram-bot-docker.md
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/53-session-renewal-protocol.md

# 3개 참조 문서
@docs/57-asset-query-fee-estimation-spec.md
@docs/60-batch-transaction-spec.md
@docs/61-price-oracle-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 4개 미변경 문서 첫 v0.8 반영 + 36-killswitch withdraw 허용 경로 추가</name>
  <files>
    .planning/deliverables/30-session-token-protocol.md
    .planning/deliverables/31-solana-adapter-detail.md
    .planning/deliverables/40-telegram-bot-docker.md
    .planning/deliverables/36-killswitch-autostop-evm.md
  </files>
  <action>
아래 4개 문서에 [v0.8] 태그로 첫 v0.8 변경을 반영한다. 35-02 매트릭스 SSoT와 일치하는 내용만 반영한다.

**A. 30-session-token-protocol.md (첫 v0.8 반영):**
1. 문서 헤더(업데이트 이력)에 v0.8 갱신 일자 추가
2. 세션 갱신 섹션에 [v0.8] Owner 유무별 분기 참조 추가:
   - "Owner 미등록(NONE/GRACE): 갱신 즉시 확정 (53-session-renewal-protocol.md 참조)"
   - "Owner 잠금(LOCKED): 갱신 후 [거부하기] 윈도우 활성 (34-02 설계 참조)"
3. 세션 토큰 발급 시 owner_address 유무에 따른 동작 차이가 있으면 명시 (없으면 "세션 토큰 자체는 Owner 유무와 무관" 명시)

**B. 31-solana-adapter-detail.md (첫 v0.8 반영):**
1. 문서 헤더에 v0.8 갱신 일자 추가
2. IChainAdapter 메서드 수 참조가 있다면 19 → 20으로 갱신 [v0.8]
3. sweepAll Solana 구현 관련 섹션이 없으면 [v0.8] 참조 추가:
   - "sweepAll(destinationAddress): Solana 4단계 실행 순서 (27-chain-adapter-interface.md §6.11 참조)"
   - "1. getAssets() → 2. buildBatch(SPL 토큰) → 3. 개별 fallback → 4. SOL 전송 (마지막)"
4. SolanaAdapter에 sweepAll 구현 지침이 이미 27 문서에 있음을 교차 참조

**C. 40-telegram-bot-docker.md (첫 v0.8 반영):**
1. 문서 헤더에 v0.8 갱신 일자 추가
2. 알림 관련 섹션에 [v0.8] v0.8 알림 유형 추가:
   - TX_DOWNGRADED_DELAY: APPROVAL → DELAY 다운그레이드 알림 + Owner 등록 안내 (33-02 참조)
   - APPROVAL 대기: [승인]/[거부] InlineKeyboard 버튼, url 기반 (33-02 참조)
   - SESSION_RENEWED: Owner LOCKED 시 [거부하기] InlineKeyboard 버튼 (34-02 참조)
3. Telegram Bot이 처리하는 알림 유형 목록에 위 3개 추가
4. Owner 미등록 에이전트에 대한 안내 메시지 처리 방법 명시 (다운그레이드 알림 본문에 set-owner CLI 안내 포함)

**D. 36-killswitch-autostop-evm.md (기존 9개 [v0.8] + 추가):**
1. killSwitchGuard 허용 경로 목록에 [v0.8] 5번째 경로 추가:
   - `POST /v1/owner/agents/:agentId/withdraw` -- Kill Switch 발동 시 자금 회수 허용 (35-01 방안 A)
2. 기존 4개 허용 경로(Kill Switch toggle, session renewal, health check, etc.)와 나란히 배치
3. 근거 주석: "자금 회수는 Kill Switch 발동 시 가장 시급한 보안 조치이며, 수신 주소가 owner_address로 고정되어 공격자 이득 없음"

**모든 변경에 [v0.8] 태그 부착.** 기존 내용은 최소한으로 수정하고 추가/보강 위주로 작업.
  </action>
  <verify>
1. 30-session: grep "[v0.8]" 결과 2개 이상
2. 31-solana: grep "[v0.8]" 결과 2개 이상, "sweepAll" 키워드 존재
3. 40-telegram: grep "[v0.8]" 결과 3개 이상, "TX_DOWNGRADED_DELAY" 키워드 존재
4. 36-killswitch: grep "withdraw" 결과에 killSwitchGuard 허용 경로 포함
  </verify>
  <done>
4개 미변경 문서에 첫 v0.8 태그가 적용되고, 36-killswitch에 withdraw 5번째 허용 경로가 추가되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 기존 10개 문서 교차 검증 + 3개 참조 문서 보강</name>
  <files>
    .planning/deliverables/25-sqlite-schema.md
    .planning/deliverables/52-auth-model-redesign.md
    .planning/deliverables/33-time-lock-approval-mechanism.md
    .planning/deliverables/34-owner-wallet-connection.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/27-chain-adapter-interface.md
    .planning/deliverables/53-session-renewal-protocol.md
    .planning/deliverables/35-notification-architecture.md
    .planning/deliverables/32-transaction-pipeline-api.md
    docs/57-asset-query-fee-estimation-spec.md
    docs/60-batch-transaction-spec.md
    docs/61-price-oracle-spec.md
  </files>
  <action>
**파트 A: 기존 10개 문서 교차 검증 (교정 필요 시만 수정)**

35-02 매트릭스 SSoT를 기준으로 기존 10개 문서의 v0.8 태그를 검증한다. 불일치 발견 시 수정하고, 일치하면 수정하지 않는다.

**검증 체크리스트:**

1. **25-sqlite-schema.md** (18개 [v0.8]):
   - agents.owner_address nullable + owner_verified 컬럼 정의 일관성
   - CHECK 제약에 owner_verified IN (0,1) 존재 확인

2. **52-auth-model-redesign.md** (10개 [v0.8]):
   - Step 8.5 markOwnerVerified 참조가 매트릭스의 GRACE→LOCKED 전이와 일치
   - change_owner action 인증 분기가 매트릭스의 set-owner 행과 일치

3. **33-time-lock-approval-mechanism.md** (25개 [v0.8]):
   - Step 9.5 다운그레이드 조건(`!agent.owner_address`)이 매트릭스의 NONE=다운그레이드, GRACE=정상APPROVAL과 일치
   - delaySeconds 결정 (SPENDING_LIMIT 우선, 300초 fallback, 60초 최소)

4. **34-owner-wallet-connection.md** (9개 [v0.8]):
   - 섹션 10 Owner 생명주기 상태 전이가 매트릭스와 일치
   - set-owner/remove-owner 인증 맵이 매트릭스와 일치
   - **추가 필요:** 매트릭스 SSoT 참조 링크 ("부록: Owner 상태 분기 매트릭스 → objectives/v0.8 참조")

5. **37-rest-api-complete-spec.md** (10개 [v0.8]):
   - §8.18 withdraw API가 매트릭스의 withdraw 행과 일치
   - Kill Switch 상태 withdraw 허용이 반영되어 있는지 확인 (35-01 방안 A). 없으면 [v0.8] 주석 추가.

6. **27-chain-adapter-interface.md** (1개 [v0.8]):
   - sweepAll 시그니처 (20번째 메서드) 확인
   - §6.11 Solana sweepAll 4단계가 매트릭스와 일치

7. **53-session-renewal-protocol.md** (5개 [v0.8]):
   - Owner 분기 (NONE/GRACE: 즉시, LOCKED: 거부 윈도우)가 매트릭스와 일치

8. **35-notification-architecture.md** (11개 [v0.8]):
   - TX_DOWNGRADED_DELAY 이벤트가 매트릭스의 다운그레이드 알림 행과 일치
   - SESSION_RENEWED [거부하기]가 매트릭스와 일치

9. **32-transaction-pipeline-api.md** (3개 [v0.8]):
   - Stage 4 알림 분기에서 PolicyDecision.downgraded 참조 확인

**불일치 발견 시:** 해당 위치에 [v0.8] 태그와 함께 수정 또는 교차 참조 추가. 수정 시 근거 문서(매트릭스 SSoT) 명시.

**파트 B: 3개 참조 문서 교차 참조 보강**

10. **docs/57-asset-query-fee-estimation-spec.md:**
   - sweepAll이 getAssets() 결과를 활용한다는 [v0.8] 교차 참조 추가
   - "sweepAll(27-chain-adapter §6.11)은 getAssets()로 토큰 잔액을 조회한 후 배치 전송한다" 문장 추가

11. **docs/60-batch-transaction-spec.md:**
   - sweepAll 토큰 배치가 buildBatch()를 활용한다는 [v0.8] 교차 참조 추가
   - "sweepAll의 SPL 토큰 배치 전송은 buildBatch()로 단일 트랜잭션에 포함하되, 실패 시 개별 fallback한다" 문장 추가

12. **docs/61-price-oracle-spec.md:**
   - APPROVAL 다운그레이드 판단 시 resolveEffectiveAmountUsd() 관련 [v0.8] 교차 참조 추가
   - "정책 다운그레이드 결정(33-time-lock Step 9.5)에서 거래 금액 USD 평가에 IPriceOracle을 활용한다" 문장 추가 (이미 존재하면 스킵)

**모든 추가/수정에 [v0.8] 태그 부착.**
  </action>
  <verify>
1. 14개 설계 문서 전체에서 [v0.8] 태그 총 수: 기존 101개 + Task 1 신규 + Task 2 보강 = 전체 합계 확인
2. 57, 60, 61 문서 각각에 [v0.8] 태그 1개 이상 추가
3. 34-owner-wallet-connection에 매트릭스 SSoT 참조 존재
4. 37-rest-api에 Kill Switch withdraw 허용 참조 존재
5. "NOT NULL" + "owner_address" 잔존 검색 -- 14개 문서 전체에서 v0.8 변경 맥락 외 0건
  </verify>
  <done>
기존 10개 문서의 v0.8 태그가 매트릭스와 교차 검증되고, 3개 참조 문서에 sweepAll/다운그레이드 교차 참조가 추가되어 있다. 14개 + 3개 = 17개 문서 전체가 v0.8 일관성을 확보했다.
  </done>
</task>

</tasks>

<verification>
1. 14개 설계 문서 + 54-cli (35-01 완료) 전체에 [v0.8] 태그 존재 (INTEG-01)
2. 30-session, 31-solana, 40-telegram에 첫 [v0.8] 태그 존재
3. 36-killswitch에 withdraw killSwitchGuard 5번째 허용 경로 존재
4. 37-rest-api에 Kill Switch withdraw 허용 주석 존재
5. 34-owner-wallet-connection에 매트릭스 SSoT 교차 참조 존재
6. 57, 60, 61 참조 문서에 [v0.8] 교차 참조 존재
7. 전체 문서에서 "NOT NULL" + "owner_address" 잔존 0건 (v0.8 맥락 제외)
8. 매트릭스 SSoT와 14개 문서 간 불일치 0건
</verification>

<success_criteria>
- 14개 기존 설계 문서 + 3개 참조 문서 전체에 v0.8 변경이 일관되게 반영
- 35-02 매트릭스와의 교차 검증 통과
- Kill Switch withdraw 허용 경로가 36-killswitch에 반영
- INTEG-01 요구사항 충족
</success_criteria>

<output>
After completion, create `.planning/phases/35-dx-설계-문서-통합/35-03-SUMMARY.md`
</output>
