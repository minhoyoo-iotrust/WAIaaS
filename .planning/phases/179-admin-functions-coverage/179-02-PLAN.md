---
phase: 179-admin-functions-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/__tests__/policies-coverage.test.tsx
  - packages/admin/src/__tests__/notifications-coverage.test.tsx
  - packages/admin/src/__tests__/zero-coverage.test.tsx
autonomous: true
requirements:
  - ADM-03
  - ADM-04

must_haves:
  truths:
    - "policies.tsx uncovered functions (openEdit, handleEdit, handleEditJsonToggle, openDelete, handleDelete, handleTypeChange, handleJsonToggle, handleCreate with validation, getWalletName, getPolicyTypeLabel, validateRules for all 12 types) are exercised by tests"
    - "notifications.tsx uncovered functions (handleTestChannel, handlePrevPage, handleNextPage, handleRowClick) are exercised by tests"
    - "0% coverage files (client.ts, layout.tsx, toast.tsx, copy-button.tsx, walletconnect.tsx, display-currency.ts) have their core functions tested"
    - "Policy form components at 0% coverage (ApproveAmountLimitForm, ApprovedSpendersForm, X402AllowedDomainsForm, ContractWhitelistForm, AllowedNetworksForm) are exercised by render tests"
  artifacts:
    - path: "packages/admin/src/__tests__/policies-coverage.test.tsx"
      provides: "Policies page function coverage tests"
      min_lines: 200
    - path: "packages/admin/src/__tests__/notifications-coverage.test.tsx"
      provides: "Notifications page function coverage tests"
      min_lines: 100
    - path: "packages/admin/src/__tests__/zero-coverage.test.tsx"
      provides: "Tests for 0% coverage files: client.ts, layout.tsx, toast.tsx, copy-button.tsx, walletconnect.tsx, display-currency.ts, and 0% policy forms"
      min_lines: 250
  key_links:
    - from: "packages/admin/src/__tests__/policies-coverage.test.tsx"
      to: "packages/admin/src/pages/policies.tsx"
      via: "import and render PoliciesPage with edit/delete interactions"
      pattern: "import.*PoliciesPage.*from.*policies"
    - from: "packages/admin/src/__tests__/zero-coverage.test.tsx"
      to: "packages/admin/src/api/client.ts"
      via: "import and test apiCall/apiGet/apiPost/apiPut/apiDelete"
      pattern: "import.*apiCall.*from.*client"
---

<objective>
Add function coverage tests for policies.tsx, notifications.tsx, and all 0% coverage files (client.ts, layout.tsx, toast.tsx, copy-button.tsx, walletconnect.tsx, display-currency.ts, and 0% policy form components).

Purpose: These files collectively contain ~40+ uncovered functions. Combined with Plan 01's coverage gains, this plan pushes admin function coverage past the 70% threshold required to restore the coverage gate.

Output: Three new test files covering the remaining uncovered functions.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/admin/src/pages/policies.tsx
@packages/admin/src/pages/notifications.tsx
@packages/admin/src/api/client.ts
@packages/admin/src/components/layout.tsx
@packages/admin/src/components/toast.tsx
@packages/admin/src/components/copy-button.tsx
@packages/admin/src/pages/walletconnect.tsx
@packages/admin/src/utils/display-currency.ts
@packages/admin/src/components/policy-forms/approve-amount-limit-form.tsx
@packages/admin/src/components/policy-forms/approved-spenders-form.tsx
@packages/admin/src/components/policy-forms/x402-allowed-domains-form.tsx
@packages/admin/src/components/policy-forms/contract-whitelist-form.tsx
@packages/admin/src/components/policy-forms/allowed-networks-form.tsx
@packages/admin/src/__tests__/policies.test.tsx
@packages/admin/src/__tests__/notifications.test.tsx
@packages/admin/src/__tests__/setup.ts
@packages/admin/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add policies.tsx + notifications.tsx function coverage tests</name>
  <files>packages/admin/src/__tests__/policies-coverage.test.tsx, packages/admin/src/__tests__/notifications-coverage.test.tsx</files>
  <action>
**policies-coverage.test.tsx**: Create a NEW test file (separate from existing `policies.test.tsx`).

Use the same mock pattern as existing tests. Mock apiGet, apiPost, apiPut, apiDelete, toast, auth store, error-messages. Mock ../components/policy-forms with `PolicyFormRouter: () => <div>PolicyFormRouter</div>`. Mock ../components/policy-rules-summary with `PolicyRulesSummary: () => <span>Rules</span>`. Mock ../components/empty-state.

Mock data:
- mockWallets: { items: [{ id: 'w1', name: 'bot', chain: 'solana', network: 'devnet', publicKey: 'pk1', status: 'ACTIVE', createdAt: 1 }] }
- mockPolicies: array of 2+ policies with different types, one with walletId=null (global), one with walletId='w1'

Write tests covering these specific uncovered functions:

1. **handleCreate (structured form)**: Click "Create Policy" to show form. Select type, set wallet, set priority/enabled. Click "Create". Assert apiPost(API.POLICIES, { type, rules, walletId, priority, enabled }). Verify form reset after success. Test with validation errors (formErrors populated, apiPost NOT called).

2. **handleCreate (JSON mode)**: Toggle to JSON mode, enter JSON, click Create. Assert apiPost with parsed JSON. Test invalid JSON error path.

3. **openEdit / handleEdit**: Render with policies. Click "Edit" button on a policy row. Assert edit modal opens with correct values. Change rules, click Save. Assert apiPut(API.POLICY(id), { rules, priority, enabled }).

4. **handleEditJsonToggle**: In edit modal, toggle between structured and JSON modes. Test JSON parse error preventing toggle.

5. **openDelete / handleDelete**: Click "Delete" on a policy row. Confirm in modal. Assert apiDelete(API.POLICY(id)). Assert success toast.

6. **handleTypeChange**: Change policy type in create form. Assert default rules update for new type.

7. **handleJsonToggle**: Toggle JSON mode in create form. Assert formRules synced from formRulesObj. Test invalid JSON preventing toggle back.

8. **getWalletName / getPolicyTypeLabel**: These are exercised implicitly when table renders — verify "Global" shows for walletId=null policies, wallet name for matched walletId, truncated ID for unmatched.

9. **validateRules**: Implicitly tested through create/edit with invalid rules. Test SPENDING_LIMIT validation (missing instant_max), WHITELIST (empty addresses), RATE_LIMIT (non-integer), ALLOWED_TOKENS (empty tokens), CONTRACT_WHITELIST (empty contracts), METHOD_WHITELIST (empty selectors), APPROVED_SPENDERS (empty), TIME_RESTRICTION (start >= end), ALLOWED_NETWORKS (empty), X402_ALLOWED_DOMAINS (empty), APPROVE_AMOUNT_LIMIT (non-integer maxAmount). Each should populate formErrors and NOT call apiPost.

10. **Filter by wallet**: Select a specific wallet from the filter dropdown. Assert fetchPolicies is called with walletId query param. Select "__global__" and assert client-side filtering.

**notifications-coverage.test.tsx**: Create NEW test file.

Use same mock pattern. Mock ../pages/telegram-users with `TelegramUsersContent: () => <div>TelegramUsers</div>`.

Test these uncovered functions:

1. **handleTestChannel**: Render page with enabled channels. Find a channel card, click "Test" button. Assert apiPost(API.ADMIN_NOTIFICATIONS_TEST, { channel: 'telegram' }). Test success and failure toast paths.

2. **handlePrevPage / handleNextPage**: Render with logs mock having total > PAGE_SIZE (20). Click "Next". Assert fetchLogs called with page 2. Click "Previous". Assert fetchLogs called with page 1. Test boundary conditions (disabled at page 1, disabled at last page).

3. **handleRowClick**: Click a log row. Assert expanded log detail appears with message. Click again to collapse. Click a different row to switch.

4. **Tab switching**: Click "Telegram Users" tab. Assert TelegramUsersContent renders. Click "Channels & Logs" tab. Assert channel cards visible.
  </action>
  <verify>
Run `pnpm --filter @waiaas/admin test -- --run src/__tests__/policies-coverage.test.tsx src/__tests__/notifications-coverage.test.tsx` and confirm all tests pass.
Run `pnpm --filter @waiaas/admin test -- --coverage` and verify policies.tsx function coverage increased from 64.86% toward 85%+ and notifications.tsx from 68.75% toward 90%+.
  </verify>
  <done>policies.tsx function coverage reaches 80%+ with edit/delete/create/validate/toggle/filter all tested. notifications.tsx function coverage reaches 85%+ with per-channel test, pagination, row expand all tested.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for 0% coverage files + uncovered policy forms</name>
  <files>packages/admin/src/__tests__/zero-coverage.test.tsx</files>
  <action>
Create a NEW test file `zero-coverage.test.tsx` covering all files currently at 0% function coverage plus low-coverage utility files.

**Section 1: client.ts tests** (NO vi.mock for client — test the REAL implementation)

Do NOT mock the client module itself. Instead, mock `fetch` globally (already done in setup.ts) and mock `../auth/store` for masterPassword/logout/resetInactivityTimer signals.

Tests:
1. **ApiError**: Construct with (404, 'NOT_FOUND', 'Resource not found'). Assert status, code, serverMessage properties, and message format.
2. **apiCall success**: Mock fetch to return ok JSON response. Call apiCall<{ok:true}>('/test'). Assert result. Assert resetInactivityTimer was called.
3. **apiCall with master password**: Set masterPassword.value='secret'. Call apiCall. Assert fetch was called with X-Master-Password header.
4. **apiCall timeout**: Mock fetch to throw with name='TimeoutError'. Assert ApiError(0, 'TIMEOUT') is thrown.
5. **apiCall network error**: Mock fetch to throw generic Error. Assert ApiError(0, 'NETWORK_ERROR') is thrown.
6. **apiCall 401**: Mock fetch returning 401 response. Assert logout() was called. Assert ApiError(401, 'INVALID_MASTER_PASSWORD') thrown.
7. **apiCall non-ok response with JSON body**: Mock fetch returning 500 with JSON { code: 'DB_ERROR', message: 'fail' }. Assert ApiError(500, 'DB_ERROR', 'fail').
8. **apiCall non-ok response without JSON body**: Mock 500 with non-JSON body. Assert ApiError(500, 'UNKNOWN', 'Unknown error').
9. **apiGet/apiPost/apiPut/apiDelete**: Call each, assert correct HTTP method passed to fetch.

**Section 2: toast.tsx tests**

Import showToast and ToastContainer directly (no mock). Use signals directly.

Tests:
1. **showToast creates toast**: Call showToast('success', 'Done'). Render <ToastContainer />. Assert toast message visible.
2. **dismissToast on click**: Render container with toast. Click it. Assert toast removed.
3. **auto-dismiss after 5s**: Use vi.useFakeTimers(). Call showToast. Advance 5000ms. Assert toast removed.
4. **empty container returns null**: Render ToastContainer with no toasts. Assert no DOM output.

**Section 3: copy-button.tsx tests**

Mock navigator.clipboard.writeText.

Tests:
1. **renders with default label**: Render <CopyButton value="test" />. Assert "Copy" text visible.
2. **renders with custom label**: Render <CopyButton value="test" label="Copy Address" />. Assert custom label.
3. **copies to clipboard on click**: Click button. Assert navigator.clipboard.writeText called with "test". Assert "Copied!" appears. After 2000ms timer, "Copy" reappears.
4. **fallback when clipboard fails**: Mock writeText to reject. Click. Assert document.execCommand('copy') was used (via textarea fallback).

**Section 4: layout.tsx tests**

Mock all page imports (import pages as stubs). Set window.location.hash.

Tests:
1. **Layout renders sidebar with nav links**: Render <Layout />. Assert all 7 nav items visible (Dashboard, Wallets, Sessions, Policies, Notifications, WalletConnect, Settings).
2. **PageRouter routes to correct page**: Set currentPath signal to each path. Assert correct page component renders.
3. **getPageTitle**: Set path to '/wallets/abc'. Assert title is 'Wallet Detail'. Set path to '/settings'. Assert 'Settings'.
4. **Active link highlighting**: Set currentPath to '/wallets/abc'. Assert wallets link has 'active' class.
5. **Logout button**: Click logout button. Assert logout() called.

**Section 5: walletconnect.tsx page tests**

Mock api client, toast, auth, error-messages, format utils.

Tests:
1. **fetchAll**: Render page. Assert apiGet(API.WALLETS) called. Assert WC session fetched for each wallet.
2. **handleConnect**: Click Connect button on a wallet row. Assert apiPost(API.WALLET_WC_PAIR) called. Assert QR modal opens.
3. **handleDisconnect**: Render with WC session present. Click Disconnect. Assert apiDelete called. Assert session cleared.
4. **closeQrModal**: Open QR modal. Close it. Assert polling stopped and modal hidden.

**Section 6: display-currency.ts tests**

Mock ../api/client for apiGet.

Tests:
1. **formatWithDisplay null amount**: Call formatWithDisplay(null, 'USD', 1). Assert returns ''.
2. **formatWithDisplay null rate**: Call formatWithDisplay(100, 'KRW', null). Assert returns '$100.00'.
3. **formatWithDisplay USD**: Call formatWithDisplay(100, 'USD', 1). Assert returns '$100.00'.
4. **formatWithDisplay non-USD**: Call formatWithDisplay(100, 'KRW', 1450). Assert returns approximation prefix + formatted KRW.
5. **fetchDisplayCurrency USD**: Mock apiGet to return display.currency='USD'. Assert returns { currency: 'USD', rate: 1 }.
6. **fetchDisplayCurrency non-USD**: Mock apiGet to return display.currency='KRW' + forex rates. Assert returns { currency: 'KRW', rate: 1450 }.
7. **fetchDisplayCurrency error fallback**: Mock apiGet to throw. Assert returns { currency: 'USD', rate: 1 }.
8. **fetchDisplayCurrency cache**: Call twice within 5 min. Assert apiGet called only once.

**Section 7: 0% policy form component tests**

Directly render each form component with mock props (rules, onChange, errors).

1. **ApproveAmountLimitForm**: Render with rules. Change maxAmount input. Assert onChange called with updated rules. Change blockUnlimited checkbox. Assert onChange. Test empty maxAmount deletion.
2. **ApprovedSpendersForm**: Render with spenders array. Click "Add Spender". Assert onChange called with appended entry. Click remove. Assert entry removed. Change fields.
3. **X402AllowedDomainsForm**: Render with domains. Add/remove/change domain entries.
4. **ContractWhitelistForm**: Render with contracts. Add/remove/change entries including chain select.
5. **AllowedNetworksForm**: Render with networks. Add/remove/change network entries via select.
  </action>
  <verify>
Run `pnpm --filter @waiaas/admin test -- --run src/__tests__/zero-coverage.test.tsx` and confirm all tests pass.
Run `pnpm --filter @waiaas/admin test -- --coverage` and verify:
- client.ts functions > 80%
- toast.tsx functions > 80%
- copy-button.tsx functions > 80%
- layout.tsx functions > 60%
- walletconnect.tsx functions > 50%
- display-currency.ts functions > 60%
- approve-amount-limit-form.tsx, approved-spenders-form.tsx, x402-allowed-domains-form.tsx functions > 0%
  </verify>
  <done>All previously 0% coverage files have functions tested. Policy form components at 0% (ApproveAmountLimitForm, ApprovedSpendersForm, X402AllowedDomainsForm, ContractWhitelistForm, AllowedNetworksForm) are covered. Overall admin function coverage exceeds 70%.</done>
</task>

</tasks>

<verification>
After both tasks in this plan complete:
1. `pnpm --filter @waiaas/admin test -- --coverage` should show overall function coverage >= 70%
2. All existing tests continue to pass (no regressions)
3. Combined with Plan 01 gains: settings.tsx >= 75%, wallets.tsx >= 70%, dashboard.tsx >= 80%, policies.tsx >= 80%, notifications.tsx >= 85%, client.ts >= 80%, toast.tsx >= 80%, copy-button.tsx >= 80%, walletconnect.tsx >= 50%
</verification>

<success_criteria>
- All new test files pass without errors
- No regressions in existing admin tests (98 tests still passing)
- Overall admin function coverage >= 70% (up from 57.95%)
- 0% coverage files all have at least partial function coverage
- Phase 179 goal met: admin function coverage high enough to restore 70% threshold in Phase 181
</success_criteria>

<output>
After completion, create `.planning/phases/179-admin-functions-coverage/179-02-SUMMARY.md`
</output>
