---
phase: 32-owner-생명주기-설계
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - .planning/deliverables/52-auth-model-redesign.md
  - .planning/deliverables/34-owner-wallet-connection.md
autonomous: true

must_haves:
  truths:
    - "ownerAuth 미들웨어 Step 8.5에 markOwnerVerified() 자동 호출이 명세되어 GRACE->LOCKED 전이가 자동 처리된다"
    - "OwnerSignaturePayload.action에 change_owner가 추가되어 LOCKED 상태 set-owner 서명 검증이 가능하다"
    - "52-auth-model-redesign.md의 31 엔드포인트 인증 맵에 PATCH /v1/agents/:id의 Owner 변경 인증 분기가 명세되어 있다"
    - "C-01(Grace-to-Locked 레이스) 방어가 ownerAuth 미들웨어와 setOwner BEGIN IMMEDIATE로 이중 보호된다"
    - "C-02(보안 다운그레이드 공격) 방어가 remove-owner 알림 + LOCKED 해제 금지 + killSwitchGuard로 삼중 보호된다"
  artifacts:
    - path: ".planning/deliverables/52-auth-model-redesign.md"
      provides: "ownerAuth Step 8.5, change_owner action, 인증 맵 갱신"
      contains: "Step 8.5"
    - path: ".planning/deliverables/34-owner-wallet-connection.md"
      provides: "보안 공격 방어 메커니즘 섹션"
      contains: "보안 다운그레이드 방지"
  key_links:
    - from: "52-auth-model-redesign.md의 ownerAuth Step 8.5"
      to: "34-owner-wallet-connection.md의 markOwnerVerified()"
      via: "OwnerLifecycleService.markOwnerVerified() 호출"
      pattern: "markOwnerVerified"
    - from: "52-auth-model-redesign.md의 change_owner action"
      to: "34-owner-wallet-connection.md의 OwnerSignaturePayload"
      via: "action enum 확장"
      pattern: "change_owner"
    - from: "34-owner-wallet-connection.md의 setOwner BEGIN IMMEDIATE"
      to: "33-time-lock-approval-mechanism.md의 BEGIN IMMEDIATE 일관성 테이블"
      via: "동일 직렬화 패턴 적용"
      pattern: "BEGIN IMMEDIATE"
---

<objective>
52-auth-model-redesign.md에 ownerAuth 미들웨어 v0.8 확장(Step 8.5 markOwnerVerified, change_owner action, 인증 맵 갱신)을 반영하고, 34-owner-wallet-connection.md에 보안 공격 방어 메커니즘(C-01 레이스 컨디션, C-02 다운그레이드 공격)과 setOwner BEGIN IMMEDIATE 직렬화 설계를 추가한다.

Purpose: ownerAuth 미들웨어가 자동으로 GRACE->LOCKED 전이를 처리하고, LOCKED 상태 Owner 변경 시 서명 검증이 가능하도록 하여, 보안 공격 경로가 차단된 설계를 확정한다.
Output: 52-auth-model-redesign.md + 34-owner-wallet-connection.md [v0.8] 섹션 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 31 outputs (markOwnerVerified, BEGIN IMMEDIATE 패턴)
@.planning/phases/31-데이터-모델-타입-기반-설계/31-02-SUMMARY.md

# Phase 32-01 output (OwnerLifecycleService, 상태 전이 조건표)
@.planning/phases/32-owner-생명주기-설계/32-01-SUMMARY.md

# Research (ownerAuth 미들웨어 통합, 보안 공격 방어)
@.planning/phases/32-owner-생명주기-설계/32-RESEARCH.md

# Target design documents
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/34-owner-wallet-connection.md

# Cross-references
@.planning/deliverables/33-time-lock-approval-mechanism.md (BEGIN IMMEDIATE 일관성 테이블)
@.planning/deliverables/36-killswitch-autostop-evm.md (killSwitchGuard 허용 경로)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 52-auth-model-redesign.md에 ownerAuth Step 8.5 + change_owner action + 인증 맵 갱신</name>
  <files>.planning/deliverables/52-auth-model-redesign.md</files>
  <action>
52-auth-model-redesign.md에 v0.8 변경 사항을 반영한다. 기존 문서 구조를 유지하면서 다음을 추가/수정한다:

**1. ownerAuth Step 8.5 추가 (섹션 3.2 또는 ownerAuth 정의 섹션)**

기존 ownerAuth 8단계 미들웨어에 [v0.8] Step 8.5를 추가한다:

```
Step 8.5 [v0.8]: markOwnerVerified() 자동 호출
  - 조건: agent.ownerVerified === false (GRACE 상태)
  - 동작: ownerLifecycleService.markOwnerVerified(agent.id) 호출
  - 타이밍: Step 8(next() 호출) 전에 실행 -- 핸들러 실행 전 LOCKED 상태 보장
  - 직렬화: BEGIN IMMEDIATE + WHERE owner_verified = 0 (Phase 31 설계)
  - Idempotency: changes === 0이면 이미 LOCKED (중복 호출 안전)
```

Step 순서를 명확히 한다: 1-7(검증) -> 8.5(자동 잠금 전이) -> 8(next() 호출)
보수적 접근 근거를 주석으로 명시: "핸들러 실행 전 LOCKED 전환이 일관성 보장"

코드 예시 (TypeScript 의사코드):
```typescript
async function ownerAuth(c: Context, next: Next): Promise<void> {
  // ... Step 1-7 기존 검증 ...

  // [v0.8] Step 8.5: ownerAuth 첫 사용 시 자동 잠금 전환
  const agent = c.get('agent')
  if (agent && !agent.ownerVerified) {
    ownerLifecycleService.markOwnerVerified(agent.id)
    // markOwnerVerified 내부에서 감사 로그 OWNER_VERIFIED 기록
  }

  await next()  // Step 8
}
```

**2. OwnerSignaturePayload.action 확장 (섹션 3.2 또는 ownerAuth 정의 섹션)**

기존 action enum (approve_tx, recover)에 change_owner를 추가한다:

```typescript
// OwnerSignaturePayload.action v0.8 확장
type OwnerAction = 'approve_tx' | 'recover' | 'change_owner'  // [v0.8] change_owner 추가
```

ROUTE_ACTION_MAP 갱신:
| 라우트 | 기대 action |
|--------|-----------|
| POST /v1/owner/agents/:id/approve | approve_tx |
| POST /v1/owner/agents/:id/recover | recover |
| PATCH /v1/agents/:id (owner 변경, LOCKED) | change_owner [v0.8] |

change_owner action 사용 시나리오:
- LOCKED 상태에서 set-owner 실행 시 CLI/API가 ownerAuth 헤더를 포함
- ownerAuth 미들웨어 Step 6에서 action === 'change_owner' 검증
- 이후 OwnerLifecycleService.setOwner() 내부에서 auth.ownerVerified 확인

**3. 31 엔드포인트 인증 맵 갱신 (섹션 4)**

기존 인증 맵에서 PATCH /v1/agents/:id 행에 [v0.8] 주석을 추가한다:

```
PATCH /v1/agents/:id  | masterAuth (implicit) | [v0.8] Owner 변경 시: NONE/GRACE -> masterAuth만, LOCKED -> ownerAuth 헤더 추가 필요. 인증 분기는 OwnerLifecycleService 내부에서 처리 (미들웨어 레벨 분기 금지)
```

인증 그룹 표에 주석 추가:
- MASTER_IMPLICIT 그룹에 PATCH /v1/agents/:id가 속하지만, LOCKED 상태 Owner 변경 시 ownerAuth가 추가 필요함을 명시

**4. 문서 헤더 갱신**

- v0.8 업데이트: 2026-02-09
- 상태: v0.8 보완
- 참조에 34-owner-wallet-connection.md의 Owner 생명주기 섹션 참조 추가

**주의사항:**
- 기존 v0.5/v0.7 내용을 삭제하지 않고 [v0.8] 태그로 확장만 수행
- LOCKED 상태 인증은 미들웨어가 아닌 비즈니스 로직에서 분기하므로, 인증 맵의 미들웨어 열은 변경하지 않음
  </action>
  <verify>
52-auth-model-redesign.md에서 다음을 확인:
1. ownerAuth 미들웨어에 Step 8.5가 [v0.8]로 추가되어 있다
2. markOwnerVerified() 호출이 next() 전에 실행됨이 명시되어 있다
3. OwnerSignaturePayload.action에 change_owner가 추가되어 있다
4. ROUTE_ACTION_MAP에 PATCH /v1/agents/:id -> change_owner 매핑이 있다
5. 인증 맵에서 PATCH /v1/agents/:id에 [v0.8] Owner 변경 분기 주석이 있다
6. 문서 헤더에 v0.8 업데이트가 반영되어 있다
  </verify>
  <done>
52-auth-model-redesign.md에 ownerAuth Step 8.5(자동 GRACE->LOCKED 전이), change_owner action, 인증 맵 갱신이 반영되어 ownerAuth 미들웨어가 v0.8 Owner 생명주기와 완전 통합된다
  </done>
</task>

<task type="auto">
  <name>Task 2: 34-owner-wallet-connection.md에 보안 공격 방어 + setOwner BEGIN IMMEDIATE 직렬화 설계 추가</name>
  <files>.planning/deliverables/34-owner-wallet-connection.md</files>
  <action>
Plan 32-01에서 추가한 섹션 뒤에, 보안 공격 방어 메커니즘 섹션을 추가한다:

**9.10 보안 공격 방어 메커니즘 [v0.8]**

**C-01: Grace-to-Locked 레이스 컨디션 (CRITICAL)**

위협 시나리오:
1. 공격자가 masterAuth를 탈취
2. set-owner로 자신의 주소를 등록 (GRACE 상태)
3. ownerAuth를 수행하여 LOCKED 전환
4. 원래 Owner가 변경 불가 상태에 빠짐

방어 3중 보호:
| 방어 계층 | 메커니즘 | 설계 문서 참조 |
|----------|---------|--------------|
| 1. markOwnerVerified 원자화 | BEGIN IMMEDIATE + WHERE owner_verified = 0 | 33-time-lock-approval-mechanism.md |
| 2. setOwner BEGIN IMMEDIATE | set-owner API에서도 BEGIN IMMEDIATE 내에서 ownerState 재확인 | 본 섹션 |
| 3. 감사 로그 즉시 기록 | GRACE->LOCKED 전이 시 OWNER_VERIFIED 이벤트 | 25-sqlite-schema.md |

setOwner BEGIN IMMEDIATE 설계:
```typescript
// OwnerLifecycleService.setOwner() 내부 - LOCKED 상태 변경 시
async setOwner(agentId: string, newAddress: string, auth: AuthContext): Promise<void> {
  // BEGIN IMMEDIATE 트랜잭션으로 ownerState 재확인 + 주소 변경 원자화
  this.sqlite.transaction(() => {
    const agent = this.sqlite.prepare(
      'SELECT owner_address, owner_verified FROM agents WHERE id = ?'
    ).get(agentId)

    const state = resolveOwnerState(agent)

    if (state === 'LOCKED' && !auth.ownerVerified) {
      throw new ForbiddenError('OWNER_AUTH_REQUIRED')
    }

    this.sqlite.prepare(
      'UPDATE agents SET owner_address = ?, updated_at = ? WHERE id = ?'
    ).run(newAddress, Math.floor(Date.now() / 1000), agentId)

    // 감사 로그도 트랜잭션 내에서 기록
    this.sqlite.prepare(
      `INSERT INTO audit_log (id, event_type, agent_id, details, created_at)
       VALUES (?, ?, ?, ?, ?)`
    ).run(
      generateUUIDv7(),
      state === 'NONE' ? 'OWNER_REGISTERED' : 'OWNER_ADDRESS_CHANGED',
      agentId,
      JSON.stringify({ newAddress, previousState: state }),
      Math.floor(Date.now() / 1000)
    )
  }).immediate()
}
```

BEGIN IMMEDIATE 일관성: 33-time-lock-approval-mechanism.md의 BEGIN IMMEDIATE 사용처 테이블에 setOwner를 추가해야 함 (Phase 35 통합 시 반영).

**C-02: 보안 다운그레이드 공격 (CRITICAL)**

위협 시나리오:
1. 공격자가 masterAuth를 탈취 (유예 구간)
2. remove-owner로 Owner를 제거
3. APPROVAL 티어가 DELAY로 다운그레이드됨
4. Kill Switch 복구 대기가 30분 -> 24시간으로 변경됨
5. 공격자가 보안 수준 저하를 이용해 자금 탈취

방어 3중 보호:
| 방어 계층 | 메커니즘 | 상세 |
|----------|---------|------|
| 1. LOCKED 해제 금지 | OwnerLifecycleService.removeOwner() -> ForbiddenError('OWNER_LOCKED') | 잠금 구간에서는 근본적으로 불가 |
| 2. 유예 구간 remove-owner 알림 | 전 채널 알림: "보안 수준이 Base로 전환됩니다. APPROVAL 거래가 DELAY로 다운그레이드됩니다." | 알림 템플릿은 Phase 33에서 설계 |
| 3. killSwitchGuard 연동 | Kill Switch ACTIVATED 상태에서 set-owner/remove-owner 자동 차단 (허용 경로 4개에 미포함) | 36-killswitch-autostop-evm.md 참조 |

추가 방어:
- remove-owner 실행 시 audit_log에 SECURITY_LEVEL_DOWNGRADE 이벤트 기록 고려 (v0.9+)
- CLI에서 remove-owner 실행 전 확인 프롬프트 표시 (Phase 35 DX에서 설계)

**H-02: 유예 구간 withdraw 공격**

위협 시나리오:
1. 공격자가 masterAuth를 탈취
2. set-owner로 자신의 주소를 등록 (GRACE)
3. withdraw로 자금을 자신의 주소로 회수

방어:
- withdraw는 owner_verified = 1 (LOCKED 상태)에서만 활성화 (WITHDRAW-08)
- GRACE 상태에서 withdraw 시도 시 403 응답
- 상세 API 설계는 Phase 34에서 진행

**H-03: Kill Switch ACTIVATED 상태 Owner 변경**

위협 시나리오:
1. Kill Switch가 발동된 상태
2. 공격자가 Owner를 변경/제거하여 복구 요건 변경

방어:
- killSwitchGuard가 4개 허용 경로만 통과: GET /v1/health, GET /v1/agents/:id/status, POST /v1/owner/agents/:id/recover, GET /v1/kill-switch/status
- set-owner/remove-owner는 허용 경로에 미포함 -> 자동 503 차단
- 이 동작을 본 섹션에서 명시적으로 문서화 (기존 36-killswitch-autostop-evm.md와 일관)

**9.11 ownerAuth 미들웨어 v0.8 변경 요약 [v0.8]**

52-auth-model-redesign.md에서 상세 설계된 변경의 요약을 교차 참조로 포함한다:

| 변경 항목 | 상세 | 참조 |
|----------|------|------|
| Step 8.5 추가 | markOwnerVerified() 자동 호출 (GRACE->LOCKED) | 52-auth-model-redesign.md 섹션 3.2 |
| action enum 확장 | approve_tx, recover + **change_owner** [v0.8] | 52-auth-model-redesign.md 섹션 3.2 |
| ROUTE_ACTION_MAP | PATCH /v1/agents/:id -> change_owner | 52-auth-model-redesign.md 섹션 4 |
| 인증 맵 갱신 | PATCH /v1/agents/:id의 LOCKED 분기 주석 | 52-auth-model-redesign.md 섹션 4 |

이 교차 참조로 34 문서와 52 문서 사이의 일관성을 보장한다.
  </action>
  <verify>
34-owner-wallet-connection.md에서 다음을 확인:
1. C-01(Grace-to-Locked 레이스) 방어 3중 보호가 테이블로 명세되어 있다
2. setOwner BEGIN IMMEDIATE 코드 예시가 있다
3. C-02(보안 다운그레이드) 방어 3중 보호가 테이블로 명세되어 있다
4. H-02(유예 구간 withdraw 공격) 방어가 owner_verified=1 조건으로 명세되어 있다
5. H-03(Kill Switch 상태 Owner 변경) 방어가 killSwitchGuard 참조로 명세되어 있다
6. ownerAuth v0.8 변경 요약이 52 문서와의 교차 참조로 명세되어 있다

52-auth-model-redesign.md에서 다음을 확인 (Task 1에서 이미 검증했지만 재확인):
7. Step 8.5가 존재하고 change_owner action이 추가되어 있다
  </verify>
  <done>
34-owner-wallet-connection.md에 보안 공격 방어(C-01/C-02/H-02/H-03) 4건과 setOwner BEGIN IMMEDIATE 직렬화가 명세되고, 52-auth-model-redesign.md와의 교차 참조가 확보되어 보안 다운그레이드 방지 메커니즘이 완성된다
  </done>
</task>

</tasks>

<verification>
Phase 32 Plan 02 검증 체크리스트:
1. [ ] 52-auth-model-redesign.md에 ownerAuth Step 8.5가 [v0.8]로 추가되어 있다
2. [ ] OwnerSignaturePayload.action에 change_owner가 추가되어 있다
3. [ ] ROUTE_ACTION_MAP에 PATCH /v1/agents/:id -> change_owner 매핑이 있다
4. [ ] 인증 맵에 PATCH /v1/agents/:id의 LOCKED 분기 주석이 있다
5. [ ] 34-owner-wallet-connection.md에 C-01 방어 3중 보호가 명세되어 있다
6. [ ] setOwner BEGIN IMMEDIATE 코드 예시가 있다
7. [ ] C-02 방어 3중 보호가 명세되어 있다
8. [ ] H-02 유예 구간 withdraw 방어가 명세되어 있다
9. [ ] H-03 Kill Switch 상태 Owner 변경 방어가 명세되어 있다
10. [ ] ownerAuth v0.8 변경 요약이 교차 참조로 명세되어 있다
</verification>

<success_criteria>
- 52-auth-model-redesign.md에 ownerAuth v0.8 확장이 완전히 반영됨
- 34-owner-wallet-connection.md에 보안 공격 방어 메커니즘이 4건 모두 명세됨
- 두 문서 간 교차 참조로 일관성이 보장됨
- Phase 34(자금 회수/보안 분기)에서 이 설계를 참조할 수 있음
</success_criteria>

<output>
After completion, create `.planning/phases/32-owner-생명주기-설계/32-02-SUMMARY.md`
</output>
