---
phase: 32-owner-생명주기-설계
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/34-owner-wallet-connection.md
autonomous: true

must_haves:
  truths:
    - "에이전트 생성 시 --owner 옵션으로 Owner 주소를 선택적으로 등록하는 API/CLI 스펙이 명세되어 있다"
    - "set-owner로 사후 등록 시 masterAuth만 요구하고, 서명은 불필요한 인증 요건이 명세되어 있다"
    - "유예 구간(owner_verified=0)에서 masterAuth만으로 변경/해제가 가능한 정책이 명세되어 있다"
    - "잠금 구간(owner_verified=1)에서 ownerAuth+masterAuth로만 변경이 가능하고, 해제가 불가능한 정책이 명세되어 있다"
    - "OwnerLifecycleService의 상태 전이 다이어그램과 6가지 전이 조건표가 명세되어 있다"
  artifacts:
    - path: ".planning/deliverables/34-owner-wallet-connection.md"
      provides: "Owner 생명주기 상태 머신 + OwnerLifecycleService + REST API/CLI 스펙"
      contains: "OwnerLifecycleService"
  key_links:
    - from: "34-owner-wallet-connection.md의 OwnerLifecycleService"
      to: "33-time-lock-approval-mechanism.md의 resolveOwnerState()"
      via: "OwnerState 타입 참조"
      pattern: "resolveOwnerState"
    - from: "34-owner-wallet-connection.md의 REST API 스펙"
      to: "37-rest-api-complete-spec.md의 POST /v1/agents"
      via: "body.owner optional 필드"
      pattern: "owner.*optional"
---

<objective>
34-owner-wallet-connection.md에 Owner 생명주기 전체를 설계한다: 3-State 상태 머신(NONE/GRACE/LOCKED), 6가지 상태 전이 조건표, OwnerLifecycleService 클래스(setOwner/removeOwner), REST API 스펙(POST /v1/agents body.owner, PATCH /v1/agents/:id owner 변경), CLI 명령어(agent create --owner, set-owner, remove-owner) 설계를 반영한다.

Purpose: Owner 등록/변경/해제의 인증 요건과 제약을 확정하여, Phase 32-02(ownerAuth 미들웨어 통합)와 Phase 34(자금 회수/보안 분기)가 이 설계를 참조할 수 있게 한다.
Output: 34-owner-wallet-connection.md에 [v0.8] Owner 생명주기 섹션 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 31 outputs (기반 타입/스키마 참조)
@.planning/phases/31-데이터-모델-타입-기반-설계/31-01-SUMMARY.md
@.planning/phases/31-데이터-모델-타입-기반-설계/31-02-SUMMARY.md

# Research (상태 머신, OwnerLifecycleService, API 설계 상세)
@.planning/phases/32-owner-생명주기-설계/32-RESEARCH.md

# Target design document
@.planning/deliverables/34-owner-wallet-connection.md

# Cross-references
@.planning/deliverables/33-time-lock-approval-mechanism.md (resolveOwnerState, markOwnerVerified)
@.planning/deliverables/37-rest-api-complete-spec.md (POST /v1/agents, PATCH /v1/agents/:id)
@.planning/deliverables/54-cli-flow-redesign.md (agent create CLI)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 34-owner-wallet-connection.md에 Owner 생명주기 상태 머신 + OwnerLifecycleService 설계 추가</name>
  <files>.planning/deliverables/34-owner-wallet-connection.md</files>
  <action>
34-owner-wallet-connection.md에 새로운 섹션 "9. Owner 생명주기 상태 머신 [v0.8]"을 추가한다. (기존 섹션 번호는 문서 구조를 확인하여 결정하되, 기존 내용 뒤에 추가한다.)

추가할 내용:

**9.1 3-State 상태 머신 (NONE / GRACE / LOCKED)**
- 상태 다이어그램 (ASCII art): NONE -> GRACE -> LOCKED 전이 흐름
  - NONE: owner_address = NULL, owner_verified = 0, 보안 = Base (DELAY까지)
  - GRACE (유예): owner_address = <addr>, owner_verified = 0, 보안 = Enhanced (APPROVAL 해금), 변경/해제 인증 = masterAuth만
  - LOCKED (잠금): owner_address = <addr>, owner_verified = 1, 보안 = Enhanced, 변경 = ownerAuth + masterAuth, 해제 = 불가
- 상태는 DB 컬럼이 아닌 resolveOwnerState() 런타임 산출 (Phase 31 결정 참조: 33-time-lock-approval-mechanism.md)

**9.2 상태 전이 조건표 (6가지)**

| # | 전이 | 트리거 | 인증 | DB 변경 | 부작용 |
|---|------|--------|------|---------|--------|
| 1 | NONE -> GRACE | set-owner 또는 agent create --owner | masterAuth | owner_address = <addr> | audit_log: OWNER_REGISTERED |
| 2 | GRACE -> NONE | remove-owner | masterAuth | owner_address = NULL, owner_verified = 0 | audit_log: OWNER_REMOVED |
| 3 | GRACE -> LOCKED | ownerAuth 첫 사용 (자동) | ownerAuth | owner_verified = 1 (BEGIN IMMEDIATE) | audit_log: OWNER_VERIFIED |
| 4 | GRACE -> GRACE (주소변경) | set-owner <new-addr> | masterAuth | owner_address = <new-addr> | audit_log: OWNER_ADDRESS_CHANGED |
| 5 | LOCKED -> LOCKED (주소변경) | set-owner <new-addr> | ownerAuth(기존) + masterAuth | owner_address = <new-addr> | audit_log: OWNER_ADDRESS_CHANGED |
| 6 | LOCKED -> NONE | **불가** | - | - | 보안 다운그레이드 방지 |

- 중요: LOCKED 상태에서 주소 변경 시 owner_verified를 리셋하지 않음 (기존 Owner 서명 승인 = 새 주소 신뢰)

**9.3 OwnerLifecycleService 클래스 설계**

32-RESEARCH.md의 "Pattern 2: OwnerLifecycleService 클래스 설계"를 공식 반영한다:
- 위치: packages/daemon/src/domain/owner-lifecycle.ts
- 생성자: DrizzleInstance, Database(better-sqlite3), AuditLogService
- setOwner(agentId, newAddress, auth): NONE/GRACE -> masterAuth만, LOCKED -> ownerAuth 필수 (auth.ownerVerified 확인)
  - NONE -> GRACE: 이벤트 OWNER_REGISTERED
  - GRACE/LOCKED 주소 변경: 이벤트 OWNER_ADDRESS_CHANGED
  - LOCKED 주소 변경 시 owner_verified = 1 유지
- removeOwner(agentId): GRACE -> NONE만 허용, LOCKED시 ForbiddenError('OWNER_LOCKED'), NONE시 NotFoundError('NO_OWNER')
  - 이벤트 OWNER_REMOVED
- markOwnerVerified(agentId): Phase 31에서 설계 완료 (33-time-lock-approval-mechanism.md 참조). BEGIN IMMEDIATE + WHERE owner_verified = 0 원자화.
- 코드 예시를 Research 문서 수준으로 포함 (TypeScript 의사코드)

**9.4 감사 로그 이벤트 (v0.8 추가 4개)**
- OWNER_REGISTERED: set-owner/agent create --owner 실행 (NONE -> GRACE)
- OWNER_ADDRESS_CHANGED: Owner 주소 변경 (GRACE/LOCKED 내)
- OWNER_REMOVED: remove-owner 실행 (GRACE -> NONE)
- OWNER_VERIFIED: ownerAuth 첫 사용 (GRACE -> LOCKED)
- 기존 13개 이벤트 + 4개 = 17개 (25-sqlite-schema.md audit_log_event_type과 일관)

**9.5 에러 코드 (v0.8 추가 3개)**
- OWNER_AUTH_REQUIRED (403): 잠금 구간에서 ownerAuth 없이 변경 시도
- OWNER_LOCKED (403): 잠금 구간에서 Owner 해제 시도
- NO_OWNER (404): Owner 미등록 에이전트에서 Owner 관련 작업 시도

**9.6 REST API 스펙 변경 [v0.8]**

| 동작 | HTTP | 경로 | 인증 | 요청 바디 | 응답 | 비고 |
|------|------|------|------|----------|------|------|
| 에이전트 생성 (Owner 선택적) | POST | /v1/agents | masterAuth (implicit) | { name, chain, ..., owner?: string } | 201 Created | body.owner = optional, 제공 시 NONE->GRACE |
| Owner 등록/변경 | PATCH | /v1/agents/:id | masterAuth (implicit) | { owner: string } | 200 OK | LOCKED 시 ownerAuth 헤더 추가 필요. 비즈니스 로직에서 상태 기반 인증 검증 |
| Owner 해제 | PATCH | /v1/agents/:id | masterAuth (implicit) | { owner: null } | 200 OK | GRACE에서만 가능, LOCKED시 403 OWNER_LOCKED |

- 미들웨어 인증 레벨: PATCH /v1/agents/:id는 masterAuth(implicit)로 고정. LOCKED 상태에서 Owner 변경 시 OwnerLifecycleService 내부에서 auth.ownerVerified를 검증한다 (미들웨어에서 정적 결정 불가). 이 접근은 "인증 분기를 비즈니스 로직에서 처리" 원칙에 따른다.

**9.7 CLI 명령어 스펙 변경 [v0.8]**

| 명령어 | 동작 | 인증 | OwnerState 전제 |
|--------|------|------|----------------|
| agent create --owner <addr> | 에이전트 생성 + Owner 등록 (NONE -> GRACE) | masterAuth | - |
| agent create (--owner 없이) | Owner 없이 에이전트 생성 (NONE) | masterAuth | - |
| agent set-owner <agent> <addr> | Owner 등록/변경 | masterAuth (NONE/GRACE), ownerAuth+masterAuth (LOCKED) | 상태에 따라 분기 |
| agent remove-owner <agent> | Owner 해제 (GRACE -> NONE) | masterAuth | GRACE만 |

- CLI에서 LOCKED 상태 set-owner: 먼저 GET /v1/agents/:id로 상태 확인 -> LOCKED이면 서명 플로우 안내 (상세는 Phase 35 DX에서 설계)

요구사항 매핑 섹션(1.2)에 v0.8 요구사항을 추가:

| OWNER-02 | 에이전트 생성 시 --owner 선택적 등록 | 섹션 9.6, 9.7 |
| OWNER-03 | set-owner 사후 등록 (masterAuth) | 섹션 9.2(전이 #1), 9.3, 9.6 |
| OWNER-04 | 유예 구간 masterAuth만으로 변경/해제 | 섹션 9.2(전이 #2, #4), 9.3 |
| OWNER-05 | 잠금 구간 ownerAuth+masterAuth 변경 | 섹션 9.2(전이 #5), 9.3 |
| OWNER-06 | 잠금 구간 해제 불가 | 섹션 9.2(전이 #6), 9.3 |

문서 헤더에 v0.8 변경 이력을 추가한다 (기존 v0.7 이후):
- v0.8 업데이트: 2026-02-09
- 상태: v0.8 보완

Anti-patterns 주의:
- owner_verified 리셋 금지 (LOCKED 주소 변경 시)
- OwnerState DB 컬럼 저장 금지
- 인증 분기를 미들웨어에서 처리 금지
- Kill Switch ACTIVATED 상태에서 Owner 변경 금지
  </action>
  <verify>
34-owner-wallet-connection.md에서 다음을 확인:
1. "Owner 생명주기 상태 머신" 섹션이 존재하고, NONE/GRACE/LOCKED 상태 다이어그램이 있다
2. 6가지 상태 전이 조건표가 인증/DB변경/부작용 컬럼을 포함한다
3. OwnerLifecycleService 클래스가 setOwner/removeOwner/markOwnerVerified 메서드를 포함한다
4. REST API 스펙에 POST /v1/agents body.owner optional이 명세되어 있다
5. CLI 스펙에 agent create --owner, set-owner, remove-owner가 명세되어 있다
6. v0.8 요구사항 매핑(OWNER-02~06)이 추가되어 있다
7. 감사 이벤트 4개, 에러 코드 3개가 명세되어 있다
  </verify>
  <done>
34-owner-wallet-connection.md에 Owner 생명주기 상태 머신(3-State, 6전이), OwnerLifecycleService(setOwner/removeOwner 정책), REST API/CLI 스펙, 감사 이벤트/에러 코드가 모두 명세되어 OWNER-02~06 요구사항이 충족된다
  </done>
</task>

<task type="auto">
  <name>Task 2: 주소 형식 검증 Zod 스키마 + Anti-Pattern 정리를 34-owner-wallet-connection.md에 추가</name>
  <files>.planning/deliverables/34-owner-wallet-connection.md</files>
  <action>
Task 1에서 추가한 섹션에 이어서, 다음 2개 하위 섹션을 추가한다:

**9.8 Owner 주소 형식 검증 [v0.8]**

Owner 주소 등록/변경 시 체인별 주소 형식 검증을 수행한다. 에이전트의 chain 필드에 따라 분기:

```typescript
// packages/core/src/schemas/owner.schema.ts (설계 스펙)
import { z } from 'zod'

const solanaAddressSchema = z.string()
  .min(32).max(44)
  .regex(/^[1-9A-HJ-NP-Za-km-z]+$/, 'Invalid Solana address (Base58)')

const evmAddressSchema = z.string()
  .regex(/^0x[0-9a-fA-F]{40}$/, 'Invalid EVM address')

// OwnerLifecycleService.setOwner() 내부에서 호출
function validateOwnerAddress(chain: 'solana' | 'ethereum', address: string): void {
  if (chain === 'solana') solanaAddressSchema.parse(address)
  else evmAddressSchema.parse(address)
}
```

- Solana: Base58 인코딩 32바이트 (보통 32-44자), 0/O/I/l 제외
- EVM: 0x + 40 hex 문자 (EIP-55 체크섬은 viem의 getAddress()로 별도 검증)
- Zod SSoT 원칙에 따라 런타임 검증과 타입 추론을 동시에 제공

**9.9 Anti-Patterns 및 설계 결정 근거 [v0.8]**

| Anti-Pattern | 위험 | 올바른 접근 |
|-------------|------|-----------|
| LOCKED 주소 변경 시 owner_verified 리셋 | 새 Owner가 GRACE 상태 -> masterAuth만으로 재변경 가능 | owner_verified = 1 유지 (기존 Owner 서명 승인 = 새 주소 신뢰) |
| OwnerState DB 컬럼 저장 | owner_address/owner_verified와 동기화 오류 | resolveOwnerState() 런타임 산출 (Phase 31 결정) |
| 미들웨어에서 인증 분기 | PATCH 요청 바디를 미들웨어에서 파싱해야 함 | OwnerLifecycleService 비즈니스 로직에서 상태 기반 검증 |
| Kill Switch ACTIVATED에서 Owner 변경 | 복구 요건이 동적 변경 | killSwitchGuard가 허용 경로 4개만 통과 -> set-owner/remove-owner 자동 차단 |
| ownerAuth 검증 후 비동기 markOwnerVerified | 검증과 전이 사이 레이스 윈도우 | 동일 요청 처리 내 동기적 전이 (Step 8.5) |

각 Anti-Pattern에 대해 "왜 위험한지"와 "올바른 접근"을 명시한다.
  </action>
  <verify>
34-owner-wallet-connection.md에서 다음을 확인:
1. Owner 주소 형식 검증 섹션에 Solana/EVM 각각의 Zod 스키마가 있다
2. Anti-Pattern 표에 5개 이상의 금지 패턴이 위험/올바른 접근과 함께 나열되어 있다
3. killSwitchGuard와의 연동이 명시되어 있다
  </verify>
  <done>
34-owner-wallet-connection.md에 Owner 주소 형식 검증 Zod 스키마와 5개 Anti-Pattern이 명세되어, 구현 시 잘못된 패턴을 사전에 방지할 수 있다
  </done>
</task>

</tasks>

<verification>
Phase 32 Plan 01 검증 체크리스트:
1. [ ] 34-owner-wallet-connection.md에 "Owner 생명주기 상태 머신" 섹션이 존재한다
2. [ ] 3-State 상태 다이어그램(NONE/GRACE/LOCKED)이 ASCII art로 그려져 있다
3. [ ] 6가지 상태 전이 조건표에 트리거/인증/DB변경/부작용이 명세되어 있다
4. [ ] OwnerLifecycleService.setOwner()가 NONE/GRACE -> masterAuth, LOCKED -> ownerAuth+masterAuth 분기를 포함한다
5. [ ] OwnerLifecycleService.removeOwner()가 LOCKED시 거부, GRACE시 허용을 포함한다
6. [ ] POST /v1/agents에 body.owner optional이 명세되어 있다
7. [ ] PATCH /v1/agents/:id에 owner 변경이 명세되어 있다
8. [ ] agent create --owner, set-owner, remove-owner CLI가 명세되어 있다
9. [ ] 감사 이벤트 4개(OWNER_REGISTERED, OWNER_ADDRESS_CHANGED, OWNER_REMOVED, OWNER_VERIFIED)가 명세되어 있다
10. [ ] 에러 코드 3개(OWNER_AUTH_REQUIRED, OWNER_LOCKED, NO_OWNER)가 명세되어 있다
11. [ ] OWNER-02~06 요구사항 매핑이 추가되어 있다
12. [ ] Zod 주소 검증 스키마(Solana/EVM)가 명세되어 있다
13. [ ] Anti-Pattern 5개가 위험/올바른 접근과 함께 명세되어 있다
</verification>

<success_criteria>
- 34-owner-wallet-connection.md에 v0.8 Owner 생명주기 설계가 완전히 반영됨
- OWNER-02(--owner 선택적 등록), OWNER-03(set-owner 사후 등록), OWNER-04(유예 구간 masterAuth), OWNER-05(잠금 구간 ownerAuth+masterAuth), OWNER-06(잠금 해제 불가) 모두 충족
- Phase 32-02에서 ownerAuth 미들웨어 통합 설계에 참조할 기반 확보
</success_criteria>

<output>
After completion, create `.planning/phases/32-owner-생명주기-설계/32-01-SUMMARY.md`
</output>
