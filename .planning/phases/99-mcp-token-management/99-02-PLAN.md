---
phase: 99-mcp-token-management
plan: 02
type: execute
wave: 2
depends_on: ["99-01"]
files_modified:
  - packages/admin/src/pages/wallets.tsx
  - packages/admin/src/api/endpoints.ts
autonomous: true

must_haves:
  truths:
    - "Admin UI wallet detail page shows an MCP Setup section with a Setup MCP button"
    - "Clicking the button calls POST /v1/mcp/tokens and displays the Claude Desktop config JSON"
    - "Claude Desktop config JSON is displayed in a code block with a Copy button"
    - "Expiry time is shown after successful provisioning"
    - "Error states (network, auth) show meaningful toast messages"
  artifacts:
    - path: "packages/admin/src/pages/wallets.tsx"
      provides: "MCP Setup section in WalletDetailView"
      contains: "McpSetupSection"
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "MCP_TOKENS API endpoint constant"
      contains: "MCP_TOKENS"
  key_links:
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "packages/daemon/src/api/routes/mcp.ts"
      via: "POST /v1/mcp/tokens API call"
      pattern: "apiPost.*MCP_TOKENS"
---

<objective>
Add MCP token provisioning UI to the Admin wallet detail page so administrators can issue MCP tokens and copy Claude Desktop config without using the CLI.

Purpose: Complete BUG-013 fix -- full Admin UI integration for MCP setup workflow.
Output: MCP Setup section in wallet detail with one-click provisioning and config copy.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/99-mcp-token-management/99-01-SUMMARY.md

@packages/admin/src/pages/wallets.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/components/copy-button.tsx
@packages/admin/src/components/form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP_TOKENS endpoint + MCP Setup section to wallet detail</name>
  <files>
    packages/admin/src/api/endpoints.ts
    packages/admin/src/pages/wallets.tsx
  </files>
  <action>
1. **Add API endpoint** to `packages/admin/src/api/endpoints.ts`:
   - Add `MCP_TOKENS: '/v1/mcp/tokens'` to the API object.

2. **Add MCP Setup section** to `WalletDetailView` in `packages/admin/src/pages/wallets.tsx`:

   a. Add new signals at the top of `WalletDetailView`:
      - `mcpLoading = useSignal(false)`
      - `mcpResult = useSignal<McpTokenResult | null>(null)` where `McpTokenResult = { walletId: string; walletName: string | null; tokenPath: string; expiresAt: number; claudeDesktopConfig: Record<string, unknown> }`

   b. Add `handleMcpSetup` async function:
      - Set `mcpLoading.value = true`
      - Call `apiPost<McpTokenResult>(API.MCP_TOKENS, { walletId: id })`
      - On success: set `mcpResult.value = result`, show success toast
      - On error: show error toast via `getErrorMessage(e.code)`
      - Finally: set `mcpLoading.value = false`

   c. Create an `McpSetupSection` component (inline in the same file, below `WalletDetailView` or as a nested function):
      - **Before provisioning** (mcpResult is null):
        - Section header: "MCP Setup"
        - Brief description: "Provision an MCP token for Claude Desktop integration."
        - "Setup MCP" Button (primary variant) that calls `handleMcpSetup`
        - Show loading state on button when `mcpLoading` is true
      - **After provisioning** (mcpResult is set):
        - Section header: "MCP Setup"
        - "Token Path" row showing `mcpResult.tokenPath`
        - "Expires At" row showing formatted date from `mcpResult.expiresAt`
        - "Claude Desktop Config" label
        - `<pre>` code block containing `JSON.stringify({ mcpServers: mcpResult.claudeDesktopConfig }, null, 2)`
        - `CopyButton` next to the code block with `value={JSON.stringify({ mcpServers: mcpResult.claudeDesktopConfig }, null, 2)}` and `label="Copy Config"`
        - "Re-provision" Button (secondary variant) to call `handleMcpSetup` again (overwrites previous)

   d. Place the McpSetupSection inside `WalletDetailView`, after the `detail-grid` div and before the `Modal` component. Use a `<div class="mcp-setup-section">` wrapper with appropriate styling via existing CSS classes (use `detail-grid` pattern or a simple card-style section).

   e. Styling: Use existing CSS classes from the admin theme. The code block should use `<pre><code>` with `style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-all', background: 'var(--color-bg-secondary)', padding: 'var(--space-3)', borderRadius: 'var(--radius-md)', fontSize: '0.85rem', maxHeight: '300px', overflow: 'auto' }}`. Keep it simple -- no new CSS file needed.
  </action>
  <verify>
    - `npx tsc --noEmit -p packages/admin/tsconfig.json` passes
    - Grep for `MCP_TOKENS` in endpoints.ts confirms endpoint constant
    - Grep for `McpSetupSection` or `handleMcpSetup` in wallets.tsx confirms UI is wired
    - `npx vitest run --reporter=verbose packages/daemon/src/__tests__/mcp-tokens.test.ts` still passes (no regression from plan 01)
  </verify>
  <done>
    Admin UI wallet detail page shows MCP Setup section. Clicking "Setup MCP" calls POST /v1/mcp/tokens and displays the Claude Desktop config JSON in a copyable code block with expiry time. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/admin/tsconfig.json` passes
2. `npx tsc --noEmit -p packages/daemon/tsconfig.json` passes (no regression)
3. Admin wallets.tsx contains McpSetupSection or equivalent MCP setup UI
4. API.MCP_TOKENS endpoint is defined in endpoints.ts
5. CopyButton is wired to copy the full Claude Desktop config JSON
6. Existing test suites pass without regression
</verification>

<success_criteria>
- Admin UI wallet detail page has a visible MCP Setup section
- "Setup MCP" button triggers POST /v1/mcp/tokens API call
- Claude Desktop config JSON is displayed in a code block with Copy button
- Expiry time is shown
- Error handling shows toast messages
- No TypeScript compilation errors
- No regression in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/99-mcp-token-management/99-02-SUMMARY.md`
</output>
