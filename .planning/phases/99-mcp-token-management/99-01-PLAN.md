---
phase: 99-mcp-token-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/mcp.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/api/index.ts
  - packages/daemon/src/lifecycle/daemon.ts
autonomous: true

must_haves:
  truths:
    - "POST /v1/mcp/tokens creates a session, writes mcp-tokens/<walletId> file, and returns Claude Desktop config snippet"
    - "API requires masterAuth and returns 401 without valid master password"
    - "Response includes walletId, walletName, tokenPath, expiresAt, and claudeDesktopConfig"
    - "Token file is written atomically (tmp + rename) at DATA_DIR/mcp-tokens/<walletId>"
  artifacts:
    - path: "packages/daemon/src/api/routes/mcp.ts"
      provides: "POST /v1/mcp/tokens route handler"
      exports: ["mcpTokenRoutes"]
    - path: "packages/daemon/src/api/server.ts"
      provides: "Route registration with dataDir dependency"
      contains: "mcpTokenRoutes"
  key_links:
    - from: "packages/daemon/src/api/routes/mcp.ts"
      to: "packages/daemon/src/api/routes/sessions.ts"
      via: "Reuses session creation logic (DB insert, JWT signing)"
      pattern: "jwtSecretManager\\.signToken"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/api/server.ts"
      via: "Passes dataDir to createApp deps"
      pattern: "dataDir"
---

<objective>
Create the POST /v1/mcp/tokens API endpoint that combines session creation + token file writing + Claude Desktop config snippet generation into a single request.

Purpose: BUG-013 fix -- Admin UI (and any HTTP client) can provision MCP tokens without the CLI.
Output: Working REST endpoint at POST /v1/mcp/tokens behind masterAuth.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/routes/sessions.ts
@packages/daemon/src/api/routes/tokens.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/cli/src/commands/mcp-setup.ts
@packages/cli/src/utils/slug.ts
@objectives/bug-reports/v1.4.1-BUG-013-admin-mcp-token-provisioning.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POST /v1/mcp/tokens route + wire into server</name>
  <files>
    packages/daemon/src/api/routes/mcp.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/api/index.ts
    packages/daemon/src/lifecycle/daemon.ts
  </files>
  <action>
1. **Add `dataDir` to CreateAppDeps** in `packages/daemon/src/api/server.ts`:
   - Add `dataDir?: string;` to the `CreateAppDeps` interface.

2. **Pass `dataDir` from daemon lifecycle** in `packages/daemon/src/lifecycle/daemon.ts`:
   - In `_startInternal()`, where `createApp({...})` is called (~line 336), add `dataDir` to the deps object.

3. **Add OpenAPI schemas** to `packages/daemon/src/api/routes/openapi-schemas.ts`:
   - `McpTokenCreateRequestSchema`: `z.object({ walletId: z.string().uuid(), expiresIn: z.number().int().min(300).max(604800).optional() })`
   - `McpTokenCreateResponseSchema`: `z.object({ walletId: z.string(), walletName: z.string().nullable(), tokenPath: z.string(), expiresAt: z.number(), claudeDesktopConfig: z.record(z.unknown()) })`

4. **Create `packages/daemon/src/api/routes/mcp.ts`** with:
   - Deps interface: `{ db, jwtSecretManager, config, dataDir, notificationService? }`
   - `POST /mcp/tokens` route using OpenAPIHono `createRoute` pattern (follow tokens.ts pattern)
   - Handler logic:
     a. Validate walletId exists in DB (query wallets table)
     b. Check active session count (same logic as sessions.ts POST /sessions)
     c. Generate session ID, compute TTL (use `expiresIn` from body, default to `config.security.session_ttl`), absoluteExpiresAt = now + 30 days
     d. Sign JWT with jwtSecretManager (payload: sub=sessionId, wlt=walletId, iat=now, exp=expiresAt)
     e. Compute tokenHash (sha256), insert session into DB
     f. Write JWT to `dataDir/mcp-tokens/<walletId>` atomically (mkdir, writeFile tmp, rename)
     g. Look up wallet name from DB
     h. Build Claude Desktop config snippet: `toSlug()` for key name, `{ command: 'npx', args: ['@waiaas/mcp'], env: { WAIAAS_DATA_DIR, WAIAAS_BASE_URL, WAIAAS_WALLET_ID, WAIAAS_WALLET_NAME? } }`
     i. `WAIAAS_BASE_URL` = construct from `config.daemon.hostname:config.daemon.port` (use `http://127.0.0.1:PORT` pattern since hostname is always loopback)
     j. Return 201 with response body
   - Include a local `toSlug()` function (copy from CLI slug.ts -- it's 5 lines, not worth creating a shared package dependency)
   - Fire-and-forget notification: `SESSION_CREATED`

5. **Register route in server.ts**:
   - Import `mcpTokenRoutes` from `./routes/mcp.js`
   - Add masterAuth for `/v1/mcp/tokens` path (in the masterAuth section ~line 166-181)
   - Register route: `app.route('/v1', mcpTokenRoutes({...}))` when db, jwtSecretManager, config, and dataDir are available

6. **Export from index.ts**: Add `export { mcpTokenRoutes } from './routes/mcp.js'` to `packages/daemon/src/api/index.ts`.
  </action>
  <verify>
    - `npx vitest run --reporter=verbose packages/daemon/src/__tests__/token-registry.test.ts` passes (no regression)
    - `npx tsc --noEmit -p packages/daemon/tsconfig.json` succeeds (type-checks)
    - Grep for `mcpTokenRoutes` in server.ts confirms route registration
  </verify>
  <done>
    POST /v1/mcp/tokens route exists, is registered with masterAuth, creates sessions, writes token files atomically, and returns Claude Desktop config snippets. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for POST /v1/mcp/tokens</name>
  <files>
    packages/daemon/src/__tests__/mcp-tokens.test.ts
  </files>
  <action>
Create `packages/daemon/src/__tests__/mcp-tokens.test.ts` following the pattern in `token-registry.test.ts`:

1. **Setup**: In-memory SQLite DB with pushSchema, mockConfig, argon2 hash, JwtSecretManager, createApp with `dataDir` pointing to a temp directory (use `node:os` tmpdir + random subfolder). Clean up temp dir in afterEach.

2. **Test cases** (at least 5):
   - `POST /v1/mcp/tokens with valid walletId returns 201 with all expected fields`: Create a wallet first (POST /v1/wallets), then call POST /v1/mcp/tokens. Verify response has walletId, walletName, tokenPath, expiresAt, claudeDesktopConfig. Verify claudeDesktopConfig has the correct structure (command, args, env with WAIAAS_DATA_DIR, WAIAAS_BASE_URL, WAIAAS_WALLET_ID).
   - `POST /v1/mcp/tokens writes token file at expected path`: After successful call, verify the token file exists at `dataDir/mcp-tokens/<walletId>` using `readFileSync`. Verify file content is a valid JWT (has 3 dot-separated parts).
   - `POST /v1/mcp/tokens without masterAuth returns 401`: Call without X-Master-Password header, expect 401.
   - `POST /v1/mcp/tokens with invalid walletId returns 404`: Call with non-existent wallet UUID, expect 404 WALLET_NOT_FOUND.
   - `POST /v1/mcp/tokens creates a session in DB`: After successful call, query sessions table to verify a session was created for the wallet.

3. **Cleanup**: Remove temp directory in afterEach using `rmSync(tmpDir, { recursive: true, force: true })`.
  </action>
  <verify>
    `npx vitest run --reporter=verbose packages/daemon/src/__tests__/mcp-tokens.test.ts` -- all 5+ tests pass
  </verify>
  <done>
    All integration tests for POST /v1/mcp/tokens pass, covering happy path, auth, error cases, file writing, and DB session creation.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/daemon/tsconfig.json` passes
2. `npx vitest run --reporter=verbose packages/daemon/src/__tests__/mcp-tokens.test.ts` -- all tests pass
3. `npx vitest run --reporter=verbose packages/daemon/src/__tests__/token-registry.test.ts` -- no regression
4. POST /v1/mcp/tokens route is registered in server.ts with masterAuth
5. Token file is written atomically (tmp + rename pattern) at DATA_DIR/mcp-tokens/<walletId>
</verification>

<success_criteria>
- POST /v1/mcp/tokens endpoint is functional behind masterAuth
- Response includes claudeDesktopConfig with correct mcpServers structure
- Token file is persisted atomically to filesystem
- 5+ integration tests pass
- No TypeScript compilation errors
- No regression in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/099-mcp-token-management/99-01-SUMMARY.md`
</output>
