---
phase: 162-compatibility-docker
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/compatibility.ts
  - packages/daemon/src/infrastructure/database/index.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/schema-compatibility.test.ts
autonomous: true
requirements: [CMPT-01, CMPT-02, CMPT-03]

must_haves:
  truths:
    - "코드 버전 > DB 스키마 버전이면 자동 마이그레이션 후 정상 시작된다"
    - "코드 버전 < DB 스키마 버전이면 시작을 거부하고 waiaas upgrade 안내 메시지를 출력한다"
    - "DB 스키마 버전이 MIN_COMPATIBLE_SCHEMA_VERSION 미만이면 시작을 거부하고 단계별 업그레이드를 안내한다"
    - "DB가 새로 생성된(빈) 경우에는 호환성 검사를 건너뛰고 정상 진행한다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/compatibility.ts"
      provides: "SchemaCompatibility 3-시나리오 판별 함수"
      exports: ["checkSchemaCompatibility", "MIN_COMPATIBLE_SCHEMA_VERSION"]
    - path: "packages/daemon/src/__tests__/schema-compatibility.test.ts"
      provides: "호환성 매트릭스 단위 테스트"
      contains: "checkSchemaCompatibility"
  key_links:
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/infrastructure/database/compatibility.ts"
      via: "checkSchemaCompatibility call in Step 2 before pushSchema"
      pattern: "checkSchemaCompatibility"
    - from: "packages/daemon/src/infrastructure/database/compatibility.ts"
      to: "packages/daemon/src/infrastructure/database/migrate.ts"
      via: "imports LATEST_SCHEMA_VERSION + MIGRATIONS"
      pattern: "LATEST_SCHEMA_VERSION"
---

<objective>
코드-DB 스키마 버전 불일치를 3-시나리오로 판별하는 호환성 매트릭스를 구현한다.

Purpose: 데몬 시작 시 코드 버전과 DB 스키마 버전의 불일치를 자동 감지하여, 안전한 자동 마이그레이션 또는 명확한 에러 메시지로 사용자를 안내한다. 이를 통해 업그레이드 후 DB 불일치로 인한 런타임 에러를 원천 차단한다.

Output: checkSchemaCompatibility 함수 + daemon Step 2 통합 + 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/index.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/__tests__/migration-runner.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: checkSchemaCompatibility 함수 + MIN_COMPATIBLE_SCHEMA_VERSION 상수 + 테스트 (RED-GREEN)</name>
  <files>
    packages/daemon/src/infrastructure/database/compatibility.ts
    packages/daemon/src/infrastructure/database/index.ts
    packages/daemon/src/__tests__/schema-compatibility.test.ts
  </files>
  <action>
**RED Phase (테스트 먼저 작성):**

`packages/daemon/src/__tests__/schema-compatibility.test.ts` 생성:
- in-memory SQLite + pushSchema로 DB 초기화하는 beforeEach/afterEach 패턴 (migration-runner.test.ts 패턴 참고)
- 아래 시나리오별 테스트 작성:

1. **Scenario A: code > db (자동 마이그레이션)** — schema_version MAX를 LATEST_SCHEMA_VERSION - 2로 세팅 후 checkSchemaCompatibility 호출 -> `{ action: 'migrate' }` 반환 확인
2. **Scenario B: code == db (정상)** — 기본 상태(pushSchema가 LATEST로 기록) -> `{ action: 'ok' }` 반환 확인
3. **Scenario C: code < db (거부 + upgrade 안내)** — schema_version에 LATEST + 1 INSERT 후 -> `{ action: 'reject', reason: 'code_too_old' }` 반환, message에 `waiaas upgrade` 포함 확인
4. **Scenario D: db < MIN_COMPATIBLE (거부 + 단계별 안내)** — schema_version MAX를 MIN_COMPATIBLE - 1로 세팅 후 -> `{ action: 'reject', reason: 'schema_too_old' }` 반환, message에 step-by-step upgrade 안내 포함 확인
5. **Scenario E: 빈 DB (신규 생성)** — schema_version 테이블이 비어있으면 -> `{ action: 'ok' }` 반환 (pushSchema가 알아서 처리)
6. **MIN_COMPATIBLE_SCHEMA_VERSION 값 테스트** — MIN_COMPATIBLE_SCHEMA_VERSION >= 1 이고 <= LATEST_SCHEMA_VERSION인지 확인

**GREEN Phase (구현):**

`packages/daemon/src/infrastructure/database/compatibility.ts` 생성:

```typescript
import type { Database } from 'better-sqlite3';
import { LATEST_SCHEMA_VERSION } from './migrate.js';

/**
 * Minimum DB schema version this code version can work with.
 * If the DB schema is below this, a step-by-step upgrade path is required.
 * Set to 1 (initial schema) -- all migrations from v1 to current are available.
 * Future breaking migrations may bump this value.
 */
export const MIN_COMPATIBLE_SCHEMA_VERSION = 1;

export type CompatibilityResult =
  | { action: 'ok' }
  | { action: 'migrate' }
  | { action: 'reject'; reason: 'code_too_old' | 'schema_too_old'; message: string };

/**
 * Check compatibility between code's expected schema and DB's actual schema version.
 *
 * @param sqlite - Raw better-sqlite3 database instance
 * @returns CompatibilityResult indicating whether to proceed, migrate, or reject
 */
export function checkSchemaCompatibility(sqlite: Database): CompatibilityResult {
  // Check if schema_version table exists
  const tableExists = sqlite
    .prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='schema_version'")
    .get();
  if (!tableExists) {
    // Fresh DB, no schema yet -> pushSchema will handle everything
    return { action: 'ok' };
  }

  // Get current max version
  const row = sqlite
    .prepare('SELECT MAX(version) AS max_version FROM schema_version')
    .get() as { max_version: number | null } | undefined;
  const dbVersion = row?.max_version ?? 0;

  if (dbVersion === 0) {
    // Empty schema_version table -> fresh DB
    return { action: 'ok' };
  }

  if (dbVersion < MIN_COMPATIBLE_SCHEMA_VERSION) {
    return {
      action: 'reject',
      reason: 'schema_too_old',
      message: [
        `DB schema version ${dbVersion} is below minimum compatible version ${MIN_COMPATIBLE_SCHEMA_VERSION}.`,
        `This database was created with a much older version of WAIaaS.`,
        `Step-by-step upgrade required:`,
        `  1. Install the intermediate version: npm install -g @waiaas/cli@<intermediate-version>`,
        `  2. Run: waiaas start (to migrate DB to intermediate schema)`,
        `  3. Then upgrade to latest: waiaas upgrade`,
      ].join('\n'),
    };
  }

  if (dbVersion > LATEST_SCHEMA_VERSION) {
    return {
      action: 'reject',
      reason: 'code_too_old',
      message: [
        `DB schema version ${dbVersion} is newer than code expects (${LATEST_SCHEMA_VERSION}).`,
        `This database was created or migrated by a newer version of WAIaaS.`,
        `Run: waiaas upgrade`,
      ].join('\n'),
    };
  }

  if (dbVersion < LATEST_SCHEMA_VERSION) {
    return { action: 'migrate' };
  }

  // dbVersion === LATEST_SCHEMA_VERSION
  return { action: 'ok' };
}
```

`packages/daemon/src/infrastructure/database/index.ts` 수정:
- `export { checkSchemaCompatibility, MIN_COMPATIBLE_SCHEMA_VERSION } from './compatibility.js';` 추가
- `export type { CompatibilityResult } from './compatibility.js';` 추가

테스트가 모두 통과하는지 확인.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/daemon/src/__tests__/schema-compatibility.test.ts --reporter=verbose` 전체 통과
  </verify>
  <done>
checkSchemaCompatibility 함수가 5개 시나리오(ok/migrate/code_too_old/schema_too_old/fresh_db)를 정확히 판별하고, 6개 이상의 테스트가 전체 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: daemon Step 2에 호환성 검사 통합 + 테스트</name>
  <files>
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/__tests__/schema-compatibility.test.ts
  </files>
  <action>
`packages/daemon/src/lifecycle/daemon.ts` Step 2 수정:

현재 Step 2 시퀀스:
1. createDatabase(dbPath)
2. pushSchema(sqlite)
3. SettingsService 초기화

변경 후 Step 2 시퀀스:
1. createDatabase(dbPath)
2. **checkSchemaCompatibility(sqlite)** 호출
3. 결과에 따라:
   - `action: 'ok'` -> 정상 진행
   - `action: 'migrate'` -> console.log('Step 2: Schema migration needed, applying...') 후 정상 진행 (pushSchema가 migration 수행)
   - `action: 'reject'` -> **throw new WAIaaSError('SCHEMA_INCOMPATIBLE', { message: result.message })** 로 데몬 시작 즉시 중단 (console.error로 message 출력 후 throw)
4. pushSchema(sqlite) (기존과 동일 -- migrate action에서 자동 마이그레이션 실행)
5. SettingsService 초기화

import 추가: `checkSchemaCompatibility`를 `'../infrastructure/database/index.js'`에서 import.

**테스트 추가** (`schema-compatibility.test.ts`에 통합 시나리오 추가):
- DaemonLifecycle.start()를 직접 테스트하기는 복잡하므로, checkSchemaCompatibility의 반환값이 daemon에서 올바르게 처리되는지는 기존 reject 시나리오 테스트로 커버.
- 추가 테스트: schema_version에 LATEST_SCHEMA_VERSION + 5를 INSERT한 뒤 checkSchemaCompatibility 호출 -> reject + 'waiaas upgrade' 메시지 확인
- 추가 테스트: schema_version을 LATEST_SCHEMA_VERSION - 1로 조작한 뒤 checkSchemaCompatibility 호출 -> migrate 반환 확인

WAIaaSError 에러코드로 'SCHEMA_INCOMPATIBLE'은 기존 에러 코드 체계에 없을 수 있다. WAIaaSError 생성자가 임의 string을 허용하는 구조라면 그대로 사용. 아니면 가장 가까운 기존 코드('SYSTEM_LOCKED' 등)를 사용하거나, @waiaas/core에 'SCHEMA_INCOMPATIBLE'을 추가한다 (core의 에러 코드 SSoT 확인 필요).

@waiaas/core의 WAIaaSError가 첫 번째 인자로 임의 string을 받는 구조이므로 'SCHEMA_INCOMPATIBLE'을 그대로 사용한다. 단, ErrorCode 타입이 union literal이라면 해당 union에 추가가 필요할 수 있다 -- 그 경우 core 패키지에 추가한다.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/daemon/src/__tests__/schema-compatibility.test.ts --reporter=verbose` 전체 통과
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx tsc -p packages/daemon/tsconfig.json --noEmit 2>&1 | grep -v 'security-test-helpers'` 에러 없음 (pre-existing 제외)
  </verify>
  <done>
daemon.ts Step 2에서 checkSchemaCompatibility를 호출하여 코드 > DB일 때 자동 마이그레이션이 진행되고, 코드 < DB일 때 WAIaaSError('SCHEMA_INCOMPATIBLE')로 시작이 거부되며, DB < MIN_COMPATIBLE일 때 단계별 안내가 출력된다.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon/src/__tests__/schema-compatibility.test.ts` -- 전체 통과 (6+ tests)
2. `npx tsc -p packages/daemon/tsconfig.json --noEmit` -- 에러 없음 (pre-existing 제외)
3. `npx vitest run packages/daemon/src/__tests__/migration-runner.test.ts` -- 기존 마이그레이션 테스트 회귀 없음
4. `npx vitest run packages/daemon/src/__tests__/database.test.ts` -- 기존 DB 테스트 회귀 없음
</verification>

<success_criteria>
- checkSchemaCompatibility 함수가 3-시나리오 (ok/migrate/reject)를 정확히 판별한다
- MIN_COMPATIBLE_SCHEMA_VERSION 상수가 존재하고 1 이상 LATEST_SCHEMA_VERSION 이하이다
- daemon.ts Step 2에서 reject 시 WAIaaSError throw로 시작을 거부한다
- reject message에 'waiaas upgrade' 안내가 포함된다
- schema_too_old reject message에 단계별 업그레이드 가이드가 포함된다
- 기존 테스트에 회귀가 없다
</success_criteria>

<output>
After completion, create `.planning/phases/162-compatibility-docker/162-01-SUMMARY.md`
</output>
