---
phase: 180-cli-lines-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/__tests__/owner-coverage.test.ts
  - packages/cli/src/__tests__/wallet-coverage.test.ts
  - packages/cli/src/__tests__/password-coverage.test.ts
autonomous: true
requirements:
  - CLI-01
  - CLI-02

must_haves:
  truths:
    - "owner.ts ownerConnectCommand produces QR code, polls for connection status (connected/expired/timeout), and handles network errors during polling"
    - "owner.ts ownerDisconnectCommand sends DELETE to wc/session and prints confirmation"
    - "owner.ts ownerStatusCommand displays session details (peer, address, chain, expiry) and handles no-session case"
    - "owner.ts selectWallet resolves by --wallet id/name, auto-selects single wallet, errors on no wallets, errors on multiple wallets without --wallet"
    - "owner.ts daemonRequest handles non-ok responses by parsing JSON error body and falling back to statusText"
    - "wallet.ts walletInfoCommand fetches wallet details and networks, displays default network and available networks"
    - "wallet.ts walletSetDefaultNetworkCommand sends PUT to change default network and displays previous/current"
    - "wallet.ts selectWallet/daemonRequest/getMasterPassword work identically to owner.ts counterparts"
    - "password.ts promptPassword resolves on valid input, rejects on empty input, and rejects on readline error"
  artifacts:
    - path: "packages/cli/src/__tests__/owner-coverage.test.ts"
      provides: "Owner command unit tests covering connect/disconnect/status/selectWallet/daemonRequest"
      min_lines: 250
    - path: "packages/cli/src/__tests__/wallet-coverage.test.ts"
      provides: "Wallet command unit tests covering info/set-default-network/selectWallet/daemonRequest"
      min_lines: 200
    - path: "packages/cli/src/__tests__/password-coverage.test.ts"
      provides: "Password prompt unit tests covering promptPassword valid/empty/error paths"
      min_lines: 60
  key_links:
    - from: "packages/cli/src/__tests__/owner-coverage.test.ts"
      to: "packages/cli/src/commands/owner.ts"
      via: "import ownerConnectCommand, ownerDisconnectCommand, ownerStatusCommand"
      pattern: "import.*owner(Connect|Disconnect|Status)Command.*from.*owner"
    - from: "packages/cli/src/__tests__/wallet-coverage.test.ts"
      to: "packages/cli/src/commands/wallet.ts"
      via: "import walletInfoCommand, walletSetDefaultNetworkCommand"
      pattern: "import.*wallet(Info|SetDefaultNetwork)Command.*from.*wallet"
    - from: "packages/cli/src/__tests__/password-coverage.test.ts"
      to: "packages/cli/src/utils/password.ts"
      via: "import resolvePassword"
      pattern: "import.*resolvePassword.*from.*password"
---

<objective>
Add unit tests for owner.ts, wallet.ts, and password.ts to raise @waiaas/cli line/statement coverage from 68% to 70%+.

Purpose: These three files account for ~436 uncovered lines (owner.ts 227, wallet.ts 173, password.ts ~36). Testing their exported command functions via mocked fetch (vi.stubGlobal) and mocked process.exit will cover the majority of these lines and push overall CLI coverage above the 70% threshold needed to restore vitest.config.ts coverage gates.

Output: Three new test files exercising all command flows (happy path + error paths) and the password interactive prompt.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/cli/src/commands/owner.ts
@packages/cli/src/commands/wallet.ts
@packages/cli/src/utils/password.ts
@packages/cli/src/__tests__/quickstart.test.ts (pattern reference for fetch mocking)
@packages/cli/src/__tests__/cli-commands.test.ts (pattern reference for process.exit mocking)
@packages/cli/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add owner.ts command coverage tests</name>
  <files>packages/cli/src/__tests__/owner-coverage.test.ts</files>
  <action>
Create `packages/cli/src/__tests__/owner-coverage.test.ts` with unit tests for all exported functions in `commands/owner.ts`. Follow the existing pattern from `quickstart.test.ts` for fetch mocking (vi.stubGlobal) and `cli-commands.test.ts` for process.exit mocking.

**Test setup:**
- Mock `process.exit` to throw `ExitError` (same pattern as cli-commands.test.ts)
- Mock `console.log`, `console.error`, `process.stdout.write` via vi.spyOn
- Mock `resolvePassword` via `vi.doMock('../utils/password.js', ...)` to return a test password
- Mock `qrcode` via `vi.doMock('qrcode', ...)` to return a dummy QR string from `toString()`
- Create `mockResponse(status, body)` helper (same as quickstart.test.ts)
- Stub `fetch` globally via `vi.stubGlobal('fetch', mockFn)`

**Test cases for `ownerConnectCommand`:**
1. Happy path without polling (`poll: false`): calls POST /v1/wallets/{id}/wc/pair, prints URI and QR code
2. Happy path with polling (`poll: true`): polls GET /v1/wallets/{id}/wc/pair/status, eventually returns `connected`, prints peer info
3. Polling: status `expired` causes process.exit(1)
4. Polling: network error during poll writes 'x' and continues
5. Polling: timeout after maxPolls (mock 2 iterations with reduced loop count not feasible -- test that 'pending' status writes '.' to stdout)

**Test cases for `ownerDisconnectCommand`:**
6. Happy path: calls DELETE /v1/wallets/{id}/wc/session, prints confirmation

**Test cases for `ownerStatusCommand`:**
7. Happy path: calls GET /v1/wallets/{id}/wc/session, prints session details (peer, URL, address, chain, expiry, created)
8. No session / error: catch block prints "No active WalletConnect session"

**Test cases for `selectWallet` (tested indirectly via commands):**
9. No wallets (empty items array): process.exit(1) with "No wallets found"
10. Wallet found by --wallet id
11. Wallet not found by --wallet id: process.exit(1)
12. Multiple wallets without --wallet: process.exit(1) with "Multiple wallets found"
13. Auto-select single wallet (no --wallet provided)

**Test cases for `daemonRequest` (tested indirectly):**
14. Non-ok response with JSON body containing `message`: prints error message
15. Non-ok response where JSON parsing fails: falls back to statusText

**Test cases for `getMasterPassword` (tested indirectly):**
16. Uses opts.password when provided (no resolvePassword call)

All tests should use `await import('../commands/owner.js')` for dynamic imports after mocking.
  </action>
  <verify>
Run `pnpm --filter @waiaas/cli vitest run src/__tests__/owner-coverage.test.ts` -- all tests pass.
Run `pnpm --filter @waiaas/cli test -- --coverage` -- owner.ts lines > 80%.
  </verify>
  <done>
owner.ts line coverage rises from 0% to 80%+ with tests covering connect (with/without polling, expired, timeout, network error), disconnect, status (with/without session), selectWallet (all 5 branches), daemonRequest error handling, and getMasterPassword delegation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add wallet.ts + password.ts coverage tests</name>
  <files>
packages/cli/src/__tests__/wallet-coverage.test.ts
packages/cli/src/__tests__/password-coverage.test.ts
  </files>
  <action>
**Part A: `wallet-coverage.test.ts`**

Create `packages/cli/src/__tests__/wallet-coverage.test.ts` with unit tests for `commands/wallet.ts`. Same mocking approach as Task 1 (vi.stubGlobal fetch, process.exit ExitError, resolvePassword doMock).

**Test cases for `walletInfoCommand`:**
1. Happy path: fetches wallet list (auto-select single), then GET /v1/wallets/{id}/networks. Prints wallet name, ID, chain, environment, address, default network, available networks, status.
2. No default network in availableNetworks: falls back to wallet.network from list response

**Test cases for `walletSetDefaultNetworkCommand`:**
3. Happy path: sends PUT /v1/wallets/{id}/default-network with `{ network }`, prints previous and current network
4. Previous network is null: prints "(none)" for previous

**Test cases for `selectWallet` (same logic as owner.ts):**
5. No wallets: exits with error
6. Wallet by id: found
7. Wallet by name: found
8. Wallet not found: exits with error
9. Multiple wallets, no --wallet: exits listing wallets

**Test cases for `daemonRequest`:**
10. Non-ok with JSON error body: prints message from body
11. Non-ok with non-JSON error body: falls back to statusText

**Test cases for `getMasterPassword`:**
12. Uses opts.password when provided

**Part B: `password-coverage.test.ts`**

Create `packages/cli/src/__tests__/password-coverage.test.ts` to test the interactive `promptPassword` function (lines 29-64 of password.ts). The existing `cli-commands.test.ts` already tests the env var and file paths; this test covers the stdin interactive prompt path.

**Approach:** Mock `process.stdin` and `process.stdout` to avoid actual terminal interaction. Use `createInterface` with a PassThrough stream to simulate user input.

**Test cases:**
1. `resolvePassword` with no env vars and no file: calls promptPassword, user types "my-secure-pw\n" â†’ resolves with "my-secure-pw"
2. `resolvePassword` with empty input: rejects with "Password cannot be empty"
3. `resolvePassword` with readline error: rejects with the error

Implementation note: Create a mock stdin that is a PassThrough/Readable stream. Override `process.stdin` temporarily. Push data to simulate user typing. The `promptPassword` function writes ANSI escape codes to stdout -- mock `process.stdout.write` to capture those.

Alternatively, since `promptPassword` is not exported, test it via `resolvePassword()` with both env vars deleted and stdin mocked. Use `vi.doMock('node:readline', ...)` to provide a controlled `createInterface` that emits 'line' or 'error' events on demand.
  </action>
  <verify>
Run `pnpm --filter @waiaas/cli vitest run src/__tests__/wallet-coverage.test.ts src/__tests__/password-coverage.test.ts` -- all tests pass.
Run `pnpm --filter @waiaas/cli test -- --coverage` -- wallet.ts lines > 80%, password.ts lines > 70%.
Overall CLI lines >= 70%, statements >= 70%.
  </verify>
  <done>
wallet.ts line coverage rises from 0% to 80%+ covering walletInfoCommand (networks display, default network fallback), walletSetDefaultNetworkCommand (previous null), selectWallet (all 5 branches), daemonRequest error paths, getMasterPassword.
password.ts line coverage rises from 31.7% to 70%+ covering promptPassword (valid input, empty input rejection, readline error).
Overall CLI package lines/statements coverage reaches 70%+, satisfying the Phase 180 goal.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/cli test -- --coverage` passes with 0 failures
2. owner.ts line coverage > 80%
3. wallet.ts line coverage > 80%
4. password.ts line coverage > 70%
5. Overall CLI lines >= 70%, statements >= 70%
6. No existing tests broken (129 existing tests still pass)
</verification>

<success_criteria>
- All 3 new test files pass without failures
- owner.ts rises from 0% to 80%+ line coverage
- wallet.ts rises from 0% to 80%+ line coverage
- password.ts rises from 31.7% to 70%+ line coverage
- Overall @waiaas/cli line coverage >= 70% (up from 68.09%)
- Overall @waiaas/cli statement coverage >= 70% (up from 68.09%)
- All 129 existing CLI tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/180-cli-lines-coverage/180-01-SUMMARY.md`
</output>
