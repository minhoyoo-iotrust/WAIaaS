---
phase: 59-rest-api-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/wallet.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/api/routes/nonce.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/api-new-endpoints.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /v1/wallet/assets returns array of AssetInfo objects (native SOL + SPL tokens)"
    - "GET /v1/transactions returns cursor-paginated transaction list with limit/cursor params"
    - "GET /v1/transactions/pending returns only QUEUED/DELAYED/PENDING_APPROVAL transactions"
    - "GET /v1/nonce returns a random nonce string for ownerAuth signature construction"
    - "GET /v1/agents returns masterAuth-protected agent list"
    - "GET /v1/agents/:id returns agent detail including ownerState (NONE/GRACE/LOCKED)"
  artifacts:
    - path: "packages/daemon/src/api/routes/wallet.ts"
      provides: "GET /wallet/assets route using adapter.getAssets()"
      contains: "walletAssetsRoute"
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "GET /transactions list + GET /transactions/pending routes"
      contains: "listTransactionsRoute"
    - path: "packages/daemon/src/api/routes/agents.ts"
      provides: "GET /agents list + GET /agents/:id detail routes"
      contains: "listAgentsRoute"
    - path: "packages/daemon/src/api/routes/nonce.ts"
      provides: "GET /nonce route for ownerAuth nonce"
      contains: "nonceRoutes"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "AssetInfoResponseSchema, TxListResponseSchema, NonceResponseSchema, AgentDetailResponseSchema"
      contains: "AssetInfoResponseSchema"
    - path: "packages/daemon/src/api/server.ts"
      provides: "Auth middleware + route registration for new endpoints"
      contains: "nonceRoutes"
    - path: "packages/daemon/src/__tests__/api-new-endpoints.test.ts"
      provides: "Tests for all 6 new endpoints"
  key_links:
    - from: "packages/daemon/src/api/routes/wallet.ts"
      to: "IChainAdapter.getAssets()"
      via: "adapter.getAssets(agent.publicKey)"
      pattern: "adapter\\.getAssets"
    - from: "packages/daemon/src/api/routes/transactions.ts"
      to: "transactions table"
      via: "Drizzle query with cursor pagination"
      pattern: "db\\.select\\(\\)\\.from\\(transactions\\)"
    - from: "packages/daemon/src/api/server.ts"
      to: "route sub-routers"
      via: "app.route('/v1', ...)"
      pattern: "app\\.route"
---

<objective>
Add 6 SDK/MCP-critical REST endpoints using the OpenAPIHono createRoute() pattern established in Phase 58: GET /v1/wallet/assets, GET /v1/transactions (cursor pagination), GET /v1/transactions/pending, GET /v1/nonce, GET /v1/agents, GET /v1/agents/:id.

Purpose: These 6 endpoints are consumed by TypeScript SDK, Python SDK, and MCP Server in Phases 61-63. Without them, SDK clients cannot list assets, browse transaction history, or query agent details.

Output: 6 new OpenAPIHono routes with Zod schemas, auth middleware wiring, and test coverage.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-openapihono-getassets/58-01-SUMMARY.md
@.planning/phases/58-openapihono-getassets/58-02-SUMMARY.md
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/agents.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/core/src/schemas/asset.schema.ts
@packages/core/src/errors/error-codes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenAPI response schemas + nonce route file</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/nonce.ts
    packages/daemon/src/api/routes/index.ts
  </files>
  <action>
**openapi-schemas.ts** -- Add these new response schemas (following existing pattern with z from @hono/zod-openapi):

1. `WalletAssetsResponseSchema` -- array wrapper:
```ts
z.object({
  agentId: z.string().uuid(),
  chain: z.string(),
  network: z.string(),
  assets: z.array(z.object({
    mint: z.string(),
    symbol: z.string(),
    name: z.string(),
    balance: z.string(),
    decimals: z.number().int(),
    isNative: z.boolean(),
    usdValue: z.number().optional(),
  })),
}).openapi('WalletAssetsResponse')
```

2. `TxListResponseSchema` -- cursor-paginated list:
```ts
z.object({
  items: z.array(TxDetailResponseSchema), // reuse existing TxDetailResponseSchema
  cursor: z.string().nullable(),
  hasMore: z.boolean(),
}).openapi('TxListResponse')
```

3. `TxPendingListResponseSchema` -- pending transactions:
```ts
z.object({
  items: z.array(TxDetailResponseSchema),
}).openapi('TxPendingListResponse')
```

4. `NonceResponseSchema`:
```ts
z.object({
  nonce: z.string(),
  expiresAt: z.number().int(),
}).openapi('NonceResponse')
```

5. `AgentListResponseSchema`:
```ts
z.object({
  items: z.array(AgentResponseSchema),
}).openapi('AgentListResponse')
```

6. `AgentDetailResponseSchema` -- full agent with owner state:
```ts
z.object({
  id: z.string().uuid(),
  name: z.string(),
  chain: z.string(),
  network: z.string(),
  publicKey: z.string(),
  status: z.string(),
  ownerAddress: z.string().nullable(),
  ownerVerified: z.boolean().nullable(),
  ownerState: z.enum(['NONE', 'GRACE', 'LOCKED']),
  createdAt: z.number().int(),
  updatedAt: z.number().int().nullable(),
}).openapi('AgentDetailResponse')
```

**nonce.ts** -- Create new route file:
- Import OpenAPIHono, createRoute, z from @hono/zod-openapi
- Import { randomBytes } from 'node:crypto'
- Import NonceResponseSchema, buildErrorResponses, openApiValidationHook from openapi-schemas.ts
- Define `nonceRoute = createRoute({ method: 'get', path: '/nonce', tags: ['Auth'], summary: 'Get ownerAuth nonce', responses: { 200: { description: 'Nonce for signature', content: { 'application/json': { schema: NonceResponseSchema } } } } })`
- Export `nonceRoutes()` factory returning OpenAPIHono router
- Handler: generate 32-byte random hex nonce via `randomBytes(32).toString('hex')`, set expiresAt = now + 300 seconds (5 min nonce lifetime)
- The nonce is stateless for now (v1.3 does not require server-side nonce storage -- the ownerAuth middleware already validates Ed25519 signatures independently). The nonce endpoint is provided for SDK/MCP clients to construct ownerAuth request payloads.
- No auth middleware needed on this endpoint (public)

**index.ts** -- Add barrel export:
```ts
export { nonceRoutes } from './nonce.js';
```
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- must compile without errors.
  </verify>
  <done>6 new OpenAPI response schemas in openapi-schemas.ts, nonce.ts route file created and exported from barrel.</done>
</task>

<task type="auto">
  <name>Task 2: Add assets/transactions/agents routes + server wiring</name>
  <files>
    packages/daemon/src/api/routes/wallet.ts
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/api/routes/agents.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
**wallet.ts** -- Add GET /wallet/assets route:
- Define `walletAssetsRoute = createRoute({ method: 'get', path: '/wallet/assets', tags: ['Wallet'], summary: 'Get wallet assets', responses: { 200: { ... WalletAssetsResponseSchema }, ...buildErrorResponses(['AGENT_NOT_FOUND', 'CHAIN_ERROR']) } })`
- Handler: get agentId from context (sessionAuth), resolve agent, call `adapter.getAssets(agent.publicKey)`, map AssetInfo[] to DTO (balance.toString()), return WalletAssetsResponse JSON
- Register on the existing walletRoutes router via `router.openapi(walletAssetsRoute, ...)`

**transactions.ts** -- Add GET /transactions (list) and GET /transactions/pending:

1. `listTransactionsRoute = createRoute({ method: 'get', path: '/transactions', tags: ['Transactions'], summary: 'List transactions', request: { query: z.object({ limit: z.coerce.number().int().min(1).max(100).default(20).optional(), cursor: z.string().uuid().optional() }) }, responses: { 200: { ... TxListResponseSchema } } })`
- Handler: get agentId from sessionAuth context, query transactions table WHERE agentId = agentId, ordered by createdAt DESC. If cursor provided, WHERE id < cursor (UUID v7 ordering). Limit + 1 to detect hasMore. Map tx rows to TxDetailResponse shape (createdAt epoch). Return { items, cursor: lastItem.id or null, hasMore }.

2. `pendingTransactionsRoute = createRoute({ method: 'get', path: '/transactions/pending', tags: ['Transactions'], summary: 'List pending transactions', responses: { 200: { ... TxPendingListResponseSchema } } })`
- Handler: get agentId from sessionAuth context, query transactions WHERE agentId = agentId AND status IN ('QUEUED', 'DELAYED', 'PENDING_APPROVAL') ordered by createdAt DESC. Return { items }.

IMPORTANT: Register `listTransactionsRoute` and `pendingTransactionsRoute` BEFORE `getTransactionRoute` (the existing GET /transactions/:id) on the router. This is because Hono matches routes in registration order, and `/transactions/pending` must match before `/transactions/{id}`. Similarly, GET `/transactions` (no sub-path) must not conflict with the existing `/transactions/send` POST. Since one is GET and one is POST, there is no conflict.

**agents.ts** -- Add GET /agents (list) and GET /agents/:id (detail):

1. `listAgentsRoute = createRoute({ method: 'get', path: '/agents', tags: ['Agents'], summary: 'List all agents', responses: { 200: { ... AgentListResponseSchema } } })`
- Handler: query all agents from DB, map to AgentResponse shape (createdAt epoch). Return { items }.
- Protected by masterAuth (already applied on /v1/agents in server.ts).

2. `agentDetailRoute = createRoute({ method: 'get', path: '/agents/{id}', tags: ['Agents'], summary: 'Get agent details', request: { params: z.object({ id: z.string().uuid() }) }, responses: { 200: { ... AgentDetailResponseSchema }, ...buildErrorResponses(['AGENT_NOT_FOUND']) } })`
- Handler: get agent by ID, compute ownerState via `resolveOwnerState({ ownerAddress, ownerVerified })`, return AgentDetailResponse with ownerState field.
- Protected by masterAuth (already covered by /v1/agents/:id path matching -- BUT need to add masterAuth to `/v1/agents/:id` path in server.ts since current setup only covers `/v1/agents` for POST).

IMPORTANT: Register `listAgentsRoute` BEFORE `createAgentRoute` to avoid GET /agents being shadowed by POST /agents (though method difference prevents shadowing). More critically, register `agentDetailRoute` in the router. The existing router only has POST /agents and PUT /agents/:id/owner. Adding GET /agents and GET /agents/:id.

**server.ts** -- Wire new routes and auth:

1. Add masterAuth to `/v1/agents/:id` for GET detail (currently only POST /v1/agents and PUT /v1/agents/:id/owner are protected):
```ts
// In the masterAuth registration section, add:
app.use('/v1/agents/:id', async (c, next) => {
  // Skip /v1/agents/:id/owner (already has its own masterAuth)
  if (c.req.path.includes('/owner')) {
    await next();
    return;
  }
  return masterAuth(c, next);
});
```

2. Add nonce route registration (public, no auth):
```ts
import { nonceRoutes } from './routes/nonce.js';
// ...
app.route('/v1', nonceRoutes());
```

3. Ensure sessionAuth covers `/v1/transactions` GET (already covered by `/v1/transactions/*` pattern -- but `GET /v1/transactions` without trailing path may not match `/v1/transactions/*`. Test this. If not matched, add explicit `app.use('/v1/transactions', sessionAuth)` for the exact path).

Actually, checking Hono wildcard behavior: `app.use('/v1/transactions/*', sessionAuth)` will NOT match `/v1/transactions` (no trailing slash or sub-path). Need to add:
```ts
app.use('/v1/transactions', sessionAuth);
```
This is needed for the new GET /v1/transactions list endpoint. The existing `/v1/transactions/*` already covers /send, /:id, /:id/approve, etc.
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- must compile without errors.
  </verify>
  <done>6 new routes (assets, list transactions, pending transactions, nonce, list agents, agent detail) registered with correct auth middleware wiring.</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for 6 new endpoints + verify all existing tests pass</name>
  <files>
    packages/daemon/src/__tests__/api-new-endpoints.test.ts
  </files>
  <action>
Create test file following existing test patterns (see api-agents.test.ts, api-transactions.test.ts for reference).

Test setup:
- Import createApp, create test app with mock deps (db, adapter, keyStore, config, jwtSecretManager, masterPasswordHash)
- Use the existing in-memory SQLite + Drizzle pattern from other daemon test files
- Create test agent and session for sessionAuth-protected routes
- Create masterAuth hash for masterAuth-protected routes

**Test cases (minimum 15):**

GET /v1/wallet/assets:
1. Returns 200 with native SOL asset when adapter.getAssets() returns data
2. Returns 200 with empty assets array when adapter.getAssets() returns []
3. Returns 401 without sessionAuth token

GET /v1/transactions:
4. Returns 200 with paginated list (limit=2, check hasMore=true when 3 txs exist)
5. Returns 200 with cursor-based pagination (cursor=tx2.id returns tx3 only)
6. Returns 200 with empty list for agent with no transactions
7. Returns 401 without sessionAuth token

GET /v1/transactions/pending:
8. Returns 200 with only QUEUED/DELAYED/PENDING_APPROVAL transactions
9. Excludes CONFIRMED and FAILED transactions from pending list
10. Returns 401 without sessionAuth token

GET /v1/nonce:
11. Returns 200 with nonce (64 hex chars) and expiresAt (future timestamp)
12. Returns different nonce on each call

GET /v1/agents:
13. Returns 200 with agent list (masterAuth required)
14. Returns 401 without masterAuth header

GET /v1/agents/:id:
15. Returns 200 with agent detail including ownerState field
16. Returns ownerState='NONE' when no owner, 'GRACE' when owner set but unverified
17. Returns 404 for non-existent agent ID

Use `app.request()` pattern for HTTP testing (Hono built-in test helper). For sessionAuth, create a real JWT token using JwtSecretManager. For masterAuth, include X-Master-Password header.

After creating tests, run full test suite:
```bash
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test
```
All existing tests + new tests must pass.
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` -- all tests pass (existing + new).
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- clean build.
  </verify>
  <done>15+ new test cases pass for all 6 endpoints, all existing tests pass (no regressions).</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with zero errors
2. `pnpm test` passes all existing + new tests
3. GET /v1/wallet/assets returns AssetInfo[] with agentId, chain, network
4. GET /v1/transactions returns { items, cursor, hasMore } with cursor pagination
5. GET /v1/transactions/pending returns only QUEUED/DELAYED/PENDING_APPROVAL
6. GET /v1/nonce returns { nonce, expiresAt } without auth
7. GET /v1/agents returns agent list with masterAuth
8. GET /v1/agents/:id returns agent detail with ownerState field
9. GET /doc OpenAPI spec includes all 6 new routes in paths
</verification>

<success_criteria>
- 6 new OpenAPIHono routes operational with correct request/response schemas
- Auth middleware correctly applied: sessionAuth on wallet/transactions, masterAuth on agents list/detail, none on nonce
- Cursor pagination on transactions list (limit/cursor query params)
- ownerState derived field on agent detail (NONE/GRACE/LOCKED via resolveOwnerState)
- 15+ new test cases pass
- All existing tests pass (zero regressions)
- GET /doc includes all 6 new routes
</success_criteria>

<output>
After completion, create `.planning/phases/59-rest-api-expansion/59-01-SUMMARY.md`
</output>
