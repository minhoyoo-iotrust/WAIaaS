---
phase: 161-cli-upgrade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/utils/update-notify.ts
  - packages/cli/src/index.ts
  - packages/cli/src/__tests__/update-notify.test.ts
autonomous: true
requirements: [VCHK-05, VCHK-06, VCHK-07]

must_haves:
  truths:
    - "CLI 실행 시 새 버전이 있으면 stderr에 업그레이드 알림 박스가 출력된다"
    - "24시간 내 재실행 시 알림이 중복 출력되지 않는다"
    - "--quiet 플래그 또는 WAIAAS_NO_UPDATE_NOTIFY=1 환경변수로 알림이 억제된다"
    - "알림 출력이 stdout을 오염시키지 않는다 (stderr만 사용)"
  artifacts:
    - path: "packages/cli/src/utils/update-notify.ts"
      provides: "CLI 업그레이드 알림 모듈"
      exports: ["checkAndNotifyUpdate"]
    - path: "packages/cli/src/__tests__/update-notify.test.ts"
      provides: "알림 모듈 단위 테스트"
      min_lines: 80
  key_links:
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/utils/update-notify.ts"
      via: "program.parseAsync 전에 checkAndNotifyUpdate 호출"
      pattern: "checkAndNotifyUpdate"
    - from: "packages/cli/src/utils/update-notify.ts"
      to: "http://127.0.0.1:{port}/health"
      via: "fetch로 /health 엔드포인트에서 latestVersion, updateAvailable 조회"
      pattern: "fetch.*health"
---

<objective>
CLI 실행 시 새 버전이 있으면 stderr에 업그레이드 안내 알림을 출력하는 모듈을 구현한다. 24시간 중복 방지, --quiet/환경변수 억제 기능을 포함한다.

Purpose: 사용자가 CLI를 사용할 때 자연스럽게 새 버전 출시를 알 수 있도록 하여 업그레이드를 유도한다.
Output: update-notify.ts 유틸리티 모듈 + CLI 엔트리포인트 통합 + 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/160-version-check-infra/160-02-SUMMARY.md

# Key source files
@packages/cli/src/index.ts
@packages/cli/src/utils/data-dir.ts
@packages/cli/src/commands/status.ts
@packages/daemon/src/api/routes/health.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: update-notify 모듈 + CLI 통합 + 테스트</name>
  <files>
    packages/cli/src/utils/update-notify.ts
    packages/cli/src/index.ts
    packages/cli/src/__tests__/update-notify.test.ts
  </files>
  <action>
**1. `packages/cli/src/utils/update-notify.ts` 생성:**

`checkAndNotifyUpdate(opts)` 함수를 export한다.

**파라미터:**
```ts
interface UpdateNotifyOpts {
  dataDir: string;      // resolveDataDir() 결과
  quiet?: boolean;      // --quiet 플래그
}
```

**로직 (순서대로):**
1. `opts.quiet === true` 또는 `process.env['WAIAAS_NO_UPDATE_NOTIFY'] === '1'` 이면 즉시 return
2. `{dataDir}/config.toml`에서 port 읽기 (status.ts의 resolvePort 패턴 재사용 — 간단한 regex 파싱, 기본값 3100)
3. `fetch(`http://127.0.0.1:${port}/health`)` 호출 (AbortSignal.timeout(2000) — CLI 응답성 보장)
4. 응답에서 `updateAvailable`, `latestVersion`, `version` 파싱
5. `updateAvailable !== true`이면 return
6. 24시간 중복 방지: 응답 JSON에서 직접 확인하는 게 아니라, **로컬 파일** `{dataDir}/.last-update-notify` 의 mtime을 확인한다. mtime이 24시간 이내이면 return. (데몬이 실행 중이지 않을 수도 있으므로 key_value_store가 아닌 파일 기반 — CLI는 데몬과 독립적으로 동작해야 함)
7. `{dataDir}/.last-update-notify` 파일을 touch (writeFileSync로 빈 내용 쓰기)
8. stderr에 알림 박스 출력:

```
╭──────────────────────────────────────╮
│                                      │
│   Update available: 1.7.0 → 2.0.0   │
│   Run: waiaas upgrade                │
│                                      │
╰──────────────────────────────────────╯
```

**중요 사항:**
- 모든 에러를 try/catch로 감싸서 무시한다 (CLI 정상 동작을 절대 방해하지 않음)
- 반드시 `process.stderr.write`로 출력한다 (stdout 오염 방지)
- 함수는 async이지만 fire-and-forget으로 호출되어야 한다 (CLI 명령 실행을 블로킹하지 않음)

**2. `packages/cli/src/index.ts` 수정:**

- `import { checkAndNotifyUpdate } from './utils/update-notify.js'` 추가
- program에 `.option('--quiet', 'Suppress update notifications')` 추가 (전역 옵션)
- `program.parseAsync()` 호출 **전에** fire-and-forget으로 알림 체크:

```ts
const globalOpts = program.opts() as { quiet?: boolean };
// 먼저 parse 전에 argv에서 --quiet와 --data-dir를 수동 파싱해야 한다.
// 이유: program.parseAsync() 전에는 opts()가 비어있으므로
// process.argv에서 직접 --quiet, --data-dir 플래그 존재 여부를 확인한다.
const hasQuiet = process.argv.includes('--quiet');
const dataDirIdx = process.argv.indexOf('--data-dir');
const dataDirArg = dataDirIdx >= 0 ? process.argv[dataDirIdx + 1] : undefined;
const effectiveDataDir = resolveDataDir({ dataDir: dataDirArg });

// Fire-and-forget: do not await, do not block CLI startup
checkAndNotifyUpdate({ dataDir: effectiveDataDir, quiet: hasQuiet }).catch(() => {});
```

이 코드를 `program.parseAsync(process.argv)` 호출 직전에 배치한다.

**3. `packages/cli/src/__tests__/update-notify.test.ts` 생성:**

vitest로 테스트. global fetch를 vi.fn()으로 mock한다.

테스트 케이스 (최소 8개):
1. updateAvailable=true → stderr에 "Update available" 문자열 출력 확인
2. updateAvailable=false → stderr 출력 없음
3. fetch 실패 (네트워크 에러) → stderr 출력 없음, 에러 throw 없음
4. 24시간 내 .last-update-notify 존재 → stderr 출력 없음
5. 24시간 초과 .last-update-notify 존재 → stderr에 알림 출력
6. quiet=true → fetch 호출 없음
7. WAIAAS_NO_UPDATE_NOTIFY=1 환경변수 → fetch 호출 없음
8. 알림 후 .last-update-notify 파일이 생성/갱신됨

각 테스트에서:
- tmpdir로 가짜 dataDir 생성
- process.stderr.write를 vi.spyOn으로 감시
- global.fetch를 vi.fn()으로 mock
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/cli/src/__tests__/update-notify.test.ts` — 8개 이상 테스트 통과

`cd /Users/minho.yoo/dev/wallet/WAIaaS && npx tsc -p packages/cli/tsconfig.json --noEmit` — 타입 에러 없음 (pre-existing 제외)
  </verify>
  <done>
- update-notify.ts가 존재하고 checkAndNotifyUpdate 함수를 export한다
- CLI index.ts에서 parseAsync 전에 fire-and-forget으로 호출한다
- --quiet 플래그와 WAIAAS_NO_UPDATE_NOTIFY 환경변수가 알림을 억제한다
- 24시간 내 중복 알림이 방지된다
- 8개 이상 단위 테스트가 통과한다
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/cli/src/__tests__/update-notify.test.ts` — 전체 통과
2. `npx tsc -p packages/cli/tsconfig.json --noEmit` — 새 에러 없음
3. update-notify.ts에 `checkAndNotifyUpdate` export 존재 확인
4. index.ts에 `checkAndNotifyUpdate` 호출 존재 확인
5. 알림이 stderr로만 출력되는지 테스트에서 확인
</verification>

<success_criteria>
- VCHK-05: CLI 실행 시 새 버전이 있으면 stderr에 업그레이드 알림을 출력한다 (테스트로 검증)
- VCHK-06: 24시간 내 재실행 시 알림이 중복 출력되지 않는다 (.last-update-notify 파일 mtime 확인)
- VCHK-07: --quiet 플래그 또는 WAIAAS_NO_UPDATE_NOTIFY=1 환경변수로 알림을 억제할 수 있다 (테스트로 검증)
</success_criteria>

<output>
After completion, create `.planning/phases/161-cli-upgrade/161-01-SUMMARY.md`
</output>
