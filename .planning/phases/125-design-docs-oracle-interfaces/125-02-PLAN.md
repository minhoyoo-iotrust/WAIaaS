---
phase: 125-design-docs-oracle-interfaces
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/price-oracle.types.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/index.ts
  - packages/daemon/src/infrastructure/oracle/index.ts
  - packages/daemon/src/infrastructure/oracle/price-cache.ts
  - packages/daemon/src/infrastructure/oracle/price-age.ts
  - packages/daemon/src/__tests__/price-cache.test.ts
  - packages/daemon/src/__tests__/price-age.test.ts
autonomous: true

must_haves:
  truths:
    - "IPriceOracle 인터페이스가 getPrice/getPrices/getNativePrice/getCacheStats 4개 메서드를 정의한다"
    - "TokenRefSchema, PriceInfoSchema가 Zod SSoT로 정의되고 z.infer로 타입이 파생된다"
    - "InMemoryPriceCache가 5분 TTL로 캐시 항목을 만료시킨다"
    - "InMemoryPriceCache가 128항목 LRU 상한을 초과하면 가장 오래된 항목을 퇴거한다"
    - "InMemoryPriceCache.getOrFetch가 동일 키에 대한 동시 요청을 하나의 fetch로 합쳐 cache stampede를 방지한다"
    - "classifyPriceAge가 5분 미만을 FRESH, 5~30분을 AGING, 30분 초과를 STALE로 판정한다"
    - "모든 단위 테스트가 통과한다"
  artifacts:
    - path: "packages/core/src/interfaces/price-oracle.types.ts"
      provides: "TokenRef, PriceInfo, CacheStats, IPriceOracle Zod SSoT types"
      exports: ["TokenRefSchema", "TokenRef", "PriceInfoSchema", "PriceInfo", "CacheStats", "IPriceOracle"]
    - path: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      provides: "InMemoryPriceCache (LRU 128, 5min TTL, stampede prevention)"
      exports: ["InMemoryPriceCache", "buildCacheKey"]
    - path: "packages/daemon/src/infrastructure/oracle/price-age.ts"
      provides: "classifyPriceAge function, PriceAge enum, threshold constants"
      exports: ["classifyPriceAge", "PriceAge", "PriceAgeEnum", "PRICE_AGE_THRESHOLDS", "PRICE_AGES"]
    - path: "packages/daemon/src/infrastructure/oracle/index.ts"
      provides: "barrel export for oracle module"
    - path: "packages/daemon/src/__tests__/price-cache.test.ts"
      provides: "InMemoryPriceCache unit tests"
    - path: "packages/daemon/src/__tests__/price-age.test.ts"
      provides: "classifyPriceAge unit tests"
  key_links:
    - from: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      to: "packages/core/src/interfaces/price-oracle.types.ts"
      via: "import PriceInfo type"
      pattern: "import.*PriceInfo.*from.*@waiaas/core"
    - from: "packages/daemon/src/infrastructure/oracle/price-age.ts"
      to: "packages/core/src/interfaces/price-oracle.types.ts"
      via: "PriceAge is co-located with oracle types concept"
      pattern: "PRICE_AGE_THRESHOLDS"
    - from: "packages/core/src/index.ts"
      to: "packages/core/src/interfaces/price-oracle.types.ts"
      via: "re-export price oracle types"
      pattern: "TokenRefSchema.*PriceInfoSchema.*IPriceOracle"
---

<objective>
IPriceOracle 인터페이스(Zod SSoT) + InMemoryPriceCache(LRU 128, 5분 TTL) + classifyPriceAge(FRESH/AGING/STALE)를 TDD로 구현한다.

Purpose: Phase 126(Oracle 구현체)과 Phase 127(USD 정책 통합)이 참조할 인터페이스와 인프라 계층을 구축한다. 외부 API 호출 없이 동작하는 기반 코드만 포함한다.
Output: core 패키지에 Zod 스키마/인터페이스, daemon 패키지에 캐시/가격 나이 분류기 + 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/125-design-docs-oracle-interfaces/125-RESEARCH.md
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/index.ts
@packages/core/src/enums/chain.ts
@packages/daemon/src/infrastructure/token-registry/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD — IPriceOracle Zod SSoT 타입 + classifyPriceAge</name>
  <files>
    packages/core/src/interfaces/price-oracle.types.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/index.ts
    packages/daemon/src/infrastructure/oracle/price-age.ts
    packages/daemon/src/infrastructure/oracle/index.ts
    packages/daemon/src/__tests__/price-age.test.ts
  </files>
  <action>
**RED phase: `packages/daemon/src/__tests__/price-age.test.ts` 테스트 파일 생성**

`import { classifyPriceAge, PriceAgeEnum, PRICE_AGE_THRESHOLDS } from '../infrastructure/oracle/price-age.js'`로 import하여 9개 테스트 케이스를 vitest describe/it으로 작성한다. vi.useFakeTimers()는 사용하지 않고 classifyPriceAge의 `now` 파라미터로 시간을 제어한다.

테스트 케이스:
- classifyPriceAge(now - 1min, now) → 'FRESH'
- classifyPriceAge(now - 4min59s, now) → 'FRESH'
- classifyPriceAge(now - 5min, now) → 'AGING' (경계값)
- classifyPriceAge(now - 15min, now) → 'AGING'
- classifyPriceAge(now - 29min59s, now) → 'AGING'
- classifyPriceAge(now - 30min, now) → 'STALE' (경계값)
- classifyPriceAge(now - 60min, now) → 'STALE'
- classifyPriceAge(now, now) → 'FRESH' (age=0)
- PriceAgeEnum.parse('FRESH') succeeds, PriceAgeEnum.parse('INVALID') throws

테스트 실행 → 모든 테스트 FAIL 확인 (import 실패). 커밋: `test(125-02): add failing price-age tests`

**GREEN phase: core 타입 + classifyPriceAge 구현**

1. `packages/core/src/interfaces/price-oracle.types.ts` 생성:
   - Research에서 제시한 코드를 기반으로 TokenRefSchema, PriceInfoSchema, CacheStats, IPriceOracle 정의
   - source enum은 반드시 `z.enum(['pyth', 'coingecko', 'cache'])` 3가지만 (v1.5 결정)
   - ChainTypeEnum은 `import { ChainTypeEnum } from '../enums/chain.js'`로 가져옴
   - TokenRefSchema: { address: string(min 1), symbol?: string, decimals: int(0-18), chain: ChainTypeEnum }
   - PriceInfoSchema: { usdPrice: number(>=0), confidence?: number(0-1), source: 'pyth'|'coingecko'|'cache', fetchedAt: int(>0), expiresAt: int(>0), isStale: boolean(default false) }
   - CacheStats interface: { hits, misses, staleHits, size, evictions } (all numbers)
   - IPriceOracle interface: getPrice(token: TokenRef) => Promise<PriceInfo>, getPrices(tokens: TokenRef[]) => Promise<Map<string, PriceInfo>>, getNativePrice(chain: ChainType) => Promise<PriceInfo>, getCacheStats() => CacheStats

2. `packages/core/src/interfaces/index.ts` 수정:
   - `export type { TokenRef, PriceInfo, CacheStats, IPriceOracle } from './price-oracle.types.js'`
   - `export { TokenRefSchema, PriceInfoSchema } from './price-oracle.types.js'` (Zod 스키마는 value export)

3. `packages/core/src/index.ts` 수정:
   - interfaces re-export 블록에 TokenRefSchema, PriceInfoSchema, TokenRef, PriceInfo, CacheStats, IPriceOracle 추가

4. `packages/daemon/src/infrastructure/oracle/price-age.ts` 생성:
   - Research에서 제시한 classifyPriceAge 코드 구현
   - PRICE_AGES, PriceAge type, PriceAgeEnum, PRICE_AGE_THRESHOLDS 상수 export
   - FRESH_MAX_MS = 5 * 60 * 1000 (= 300,000ms)
   - AGING_MAX_MS = 30 * 60 * 1000 (= 1,800,000ms)
   - classifyPriceAge(fetchedAt, now?) → PriceAge: FRESH(< 5min), AGING(5~30min), STALE(>= 30min)
   - now 미지정 시 Date.now() 사용 (테스트에서 주입 가능)

5. `packages/daemon/src/infrastructure/oracle/index.ts` 생성:
   ```typescript
   export { classifyPriceAge, PriceAgeEnum, PRICE_AGE_THRESHOLDS, PRICE_AGES, type PriceAge } from './price-age.js';
   ```
   (InMemoryPriceCache export는 Task 2에서 추가)

6. 테스트 실행 → price-age 테스트 모든 PASS 확인
   커밋: `feat(125-02): implement IPriceOracle types + classifyPriceAge`

**REFACTOR phase:** JSDoc 보완, 코드 정리. 테스트 재실행 → PASS 확인.
  </action>
  <verify>
```bash
cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/daemon/src/__tests__/price-age.test.ts --reporter=verbose
cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/core && npx tsc --noEmit
cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx tsc --noEmit
```
  </verify>
  <done>
- price-age.test.ts: 9개 테스트 PASS (경계값 3개 포함)
- core 패키지에서 TokenRefSchema, PriceInfoSchema, IPriceOracle을 import할 수 있다
- TokenRefSchema.parse({ address: 'test', decimals: 6, chain: 'solana' }) 성공
- PriceInfoSchema.parse({ usdPrice: 150.25, source: 'pyth', fetchedAt: Date.now(), expiresAt: Date.now() + 300000 }) 성공
- classifyPriceAge가 FRESH/AGING/STALE를 정확히 분류한다
- core/daemon 패키지 타입 에러 없음
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD — InMemoryPriceCache (LRU 128, 5min TTL, stampede 방지)</name>
  <files>
    packages/daemon/src/infrastructure/oracle/price-cache.ts
    packages/daemon/src/infrastructure/oracle/index.ts
    packages/daemon/src/__tests__/price-cache.test.ts
  </files>
  <action>
**RED phase: `packages/daemon/src/__tests__/price-cache.test.ts` 테스트 파일 생성**

`import { InMemoryPriceCache, buildCacheKey } from '../infrastructure/oracle/price-cache.js'`와 `import type { PriceInfo } from '@waiaas/core'`로 import한다. TTL/LRU/stampede 테스트를 위해 vi.useFakeTimers() 활용 (vi.advanceTimersByTime으로 시간 경과 시뮬레이션). 테스트용 PriceInfo 헬퍼 `makePriceInfo(overrides?)` 팩토리 함수를 테스트 파일 상단에 정의한다.

15개 테스트 케이스:
- set + get 기본 동작 (캐시 히트)
- TTL 만료 후 get → null (캐시 미스)
- TTL 만료 후 getStale → stale 데이터 반환
- staleMax 만료 후 getStale → null
- LRU 퇴거: 129번째 항목 set → 첫 번째 항목 제거됨
- LRU touch: get 접근 시 퇴거 순서 변경 (최근 접근 항목 보존)
- getOrFetch 캐시 히트 → fetcher 호출 안 됨
- getOrFetch 캐시 미스 → fetcher 호출되고 캐시에 저장
- getOrFetch 동시 호출 → fetcher 1회만 호출 (stampede 방지)
- getOrFetch fetcher 에러 → inflight 해제, 다음 호출에서 재시도
- getStats → hits/misses/staleHits/evictions 정확한 카운트
- buildCacheKey('ethereum', '0xA0b86991c...') → 'ethereum:0xa0b86991c...' (lowercase)
- buildCacheKey('solana', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v') → 'solana:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v' (그대로)
- clear → 캐시 비우고 stats 리셋

테스트 실행 → 모든 테스트 FAIL 확인 (import 실패). 커밋: `test(125-02): add failing price-cache tests`

**GREEN phase: InMemoryPriceCache 구현**

1. `packages/daemon/src/infrastructure/oracle/price-cache.ts` 생성:
   - Research에서 제시한 InMemoryPriceCache 코드를 기반으로 구현
   - constructor(ttlMs=300000, staleMaxMs=1800000, maxEntries=128)
   - CacheEntry 내부 인터페이스: { price: PriceInfo, cachedAt: number, expiresAt: number }
   - get(key): Map에서 키 조회 → 존재하면 TTL 체크 → 유효하면 LRU touch(delete+set) + stats.hits++ → 만료이면 null + stats.misses++
   - getStale(key): TTL 만료 && staleMax 이내이면 데이터 반환 + stats.staleHits++, 초과이면 null
   - set(key, price): maxEntries 초과 시 Map.keys().next().value로 oldest 제거 + stats.evictions++
   - getOrFetch(key, fetcher): 캐시 히트 → 반환, inflight 있으면 대기, 없으면 새 fetch 시작 → finally에서 inflight 삭제
   - buildCacheKey(chain, address): chain === 'ethereum' ? `${chain}:${address.toLowerCase()}` : `${chain}:${address}`
   - getStats() → CacheStats
   - clear() → 캐시 비우고 stats 리셋
   - 시간 비교는 Date.now()를 내부에서 호출 (테스트에서 vi.useFakeTimers()로 제어)

2. `packages/daemon/src/infrastructure/oracle/index.ts` 수정:
   - `export { InMemoryPriceCache, buildCacheKey } from './price-cache.js';` 추가

3. 테스트 실행 → price-cache 테스트 모든 PASS 확인
   커밋: `feat(125-02): implement InMemoryPriceCache`

**REFACTOR phase:** JSDoc 보완, 코드 정리. 테스트 재실행 → PASS 확인.
  </action>
  <verify>
```bash
cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/daemon/src/__tests__/price-cache.test.ts --reporter=verbose
cd /Users/minho.yoo/dev/wallet/WAIaaS/packages/daemon && npx tsc --noEmit
```

전체 daemon 테스트 회귀 확인:
```bash
cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/daemon --reporter=verbose
```
  </verify>
  <done>
- price-cache.test.ts: 15개 테스트 PASS (LRU, TTL, stampede 포함)
- InMemoryPriceCache가 5분 TTL로 캐시 항목을 만료시킨다
- InMemoryPriceCache가 128항목 LRU 상한을 초과하면 가장 오래된 항목을 퇴거한다
- getOrFetch가 동일 키에 대한 동시 요청을 하나의 fetch로 합쳐 cache stampede를 방지한다
- daemon 패키지에서 InMemoryPriceCache, buildCacheKey를 import할 수 있다
- 외부 npm 의존성 추가 없음 (v1.5 결정 준수)
- daemon 패키지 타입 에러 없음, 기존 테스트 회귀 없음
  </done>
</task>

</tasks>

<verification>
1. `cd packages/daemon && npx vitest run src/__tests__/price-age.test.ts` — 모든 테스트 PASS
2. `cd packages/daemon && npx vitest run src/__tests__/price-cache.test.ts` — 모든 테스트 PASS
3. `cd packages/core && npx tsc --noEmit` — 타입 에러 없음
4. `cd packages/daemon && npx tsc --noEmit` — 타입 에러 없음
5. TokenRefSchema.parse({ address: 'test', decimals: 6, chain: 'solana' }) — 성공
6. PriceInfoSchema.parse({ usdPrice: 150.25, source: 'pyth', fetchedAt: Date.now(), expiresAt: Date.now() + 300000 }) — 성공
</verification>

<success_criteria>
- price-age.test.ts: 9+ 테스트 PASS (경계값 3개 포함)
- price-cache.test.ts: 15+ 테스트 PASS (LRU, TTL, stampede 포함)
- core 패키지에서 TokenRefSchema, PriceInfoSchema, IPriceOracle을 import할 수 있다
- daemon 패키지에서 InMemoryPriceCache, classifyPriceAge를 import할 수 있다
- 외부 npm 의존성 추가 없음 (v1.5 결정 준수)
</success_criteria>

<output>
After completion, create `.planning/phases/125-design-docs-oracle-interfaces/125-02-SUMMARY.md`
</output>
