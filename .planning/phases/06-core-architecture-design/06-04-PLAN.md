---
phase: 06-core-architecture-design
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - .planning/deliverables/28-daemon-lifecycle-cli.md
autonomous: true

must_haves:
  truths:
    - "데몬 라이프사이클이 시퀀스 다이어그램으로 문서화됨 (시작, 키스토어 잠금 해제, 서비스 초기화, 서빙, 신호 처리, 우아한 종료)"
    - "Graceful Shutdown이 10단계 캐스케이드로 정의됨 (06-RESEARCH.md 결정 반영)"
    - "CLI 커맨드 4개(init, start, stop, status)가 옵션/출력/에러까지 정의됨"
    - "waiaas init 대화형 플로우가 step-by-step으로 정의됨"
    - "npm 글로벌 패키지 설치 구조(bin 필드, shebang)가 정의됨"
    - "PID 파일 기반 프로세스 관리가 경쟁 조건 방지까지 설계됨"
  artifacts:
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "데몬 라이프사이클 + CLI 커맨드 전체 설계"
      contains: "gracefulShutdown"
  key_links:
    - from: "28-daemon-lifecycle-cli.md"
      to: "26-keystore-spec.md"
      via: "데몬 시작 시 ILocalKeyStore.unlock() 호출"
      pattern: "unlock"
    - from: "28-daemon-lifecycle-cli.md"
      to: "27-chain-adapter-interface.md"
      via: "데몬 시작 시 AdapterRegistry 초기화"
      pattern: "AdapterRegistry"
    - from: "28-daemon-lifecycle-cli.md"
      to: "24-monorepo-data-directory.md"
      via: "packages/cli 패키지 구조, ~/.waiaas/ 경로"
      pattern: "packages/cli"
---

<objective>
데몬 라이프사이클(시작부터 종료까지 전체 시퀀스)과 CLI 커맨드(init/start/stop/status) 상세 설계를 작성한다. 키스토어 잠금 해제, 서비스 초기화, 신호 처리, Graceful Shutdown을 시퀀스 다이어그램으로 문서화한다.

Purpose: 데몬 라이프사이클은 키스토어(06-02), ChainAdapter(06-03), API 서버(06-05)를 하나의 프로세스로 통합하는 골격. 초기화/종료 순서가 잘못되면 키 자료 유출이나 거래 손실 위험.
Output: 설계 문서 1개 -- 28-daemon-lifecycle-cli.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-core-architecture-design/06-CONTEXT.md
@.planning/phases/06-core-architecture-design/06-RESEARCH.md

# 선행 플랜 SUMMARY (키스토어, ChainAdapter, 패키지 구조 참조)
@.planning/phases/06-core-architecture-design/06-01-SUMMARY.md
@.planning/phases/06-core-architecture-design/06-02-SUMMARY.md
@.planning/phases/06-core-architecture-design/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 데몬 라이프사이클 설계</name>
  <files>.planning/deliverables/28-daemon-lifecycle-cli.md</files>
  <action>
  설계 문서 `28-daemon-lifecycle-cli.md`를 작성한다. 문서 ID는 `CORE-05`.

  **섹션 1: 데몬 아키텍처 개요**
  - 단일 Node.js 프로세스 (foreground 기본, --daemon으로 background)
  - 주요 서비스 컴포넌트:
    1. ConfigLoader (config.toml + 환경변수)
    2. DatabaseManager (Drizzle + better-sqlite3 + 마이그레이션)
    3. LocalKeyStore (sodium-native guarded memory)
    4. AdapterRegistry (Solana/EVM 어댑터)
    5. HonoServer (HTTP API + 미들웨어)
    6. BackgroundWorkers (WAL checkpoint, 세션 만료 정리 등)
  - 서비스 간 의존 관계 다이어그램

  **섹션 2: 시작 시퀀스 (Startup Sequence)**
  Mermaid 시퀀스 다이어그램으로 전체 시작 과정 문서화:

  1. 환경 검증
     - Node.js 버전 체크 (>=22)
     - 데이터 디렉토리 존재 확인 (`~/.waiaas/` 또는 `$WAIAAS_DATA_DIR`)
     - config.toml 로드 (smol-toml)
     - PID 파일 확인 (이미 실행 중인 데몬 감지)

  2. 데이터베이스 초기화
     - better-sqlite3 연결
     - PRAGMA 설정 (WAL, foreign_keys 등 -- 25-sqlite-schema.md 참조)
     - `migrate()` 자동 마이그레이션 실행
     - 성공 로그

  3. 키스토어 잠금 해제
     - 마스터 패스워드 획득 (환경변수 > 파일 > 대화형 -- 26-keystore-spec.md)
     - `ILocalKeyStore.unlock(password)` 호출
     - Argon2id 키 파생 (~1-3초)
     - 모든 에이전트 키를 sodium_malloc 버퍼로 복호화
     - sodium_mprotect_readonly 설정
     - 패스워드 문자열 제로화

  4. 어댑터 초기화
     - config.toml [rpc] 섹션에서 RPC URL 로드
     - AdapterRegistry에 Solana/EVM 어댑터 등록
     - 각 어댑터 connect + 헬스 체크
     - 연결 실패 시 경고 (에이전트가 해당 체인을 사용하지 않으면 무시)

  5. HTTP 서버 시작
     - Hono app 초기화 + 미들웨어 등록
     - `serve({ hostname: '127.0.0.1', port })` -- 06-05에서 상세화
     - 서버 리스닝 시작

  6. 백그라운드 워커 시작
     - WAL 체크포인트 워커 (5분 주기)
     - 만료 세션 정리 워커 (1분 주기)
     - 데몬 상태 로깅 워커 (선택적)

  7. PID 파일 기록 + Ready 로그
     - `~/.waiaas/daemon.pid`에 PID 기록
     - "WAIaaS daemon ready on 127.0.0.1:3000" 출력

  - 각 단계의 실패 시 동작 정의 (fail-fast vs 경고 후 계속)
  - 시작 시간 추정 (Argon2id ~1-3s가 지배적)

  **섹션 3: 종료 시퀀스 (Shutdown Sequence)**
  06-RESEARCH.md "Graceful Shutdown 전략" 기반, 10단계 캐스케이드:

  Mermaid 시퀀스 다이어그램으로 문서화:

  1. 시그널 수신 (SIGINT/SIGTERM) + isShuttingDown 플래그
  2. 새 연결 수락 중지 (`server.close()`)
  3. 응답에 `Connection: close` 헤더 설정
  4. In-flight HTTP 요청 완료 대기 (최대 30초)
  5. 진행 중 서명 작업 완료 (CRITICAL -- 06-RESEARCH.md 참조)
  6. Pending queue 상태 SQLite에 저장
  7. 백그라운드 워커 중지
  8. WAL checkpoint (`PRAGMA wal_checkpoint(TRUNCATE)`)
  9. 키스토어 잠금 (`ILocalKeyStore.lock()` -> sodium_memzero -> sodium_mprotect_noaccess)
  10. SQLite 연결 닫기 + PID 파일 삭제 + process.exit(0)

  - 30초 강제 종료 타임아웃 (setTimeout -> process.exit(1))
  - 06-RESEARCH.md Pitfall 6 (Hono server.close 미종료) 대응: 소켓 추적 + destroySoon
  - Windows 호환성 노트 (SIGTERM 미지원)
  - Docker PID 1 문제: --init 플래그 또는 tini 사용

  **섹션 4: 신호 처리 (Signal Handling)**
  | Signal | Action |
  |--------|--------|
  | SIGINT | Graceful Shutdown |
  | SIGTERM | Graceful Shutdown |
  | SIGHUP | Config 재로드 (hot reload) |
  | SIGUSR1 | 상태 덤프 (로그에 현재 상태 출력) |

  - 다중 시그널 방지 (isShuttingDown guard)
  - uncaughtException / unhandledRejection 핸들링 (로그 후 강제 종료)

  **섹션 5: 프로세스 관리 (PID 파일)**
  - PID 파일 경로: `~/.waiaas/daemon.pid`
  - 기록 시점: 서버 리스닝 시작 후
  - 삭제 시점: Graceful Shutdown 마지막 단계
  - 경쟁 조건 방지: 파일 잠금 (fs.open O_EXCL) 또는 stale PID 감지 (process.kill(pid, 0))
  - background 모드 전환: `--daemon` 플래그 시 child_process.fork + detach
  </action>
  <verify>
  문서에 다음이 모두 포함되어 있는지 확인:
  - 서비스 컴포넌트 의존 관계 다이어그램
  - Startup Sequence Mermaid 시퀀스 다이어그램 (7단계)
  - Shutdown Sequence Mermaid 시퀀스 다이어그램 (10단계)
  - 각 단계 실패 시 동작 정의
  - Signal 처리 테이블 (4개 시그널)
  - PID 파일 관리 + 경쟁 조건 방지
  </verify>
  <done>
  데몬 라이프사이클이 시작 7단계 + 종료 10단계 시퀀스 다이어그램으로 문서화됨. 신호 처리, PID 관리, 강제 종료 타임아웃이 포함됨. 요구사항 CLI-02 완전 커버.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI 커맨드 설계 (init/start/stop/status)</name>
  <files>.planning/deliverables/28-daemon-lifecycle-cli.md</files>
  <action>
  기존 `28-daemon-lifecycle-cli.md`에 섹션 6, 7, 8을 추가한다.

  **섹션 6: CLI 커맨드 상세 설계**
  각 커맨드별:
  - Usage 문법
  - 옵션/플래그 (--port, --daemon, --data-dir 등)
  - 실행 시 출력 예시
  - 에러 시 출력 예시
  - Exit code 정의 (0=성공, 1=에러, 2=이미 실행 중 등)

  **`waiaas init`** (CLI-01):
  - 대화형 초기 설정 플로우:
    1. "마스터 비밀번호 설정" (입력 + 확인, 최소 12자)
    2. "첫 번째 에이전트 생성?" (y/n)
       - 이름, 체인 선택 (solana/ethereum), 네트워크 선택
    3. "알림 채널 설정?" (Phase 8에서 상세, 스킵 가능)
    4. "Owner 지갑 주소 등록?" (Phase 8에서 상세, 스킵 가능)
  - 수행하는 작업:
    - ~/.waiaas/ 디렉토리 생성 (chmod 700)
    - config.toml 기본 파일 생성
    - SQLite DB 초기화 + 마이그레이션
    - 키스토어 초기화 (마스터 패스워드로 암호화 설정)
    - 에이전트 생성 (선택 시)
  - 비대화형 모드: `waiaas init --non-interactive --password-env WAIAAS_MASTER_PASSWORD`
  - 이미 초기화된 경우 에러 ("Already initialized. Use --force to reinitialize")

  **`waiaas start`** (CLI-02):
  - 기본: foreground 실행
  - `--daemon` / `-d`: background 실행 (fork + detach)
  - `--port <number>`: 포트 오버라이드 (기본 3000)
  - `--data-dir <path>`: 데이터 디렉토리 오버라이드
  - `--log-level <level>`: debug/info/warn/error (기본 info)
  - 출력: "WAIaaS daemon v0.2.0 started on 127.0.0.1:3000 (PID: 12345)"
  - 에러: "Data directory not initialized. Run 'waiaas init' first."

  **`waiaas stop`** (CLI-02):
  - PID 파일에서 PID 읽기
  - `process.kill(pid, 'SIGTERM')` 전송
  - 종료 대기 (polling, 최대 35초)
  - 출력: "WAIaaS daemon (PID: 12345) stopped gracefully"
  - 에러: "No running daemon found", "Daemon did not stop within timeout, sending SIGKILL"

  **`waiaas status`** (CLI-03):
  - 데몬 미실행 시: "WAIaaS daemon is not running"
  - 데몬 실행 중: HTTP API 호출로 상태 조회 (GET /v1/health)
  - 출력 예시:
    ```
    WAIaaS Daemon v0.2.0
    Status:     Running (PID: 12345)
    Uptime:     2h 34m
    Address:    127.0.0.1:3000
    Agents:     3 active, 1 suspended
    Sessions:   2 active
    Last TX:    2 minutes ago
    DB Size:    4.2 MB
    ```

  **섹션 7: npm 글로벌 패키지 구조 (CLI-04)**
  - packages/cli/package.json:
    ```json
    {
      "name": "@waiaas/cli",
      "bin": { "waiaas": "./bin/waiaas.js" },
      "files": ["bin/", "dist/"],
      "dependencies": { "@waiaas/daemon": "workspace:*" }
    }
    ```
  - bin/waiaas.js shebang: `#!/usr/bin/env node`
  - 설치: `npm install -g @waiaas/cli` 또는 `npx @waiaas/cli init`
  - 버전 관리: 모노레포 내 workspace 연동
  - CLI 파싱 라이브러리: Node.js 내장 `parseArgs` (util.parseArgs, Node 18.3+)
    - 외부 의존성 없이 CLI 파싱 (commander/yargs 불필요)
    - 주의: subcommand 패턴은 수동 구현 필요

  **섹션 8: 에이전트 관리 보조 커맨드 (미래 확장)**
  Phase 6에서는 구조만 정의, Phase 7-8에서 상세화:
  - `waiaas agent create <name> --chain <chain>` -- 에이전트 생성
  - `waiaas agent list` -- 에이전트 목록
  - `waiaas agent export <id>` -- 키파일 내보내기
  - `waiaas agent import <path>` -- 키파일 가져오기
  - `waiaas backup create` -- 전체 백업
  - `waiaas backup restore <path>` -- 복원
  - 커맨드 구조만 표로 정리, 상세 옵션은 향후 설계
  </action>
  <verify>
  문서에 다음이 모두 포함되어 있는지 확인:
  - init/start/stop/status 4개 커맨드의 전체 옵션 테이블
  - waiaas init 대화형 플로우 (4단계) + 비대화형 모드
  - 각 커맨드의 출력 예시 + 에러 예시
  - Exit code 정의
  - npm 글로벌 패키지 구조 (package.json, bin 필드)
  - 보조 커맨드 구조 표
  </verify>
  <done>
  CLI 4개 커맨드가 옵션/출력/에러/exit code까지 정의됨. npm 글로벌 패키지 구조가 bin 필드까지 설계됨. waiaas init 대화형 플로우가 step-by-step으로 정의됨. 요구사항 CLI-01, CLI-02, CLI-03, CLI-04 모두 커버.
  </done>
</task>

</tasks>

<verification>
- 28-daemon-lifecycle-cli.md가 8개 섹션을 모두 포함함
- Startup/Shutdown 시퀀스 다이어그램이 Mermaid로 작성됨
- 06-02의 ILocalKeyStore, 06-03의 AdapterRegistry와 정확히 연결됨
- Graceful Shutdown이 06-RESEARCH.md의 10단계와 일치
- CLI 4개 커맨드가 REQUIREMENTS.md의 CLI-01~04와 1:1 매핑
</verification>

<success_criteria>
1. 데몬 라이프사이클이 시작 7단계 + 종료 10단계 시퀀스 다이어그램으로 문서화됨
2. 신호 처리가 4개 시그널별 동작으로 정의됨
3. CLI 4개 커맨드가 옵션/출력/에러/exit code까지 정의됨
4. waiaas init 대화형 플로우가 step-by-step으로 정의됨
5. npm 글로벌 패키지 구조가 package.json + bin 수준으로 설계됨
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-architecture-design/06-04-SUMMARY.md`
</output>
