---
phase: 06-core-architecture-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/24-monorepo-data-directory.md
  - .planning/deliverables/25-sqlite-schema.md
autonomous: true

must_haves:
  truths:
    - "모노레포 패키지 구조가 packages/, 빌드 의존성, workspace 설정까지 확정됨"
    - "~/.waiaas/ 데이터 디렉토리 레이아웃이 모든 하위 경로와 파일 용도까지 정의됨"
    - "TOML 설정 파일의 전체 키-값 구조가 예시와 함께 정의됨"
    - "SQLite 스키마가 Drizzle ORM 코드 수준으로 정의됨 (agents, sessions, transactions, policies, audit_log 테이블)"
    - "모든 테이블에 인덱스, 외래키, 제약조건이 명시됨"
    - "마이그레이션 전략(drizzle-kit generate + migrate())이 절차와 함께 문서화됨"
  artifacts:
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "모노레포 패키지 구조 + 데이터 디렉토리 레이아웃 + TOML 설정 스펙"
      contains: "pnpm-workspace.yaml"
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "SQLite 전체 스키마 DDL + Drizzle ORM 정의 + 마이그레이션 전략"
      contains: "sqliteTable"
  key_links:
    - from: "24-monorepo-data-directory.md"
      to: "25-sqlite-schema.md"
      via: "데이터 디렉토리에서 DB 파일 경로 참조"
      pattern: "waiaas\\.db"
---

<objective>
모노레포 패키지 구조, ~/.waiaas/ 데이터 디렉토리 레이아웃, TOML 설정 파일 스펙, SQLite 전체 스키마를 설계한다. Phase 6의 나머지 4개 플랜이 참조할 기반 구조를 확정한다.

Purpose: 모든 후속 설계(키스토어, ChainAdapter, 데몬, API)가 이 구조 위에 배치되므로, 패키지 경계와 데이터 모델을 먼저 확정해야 한다.
Output: 설계 문서 2개 -- 24-monorepo-data-directory.md, 25-sqlite-schema.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-architecture-design/06-CONTEXT.md
@.planning/phases/06-core-architecture-design/06-RESEARCH.md

# v0.1 참조 문서
@.planning/deliverables/09-system-components.md (ARCH-02: 모노레포 구조 원본 -- v0.2에서 Self-Hosted로 리팩터링)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 모노레포 패키지 구조 + 데이터 디렉토리 + TOML 설정 설계</name>
  <files>.planning/deliverables/24-monorepo-data-directory.md</files>
  <action>
  설계 문서 `24-monorepo-data-directory.md`를 작성한다. 문서 ID는 `CORE-01`.

  **섹션 1: 모노레포 패키지 구조**
  - 06-RESEARCH.md의 "Recommended Project Structure" 기반으로 전체 디렉토리 트리 작성
  - 각 패키지(core, daemon, adapters/solana, adapters/evm, cli, sdk, mcp)의 역할, 의존 관계, 진입점(entry point), exports 정의
  - pnpm-workspace.yaml 전체 내용
  - turbo.json 전체 내용 (build, test, lint task 의존성)
  - 루트 package.json의 scripts, workspace 설정
  - 각 패키지 package.json의 name, main, exports, dependencies 관계
  - 빌드 순서: core -> adapters -> daemon -> cli (의존성 그래프로 시각화)

  **섹션 2: ~/.waiaas/ 데이터 디렉토리 레이아웃**
  - 전체 디렉토리 트리:
    ```
    ~/.waiaas/
      config.toml          # 데몬 설정
      daemon.pid           # PID 파일 (background 모드)
      data/
        waiaas.db           # SQLite 메인 DB
        waiaas.db-wal       # WAL 파일
        waiaas.db-shm       # 공유 메모리
      keystore/
        <agent-id>.json     # 에이전트별 암호화 키파일
      logs/
        daemon.log          # 데몬 로그 (stdout/file)
      backups/              # 키스토어 백업
      drizzle/              # 마이그레이션 파일
    ```
  - 각 파일/디렉토리의 용도, 생성 시점, 접근 권한(chmod), 소유자
  - 환경변수 `WAIAAS_DATA_DIR`로 데이터 디렉토리 변경 가능 (06-CONTEXT.md 결정)
  - 기본 경로 해석 로직: `$WAIAAS_DATA_DIR || $XDG_DATA_HOME/waiaas || ~/.waiaas`

  **섹션 3: TOML 설정 파일 스펙 (config.toml)**
  - smol-toml 사용 (06-RESEARCH.md 결정)
  - 전체 키-값 구조를 테이블로 정의:
    - [daemon]: port, hostname(127.0.0.1 고정), log_level, pid_file
    - [keystore]: argon2_memory(65536), argon2_time(3), argon2_parallelism(4)
    - [rpc]: 체인별 RPC 엔드포인트 (solana.mainnet, solana.devnet, evm.ethereum 등)
    - [notifications]: 채널 설정 (Phase 8에서 상세화, 여기서는 구조만)
    - [security]: session_ttl, max_pending_tx 등 (Phase 7-8에서 상세화)
  - 각 키의 타입, 기본값, 유효 범위, 설명
  - 전체 기본 config.toml 예시 (주석 포함)
  - 설정 로드 순서: 기본값 -> config.toml -> 환경변수 오버라이드
  - 환경변수 매핑 규칙: `WAIAAS_DAEMON_PORT=3001` -> `[daemon].port = 3001`

  **참조할 v0.1 설계:** 09-system-components.md의 패키지 구조를 Self-Hosted 버전으로 리팩터링. AWS 의존성 제거, SQLite/파일 기반으로 전환.

  **주의:** Phase 9의 sdk, mcp 패키지는 디렉토리만 정의하고 내부 구조는 Phase 9에서 설계. Phase 7-8의 설정 키는 섹션/구조만 잡아두고 상세값은 해당 Phase에서 확정.
  </action>
  <verify>
  문서에 다음이 모두 포함되어 있는지 확인:
  - 모노레포 디렉토리 트리 (packages/ 하위 7개 패키지)
  - pnpm-workspace.yaml 전체 내용
  - turbo.json 전체 내용
  - 패키지 간 의존 관계 다이어그램
  - ~/.waiaas/ 디렉토리 트리 (모든 파일/디렉토리 용도 설명)
  - config.toml 전체 키-값 정의 테이블
  - config.toml 전체 예시 (주석 포함)
  - 환경변수 오버라이드 규칙
  </verify>
  <done>
  모노레포 패키지 구조가 7개 패키지의 역할/의존관계/exports까지 확정됨. 데이터 디렉토리가 모든 하위 경로와 파일 용도까지 정의됨. TOML 설정이 키-값 수준으로 정의됨.
  </done>
</task>

<task type="auto">
  <name>Task 2: SQLite 전체 스키마 설계</name>
  <files>.planning/deliverables/25-sqlite-schema.md</files>
  <action>
  설계 문서 `25-sqlite-schema.md`를 작성한다. 문서 ID는 `CORE-02`.

  **섹션 1: 스키마 개요**
  - Drizzle ORM + better-sqlite3 기반 (06-RESEARCH.md 확정)
  - WAL 모드, 필수 PRAGMA 설정 (journal_mode, synchronous, foreign_keys, busy_timeout, cache_size, mmap_size)
  - 각 PRAGMA의 값과 근거

  **섹션 2: 테이블 정의 (Drizzle ORM TypeScript 코드)**
  다음 테이블을 Drizzle ORM `sqliteTable()` 코드로 정의:

  1. `agents` - 에이전트 정보 (id, name, chain, network, publicKey, status, ownerAddress, createdAt, updatedAt, suspendedAt, suspensionReason)
     - status enum: CREATING, ACTIVE, SUSPENDED, TERMINATING, TERMINATED
     - Unique: publicKey
     - 관계: KEYS-01, KEYS-03 요구사항

  2. `sessions` - 세션 정보 (id, agentId, tokenHash, expiresAt, constraints JSON, usageStats JSON, revokedAt, createdAt)
     - FK: agentId -> agents.id
     - Index: agentId, expiresAt
     - Phase 7에서 상세화, 여기서는 기본 구조

  3. `transactions` - 거래 기록 (id, agentId, sessionId, chain, txHash, type, amount, to, status, tier, queuedAt, executedAt, error, metadata JSON)
     - status enum: PENDING, QUEUED, EXECUTING, SUBMITTED, CONFIRMED, FAILED, CANCELLED, EXPIRED
     - tier enum: INSTANT, NOTIFY, DELAY, APPROVAL
     - FK: agentId, sessionId
     - Index: agentId+status, sessionId, txHash, queuedAt

  4. `policies` - 정책 규칙 (id, agentId, type, rules JSON, priority, enabled, createdAt, updatedAt)
     - type: SPENDING_LIMIT, ALLOWED_ADDRESSES, TIME_RESTRICTION, AUTO_STOP
     - FK: agentId (nullable - null이면 글로벌)
     - Phase 8에서 상세화

  5. `audit_log` - 감사 로그 (id AUTOINCREMENT, timestamp, eventType, actor, agentId, sessionId, txId, details JSON, severity, ipAddress)
     - severity enum: info, warning, critical
     - Index: timestamp, eventType, agentId, severity
     - Append-only (DELETE 금지 정책 문서화)

  6. `pending_approvals` - 승인 대기 거래 (id, txId, requiredBy, expiresAt, approvedAt, rejectedAt, ownerSignature)
     - FK: txId -> transactions.id
     - Phase 8에서 상세화

  7. `notification_channels` - 알림 채널 (id, type, config JSON, priority, enabled, lastSuccessAt, lastFailureAt)
     - type: TELEGRAM, DISCORD, NTFY
     - Phase 8에서 상세화

  **각 테이블에 포함할 것:**
  - Drizzle ORM TypeScript 코드 (sqliteTable, text, integer, blob 사용)
  - 해당하는 CREATE TABLE SQL DDL (Drizzle가 생성할 결과)
  - 인덱스 정의 (sqliteTable 두 번째 인자 또는 별도)
  - 컬럼별 설명 (타입, nullable, 기본값, 용도)
  - 요구사항 매핑 (이 테이블이 어떤 KEYS/CLI/API 요구사항을 지원하는지)

  **섹션 3: 관계 다이어그램 (ERD)**
  - Mermaid erDiagram으로 테이블 간 관계 시각화
  - FK 관계, 1:N / N:M 표시

  **섹션 4: 마이그레이션 전략**
  - drizzle-kit generate + migrate() 워크플로우 (06-RESEARCH.md 기반)
  - drizzle.config.ts 전체 내용
  - 데몬 시작 시 자동 마이그레이션 코드 패턴
  - 마이그레이션 파일 저장 경로: packages/daemon/drizzle/
  - SQLite 제약사항 문서화 (ALTER TABLE 제한, Drop NOT NULL 불가 등)

  **섹션 5: SQLite 운영 가이드**
  - WAL 체크포인트 전략 (5분 주기 PRAGMA wal_checkpoint(TRUNCATE))
  - 백업 전략 (VACUUM INTO 또는 .backup)
  - 크기 추정 (에이전트 10개, 일 1000 tx 기준)
  - 성능 고려사항 (인덱스, 쿼리 패턴)

  **주의:** sessions, policies, pending_approvals, notification_channels 테이블은 기본 구조만 정의하고 "Phase 7/8에서 상세화"로 표시. 지금 확정하는 것은 agents, transactions, audit_log.
  </action>
  <verify>
  문서에 다음이 모두 포함되어 있는지 확인:
  - 7개 테이블의 Drizzle ORM TypeScript 코드
  - 7개 테이블의 CREATE TABLE SQL DDL
  - 모든 인덱스 정의
  - Mermaid ERD 다이어그램
  - drizzle.config.ts 전체 내용
  - 자동 마이그레이션 코드 패턴
  - PRAGMA 설정 목록과 근거
  - WAL 운영 가이드
  </verify>
  <done>
  SQLite 스키마가 7개 테이블, 인덱스, FK, ERD까지 Drizzle ORM 코드 수준으로 정의됨. 마이그레이션 전략이 drizzle-kit generate + migrate() 절차로 문서화됨. 요구사항 KEYS-01, KEYS-03, CLI-01 지원 확인.
  </done>
</task>

</tasks>

<verification>
- 24-monorepo-data-directory.md에 패키지 구조, 데이터 디렉토리, TOML 설정이 모두 포함됨
- 25-sqlite-schema.md에 전체 스키마가 구현 가능한 수준으로 정의됨
- 두 문서 간 데이터 디렉토리 경로(waiaas.db 위치)가 일관성 있음
- 요구사항 커버리지: CLI-04(npm 글로벌), KEYS-01(키스토어 경로), KEYS-03(agents 테이블)
</verification>

<success_criteria>
1. 모노레포 7개 패키지의 역할, 의존관계, exports가 확정됨
2. ~/.waiaas/ 하위 모든 경로와 파일 용도가 정의됨
3. config.toml 키-값 구조가 타입/기본값/범위까지 정의됨
4. SQLite 7개 테이블이 Drizzle ORM 코드 + SQL DDL로 정의됨
5. 마이그레이션 전략이 절차와 코드 패턴까지 문서화됨
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-architecture-design/06-01-SUMMARY.md`
</output>
