---
phase: 06-core-architecture-design
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .planning/deliverables/27-chain-adapter-interface.md
autonomous: true

must_haves:
  truths:
    - "ChainAdapter 인터페이스가 TypeScript 타입 정의 수준으로 설계됨 (모든 메서드 시그니처, 파라미터 타입, 반환 타입, 에러 타입)"
    - "Solana 어댑터가 @solana/kit 3.x pipe API 기반으로 상세 설계됨 (buildTx, simulateTx, submitTx 각각의 내부 구현 전략)"
    - "EVM 어댑터가 viem 기반으로 상세 설계됨 (같은 인터페이스, 체인별 차이점 문서화)"
    - "체인별 공용 RPC 기본값과 사용자 오버라이드 구조가 정의됨"
    - "에러 타입이 체인 무관 공통 에러 + 체인 고유 에러로 분리 정의됨"
    - "어댑터 등록/검색 메커니즘(AdapterRegistry)이 설계됨"
  artifacts:
    - path: ".planning/deliverables/27-chain-adapter-interface.md"
      provides: "ChainAdapter 인터페이스 + Solana/EVM 어댑터 상세 명세"
      contains: "IChainAdapter"
  key_links:
    - from: "27-chain-adapter-interface.md"
      to: "25-sqlite-schema.md"
      via: "transactions 테이블의 chain 컬럼이 어댑터 선택에 사용됨"
      pattern: "chain.*solana|ethereum"
    - from: "27-chain-adapter-interface.md"
      to: "24-monorepo-data-directory.md"
      via: "packages/adapters/solana, packages/adapters/evm 패키지 구조"
      pattern: "adapters/"
---

<objective>
ChainAdapter 인터페이스를 TypeScript 타입 수준으로 설계하고, Solana와 EVM 어댑터의 상세 구현 명세를 작성한다. v0.1의 IBlockchainAdapter를 Self-Hosted + 체인 무관 모델로 리팩터링한다.

Purpose: 체인 추상화는 모든 거래 처리의 기반. 인터페이스가 불명확하면 Phase 7의 거래 파이프라인과 Phase 8의 EVM 어댑터 설계가 차질을 빚는다.
Output: 설계 문서 1개 -- 27-chain-adapter-interface.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-core-architecture-design/06-CONTEXT.md
@.planning/phases/06-core-architecture-design/06-RESEARCH.md

# 06-01 SUMMARY (패키지 구조 참조)
@.planning/phases/06-core-architecture-design/06-01-SUMMARY.md

# v0.1 참조 문서
@.planning/deliverables/12-multichain-extension.md (ARCH-05: IBlockchainAdapter 원본 -- Squads 메서드 제거 필요)
</context>

<tasks>

<task type="auto">
  <name>Task 1: ChainAdapter 인터페이스 + 공통 타입 설계</name>
  <files>.planning/deliverables/27-chain-adapter-interface.md</files>
  <action>
  설계 문서 `27-chain-adapter-interface.md`를 작성한다. 문서 ID는 `CORE-04`.

  **섹션 1: 인터페이스 설계 원칙**
  - v0.1 ARCH-05의 IBlockchainAdapter 기반, Squads 관련 메서드 제거
  - 명령형 인터페이스 (내부 구현은 체인별 라이브러리 패턴 사용)
  - 체인 무관 공통 타입 + 체인 고유 확장
  - 1 agent = 1 chain wallet (06-CONTEXT.md)

  **섹션 2: 공통 타입 정의 (packages/core/src/interfaces/)**
  TypeScript 타입/인터페이스 전체 정의:

  ```typescript
  // 체인 타입
  type ChainType = 'solana' | 'ethereum' | 'polygon' | 'arbitrum'
  type NetworkType = 'mainnet' | 'devnet' | 'testnet' | 'mainnet-beta'

  // 금액 (항상 최소 단위, bigint)
  interface TokenAmount {
    raw: bigint          // lamports, wei
    decimals: number     // 9 (SOL), 18 (ETH)
    symbol: string       // 'SOL', 'ETH'
  }

  // 트랜잭션 빌드 요청
  interface TransferRequest {
    from: string         // 발신 주소
    to: string           // 수신 주소
    amount: bigint       // 최소 단위
    memo?: string        // 메모 (Solana memo program, EVM data)
  }

  // 빌드된 트랜잭션 (서명 전)
  interface UnsignedTransaction {
    chain: ChainType
    serialized: Uint8Array   // 체인별 직렬화된 트랜잭션
    estimatedFee: bigint     // 예상 수수료
    expiresAt?: Date         // 유효 기한 (Solana blockhash lifetime ~60s)
    metadata: Record<string, unknown>  // 체인별 메타데이터
  }

  // 시뮬레이션 결과
  interface SimulationResult {
    success: boolean
    logs: string[]
    unitsConsumed?: bigint   // Solana compute units, EVM gas
    error?: string
  }

  // 제출 결과
  interface SubmitResult {
    txHash: string
    status: 'submitted' | 'confirmed' | 'finalized'
    confirmations?: number
    blockNumber?: bigint
    fee?: bigint
  }

  // 잔액 정보
  interface BalanceInfo {
    address: string
    balance: bigint
    decimals: number
    symbol: string
    usdValue?: number    // 선택적, 향후 가격 조회 통합
  }
  ```

  - 각 타입의 모든 필드에 JSDoc 수준 설명
  - 체인별 차이 (Solana는 expiresAt 필수, EVM은 nonce 필수 등)

  **섹션 3: IChainAdapter 인터페이스**
  ```typescript
  interface IChainAdapter {
    readonly chain: ChainType
    readonly network: NetworkType

    // 연결 관리
    connect(rpcUrl: string): Promise<void>
    disconnect(): Promise<void>
    isConnected(): boolean
    getHealth(): Promise<{ healthy: boolean; latency: number }>

    // 주소 검증
    isValidAddress(address: string): boolean

    // 잔액 조회
    getBalance(address: string): Promise<BalanceInfo>

    // 트랜잭션 빌드 -> 시뮬레이션 -> 서명 -> 제출 4단계
    buildTransaction(request: TransferRequest): Promise<UnsignedTransaction>
    simulateTransaction(tx: UnsignedTransaction): Promise<SimulationResult>
    signTransaction(tx: UnsignedTransaction, privateKey: Uint8Array): Promise<Uint8Array>
    submitTransaction(signedTx: Uint8Array): Promise<SubmitResult>

    // 트랜잭션 조회
    getTransactionStatus(txHash: string): Promise<SubmitResult>
    waitForConfirmation(txHash: string, timeout?: number): Promise<SubmitResult>

    // 수수료 추정
    estimateFee(request: TransferRequest): Promise<bigint>
  }
  ```
  - 각 메서드의 파라미터, 반환값, 에러 케이스를 상세 문서화
  - `signTransaction`이 `Uint8Array` privateKey를 받는 이유 (sodium guarded memory 호환)
  - 4단계 분리 이유 (정책 엔진이 simulate 후 approve/reject 가능)

  **섹션 4: 에러 타입 체계**
  ```typescript
  // 공통 에러 (체인 무관)
  enum ChainErrorCode {
    INSUFFICIENT_BALANCE = 'INSUFFICIENT_BALANCE',
    INVALID_ADDRESS = 'INVALID_ADDRESS',
    TRANSACTION_FAILED = 'TRANSACTION_FAILED',
    TRANSACTION_EXPIRED = 'TRANSACTION_EXPIRED',
    RPC_ERROR = 'RPC_ERROR',
    NETWORK_ERROR = 'NETWORK_ERROR',
    SIMULATION_FAILED = 'SIMULATION_FAILED',
  }

  // 체인 고유 에러
  enum SolanaErrorCode {
    BLOCKHASH_EXPIRED = 'SOLANA_BLOCKHASH_EXPIRED',
    PROGRAM_ERROR = 'SOLANA_PROGRAM_ERROR',
  }

  enum EVMErrorCode {
    NONCE_TOO_LOW = 'EVM_NONCE_TOO_LOW',
    GAS_TOO_LOW = 'EVM_GAS_TOO_LOW',
    REVERT = 'EVM_REVERT',
  }

  class ChainError extends Error {
    code: ChainErrorCode | SolanaErrorCode | EVMErrorCode
    chain: ChainType
    details?: Record<string, unknown>
  }
  ```
  - v0.1의 에러 코드 체계(20-error-codes.md)와 통합 방안

  **섹션 5: AdapterRegistry 설계**
  - 어댑터 등록/검색 메커니즘
  - `AdapterRegistry.register(chain, factory)` + `AdapterRegistry.get(chain, network)`
  - 빌트인 어댑터 자동 등록 (Solana, EVM)
  - 향후 플러그인 어댑터 인터페이스 (06-CONTEXT.md: 빌트인 + 추후 플러그인)
  - config.toml [rpc] 섹션과의 연동 (체인별 RPC URL 주입)
  </action>
  <verify>
  문서에 다음이 모두 포함되어 있는지 확인:
  - 공통 타입 7개 (ChainType, NetworkType, TokenAmount, TransferRequest, UnsignedTransaction, SimulationResult, SubmitResult, BalanceInfo)
  - IChainAdapter 인터페이스 (12개 메서드)
  - 각 메서드의 파라미터/반환/에러 상세 문서
  - 에러 코드 체계 (공통 + Solana + EVM)
  - AdapterRegistry 설계
  - v0.1 IBlockchainAdapter와의 차이 비교
  </verify>
  <done>
  ChainAdapter 인터페이스가 12개 메서드의 시그니처/에러까지 설계됨. 공통 타입 7개가 정의됨. AdapterRegistry가 설계됨. 요구사항 CHAIN-01 완전 커버.
  </done>
</task>

<task type="auto">
  <name>Task 2: Solana + EVM 어댑터 상세 구현 명세</name>
  <files>.planning/deliverables/27-chain-adapter-interface.md</files>
  <action>
  기존 `27-chain-adapter-interface.md`에 섹션 6, 7, 8을 추가한다.

  **섹션 6: Solana Adapter 상세 명세**
  - `SolanaAdapter implements IChainAdapter`
  - 내부 구현: @solana/kit 3.x pipe 기반 (06-RESEARCH.md Pattern 6 기반)
  - 각 메서드의 내부 구현 전략:

  `connect(rpcUrl)`:
  - `createSolanaRpc(rpcUrl)` + `createSolanaRpcSubscriptions(wssUrl)` 설정
  - RPC 헬스 체크 (`getHealth().send()`)
  - WSS URL 자동 추론 규칙 (https -> wss)

  `buildTransaction(request)`:
  - pipe 패턴으로 트랜잭션 메시지 구성
  - `getLatestBlockhash()` -> `setTransactionMessageLifetimeUsingBlockhash`
  - SOL 전송: `getTransferSolInstruction` from `@solana-program/system`
  - SPL 토큰 전송: 향후 확장 포인트 (v0.2에서는 SOL만)
  - `expiresAt` 계산: blockhash lastValidBlockHeight 기반 (~60초)

  `simulateTransaction(tx)`:
  - `simulateTransaction().send()` 호출
  - compute units 추출, 에러 로그 파싱

  `signTransaction(tx, privateKey)`:
  - sodium guarded memory에서 받은 privateKey(Uint8Array)로 Ed25519 서명
  - 서명 방법: `signBytes(privateKey, txMessage)` 또는 수동 Ed25519 서명
  - 주의: @solana/kit의 `signTransactionMessageWithSigners`는 Signer 객체 필요 -> adapter 내부에서 CryptoKeyPair 생성

  `submitTransaction(signedTx)`:
  - `sendAndConfirmTransactionFactory({ rpc, rpcSubscriptions })` 사용
  - commitment: 'confirmed' (기본), 'finalized' (옵션)
  - skipPreflight: 시뮬레이션 이미 완료했으므로 true

  `getBalance(address)`:
  - `getBalance(address(addr)).send()` -> lamports (bigint)
  - decimals: 9, symbol: 'SOL'

  - RPC 기본값 테이블:
    | Network | RPC URL | WSS URL |
    |---------|---------|---------|
    | mainnet-beta | https://api.mainnet-beta.solana.com | wss://api.mainnet-beta.solana.com |
    | devnet | https://api.devnet.solana.com | wss://api.devnet.solana.com |

  **섹션 7: EVM Adapter 상세 명세**
  - `EVMAdapter implements IChainAdapter`
  - 내부 구현: viem Client/Action 패턴 (06-RESEARCH.md 결정)
  - 각 메서드의 내부 구현 전략:

  `connect(rpcUrl)`:
  - `createPublicClient({ chain, transport: http(rpcUrl) })` 설정
  - `getBlockNumber()` 헬스 체크

  `buildTransaction(request)`:
  - `prepareTransactionRequest()` 호출
  - nonce 자동 관리 (nonce gap 방지 전략)
  - gas 추정: `estimateGas()` + 1.1x 안전 마진
  - EIP-1559 수수료: `maxFeePerGas`, `maxPriorityFeePerGas`

  `simulateTransaction(tx)`:
  - `simulateContract()` 또는 `call()` (단순 전송)

  `signTransaction(tx, privateKey)`:
  - viem `signTransaction()` with privateKey
  - secp256k1 서명 (r, s, v)

  `submitTransaction(signedTx)`:
  - `sendRawTransaction()` 호출
  - `waitForTransactionReceipt()` 대기

  `getBalance(address)`:
  - `getBalance({ address })` -> wei (bigint)
  - decimals: 18, symbol: 체인별 ('ETH', 'MATIC', etc.)

  - Nonce 관리 전략:
    - 로컬 nonce 트래커 (마지막 사용 nonce 기억)
    - 제출 실패 시 nonce 복구 전략
    - Graceful shutdown 시 미전송 tx의 nonce 처리 (06-RESEARCH.md Open Question 3)

  - 지원 체인 + RPC 기본값 테이블:
    | Chain | ChainId | RPC URL |
    |-------|---------|---------|
    | ethereum | 1 | https://cloudflare-eth.com |
    | polygon | 137 | https://polygon-rpc.com |
    | arbitrum | 42161 | https://arb1.arbitrum.io/rpc |

  **섹션 8: 체인 간 차이점 비교 매트릭스**
  - 수수료 모델: Solana (priority fee + base fee, lamports) vs EVM (EIP-1559, gas * gasPrice)
  - 트랜잭션 수명: Solana (blockhash ~60s) vs EVM (nonce 기반, 무제한)
  - 확정성: Solana (confirmed ~400ms, finalized ~6s) vs EVM (체인별 다름, 12-15 blocks)
  - 서명 알고리즘: Solana (Ed25519) vs EVM (secp256k1 + ECDSA)
  - 주소 포맷: Solana (Base58, 32-44자) vs EVM (0x-hex, 42자)
  - 이 차이가 IChainAdapter 인터페이스 설계에 미치는 영향
  </action>
  <verify>
  문서에 다음이 모두 포함되어 있는지 확인:
  - Solana Adapter 전체 메서드의 내부 구현 전략 (12개)
  - @solana/kit pipe 패턴 코드 참조
  - EVM Adapter 전체 메서드의 내부 구현 전략 (12개)
  - viem Client/Action 패턴 코드 참조
  - Nonce 관리 전략 (EVM)
  - 체인 간 차이점 비교 매트릭스
  - RPC 기본값 테이블 (Solana + EVM)
  </verify>
  <done>
  Solana Adapter가 @solana/kit 3.x 기반으로 모든 메서드의 내부 구현 전략까지 설계됨. EVM Adapter가 viem 기반으로 동일 수준으로 설계됨. 체인 간 차이가 비교 매트릭스로 문서화됨. 요구사항 CHAIN-01 완전 커버, KEYS-03(getBalance) 연결.
  </done>
</task>

</tasks>

<verification>
- 27-chain-adapter-interface.md가 8개 섹션을 모두 포함함
- IChainAdapter 인터페이스가 v0.1 ARCH-05 대비 Squads 메서드 제거됨
- Solana: @solana/kit 3.x pipe 패턴 사용 확인
- EVM: viem Client/Action 패턴 사용 확인
- 에러 코드가 공통/체인별로 분리됨
- 요구사항 CHAIN-01 완전 커버
</verification>

<success_criteria>
1. IChainAdapter 인터페이스가 12개 메서드 시그니처 수준으로 설계됨
2. 공통 타입이 모든 필드의 타입/용도까지 정의됨
3. Solana Adapter가 @solana/kit 3.x 기반 구현 전략까지 설계됨
4. EVM Adapter가 viem 기반 구현 전략까지 설계됨 (nonce 관리 포함)
5. 체인 간 차이가 비교 매트릭스로 정리됨
6. AdapterRegistry가 등록/검색/플러그인 확장까지 설계됨
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-architecture-design/06-03-SUMMARY.md`
</output>
