---
phase: 58-openapihono-getassets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/package.json
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/api/routes/health.ts
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/api/routes/wallet.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/routes/sessions.ts
  - packages/daemon/src/api/routes/policies.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/index.ts
autonomous: true

must_haves:
  truths:
    - "GET /doc returns valid OpenAPI 3.0 JSON containing all 18 route paths"
    - "All 18 existing routes respond identically to before conversion (same status codes, same JSON shapes)"
    - "68 error codes are mapped as OpenAPI response schemas in the spec"
    - "All existing 457 tests pass after conversion (zero regressions)"
  artifacts:
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "Shared OpenAPI Zod response schemas for all routes + error code mapping"
    - path: "packages/daemon/src/api/server.ts"
      provides: "OpenAPIHono app factory with GET /doc endpoint"
      contains: "OpenAPIHono"
    - path: "packages/daemon/src/api/routes/health.ts"
      provides: "Health route converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/agents.ts"
      provides: "Agent routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/wallet.ts"
      provides: "Wallet routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "Transaction routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/sessions.ts"
      provides: "Session routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/policies.ts"
      provides: "Policy routes converted to createRoute()"
      contains: "createRoute"
  key_links:
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/*.ts"
      via: "OpenAPIHono app.route() registration"
      pattern: "app\\.route\\("
    - from: "packages/daemon/src/api/server.ts"
      to: "GET /doc endpoint"
      via: "app.doc('/doc', {...})"
      pattern: "app\\.doc\\("
    - from: "packages/daemon/src/api/routes/openapi-schemas.ts"
      to: "packages/core/src/errors/error-codes.ts"
      via: "ERROR_CODES import for error response mapping"
      pattern: "ERROR_CODES"
---

<objective>
Convert all 18 existing Hono routes to OpenAPIHono createRoute() pattern, add GET /doc endpoint for OpenAPI 3.0 JSON spec auto-generation, and map 68 error codes to OpenAPI response schemas.

Purpose: Enable type-safe routing with Zod schema validation at the framework level, auto-generate OpenAPI 3.0 spec for SDK/MCP code generation, and document all error responses for API consumers.

Output: All route files converted to OpenAPIHono, GET /doc returning valid OpenAPI 3.0 JSON, 68 error codes in spec, zero test regressions.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/server.ts
@packages/daemon/src/api/routes/health.ts
@packages/daemon/src/api/routes/agents.ts
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/sessions.ts
@packages/daemon/src/api/routes/policies.ts
@packages/daemon/src/api/routes/index.ts
@packages/daemon/src/api/index.ts
@packages/core/src/errors/error-codes.ts
@packages/core/src/schemas/index.ts
@packages/daemon/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @hono/zod-openapi, create shared OpenAPI response schemas, and convert all 18 routes to createRoute()</name>
  <files>
    packages/daemon/package.json
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/api/routes/health.ts
    packages/daemon/src/api/routes/agents.ts
    packages/daemon/src/api/routes/wallet.ts
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/api/routes/sessions.ts
    packages/daemon/src/api/routes/policies.ts
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/index.ts
  </files>
  <action>
**Step 1: Install @hono/zod-openapi**
```bash
cd packages/daemon && pnpm add @hono/zod-openapi
```

Note: @hono/zod-openapi uses `@hono/zod-openapi` package which re-exports `z` from zod with `.openapi()` extension. Import `z` from `@hono/zod-openapi` in route files for schema definitions, OR use the `z.openapi()` extension method on existing `zod` schemas. The package works alongside existing `zod` -- no migration needed for `@waiaas/core` schemas.

**Step 2: Create `packages/daemon/src/api/routes/openapi-schemas.ts`**

This file provides:
1. **Shared Zod response schemas** for OpenAPI documentation (using `z` from `@hono/zod-openapi` where `.openapi()` extension is needed):
   - `ErrorResponseSchema` -- { code: string, message: string, retryable: boolean, details?: object, requestId?: string }
   - `HealthResponseSchema` -- { status, version, uptime, timestamp }
   - `AgentResponseSchema` -- { id, name, chain, network, publicKey, status, createdAt }
   - `AgentOwnerResponseSchema` -- { id, name, chain, network, publicKey, status, ownerAddress, ownerVerified, updatedAt }
   - `WalletAddressResponseSchema` -- { agentId, chain, network, address }
   - `WalletBalanceResponseSchema` -- { agentId, chain, network, address, balance, decimals, symbol }
   - `SessionCreateResponseSchema` -- { id, token, expiresAt, agentId }
   - `SessionListItemSchema` -- { id, agentId, status, renewalCount, maxRenewals, expiresAt, absoluteExpiresAt, createdAt, lastRenewedAt }
   - `SessionRevokeResponseSchema` -- { id, status, message? }
   - `SessionRenewResponseSchema` -- { id, token, expiresAt, renewalCount }
   - `TxSendResponseSchema` -- { id, status }
   - `TxDetailResponseSchema` -- { id, agentId, type, status, tier, chain, toAddress, amount, txHash, error, createdAt }
   - `TxApproveResponseSchema` -- { id, status, approvedAt }
   - `TxRejectResponseSchema` -- { id, status, rejectedAt }
   - `TxCancelResponseSchema` -- { id, status }
   - `PolicyResponseSchema` -- { id, agentId, type, rules, priority, enabled, createdAt, updatedAt }
   - `PolicyDeleteResponseSchema` -- { id, deleted }

2. **Error code OpenAPI mapping function**: `buildErrorResponses(codes: ErrorCode[])` that returns a record of HTTP status code -> { description, content: 'application/json': { schema: ErrorResponseSchema } } for use in createRoute() responses. Group error codes by httpStatus (e.g., all 401 codes merge into one "401" response entry with description listing which codes can occur).

3. Re-export `@waiaas/core` request schemas with `.openapi()` metadata added via wrapper (e.g., `CreateAgentRequestSchema.openapi('CreateAgentRequest')`). Use the approach of extending existing Zod schemas -- do NOT redefine them.

**Step 3: Convert `server.ts` to use OpenAPIHono**

Replace `import { Hono } from 'hono'` with `import { OpenAPIHono } from '@hono/zod-openapi'`.
- Change `new Hono()` to `new OpenAPIHono()` in createApp.
- Keep all existing middleware registration unchanged (requestId, hostGuard, killSwitchGuard, requestLogger, errorHandler).
- Keep all existing auth middleware registration unchanged.
- Add `app.doc('/doc', { openapi: '3.0.0', info: { title: 'WAIaaS API', version: '0.0.0' } })` after all routes are registered (before `return app`).
- IMPORTANT: OpenAPIHono is a superset of Hono. All existing `.use()`, `.route()`, `.onError()` calls work unchanged.
- Type the return type as `OpenAPIHono` instead of `Hono`.
- Update barrel exports in `packages/daemon/src/api/index.ts` accordingly.

**Step 4: Convert each route file to use OpenAPIHono + createRoute()**

For EACH route file, apply this pattern:

```typescript
import { OpenAPIHono, createRoute, z } from '@hono/zod-openapi';

// Define route with createRoute()
const healthRoute = createRoute({
  method: 'get',
  path: '/',
  tags: ['Health'],
  summary: 'Health check',
  responses: {
    200: {
      description: 'Daemon health status',
      content: { 'application/json': { schema: HealthResponseSchema } },
    },
  },
});

// Register with OpenAPIHono
const health = new OpenAPIHono();
health.openapi(healthRoute, (c) => {
  return c.json({ status: 'ok', ... }, 200);
});
```

**Route-by-route conversion details:**

1. **health.ts** (1 route):
   - GET / -> createRoute with HealthResponseSchema

2. **agents.ts** (2 routes):
   - POST /agents -> createRoute with CreateAgentRequestSchema body + AgentResponseSchema 201 + error responses (AGENT_NOT_FOUND)
   - PUT /agents/:id/owner -> createRoute with path param `id`, body { owner_address: string }, AgentOwnerResponseSchema 200 + error responses (AGENT_NOT_FOUND, OWNER_ALREADY_CONNECTED)

3. **wallet.ts** (2 routes):
   - GET /wallet/address -> createRoute with WalletAddressResponseSchema 200 + error responses (AGENT_NOT_FOUND)
   - GET /wallet/balance -> createRoute with WalletBalanceResponseSchema 200 + error responses (AGENT_NOT_FOUND, CHAIN_ERROR)

4. **sessions.ts** (4 routes):
   - POST /sessions -> createRoute with CreateSessionRequestSchema body + SessionCreateResponseSchema 201 + errors (AGENT_NOT_FOUND, SESSION_LIMIT_EXCEEDED)
   - GET /sessions -> createRoute with query `agentId` + SessionListItemSchema array 200 + errors (AGENT_NOT_FOUND)
   - DELETE /sessions/:id -> createRoute with path param `id` + SessionRevokeResponseSchema 200 + errors (SESSION_NOT_FOUND)
   - PUT /sessions/:id/renew -> createRoute with path param `id` + SessionRenewResponseSchema 200 + errors (SESSION_NOT_FOUND, SESSION_REVOKED, SESSION_RENEWAL_MISMATCH, RENEWAL_LIMIT_REACHED, SESSION_ABSOLUTE_LIFETIME_EXCEEDED, RENEWAL_TOO_EARLY)

5. **transactions.ts** (5 routes):
   - POST /transactions/send -> createRoute with SendTransactionRequestSchema body + TxSendResponseSchema 201 + errors (AGENT_NOT_FOUND)
   - GET /transactions/:id -> createRoute with path param `id` + TxDetailResponseSchema 200 + errors (TX_NOT_FOUND)
   - POST /transactions/:id/approve -> createRoute with path param `id` + TxApproveResponseSchema 200 + errors (TX_NOT_FOUND)
   - POST /transactions/:id/reject -> createRoute with path param `id` + TxRejectResponseSchema 200 + errors (TX_NOT_FOUND)
   - POST /transactions/:id/cancel -> createRoute with path param `id` + TxCancelResponseSchema 200 + errors (TX_NOT_FOUND)

6. **policies.ts** (4 routes):
   - POST /policies -> createRoute with CreatePolicyRequestSchema body + PolicyResponseSchema 201 + errors (AGENT_NOT_FOUND, ACTION_VALIDATION_FAILED)
   - GET /policies -> createRoute with query `agentId` optional + PolicyResponseSchema array 200
   - PUT /policies/:id -> createRoute with path param `id` + UpdatePolicyRequestSchema body + PolicyResponseSchema 200 + errors (POLICY_NOT_FOUND, ACTION_VALIDATION_FAILED)
   - DELETE /policies/:id -> createRoute with path param `id` + PolicyDeleteResponseSchema 200 + errors (POLICY_NOT_FOUND)

**CRITICAL conversion rules:**
- Each route factory function (e.g., `agentRoutes(deps)`) must return `OpenAPIHono` instead of `Hono`.
- Use `router.openapi(route, handler)` instead of `router.get/post/put/delete(path, handler)`.
- Handler body remains IDENTICAL -- only the registration pattern changes.
- Path parameters MUST use Zod schema in createRoute: `params: z.object({ id: z.string().uuid() })`.
- Query parameters: use `query: z.object({ agentId: z.string().uuid().optional() })`.
- Request body: use `body: { content: { 'application/json': { schema: XxxSchema } } }`.
- Keep ALL existing handler logic unchanged -- this is a framework migration, not a logic change.
- For transactions routes with conditional registration (approve/reject behind `if (deps.approvalWorkflow && deps.ownerLifecycle)`), define the createRoute outside the if-block but register with `router.openapi()` inside the if-block. This ensures the routes appear in OpenAPI spec when registered.
- `c.req.param('id')` -> params are now typed via createRoute; access via `const { id } = c.req.valid('param')`.
- `c.req.query('agentId')` -> access via `const { agentId } = c.req.valid('query')`.
- `await c.req.json()` + `Schema.parse(body)` -> access via `const body = c.req.valid('json')` (OpenAPIHono validates automatically, BUT since we have custom validation logic in policies.ts beyond Zod -- i.e., `validateRules()` -- we still need the manual validation call AFTER getting the validated body).
- For routes that use `c.get('agentId' as never)` from middleware context, this continues to work unchanged -- OpenAPIHono doesn't affect Hono context variables.

**Step 5: Update barrel exports**

In `packages/daemon/src/api/routes/index.ts`, ensure sessionRoutes is exported (currently missing from barrel).
In `packages/daemon/src/api/index.ts`, update any Hono type references.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- all packages compile
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` -- all existing tests pass (target: 456+ passing, 0 new failures beyond the known flaky lifecycle test)
3. Verify GET /doc content:
   - Write a quick inline test or use the existing test infra to call `app.request('/doc')` and verify:
     a. Response is valid JSON with `openapi: '3.0.0'`
     b. `paths` object contains all 18 route paths
     c. Error response schemas reference the ErrorResponseSchema
  </verify>
  <done>
- All 18 routes use OpenAPIHono createRoute() pattern
- GET /doc returns valid OpenAPI 3.0 JSON with all routes documented
- 68 error codes are mapped in OpenAPI response schemas
- All existing tests pass (zero regressions beyond known flaky test)
- `pnpm build` succeeds across all packages
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds for all packages
2. `pnpm test` shows same or better pass rate (456+ passing tests)
3. `app.request('/doc')` returns valid OpenAPI 3.0 JSON with:
   - 18 paths covering all existing routes
   - Error response schemas for each error-prone route
   - Request/response schemas matching existing Zod schemas
4. Route behavior is IDENTICAL to pre-conversion (same status codes, same JSON payloads)
</verification>

<success_criteria>
- OAPI-01: All 18 routes use createRoute() with Zod request/response schemas
- OAPI-02: GET /doc returns valid OpenAPI 3.0 JSON for all routes
- OAPI-03: 68 error codes are mapped to OpenAPI response schemas
- OAPI-04: All existing tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/58-openapihono-getassets/58-01-SUMMARY.md`
</output>
