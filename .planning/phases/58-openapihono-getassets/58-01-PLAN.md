---
phase: 58-openapihono-getassets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/package.json
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/api/routes/health.ts
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/api/routes/wallet.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/routes/sessions.ts
  - packages/daemon/src/api/routes/policies.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/index.ts
autonomous: true

must_haves:
  truths:
    - "GET /doc returns valid OpenAPI 3.0 JSON containing all 18 route paths"
    - "All 18 existing routes respond identically to before conversion (same status codes, same JSON shapes)"
    - "68 error codes are mapped as OpenAPI response schemas in the spec"
    - "All existing v1.2 tests pass after conversion (zero regressions)"
  artifacts:
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "Shared OpenAPI Zod response schemas for all routes + error code mapping"
    - path: "packages/daemon/src/api/server.ts"
      provides: "OpenAPIHono app factory with GET /doc endpoint"
      contains: "OpenAPIHono"
    - path: "packages/daemon/src/api/routes/health.ts"
      provides: "Health route converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/agents.ts"
      provides: "Agent routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/wallet.ts"
      provides: "Wallet routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "Transaction routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/sessions.ts"
      provides: "Session routes converted to createRoute()"
      contains: "createRoute"
    - path: "packages/daemon/src/api/routes/policies.ts"
      provides: "Policy routes converted to createRoute()"
      contains: "createRoute"
  key_links:
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/*.ts"
      via: "OpenAPIHono app.route() registration of all 6 converted route modules"
      pattern: "app\\.route\\("
    - from: "packages/daemon/src/api/server.ts"
      to: "GET /doc endpoint"
      via: "app.doc('/doc', {...})"
      pattern: "app\\.doc\\("
    - from: "packages/daemon/src/api/routes/openapi-schemas.ts"
      to: "packages/core/src/errors/error-codes.ts"
      via: "ERROR_CODES import for error response mapping"
      pattern: "ERROR_CODES"
---

<objective>
Convert all 18 existing Hono routes to OpenAPIHono createRoute() pattern, add GET /doc endpoint for OpenAPI 3.0 JSON spec auto-generation, and map 68 error codes to OpenAPI response schemas.

Purpose: Enable type-safe routing with Zod schema validation at the framework level, auto-generate OpenAPI 3.0 spec for SDK/MCP code generation, and document all error responses for API consumers.

Output: All route files converted to OpenAPIHono, GET /doc returning valid OpenAPI 3.0 JSON, 68 error codes in spec, zero test regressions.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/server.ts
@packages/daemon/src/api/routes/health.ts
@packages/daemon/src/api/routes/agents.ts
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/sessions.ts
@packages/daemon/src/api/routes/policies.ts
@packages/daemon/src/api/routes/index.ts
@packages/daemon/src/api/index.ts
@packages/core/src/errors/error-codes.ts
@packages/core/src/schemas/index.ts
@packages/daemon/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @hono/zod-openapi and create shared OpenAPI response schemas</name>
  <files>
    packages/daemon/package.json
    packages/daemon/src/api/routes/openapi-schemas.ts
  </files>
  <action>
**Step 1: Install @hono/zod-openapi**
```bash
cd packages/daemon && pnpm add @hono/zod-openapi
```

Note: @hono/zod-openapi re-exports `z` from zod with `.openapi()` extension. Import `z` from `@hono/zod-openapi` in route files for schema definitions. The package works alongside existing `zod` -- no migration needed for `@waiaas/core` schemas.

**Step 2: Create `packages/daemon/src/api/routes/openapi-schemas.ts`**

This file provides:

1. **Shared Zod response schemas** for OpenAPI documentation (using `z` from `@hono/zod-openapi` where `.openapi()` extension is needed):
   - `ErrorResponseSchema` -- { code: string, message: string, retryable: boolean, details?: object, requestId?: string }
   - `HealthResponseSchema` -- { status, version, uptime, timestamp }
   - `AgentResponseSchema` -- { id, name, chain, network, publicKey, status, createdAt }
   - `AgentOwnerResponseSchema` -- { id, name, chain, network, publicKey, status, ownerAddress, ownerVerified, updatedAt }
   - `WalletAddressResponseSchema` -- { agentId, chain, network, address }
   - `WalletBalanceResponseSchema` -- { agentId, chain, network, address, balance, decimals, symbol }
   - `SessionCreateResponseSchema` -- { id, token, expiresAt, agentId }
   - `SessionListItemSchema` -- { id, agentId, status, renewalCount, maxRenewals, expiresAt, absoluteExpiresAt, createdAt, lastRenewedAt }
   - `SessionRevokeResponseSchema` -- { id, status, message? }
   - `SessionRenewResponseSchema` -- { id, token, expiresAt, renewalCount }
   - `TxSendResponseSchema` -- { id, status }
   - `TxDetailResponseSchema` -- { id, agentId, type, status, tier, chain, toAddress, amount, txHash, error, createdAt }
   - `TxApproveResponseSchema` -- { id, status, approvedAt }
   - `TxRejectResponseSchema` -- { id, status, rejectedAt }
   - `TxCancelResponseSchema` -- { id, status }
   - `PolicyResponseSchema` -- { id, agentId, type, rules, priority, enabled, createdAt, updatedAt }
   - `PolicyDeleteResponseSchema` -- { id, deleted }

2. **Error code OpenAPI mapping function**: `buildErrorResponses(codes: ErrorCode[])` that returns a record of HTTP status code -> { description, content: 'application/json': { schema: ErrorResponseSchema } } for use in createRoute() responses. Group error codes by httpStatus (e.g., all 401 codes merge into one "401" response entry with description listing which codes can occur).

3. Re-export `@waiaas/core` request schemas with `.openapi()` metadata added via wrapper (e.g., `CreateAgentRequestSchema.openapi('CreateAgentRequest')`). Use the approach of extending existing Zod schemas -- do NOT redefine them.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build --filter @waiaas/daemon` -- compiles with new dependency and schema file
2. Verify `openapi-schemas.ts` exports all listed schemas and `buildErrorResponses` function
  </verify>
  <done>
- @hono/zod-openapi installed in daemon package
- openapi-schemas.ts exports 17 response schemas + buildErrorResponses() function
- `pnpm build --filter @waiaas/daemon` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert server.ts to OpenAPIHono and convert health.ts + wallet.ts (3 simple routes)</name>
  <files>
    packages/daemon/src/api/server.ts
    packages/daemon/src/api/routes/health.ts
    packages/daemon/src/api/routes/wallet.ts
    packages/daemon/src/api/index.ts
  </files>
  <action>
**Step 1: Convert `server.ts` to use OpenAPIHono**

Replace `import { Hono } from 'hono'` with `import { OpenAPIHono } from '@hono/zod-openapi'`.
- Change `new Hono()` to `new OpenAPIHono()` in createApp.
- Keep all existing middleware registration unchanged (requestId, hostGuard, killSwitchGuard, requestLogger, errorHandler).
- Keep all existing auth middleware registration unchanged.
- Type the return type as `OpenAPIHono` instead of `Hono`.
- IMPORTANT: OpenAPIHono is a superset of Hono. All existing `.use()`, `.route()`, `.onError()` calls work unchanged.
- Update barrel exports in `packages/daemon/src/api/index.ts` accordingly (update any Hono type references).

**Step 2: Convert health.ts (1 route: GET /)**

```typescript
import { OpenAPIHono, createRoute } from '@hono/zod-openapi';
import { HealthResponseSchema } from './openapi-schemas.js';

const healthRoute = createRoute({
  method: 'get',
  path: '/',
  tags: ['Health'],
  summary: 'Health check',
  responses: {
    200: {
      description: 'Daemon health status',
      content: { 'application/json': { schema: HealthResponseSchema } },
    },
  },
});

const health = new OpenAPIHono();
health.openapi(healthRoute, (c) => {
  // existing handler body unchanged
});
```

**Step 3: Convert wallet.ts (2 routes: GET /wallet/address, GET /wallet/balance)**

Apply same createRoute() pattern:
- GET /wallet/address -> createRoute with WalletAddressResponseSchema 200 + error responses (AGENT_NOT_FOUND)
- GET /wallet/balance -> createRoute with WalletBalanceResponseSchema 200 + error responses (AGENT_NOT_FOUND, CHAIN_ERROR)

CRITICAL conversion rules for both files:
- Each route factory function must return `OpenAPIHono` instead of `Hono`.
- Use `router.openapi(route, handler)` instead of `router.get(path, handler)`.
- Handler body remains IDENTICAL -- only the registration pattern changes.
- For routes that use `c.get('agentId' as never)` from middleware context, this continues to work unchanged -- OpenAPIHono doesn't affect Hono context variables.

**Step 4: Verify build + tests still pass after first batch**

Run `pnpm build && pnpm test` to confirm no regressions from the first 3 routes converted.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- all packages compile with OpenAPIHono
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` -- all existing v1.2 tests pass (zero new failures beyond known flaky lifecycle test)
3. Confirm server.ts uses `OpenAPIHono` and health.ts + wallet.ts use `createRoute()`
  </verify>
  <done>
- server.ts uses OpenAPIHono instead of Hono
- health.ts converted (1 route: GET /)
- wallet.ts converted (2 routes: GET /wallet/address, GET /wallet/balance)
- All existing tests pass, pnpm build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert agents.ts (2 routes) and sessions.ts (4 routes) to createRoute()</name>
  <files>
    packages/daemon/src/api/routes/agents.ts
    packages/daemon/src/api/routes/sessions.ts
  </files>
  <action>
**Step 1: Convert agents.ts (2 routes)**

- POST /agents -> createRoute with CreateAgentRequestSchema body + AgentResponseSchema 201 + error responses (AGENT_NOT_FOUND)
- PUT /agents/:id/owner -> createRoute with path param `id`, body { owner_address: string }, AgentOwnerResponseSchema 200 + error responses (AGENT_NOT_FOUND, OWNER_ALREADY_CONNECTED)

Conversion rules:
- Route factory must return `OpenAPIHono` instead of `Hono`.
- Use `router.openapi(route, handler)` instead of `router.post/put(path, handler)`.
- Path parameters MUST use Zod schema in createRoute: `params: z.object({ id: z.string().uuid() })`.
- Request body: use `body: { content: { 'application/json': { schema: XxxSchema } } }`.
- `await c.req.json()` + `Schema.parse(body)` -> access via `const body = c.req.valid('json')` (OpenAPIHono validates automatically).
- Handler body logic remains IDENTICAL.

**Step 2: Convert sessions.ts (4 routes)**

- POST /sessions -> createRoute with CreateSessionRequestSchema body + SessionCreateResponseSchema 201 + errors (AGENT_NOT_FOUND, SESSION_LIMIT_EXCEEDED)
- GET /sessions -> createRoute with query `agentId` + SessionListItemSchema array 200 + errors (AGENT_NOT_FOUND)
- DELETE /sessions/:id -> createRoute with path param `id` + SessionRevokeResponseSchema 200 + errors (SESSION_NOT_FOUND)
- PUT /sessions/:id/renew -> createRoute with path param `id` + SessionRenewResponseSchema 200 + errors (SESSION_NOT_FOUND, SESSION_REVOKED, SESSION_RENEWAL_MISMATCH, RENEWAL_LIMIT_REACHED, SESSION_ABSOLUTE_LIFETIME_EXCEEDED, RENEWAL_TOO_EARLY)

Additional conversion rules for sessions:
- `c.req.param('id')` -> `const { id } = c.req.valid('param')`.
- `c.req.query('agentId')` -> `const { agentId } = c.req.valid('query')` with `query: z.object({ agentId: z.string().uuid().optional() })`.
- Keep ALL existing handler logic unchanged -- this is a framework migration, not a logic change.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- compiles
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` -- all existing tests pass (zero regressions)
3. Confirm agents.ts has 2 createRoute() definitions and sessions.ts has 4 createRoute() definitions
  </verify>
  <done>
- agents.ts converted (2 routes: POST /agents, PUT /agents/:id/owner)
- sessions.ts converted (4 routes: POST/GET /sessions, DELETE/PUT /sessions/:id)
- All existing tests pass, pnpm build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 4: Convert transactions.ts (5 routes) and policies.ts (4 routes) to createRoute()</name>
  <files>
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/api/routes/policies.ts
  </files>
  <action>
**Step 1: Convert transactions.ts (5 routes)**

- POST /transactions/send -> createRoute with SendTransactionRequestSchema body + TxSendResponseSchema 201 + errors (AGENT_NOT_FOUND)
- GET /transactions/:id -> createRoute with path param `id` + TxDetailResponseSchema 200 + errors (TX_NOT_FOUND)
- POST /transactions/:id/approve -> createRoute with path param `id` + TxApproveResponseSchema 200 + errors (TX_NOT_FOUND)
- POST /transactions/:id/reject -> createRoute with path param `id` + TxRejectResponseSchema 200 + errors (TX_NOT_FOUND)
- POST /transactions/:id/cancel -> createRoute with path param `id` + TxCancelResponseSchema 200 + errors (TX_NOT_FOUND)

IMPORTANT: For transactions routes with conditional registration (approve/reject behind `if (deps.approvalWorkflow && deps.ownerLifecycle)`), define the createRoute() outside the if-block but register with `router.openapi()` inside the if-block. This ensures the routes appear in OpenAPI spec when registered.

Conversion rules:
- `c.req.param('id')` -> `const { id } = c.req.valid('param')`.
- Handler body remains IDENTICAL -- only the registration pattern changes.

**Step 2: Convert policies.ts (4 routes)**

- POST /policies -> createRoute with CreatePolicyRequestSchema body + PolicyResponseSchema 201 + errors (AGENT_NOT_FOUND, ACTION_VALIDATION_FAILED)
- GET /policies -> createRoute with query `agentId` optional + PolicyResponseSchema array 200
- PUT /policies/:id -> createRoute with path param `id` + UpdatePolicyRequestSchema body + PolicyResponseSchema 200 + errors (POLICY_NOT_FOUND, ACTION_VALIDATION_FAILED)
- DELETE /policies/:id -> createRoute with path param `id` + PolicyDeleteResponseSchema 200 + errors (POLICY_NOT_FOUND)

IMPORTANT for policies.ts: Since we have custom validation logic beyond Zod (i.e., `validateRules()`), we still need the manual validation call AFTER getting the validated body via `c.req.valid('json')`.
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- compiles
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` -- all existing tests pass (zero regressions)
3. Confirm transactions.ts has 5 createRoute() definitions and policies.ts has 4 createRoute() definitions
  </verify>
  <done>
- transactions.ts converted (5 routes including conditional approve/reject)
- policies.ts converted (4 routes with custom validation preserved)
- All existing tests pass, pnpm build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 5: Update barrel exports, add GET /doc endpoint, and verify all route registrations</name>
  <files>
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
**Step 1: Update barrel exports**

In `packages/daemon/src/api/routes/index.ts`, ensure sessionRoutes is exported (currently missing from barrel). Verify all 6 route module exports are present: healthRoutes, agentRoutes, walletRoutes, sessionRoutes, transactionRoutes, policyRoutes.

**Step 2: Add GET /doc endpoint to server.ts**

Add `app.doc('/doc', { openapi: '3.0.0', info: { title: 'WAIaaS API', version: '0.0.0' } })` after all routes are registered (before `return app`).

**Step 3: Verify all 6 route modules are registered with app.route()**

Confirm server.ts registers all 6 converted route modules via `app.route()`:
1. `app.route('/health', healthRoutes)` (or equivalent path prefix)
2. `app.route('/agents', agentRoutes)` (or equivalent)
3. `app.route('/wallet', walletRoutes)` (or equivalent)
4. `app.route('/sessions', sessionRoutes)` (or equivalent)
5. `app.route('/transactions', transactionRoutes)` (or equivalent)
6. `app.route('/policies', policyRoutes)` (or equivalent)

If any route module is not registered via app.route(), add the registration. This is the critical wiring that connects OpenAPIHono route definitions to the app's OpenAPI spec -- without app.route(), routes won't appear in GET /doc output.

**Step 4: Verify GET /doc output**

Write an inline verification (or use existing test infra) to call `app.request('/doc')` and verify:
a. Response is valid JSON with `openapi: '3.0.0'`
b. `paths` object contains all 18 route paths
c. Error response schemas reference the ErrorResponseSchema
  </action>
  <verify>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` -- all packages compile
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` -- all existing v1.2 tests pass (zero new failures beyond known flaky lifecycle test)
3. Verify GET /doc content:
   - `app.request('/doc')` returns valid JSON with `openapi: '3.0.0'`
   - `paths` object contains all 18 route paths
   - Error response schemas reference the ErrorResponseSchema
4. Grep server.ts for `app.route(` calls -- confirm 6 registrations exist
  </verify>
  <done>
- All barrel exports updated (including sessionRoutes)
- GET /doc returns valid OpenAPI 3.0 JSON with all 18 routes documented
- All 6 route modules confirmed registered via app.route() in server.ts
- 68 error codes mapped in OpenAPI response schemas
- All existing tests pass (zero regressions beyond known flaky test)
- `pnpm build` succeeds across all packages
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds for all packages
2. `pnpm test` shows same or better pass rate (all existing v1.2 tests pass)
3. `app.request('/doc')` returns valid OpenAPI 3.0 JSON with:
   - 18 paths covering all existing routes
   - Error response schemas for each error-prone route
   - Request/response schemas matching existing Zod schemas
4. Route behavior is IDENTICAL to pre-conversion (same status codes, same JSON payloads)
5. server.ts has 6 `app.route()` registrations wiring all converted route modules
</verification>

<success_criteria>
- OAPI-01: All 18 routes use createRoute() with Zod request/response schemas
- OAPI-02: GET /doc returns valid OpenAPI 3.0 JSON for all routes
- OAPI-03: 68 error codes are mapped to OpenAPI response schemas
- OAPI-04: All existing v1.2 tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/58-openapihono-getassets/58-01-SUMMARY.md`
</output>
