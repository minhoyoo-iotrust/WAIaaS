---
phase: 58-openapihono-getassets
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/chain-adapter.types.ts
  - packages/core/src/interfaces/IChainAdapter.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/index.ts
  - packages/core/src/schemas/asset.schema.ts
  - packages/core/src/schemas/index.ts
  - packages/adapters/solana/src/adapter.ts
  - packages/adapters/solana/src/__tests__/solana-adapter.test.ts
autonomous: true

must_haves:
  truths:
    - "IChainAdapter interface includes getAssets(address: string): Promise<AssetInfo[]>"
    - "SolanaAdapter.getAssets() returns native SOL + SPL token accounts via getTokenAccountsByOwner RPC"
    - "AssetInfo type is exported from @waiaas/core and AssetInfoSchema Zod schema exists for validation"
    - "Tests cover native-only, native+tokens, empty account, and RPC error scenarios"
  artifacts:
    - path: "packages/core/src/interfaces/chain-adapter.types.ts"
      provides: "AssetInfo type definition"
      contains: "AssetInfo"
    - path: "packages/core/src/interfaces/IChainAdapter.ts"
      provides: "getAssets method on IChainAdapter"
      contains: "getAssets"
    - path: "packages/core/src/schemas/asset.schema.ts"
      provides: "AssetInfoSchema Zod schema"
      contains: "AssetInfoSchema"
    - path: "packages/adapters/solana/src/adapter.ts"
      provides: "SolanaAdapter.getAssets() implementation"
      contains: "getAssets"
    - path: "packages/adapters/solana/src/__tests__/solana-adapter.test.ts"
      provides: "getAssets() unit tests"
      contains: "getAssets"
  key_links:
    - from: "packages/core/src/interfaces/IChainAdapter.ts"
      to: "packages/core/src/interfaces/chain-adapter.types.ts"
      via: "AssetInfo type import"
      pattern: "import.*AssetInfo"
    - from: "packages/adapters/solana/src/adapter.ts"
      to: "packages/core/src/interfaces/IChainAdapter.ts"
      via: "implements IChainAdapter"
      pattern: "implements IChainAdapter"
    - from: "packages/core/src/index.ts"
      to: "packages/core/src/schemas/asset.schema.ts"
      via: "barrel export"
      pattern: "AssetInfoSchema"
---

<objective>
Add getAssets() method to IChainAdapter interface and implement it in SolanaAdapter, returning native SOL balance plus all SPL token accounts as AssetInfo[] via a single getTokenAccountsByOwner RPC call.

Purpose: Phase 59 needs GET /v1/wallet/assets endpoint which depends on adapter.getAssets(). This is the chain-level building block.

Output: AssetInfo type, AssetInfoSchema Zod schema, IChainAdapter.getAssets(), SolanaAdapter.getAssets() with TDD tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/index.ts
@packages/core/src/schemas/index.ts
@packages/adapters/solana/src/adapter.ts
@packages/adapters/solana/src/__tests__/solana-adapter.test.ts
</context>

<feature>
  <name>IChainAdapter.getAssets() with SolanaAdapter implementation</name>
  <files>
    packages/core/src/interfaces/chain-adapter.types.ts
    packages/core/src/interfaces/IChainAdapter.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/index.ts
    packages/core/src/schemas/asset.schema.ts
    packages/core/src/schemas/index.ts
    packages/adapters/solana/src/adapter.ts
    packages/adapters/solana/src/__tests__/solana-adapter.test.ts
  </files>
  <behavior>
**AssetInfo type definition** (in chain-adapter.types.ts):
```typescript
export interface AssetInfo {
  /** Token mint address. 'native' for SOL/ETH. */
  mint: string;
  /** Token symbol. 'SOL', 'USDC', etc. */
  symbol: string;
  /** Token name. 'Solana', 'USD Coin', etc. Empty string if unknown. */
  name: string;
  /** Balance in smallest unit (lamports/wei). */
  balance: bigint;
  /** Decimal places. */
  decimals: number;
  /** Whether this is the native token. */
  isNative: boolean;
  /** USD value if available (from price oracle). */
  usdValue?: number;
}
```

**AssetInfoSchema** (Zod, in asset.schema.ts):
```typescript
export const AssetInfoSchema = z.object({
  mint: z.string(),
  symbol: z.string(),
  name: z.string(),
  balance: z.string(), // bigint as string for JSON
  decimals: z.number().int(),
  isNative: z.boolean(),
  usdValue: z.number().optional(),
});
```

**IChainAdapter method signature:**
```typescript
getAssets(address: string): Promise<AssetInfo[]>;
```

**SolanaAdapter.getAssets() behavior:**

1. Call `rpc.getBalance(address)` for native SOL balance
2. Call `rpc.getTokenAccountsByOwner(address, { programId: TOKEN_PROGRAM_ADDRESS })` with `{ encoding: 'jsonParsed' }` to get all SPL token accounts
3. First entry in result array is always native SOL: `{ mint: 'native', symbol: 'SOL', name: 'Solana', balance: <lamports>, decimals: 9, isNative: true }`
4. Each SPL token account becomes: `{ mint: <mintAddress>, symbol: '', name: '', balance: <tokenAmount>, decimals: <decimals>, isNative: false }`
   - symbol and name are empty strings because on-chain token accounts don't store metadata (that's in Metaplex metadata accounts, which is v1.4+ work with price oracle)
5. Filter out zero-balance token accounts
6. On RPC error, throw `WAIaaSError('CHAIN_ERROR', { message: '...' })`

**Test cases (input -> expected output):**

- `getAssets('validAddr')` with 1 SOL + 0 tokens -> `[{ mint: 'native', symbol: 'SOL', balance: 1_000_000_000n, decimals: 9, isNative: true }]`
- `getAssets('validAddr')` with 1 SOL + 2 SPL tokens -> array of 3 AssetInfo entries (native first, then tokens)
- `getAssets('validAddr')` with 0 SOL + 0 tokens -> `[{ mint: 'native', symbol: 'SOL', balance: 0n, decimals: 9, isNative: true }]` (always include native)
- `getAssets('validAddr')` with SPL token having zero balance -> filtered out, not in result
- `getAssets('validAddr')` when RPC throws -> throws WAIaaSError with code 'CHAIN_ERROR'
- `getAssets('validAddr')` when not connected -> throws WAIaaSError with code 'ADAPTER_NOT_AVAILABLE'
  </behavior>
  <implementation>
**Step 1 (RED): Write failing tests**

Add test describe block `getAssets()` to `packages/adapters/solana/src/__tests__/solana-adapter.test.ts`:

Mock RPC responses:
- `getBalance` returns `{ value: <bigint> }`
- `getTokenAccountsByOwner` returns `{ value: [{ account: { data: { parsed: { info: { mint, tokenAmount: { amount, decimals, uiAmountString } } }, type: 'account' } } }] }`

Use the existing mock pattern in the test file (vi.mock for @solana/kit RPC).

Write 6 test cases matching the behavior spec above. Run tests -- all 6 MUST fail (getAssets not implemented yet).

**Step 2 (GREEN): Implement**

1. Add `AssetInfo` interface to `packages/core/src/interfaces/chain-adapter.types.ts`
2. Uncomment and formalize `getAssets` in `packages/core/src/interfaces/IChainAdapter.ts` -- remove the `// v1.3 planned method:` comment and add the real method signature
3. Export `AssetInfo` from `packages/core/src/interfaces/index.ts` and `packages/core/src/index.ts`
4. Create `packages/core/src/schemas/asset.schema.ts` with `AssetInfoSchema` (Zod, with balance as string for JSON serialization)
5. Export from `packages/core/src/schemas/index.ts` and ensure it flows through `packages/core/src/index.ts`
6. Implement `getAssets()` in `packages/adapters/solana/src/adapter.ts`:
   - Import `TOKEN_PROGRAM_ADDRESS` from `@solana-program/token` (add `@solana-program/token` to adapter-solana dependencies if not present -- check first)
   - If `@solana-program/token` is not available, use the hard-coded SPL Token Program ID: `TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA`
   - Call `this.getRpc()` to ensure connected
   - `const balanceResult = await rpc.getBalance(address(addr)).send()`
   - `const tokenResult = await rpc.getTokenAccountsByOwner(address(addr), { programId: address(TOKEN_PROGRAM_ID) }, { encoding: 'jsonParsed' }).send()`
   - Build AssetInfo[] -- native SOL first, then non-zero SPL tokens
   - Wrap in try/catch -> WAIaaSError('CHAIN_ERROR')

Run tests -- all 6 MUST pass.

**Step 3 (REFACTOR): Clean up if needed**

Verify `pnpm build` succeeds for @waiaas/core and @waiaas/adapter-solana.
Verify existing tests still pass.
  </implementation>
</feature>

<verification>
1. `pnpm test --filter @waiaas/adapter-solana` -- all getAssets tests pass
2. `pnpm build --filter @waiaas/core` -- compiles with AssetInfo exported
3. `pnpm build --filter @waiaas/adapter-solana` -- compiles with getAssets() implemented
4. `pnpm test` (full suite) -- no regressions
5. TypeScript: `IChainAdapter` has `getAssets` method, `SolanaAdapter` implements it
</verification>

<success_criteria>
- CHAIN-01: IChainAdapter has getAssets(address: string): Promise<AssetInfo[]>
- CHAIN-02: SolanaAdapter.getAssets() uses getBalance + getTokenAccountsByOwner single RPC pattern
- AssetInfo type and AssetInfoSchema Zod schema exported from @waiaas/core
- 6 test cases covering normal, empty, zero-balance, error scenarios
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/58-openapihono-getassets/58-02-SUMMARY.md`
</output>
