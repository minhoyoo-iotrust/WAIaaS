---
phase: 89-db-migration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/infrastructure/database/index.ts
  - packages/daemon/src/__tests__/migration-runner.test.ts
autonomous: true

must_haves:
  truths:
    - "v3 migration renames agents table to wallets, preserving all existing data"
    - "5 FK columns (sessions, transactions, policies, audit_log, notification_logs) renamed from agent_id to wallet_id"
    - "All 10 agent-related indexes renamed to wallet-based pattern"
    - "audit_log.action AGENT_* values updated to WALLET_* (4 values)"
    - "notification_logs.event_type AGENT_SUSPENDED updated to WALLET_SUSPENDED"
    - "schema_version is 3 after migration"
    - "Drizzle schema exports wallets table definition matching new DB structure"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v3 migration (agents -> wallets rename, FK columns, indexes, enum data)"
      contains: "version: 3"
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "Drizzle schema with wallets table, walletId FK columns"
      contains: "wallets"
    - path: "packages/daemon/src/infrastructure/database/index.ts"
      provides: "Barrel export with wallets + agents backward-compat alias"
      contains: "wallets"
    - path: "packages/daemon/src/__tests__/migration-runner.test.ts"
      provides: "v3 migration tests: data preservation, FK rename, index rename, enum data update"
      contains: "v3 migration"
  key_links:
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "v3 migration SQL matches Drizzle schema definitions"
      pattern: "wallets"
    - from: "packages/daemon/src/infrastructure/database/index.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "barrel export re-exports wallets + backward-compat agents alias"
      pattern: "agents.*wallets|wallets.*agents"
---

<objective>
Implement schema_version 3 migration that renames the agents table to wallets throughout the SQLite database, including FK columns, indexes, and enum data values. Update the Drizzle ORM schema to match the new DB structure while providing a backward-compatible `agents` alias so existing daemon code continues to compile until Phase 91.

Purpose: Foundation for the v1.4.2 terminology change. All subsequent phases (90-94) depend on the DB layer being correct. By also updating the Drizzle schema, Phase 91 can focus on API/business logic changes rather than schema plumbing.

Output: v3 migration in migrate.ts, updated Drizzle schema.ts with wallets table, backward-compat index.ts exports, migration tests verifying all 5 requirements.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase that established migration patterns
@.planning/phases/85-db-migration/85-01-SUMMARY.md

# Files to modify
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/index.ts
@packages/daemon/src/__tests__/migration-runner.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED -- Write failing tests for v3 migration (agents -> wallets)</name>
  <files>packages/daemon/src/__tests__/migration-runner.test.ts</files>
  <action>
Add a new `describe('v3 migration: rename agents to wallets')` block in migration-runner.test.ts, following the exact same pattern as the existing `describe('v2 migration: expand agents network CHECK for EVM')` block. Use a dedicated v2-only database (manual schema with v2-applied CHECK constraints) so the v3 migration can be explicitly tested.

Create a `createV2Database()` helper that:
- Creates an in-memory DB
- Creates `agents` table with full v2 CHECK constraints (using CHAIN_TYPES, NETWORK_TYPES, AGENT_STATUSES SSoT arrays)
- Creates `sessions`, `transactions`, `policies`, `audit_log`, `notification_logs` tables with `agent_id` FK columns
- Creates all `idx_agents_*` and `idx_*_agent_*` indexes
- Inserts schema_version rows for v1 and v2
- Does NOT create pending_approvals, key_value_store (they have no agent_id columns)

Write these test cases (all should FAIL initially since v3 migration doesn't exist yet):

1. **should rename agents table to wallets with all data preserved** - Insert 3 agents with different chains/networks/statuses. Run v3 migration. Verify `wallets` table has 3 rows with identical data. Verify `agents` table does NOT exist (SELECT from agents should throw).

2. **should rename agent_id columns to wallet_id in 5 FK tables** - Insert agent, session, transaction, policy, audit_log entry, notification_log entry. Run v3 migration. Verify each table's `wallet_id` column contains the original agent ID value. Verify `agent_id` column does NOT exist in any of the 5 tables (PRAGMA table_info check).

3. **should rename all agent-related indexes to wallet pattern** - Run v3 migration. Use `PRAGMA index_list` on wallets, sessions, transactions, policies, audit_log, notification_logs. Verify index names match `idx_wallets_*` or `idx_*_wallet_*` patterns. Verify NO index names contain `idx_agents_` or `_agent_`.

4. **should update audit_log.action AGENT_* values to WALLET_*** - Insert 4 audit_log rows with event_type = AGENT_CREATED, AGENT_ACTIVATED, AGENT_SUSPENDED, AGENT_TERMINATED. Also insert 2 non-agent audit entries (TX_REQUESTED, SESSION_ISSUED) that should NOT change. Run v3 migration. Verify AGENT_* values are 0 and WALLET_* values are 4. Verify TX_REQUESTED and SESSION_ISSUED unchanged.

5. **should update notification_logs.event_type AGENT_SUSPENDED to WALLET_SUSPENDED** - Insert 2 notification_logs: one AGENT_SUSPENDED, one TX_CONFIRMED. Run v3 migration. Verify AGENT_SUSPENDED count is 0, WALLET_SUSPENDED count is 1, TX_CONFIRMED unchanged.

6. **should set schema_version to 3** - Run v3 migration. Verify schema_version table contains version 3 with non-null applied_at and description.

7. **should pass foreign_key_check after migration** - Insert agent + session + transaction + policy (FK chain). Run v3 migration. Verify `PRAGMA foreign_key_check` returns empty array. Verify session.wallet_id references wallets.id via SELECT JOIN.

Run `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/migration-runner.test.ts` -- all 7 new tests should FAIL (v3 migration not implemented).
  </action>
  <verify>Run `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/migration-runner.test.ts` -- expect the 7 new tests to FAIL while existing tests PASS.</verify>
  <done>7 new test cases added in `describe('v3 migration')` block, all failing with clear error messages (v3 migration not found or table not renamed).</done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN -- Implement v3 migration + update Drizzle schema + backward-compat alias</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/infrastructure/database/index.ts
    packages/daemon/src/__tests__/migration-runner.test.ts
  </files>
  <action>
**Part A: Implement v3 migration in migrate.ts**

Add a new MIGRATIONS.push() entry for version 3 with `managesOwnTransaction: true` (because it needs PRAGMA foreign_keys=OFF for table recreation). The migration description should be `'Rename agents to wallets (table, FK columns, indexes, enum data)'`.

The v3 up() function must execute these steps IN ORDER within a single BEGIN/COMMIT:

```
sqlite.exec('BEGIN');
try {
  // Step 1: Rename agents table to wallets
  sqlite.exec('ALTER TABLE agents RENAME TO wallets');

  // Step 2: Recreate 5 FK tables with wallet_id columns
  // For each of: sessions, transactions, policies, audit_log, notification_logs:
  //   a. CREATE TABLE {table}_new with wallet_id instead of agent_id
  //   b. INSERT INTO {table}_new SELECT ... (mapping agent_id to wallet_id)
  //   c. DROP TABLE {table}
  //   d. ALTER TABLE {table}_new RENAME TO {table}

  // Sessions: wallet_id NOT NULL REFERENCES wallets(id) ON DELETE CASCADE
  // Transactions: wallet_id NOT NULL REFERENCES wallets(id) ON DELETE RESTRICT
  // Policies: wallet_id REFERENCES wallets(id) ON DELETE CASCADE (nullable)
  // Audit_log: wallet_id (no FK constraint, just column rename)
  // Notification_logs: wallet_id (no FK constraint, just column rename)

  // Step 3: Recreate all indexes with wallet naming
  // wallets table:
  //   idx_wallets_public_key (UNIQUE), idx_wallets_status, idx_wallets_chain_network, idx_wallets_owner_address
  // sessions:
  //   idx_sessions_wallet_id (was agent_id)
  // transactions:
  //   idx_transactions_wallet_status (was agent_status) on (wallet_id, status)
  // policies:
  //   idx_policies_wallet_enabled (was agent_enabled) on (wallet_id, enabled)
  // audit_log:
  //   idx_audit_log_wallet_id, idx_audit_log_wallet_timestamp on (wallet_id, timestamp)
  // notification_logs:
  //   idx_notification_logs_wallet_id
  // (Other non-agent indexes remain unchanged: idx_sessions_expires_at, idx_sessions_token_hash,
  //  idx_transactions_session_id, idx_transactions_tx_hash, etc.)

  // Step 4: UPDATE audit_log.event_type data
  // UPDATE audit_log SET event_type = 'WALLET_CREATED' WHERE event_type = 'AGENT_CREATED'
  // UPDATE audit_log SET event_type = 'WALLET_ACTIVATED' WHERE event_type = 'AGENT_ACTIVATED'
  // UPDATE audit_log SET event_type = 'WALLET_SUSPENDED' WHERE event_type = 'AGENT_SUSPENDED'
  // UPDATE audit_log SET event_type = 'WALLET_TERMINATED' WHERE event_type = 'AGENT_TERMINATED'

  // Step 5: UPDATE notification_logs.event_type data
  // UPDATE notification_logs SET event_type = 'WALLET_SUSPENDED' WHERE event_type = 'AGENT_SUSPENDED'

  sqlite.exec('COMMIT');
} catch (err) {
  sqlite.exec('ROLLBACK');
  throw err;
}

// Re-enable FK and verify integrity (same pattern as v2)
sqlite.pragma('foreign_keys = ON');
const fkErrors = sqlite.pragma('foreign_key_check') as unknown[];
if (fkErrors.length > 0) {
  throw new Error(`FK integrity check failed after v3 migration: ${JSON.stringify(fkErrors)}`);
}
```

IMPORTANT implementation notes:
- SQLite ALTER TABLE RENAME TO only renames the table, not FK references. We must recreate FK-referencing tables.
- When recreating sessions/transactions/policies, their FK column names change to `wallet_id` AND their FK target changes from `agents(id)` to `wallets(id)`.
- audit_log and notification_logs have no FK constraints on agent_id, but we still recreate them to rename the column.
- All non-agent-related indexes (e.g., idx_sessions_expires_at, idx_transactions_tx_hash, etc.) must be recreated too because dropping and recreating a table drops its indexes.
- The `event_type` column in audit_log is what stores AGENT_CREATED etc. (not `action`). Verify by checking the schema.
- For the DDL: use the same CHECK constraints from current SSoT arrays (CHAIN_TYPES, NETWORK_TYPES, etc.) via the existing `inList()` helper. For the AGENT_STATUSES in the wallets table CHECK, continue using AGENT_STATUSES from @waiaas/core (those status VALUES don't change -- CREATING/ACTIVE/SUSPENDED are status states, not agent/wallet terms). Phase 90 will rename AGENT_STATUSES to WALLET_STATUSES.
- Use TRANSACTION_TYPES, TRANSACTION_STATUSES, POLICY_TIERS, POLICY_TYPES, NOTIFICATION_LOG_STATUSES from @waiaas/core for CHECK constraints in recreated tables.

Also update getCreateTableStatements() and getCreateIndexStatements() in migrate.ts:
- Change `agents` table to `wallets` in DDL
- Change `agent_id` to `wallet_id` in sessions, transactions, policies, audit_log, notification_logs DDL
- Change FK references from `agents(id)` to `wallets(id)`
- Change index names from `idx_agents_*` to `idx_wallets_*` and `idx_*_agent_*` to `idx_*_wallet_*`

**Part B: Update Drizzle schema.ts**

Rename the Drizzle table definition:
- `export const agents = sqliteTable('agents', ...)` -> `export const wallets = sqliteTable('wallets', ...)`
- In `sessions`: rename `agentId` field to `walletId`, change `text('agent_id')` to `text('wallet_id')`, update FK reference from `agents.id` to `wallets.id`
- In `transactions`: same rename agentId -> walletId, agent_id -> wallet_id, agents.id -> wallets.id
- In `policies`: same rename
- In `auditLog`: rename `agentId` to `walletId`, `text('agent_id')` to `text('wallet_id')`
- In `notificationLogs`: same rename
- Update all index names: `idx_agents_*` -> `idx_wallets_*`, `idx_*_agent_*` -> `idx_*_wallet_*`
- Keep the AGENT_STATUSES import unchanged (Phase 90 renames it)

**Part C: Update index.ts barrel export**

- Change `export { agents, ... }` to `export { wallets, ... }` from schema.js
- Add backward-compat alias: `export { wallets as agents }` so existing daemon code continues to compile until Phase 91

**Part D: Fix existing tests if needed**

The migration-runner.test.ts existing v2 tests reference `agents` table. The pushSchema() call in beforeEach now creates `wallets` table (not `agents`). Update existing tests:
- In v2 migration tests, the v1-only database still creates `agents` table (that's the point -- testing migration from v1). The v2 migration result is now `wallets` table after v3 runs. BUT: v2 tests use a v1-only DB and only run v2. After v2, table is still named `agents`. The v3 migration tests use a v2-only DB. So v2 tests should be unaffected IF they don't run pushSchema() auto-migrations.
- In the main `beforeEach` that calls `pushSchema(sqlite)`: after this call, the DB has the latest schema (wallets table). Update any top-level test references from `agents` table to `wallets` table.
- Run the full daemon test suite to identify and fix any other test regressions.

Run `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/migration-runner.test.ts` -- all tests (old + new) should PASS.
Run `pnpm --filter @waiaas/daemon exec vitest run` -- full daemon test suite to verify no regressions (noting that tsc may have type errors in non-test files due to agents->wallets rename, but vitest can still run tests).
  </action>
  <verify>
1. `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/migration-runner.test.ts` -- all tests pass (old + 7 new)
2. `pnpm --filter @waiaas/daemon exec vitest run` -- full daemon test suite passes (or document expected failures from schema rename awaiting Phase 91)
  </verify>
  <done>
- v3 migration implemented in MIGRATIONS array, renames agents->wallets at SQL level
- Drizzle schema.ts uses `wallets` table name and `walletId` field names
- index.ts exports `wallets` + backward-compat `agents` alias
- schema_version 3 recorded with description
- All 7 new migration tests pass
- FK integrity verified post-migration
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **DB-01**: Run v3 migration on v2 DB. `SELECT * FROM wallets` succeeds, `SELECT * FROM agents` throws "no such table".
2. **DB-02**: `PRAGMA table_info(sessions)` shows `wallet_id`, no `agent_id`. Same for transactions, policies, audit_log, notification_logs.
3. **DB-03**: `PRAGMA index_list(wallets)` shows `idx_wallets_*`. No `idx_agents_*` pattern anywhere.
4. **DB-04**: `SELECT COUNT(*) FROM audit_log WHERE event_type LIKE 'AGENT_%'` = 0. `SELECT COUNT(*) FROM audit_log WHERE event_type LIKE 'WALLET_%'` = 4.
5. **DB-05**: `SELECT COUNT(*) FROM notification_logs WHERE event_type = 'AGENT_SUSPENDED'` = 0. `SELECT COUNT(*) FROM notification_logs WHERE event_type = 'WALLET_SUSPENDED'` = 1.
6. `SELECT MAX(version) FROM schema_version` = 3.
7. FK integrity: `PRAGMA foreign_key_check` returns empty array.
</verification>

<success_criteria>
- v3 migration exists in MIGRATIONS array and executes successfully on both fresh DB (pushSchema) and existing v2 DB
- All 7 new tests pass, verifying data preservation, FK rename, index rename, enum data update, FK integrity
- Drizzle schema.ts defines `wallets` table (not `agents`)
- index.ts provides backward-compat `agents` alias for Phase 91 migration
- schema_version is 3
- No test regressions in migration-runner.test.ts
</success_criteria>

<output>
After completion, create `.planning/phases/89-db-migration/89-01-SUMMARY.md`
</output>
