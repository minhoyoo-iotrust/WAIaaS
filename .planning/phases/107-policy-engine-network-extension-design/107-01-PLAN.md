---
phase: 107-policy-engine-network-extension-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/71-policy-engine-network-extension-design.md]
autonomous: true

must_haves:
  truths:
    - "ALLOWED_NETWORKS PolicyType의 Zod 스키마(AllowedNetworksRulesSchema), 평가 의사코드(evaluateAllowedNetworks), 미설정 시 permissive default 동작이 정의되어 있다"
    - "기존 정책의 network 필드 추가 스키마와 4단계 override 우선순위(wallet+network > wallet+null > global+network > global+null)가 resolveOverrides() 확장 의사코드로 명시되어 있다"
    - "policies 테이블 v8 마이그레이션(12-step 재생성)이 network 컬럼 추가 + type CHECK ALLOWED_NETWORKS 포함 + network CHECK 포함으로 설계되어 있다"
    - "TransactionParam.network + IPolicyEngine.evaluate() 시그니처 확장 + buildTransactionParam() 변경이 설계되어 있다"
    - "evaluateAndReserve() raw SQL에 network 필터 조건 추가가 명시되어 있다"
  artifacts:
    - path: "docs/71-policy-engine-network-extension-design.md"
      provides: "ALLOWED_NETWORKS 스키마/평가/override + policies v8 마이그레이션 + 인터페이스 확장 통합 설계"
      contains: "ALLOWED_NETWORKS"
  key_links:
    - from: "docs/71 (ALLOWED_NETWORKS 평가)"
      to: "docs/70 (PipelineContext.resolvedNetwork)"
      via: "Stage 3에서 ctx.resolvedNetwork를 ALLOWED_NETWORKS 평가에 전달"
      pattern: "resolvedNetwork"
    - from: "docs/71 (v8 마이그레이션)"
      to: "docs/69 (v6b 마이그레이션)"
      via: "v6b(version 7) 이후 v8(version 8) 순서"
      pattern: "version.*8"
    - from: "docs/71 (POLICY_TYPES 확장)"
      to: "packages/core/src/enums/policy.ts"
      via: "POLICY_TYPES SSoT 배열에 ALLOWED_NETWORKS 추가"
      pattern: "ALLOWED_NETWORKS"
---

<objective>
ALLOWED_NETWORKS 11번째 PolicyType + 네트워크 스코프 정책 + policies 테이블 v8 마이그레이션 통합 설계 문서(docs/71) 작성

Purpose: 정책 엔진이 네트워크 단위로 트랜잭션을 제어할 수 있는 확장을 설계하여, v1.4.6 구현자가 코드 레벨 변경을 수행할 수 있는 완전한 명세를 제공한다
Output: docs/71-policy-engine-network-extension-design.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/107-policy-engine-network-extension-design/107-RESEARCH.md

# Prior phase outputs (Phase 107 depends on 105+106)
@.planning/phases/106-pipeline-network-resolve-design/106-01-SUMMARY.md
@.planning/phases/105-environment-data-model-db-migration/105-02-SUMMARY.md

# Design documents to reference and extend
@docs/70-pipeline-network-resolve-design.md
@docs/69-db-migration-v6-design.md
@docs/68-environment-data-model-design.md

# Source code to reference for accurate pseudocode
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/core/src/enums/policy.ts
@packages/core/src/schemas/policy.schema.ts
@packages/core/src/interfaces/IPolicyEngine.ts
@packages/daemon/src/api/routes/policies.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/pipeline/stages.ts
@packages/core/src/enums/chain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ALLOWED_NETWORKS PolicyType + 네트워크 스코프 정책 설계 (docs/71 섹션 1~5)</name>
  <files>docs/71-policy-engine-network-extension-design.md</files>
  <action>
docs/71-policy-engine-network-extension-design.md를 생성하고 아래 내용을 작성한다. 설계 문서 패턴은 docs/70을 따른다.

**섹션 1: 개요 + 설계 범위**
- Phase 107의 목표 (정책 엔진 네트워크 인식 확장)
- 변경 대상 정리: POLICY_TYPES SSoT 배열, Zod 스키마, DatabasePolicyEngine, IPolicyEngine, TransactionParam, policies 테이블, Stage 3 연동
- 참조 문서: docs/68 (환경 매핑), docs/69 (마이그레이션 v6a/v6b), docs/70 (파이프라인 리졸브)

**섹션 2: ALLOWED_NETWORKS PolicyType 설계 (PLCY-01)**
- AllowedNetworksRulesSchema Zod 정의 (Research Pattern 1 기반):
  - `z.object({ networks: z.array(z.object({ network: NetworkTypeEnum, name: z.string().optional() })).min(1) })`
- POLICY_TYPES SSoT 배열에 'ALLOWED_NETWORKS' 추가 → PolicyTypeEnum 자동 파생 → DB CHECK 자동 동기화
- POLICY_RULES_SCHEMAS 맵에 `ALLOWED_NETWORKS: AllowedNetworksRulesSchema` 추가
- evaluateAllowedNetworks() 평가 의사코드:
  - 적용 대상: 모든 5-type (TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH)
  - 미설정 시: return null (permissive default -- 환경 내 전체 허용)
  - 설정 시: resolvedNetwork가 networks 목록에 없으면 deny
  - 비교: case-insensitive (toLowerCase)
  - 에러 메시지: "Network '{network}' not in allowed networks list. Allowed: {list}"
  - tier: INSTANT (즉시 거부)
- Stage 3 평가 순서에서 WHITELIST 직후 (Step 4a.5)에 배치하는 근거

**섹션 3: 네트워크 스코프 정책 설계 (PLCY-02)**
- policies.network 필드 의미: NULL=전체 네트워크, 값=해당 네트워크만
- CreatePolicyRequestSchema에 `network: NetworkTypeEnum.optional()` 추가
- 4단계 override 우선순위 표:
  1순위: wallet+network (walletId=W, network=N)
  2순위: wallet+null (walletId=W, network=NULL)
  3순위: global+network (walletId=NULL, network=N)
  4순위: global+null (walletId=NULL, network=NULL)
- resolveOverrides() 확장 의사코드 (Research Pattern 3 기반):
  - 기존 로직(typeMap[type] with wallet>global)을 4단계로 확장
  - 핵심: 낮은 우선순위부터 삽입, 높은 우선순위가 덮어씀 → typeMap[type] 키 유지 (복합키 불필요)
  - network=NULL 기존 정책은 2순위 또는 4순위에서 삽입 → 기존 동작 100% 하위호환
- 하위호환 증명: 기존 모든 정책이 network=NULL이면 4단계가 2단계와 동일한 결과

**섹션 4: 인터페이스 확장 설계**
- TransactionParam에 `network?: string` 추가 의사코드
- IPolicyEngine.evaluate() 시그니처: transaction 객체에 network 추가
- buildTransactionParam() 변경: `ctx.resolvedNetwork` 전달 (Phase 106 docs/70 섹션 5.3 참조)
- evaluateAndReserve() raw SQL 변경:
  - `AND (network = ? OR network IS NULL)` 조건 추가
  - 바인딩: resolvedNetwork
- evaluateBatch() 동일 변경 패턴

**섹션 5: 설계 결정 로그**
- PLCY-D01: ALLOWED_NETWORKS permissive default (not default deny) -- 기존 월렛 하위호환
- PLCY-D02: Stage 3 평가 순서 WHITELIST 직후 -- 네트워크 미허용 시 세부 정책 평가 무의미
- PLCY-D03: resolveOverrides() 4단계는 typeMap[type] 단일 키 유지 -- 복합키 불필요 증명
- PLCY-D04: policies.network을 DB 컬럼으로 (rules JSON 내부가 아닌) -- SQL 쿼리 최적화
- PLCY-D05: evaluateAndReserve() raw SQL에 network 필터 추가 -- ORM이 아닌 raw SQL이므로 직접 변경
  </action>
  <verify>docs/71-policy-engine-network-extension-design.md가 존재하고, 섹션 1~5가 모두 포함되어 있다. ALLOWED_NETWORKS 스키마, evaluateAllowedNetworks 의사코드, 4단계 override 의사코드, resolveOverrides 확장 코드, TransactionParam/IPolicyEngine 확장이 코드 블록으로 포함되어 있다.</verify>
  <done>PLCY-01(ALLOWED_NETWORKS 스키마+평가+순서)와 PLCY-02(네트워크 스코프+override+인터페이스)가 구현자가 코드 작성할 수 있는 수준의 의사코드로 완전 정의되어 있다</done>
</task>

<task type="auto">
  <name>Task 2: policies 테이블 v8 마이그레이션 설계 + 통합 검증 (docs/71 섹션 6~8)</name>
  <files>docs/71-policy-engine-network-extension-design.md</files>
  <action>
docs/71에 이어서 섹션 6~8을 추가한다.

**섹션 6: policies 테이블 v8 마이그레이션 설계 (PLCY-03)**
- 마이그레이션 전략: v8(version 8) = 12-step 재생성 (Research 권장 방안 채택)
  - 근거: network 컬럼 추가 + type CHECK에 ALLOWED_NETWORKS 추가 + network CHECK 추가를 원자적으로 처리
  - v6b(version 7) 직후이므로 스키마가 명확하고 12-step 패턴이 검증됨
- 12-step 재생성 상세 SQL (docs/69 v6b 패턴을 따름):
  Step 1: PRAGMA foreign_keys=OFF
  Step 2: BEGIN TRANSACTION
  Step 3: CREATE TABLE policies_new (기존 8컬럼 + network TEXT)
    - type CHECK: `type IN (${inList(POLICY_TYPES)})` -- ALLOWED_NETWORKS 포함
    - network CHECK: `network IS NULL OR network IN (${inList(NETWORK_TYPES)})`
  Step 4: INSERT INTO policies_new SELECT *, NULL FROM policies_old (기존 정책 network=NULL)
  Step 5: DROP TABLE policies
  Step 6: ALTER TABLE policies_new RENAME TO policies
  Step 7: CREATE INDEX idx_policies_wallet_enabled, idx_policies_type
  Step 8: CREATE INDEX idx_policies_network (NEW)
  Step 9: FK dependent 테이블 재생성 없음 (policies는 FK 참조 대상 아님, 참조하는 쪽만 -- 없음)
  Step 10: PRAGMA foreign_key_check
  Step 11: COMMIT
  Step 12: PRAGMA foreign_keys=ON
- managesOwnTransaction: true (12-step이므로 직접 트랜잭션 관리)
- v6b와의 차이: policies만 재생성 (FK dependent 없음), 기존 데이터에 network=NULL 삽입

**섹션 7: pushSchema DDL + Drizzle 스키마 동기화**
- pushSchema DDL 업데이트:
  - policies CREATE TABLE에 network 컬럼 추가
  - type CHECK에 ALLOWED_NETWORKS 포함
  - network CHECK 추가
  - LATEST_SCHEMA_VERSION = 7 -> 8
- Drizzle ORM 스키마 변경:
  - `network: text('network')` 추가
  - `index('idx_policies_network').on(table.network)` 추가
  - `check('check_policy_network', ...)` 추가
  - `check('check_policy_type', ...)` POLICY_TYPES에 ALLOWED_NETWORKS 자동 포함 확인

**섹션 8: 통합 검증 + 참조 관계**
- Phase 105/106/107 설계 통합 다이어그램:
  - docs/68 → docs/70 → docs/71 참조 체인
  - docs/69 v6b(version 7) → docs/71 v8(version 8) 마이그레이션 순서
- 마이그레이션 실행 순서: v6a(6) → v6b(7) → v8(8)
- 테스트 전략:
  1. ALLOWED_NETWORKS 평가 테스트 (설정/미설정/매칭/불매칭)
  2. resolveOverrides 4단계 테스트 (기존 동작 보존 + 4단계 우선순위)
  3. v8 마이그레이션 테스트 (빈 DB, 기존 데이터, CHECK 제약)
  4. 하위호환 테스트 (모든 기존 policy-engine 테스트 25개 통과)
- Phase 108 인터페이스로의 이행 포인트:
  - POST /v1/policies body에 network 필드 추가 (REST API)
  - MCP create_policy 도구에 network 파라미터 추가
  - SDK createPolicy()에 network 옵션 추가
  </action>
  <verify>docs/71의 섹션 6~8이 존재한다. v8 마이그레이션 12-step SQL이 Step 1~12로 명시되어 있다. pushSchema DDL에 LATEST_SCHEMA_VERSION=8과 network 컬럼이 포함되어 있다. 통합 다이어그램에 docs/68→70→71 참조 체인과 v6a→v6b→v8 마이그레이션 순서가 있다.</verify>
  <done>PLCY-03(v8 마이그레이션 12-step + pushSchema/Drizzle 동기화)가 copy-paste 수준 SQL로 완성되고, Phase 105/106/107 설계의 통합 참조 관계가 명확하다</done>
</task>

</tasks>

<verification>
1. docs/71-policy-engine-network-extension-design.md가 8개 섹션으로 존재
2. PLCY-01: AllowedNetworksRulesSchema + evaluateAllowedNetworks() 의사코드 + permissive default + 평가 순서
3. PLCY-02: 4단계 override 의사코드 + resolveOverrides() 확장 + TransactionParam/IPolicyEngine 확장 + evaluateAndReserve SQL
4. PLCY-03: v8 12-step SQL + pushSchema DDL + Drizzle 스키마 + LATEST_SCHEMA_VERSION=8
5. 설계 결정 5개 이상 기록 (PLCY-D01~D05)
6. Phase 108 이행 포인트 명시
</verification>

<success_criteria>
- docs/71이 존재하고 8개 섹션이 모두 작성됨
- 모든 의사코드가 코드 블록 안에 있고 구현자가 직접 변환할 수 있는 수준
- v8 마이그레이션 SQL이 12 Step으로 완전 명시
- Phase 105(docs/68, 69) + Phase 106(docs/70) + Phase 107(docs/71) 참조 체인이 명확
- PLCY-01, PLCY-02, PLCY-03 3개 요구사항이 모두 충족
</success_criteria>

<output>
After completion, create `.planning/phases/107-policy-engine-network-extension-design/107-01-SUMMARY.md`
</output>
