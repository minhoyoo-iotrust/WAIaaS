---
phase: 88-integration-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts
autonomous: true

must_haves:
  truths:
    - "5-type 트랜잭션(TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH + 레거시 TRANSFER)이 REST API를 통해 full pipeline E2E로 동작한다"
    - "MCP send_token이 TOKEN_TRANSFER type/token 파라미터로 E2E 동작한다"
    - "SDK send 메서드가 5-type 파라미터를 올바르게 전달한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts"
      provides: "5-type transaction pipeline E2E + MCP/SDK type verification tests"
      min_lines: 200
  key_links:
    - from: "pipeline-5type-e2e.test.ts"
      to: "pipeline/stages.ts stage1Validate"
      via: "POST /v1/transactions/send -> stage1Validate discriminatedUnion"
      pattern: "type.*TOKEN_TRANSFER|CONTRACT_CALL|APPROVE|BATCH"
    - from: "pipeline-5type-e2e.test.ts"
      to: "pipeline/stages.ts stage5Execute"
      via: "Type-specific adapter method dispatch (buildTokenTransfer, buildContractCall, buildApprove, buildBatch)"
      pattern: "buildTokenTransfer|buildContractCall|buildApprove|buildBatch"
---

<objective>
5가지 트랜잭션 타입이 REST API를 통해 파이프라인 전체(stage1-6)를 E2E로 통과하는 것을 검증하고, MCP/SDK의 type/token 파라미터 지원을 검증한다.

Purpose: Phase 86에서 구현한 5-type route + pipeline 통합과 MCP/SDK 확장이 실제 요청 흐름에서 올바르게 동작하는지 검증한다. 개별 unit test와 달리, 전체 앱 컨텍스트에서 stage1-6가 연쇄적으로 실행되는 것을 검증한다.

Output: `packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts` -- 5-type pipeline E2E + MCP/SDK 통합 검증 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern references
@packages/daemon/src/__tests__/api-transactions.test.ts
@packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts

# Implementation references
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/openapi-schemas.ts

# MCP/SDK references
@packages/mcp/src/__tests__/tools.test.ts
@packages/sdk/src/__tests__/client.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 5-type transaction full pipeline E2E tests</name>
  <files>packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts</files>
  <action>
Create `packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts` following the established E2E test pattern.

**Test infrastructure setup (same pattern as session-lifecycle-e2e.test.ts):**
- In-memory SQLite + pushSchema + full deps
- createApp() with all dependencies
- masterAuth + sessionAuth helpers

**Mock adapter with full 5-type support:**
Create a mock IChainAdapter that implements ALL 20 methods including 5-type builder methods:
- `buildTransaction(agentAddress, params)` -> returns mock UnsignedTransaction (for legacy TRANSFER)
- `buildTokenTransfer(agentAddress, params)` -> returns mock UnsignedTransaction (for TOKEN_TRANSFER). Call is trackable via vi.fn().
- `buildContractCall(agentAddress, params)` -> returns mock UnsignedTransaction (for CONTRACT_CALL). Trackable.
- `buildApprove(agentAddress, params)` -> returns mock UnsignedTransaction (for APPROVE). Trackable.
- `buildBatch(agentAddress, params)` -> returns mock UnsignedTransaction (for BATCH). Trackable.
- `simulateTransaction` -> success
- `signTransaction` -> mock bytes
- `submitTransaction` -> mock hash + submitted
- `waitForConfirmation` -> confirmed
- `getTokenInfo(tokenAddress)` -> returns { symbol: 'USDC', decimals: 6, name: 'USD Coin' }

Use vi.fn() for each build method so we can verify which adapter method was called for each type.

**Test suite 1: "5-Type Transaction Pipeline E2E" (6 tests):**

1. **"Legacy TRANSFER (no type field) -> calls buildTransaction"**
   - POST /v1/transactions/send with { to: '...', amount: '1000000000' } (no type field)
   - Wait for pipeline completion (short delay + poll DB)
   - Verify: 201, DB row has type='TRANSFER', adapter.buildTransaction was called, status reaches CONFIRMED

2. **"TRANSFER type -> calls buildTransaction"**
   - POST with { type: 'TRANSFER', to: '...', amount: '1000000000' }
   - Verify: DB type='TRANSFER', buildTransaction called, CONFIRMED

3. **"TOKEN_TRANSFER type -> calls buildTokenTransfer"**
   - POST with { type: 'TOKEN_TRANSFER', to: '...', amount: '1000000', token: { address: 'So11111111111111111111111111111111111111112', decimals: 6, symbol: 'USDC' } }
   - Verify: DB type='TOKEN_TRANSFER', adapter.buildTokenTransfer was called, CONFIRMED

4. **"CONTRACT_CALL type -> calls buildContractCall"**
   - POST with { type: 'CONTRACT_CALL', contractAddress: '0x1234...', calldata: '0xabcdef', amount: '0' }
   - Verify: DB type='CONTRACT_CALL', adapter.buildContractCall was called, CONFIRMED

5. **"APPROVE type -> calls buildApprove"**
   - POST with { type: 'APPROVE', token: { address: '0xA0b8...', decimals: 18, symbol: 'USDC' }, spender: '0x7a25...', amount: '1000000' }
   - Verify: DB type='APPROVE', adapter.buildApprove was called, CONFIRMED

6. **"BATCH type -> calls buildBatch"**
   - POST with { type: 'BATCH', instructions: [{ type: 'TRANSFER', to: '...', amount: '100' }, { type: 'TRANSFER', to: '...', amount: '200' }] }
   - Verify: DB type='BATCH', adapter.buildBatch was called, CONFIRMED

**Test suite 2: "MCP send_token Type Support" (2 tests):**

7. **"MCP send_token with type=TRANSFER passes to API"**
   - Use the MCP tool handler test pattern from `tools.test.ts`
   - Create mock ApiClient, register send_token tool, call handler with { to: '...', amount: '100' }
   - Verify: apiClient.post called with /v1/transactions/send and { to, amount } (no type = TRANSFER fallback)

8. **"MCP send_token with type=TOKEN_TRANSFER and token"**
   - Call handler with { to: '...', amount: '100', type: 'TOKEN_TRANSFER', token: '{"address":"0x...","decimals":6,"symbol":"USDC"}' }
   - Verify: apiClient.post called with correct type + token fields
   - Verify: CONTRACT_CALL type is rejected or not available as option (MCPSDK-04)

**Test suite 3: "SDK 5-Type Support" (2 tests):**

9. **"TS SDK sendToken with type + token"**
   - Use the SDK client test pattern from `client.test.ts`
   - Create client with mock fetch, call sendToken with type: 'TOKEN_TRANSFER' + token params
   - Verify: fetch called with correct body containing type and token fields

10. **"TS SDK sendToken with legacy (no type) backward compat"**
    - Call sendToken with only { to, amount } (no type field)
    - Verify: fetch called with { to, amount } (no type key in body)

**Important implementation notes:**
- For pipeline E2E tests (suite 1), the pipeline runs fire-and-forget after POST returns 201. Use a short wait (100ms) then check the DB directly: `sqlite.prepare('SELECT status, type FROM transactions WHERE id = ?').get(txId)`. The mock adapter resolves immediately so pipeline should complete within ~50ms.
- For MCP/SDK tests (suites 2-3), these are mock-based integration tests verifying parameter passing, not full server E2E. This is consistent with existing MCP/SDK test patterns.
- Ensure the mock adapter's build methods are vi.fn() so we can assert `.toHaveBeenCalled()` and inspect parameters.
- Use the same mockConfig() pattern as existing tests (full DaemonConfig with all keys).
  </action>
  <verify>
Run: `npx vitest run packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts`
All 10 tests pass. No regressions: `npx vitest run --project daemon`.
  </verify>
  <done>
10 E2E/integration tests pass:
- 6 pipeline E2E tests verify each type calls the correct adapter method and reaches CONFIRMED
- 2 MCP tests verify send_token type/token parameter passing
- 2 SDK tests verify sendToken 5-type parameter support
- All transactions correctly stored with proper type in DB
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts` -- all tests pass
2. `npx vitest run --project daemon` -- no regressions in daemon package
3. Tests verify: stage1Validate discriminatedUnion, type-specific adapter dispatch in stage5, MCP/SDK parameter passing
</verification>

<success_criteria>
- All 5 transaction types flow through complete pipeline (stage1-6) and reach CONFIRMED
- Legacy TRANSFER (no type field) backward compatibility verified
- MCP send_token correctly passes type/token parameters
- SDK sendToken correctly passes 5-type parameters
- Type field persisted correctly in transactions DB table
</success_criteria>

<output>
After completion, create `.planning/phases/88-integration-verification/88-02-SUMMARY.md`
</output>
