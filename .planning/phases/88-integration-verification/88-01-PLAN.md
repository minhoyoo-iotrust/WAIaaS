---
phase: 88-integration-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts
autonomous: true

must_haves:
  truths:
    - "EVM 에이전트 생성 -> 잔액 조회 -> ETH 전송 -> CONFIRMED까지 E2E 파이프라인이 동작한다"
    - "Solana + EVM 에이전트를 동시에 운용하고 각각 트랜잭션을 실행할 수 있다"
    - "SIWE owner-auth가 EVM 에이전트에 대해 E2E로 동작한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts"
      provides: "EVM full lifecycle E2E + dual chain + SIWE owner-auth E2E tests"
      min_lines: 200
  key_links:
    - from: "evm-lifecycle-e2e.test.ts"
      to: "api/server.ts createApp()"
      via: "Hono app.request() with full deps"
      pattern: "createApp.*adapterPool"
    - from: "evm-lifecycle-e2e.test.ts"
      to: "adapter-pool.ts resolve()"
      via: "Mock AdapterPool that returns EVM mock adapter"
      pattern: "resolve.*ethereum"
---

<objective>
EVM 에이전트의 풀 라이프사이클(생성 -> 잔액 조회 -> ETH 전송 -> CONFIRMED)을 E2E 테스트로 검증하고, Solana + EVM 동시 운용을 검증한다.

Purpose: Phase 82-87에서 개별적으로 구현된 EVM 인프라(config, keystore, adapter pool, DB migration, REST API, owner-auth)가 실제 API 요청 흐름에서 올바르게 통합되는지 검증한다.

Output: `packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts` -- EVM E2E + 듀얼 체인 + SIWE owner-auth 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern references -- existing E2E tests to follow
@packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts
@packages/daemon/src/__tests__/workflow-owner-e2e.test.ts

# Infrastructure references
@packages/daemon/src/api/server.ts
@packages/daemon/src/infrastructure/adapter-pool.ts
@packages/daemon/src/api/routes/agents.ts
@packages/daemon/src/api/routes/wallet.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/middleware/owner-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: EVM full lifecycle E2E + dual chain + SIWE owner-auth tests</name>
  <files>packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts</files>
  <action>
Create `packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts` following the established E2E test pattern from `session-lifecycle-e2e.test.ts`.

**Test infrastructure setup (same pattern as session-lifecycle-e2e.test.ts):**
- In-memory SQLite + pushSchema + full deps (db, jwtSecretManager, config, policyEngine, delayQueue, approvalWorkflow, ownerLifecycle)
- createApp() with full dependencies including adapterPool
- masterAuth + sessionAuth helper functions for API calls

**Mock adapters:**
- `createMockEvmAdapter()`: Returns IChainAdapter with chain='ethereum', network='ethereum-sepolia'. Implements all 20 methods. getBalance returns 1 ETH (1000000000000000000n, decimals=18, symbol='ETH'). buildTransaction returns a mock unsigned tx. simulateTransaction returns success. signTransaction returns mock bytes. submitTransaction returns mock hash. waitForConfirmation returns confirmed.
- `createMockSolanaAdapter()`: Same pattern but chain='solana', network='devnet', balance 1 SOL (1000000000n, decimals=9, symbol='SOL').
- `createMockAdapterPool(adapters)`: Takes a map of chain:network -> adapter. The resolve() mock returns the appropriate adapter based on chain+network args. disconnectAll is vi.fn().

**Mock keyStore:**
- generateKeyPair: When called with chain='ethereum', returns a 0x-prefixed EIP-55 address (e.g., '0x71C7656EC7ab88b098defB751B7401B5f6d8976F'). When called with 'solana' (or default), returns a Solana base58 address.
- Use vi.fn() so call parameters can be inspected (verify chain and network are passed).

**Test suite 1: "EVM Agent Full Lifecycle E2E" (4 tests):**

1. **"Create EVM agent -> returns 201 with 0x address"**
   - POST /v1/agents with { name: 'evm-test', chain: 'ethereum', network: 'ethereum-sepolia' }
   - Verify: 201, body has id/name/chain='ethereum'/network='ethereum-sepolia'/publicKey starts with '0x'

2. **"GET /v1/wallet/balance returns ETH balance for EVM agent"**
   - Create EVM agent, create session, GET /v1/wallet/balance with sessionAuth
   - Verify: 200, body has balance/decimals=18/symbol='ETH'

3. **"POST /v1/transactions/send -> CONFIRMED for EVM agent"**
   - Create EVM agent, create session, POST /v1/transactions/send with { to: '0x742d35Cc6634C0532925a3b844Bc9e7595916Da2', amount: '1000000000000000000' }
   - Verify: 201, txId returned. Then GET /v1/transactions/:id returns status eventually 'CONFIRMED'.
   - Note: Pipeline runs async fire-and-forget. Use a short setTimeout/retry or check DB directly for CONFIRMED status.

4. **"EVM agent with SIWE owner-auth"**
   - Create EVM agent, set owner (PUT /v1/agents/:id/owner) with valid EIP-55 address
   - Create session, then call an endpoint requiring ownerAuth with SIWE headers (X-Owner-Signature, X-Owner-Message base64-encoded, X-Owner-Address)
   - Use viem's `privateKeyToAccount` + `signMessage` for generating valid SIWE signatures
   - Verify: The ownerAuth middleware accepts the SIWE signature for ethereum chain agents

**Test suite 2: "Dual Chain Simultaneous Operation" (2 tests):**

5. **"Solana + EVM agents coexist and operate independently"**
   - Create Solana agent (chain='solana', network='devnet') and EVM agent (chain='ethereum', network='ethereum-sepolia')
   - Create sessions for both
   - GET /v1/wallet/balance for both: Solana returns SOL, EVM returns ETH
   - POST /v1/transactions/send for both agents
   - Verify: Both return 201 with different txIds. adapterPool.resolve was called with correct chain:network for each.

6. **"List agents shows both chains"**
   - Create both Solana and EVM agents
   - GET /v1/agents (masterAuth)
   - Verify: Response items include both, with correct chain/network values

**Important implementation notes:**
- The pipeline stages 2-6 run async (fire-and-forget). For test 3, after POST returns 201, wait briefly (e.g., `await new Promise(r => setTimeout(r, 100))`) then check the transaction row in SQLite directly for CONFIRMED status, or poll GET /v1/transactions/:id.
- For the SIWE owner-auth test (test 4): Use `viem` to generate a real SIWE message and signature. Create a test wallet with `privateKeyToAccount('0x...')`, compose a SIWE message string (EIP-4361 format), sign it with `signMessage`, base64-encode the message for the header. The verifySIWE function in the middleware will verify the signature. Since this is a test, use a hardcoded private key.
- Use vi.useFakeTimers() if needed for any time-sensitive logic, but real timers are fine for this E2E since the mock adapter resolves immediately.
- Follow the config pattern from existing E2E tests (full DaemonConfig with all EVM RPC keys).
  </action>
  <verify>
Run: `npx vitest run packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts`
All 6 tests pass. No test regressions when running full daemon suite: `npx vitest run --project daemon`.
  </verify>
  <done>
6 E2E tests pass:
- EVM agent creation returns 0x address
- EVM balance returns ETH with correct decimals
- EVM transfer flows through pipeline to CONFIRMED
- SIWE owner-auth works for EVM agents
- Dual chain agents operate independently
- Agent list shows both chains correctly
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts` -- all tests pass
2. `npx vitest run --project daemon` -- no regressions in daemon package
3. Tests exercise: createApp with adapterPool, EVM agent creation, EVM balance query, EVM transaction pipeline, SIWE auth, dual-chain coexistence
</verification>

<success_criteria>
- EVM full lifecycle (create -> balance -> send -> confirm) verified end-to-end through Hono API
- Solana + EVM dual operation verified in same test run
- SIWE owner-auth verified for EVM agents end-to-end
- Zero test regressions in daemon package
</success_criteria>

<output>
After completion, create `.planning/phases/88-integration-verification/88-01-SUMMARY.md`
</output>
