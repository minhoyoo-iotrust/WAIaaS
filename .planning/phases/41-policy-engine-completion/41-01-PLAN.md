---
phase: 41-policy-engine-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/33-time-lock-approval-mechanism.md
autonomous: true

must_haves:
  truths:
    - "25-sqlite §4.4 rules 컬럼 설명에서 'LOCK-MECH Phase 8에서 확정' 이연 표기가 제거되고, 33-time-lock §2.2 PolicyRuleSchema SSoT 참조가 명시되어 있다"
    - "25-sqlite §4.4 JSON 예시 블록 헤더에서 'Phase 8 LOCK-MECH에서 확정' 이연 표기가 제거되고, SSoT 참조로 교체되어 있다"
    - "33-time-lock §3.2 evaluate() evaluateSpendingLimit()의 APPROVAL 반환부에 3단계 타임아웃 우선순위(정책별 > 글로벌 config > 하드코딩 3600초)가 주석/의사코드로 명시되어 있다"
  artifacts:
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "PolicyRuleSchema SSoT 교차 참조"
      contains: "SSoT: 33-time-lock"
    - path: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      provides: "APPROVAL 타임아웃 3단계 우선순위"
      contains: "policy_defaults_approval_timeout"
  key_links:
    - from: ".planning/deliverables/25-sqlite-schema.md"
      to: ".planning/deliverables/33-time-lock-approval-mechanism.md"
      via: "SSoT 교차 참조 (rules 컬럼 -> PolicyRuleSchema §2.2)"
      pattern: "SSoT.*33-time-lock.*2\\.2"
---

<objective>
25-sqlite의 PolicyRuleSchema 이연 표기를 제거하고 33-time-lock SSoT 참조로 교체한다 (PLCY-01). 33-time-lock evaluate()에 APPROVAL 타임아웃 3단계 우선순위를 명시한다 (PLCY-03).

Purpose: 구현자가 rules 컬럼의 JSON 구조를 즉시 찾고, APPROVAL 타임아웃 결정 로직을 추측 없이 구현할 수 있게 한다.
Output: 25-sqlite-schema.md 2곳 수정, 33-time-lock-approval-mechanism.md 1곳 수정
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/phases/41-policy-engine-completion/41-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 25-sqlite §4.4 rules 컬럼 이연 표기 제거 + SSoT 참조 추가 (PLCY-01)</name>
  <files>.planning/deliverables/25-sqlite-schema.md</files>
  <action>
25-sqlite-schema.md §4.4 컬럼 설명 테이블에서 두 곳을 수정한다:

**수정 1 -- 컬럼 설명 테이블 (480행 부근):**

현재 텍스트:
```
| `rules` | TEXT (JSON) | NOT NULL | - | 정책별 규칙 JSON. LOCK-MECH (Phase 8)에서 각 type별 JSON 구조 확정 |
```

교체 텍스트:
```
| `rules` | TEXT (JSON) | NOT NULL | - | 정책별 규칙 JSON. **SSoT: 33-time-lock-approval-mechanism.md §2.2 PolicyRuleSchema** (10개 PolicyType의 Zod discriminatedUnion). 각 type별 JSON 구조와 필드 제약을 정의 |
```

**수정 2 -- JSON 예시 블록 헤더 (486행 부근):**

현재 텍스트:
```
**rules JSON 구조 예시 (Phase 8 LOCK-MECH에서 확정, v0.6 확장):**
```

교체 텍스트:
```
**rules JSON 구조 예시 (SSoT: 33-time-lock §2.2 PolicyRuleSchema, v0.6에서 10개 타입 확장):**
```

**수정 3 -- JSON 예시 블록 내 SPENDING_LIMIT 주석 (489행 부근):**

현재 텍스트:
```
// SPENDING_LIMIT (Phase 8 기존 + v0.6 USD 확장)
```

교체 텍스트:
```
// SPENDING_LIMIT (v0.6 USD 확장 -- 전체 스키마: 33-time-lock §2.2 SpendingLimitRuleSchema)
```

**검증:** 수정 후 25-sqlite-schema.md 전체에서 "Phase 8", "LOCK-MECH에서 확정" 문구가 남아있지 않아야 한다. "LOCK-MECH" 단어는 33-time-lock 문서 ID 참조 맥락에서만 존재해야 한다.
  </action>
  <verify>
grep -n "LOCK-MECH.*확정\|Phase 8.*확정" .planning/deliverables/25-sqlite-schema.md 결과가 0건이어야 한다.
grep -n "SSoT.*33-time-lock" .planning/deliverables/25-sqlite-schema.md 결과가 2건 이상이어야 한다.
  </verify>
  <done>
25-sqlite §4.4의 rules 컬럼 설명과 JSON 예시 블록 헤더에서 이연 표기가 완전히 제거되고, 33-time-lock §2.2 PolicyRuleSchema SSoT 참조로 교체되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 33-time-lock §3.2 evaluate() APPROVAL 타임아웃 3단계 우선순위 명시 (PLCY-03)</name>
  <files>.planning/deliverables/33-time-lock-approval-mechanism.md</files>
  <action>
33-time-lock-approval-mechanism.md §3.2 evaluateSpendingLimit()의 APPROVAL 반환 부분(909-914행 부근)을 수정한다:

**현재 코드 (909-914행):**
```typescript
    // APPROVAL: amount > delay_max
    return {
      allowed: true,
      tier: 'APPROVAL',
      approvalTimeoutSeconds: config.approval_timeout,
    }
```

**교체 코드:**
```typescript
    // APPROVAL: amount > delay_max
    // [v0.10] 타임아웃 결정 순서 (3단계 우선순위):
    //   1. 정책별: 해당 SPENDING_LIMIT rules의 approval_timeout (Zod default: 3600)
    //   2. 글로벌: config.toml [security].policy_defaults_approval_timeout
    //   3. 하드코딩: 3600초 (1시간)
    // 참고: SpendingLimitRuleSchema의 approval_timeout은 .default(3600)이므로
    // Zod 파싱 후 항상 값이 존재한다. 글로벌 config fallback은 향후
    // approval_timeout을 optional로 변경할 때의 설계 의도를 보존한다.
    const approvalTimeout = config.approval_timeout        // 1. 정책별 (Zod default: 3600)
      ?? this.globalConfig.policy_defaults_approval_timeout // 2. 글로벌 config
      ?? 3600                                               // 3. 하드코딩 fallback
    return {
      allowed: true,
      tier: 'APPROVAL',
      approvalTimeoutSeconds: approvalTimeout,
    }
```

**추가:** §3.2 evaluateSpendingLimit() 직전(879행 부근) 또는 §3.1 DatabasePolicyEngine constructor 부분(555-559행 부근)에 globalConfig 주입을 명시한다. constructor에 `private globalConfig: GlobalConfig`를 추가:

현재 constructor:
```typescript
  constructor(
    private db: DrizzleInstance,
    private sqlite: Database,  // better-sqlite3 (TOCTOU 방지용 raw 쿼리)
  ) {}
```

교체 constructor:
```typescript
  constructor(
    private db: DrizzleInstance,
    private sqlite: Database,  // better-sqlite3 (TOCTOU 방지용 raw 쿼리)
    private globalConfig: { policy_defaults_approval_timeout?: number },  // [v0.10] config.toml [security] 섹션
  ) {}
```

**추가 2:** §4 (4-티어 보안 분류 상태 머신) 또는 Stage 4 APPROVAL 큐잉 코드(1105-1117행 부근) 직전에 타임아웃 결정 순서 설명 블록을 추가한다.

1105행의 `case 'APPROVAL':` 바로 아래(1106행)의 기존 주석을 확장:

현재:
```typescript
    case 'APPROVAL':
      // Owner 승인 대기 큐잉
```

교체:
```typescript
    case 'APPROVAL':
      // Owner 승인 대기 큐잉
      // [v0.10] decision.approvalTimeoutSeconds는 evaluate()에서 이미 3단계 우선순위로 결정됨:
      //   1. 정책별 approval_timeout → 2. 글로벌 config → 3. 3600초
```
  </action>
  <verify>
grep -n "policy_defaults_approval_timeout" .planning/deliverables/33-time-lock-approval-mechanism.md 결과가 2건 이상이어야 한다 (constructor + evaluate 주석).
grep -n "3단계 우선순위\|3단계.*우선순위" .planning/deliverables/33-time-lock-approval-mechanism.md 결과가 1건 이상이어야 한다.
  </verify>
  <done>
33-time-lock §3.2 evaluate()의 APPROVAL 반환부에 타임아웃 3단계 우선순위(정책별 > 글로벌 config > 하드코딩 3600초)가 코드 주석과 의사코드로 명시되어 있다. DatabasePolicyEngine constructor에 globalConfig 주입이 추가되어 있다. Stage 4 APPROVAL 큐잉 주석에도 결정 순서 참조가 명시되어 있다.
  </done>
</task>

</tasks>

<verification>
1. 25-sqlite-schema.md 전체에서 "LOCK-MECH.*확정" 또는 "Phase 8.*확정" 패턴이 0건
2. 25-sqlite-schema.md에서 "SSoT.*33-time-lock" 패턴이 2건 이상
3. 33-time-lock-approval-mechanism.md에서 "policy_defaults_approval_timeout" 패턴이 2건 이상
4. 33-time-lock-approval-mechanism.md에서 "3단계 우선순위" 패턴이 1건 이상
5. 25-sqlite-schema.md의 rules JSON 예시 블록에 "Phase 8" 표기 없음
</verification>

<success_criteria>
- PLCY-01 충족: 25-sqlite §4.4의 이연 표기 완전 제거, SSoT 참조 명시
- PLCY-03 충족: 33-time-lock §3.2 evaluate()에 APPROVAL 타임아웃 3단계 우선순위 명시
- Phase 41 Success Criteria 1 충족 (이연 표기 제거 + SSoT 참조)
- Phase 41 Success Criteria 4 충족 (APPROVAL 타임아웃 결정 순서 명시)
</success_criteria>

<output>
After completion, create `.planning/phases/41-policy-engine-completion/41-01-SUMMARY.md`
</output>
