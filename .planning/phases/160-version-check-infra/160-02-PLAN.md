---
phase: 160-version-check-infra
plan: 02
type: tdd
wave: 2
depends_on: ["160-01"]
files_modified:
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/health.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/__tests__/api-server.test.ts
autonomous: true
requirements:
  - HLTH-01
  - HLTH-02

must_haves:
  truths:
    - "GET /health response includes latestVersion, updateAvailable, schemaVersion fields"
    - "latestVersion is null and updateAvailable is false when version check has not run"
    - "updateAvailable is true when latestVersion > current version"
    - "schemaVersion reflects the current DB schema version (LATEST_SCHEMA_VERSION)"
  artifacts:
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "Extended HealthResponseSchema with latestVersion, updateAvailable, schemaVersion"
      contains: "latestVersion"
    - path: "packages/daemon/src/api/routes/health.ts"
      provides: "Health route returning version check + schema info"
      contains: "latestVersion"
    - path: "packages/daemon/src/__tests__/api-server.test.ts"
      provides: "Tests for extended health endpoint"
      contains: "latestVersion"
  key_links:
    - from: "packages/daemon/src/api/routes/health.ts"
      to: "packages/daemon/src/infrastructure/version/version-check-service.ts"
      via: "getLatest() call for latestVersion field"
      pattern: "getLatest|versionCheck"
    - from: "packages/daemon/src/api/routes/health.ts"
      to: "packages/daemon/src/infrastructure/database/migrate.ts"
      via: "LATEST_SCHEMA_VERSION import for schemaVersion field"
      pattern: "LATEST_SCHEMA_VERSION|schemaVersion"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/health.ts"
      via: "createApp passes versionCheckService to health route"
      pattern: "versionCheck"
---

<objective>
GET /health 엔드포인트에 latestVersion, updateAvailable, schemaVersion 필드를 추가하여 버전 상태 및 스키마 정보를 노출한다.

Purpose: 외부 모니터링 도구, SDK, MCP가 데몬의 버전 상태를 조회하고 업그레이드 필요 여부를 판단할 수 있는 API를 제공한다.
Output: HealthResponseSchema 확장 + health.ts 응답 변경 + createApp deps 확장 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/routes/health.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/__tests__/api-server.test.ts
@packages/daemon/src/infrastructure/database/migrate.ts (LATEST_SCHEMA_VERSION)
@objectives/v1.8-upgrade-distribution.md (section 4: Health 엔드포인트 확장)

# Prior plan context needed:
@.planning/phases/160-version-check-infra/160-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: HealthResponseSchema 확장 + health route 변경 + createApp deps 연결 + 테스트</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/health.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/__tests__/api-server.test.ts
  </files>
  <action>
    **1. HealthResponseSchema 확장** (`packages/daemon/src/api/routes/openapi-schemas.ts`):

    기존 `HealthResponseSchema`에 3개 필드 추가:
    ```typescript
    export const HealthResponseSchema = z
      .object({
        status: z.string(),
        version: z.string(),
        latestVersion: z.string().nullable(),  // null if version check not run
        updateAvailable: z.boolean(),
        schemaVersion: z.number().int(),
        uptime: z.number().int(),
        timestamp: z.number().int(),
      })
      .openapi('HealthResponse');
    ```

    **2. health route 변경** (`packages/daemon/src/api/routes/health.ts`):

    - health 모듈이 VersionCheckService 인스턴스를 받을 수 있도록 함수형으로 변경:
      ```typescript
      import { LATEST_SCHEMA_VERSION } from '../../infrastructure/database/index.js';
      import type { VersionCheckService } from '../../infrastructure/version/index.js';

      export function createHealthRoute(deps: { versionCheckService?: VersionCheckService | null } = {}) {
        const health = new OpenAPIHono();

        health.openapi(healthRoute, (c) => {
          const latestVersion = deps.versionCheckService?.getLatest() ?? null;
          const current = DAEMON_VERSION;
          // semver.gt() 사용하여 비교. latestVersion이 null이면 updateAvailable = false.
          const updateAvailable = latestVersion !== null && semver.gt(latestVersion, current);

          return c.json({
            status: 'ok',
            version: current,
            latestVersion,
            updateAvailable,
            schemaVersion: LATEST_SCHEMA_VERSION,
            uptime: Math.floor(process.uptime()),
            timestamp: Math.floor(Date.now() / 1000),
          }, 200);
        });

        return health;
      }

      // Backward compatibility: default export for existing imports
      export const health = createHealthRoute();
      ```

    - `semver` import 추가: `import semver from 'semver'`
    - 기존 `export { health }` 유지하면서 `createHealthRoute` 팩토리 함수 추가.

    **3. createApp deps 확장** (`packages/daemon/src/api/server.ts`):

    - `CreateAppDeps` 인터페이스에 추가:
      ```typescript
      versionCheckService?: VersionCheckService | null;
      ```
    - `import type { VersionCheckService } from '../infrastructure/version/index.js'` 추가.
    - 기존 `app.route('/health', health)` 를 `app.route('/health', createHealthRoute({ versionCheckService: deps.versionCheckService ?? null }))` 로 변경.
    - `import { createHealthRoute } from './routes/health.js'` 추가 (기존 `health` import 대체).

    **4. daemon.ts 연결:**

    160-01에서 daemon.ts에 저장된 `this.versionCheckService`를 createApp deps로 전달. Step 5의 createApp 호출부에서:
    ```typescript
    const app = createApp({
      ...existingDeps,
      versionCheckService: this.versionCheckService,
    });
    ```

    단, Step 5(HTTP server)가 Step 6(workers) 전에 실행되므로, versionCheckService 인스턴스는 Step 5 전에 생성해야 함. 160-01에서 워커 등록은 Step 6에서 하지만, **VersionCheckService 인스턴스 생성 자체는 Step 5 이전**(Step 4c 이후, Step 5 이전 등)으로 이동. 워커 등록(Step 6)에서는 이미 생성된 인스턴스의 check() 핸들러만 등록.

    구체적으로:
    - daemon.ts에서 Step 4와 Step 5 사이에 VersionCheckService 인스턴스 생성:
      ```typescript
      // Step 4e: VersionCheckService (always create for health endpoint)
      if (this.sqlite && this._config!.daemon.update_check) {
        this.versionCheckService = new VersionCheckService(this.sqlite);
      }
      ```
    - Step 5의 createApp에 versionCheckService 전달
    - Step 6의 워커 등록에서 `this.versionCheckService.check()` 핸들러 사용

    **5. 테스트 추가** (`packages/daemon/src/__tests__/api-server.test.ts`):

    기존 `health route` describe 블록에 테스트 추가:

    ```typescript
    it('should include latestVersion, updateAvailable, schemaVersion in health response', async () => {
      const app = createTestApp();
      const res = await app.request('/health', { headers: { Host: '127.0.0.1:3100' } });
      const body = await json(res);

      // Default (no versionCheckService): latestVersion = null, updateAvailable = false
      expect(body.latestVersion).toBeNull();
      expect(body.updateAvailable).toBe(false);
      expect(typeof body.schemaVersion).toBe('number');
      expect(body.schemaVersion).toBeGreaterThan(0);
    });

    it('should return updateAvailable=true when latest > current', async () => {
      // Create a mock VersionCheckService that returns a higher version
      const mockService = { getLatest: () => '99.0.0', getCheckedAt: () => 1000 };
      const app = createApp({ versionCheckService: mockService as any });
      const res = await app.request('/health', { headers: { Host: '127.0.0.1:3100' } });
      const body = await json(res);

      expect(body.latestVersion).toBe('99.0.0');
      expect(body.updateAvailable).toBe(true);
    });

    it('should return updateAvailable=false when latest <= current', async () => {
      const mockService = { getLatest: () => '0.0.1', getCheckedAt: () => 1000 };
      const app = createApp({ versionCheckService: mockService as any });
      const res = await app.request('/health', { headers: { Host: '127.0.0.1:3100' } });
      const body = await json(res);

      expect(body.latestVersion).toBe('0.0.1');
      expect(body.updateAvailable).toBe(false);
    });

    it('should return latestVersion=null when version check service is null', async () => {
      const app = createApp({ versionCheckService: null });
      const res = await app.request('/health', { headers: { Host: '127.0.0.1:3100' } });
      const body = await json(res);

      expect(body.latestVersion).toBeNull();
      expect(body.updateAvailable).toBe(false);
    });
    ```

    기존 테스트 `'should return body with status, version, uptime, timestamp'`도 새 필드가 포함되도록 업데이트:
    ```typescript
    expect(body.latestVersion).toBeNull(); // default
    expect(body.updateAvailable).toBe(false); // default
    expect(typeof body.schemaVersion).toBe('number');
    ```
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/api-server.test.ts` 통과
    2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec tsc --noEmit` 타입 검사 통과
    3. Health 응답 JSON에 latestVersion, updateAvailable, schemaVersion 필드 존재 확인
  </verify>
  <done>
    - HealthResponseSchema에 latestVersion(nullable), updateAvailable, schemaVersion 필드 추가됨
    - GET /health가 VersionCheckService의 데이터를 읽어 응답에 포함함
    - 버전 체크 미실행 시 latestVersion = null, updateAvailable = false 반환
    - schemaVersion이 LATEST_SCHEMA_VERSION(현재 16) 반환
    - createApp에 versionCheckService deps 추가되어 health route로 전달됨
    - 모든 테스트(기존 + 신규) 통과
  </done>
</task>

</tasks>

<verification>
1. GET /health 응답에 latestVersion, updateAvailable, schemaVersion 필드가 포함됨
2. 버전 체크 미실행 시: latestVersion = null, updateAvailable = false
3. 최신 버전이 현재보다 높을 때: updateAvailable = true
4. schemaVersion = LATEST_SCHEMA_VERSION (현재 16)
5. 기존 health 테스트가 깨지지 않음
6. OpenAPI /doc 스펙에 새 필드가 반영됨
</verification>

<success_criteria>
- GET /health 응답에 latestVersion, updateAvailable, schemaVersion 3개 필드가 포함된다
- 버전 체크 미실행 시 latestVersion = null, updateAvailable = false를 반환한다
- VersionCheckService 데이터가 있을 때 semver 비교 결과를 updateAvailable에 반영한다
- schemaVersion이 LATEST_SCHEMA_VERSION 상수값을 반환한다
- 기존 + 신규 테스트 모두 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/160-version-check-infra/160-02-SUMMARY.md`
</output>
