---
phase: 29-api-integration-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/39-tauri-desktop-architecture.md
  - .planning/deliverables/29-api-framework-design.md
  - .planning/deliverables/28-daemon-lifecycle-cli.md
  - .planning/deliverables/54-cli-flow-redesign.md
autonomous: true

must_haves:
  truths:
    - "Tauri sidecar 종료 타임아웃이 5초에서 35초(데몬 30초 + 5초 마진)로 변경되어 있다"
    - "비정상 종료 시 다음 시작에서 SQLite PRAGMA integrity_check 복구 로직이 설계에 포함되어 있다"
    - "CORS 허용 목록에 tauri://localhost, http://tauri.localhost, https://tauri.localhost 3가지가 모두 포함되어 있다"
    - "개발 모드 Origin 로깅이 설계에 추가되어 있다"
    - "Tauri Setup Wizard가 CLI init을 sidecar로 호출하는 구조이고, waiaas init이 idempotent하게 동작하는 스펙이 확정되어 있다"
  artifacts:
    - path: ".planning/deliverables/39-tauri-desktop-architecture.md"
      provides: "sidecar 종료 타임아웃 35초, integrity_check 복구, CORS 3종 Origin, Setup Wizard CLI 위임 + init --json"
      contains: "SHUTDOWN_TIMEOUT.*35|integrity_check|http://tauri.localhost|https://tauri.localhost|--json"
    - path: ".planning/deliverables/29-api-framework-design.md"
      provides: "CORS 미들웨어에 Tauri 3종 Origin 추가, 개발 모드 Origin 로깅"
      contains: "http://tauri.localhost|https://tauri.localhost|Origin.*log"
    - path: ".planning/deliverables/28-daemon-lifecycle-cli.md"
      provides: "waiaas init idempotent 동작 스펙"
      contains: "idempotent|alreadyInitialized"
    - path: ".planning/deliverables/54-cli-flow-redesign.md"
      provides: "waiaas init idempotent 동작, --json 모드 스펙"
      contains: "idempotent|--json"
  key_links:
    - from: ".planning/deliverables/39-tauri-desktop-architecture.md"
      to: ".planning/deliverables/29-api-framework-design.md"
      via: "CORS Origin 허용 목록 일치"
      pattern: "tauri://localhost.*http://tauri.localhost.*https://tauri.localhost"
    - from: ".planning/deliverables/39-tauri-desktop-architecture.md"
      to: ".planning/deliverables/54-cli-flow-redesign.md"
      via: "Setup Wizard가 CLI init을 호출하는 구조"
      pattern: "waiaas init.*--json"
---

<objective>
Tauri sidecar 종료 타임아웃을 35초로 변경하고 비정상 종료 시 SQLite integrity_check 복구를 추가하며, CORS Origin에 Windows용 http/https://tauri.localhost를 추가하고, Setup Wizard CLI 위임 + waiaas init idempotent 스펙을 확정한다.

Purpose: Tauri Desktop 앱의 3대 구현 장애 요소(종료 시 DB 손상, Windows CORS 실패, init 중복 호출 에러)를 설계 수준에서 해소한다.
Output: 4개 설계 문서 수정 (39, 29, 28, 54) -- API-01, API-02, API-05 해소
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-api-integration-protocol/29-RESEARCH.md

# 수정 대상 설계 문서 (직접 참조)
@.planning/deliverables/39-tauri-desktop-architecture.md
@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/28-daemon-lifecycle-cli.md
@.planning/deliverables/54-cli-flow-redesign.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tauri sidecar 종료 타임아웃 35초 + SQLite integrity_check 복구 + CORS 3종 Origin (API-01, API-02)</name>
  <files>
    .planning/deliverables/39-tauri-desktop-architecture.md
    .planning/deliverables/29-api-framework-design.md
  </files>
  <action>
    29-RESEARCH.md의 Pattern 1 (Sidecar Graceful Shutdown), Pattern 2 (CORS Origin), Code Examples 1-2를 참조하여 2개 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **39-tauri-desktop-architecture.md:**

    1. **섹션 3.4 CORS 설정 (line 166) 보강:**
       - 기존 `corsOrigins` 배열에 Windows용 Origin 2개 추가:
         ```typescript
         cors({
           origin: [
             `http://localhost:${port}`,
             `http://127.0.0.1:${port}`,
             'tauri://localhost',            // macOS, Linux (WKWebView, WebKitGTK)
             'http://tauri.localhost',       // Windows (WebView2, Tauri 2.x 기본) [v0.7 보완]
             'https://tauri.localhost',      // Windows (WebView2, useHttpsScheme: true) [v0.7 보완]
           ],
         })
         ```
       - CORS 설명 갱신: `Tauri 2.x WebView는 플랫폼별로 서로 다른 Origin을 사용한다` + 플랫폼별 Origin 표 추가 (macOS: tauri://localhost, Windows: http://tauri.localhost 기본 또는 https://tauri.localhost, Linux: tauri://localhost).
       - 개발 모드 Origin 로깅 코드 예시 추가 (29-RESEARCH.md의 "개발 모드 Origin 로깅" 코드):
         ```typescript
         // [v0.7 보완] 개발 모드에서 수신된 Origin 헤더 로깅 (CORS 디버그용)
         if (config.daemon.log_level === 'debug') {
           app.use('*', async (c, next) => {
             const origin = c.req.header('Origin')
             if (origin) logger.debug(`[CORS] Request Origin: ${origin}`)
             await next()
           })
         }
         ```

    2. **섹션 4.2 Sidecar 라이프사이클 (line 304) 종료 타임아웃 변경:**
       - 라이프사이클 규칙 테이블의 "앱 종료" 행:
         기존: `POST /v1/admin/shutdown -> 5초 대기 -> SIGTERM`
         변경: `[v0.7 보완] POST /v1/admin/shutdown -> 35초 대기 -> SIGTERM -> 5초 대기 -> SIGKILL`
       - 변경 근거 주석 추가: `데몬 graceful shutdown 최대 30초 (28-daemon-lifecycle-cli.md shutdown_timeout=30) + 5초 마진 = 35초. 기존 5초는 DB WAL 손상 위험.`

    3. **섹션 4.3 Sidecar Manager (line 350) Rust 코드 보강:**
       - `stop_daemon()` 메서드에 타임아웃 상수 추가:
         ```rust
         // [v0.7 보완] 5초 -> 35초로 변경 (데몬 30초 + 5초 마진)
         const SHUTDOWN_TIMEOUT_SECS: u64 = 35;
         const SIGTERM_GRACE_SECS: u64 = 5;
         ```
       - stop 함수 로직 갱신: (1) POST /v1/admin/shutdown -> (2) 35초 대기 -> (3) 프로세스 생존 시 SIGTERM -> (4) 5초 대기 -> (5) 생존 시 SIGKILL
       - 29-RESEARCH.md의 Code Example 1 (Tauri Sidecar Stop with Extended Timeout)을 참조하되, 기존 코드 구조를 유지하면서 타임아웃 값과 4단계 종료 플로우만 반영.

    4. **섹션 4.2 또는 4.3 끝에 SQLite integrity_check 복구 하위 섹션 추가:**
       - 제목: `#### 4.3.1 비정상 종료 후 SQLite 복구 [v0.7 보완]`
       - 설명: Sidecar가 SIGKILL로 강제 종료되었거나, 크래시 감지 후 재시작 시 SQLite 무결성 검사를 수행한다.
       - 복구 로직 (29-RESEARCH.md Code Example 2 참조):
         (1) `PRAGMA integrity_check` 실행
         (2) 결과가 'ok'가 아니면 `PRAGMA wal_checkpoint(TRUNCATE)` 실행
         (3) 재검증 후 여전히 실패하면 에러 throw (DATABASE_CORRUPT)
       - 트리거 조건: `DaemonState::Crashed` 후 자동 재시작 시, 또는 앱 시작 시 이전 비정상 종료 플래그 감지 시.
       - 성능 주석: `integrity_check는 O(NlogN)이지만 WAIaaS DB는 소규모(에이전트 로컬)이므로 문제없음. 비정상 종료 후에만 실행.`

    **29-api-framework-design.md:**

    5. **섹션 2.3 미들웨어 상세 중 CORS 미들웨어 부분 보강:**
       - CORS origin 목록에 Windows용 Origin 2개 추가 (39번과 동일):
         `'http://tauri.localhost'` 와 `'https://tauri.localhost'` 추가
       - `[v0.7 보완] Tauri 2.x는 플랫폼별 Origin이 다르다: macOS/Linux는 tauri://localhost, Windows는 http://tauri.localhost (기본) 또는 https://tauri.localhost (useHttpsScheme). 3종 모두 허용.` 주석 추가
       - 개발 모드 Origin 로깅 미들웨어 추가 (39번과 동일 코드, 미들웨어 스택 설명에 반영)

    **주의사항:**
    - 39번과 29번의 CORS Origin 목록이 완전히 일치해야 한다 (5개 Origin).
    - 기존 코드 구조를 최대한 유지하면서 수정/추가만 수행.
    - 28-daemon-lifecycle-cli.md의 shutdown_timeout=30 근거를 인용.
  </action>
  <verify>
    1. grep "http://tauri.localhost" .planning/deliverables/39-tauri-desktop-architecture.md -- 결과 있어야 함
    2. grep "https://tauri.localhost" .planning/deliverables/39-tauri-desktop-architecture.md -- 결과 있어야 함
    3. grep "http://tauri.localhost" .planning/deliverables/29-api-framework-design.md -- 결과 있어야 함
    4. grep "https://tauri.localhost" .planning/deliverables/29-api-framework-design.md -- 결과 있어야 함
    5. grep "35" .planning/deliverables/39-tauri-desktop-architecture.md | grep -i "shutdown\|timeout\|SHUTDOWN_TIMEOUT" -- 35초 타임아웃 있어야 함
    6. grep "integrity_check" .planning/deliverables/39-tauri-desktop-architecture.md -- integrity_check 복구 있어야 함
    7. grep "SIGKILL" .planning/deliverables/39-tauri-desktop-architecture.md -- 4단계 종료(SIGKILL 포함) 있어야 함
    8. grep -c "v0.7 보완" .planning/deliverables/39-tauri-desktop-architecture.md -- 기존 대비 증가
    9. grep "Origin.*log\|CORS.*debug\|origin.*debug" .planning/deliverables/29-api-framework-design.md -- Origin 로깅 있어야 함
  </verify>
  <done>
    39번 문서에 Sidecar 종료 35초 타임아웃 + SIGKILL 4단계 + SQLite integrity_check 복구가 정의되고, 39번과 29번 문서의 CORS 허용 목록이 5개 Origin(localhost:port, 127.0.0.1:port, tauri://localhost, http://tauri.localhost, https://tauri.localhost)으로 일치하며, 개발 모드 Origin 로깅이 추가됨
  </done>
</task>

<task type="auto">
  <name>Task 2: Setup Wizard CLI 위임 확정 + waiaas init idempotent + --json 모드 (API-05)</name>
  <files>
    .planning/deliverables/39-tauri-desktop-architecture.md
    .planning/deliverables/28-daemon-lifecycle-cli.md
    .planning/deliverables/54-cli-flow-redesign.md
  </files>
  <action>
    29-RESEARCH.md의 Pattern 5 (Setup Wizard CLI 위임 + idempotent)를 참조하여 3개 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **39-tauri-desktop-architecture.md:**

    1. **섹션 7.7 화면 6 -- Setup Wizard (line 1076) 보강:**
       - 백엔드 연동 (line 1118) 부분을 구체화:
         기존: `Step 1-2: waiaas init CLI 커맨드를 Sidecar Manager가 실행 (또는 동등 API)`
         변경: `[v0.7 보완] Step 1-2: Sidecar Manager가 waiaas init --json --master-password <pw> CLI를 sidecar로 실행. --json 모드는 Tauri IPC 파싱을 위한 JSON 출력을 보장. idempotent: 이미 초기화 완료되었으면 에러 없이 현재 상태 반환 ({ success: true, alreadyInitialized: true }).`
       - waiaas init --json 응답 스키마 예시 추가:
         ```json
         // 신규 초기화
         { "success": true, "alreadyInitialized": false, "dataDir": "~/.waiaas/", "version": "0.2.0" }
         // 이미 초기화됨 (idempotent)
         { "success": true, "alreadyInitialized": true, "dataDir": "~/.waiaas/", "version": "0.2.0" }
         ```

    2. **섹션 13.2 Setup Wizard와 CLI init 초기화 순서 관계 (line 2035) 보강:**
       - 기존 "Wizard = CLI init + 데몬 시작 + API 호출의 조합" 설명 뒤에 구체적 호출 시퀀스 추가:
         ```
         [v0.7 보완] Setup Wizard 내부 호출 시퀀스:
         1. Sidecar Manager -> waiaas init --json --master-password <pw>
            - idempotent: 이미 초기화 시 skip + 성공 반환
            - 에러: JSON { success: false, error: "...", code: "INIT_FAILED" }
         2. Sidecar Manager -> waiaas start (데몬 시작)
         3. HTTP API -> POST /v1/agents (에이전트 생성)
         4. HTTP API -> POST /v1/owner/connect (Owner 연결, 선택적)
         5. HTTP API -> PUT /v1/owner/settings (알림 채널 설정, 선택적)
         ```
       - `--force` 플래그 동작 명시: `waiaas init --force는 기존 ~/.waiaas/ 삭제 후 재초기화. Wizard에서는 사용하지 않음 (사용자가 명시적으로 CLI에서만 사용).`

    **28-daemon-lifecycle-cli.md:**

    3. **waiaas init 관련 섹션에 idempotent 스펙 추가:**
       - 기존 init 플로우 설명 끝에 `[v0.7 보완]` 블록 추가:
         ```
         [v0.7 보완] waiaas init idempotent 동작:
         - ~/.waiaas/ 이미 존재하면 에러가 아닌 성공 반환 (기존: --force 없으면 에러)
         - 각 단계가 개별 idempotent: 디렉토리 존재→skip, DB 존재→migration만, config 존재→skip
         - 반환 구분: { alreadyInitialized: true } (기존) vs { alreadyInitialized: false } (신규)
         - --force: 기존 데이터 삭제 후 재초기화 (idempotent와 분리된 별도 동작)
         - --json: Tauri sidecar 호출용 JSON 출력 모드 (stdout에 JSON 한 줄 출력)
         ```

    **54-cli-flow-redesign.md:**

    4. **섹션 2 (waiaas init 재설계) 또는 섹션 2.5 (init 옵션 테이블)에 idempotent + --json 스펙 추가:**
       - init 옵션 테이블에 `--json` 행 추가:
         `| --json | 없음 | JSON 출력 모드 (Tauri sidecar IPC용). stdout에 JSON 한 줄 출력. | [v0.7 보완] |`
       - idempotent 동작 설명 추가 (섹션 2.2 v0.5 init 플로우 끝이나 적절한 위치):
         ```
         [v0.7 보완] idempotent 동작:
         v0.5까지 waiaas init은 ~/.waiaas/ 존재 시 에러를 반환했다. v0.7에서 idempotent로 변경:
         - 이미 초기화 완료: 에러 없이 성공 (exit code 0), 현재 상태 반환
         - --force: 명시적 삭제 후 재초기화 (기존 동작 유지)
         - Tauri Setup Wizard가 sidecar로 waiaas init을 호출할 때, 사용자가 앱을 재시작해도 에러가 발생하지 않도록 보장
         ```

    **주의사항:**
    - 39번의 Setup Wizard 호출 시퀀스와 54번의 init 플로우가 정합해야 한다.
    - --json 모드 출력 형식이 39번과 28번에서 일치해야 한다.
    - --force와 idempotent의 동작을 명확히 분리: idempotent = 존재하면 skip, --force = 삭제+재초기화.
  </action>
  <verify>
    1. grep "idempotent" .planning/deliverables/39-tauri-desktop-architecture.md -- 결과 있어야 함
    2. grep "idempotent" .planning/deliverables/28-daemon-lifecycle-cli.md -- 결과 있어야 함
    3. grep "idempotent" .planning/deliverables/54-cli-flow-redesign.md -- 결과 있어야 함
    4. grep "\-\-json" .planning/deliverables/39-tauri-desktop-architecture.md -- --json 모드 있어야 함
    5. grep "\-\-json" .planning/deliverables/54-cli-flow-redesign.md -- --json 옵션 있어야 함
    6. grep "alreadyInitialized" .planning/deliverables/39-tauri-desktop-architecture.md -- JSON 응답 스키마 있어야 함
    7. grep "v0.7 보완" .planning/deliverables/28-daemon-lifecycle-cli.md -- 태그 존재
    8. grep "v0.7 보완" .planning/deliverables/54-cli-flow-redesign.md -- 태그 존재
  </verify>
  <done>
    39번에서 Setup Wizard가 waiaas init --json을 sidecar로 호출하는 시퀀스가 확정되고, 28/54번에서 waiaas init idempotent 동작 + --json 모드가 정의되며, --force와 idempotent 동작이 명확히 분리됨
  </done>
</task>

</tasks>

<verification>
1. CORS 일관성: 39번과 29번의 CORS Origin 목록이 동일한 5개 Origin을 포함하는지 확인
2. 종료 타임아웃 일관성: 39번의 35초와 28-daemon-lifecycle-cli.md의 shutdown_timeout=30 + 5초 마진이 정합하는지 확인
3. init idempotent 일관성: 39번(Setup Wizard), 28번(daemon lifecycle), 54번(CLI flow)의 idempotent 동작 설명이 일치하는지 확인
4. --json 출력 일관성: 39번과 28번의 JSON 응답 형식이 일치하는지 확인
5. [v0.7 보완] 태그가 모든 변경 지점에 추가되었는지 확인
</verification>

<success_criteria>
- Tauri sidecar 종료 타임아웃이 35초로 변경되고, 비정상 종료 시 SQLite integrity_check 복구 로직이 추가됨
- CORS 허용 목록에 tauri://localhost, http://tauri.localhost, https://tauri.localhost 3종이 모두 포함됨
- 개발 모드 Origin 로깅이 39번과 29번에 추가됨
- Tauri Setup Wizard가 CLI init --json을 sidecar로 호출하는 구조가 확정됨
- waiaas init이 idempotent하게 동작하는 스펙이 28/54번에 정의됨
</success_criteria>

<output>
After completion, create `.planning/phases/29-api-integration-protocol/29-01-SUMMARY.md`
</output>
