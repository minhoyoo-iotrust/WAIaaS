---
phase: 29-api-integration-protocol
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/38-sdk-mcp-interface.md
  - .planning/deliverables/24-monorepo-data-directory.md
autonomous: true

must_haves:
  truths:
    - "Python SDK의 snake_case 변환이 WAIaaSBaseModel + ConfigDict(alias_generator=to_camel, populate_by_name=True) 패턴으로 SSoT 정의되어 있다"
    - "기존 Field(alias='camelCase') 방식이 alias_generator로 통합되고, to_camel 변환 결과와 API 필드명의 대조표가 존재한다"
    - "@waiaas/core의 index.ts에서 타입(z.infer) + Zod 스키마를 named export하는 패턴이 정의되어 있다"
    - "@waiaas/sdk에서 TransferRequestSchema.parse() 등으로 서버 전송 전 사전 검증하는 패턴이 정의되어 있다"
    - "Python SDK는 Pydantic field_validator로 수동 매핑하며 Zod 자동 생성이 아님이 명시되어 있다"
  artifacts:
    - path: ".planning/deliverables/38-sdk-mcp-interface.md"
      provides: "WAIaaSBaseModel 패턴, to_camel 대조표, Zod export 목록, SDK parse() 패턴, Python field_validator 매핑"
      contains: "WAIaaSBaseModel|alias_generator.*to_camel|TransferRequestSchema.*parse|field_validator"
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "@waiaas/core index.ts export 패턴"
      contains: "export.*Schema|export.*type.*from.*schema"
  key_links:
    - from: ".planning/deliverables/24-monorepo-data-directory.md"
      to: ".planning/deliverables/38-sdk-mcp-interface.md"
      via: "@waiaas/core export 목록이 SDK에서 참조하는 스키마와 일치"
      pattern: "TransferRequestSchema|TransactionRequestSchema"
    - from: ".planning/deliverables/38-sdk-mcp-interface.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "Python SDK 필드명이 REST API camelCase 필드와 to_camel 변환으로 일치"
      pattern: "to_camel|alias_generator"
---

<objective>
Python SDK의 snake_case 변환 규칙을 WAIaaSBaseModel + alias_generator SSoT로 확정하고, @waiaas/core에서 Zod 스키마를 export하여 @waiaas/sdk에서 클라이언트 사전 검증하는 패턴을 정의한다.

Purpose: Python SDK의 필드명 변환이 수동 alias 관리에서 자동 생성으로 전환되어 유지보수 부담이 제거되고, TS SDK의 런타임 검증이 @waiaas/core SSoT에서 파생되어 타입 drift가 0%가 된다.
Output: 2개 설계 문서 수정 (38, 24) -- API-06, API-07 해소
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-api-integration-protocol/29-RESEARCH.md

# 수정 대상 설계 문서 (직접 참조)
@.planning/deliverables/38-sdk-mcp-interface.md
@.planning/deliverables/24-monorepo-data-directory.md

# 참조 문서 (Zod 스키마 원본 확인용)
@.planning/deliverables/37-rest-api-complete-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Python SDK WAIaaSBaseModel + alias_generator SSoT 확정 (API-06)</name>
  <files>
    .planning/deliverables/38-sdk-mcp-interface.md
  </files>
  <action>
    29-RESEARCH.md의 Pattern 6 (Python SDK snake_case SSoT)과 Code Example 4를 참조하여 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **38-sdk-mcp-interface.md:**

    1. **섹션 4.2 Pydantic v2 모델 (line 1216) 보강:**
       - 기존 모델 정의 시작 부분에 **WAIaaSBaseModel** 공통 베이스 모델 추가:
         ```python
         # [v0.7 보완] 공통 베이스 모델 (snake_case SSoT)
         from pydantic import BaseModel, ConfigDict
         from pydantic.alias_generators import to_camel

         class WAIaaSBaseModel(BaseModel):
             """WAIaaS Python SDK 공통 베이스 모델.

             - alias_generator=to_camel: snake_case 필드명 -> camelCase alias 자동 생성
             - populate_by_name=True: snake_case와 camelCase 양방향 입력 허용
             - 직렬화: model_dump(by_alias=True)로 camelCase JSON 출력
             """
             model_config = ConfigDict(
                 alias_generator=to_camel,
                 populate_by_name=True,
             )
         ```
       - 기존 Pydantic 모델들(TransactionResponse, SessionCreateRequest 등)의 부모 클래스를 `BaseModel` -> `WAIaaSBaseModel`로 교체.
       - 기존 `Field(alias="camelCase")` 방식을 제거하고 `alias_generator=to_camel` 자동 생성으로 통합. 단, `to_camel`이 올바르게 생성하지 못하는 필드가 있으면 해당 필드만 명시적 `Field(alias="...")` 유지 (아래 대조표에서 확인).
       - `model_config = {"populate_by_name": True}` 기존 설정을 `WAIaaSBaseModel` 상속으로 대체 (중복 제거).

    2. **섹션 4.2 직후 또는 적절한 위치에 to_camel 변환 대조표 추가:**

       ```
       #### snake_case -> camelCase 변환 대조표 [v0.7 보완]

       `to_camel` 함수의 변환 결과와 REST API의 실제 camelCase 필드명을 대조한다.
       불일치 시 해당 필드만 Field(alias="...") 수동 지정.

       | Python 필드 (snake_case) | to_camel 결과 | API 필드 (camelCase) | 일치 |
       |-------------------------|--------------|---------------------|------|
       | agent_id | agentId | agentId | O |
       | transaction_id | transactionId | transactionId | O |
       | tx_hash | txHash | txHash | O |
       | estimated_fee | estimatedFee | estimatedFee | O |
       | created_at | createdAt | createdAt | O |
       | max_amount_per_tx | maxAmountPerTx | maxAmountPerTx | O |
       | max_daily_amount | maxDailyAmount | maxDailyAmount | O |
       | allowed_addresses | allowedAddresses | allowedAddresses | O |
       | session_token | sessionToken | sessionToken | O |
       | expires_at | expiresAt | expiresAt | O |
       | usd_value | usdValue | usdValue | O |
       | contract_address | contractAddress | contractAddress | O |
       | method_signature | methodSignature | methodSignature | O |
       | spender_address | spenderAddress | spenderAddress | O |
       | approved_amount | approvedAmount | approvedAmount | O |
       | instruction_data | instructionData | instructionData | O |
       | is_signer | isSigner | isSigner | O |
       | is_writable | isWritable | isWritable | O |

       **결론:** v0.6까지의 모든 필드가 to_camel과 일치. 수동 alias 불필요.
       v0.6 확장 필드(CONTRACT_CALL, APPROVE, BATCH) 포함 검증 완료.
       ```

    3. **섹션 11.3 Python SDK snake_case 변환 검증 (NOTE-10, line 3166) 업데이트:**
       - 기존 17개 필드 변환 검증을 위 대조표로 대체하거나, 대조표 참조 추가.
       - `[v0.7 보완] alias_generator=to_camel 전환으로 인해 Field(alias=) 수동 지정이 제거됨. 대조표(섹션 4.2.x)에서 전수 검증 완료.` 주석 추가.

    4. **v0.6 확장 타입의 Python 모델 추가 (기존에 없음):**
       - 섹션 4.2에 v0.6에서 추가된 타입의 Python 모델 추가 (ContractCallRequest, ApproveRequest, BatchRequest, Action 관련). 모두 WAIaaSBaseModel 상속:
         ```python
         class ContractCallRequest(WAIaaSBaseModel):
             type: Literal['CONTRACT_CALL']
             contract_address: str
             # EVM
             calldata: str | None = None
             value: str | None = None
             # Solana
             program_id: str | None = None
             instruction_data: str | None = None
             accounts: list[AccountMeta] | None = None

         class ApproveRequest(WAIaaSBaseModel):
             type: Literal['APPROVE']
             token: TokenIdentifier
             spender: str
             amount: str

         class BatchRequest(WAIaaSBaseModel):
             type: Literal['BATCH']
             instructions: list[TransferRequest | TokenTransferRequest | ContractCallRequest | ApproveRequest]
         ```
       - 모든 v0.6 확장 모델에 `# [v0.7 보완]` 주석.

    **주의사항:**
    - `to_camel`은 snake_case -> camelCase 단방향이다. Pydantic에서 alias_generator로 설정하면, 필드명(snake_case)에서 alias(camelCase)를 자동 생성.
    - `model_dump(by_alias=True)` 호출 시 camelCase JSON 출력, `model_dump()` 호출 시 snake_case.
    - Enum 값(PENDING, CONFIRMED 등)은 변환 대상이 아님 (UPPER_SNAKE_CASE 유지).
    - 38번 문서가 3215줄이므로, 변경 위치를 정확히 특정하여 수정.
  </action>
  <verify>
    1. grep "WAIaaSBaseModel" .planning/deliverables/38-sdk-mcp-interface.md -- 베이스 모델 있어야 함
    2. grep "alias_generator.*to_camel\|to_camel.*alias_generator" .planning/deliverables/38-sdk-mcp-interface.md -- alias_generator 설정 있어야 함
    3. grep "populate_by_name" .planning/deliverables/38-sdk-mcp-interface.md -- populate_by_name 설정 있어야 함
    4. grep "to_camel.*대조표\|변환.*대조표\|대조표" .planning/deliverables/38-sdk-mcp-interface.md -- 대조표 있어야 함
    5. grep "ContractCallRequest\|ApproveRequest\|BatchRequest" .planning/deliverables/38-sdk-mcp-interface.md | grep -i "python\|class\|WAIaaS" -- v0.6 확장 Python 모델 있어야 함
    6. grep "v0.7 보완" .planning/deliverables/38-sdk-mcp-interface.md -- 태그 존재
  </verify>
  <done>
    WAIaaSBaseModel + ConfigDict(alias_generator=to_camel) 패턴이 SSoT로 정의되고, 기존 Field(alias=) 수동 방식이 제거되며, 전체 필드 to_camel 대조표와 v0.6 확장 Python 모델이 추가됨
  </done>
</task>

<task type="auto">
  <name>Task 2: @waiaas/core Zod 스키마 export + @waiaas/sdk 사전 검증 + Python field_validator 매핑 (API-07)</name>
  <files>
    .planning/deliverables/38-sdk-mcp-interface.md
    .planning/deliverables/24-monorepo-data-directory.md
  </files>
  <action>
    29-RESEARCH.md의 Pattern 7 (Zod 스키마 @waiaas/core Export)를 참조하여 2개 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **24-monorepo-data-directory.md:**

    1. **@waiaas/core 패키지 설명 섹션에 Zod 스키마 export 패턴 추가:**
       - 기존 패키지 구조 설명 끝이나 적절한 위치에 `[v0.7 보완]` 블록 추가:

       ```
       #### @waiaas/core Zod 스키마 Export 패턴 [v0.7 보완]

       @waiaas/core의 index.ts에서 타입(z.infer)과 Zod 스키마를 named export한다.
       @waiaas/sdk는 workspace 참조로 이 스키마를 import하여 클라이언트 사전 검증에 사용한다.

       ```typescript
       // packages/core/src/index.ts

       // === 타입 (z.infer) ===
       export type { TransferRequest, TokenTransferRequest, ContractCallRequest, ApproveRequest, BatchRequest } from './schemas/transaction.schema.js'
       export type { TransactionResponse } from './schemas/transaction.schema.js'
       export type { SessionConstraints, SessionCreateRequest, SessionCreateResponse } from './schemas/session.schema.js'
       export type { AgentCreateRequest, AgentSummary } from './schemas/agent.schema.js'

       // === Zod 스키마 (런타임 검증용) ===
       export {
         TransferRequestSchema,
         TokenTransferRequestSchema,
         ContractCallRequestSchema,
         ApproveRequestSchema,
         BatchRequestSchema,
         TransactionRequestSchema,  // discriminatedUnion 5-type
       } from './schemas/transaction.schema.js'

       export {
         SessionConstraintsSchema,
         SessionCreateRequestSchema,
       } from './schemas/session.schema.js'

       export {
         AgentCreateRequestSchema,
       } from './schemas/agent.schema.js'
       ```

       **원칙:**
       - 타입은 `export type` (tree-shaking, 런타임 0 바이트)
       - 스키마는 `export` (런타임 검증에 사용)
       - 스키마 이름 규칙: `{PascalCaseName}Schema` (예: TransferRequestSchema)
       - 파일 위치 규칙: `packages/core/src/schemas/{domain}.schema.ts`
       ```

    **38-sdk-mcp-interface.md:**

    2. **섹션 2 (Zod SSoT -> SDK 타입 파이프라인, line 47) 보강:**
       - 기존 Zod SSoT 파이프라인 설명 끝에 구체적 @waiaas/sdk 사전 검증 패턴 추가:

       ```
       #### SDK 클라이언트 사전 검증 패턴 [v0.7 보완]

       @waiaas/sdk는 @waiaas/core에서 Zod 스키마를 import하여, 서버 전송 전 클라이언트에서 요청을 사전 검증한다.
       이로써 서버 왕복 없이 즉시 유효성 에러를 반환할 수 있다.

       ```typescript
       // packages/sdk/src/client.ts
       import {
         TransferRequestSchema,
         TokenTransferRequestSchema,
         ContractCallRequestSchema,
         TransactionRequestSchema,
         type TransferRequest,
         type TransactionResponse,
       } from '@waiaas/core'

       class WAIaaSClient {
         async sendNativeToken(request: TransferRequest): Promise<TransactionResponse> {
           // 서버 전송 전 클라이언트 사전 검증
           TransferRequestSchema.parse(request)  // 실패 시 ZodError throw
           return this.post('/v1/transactions/send', { ...request, type: 'TRANSFER' })
         }

         async sendTransaction(request: TransactionRequest): Promise<TransactionResponse> {
           // discriminatedUnion 검증 (type 필드 기반 자동 스키마 선택)
           TransactionRequestSchema.parse(request)
           return this.post('/v1/transactions/send', request)
         }
       }
       ```

       **검증 실패 시 동작:**
       - `ZodError` throw (SDK에서 `WAIaaSError`로 래핑)
       - 에러 메시지에 어떤 필드가 잘못되었는지 포함
       - 서버에 요청이 전송되지 않음 (네트워크 비용 절약)
       ```

    3. **Python SDK field_validator 수동 매핑 설명 추가:**
       - 섹션 4.2 끝이나 적절한 위치에:

       ```
       #### Python SDK 검증: Pydantic field_validator 수동 매핑 [v0.7 보완]

       Python SDK는 Zod 스키마를 자동 변환하지 않는다. OpenAPI 스키마의
       format/pattern 제약조건을 참조하여 Pydantic field_validator로 수동 매핑한다.

       ```python
       from pydantic import field_validator

       class TransferRequest(WAIaaSBaseModel):
           type: Literal['TRANSFER'] = 'TRANSFER'
           to: str
           amount: str
           memo: str | None = None
           priority: Literal['low', 'medium', 'high'] = 'medium'

           @field_validator('to')
           @classmethod
           def validate_to(cls, v: str) -> str:
               if not v:
                   raise ValueError('to address must not be empty')
               return v

           @field_validator('amount')
           @classmethod
           def validate_amount(cls, v: str) -> str:
               if not v:
                   raise ValueError('amount must not be empty')
               # 양수 검증 (lamports/wei 문자열)
               try:
                   if int(v) <= 0:
                       raise ValueError('amount must be positive')
               except (ValueError, TypeError):
                   raise ValueError('amount must be a numeric string')
               return v

           @field_validator('memo')
           @classmethod
           def validate_memo(cls, v: str | None) -> str | None:
               if v is not None and len(v) > 200:
                   raise ValueError('memo must be 200 characters or less')
               return v
       ```

       **원칙:**
       - Zod 스키마의 .min(), .max(), .regex() 등을 field_validator로 대응
       - OpenAPI 3.0 spec의 format/pattern 참조
       - 자동 생성이 아닌 수동 매핑 (Zod -> Pydantic 자동 변환 도구 미사용)
       - 변환 정확성은 테스트(51-platform-test-scenarios.md)에서 검증
       ```

    **주의사항:**
    - 24번 문서에서 @waiaas/core의 packages 구조가 이미 정의되어 있으므로 export 패턴만 추가.
    - 38번 문서의 기존 Zod 파이프라인 설명(섹션 2)을 유지하면서 구체적 패턴만 추가.
    - Python SDK의 field_validator는 수동 매핑임을 명확히 -- Zod 자동 변환이 아님.
    - export 목록에 v0.6 확장 타입(ContractCallRequest, ApproveRequest, BatchRequest)이 포함되어야 함.
  </action>
  <verify>
    1. grep "TransferRequestSchema" .planning/deliverables/24-monorepo-data-directory.md -- core export에 스키마 있어야 함
    2. grep "TransactionRequestSchema" .planning/deliverables/24-monorepo-data-directory.md -- discriminatedUnion export 있어야 함
    3. grep "export type" .planning/deliverables/24-monorepo-data-directory.md -- 타입 export 있어야 함
    4. grep "\.parse(" .planning/deliverables/38-sdk-mcp-interface.md -- SDK에서 parse() 사전 검증 있어야 함
    5. grep "field_validator" .planning/deliverables/38-sdk-mcp-interface.md -- Python field_validator 있어야 함
    6. grep "수동.*매핑\|자동.*변환.*아닌\|자동 생성.*아님" .planning/deliverables/38-sdk-mcp-interface.md -- 수동 매핑 명시
    7. grep "ContractCallRequestSchema\|ApproveRequestSchema\|BatchRequestSchema" .planning/deliverables/24-monorepo-data-directory.md -- v0.6 확장 스키마 export 포함
    8. grep "v0.7 보완" .planning/deliverables/24-monorepo-data-directory.md -- 태그 존재
  </verify>
  <done>
    24번에 @waiaas/core의 Zod 스키마 + 타입 export 패턴이 정의되고, 38번에 @waiaas/sdk의 .parse() 사전 검증 패턴 + Python SDK field_validator 수동 매핑 패턴이 정의됨
  </done>
</task>

</tasks>

<verification>
1. SSoT 일관성: 38번의 WAIaaSBaseModel이 모든 Python 모델의 부모 클래스인지 확인
2. Export 일관성: 24번의 @waiaas/core export 목록이 38번의 SDK import 목록과 일치하는지 확인
3. 대조표 완전성: 38번의 to_camel 대조표가 37번의 모든 API 필드를 커버하는지 확인
4. v0.6 확장: ContractCallRequest, ApproveRequest, BatchRequest의 Python 모델이 추가되었는지 확인
5. Python 수동 매핑: field_validator 수동 매핑이 명시적으로 "자동 생성이 아님"으로 기술되는지 확인
6. [v0.7 보완] 태그가 모든 변경 지점에 추가되었는지 확인
</verification>

<success_criteria>
- Python SDK snake_case 변환이 WAIaaSBaseModel + alias_generator=to_camel SSoT로 확정됨
- 기존 Field(alias=) 수동 방식이 제거되고 to_camel 전수 검증 대조표가 존재함
- @waiaas/core의 Zod 스키마 export 패턴이 24번에 정의됨 (v0.6 확장 포함)
- @waiaas/sdk의 .parse() 사전 검증 패턴이 38번에 정의됨
- Python SDK는 Pydantic field_validator 수동 매핑으로 확정됨
</success_criteria>

<output>
After completion, create `.planning/phases/29-api-integration-protocol/29-03-SUMMARY.md`
</output>
