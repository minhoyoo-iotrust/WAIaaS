---
phase: 29-api-integration-protocol
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/34-owner-wallet-connection.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/32-transaction-pipeline-api.md
autonomous: true

must_haves:
  truths:
    - "DELETE /v1/owner/disconnect의 cascade 동작이 에이전트별 owner_address 기준 5단계(APPROVAL->EXPIRED, DELAY유지, WC정리, 주소유지, 감사)로 확정되어 있다"
    - "disconnect 요청 바디에 address, chain 필드가 포함되고 masterAuth 인증이며 응답에 affectedAgents, expiredTransactions가 포함된다"
    - "5개 TransactionType 전체에 대해 티어별 HTTP 응답 status(INSTANT->200, NOTIFY->200, DELAY->202, APPROVAL->202)가 확정되어 있다"
    - "INSTANT 타임아웃 시 200 SUBMITTED(폴링 필요)가 명시되어 있다"
  artifacts:
    - path: ".planning/deliverables/34-owner-wallet-connection.md"
      provides: "Owner disconnect 5단계 cascade 스펙 + 코드 패턴"
      contains: "OWNER_DISCONNECTED|cascade|APPROVAL.*EXPIRED|DELAY.*유지"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "disconnect 엔드포인트 request body + cascade 응답 + TransactionType x Tier HTTP status 매트릭스"
      contains: "affectedAgents|expiredTransactions|INSTANT.*200|DELAY.*202|APPROVAL.*202"
    - path: ".planning/deliverables/32-transaction-pipeline-api.md"
      provides: "파이프라인 Stage 결과의 HTTP 응답 매핑 규칙"
      contains: "INSTANT.*200|DELAY.*202|APPROVAL.*202|SUBMITTED.*폴링"
  key_links:
    - from: ".planning/deliverables/34-owner-wallet-connection.md"
      to: ".planning/deliverables/37-rest-api-complete-spec.md"
      via: "disconnect cascade 동작이 양쪽 일치"
      pattern: "5단계.*cascade|APPROVAL.*EXPIRED"
    - from: ".planning/deliverables/37-rest-api-complete-spec.md"
      to: ".planning/deliverables/32-transaction-pipeline-api.md"
      via: "HTTP status 매핑이 파이프라인 티어 분류와 일치"
      pattern: "INSTANT.*200.*CONFIRMED|DELAY.*202.*QUEUED"
---

<objective>
Owner disconnect cascade 5단계 동작을 확정하고, 5개 TransactionType x 4 Tier의 HTTP 응답 status 값을 확정하여, 클라이언트 구현자가 추가 질문 없이 disconnect 처리와 트랜잭션 응답 파싱을 코딩할 수 있게 한다.

Purpose: Owner disconnect 시 에이전트/트랜잭션 후속 처리와 트랜잭션 API 응답 코드가 미정의되어 클라이언트 구현 시 차단되는 문제를 해소한다.
Output: 3개 설계 문서 수정 (34, 37, 32) -- API-03, API-04 해소
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-api-integration-protocol/29-RESEARCH.md

# 수정 대상 설계 문서 (직접 참조)
@.planning/deliverables/34-owner-wallet-connection.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/32-transaction-pipeline-api.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Owner disconnect cascade 5단계 확정 -- 34/37번 문서 수정 (API-03)</name>
  <files>
    .planning/deliverables/34-owner-wallet-connection.md
    .planning/deliverables/37-rest-api-complete-spec.md
  </files>
  <action>
    29-RESEARCH.md의 Pattern 3 (Owner Disconnect Cascade)과 Code Example 3을 참조하여 2개 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **34-owner-wallet-connection.md:**

    1. **섹션 6 (Owner 관련 API 엔드포인트) 내 disconnect 부분 보강:**
       - 기존 6.1 엔드포인트 전체 목록의 #2 DELETE /v1/owner/disconnect 행에 `[v0.7 보완] cascade 5단계 추가` 주석 또는 참조 추가.
       - 섹션 6 끝 또는 적절한 위치에 **disconnect cascade 상세** 하위 섹션 추가:

       ```
       ### 6.x DELETE /v1/owner/disconnect Cascade 동작 [v0.7 보완]

       v0.5에서 owner_address가 agents 테이블의 에이전트별 컬럼으로 변경되었으므로,
       disconnect는 요청된 address/chain에 매칭되는 에이전트들에 대해 5단계 cascade를 수행한다.

       **인증:** masterAuth (implicit) -- v0.5 변경에 의해 시스템 관리 작업으로 분류

       **요청:**
       DELETE /v1/owner/disconnect
       Body: { address: string, chain: 'solana' | 'ethereum' }

       **5단계 Cascade:**

       | 순서 | 동작 | 대상 | 근거 |
       |------|------|------|------|
       | 1 | APPROVAL 대기 트랜잭션 -> EXPIRED | transactions WHERE status='QUEUED' AND tier='APPROVAL' AND agentId IN (해당 에이전트들) | 승인자 부재로 영구 대기 방지 |
       | 2 | DELAY 대기 트랜잭션 -> 유지 (no-op) | transactions WHERE tier='DELAY' | DELAY는 Owner 개입 불필요, 타이머 계속 진행 |
       | 3 | WalletConnect 세션 정리 | wallet_connections WHERE address=req.address AND chain=req.chain | push 서명 비활성화 |
       | 4 | agents.owner_address 유지 (no-op) | agents | 주소는 에이전트 속성, 변경은 PUT /v1/agents/:id/owner |
       | 5 | audit_log 기록 | audit_log INSERT | OWNER_DISCONNECTED 이벤트, severity: info |

       **응답 (200 OK):**
       { disconnectedAt: string, affectedAgents: number, expiredTransactions: number }

       **코드 패턴 (구현 참조):**
       ```
       - 29-RESEARCH.md Code Example 3의 disconnectOwner 함수 패턴을 포함. 핵심 로직:
         (1) affectedAgentIds 쿼리 (agents WHERE ownerAddress=address AND chain=chain)
         (2) APPROVAL 상태 UPDATE -> EXPIRED (error='OWNER_DISCONNECTED')
         (3) wallet_connections DELETE
         (4) audit_log INSERT
         (5) 결과 반환 (disconnectedAt, affectedAgents, expiredTransactions)
       - 전체 동작은 단일 SQLite 트랜잭션(db.transaction())으로 원자적 실행.

    **37-rest-api-complete-spec.md:**

    2. **섹션 8.2 DELETE /v1/owner/disconnect (line 1680) 보강:**
       - 기존 엔드포인트 테이블에 v0.5 변경 정보는 유지.
       - **Request Body 추가** (기존에 없음):
         ```typescript
         // [v0.7 보완] disconnect 요청에 대상 address/chain 지정
         const OwnerDisconnectRequestSchema = z.object({
           address: z.string().min(1).openapi({
             description: 'Owner 지갑 주소',
             example: 'EcxjN4mea6Ah9WSqZhLtSJJCZcxY73Vaz6UVHFZZ5Ttz',
           }),
           chain: z.enum(['solana', 'ethereum']).openapi({
             description: '체인 식별자',
             example: 'solana',
           }),
         }).openapi('OwnerDisconnectRequest')
         ```
       - **Response Zod 스키마 교체** (기존 단순 응답 -> cascade 결과):
         ```typescript
         // [v0.7 보완] cascade 결과 포함 응답으로 확장
         const OwnerDisconnectResponseSchema = z.object({
           disconnected: z.literal(true),
           disconnectedAt: z.string().datetime(),
           affectedAgents: z.number().int().min(0).openapi({
             description: '영향받은 에이전트 수',
           }),
           expiredTransactions: z.number().int().min(0).openapi({
             description: 'EXPIRED로 전환된 APPROVAL 대기 트랜잭션 수',
           }),
         }).openapi('OwnerDisconnectResponse')
         ```
       - **응답 예시 교체:**
         ```json
         {
           "disconnected": true,
           "disconnectedAt": "2026-02-05T10:30:00.000Z",
           "affectedAgents": 2,
           "expiredTransactions": 1
         }
         ```
       - **[v0.7 보완] cascade 동작 참조** 주석 추가: `5단계 cascade 상세는 34-owner-wallet-connection.md 섹션 6.x 참조.`
       - 에러 테이블에 추가: `OWNER_NOT_FOUND` (404, 해당 address/chain 조합의 에이전트가 없음)를 기존 `OWNER_NOT_CONNECTED` 옆에 추가하거나 대체.

    **주의사항:**
    - 34번과 37번의 disconnect cascade 동작 설명이 정합해야 한다 (5단계 동일).
    - v0.5에서 owner_address가 에이전트별이므로 "모든 에이전트의 owner 해제"가 아니라 "해당 address/chain 매칭 에이전트에 대해서만" cascade 수행.
    - DELAY 유지(no-op)는 명시적으로 기술 -- Pitfall 3 방지.
    - OWNER_DISCONNECTED 감사 이벤트는 45-enum-unified-mapping.md의 AuditEventType에 추가 필요하면 주석으로 기록.
  </action>
  <verify>
    1. grep "OWNER_DISCONNECTED" .planning/deliverables/34-owner-wallet-connection.md -- cascade 감사 이벤트 있어야 함
    2. grep "affectedAgents" .planning/deliverables/37-rest-api-complete-spec.md -- cascade 응답 필드 있어야 함
    3. grep "expiredTransactions" .planning/deliverables/37-rest-api-complete-spec.md -- cascade 응답 필드 있어야 함
    4. grep "DELAY.*유지\|DELAY.*no-op" .planning/deliverables/34-owner-wallet-connection.md -- DELAY 유지 명시
    5. grep "APPROVAL.*EXPIRED" .planning/deliverables/34-owner-wallet-connection.md -- APPROVAL -> EXPIRED 명시
    6. grep "address.*chain" .planning/deliverables/37-rest-api-complete-spec.md | grep -i "disconnect" -- 요청 body에 address/chain
    7. grep "v0.7 보완" .planning/deliverables/34-owner-wallet-connection.md -- 태그 존재
  </verify>
  <done>
    34번에 disconnect cascade 5단계가 상세 정의되고, 37번의 DELETE /v1/owner/disconnect에 request body(address, chain) + cascade 결과 응답(affectedAgents, expiredTransactions)이 추가되며, DELAY 유지와 APPROVAL EXPIRED가 명시됨
  </done>
</task>

<task type="auto">
  <name>Task 2: TransactionType x Tier HTTP 응답 status 매트릭스 확정 -- 37/32번 문서 수정 (API-04)</name>
  <files>
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/32-transaction-pipeline-api.md
  </files>
  <action>
    29-RESEARCH.md의 Pattern 4 (TransactionType x Tier HTTP Status 매트릭스)를 참조하여 2개 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **37-rest-api-complete-spec.md:**

    1. **섹션 6.3 POST /v1/transactions/send 응답 분기 (line 831 근처) 보강:**
       - 기존 응답 분기:
         ```
         **응답 분기:**
         - **200 OK** (INSTANT 티어): status: 'CONFIRMED', txHash 포함
         - **202 Accepted** (DELAY/APPROVAL 티어): status: 'QUEUED', txHash 없음
         ```
       - 이것을 다음과 같이 확장하여 전체 매트릭스로 교체:

       ```
       #### HTTP 응답 Status 매트릭스 [v0.7 보완]

       모든 TransactionType(TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH)에
       동일한 규칙이 적용된다. 티어별 차이만 존재하며, 타입별 차이는 응답의 `type` 필드로 구분.

       | 티어 | HTTP Status | 응답 body의 status | 설명 |
       |------|------------|-------------------|------|
       | INSTANT (성공) | 200 OK | CONFIRMED | 동기 완료. txHash 포함. |
       | INSTANT (타임아웃) | 200 OK | SUBMITTED | 30초 내 미확정. txHash 포함. 클라이언트 폴링 필요. |
       | NOTIFY | 200 OK | CONFIRMED / SUBMITTED | INSTANT과 동일 동작 + Owner 알림 전송. |
       | DELAY | 202 Accepted | QUEUED | 대기열 진입. 쿨다운 후 자동 실행. txHash 없음. |
       | APPROVAL | 202 Accepted | QUEUED | 대기열 진입. Owner 승인 대기. txHash 없음. |

       **핵심 원칙:**
       - 200 = 동기 처리 완료 (CONFIRMED 또는 SUBMITTED)
       - 202 = 비동기 대기열 진입 (QUEUED)
       - 타입(TRANSFER/TOKEN_TRANSFER/CONTRACT_CALL/APPROVE/BATCH)은 HTTP status에 영향 없음
       - INSTANT 타임아웃(30초 내 미확정)은 200 SUBMITTED으로 반환하여 클라이언트가 GET /v1/transactions/:id로 폴링
       ```

       - 기존 "응답 예시" 2개 유지하되, INSTANT 타임아웃 예시 1개 추가:
         ```json
         // [v0.7 보완] 200 OK -- INSTANT 타임아웃 (SUBMITTED, 폴링 필요)
         {
           "transactionId": "019502c0-1a2b-3c4d-5e6f-abcdef012345",
           "type": "TRANSFER",
           "status": "SUBMITTED",
           "tier": "INSTANT",
           "txHash": "4vJ9JU1bJJE96FW...",
           "estimatedFee": "5000",
           "createdAt": "2026-02-05T10:31:25.000Z"
         }
         ```

    **32-transaction-pipeline-api.md:**

    2. **섹션 3.7 (6단계 전체 시퀀스 다이어그램, line 811) 끝 또는 적절한 위치에 HTTP 응답 매핑 규칙 추가:**
       - 새 하위 섹션 추가:

       ```
       #### 3.7.x 파이프라인 결과 -> HTTP 응답 매핑 [v0.7 보완]

       파이프라인 Stage 4 (Tier Classify)의 결과와 Stage 5-6 (Execute-Confirm)의 결과가
       HTTP 응답으로 매핑되는 규칙:

       | 파이프라인 결과 | HTTP Status | 응답 status | 조건 |
       |--------------|------------|------------|------|
       | Stage 4: tier=INSTANT/NOTIFY + Stage 6: CONFIRMED | 200 | CONFIRMED | 30초 내 온체인 확정 |
       | Stage 4: tier=INSTANT/NOTIFY + Stage 5d: SUBMITTED (timeout) | 200 | SUBMITTED | 30초 내 미확정 |
       | Stage 4: tier=DELAY | 202 | QUEUED | 즉시 반환, 쿨다운 대기 |
       | Stage 4: tier=APPROVAL | 202 | QUEUED | 즉시 반환, Owner 승인 대기 |
       | Stage 1-3: 실패 | 4xx | (에러) | 검증/정책 실패 |
       | Stage 5: 실패 | 4xx/5xx | (에러) | 빌드/서명/제출 실패 |

       이 매핑은 TransactionType에 무관하게 적용된다. 5개 TransactionType
       (TRANSFER, TOKEN_TRANSFER, CONTRACT_CALL, APPROVE, BATCH) 모두 동일 규칙.
       ```

    3. **기존 섹션 3.7의 INSTANT 플로우 시퀀스 다이어그램 끝에 주석 추가:**
       - `Note: [v0.7 보완] INSTANT 플로우에서 Stage 6 CONFIRM이 30초 타임아웃이면 200 SUBMITTED 반환. 클라이언트는 GET /v1/transactions/:id로 폴링하여 최종 CONFIRMED 확인.`

    **주의사항:**
    - 기존 "200 OK (INSTANT 티어): status: 'CONFIRMED'" 설명이 부분적으로 맞지만, SUBMITTED 케이스가 누락되어 있었다. 이를 보완.
    - NOTIFY 티어는 INSTANT과 동일 동작 + Owner 알림이므로 HTTP status도 동일(200).
    - 매트릭스는 TransactionType 무관 -- 이 원칙을 반복 명시.
  </action>
  <verify>
    1. grep "INSTANT.*200\|200.*INSTANT" .planning/deliverables/37-rest-api-complete-spec.md -- INSTANT -> 200 매핑 있어야 함
    2. grep "DELAY.*202\|202.*DELAY" .planning/deliverables/37-rest-api-complete-spec.md -- DELAY -> 202 매핑 있어야 함
    3. grep "APPROVAL.*202\|202.*APPROVAL" .planning/deliverables/37-rest-api-complete-spec.md -- APPROVAL -> 202 매핑 있어야 함
    4. grep "NOTIFY.*200\|200.*NOTIFY" .planning/deliverables/37-rest-api-complete-spec.md -- NOTIFY -> 200 매핑 있어야 함
    5. grep "SUBMITTED.*폴링\|SUBMITTED.*polling\|폴링.*SUBMITTED" .planning/deliverables/37-rest-api-complete-spec.md -- INSTANT 타임아웃 폴링 설명 있어야 함
    6. grep "HTTP.*응답.*매핑\|파이프라인.*HTTP" .planning/deliverables/32-transaction-pipeline-api.md -- 파이프라인 -> HTTP 매핑 있어야 함
    7. grep "TransactionType.*무관\|타입.*무관\|타입별.*차이.*없" .planning/deliverables/37-rest-api-complete-spec.md -- TransactionType 무관 원칙 명시
    8. grep "v0.7 보완" .planning/deliverables/32-transaction-pipeline-api.md -- 태그 존재
  </verify>
  <done>
    37번에 5개 TransactionType x 4 Tier의 HTTP 응답 매트릭스(INSTANT/NOTIFY->200, DELAY/APPROVAL->202)와 INSTANT 타임아웃(200 SUBMITTED) 케이스가 확정되고, 32번에 파이프라인 결과 -> HTTP 응답 매핑 규칙이 추가됨
  </done>
</task>

</tasks>

<verification>
1. Cascade 일관성: 34번과 37번의 disconnect cascade 5단계가 동일한 순서와 동작을 기술하는지 확인
2. HTTP Status 일관성: 37번의 매트릭스와 32번의 파이프라인 매핑이 동일한 규칙을 기술하는지 확인
3. DELAY 유지 명시: 34번에서 DELAY 트랜잭션이 disconnect 시 유지(no-op)됨이 명시적으로 기술되는지 확인
4. INSTANT 타임아웃: 37번에 200 SUBMITTED + 폴링 필요가 명시되는지 확인
5. TransactionType 무관 원칙: 37번과 32번에서 타입별 차이가 없음이 명시되는지 확인
6. [v0.7 보완] 태그가 모든 변경 지점에 추가되었는지 확인
</verification>

<success_criteria>
- DELETE /v1/owner/disconnect의 cascade 5단계(APPROVAL->EXPIRED, DELAY유지, WC정리, 주소유지, 감사)가 34번에 확정됨
- 37번의 disconnect 엔드포인트에 request body(address, chain)와 cascade 응답(affectedAgents, expiredTransactions)이 추가됨
- 5개 TransactionType x 4 Tier의 HTTP 응답 매트릭스가 37번에 확정됨 (INSTANT/NOTIFY->200, DELAY/APPROVAL->202)
- 32번에 파이프라인 결과 -> HTTP 응답 매핑 규칙이 추가됨
</success_criteria>

<output>
After completion, create `.planning/phases/29-api-integration-protocol/29-02-SUMMARY.md`
</output>
