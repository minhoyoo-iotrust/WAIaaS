---
phase: 28-dependency-build-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/30-session-token-protocol.md
  - .planning/deliverables/34-owner-wallet-connection.md
  - .planning/deliverables/37-rest-api-complete-spec.md
  - .planning/deliverables/39-tauri-desktop-architecture.md
  - .planning/deliverables/24-monorepo-data-directory.md
autonomous: true

must_haves:
  truths:
    - "SIWE 검증이 viem/siwe 내장 parseSiweMessage + verifyMessage로 전환되어, siwe와 ethers 패키지 참조가 설계 문서에서 완전히 제거되었다"
    - "Sidecar 크로스 컴파일 대상 5개 플랫폼(ARM64 Windows 제외)이 확정되고, prebuildify 기반 native addon 번들 전략이 정의되었다"
    - "영향받는 5개 설계 문서가 일관성 있게 업데이트되어, 문서 간 SIWE 검증 방식/의존성 참조가 불일치 없다"
  artifacts:
    - path: ".planning/deliverables/30-session-token-protocol.md"
      provides: "verifySIWE 코드 패턴이 viem/siwe 기반으로 교체, ethers 의존성 설명 제거"
      contains: "parseSiweMessage|validateSiweMessage|verifyMessage.*viem"
    - path: ".planning/deliverables/34-owner-wallet-connection.md"
      provides: "verifySIWE import 경로가 viem/siwe 기반으로 변경"
      contains: "viem/siwe"
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "서명 알고리즘 설명에서 siwe+ethers 대신 viem/siwe 참조"
      contains: "viem/siwe"
    - path: ".planning/deliverables/39-tauri-desktop-architecture.md"
      provides: "6개 플랫폼 매트릭스 + prebuildify/SEA 번들 전략 + native-loader 패턴"
      contains: "prebuildify|getRawAsset|native-loader"
    - path: ".planning/deliverables/24-monorepo-data-directory.md"
      provides: "daemon dependencies에 viem 추가, siwe/ethers 불포함 확인"
      contains: "viem.*2\\.23"
  key_links:
    - from: ".planning/deliverables/30-session-token-protocol.md"
      to: ".planning/deliverables/34-owner-wallet-connection.md"
      via: "verifySIWE 함수 시그니처 동일"
      pattern: "verifySIWE.*SIWEVerifyInput"
    - from: ".planning/deliverables/39-tauri-desktop-architecture.md"
      to: ".planning/deliverables/24-monorepo-data-directory.md"
      via: "native addon 목록 일치 (sodium-native, better-sqlite3, argon2)"
      pattern: "sodium-native.*better-sqlite3.*argon2"
---

<objective>
SIWE 검증을 viem/siwe 내장 함수로 전환하여 ethers/siwe 의존성을 제거하고, Sidecar 크로스 컴파일 전략을 prebuildify 기반으로 확정한다.

Purpose: 모노레포 첫 빌드에서 ethers+viem 공존으로 인한 의존성 충돌과 native addon 크로스 플랫폼 번들링 미정의 문제를 해소한다.
Output: 5개 설계 문서 수정 (DEPS-01: 4개, DEPS-02: 2개, 1개 공통)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-dependency-build-resolution/28-RESEARCH.md

# 수정 대상 설계 문서 (직접 참조)
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/34-owner-wallet-connection.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/39-tauri-desktop-architecture.md
@.planning/deliverables/24-monorepo-data-directory.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SIWE viem 전환 -- 4개 설계 문서 수정 (DEPS-01)</name>
  <files>
    .planning/deliverables/30-session-token-protocol.md
    .planning/deliverables/34-owner-wallet-connection.md
    .planning/deliverables/37-rest-api-complete-spec.md
    .planning/deliverables/24-monorepo-data-directory.md
  </files>
  <action>
    28-RESEARCH.md의 Pattern 1 (SIWE viem 전환 코드 패턴)과 Code Examples를 참조하여 4개 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **30-session-token-protocol.md:**
    1. 섹션 3.3.1 플로우 단계 (line 571): `siwe SiweMessage.verify({ signature })` -> `viem/siwe parseSiweMessage + verifyMessage로 3단계 검증`
    2. 섹션 3.3.3 코드 패턴 (lines 593-635): 전체 교체. `import { SiweMessage } from 'siwe'` 블록을 28-RESEARCH.md의 "SIWE 검증 전환: 전체 verifySIWE 교체 패턴" 코드로 대체. 핵심: `import { verifyMessage, type Hex } from 'viem'` + `import { parseSiweMessage, validateSiweMessage } from 'viem/siwe'`. 3단계: parseSiweMessage(파싱) -> validateSiweMessage(필드검증) -> verifyMessage(서명검증, RPC 불필요).
    3. 섹션 3.3.3 이후 의존성 설명 (lines 638-642): `siwe v3.x + ethers v6 의존성` 블록을 교체. 새 내용: `[v0.7 보완] viem/siwe 의존성: viem v2.x에 내장된 viem/siwe 모듈 사용. 별도 siwe/ethers 패키지 불필요. verifyMessage는 ecRecover 기반으로 RPC 불필요 (EOA 전용). 스마트 계정(EIP-1271) 지원이 필요하면 verifySiweMessage(PublicClient 필요)로 전환.`
    4. 섹션 3.3.4 시퀀스 다이어그램 (line 673): `SiweMessage.verify({ signature })` -> `parseSiweMessage + validateSiweMessage + verifyMessage (viem/siwe)`

    **34-owner-wallet-connection.md:**
    1. 섹션 5.5 Step 4 코드 (line 480 근처): `import { verifySIWS, verifySIWE } from '../../services/owner-verifier.js'` -- import 자체는 유지 (함수명 동일). 대신 line 384 또는 적절한 위치에 주석 추가: `[v0.7 보완] verifySIWE는 viem/siwe 기반으로 전환됨 (30-session-token-protocol.md 섹션 3.3.3 참조). siwe/ethers 의존성 없음.`
    2. verifySIWE 호출 패턴 (line 547 근처): 함수 시그니처는 동일 (SIWEVerifyInput 유지)하므로 호출부는 변경 불필요. 다만 해당 코드 블록 상단에 `// [v0.7 보완] verifySIWE 내부 구현이 viem/siwe 기반으로 전환됨` 주석 추가.

    **37-rest-api-complete-spec.md:**
    1. Line 176: `| 서명 알고리즘 | Solana: Ed25519 (tweetnacl), EVM: EIP-191 (siwe + ethers) |` -> `| 서명 알고리즘 | Solana: Ed25519 (tweetnacl), EVM: EIP-191 (viem/siwe + verifyMessage) | [v0.7 보완]`

    **24-monorepo-data-directory.md:**
    1. @waiaas/daemon dependencies (lines 391-402): `viem` 추가 (`"viem": "^2.23.0"` -- SIWE 검증용). 기존 siwe/ethers는 이미 없으므로 추가만 필요.
    2. 적절한 위치(dependencies 블록 근처)에 주석: `[v0.7 보완] SIWE 검증이 viem/siwe로 전환되어 daemon에 viem 직접 의존. siwe/ethers 패키지 불필요.`

    **주의사항:**
    - verifySIWE 함수 시그니처(SIWEVerifyInput -> { valid, address?, nonce? })는 유지. 내부 구현만 교체.
    - 52-auth-model-redesign.md는 SIWE/SIWS 일반 참조만 있고 코드 패턴이 없으므로 수정 불필요 (Research에서 "소"로 분류).
    - ethers 참조가 남아있지 않도록 grep으로 전수 확인.
  </action>
  <verify>
    1. grep -r "SiweMessage\|from 'siwe'\|ethers.*siwe\|siwe.*ethers" .planning/deliverables/ -- 결과 없어야 함 (52번 제외, 52번에도 없을 것)
    2. grep -r "parseSiweMessage\|validateSiweMessage" .planning/deliverables/30-session-token-protocol.md -- 결과 있어야 함
    3. grep -r "viem/siwe" .planning/deliverables/37-rest-api-complete-spec.md -- 결과 있어야 함
    4. grep "viem" .planning/deliverables/24-monorepo-data-directory.md | grep daemon -- viem이 daemon dependencies에 포함되어야 함
  </verify>
  <done>
    siwe+ethers 참조가 설계 문서에서 완전히 제거되고, viem/siwe 기반 verifySIWE 패턴이 30번 문서에 반영되며, 영향받는 34/37/24번 문서가 일관성 있게 업데이트됨
  </done>
</task>

<task type="auto">
  <name>Task 2: Sidecar 크로스 컴파일 전략 확정 -- 2개 설계 문서 수정 (DEPS-02)</name>
  <files>
    .planning/deliverables/39-tauri-desktop-architecture.md
    .planning/deliverables/24-monorepo-data-directory.md
  </files>
  <action>
    28-RESEARCH.md의 Pattern 4/5 (SEA + Native Addon 번들 전략)와 타겟 플랫폼 매트릭스를 참조하여 2개 설계 문서를 수정한다. 모든 변경에 `[v0.7 보완]` 태그를 붙인다.

    **39-tauri-desktop-architecture.md:**

    1. **섹션 4.1 Sidecar 바이너리 (lines 185-217) 보완:**
       - native addon 행 (line 195): `sodium-native, better-sqlite3` -> `sodium-native, better-sqlite3, argon2` (argon2 누락 보완). `v0.3 구현 시 크로스 컴파일 검증 필요` -> `[v0.7 보완] prebuildify 기반 번들 전략 정의 (섹션 11.6 참조)`
       - 바이너리 배치 목록 (lines 211-217): Linux ARM64 추가. 총 5개 플랫폼:
         ```
         src-tauri/binaries/
           waiaas-daemon-aarch64-apple-darwin       (macOS Apple Silicon)
           waiaas-daemon-x86_64-apple-darwin        (macOS Intel)
           waiaas-daemon-x86_64-pc-windows-msvc.exe (Windows x64)
           waiaas-daemon-x86_64-unknown-linux-gnu   (Linux x64)
           waiaas-daemon-aarch64-unknown-linux-gnu   (Linux ARM64)
         ```
       - 섹션 4.1 끝에 **Native Addon 번들 전략** 하위 섹션 추가:
         - SEA assets 메커니즘 설명 (sea-config.json + assets 예시)
         - native-loader.ts 패턴 (28-RESEARCH.md Code Examples의 SEA 네이티브 모듈 로더)
         - 대안 전략: SEA assets 실패 시 동반 .node 파일 디렉토리 (.d/) 방식 (28-RESEARCH.md Pattern 5)
         - 각 native addon별 빌드 도구 차이 명시:
           - sodium-native: prebuildify + node-gyp-build (prebuilds/ 디렉토리)
           - better-sqlite3: prebuild-install (prebuilds/ 디렉토리)
           - argon2: @mapbox/node-pre-gyp (lib/binding/ 디렉토리) -- 경로 차이 주의!
         - `[v0.7 보완] sodium-native SEA 호환성은 구현 시 검증 필요. 실패 시 동반 파일 전략으로 전환.` 주석

    2. **섹션 11.6 Sidecar 크로스 컴파일 (lines 1725-1739) 전면 보강:**
       - 기존 4행 테이블 + 3개 미검증 항목을 삭제하고, 28-RESEARCH.md의 타겟 플랫폼 매트릭스로 교체:

       **[v0.7 보완] 타겟 플랫폼 매트릭스 (5+1):**

       | # | Target Triple | OS | Arch | CI Runner | 우선순위 |
       |---|--------------|-----|------|-----------|:--------:|
       | 1 | aarch64-apple-darwin | macOS | ARM64 | macos-14 (M1) | P0 |
       | 2 | x86_64-apple-darwin | macOS | x64 | macos-13 | P0 |
       | 3 | x86_64-pc-windows-msvc | Windows | x64 | windows-2022 | P1 |
       | 4 | x86_64-unknown-linux-gnu | Linux | x64 | ubuntu-22.04 | P1 |
       | 5 | aarch64-unknown-linux-gnu | Linux | ARM64 | ubuntu-22.04 ARM64 | P2 |
       | - | aarch64-pc-windows-msvc | Windows | ARM64 | - | **제외** |

       **제외 근거 (ARM64 Windows):** sodium-native/argon2 ARM64 Windows prebuild 미제공, Tauri ARM64 Windows 실험적, 시장 점유율 미미.

       **Native Addon별 Prebuild 현황:**

       | Package | Build Tool | 런타임 로더 | Prebuild 경로 |
       |---------|------------|------------|--------------|
       | sodium-native v5.x | prebuildify | node-gyp-build | prebuilds/{platform}-{arch}/ |
       | better-sqlite3 v12.x | prebuild-install | node-gyp-build | prebuilds/{platform}-{arch}/ |
       | argon2 v0.43+ | @mapbox/node-pre-gyp | @mapbox/node-pre-gyp | lib/binding/napi-v3-{platform}-{arch}/ |

       **SEA 빌드 파이프라인 (CI 매트릭스):**
       ```
       1. pnpm install + turborepo build (@waiaas/daemon 번들)
       2. 플랫폼별 prebuilt .node 파일 수집
       3. sea-config.json에 assets로 .node 파일 포함
       4. node --experimental-sea-config sea-config.json (Node.js 22)
       5. postject로 SEA 바이너리 생성
       6. 코드사인 (macOS: codesign, Windows: signtool)
       ```

       **v0.3 구현 시 검증 필요 항목** (기존 3개 유지 + 보강):
       - sodium-native의 SEA assets 호환성 (process.dlopen 시 libsodium 동적 링크 의존성)
       - better-sqlite3의 SEA 번들링 (napi 바인딩 + SQLite 정적 링크)
       - argon2의 lib/binding/ 경로 차이 (prebuildify가 아닌 node-pre-gyp 사용)
       - Linux ARM64 Docker postject ELF hash table 이슈 (postject#105) -- P2 우선순위이므로 non-container 빌드 기본
       - SEA 바이너리 크기 최적화 (예상: 80-120MB per platform)

    **24-monorepo-data-directory.md:**
    - Task 1에서 viem을 daemon에 추가했으므로, 이 Task에서는 native addon 관련 의존성이 daemon에 이미 올바르게 있는지 확인만 수행 (sodium-native, better-sqlite3, argon2 -- 모두 이미 존재).
    - 24번 문서에 별도 수정이 필요하면: 의존성 목록에 주석으로 `[v0.7 보완] native addon prebuild 전략: sodium-native(prebuildify), better-sqlite3(prebuild-install), argon2(node-pre-gyp)` 추가.

    **주의사항:**
    - Node.js 22 기준 유지 (25.5 --build-sea는 주석으로만 언급)
    - ARM64 Windows 제외는 확정 사항
    - 기존 섹션 4.2~4.3 (Sidecar 라이프사이클, SidecarManager)은 변경 없음
  </action>
  <verify>
    1. grep "argon2" .planning/deliverables/39-tauri-desktop-architecture.md -- 섹션 4.1에 argon2가 포함되어야 함
    2. grep "prebuildify\|node-pre-gyp\|prebuild-install" .planning/deliverables/39-tauri-desktop-architecture.md -- 3개 빌드 도구 모두 언급되어야 함
    3. grep "aarch64-unknown-linux-gnu" .planning/deliverables/39-tauri-desktop-architecture.md -- Linux ARM64 타겟이 포함되어야 함
    4. grep "aarch64-pc-windows-msvc" .planning/deliverables/39-tauri-desktop-architecture.md | grep "제외" -- ARM64 Windows 제외 명시
    5. grep "getRawAsset\|native-loader\|process.dlopen" .planning/deliverables/39-tauri-desktop-architecture.md -- SEA 번들 전략이 포함되어야 함
  </verify>
  <done>
    39-tauri-desktop-architecture.md에 5개 타겟 플랫폼 매트릭스, 3개 native addon별 prebuild 현황, SEA 번들 전략(primary: assets, fallback: 동반 파일)이 정의되고, 24-monorepo-data-directory.md의 의존성이 일관됨
  </done>
</task>

</tasks>

<verification>
1. DEPS-01 전수 확인: `grep -r "from 'siwe'\|SiweMessage\|ethers.*v6" .planning/deliverables/` -- 결과 없어야 함
2. DEPS-02 플랫폼 확인: 39번 문서에 5개 타겟 + 1개 제외가 명시되어야 함
3. 문서 간 일관성: 30번의 verifySIWE 시그니처와 34번의 호출이 일치해야 함
4. 24번 daemon dependencies에 viem이 포함되고 siwe/ethers가 없어야 함
5. [v0.7 보완] 태그가 모든 변경 지점에 추가되어야 함
</verification>

<success_criteria>
- SIWE 검증이 viem v2.x 내장 parseSiweMessage + verifyMessage로 전환되어, ethers와 siwe npm 패키지 의존성이 모노레포 설계에서 완전히 제거됨
- Sidecar 크로스 컴파일 대상 5개 플랫폼(ARM64 Windows 제외)이 확정되고, prebuildify 기반 네이티브 바이너리 번들 전략이 정의됨
- 영향받는 5개 설계 문서(24, 30, 34, 37, 39)가 일관성 있게 [v0.7 보완] 태그와 함께 업데이트됨
</success_criteria>

<output>
After completion, create `.planning/phases/28-dependency-build-resolution/28-01-SUMMARY.md`
</output>
