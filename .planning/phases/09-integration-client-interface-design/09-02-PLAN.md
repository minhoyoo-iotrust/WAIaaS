---
phase: 09-integration-client-interface-design
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - .planning/deliverables/38-sdk-mcp-interface.md
autonomous: true

must_haves:
  truths:
    - "TypeScript SDK 클래스 구조가 메서드 시그니처, 에러 타입, Options Bag 패턴으로 설계됨"
    - "Python SDK async 클래스가 동일 기능을 httpx + Pydantic으로 설계됨"
    - "MCP Server 도구 5-7개가 Zod inputSchema + 응답 형식으로 정의됨"
    - "MCP 리소스 2-3개가 URI 스키마 + MIME 타입으로 정의됨"
    - "MCP 세션 토큰 전달 메커니즘이 stdio/Streamable HTTP 양쪽에 대해 설계됨"
    - "SDK와 MCP가 Zod SSoT에서 타입을 파생하는 파이프라인이 정의됨"
  artifacts:
    - path: ".planning/deliverables/38-sdk-mcp-interface.md"
      provides: "TypeScript SDK, Python SDK, MCP Server 전체 인터페이스 설계"
      contains: "WAIaaSClient"
  key_links:
    - from: "38-sdk-mcp-interface.md"
      to: "37-rest-api-complete-spec.md"
      via: "SDK 메서드가 API 엔드포인트에 1:1 매핑, MCP Tool이 Agent API subset에 매핑"
      pattern: "getBalance.*GET /v1/wallet/balance"
    - from: "38-sdk-mcp-interface.md"
      to: "30-session-token-protocol.md"
      via: "SDK 세션 토큰 설정/갱신, MCP 환경변수 세션 토큰"
      pattern: "setSessionToken.*wai_sess_"
    - from: "38-sdk-mcp-interface.md"
      to: "29-api-framework-design.md"
      via: "Zod SSoT -> openapi-typescript -> SDK 타입 자동 생성"
      pattern: "openapi-typescript.*@waiaas/core"
---

<objective>
TypeScript SDK (@waiaas/sdk), Python SDK (waiaas), MCP Server (@waiaas/mcp) 인터페이스를 상세 설계한다 -- SDK 클래스 구조, 메서드 시그니처, 에러 타입, 세션 관리 헬퍼, MCP 도구/리소스 정의, 세션 토큰 전달 메커니즘, stdio/Streamable HTTP 전송을 구현 가능한 수준으로 정의한다.

Purpose: AI 에이전트 프레임워크가 WAIaaS와 통합하는 3가지 경로(SDK 직접 호출, MCP 도구, REST API)를 제공한다. SDK는 개발자 편의성, MCP는 AI 에이전트 자율성을 극대화한다.
Output: 설계 문서 1개 -- 38-sdk-mcp-interface.md (SDK-01, SDK-02, MCP-01, MCP-02 충족)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-client-interface-design/09-RESEARCH.md

# 09-01 SUMMARY (직접 의존 -- API 전체 스펙)
@.planning/phases/09-integration-client-interface-design/09-01-SUMMARY.md

# Phase 6-7 참조
@.planning/deliverables/29-api-framework-design.md (CORE-06: Zod SSoT, OpenAPIHono)
@.planning/deliverables/30-session-token-protocol.md (SESS-PROTO: JWT, 세션 제약)
@.planning/deliverables/32-transaction-pipeline-api.md (TX-PIPE: 거래 API Zod 스펙)

# v0.1 참조 (커버리지 비교용, Cloud 개념은 사용하지 않음)
@.planning/deliverables/22-sdk-interface.md (v0.1 Cloud SDK -- 커버리지 참조만)
@.planning/deliverables/23-mcp-integration.md (v0.1 Cloud MCP -- 커버리지 참조만)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript SDK + Python SDK 인터페이스 설계</name>
  <files>.planning/deliverables/38-sdk-mcp-interface.md</files>
  <action>
  설계 문서 `38-sdk-mcp-interface.md`를 작성한다. 문서 ID는 `SDK-MCP`.

  **섹션 1: 문서 개요**
  - 문서 ID: SDK-MCP
  - 목적: TypeScript/Python SDK + MCP Server 인터페이스 설계 (37-rest-api-complete-spec.md 기반)
  - 요구사항 매핑: SDK-01 (TS SDK), SDK-02 (Python SDK), MCP-01 (MCP Server), MCP-02 (Claude Desktop 연동)
  - v0.1과의 핵심 차이: API Key -> Session Token, Cloud URL -> localhost baseUrl, Webhook -> 로컬 알림

  **섹션 2: Zod SSoT -> SDK 타입 파이프라인**
  - 파이프라인 다이어그램:
    ```
    @waiaas/core Zod Schemas
      -> z.infer<typeof Schema>     (TS 타입 -- @waiaas/core에서 export)
      -> openapi-typescript          (OpenAPI JSON -> TS 타입 자동 생성)
      -> @waiaas/sdk                (수동 래퍼 클래스 -- Zod 타입 import)
      -> Python SDK                 (Pydantic 모델 수동 동기화)
    ```
  - 핵심 결정: TS SDK는 @waiaas/core에서 Zod 타입을 직접 import (모노레포 이점), Python SDK는 OpenAPI 스펙에서 Pydantic 모델 수동 작성
  - 타입 drift 방지: CI에서 openapi-typescript 출력 diff 검증

  **섹션 3: TypeScript SDK (@waiaas/sdk) -- SDK-01**

  3.1 패키지 구조:
  ```
  packages/sdk/
    src/
      client.ts        (WAIaaSClient 메인 클래스)
      types.ts         (re-export from @waiaas/core)
      errors.ts        (WAIaaSError 클래스)
      session.ts       (SessionHelper -- 세션 토큰 관리)
      retry.ts         (RetryPolicy -- 자동 재시도)
      index.ts         (public API)
    package.json       (name: @waiaas/sdk, peer: @waiaas/core)
  ```

  3.2 WAIaaSClient 클래스:
  ```typescript
  class WAIaaSClient {
    constructor(options: WAIaaSClientOptions)

    // 세션 관리
    setSessionToken(token: string): void
    getSessionToken(): string | null

    // Wallet API
    getBalance(options?: GetBalanceOptions): Promise<BalanceResponse>
    getAddress(options?: GetAddressOptions): Promise<AddressResponse>

    // Transaction API
    sendToken(request: TransferRequest, options?: SendTokenOptions): Promise<TransactionResponse>
    getTransaction(id: string, options?: GetTransactionOptions): Promise<TransactionDetail>
    listTransactions(options?: ListTransactionsOptions): Promise<PaginatedResponse<TransactionSummary>>
    listPendingTransactions(options?: ListPendingOptions): Promise<PaginatedResponse<TransactionSummary>>

    // Nonce (public)
    getNonce(): Promise<NonceResponse>
  }
  ```

  3.3 WAIaaSClientOptions (Options Bag 패턴):
  - baseUrl: string (기본값 'http://127.0.0.1:3100')
  - sessionToken?: string (초기 토큰)
  - retry?: RetryPolicy (기본: { maxRetries: 3, backoff: 'exponential', retryableStatuses: [429, 502, 503] })
  - timeout?: number (기본: 30_000ms)
  - signal?: AbortSignal (요청 취소)

  3.4 WAIaaSOwnerClient 클래스 (Owner 전용):
  ```typescript
  class WAIaaSOwnerClient {
    constructor(options: WAIaaSOwnerClientOptions)

    // 세션 관리 (Owner)
    createSession(request: CreateSessionRequest): Promise<SessionResponse>
    listSessions(options?: ListSessionsOptions): Promise<PaginatedResponse<SessionSummary>>
    revokeSession(sessionId: string): Promise<RevokeResponse>

    // 거래 승인
    approveTransaction(txId: string): Promise<ApprovalResponse>
    rejectTransaction(txId: string, reason?: string): Promise<ApprovalResponse>
    listPendingApprovals(options?: ListPendingApprovalsOptions): Promise<PaginatedResponse<PendingApproval>>

    // 에이전트 관리
    listAgents(): Promise<AgentSummary[]>
    getAgent(agentId: string): Promise<AgentDetail>

    // 시스템
    getStatus(): Promise<SystemStatus>
    getDashboard(): Promise<DashboardSummary>
    getSettings(): Promise<SystemSettings>
    updateSettings(settings: Partial<UpdatableSettings>): Promise<SystemSettings>

    // Kill Switch
    activateKillSwitch(reason: string): Promise<KillSwitchResponse>
    recover(masterPassword: string): Promise<RecoverResponse>

    // Owner 연결
    connect(): Promise<ConnectResponse>
    disconnect(): Promise<void>
  }
  ```

  3.5 WAIaaSOwnerClientOptions:
  - baseUrl: string
  - signMessage: (message: string) => Promise<string> -- Owner 서명 콜백 (WalletConnect 연동)
  - ownerAddress: string
  - chain: 'solana' | 'ethereum'

  3.6 WAIaaSError 클래스:
  ```typescript
  class WAIaaSError extends Error {
    readonly code: string      // 'INVALID_TOKEN', 'INSUFFICIENT_BALANCE', etc.
    readonly statusCode: number // HTTP status
    readonly retryable: boolean
    readonly requestId: string
    readonly details?: unknown
  }
  ```

  3.7 RetryPolicy:
  - maxRetries: number (0-5, 기본 3)
  - backoff: 'none' | 'linear' | 'exponential' (기본 'exponential')
  - baseDelay: number (기본 1000ms)
  - retryableStatuses: number[] (기본 [429, 502, 503])
  - retryable 에러 코드: WAIaaSError.retryable=true인 경우만

  3.8 사용 예시 코드:
  - 기본 Agent 사용 (getBalance, sendToken)
  - Owner 세션 생성 + Agent 사용 플로우
  - 에러 핸들링 패턴

  **섹션 4: Python SDK (waiaas) -- SDK-02**

  4.1 패키지 구조:
  ```
  packages/sdk-python/
    waiaas/
      __init__.py
      client.py          (WAIaaSClient async class)
      owner_client.py    (WAIaaSOwnerClient async class)
      types.py           (Pydantic models)
      errors.py          (WAIaaSError)
      retry.py           (RetryPolicy)
    pyproject.toml       (dependencies: httpx, pydantic)
  ```

  4.2 WAIaaSClient (async):
  - Python 3.10+ async/await
  - httpx.AsyncClient 사용 (connection pooling, HTTP/2)
  - 동일 메서드 시그니처 (snake_case 변환): get_balance(), send_token(), list_transactions()
  - async context manager: `async with WAIaaSClient(base_url=...) as client:`

  4.3 Pydantic 모델:
  - BalanceResponse, TransferRequest, TransactionResponse 등 -- TS Zod 스키마와 동일 필드
  - Pydantic v2 model_validator 사용

  4.4 WAIaaSOwnerClient (async):
  - TS WAIaaSOwnerClient와 동일 메서드 (snake_case)
  - sign_message: Callable[[str], Awaitable[str]] 콜백

  4.5 사용 예시 코드 (Python):
  - 기본 사용, 에러 핸들링, Owner 플로우

  </action>
  <verify>
  - 38-sdk-mcp-interface.md 파일이 존재하고 문서 ID가 SDK-MCP
  - Zod SSoT 파이프라인이 다이어그램으로 정의됨
  - WAIaaSClient 메서드 시그니처가 Agent API에 1:1 매핑됨
  - WAIaaSOwnerClient 메서드 시그니처가 Owner API에 매핑됨
  - Python SDK가 동일 메서드를 async/httpx로 제공
  - WAIaaSError, RetryPolicy가 양쪽 SDK에 정의됨
  </verify>
  <done>TypeScript SDK + Python SDK 인터페이스가 메서드 시그니처, 에러 타입, Options Bag, 사용 예시 수준으로 설계됨. SDK-01, SDK-02 충족.</done>
</task>

<task type="auto">
  <name>Task 2: MCP Server 도구/리소스/전송 + Claude Desktop 연동 설계</name>
  <files>.planning/deliverables/38-sdk-mcp-interface.md</files>
  <action>
  38-sdk-mcp-interface.md에 다음 섹션을 추가한다.

  **섹션 5: MCP Server (@waiaas/mcp) -- MCP-01**

  5.1 패키지 구조:
  ```
  packages/mcp/
    src/
      server.ts        (McpServer 인스턴스 + tool/resource 등록)
      tools/           (도구별 핸들러)
        send-token.ts
        get-balance.ts
        get-address.ts
        list-transactions.ts
        get-transaction.ts
      resources/       (리소스 핸들러)
        wallet-balance.ts
        system-status.ts
      config.ts        (환경변수 + 설정)
      index.ts         (entry point -- transport 선택 + 서버 시작)
    package.json       (name: @waiaas/mcp, dependencies: @modelcontextprotocol/sdk, @waiaas/core)
  ```

  5.2 MCP Server 초기화:
  - McpServer 인스턴스: name='waiaas-wallet', version='0.2.0'
  - 세션 토큰: 환경변수 `WAIAAS_SESSION_TOKEN` 또는 `WAIAAS_TOKEN_FILE` (파일 경로)
  - Base URL: 환경변수 `WAIAAS_BASE_URL` (기본 'http://127.0.0.1:3100')

  5.3 MCP Tools (도구) -- 10개 이내 원칙, Agent 핵심 동작만:

  Tool 1 -- send_token:
  - description: "Send SOL from agent wallet to destination address"
  - inputSchema (Zod 재사용): { to: z.string(), amount: z.string(), memo: z.string().optional() }
  - 내부: POST /v1/transactions/send 호출
  - 응답: TransactionResponse JSON (txId, status, hash)

  Tool 2 -- get_balance:
  - description: "Get current SOL balance of agent wallet"
  - inputSchema: {} (파라미터 없음)
  - 내부: GET /v1/wallet/balance

  Tool 3 -- get_address:
  - description: "Get agent wallet address"
  - inputSchema: {} (파라미터 없음)
  - 내부: GET /v1/wallet/address

  Tool 4 -- list_transactions:
  - description: "List recent transactions with optional pagination"
  - inputSchema: { cursor: z.string().optional(), limit: z.number().optional() }
  - 내부: GET /v1/transactions

  Tool 5 -- get_transaction:
  - description: "Get details of a specific transaction by ID"
  - inputSchema: { id: z.string() }
  - 내부: GET /v1/transactions/:id (주의: Phase 7에서 개별 조회 엔드포인트는 list에서 id 필터로 대체 가능, 37번 문서 확인 후 결정)

  Tool 6 -- get_nonce:
  - description: "Get a fresh nonce for session creation (Owner use)"
  - inputSchema: {}
  - 내부: GET /v1/nonce

  총 6개 도구. 관리 도구(세션/정책/킬스위치)는 의도적으로 제외 (MCP는 에이전트 동작 전용, 관리는 REST API/Desktop/Telegram).

  5.4 MCP Resources (리소스) -- 읽기 전용 데이터:

  Resource 1 -- wallet-balance:
  - URI: waiaas://wallet/balance
  - mimeType: application/json
  - description: "Current SOL balance"
  - 내부: GET /v1/wallet/balance

  Resource 2 -- wallet-address:
  - URI: waiaas://wallet/address
  - mimeType: application/json
  - 내부: GET /v1/wallet/address

  Resource 3 -- system-status:
  - URI: waiaas://system/status
  - mimeType: application/json
  - description: "Daemon health and system state"
  - 내부: GET /health

  5.5 MCP Tool 응답 형식:
  - 성공: { content: [{ type: 'text', text: JSON.stringify(data) }] }
  - 에러: { content: [{ type: 'text', text: JSON.stringify({ error: code, message }) }], isError: true }
  - 모든 응답은 JSON text (LLM이 파싱 가능한 구조화된 텍스트)

  **섹션 6: MCP 세션 토큰 전달 메커니즘**

  6.1 Open Question 해결 (09-RESEARCH.md 참조):
  - 권장 방안: MCP 전용 장기 세션 발급
    - Owner가 MCP용 세션을 별도 생성: POST /v1/sessions { maxExpiry: '7d', constraints: { allowedOps: ['transfer', 'balance', 'address', 'list_tx'] } }
    - 환경변수: WAIAAS_SESSION_TOKEN=wai_sess_xxx...
    - 만료 시 Owner가 새 토큰 발급 -> 환경변수 업데이트 -> MCP Server 재시작

  6.2 토큰 갱신 전략:
  - v0.2: 수동 갱신 (Owner가 새 세션 발급, MCP config 업데이트)
  - v0.3 고려: MCP Server 내장 refresh 메커니즘 (Owner 승인 플로우)
  - 이유: Claude Desktop 등 MCP 호스트가 환경변수를 동적 업데이트하는 표준 방법이 없음

  6.3 Claude Desktop 설정 예시:
  ```json
  {
    "mcpServers": {
      "waiaas-wallet": {
        "command": "npx",
        "args": ["@waiaas/mcp"],
        "env": {
          "WAIAAS_SESSION_TOKEN": "wai_sess_eyJhbGciOi...",
          "WAIAAS_BASE_URL": "http://127.0.0.1:3100"
        }
      }
    }
  }
  ```

  **섹션 7: MCP Transport 설계**

  7.1 stdio Transport (기본 -- Claude Desktop용):
  - StdioServerTransport 사용
  - 프로세스 시작 시 환경변수에서 세션 토큰 로드
  - 장점: 가장 간단, 보안 (프로세스 격리)
  - CLI: `npx @waiaas/mcp` 또는 `waiaas mcp start`

  7.2 Streamable HTTP Transport (향후 -- remote MCP 확장용):
  - @hono/mcp 미들웨어 사용 가능성
  - WAIaaS 데몬에 /mcp 엔드포인트 추가 (v0.3 이연)
  - 인증: 세션 토큰을 HTTP Authorization 헤더로 전달
  - v0.2에서는 설계만, 구현은 v0.3

  7.3 Transport 선택 로직:
  ```
  if (process.env.WAIAAS_MCP_TRANSPORT === 'http') {
    // Streamable HTTP (v0.3)
  } else {
    // stdio (기본, v0.2)
  }
  ```

  **섹션 8: MCP-02 Claude Desktop 통합 시나리오**
  - 시나리오 1: "잔액 확인해줘" -> get_balance tool 자동 선택
  - 시나리오 2: "0.5 SOL을 xxx 주소로 보내줘" -> send_token tool 자동 선택
  - 시나리오 3: "최근 거래 보여줘" -> list_transactions tool 자동 선택
  - 제한: 관리 작업 (세션 생성, Kill Switch 등)은 MCP에서 불가 -> "이 작업은 WAIaaS Desktop 앱에서 수행해주세요" 안내

  **섹션 9: SDK vs MCP 기능 매트릭스**
  - 비교 테이블: 기능 x { TS SDK, Python SDK, MCP, REST API } 지원 여부
  - 원칙: REST API = 전체 기능, SDK = REST 래퍼, MCP = Agent 핵심 동작 subset

  **섹션 10: 보안 고려사항**
  - SDK baseUrl 기본값은 localhost이나 변경 가능 (Docker, SSH 터널)
  - MCP 세션 토큰은 환경변수에 평문 저장 -> 프로세스 메모리에만 존재, 파일 대안은 WAIAAS_TOKEN_FILE
  - MCP Tool은 Agent 권한만 (Owner/Admin 불가) -> 에이전트가 관리 기능 접근 불가
  - SDK retry는 멱등 GET만 자동, POST는 retryable=true 응답에만

  </action>
  <verify>
  - MCP Tools 6개가 Zod inputSchema + 응답 형식으로 정의됨
  - MCP Resources 3개가 URI + mimeType으로 정의됨
  - MCP 세션 토큰 전달이 환경변수 + 장기 세션으로 설계됨
  - Claude Desktop 설정 예시가 포함됨
  - stdio + Streamable HTTP 전송이 설계됨
  - SDK vs MCP 기능 매트릭스가 포함됨
  </verify>
  <done>MCP Server 도구/리소스/전송 + Claude Desktop 연동이 설계됨. MCP-01, MCP-02 충족. SDK-MCP 문서 완성.</done>
</task>

</tasks>

<verification>
1. 38-sdk-mcp-interface.md가 .planning/deliverables/에 존재
2. SDK-01: WAIaaSClient가 Agent API 전체 메서드를 Options Bag 패턴으로 제공
3. SDK-02: Python WAIaaSClient가 httpx async + Pydantic으로 동일 메서드 제공
4. MCP-01: 6개 Tool + 3개 Resource가 Zod 스키마로 정의됨
5. MCP-02: Claude Desktop 설정 예시 + 사용 시나리오가 포함됨
6. Zod SSoT -> SDK/MCP 파이프라인이 다이어그램으로 설명됨
7. 세션 토큰 전달 메커니즘이 stdio/HTTP 양쪽에 대해 설계됨
</verification>

<success_criteria>
- TypeScript SDK + Python SDK가 메서드 시그니처, 에러 타입, RetryPolicy 수준으로 설계됨
- MCP Server가 도구 6개 + 리소스 3개 + 전송 2종으로 설계됨
- Phase 9 Success Criteria #2 (SDK 인터페이스) + #3 (MCP Server) 충족
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-client-interface-design/09-02-SUMMARY.md`
</output>
