---
phase: 09-integration-client-interface-design
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - .planning/deliverables/39-tauri-desktop-architecture.md
autonomous: true

must_haves:
  truths:
    - "Tauri 2 앱 전체 아키텍처가 Sidecar + IPC + HTTP localhost 하이브리드로 설계됨"
    - "시스템 트레이가 3색 상태 아이콘(초록/노랑/빨강) + 메뉴 동작으로 정의됨"
    - "화면별 UI 플로우가 6개 이상 화면으로 컴포넌트 구조와 데이터 흐름 포함 설계됨"
    - "데몬 사이드카 라이프사이클(시작/중지/상태 감지)이 Tauri IPC 커맨드로 정의됨"
    - "WalletConnect QR 연결 플로우가 Tauri WebView용으로 설계됨 (@reown/appkit)"
    - "OS 네이티브 알림 + 자동 업데이트가 Tauri 플러그인 기반으로 설계됨"
    - "macOS/Windows/Linux 크로스 플랫폼 빌드 설정이 정의됨"
  artifacts:
    - path: ".planning/deliverables/39-tauri-desktop-architecture.md"
      provides: "Tauri Desktop 앱 전체 아키텍처, UI 플로우, 사이드카 통합, 크로스 플랫폼 설계"
      contains: "Tauri 2"
  key_links:
    - from: "39-tauri-desktop-architecture.md"
      to: "37-rest-api-complete-spec.md"
      via: "WebView가 Owner API를 HTTP localhost로 호출 (SDK 재사용 가능)"
      pattern: "localhost:3100.*Owner API"
    - from: "39-tauri-desktop-architecture.md"
      to: "34-owner-wallet-connection.md"
      via: "WalletConnect v2 QR 페어링 플로우 (@reown/appkit in WebView)"
      pattern: "reown.*appkit.*QR"
    - from: "39-tauri-desktop-architecture.md"
      to: "28-daemon-lifecycle-cli.md"
      via: "Sidecar가 데몬 바이너리를 관리 (시작/중지/상태)"
      pattern: "sidecar.*daemon.*lifecycle"
    - from: "39-tauri-desktop-architecture.md"
      to: "36-killswitch-autostop-evm.md"
      via: "Kill Switch 발동/복구 UI가 Owner API를 호출"
      pattern: "kill-switch.*recover"
---

<objective>
Tauri 2 기반 WAIaaS Desktop 앱의 전체 아키텍처를 설계한다 -- 데몬 사이드카 통합, Rust backend + WebView frontend 구조, 시스템 트레이 동작, 화면별 UI 플로우, WalletConnect QR 연결, OS 알림, 자동 업데이트, 크로스 플랫폼 빌드를 구현 가능한 수준으로 정의한다.

Purpose: Owner가 WAIaaS 데몬을 시각적으로 관리하는 데스크톱 앱이다. 거래 승인/거부, 세션 관리, 시스템 모니터링을 GUI로 제공하여 CLI 의존도를 낮춘다.
Output: 설계 문서 1개 -- 39-tauri-desktop-architecture.md (DESK-01, DESK-02, DESK-03, DESK-04 충족)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-client-interface-design/09-RESEARCH.md

# 09-01 SUMMARY (직접 의존 -- API 전체 스펙)
@.planning/phases/09-integration-client-interface-design/09-01-SUMMARY.md

# Phase 6-8 참조
@.planning/deliverables/28-daemon-lifecycle-cli.md (CORE-05: 데몬 라이프사이클, sidecar 대상)
@.planning/deliverables/34-owner-wallet-connection.md (OWNR-CONN: WalletConnect v2 Reown, QR 플로우)
@.planning/deliverables/36-killswitch-autostop-evm.md (KILL-AUTO-EVM: Kill Switch UI 동작)
@.planning/deliverables/24-monorepo-data-directory.md (CORE-01: packages/desktop 위치)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tauri 2 앱 아키텍처 + Sidecar + 시스템 트레이 설계</name>
  <files>.planning/deliverables/39-tauri-desktop-architecture.md</files>
  <action>
  설계 문서 `39-tauri-desktop-architecture.md`를 작성한다. 문서 ID는 `TAURI-DESK`.

  **섹션 1: 문서 개요**
  - 문서 ID: TAURI-DESK
  - 목적: Tauri 2 기반 WAIaaS Desktop 앱 전체 아키텍처 설계
  - 요구사항 매핑: DESK-01 (Tauri 앱 + 시스템 트레이), DESK-02 (대시보드 + 승인 인터페이스), DESK-03 (3 OS 빌드), DESK-04 (OS 알림 + 자동 업데이트)
  - 09-RESEARCH.md Pattern 3 (Tauri Sidecar + IPC) 기반

  **섹션 2: 전체 아키텍처 다이어그램**
  - Mermaid 다이어그램:
    ```
    Tauri App
    ├── Rust Backend (src-tauri/)
    │   ├── Sidecar Manager (데몬 프로세스 관리)
    │   ├── System Tray (3색 아이콘 + 메뉴)
    │   ├── IPC Commands (invoke handlers)
    │   ├── OS Notification Bridge
    │   └── Auto Updater
    ├── WebView Frontend (src/)
    │   ├── React (또는 SolidJS) SPA
    │   ├── @waiaas/sdk (HTTP localhost 호출)
    │   ├── @reown/appkit (WalletConnect QR)
    │   └── TailwindCSS
    └── WAIaaS Daemon (Sidecar Binary)
        └── Hono HTTP Server (127.0.0.1:3100)
    ```

  **섹션 3: 통신 아키텍처 -- 하이브리드 모델**
  - Tauri IPC (Rust invoke): 데몬 라이프사이클 관리에만 사용
    - start_daemon(): sidecar 프로세스 시작
    - stop_daemon(): sidecar 프로세스 중지 (graceful)
    - get_daemon_status(): sidecar 프로세스 alive + /health 응답 조합
    - get_daemon_logs(): 최근 로그 라인 읽기
  - HTTP localhost: API 호출에 사용 (WebView -> localhost:3100)
    - 장점: @waiaas/sdk를 WebView에서 그대로 재사용
    - WebView Origin: `tauri://localhost` -> CORS 허용 목록에 추가
    - fetch API 직접 사용 또는 SDK client 사용

  **섹션 4: Sidecar 관리**
  4.1 Sidecar 바이너리:
  - WAIaaS 데몬을 Node.js SEA (Single Executable Application) 또는 pkg로 단일 바이너리 변환
  - 바이너리 위치: Tauri externalBin 설정 (src-tauri/tauri.conf.json)
  - 바이너리 이름: waiaas-daemon-{target_triple} (예: waiaas-daemon-aarch64-apple-darwin)
  - native addon (sodium-native, better-sqlite3) 호환성은 v0.3 구현 시 검증 (설계 문서에 명시적 "구현 시 검증" 태그)

  4.2 Sidecar 라이프사이클:
  - Tauri 앱 시작 시: 자동으로 sidecar 시작 (config에 따라 옵션)
  - Tauri 앱 종료 시: sidecar graceful shutdown (/v1/admin/shutdown 호출 -> SIGTERM 폴백)
  - Sidecar 크래시 감지: 5초 주기 health check (/health), 크래시 시 자동 재시작 (최대 3회)
  - 첫 실행: waiaas init 미완료 시 초기 설정 위자드 화면으로 이동

  4.3 Rust IPC 커맨드 정의:
  ```rust
  #[tauri::command]
  async fn start_daemon(app: AppHandle) -> Result<DaemonStatus, String>

  #[tauri::command]
  async fn stop_daemon(app: AppHandle) -> Result<(), String>

  #[tauri::command]
  async fn get_daemon_status(app: AppHandle) -> Result<DaemonStatus, String>

  #[tauri::command]
  async fn restart_daemon(app: AppHandle) -> Result<DaemonStatus, String>
  ```
  - DaemonStatus: { running: bool, pid: Option<u32>, port: u16, uptime_secs: Option<u64>, health: Option<HealthResponse> }

  **섹션 5: 시스템 트레이 (DESK-01)**
  5.1 아이콘 상태:
  - 초록 (NORMAL): 데몬 정상 운영, 키스토어 열림
  - 노랑 (WARNING): 알림 채널 부족 (<2), 또는 에이전트 일시 정지 상태
  - 빨강 (CRITICAL): Kill Switch 발동, 또는 데몬 다운

  5.2 트레이 메뉴:
  - "WAIaaS v0.2" (비활성 타이틀)
  - 구분선
  - "Dashboard" -> 메인 윈도우 열기
  - "Pending Approvals (N)" -> 승인 화면으로 이동 (대기 건수 배지)
  - 구분선
  - "Start Daemon" / "Stop Daemon" (상태에 따라 토글)
  - "Emergency Kill Switch" -> 확인 다이얼로그 후 발동
  - 구분선
  - "Quit WAIaaS" -> 데몬 종료 + 앱 종료

  5.3 트레이 아이콘 업데이트:
  - 5초 주기 health check 결과 기반
  - Kill Switch 상태: system_state -> 아이콘 빨강
  - Pending approvals > 0: 배지 숫자 표시 (macOS) 또는 트레이 메뉴 텍스트

  **섹션 6: 프로젝트 구조**
  ```
  packages/desktop/
    src-tauri/
      src/
        main.rs          (Tauri entry point)
        sidecar.rs       (Sidecar 관리)
        tray.rs          (시스템 트레이)
        commands.rs      (IPC commands)
      tauri.conf.json    (앱 설정, externalBin)
      Cargo.toml
      icons/             (3색 트레이 아이콘 + 앱 아이콘)
    src/
      App.tsx            (React Router)
      pages/
        Dashboard.tsx
        Approvals.tsx
        Sessions.tsx
        Agents.tsx
        Settings.tsx
        Setup.tsx        (초기 설정 위자드)
        OwnerConnect.tsx (WalletConnect QR)
        KillSwitch.tsx   (Kill Switch 관리)
      components/
        Layout.tsx       (사이드바 + 헤더)
        TxCard.tsx       (거래 카드)
        SessionCard.tsx  (세션 카드)
        StatusBadge.tsx  (상태 배지)
      hooks/
        useDaemon.ts     (IPC 커맨드 래퍼)
        useOwnerApi.ts   (Owner API 호출)
        usePolling.ts    (주기적 데이터 갱신)
      lib/
        api.ts           (@waiaas/sdk WAIaaSOwnerClient 인스턴스)
    package.json         (dependencies: @tauri-apps/api, @waiaas/sdk, @reown/appkit, react, tailwindcss)
  ```

  </action>
  <verify>
  - 39-tauri-desktop-architecture.md 파일이 존재하고 문서 ID가 TAURI-DESK
  - 전체 아키텍처 다이어그램이 Rust Backend + WebView + Sidecar로 구성됨
  - IPC vs HTTP 하이브리드 통신이 설계됨
  - Sidecar 라이프사이클 (시작/중지/크래시/재시작)이 정의됨
  - 시스템 트레이 3색 아이콘 + 메뉴가 정의됨
  - 프로젝트 구조가 파일 수준으로 정의됨
  </verify>
  <done>Tauri 2 앱 아키텍처, Sidecar 관리, 시스템 트레이가 구현 가능한 수준으로 설계됨</done>
</task>

<task type="auto">
  <name>Task 2: UI 화면별 플로우 + WalletConnect QR + OS 알림 + 자동 업데이트 + 크로스 플랫폼 빌드</name>
  <files>.planning/deliverables/39-tauri-desktop-architecture.md</files>
  <action>
  39-tauri-desktop-architecture.md에 다음 섹션을 추가한다.

  **섹션 7: UI 화면별 플로우 (DESK-02)**

  화면 1 -- Dashboard (메인):
  - 레이아웃: 사이드바(네비게이션) + 콘텐츠 영역
  - 상단 카드 3개: SOL 잔액 (실시간), 오늘 거래 건수/금액, 활성 세션 수
  - 중앙: 최근 거래 목록 (최근 10건, TxCard 컴포넌트)
  - 우측: 시스템 상태 (데몬 uptime, 체인 어댑터 상태, Kill Switch 상태)
  - 데이터 소스: GET /v1/owner/dashboard (5초 폴링 또는 화면 포커스 시 갱신)

  화면 2 -- Pending Approvals (대기 거래 승인/거부):
  - 목록: APPROVAL 티어 대기 거래 카드 (금액, 대상 주소, 에이전트, 남은 시간)
  - 각 카드: [Approve] [Reject] 버튼
  - Approve 클릭: ownerAuth 서명 -> POST /v1/owner/approve/:txId
  - Reject 클릭: POST /v1/owner/reject/:txId (사유 입력 옵션)
  - 실시간: 5초 폴링 (GET /v1/owner/pending-approvals)
  - 빈 상태: "No pending approvals" 메시지

  화면 3 -- Sessions:
  - 목록: 모든 활성 세션 (SessionCard: 에이전트명, 만료 시간, 제약 조건 요약)
  - 각 카드: [Revoke] 버튼 -> DELETE /v1/owner/sessions/:id
  - 새 세션 생성: [Create Session] 버튼 -> 모달 (에이전트 선택, 만료 시간, 제약 조건 설정)

  화면 4 -- Agents:
  - 목록: 에이전트 카드 (이름, 상태 배지, 체인, 세션 수, 거래 수)
  - 상세: 클릭 시 에이전트 상세 화면 (최근 거래, 활성 세션, 적용 정책)

  화면 5 -- Settings:
  - 알림 채널 설정 (Telegram/Discord/ntfy.sh 추가/삭제/테스트)
  - 자동 정지 규칙 설정 (규칙 목록 + 편집)
  - 정책 관리 (SPENDING_LIMIT, WHITELIST 등)
  - 시스템 정보 (버전, 데몬 상태, 저장소 경로)

  화면 6 -- Setup Wizard (초기 설정):
  - Step 1: 마스터 패스워드 설정
  - Step 2: 체인 선택 (Solana, 에이전트 이름)
  - Step 3: Owner 지갑 연결 (WalletConnect QR)
  - Step 4: 알림 채널 설정 (최소 2개)
  - Step 5: 완료 확인 + 대시보드로 이동

  화면 7 -- Owner Connect:
  - WalletConnect QR 코드 표시 (@reown/appkit)
  - 연결 상태: "Waiting for connection..." -> "Connected to {address}"
  - 연결 해제 버튼
  - Mermaid 시퀀스 다이어그램: WebView -> @reown/appkit -> WalletConnect Relay -> Owner Mobile Wallet

  화면 8 -- Kill Switch:
  - 현재 상태 표시 (NORMAL/ACTIVATED/RECOVERING)
  - NORMAL 상태: [Activate Kill Switch] 빨간 버튼 (확인 다이얼로그)
  - ACTIVATED 상태: 영향 요약 (폐기 세션/취소 거래/정지 에이전트 수) + [Recover] 버튼
  - Recover: 마스터 패스워드 입력 + Owner 서명 요청

  **섹션 8: WalletConnect QR 연결 플로우 (Tauri WebView)**
  - @reown/appkit 초기화: WalletConnect projectId (config.toml에서 읽기)
  - QR 코드: appkit 자동 생성 (모달 또는 인라인)
  - 연결 성공: POST /v1/owner/connect (localhost, ownerAuth 제외)
  - 서명 요청: appkit.signMessage() -> Owner 모바일 지갑에서 서명 -> 콜백
  - Tauri WebView 제약: Chrome Extension API 미지원 -> QR만 가능 (브라우저 확장 안 됨)
  - CORS: tauri://localhost Origin이 CORS 허용 목록에 포함 (37번 문서 참조)

  **섹션 9: OS 네이티브 알림 (DESK-04)**
  - @tauri-apps/plugin-notification 사용
  - 알림 트리거:
    - 새 APPROVAL 대기 거래 발생 시
    - Kill Switch 발동/복구 시
    - 에이전트 자동 정지 시
    - 세션 만료 임박 시 (5분 전)
  - 알림 형식: { title, body, icon } (OS별 자동 적응)
  - 알림 클릭: 해당 화면으로 이동 (Approvals, KillSwitch 등)
  - 폴링 기반: WebView에서 5초 주기 상태 확인 -> 변경 감지 시 Rust IPC로 OS 알림 전송

  **섹션 10: 자동 업데이트 (DESK-04)**
  - @tauri-apps/plugin-updater 사용
  - 업데이트 서버: CrabNebula Cloud 또는 GitHub Releases (JSON endpoint)
  - 업데이트 확인 주기: 앱 시작 시 + 24시간 주기
  - 플로우: 업데이트 확인 -> 다운로드 -> 알림 표시 "Update available v0.2.1" -> [Install & Restart] 버튼
  - 서명 검증: Tauri 내장 서명 검증 (tauri.conf.json > plugins > updater > pubkey)
  - 사이드카 바이너리도 함께 업데이트 (Tauri 번들에 포함)

  **섹션 11: 크로스 플랫폼 빌드 (DESK-03)**
  - 빌드 대상:
    - macOS: aarch64-apple-darwin (Apple Silicon), x86_64-apple-darwin (Intel)
    - Windows: x86_64-pc-windows-msvc
    - Linux: x86_64-unknown-linux-gnu (AppImage + .deb)
  - CI/CD: GitHub Actions 매트릭스 빌드
  - 서명:
    - macOS: Apple Developer Certificate (code signing + notarization)
    - Windows: Authenticode code signing
    - Linux: 서명 불필요 (AppImage 자체 서명 옵션)
  - 배포:
    - GitHub Releases (모든 플랫폼)
    - macOS: DMG 이미지
    - Windows: MSI + NSIS 인스톨러
    - Linux: AppImage + .deb (Debian/Ubuntu)
  - Sidecar 크로스 컴파일: 각 target triple에 맞는 Node.js SEA 바이너리 빌드
  - native addon 크로스 컴파일 주의사항 (sodium-native, better-sqlite3) -- v0.3 구현 시 검증 필요

  **섹션 12: 보안 고려사항**
  - WebView CSP: default-src 'self'; connect-src 'self' http://127.0.0.1:3100
  - Tauri allowlist: 필요한 IPC 커맨드만 허용 (capabilities 설정)
  - 마스터 패스워드: WebView 메모리에만 존재, 전송 후 즉시 null 처리
  - WalletConnect projectId: config.toml에서 읽기 (하드코딩 금지)
  - Sidecar 바이너리 무결성: Tauri 번들 서명으로 보호

  </action>
  <verify>
  - UI 화면 8개가 레이아웃/데이터 소스/사용자 동작으로 정의됨
  - WalletConnect QR 연결 플로우가 @reown/appkit + Tauri WebView로 설계됨
  - OS 네이티브 알림이 트리거 조건 + 알림 형식으로 정의됨
  - 자동 업데이트가 CrabNebula/GitHub + 서명 검증으로 설계됨
  - 크로스 플랫폼 빌드가 macOS/Windows/Linux 3종 + 배포 포맷으로 정의됨
  - 보안 CSP + Tauri capabilities가 명시됨
  </verify>
  <done>UI 플로우, WalletConnect QR, OS 알림, 자동 업데이트, 크로스 플랫폼 빌드가 완성됨. DESK-01~04 모두 충족.</done>
</task>

</tasks>

<verification>
1. 39-tauri-desktop-architecture.md가 .planning/deliverables/에 존재
2. DESK-01: Tauri 앱 + 시스템 트레이 3색 아이콘 + 메뉴가 설계됨
3. DESK-02: Dashboard + 승인/거부 인터페이스 + 세션/에이전트 관리 화면이 설계됨
4. DESK-03: macOS/Windows/Linux 빌드 + 배포 포맷이 정의됨
5. DESK-04: OS 네이티브 알림 (트리거 4종) + 자동 업데이트 (CrabNebula/GitHub)가 설계됨
6. Sidecar 라이프사이클이 Rust IPC 커맨드로 정의됨
7. WalletConnect QR 플로우가 Tauri WebView 제약 사항과 함께 설계됨
</verification>

<success_criteria>
- Tauri 2 앱이 12개 섹션으로 완전히 설계됨 (아키텍처 + UI 8화면 + 알림 + 업데이트 + 빌드)
- Phase 9 Success Criteria #4 "Tauri Desktop 앱 아키텍처가 설계됨" 충족
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-client-interface-design/09-03-SUMMARY.md`
</output>
