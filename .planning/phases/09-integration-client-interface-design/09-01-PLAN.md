---
phase: 09-integration-client-interface-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/37-rest-api-complete-spec.md
autonomous: true

must_haves:
  truths:
    - "30개 전체 엔드포인트가 요청/응답 Zod 스키마 수준으로 정의됨 (Phase 6-8에서 분산 정의된 것 + Phase 9 신규 7개 통합)"
    - "인증 체계 3종이 OpenAPI securitySchemes로 정의됨 (Session Bearer, Owner Signature, Master Password)"
    - "에러 코드 체계가 도메인별로 정리됨 (AUTH, SESSION, TX, POLICY, OWNER, SYSTEM, AGENT 카테고리)"
    - "OpenAPI 3.0 문서 구조가 정의됨 (태그, 보안 스키마, 공통 응답, Zod SSoT 파이프라인)"
    - "Owner 전용 API 확장 7개 엔드포인트(sessions, agents, settings, dashboard)가 상세 스펙으로 정의됨"
  artifacts:
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "REST API 전체 스펙, 인증 체계, 에러 코드, OpenAPI 3.0 구조"
      contains: "OpenAPI 3.0"
  key_links:
    - from: "37-rest-api-complete-spec.md"
      to: "29-api-framework-design.md"
      via: "OpenAPIHono + Zod SSoT 패턴 기반 전체 라우트 정의"
      pattern: "createRoute.*openapi"
    - from: "37-rest-api-complete-spec.md"
      to: "32-transaction-pipeline-api.md"
      via: "Transaction API 엔드포인트 스키마 통합 (Phase 7에서 정의된 9개)"
      pattern: "/v1/transactions"
    - from: "37-rest-api-complete-spec.md"
      to: "34-owner-wallet-connection.md"
      via: "Owner API 8개 엔드포인트 + Phase 9 확장 7개 통합"
      pattern: "/v1/owner"
    - from: "37-rest-api-complete-spec.md"
      to: "30-session-token-protocol.md"
      via: "세션 인증 스키마 + 세션 API 통합"
      pattern: "bearerAuth.*wai_sess_"
---

<objective>
WAIaaS v0.2의 전체 REST API 스펙을 하나의 완전한 설계 문서로 통합한다 -- Phase 6-8에서 분산 정의된 23개 엔드포인트와 Phase 9에서 추가하는 7개 엔드포인트를 합쳐 총 30개 엔드포인트의 요청/응답 스키마, 인증 체계, 에러 코드 체계, OpenAPI 3.0 구조를 정의한다.

Purpose: SDK, MCP Server, Tauri Desktop, Telegram Bot 등 모든 클라이언트가 참조하는 API 단일 소스(Single Source of Truth)를 확립한다. 이 문서가 Phase 9의 나머지 3개 플랜의 기반이 된다.
Output: 설계 문서 1개 -- 37-rest-api-complete-spec.md (Phase 9 Success Criteria #1 충족)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-client-interface-design/09-RESEARCH.md

# Phase 6-8 핵심 참조 (API 엔드포인트 정의 원본)
@.planning/deliverables/29-api-framework-design.md (CORE-06: Hono OpenAPIHono, 8 middleware, localhost 보안, Zod/OpenAPI)
@.planning/deliverables/30-session-token-protocol.md (SESS-PROTO: JWT HS256, sessionAuth 2-stage, POST /v1/sessions)
@.planning/deliverables/32-transaction-pipeline-api.md (TX-PIPE: 6-stage pipeline, 9 API endpoints Zod specs)
@.planning/deliverables/34-owner-wallet-connection.md (OWNR-CONN: WalletConnect v2, ownerAuth 8-step, Owner API 8 endpoints)
@.planning/deliverables/36-killswitch-autostop-evm.md (KILL-AUTO-EVM: Kill Switch API, /v1/admin/kill-switch)
@.planning/deliverables/25-sqlite-schema.md (CORE-02: 7 tables, 스키마 참조)
@.planning/deliverables/28-daemon-lifecycle-cli.md (CORE-05: /v1/admin/shutdown)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent/Session/Transaction/Wallet API 통합 스펙 + 인증 체계 설계</name>
  <files>.planning/deliverables/37-rest-api-complete-spec.md</files>
  <action>
  설계 문서 `37-rest-api-complete-spec.md`를 작성한다. 문서 ID는 `API-SPEC`.

  **섹션 1: 문서 개요**
  - 문서 ID: API-SPEC
  - 목적: WAIaaS v0.2 REST API 전체 스펙 통합 문서 (SDK/MCP/Desktop/Bot의 단일 참조 소스)
  - 참조 문서: CORE-06, SESS-PROTO, TX-PIPE, OWNR-CONN, KILL-AUTO-EVM, CORE-02, CORE-05
  - v0.1과의 핵심 차이: API Key -> JWT Session, Cloud URL -> localhost:3100, OAuth scopes -> 3종 인증 체계

  **섹션 2: 서버 정보 + 기본 설정**
  - Base URL: `http://127.0.0.1:{port}` (기본 3100, config.toml [server].port)
  - Content-Type: application/json 단일 (content negotiation 미채택 -- CORE-06 결정)
  - 공통 헤더: X-Request-ID (UUID v7, 서버 자동 생성), X-RateLimit-* (Remaining, Limit, Reset)
  - CORS: Origin `tauri://localhost` 추가 (Phase 9 Tauri WebView 대응, CORE-06에서 예고된 과제)

  **섹션 3: 인증 체계 (OpenAPI securitySchemes)**
  3종 인증 스키마를 OpenAPI securitySchemes로 정의:

  (1) Session Bearer (`bearerAuth`):
  - type: http, scheme: bearer, bearerFormat: JWT
  - 토큰 형식: `wai_sess_` + JWT HS256 (~270 bytes)
  - sessionAuth 2-stage 검증 (SESS-PROTO 참조): Stage 1 JWT verify (no DB) -> Stage 2 DB lookup
  - 적용: Agent API 전체 (/v1/wallet/*, /v1/transactions/*)

  (2) Owner Signature (`ownerAuth`):
  - type: apiKey, in: header, name: X-Owner-Signature
  - 페이로드: base64url JSON { chain, address, action, nonce, timestamp, message, signature }
  - 검증: 8-step verify chain (OWNR-CONN 참조)
  - 유효기간: 5분 (timestamp + nonce + action binding)
  - 적용: Owner API (/v1/owner/*), POST /v1/sessions (세션 발급)

  (3) Master Password (`masterAuth`):
  - type: apiKey, in: header, name: X-Master-Password
  - Argon2id 검증 -> 키스토어 잠금 해제
  - 적용: Admin API (/v1/admin/*)
  - brute-force 방지: 5회 실패 -> 30분 lockout

  **섹션 4: 미들웨어 체인 (Phase 8 확장 반영)**
  - 9단계: ID -> Log -> ShutdownGuard -> SecureHeaders -> Host -> CORS -> Rate -> KillSwitchGuard -> Auth
  - killSwitchGuard 위치와 동작: ACTIVATED 상태에서 허용 엔드포인트 목록 (/health, /v1/owner/recover, /v1/admin/status)

  **섹션 5: Public API (인증 불필요)**
  각 엔드포인트를 다음 형식으로 정의:
  - Method + Path
  - 설명
  - Auth: None
  - Request: (params/query/body) Zod 스키마 명세 (필드명, 타입, 제약조건, 예시)
  - Response: 200/4xx/5xx 별 Zod 스키마 + 예시 JSON
  - 정의 원본 (어느 Phase 문서에서 정의됨)

  엔드포인트 목록:
  - GET /health (CORE-06)
  - GET /doc (CORE-06, debug 모드만)
  - GET /v1/nonce (SESS-PROTO)

  **섹션 6: Session API (Agent 인증)**
  - GET /v1/wallet/balance (TX-PIPE)
  - GET /v1/wallet/address (TX-PIPE)
  - POST /v1/transactions/send (TX-PIPE) -- 응답 분기: INSTANT=200, DELAY/APPROVAL=202
  - GET /v1/transactions (TX-PIPE) -- cursor pagination (UUID v7 기반)
  - GET /v1/transactions/pending (TX-PIPE)

  각 엔드포인트에 대해:
  - Zod 스키마 (input/output) 필드별 상세 (타입, 제약조건, openapi metadata)
  - 성공 응답 + 에러 응답 예시 JSON
  - Rate limit 적용 티어 (전역/세션/거래)

  **섹션 7: Session Management API (Owner 인증)**
  - POST /v1/sessions (SESS-PROTO) -- Owner SIWS/SIWE로 에이전트 세션 발급
  - GET /v1/sessions (SESS-PROTO)
  - DELETE /v1/sessions/:id (SESS-PROTO)

  </action>
  <verify>
  - 37-rest-api-complete-spec.md 파일이 존재하고 문서 ID가 API-SPEC
  - 인증 체계 3종이 OpenAPI securitySchemes 형식으로 정의됨
  - Public API 3개, Session API 5개, Session Management API 3개 엔드포인트가 상세 스펙으로 정의됨
  - 각 엔드포인트에 Request/Response Zod 스키마가 포함됨
  </verify>
  <done>Public + Session + Session Management API 총 11개 엔드포인트와 인증 체계 3종이 완전한 Zod 스키마 수준으로 정의됨</done>
</task>

<task type="auto">
  <name>Task 2: Owner/Admin API 확장 스펙 + 에러 코드 체계 + OpenAPI 구조 요약</name>
  <files>.planning/deliverables/37-rest-api-complete-spec.md</files>
  <action>
  37-rest-api-complete-spec.md에 다음 섹션을 추가한다.

  **섹션 8: Owner API (Owner 인증)**
  Phase 8에서 정의된 기존 8개:
  - POST /v1/owner/connect (OWNR-CONN) -- 인증: None (localhost 보안)
  - DELETE /v1/owner/disconnect (OWNR-CONN)
  - POST /v1/owner/approve/:txId (OWNR-CONN)
  - POST /v1/owner/reject/:txId (OWNR-CONN)
  - POST /v1/owner/kill-switch (KILL-AUTO-EVM)
  - POST /v1/owner/recover (KILL-AUTO-EVM)
  - GET /v1/owner/pending-approvals (OWNR-CONN)
  - GET /v1/owner/status (OWNR-CONN)

  Phase 9에서 추가하는 7개:
  - GET /v1/owner/sessions -- 세션 목록 (Owner 관점, 모든 에이전트 세션 포함)
    - Query: ?cursor, ?limit(default 20, max 100), ?agentId(optional filter), ?active(boolean filter)
    - Response: { sessions: Session[], nextCursor: string | null }
  - DELETE /v1/owner/sessions/:id -- 세션 즉시 폐기 (Owner 직접)
    - Response: { revoked: true, sessionId }
  - GET /v1/owner/agents -- 에이전트 목록
    - Response: { agents: Agent[] } (id, name, status, chain, createdAt, sessionCount, totalTxCount)
  - GET /v1/owner/agents/:id -- 에이전트 상세 (최근 거래, 활성 세션, 정책 요약)
    - Response: { agent, recentTransactions, activeSessions, policies }
  - GET /v1/owner/settings -- 시스템 설정 조회 (보안 관련 설정 현황)
    - Response: { server, security, notifications, autoStop } (민감 값 마스킹 -- botToken 마지막 4자만)
  - PUT /v1/owner/settings -- 시스템 설정 변경
    - Body: Partial<Settings> (허용 필드만: notifications, autoStop rules, policies)
    - 변경 불가 필드: hostname (127.0.0.1 강제), jwt_secret
    - Response: { updated: true, settings }
  - GET /v1/owner/dashboard -- 대시보드 요약
    - Response: { balance: { sol, chain }, todayTxCount, todayTxVolume, activeSessions, pendingApprovals, systemState, agentStatuses }

  Policy Management:
  - POST /v1/owner/policies (OWNR-CONN)
  - PUT /v1/owner/policies/:policyId (OWNR-CONN)

  각 엔드포인트에 대해 동일 형식: Method, Path, Auth, Request Zod, Response Zod, Error codes, 정의 원본.

  **섹션 9: Admin API (Master Password 인증)**
  - POST /v1/admin/kill-switch (KILL-AUTO-EVM) -- CLI 전용, WalletConnect 불필요
  - POST /v1/admin/shutdown (CORE-05) -- Graceful shutdown 트리거
  - GET /v1/admin/status -- 데몬 상태 조회 (uptime, kill_switch_status, adapter_health, worker_status)

  **섹션 10: 에러 코드 체계**
  CORE-06에서 정의한 간소화 포맷 기반으로 전체 에러 코드 정리:
  ```
  { code: string, message: string, details?: unknown, requestId: string, retryable: boolean }
  ```

  도메인별 에러 코드 테이블:
  - AUTH 도메인: INVALID_TOKEN, TOKEN_EXPIRED, SESSION_REVOKED, INVALID_SIGNATURE, INVALID_NONCE, INVALID_MASTER_PASSWORD, MASTER_PASSWORD_LOCKED, SYSTEM_LOCKED
  - SESSION 도메인: SESSION_NOT_FOUND, SESSION_EXPIRED, SESSION_LIMIT_EXCEEDED, CONSTRAINT_VIOLATED
  - TX 도메인: INSUFFICIENT_BALANCE, INVALID_ADDRESS, TX_NOT_FOUND, TX_EXPIRED, TX_ALREADY_PROCESSED, CHAIN_ERROR, SIMULATION_FAILED
  - POLICY 도메인: POLICY_DENIED, SPENDING_LIMIT_EXCEEDED, RATE_LIMIT_EXCEEDED, WHITELIST_DENIED
  - OWNER 도메인: OWNER_ALREADY_CONNECTED, OWNER_NOT_CONNECTED, APPROVAL_TIMEOUT, APPROVAL_NOT_FOUND
  - SYSTEM 도메인: KILL_SWITCH_ACTIVE, KILL_SWITCH_NOT_ACTIVE, KEYSTORE_LOCKED, CHAIN_NOT_SUPPORTED, SHUTTING_DOWN
  - AGENT 도메인: AGENT_NOT_FOUND, AGENT_SUSPENDED, AGENT_TERMINATED

  각 에러 코드에 HTTP status code + retryable 여부 + 설명 포함.

  **섹션 11: 공통 응답 스키마**
  - PaginatedResponse<T>: { data: T[], nextCursor: string | null, hasMore: boolean }
  - ErrorResponse: { code, message, details, requestId, retryable }
  - SuccessResponse<T>: T (래퍼 없이 직접 반환 -- v0.2 간소화)

  **섹션 12: OpenAPI 3.0 문서 구조 요약**
  - Zod SSoT 파이프라인: Zod Schema -> z.infer<> TS Type -> .openapi() -> createRoute() -> /doc JSON
  - 태그 그룹: Public, Wallet, Transaction, Session, Owner, Admin
  - securitySchemes 3종 (위 섹션 3 요약)
  - 자동 생성 경로: GET /doc -> OpenAPI JSON (debug 모드) or GET /doc -> Swagger UI
  - v0.3 확장 포인트: SPL 토큰 엔드포인트, EVM 체인 엔드포인트, 멀티 에이전트 관리

  **섹션 13: API 버전 관리 전략**
  - v0.2: /v1 단일 버전 (breaking change 없음)
  - v0.3+ 전략: /v1 유지 + 신규 엔드포인트 추가 (additive), breaking change 시 /v2 신설
  - Deprecation 정책: deprecated header + 6개월 유지

  </action>
  <verify>
  - Owner API 기존 8개 + 신규 7개 = 15개 엔드포인트가 상세 스펙으로 정의됨
  - Admin API 3개 엔드포인트가 정의됨
  - 에러 코드가 7개 도메인으로 분류되어 HTTP status + retryable 포함
  - OpenAPI 3.0 문서 구조가 태그, securitySchemes, Zod SSoT 파이프라인으로 정의됨
  - 전체 30개 엔드포인트가 문서에 포함됨 (Public 3 + Session 5 + Session Mgmt 3 + Owner 17 + Admin 3 = 31, /doc 포함)
  </verify>
  <done>Owner/Admin API + 에러 코드 체계 + OpenAPI 구조가 완성되어 Phase 9 Success Criteria #1 "REST API 전체 스펙 완성" 충족</done>
</task>

</tasks>

<verification>
1. 37-rest-api-complete-spec.md가 .planning/deliverables/에 존재
2. Phase 6-8에서 정의된 23개 엔드포인트가 모두 통합됨
3. Phase 9 신규 7개 Owner 엔드포인트가 추가됨
4. 인증 체계 3종(Session, Owner, Master)이 OpenAPI securitySchemes로 정의됨
5. 에러 코드가 도메인별 테이블로 정리됨 (최소 25개 코드)
6. 각 엔드포인트에 Request/Response Zod 스키마 + 예시 JSON이 포함됨
7. Zod SSoT -> OpenAPI 파이프라인이 설명됨
</verification>

<success_criteria>
- 30개 전체 엔드포인트가 Zod 스키마 수준으로 완전히 정의된 단일 문서
- 에러 코드 체계가 SDK/MCP/Desktop/Bot 클라이언트가 참조할 수 있는 수준으로 정리됨
- OpenAPI 3.0 구조가 자동 생성 파이프라인과 함께 설계됨
- Phase 9 Success Criteria #1 충족
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-client-interface-design/09-01-SUMMARY.md`
</output>
