---
phase: 40-test-design-doc-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/38-sdk-mcp-interface.md
  - objectives/v0.9-session-management-automation.md
autonomous: true

must_haves:
  truths:
    - "T-01~T-14 핵심 검증 시나리오 각각의 검증 내용, 테스트 레벨(Unit/Integration), 검증 방법이 설계 문서에 명시되어 있다"
    - "S-01~S-04 보안 시나리오 각각의 검증 내용과 검증 방법이 설계 문서에 명시되어 있다"
    - "각 시나리오가 관련 설계 결정 ID(SM-XX, SMGI-DXX, TF-XX, CLI-XX, TG-XX, NOTI-XX)를 참조하여 추적 가능하다"
  artifacts:
    - path: ".planning/deliverables/38-sdk-mcp-interface.md"
      provides: "18개 테스트 시나리오 설계 섹션 (섹션 12)"
      contains: "T-01"
    - path: "objectives/v0.9-session-management-automation.md"
      provides: "성공 기준 10/11 설계 완료 표기"
      contains: "설계 확정"
  key_links:
    - from: "38-sdk-mcp-interface.md 섹션 12 테스트 시나리오"
      to: "Phase 36-39 설계 결정 (SM-01~14, SMGI-D01~04, TF-01~05, CLI-01~06, TG-01~06, NOTI-01~05)"
      via: "관련 설계 결정 ID 컬럼"
      pattern: "SM-|SMGI-D|TF-|CLI-|TG-|NOTI-"
    - from: "objectives 성공 기준 10/11"
      to: "38-sdk-mcp-interface.md 테스트 섹션"
      via: "Phase 40 완료 표기"
      pattern: "설계 확정.*Phase 40"
---

<objective>
38-sdk-mcp-interface.md에 v0.9 테스트 설계 섹션(섹션 12)을 추가하여, 14개 핵심 검증 시나리오(T-01~T-14)와 4개 보안 시나리오(S-01~S-04) 각각의 검증 내용, 테스트 레벨, 검증 방법, 관련 설계 결정 ID를 명시한다.

Purpose: 구현 단계(v1.x)에서 테스트 계획의 기반이 되는 18개 시나리오를 설계 문서에 SSoT로 통합한다. v0.9 objectives의 성공 기준 10/11번을 충족시킨다.
Output: 38-sdk-mcp-interface.md 수정 (테스트 섹션 추가), objectives 수정 (성공 기준 업데이트)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-test-design-doc-integration/40-RESEARCH.md
@.planning/deliverables/38-sdk-mcp-interface.md
@objectives/v0.9-session-management-automation.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 38-sdk-mcp-interface.md에 테스트 설계 섹션 추가 (TEST-01, TEST-02)</name>
  <files>.planning/deliverables/38-sdk-mcp-interface.md</files>
  <action>
38-sdk-mcp-interface.md의 섹션 11(구현 노트) 다음에 새로운 최상위 섹션 "## 12. v0.9 테스트 설계 [v0.9]"을 추가한다.

이 섹션은 두 개의 하위 섹션으로 구성된다:

**### 12.1 핵심 검증 시나리오 (T-01~T-14) [v0.9 Phase 40]**

아래 테이블 형식으로 14개 시나리오를 명시한다. 각 시나리오의 검증 방법은 40-RESEARCH.md의 "T-01~T-14 테스트 시나리오 상세 분석" 매핑을 기반으로 작성한다.

테이블 컬럼: | # | 시나리오 | 검증 내용 | 테스트 레벨 | 검증 방법 | 관련 설계 결정 |

각 시나리오 상세 (40-RESEARCH.md 매핑 그대로 사용):
- T-01: 최초 기동 (env var만) | Unit | readMcpToken mock -> null, WAIAAS_SESSION_TOKEN 설정 -> SessionManager.start() -> getToken() 비교 | SM-04, SM-06
- T-02: 최초 기동 (파일 존재) | Unit | readMcpToken mock -> valid JWT, env var도 설정 -> start() -> getToken()이 파일 토큰인지 검증 | SM-04, TF-01
- T-03: 자동 갱신 성공 | Integration | fake timer 사용, PUT /renew mock -> 200 OK -> writeMcpToken 호출 확인 + getToken() 새 토큰 확인 | SM-09, SM-10
- T-04: 자동 갱신 실패 (TOO_EARLY) | Unit | PUT /renew mock -> 403 RENEWAL_TOO_EARLY -> 30초 timer 재설정 확인 | SM-11
- T-05: 갱신 한도 도달 | Unit | PUT /renew mock -> 403 RENEWAL_LIMIT_REACHED -> scheduleRenewal 미호출 확인 | SM-11, SM-13, NOTI-01~05
- T-06: 절대 수명 만료 | Unit | PUT /renew mock -> 403 SESSION_LIFETIME_EXCEEDED -> state = 'expired' 확인 | SM-11
- T-07: 외부 토큰 교체 감지 | Integration | GET mock -> 401 -> readMcpToken mock 새 토큰 반환 -> handleUnauthorized() true -> 재시도 성공 | SM-12, SMGI-D02
- T-08: Telegram /newsession | Integration | mock agentService.listActive, mock sessionService.create -> writeMcpToken 호출 + sendMessage 확인 | TG-01~TG-06
- T-09: CLI mcp setup | Integration | mock fetch (health + sessions POST) -> writeMcpToken 호출 + stdout Claude Desktop config 포함 | CLI-01~CLI-06
- T-10: CLI mcp refresh-token | Integration | mock fetch (health + sessions GET/POST/DELETE) -> 생성->파일->폐기 순서 검증 | CLI-03, CLI-06
- T-11: 토큰 파일 권한 | Unit | writeMcpToken 호출 후 statSync -> mode & 0o777 === 0o600 검증 (POSIX만) | TF-01, TF-04
- T-12: 동시 갱신 방지 | Unit | renew() inflight 중 getToken() 호출 -> 구 토큰 반환 + isRenewing true 검증 | SM-14, SMGI-D02
- T-13: 데몬 미기동 상태 | Unit | fetch mock -> network error -> retryRenewal(60000, 3) 호출 + 3회 후 state = 'error' | SM-11, SM-07
- T-14: SESSION_EXPIRING_SOON 알림 | Integration | shouldNotifyExpiringSession(remainingRenewals=2, absoluteExpiresAt=future) -> true + notificationService.notify mock 호출 | NOTI-01~NOTI-05

**### 12.2 보안 시나리오 (S-01~S-04) [v0.9 Phase 40]**

테이블 컬럼: | # | 시나리오 | 검증 내용 | 검증 방법 | 관련 설계 결정 |

각 시나리오 상세:
- S-01: mcp-token 파일 권한 | POSIX: 0o644 mode 파일 생성 -> readMcpToken -> null 또는 경고 로그. Windows: 권한 검증 스킵 + 경고 (H-03). POSIX 전용 테스트 | TF-01, H-03
- S-02: 토큰 파일 악성 내용 | 파일에 "not-a-jwt" 작성 -> readMcpToken -> null. 잘린 JWT 작성 -> readMcpToken -> null | TF-01
- S-03: /newsession 미인증 사용자 | 잘못된 chatId로 handleNewSession 호출 -> sendUnauthorized 호출 확인 | TG-01
- S-04: 토큰 파일 심볼릭 링크 | symlink 생성 -> readMcpToken -> null + console.error 로그 확인 | TF-01

테이블 아래에 간략한 설명 문단을 추가:
- 테스트 시나리오 원본: v0.9 objectives "테스트 전략" 섹션
- 설계 결정 참조: Phase 36(TF-01~05, NOTI-01~05), Phase 37(SM-01~14), Phase 38(SMGI-D01~04), Phase 39(CLI-01~06, TG-01~06)
- 구현 시점: v1.3 (SDK+MCP 마일스톤) 이후

주의사항:
- 기존 문서 끝부분 구조 참고: 현재 마지막 최상위 섹션은 "## 11. 구현 노트". 그 뒤에 참조 문서 목록(### v0.5 참조 문서, ### v0.9 참조 문서)이 있다. "## 12. v0.9 테스트 설계" 섹션은 "## 11. 구현 노트" 섹션과 참조 문서 목록 사이에 삽입한다.
- 검증 방법 작성 시 Phase 36-39에서 확정된 설계 결정과 일치하는지 확인. 특히 T-07의 handleUnauthorized는 SM-12(4-step)와 일치해야 한다.
- [v0.9] 태그를 섹션 헤더에 사용 (기존 컨벤션 준수)
  </action>
  <verify>
grep으로 검증:
1. `grep -c "T-01\|T-02\|T-03\|T-04\|T-05\|T-06\|T-07\|T-08\|T-09\|T-10\|T-11\|T-12\|T-13\|T-14" .planning/deliverables/38-sdk-mcp-interface.md` -- 14개 이상
2. `grep -c "S-01\|S-02\|S-03\|S-04" .planning/deliverables/38-sdk-mcp-interface.md` -- 4개 이상
3. `grep "## 12\. v0\.9 테스트 설계" .planning/deliverables/38-sdk-mcp-interface.md` -- 섹션 존재
4. `grep "12\.1 핵심 검증 시나리오" .planning/deliverables/38-sdk-mcp-interface.md` -- 하위 섹션 존재
5. `grep "12\.2 보안 시나리오" .planning/deliverables/38-sdk-mcp-interface.md` -- 하위 섹션 존재
  </verify>
  <done>
38-sdk-mcp-interface.md에 "## 12. v0.9 테스트 설계 [v0.9]" 섹션이 존재하고, T-01~T-14 14개 핵심 시나리오와 S-01~S-04 4개 보안 시나리오 각각에 검증 내용, 테스트 레벨, 검증 방법, 관련 설계 결정 ID가 테이블로 명시되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: v0.9 objectives 성공 기준 업데이트</name>
  <files>objectives/v0.9-session-management-automation.md</files>
  <action>
objectives/v0.9-session-management-automation.md의 성공 기준 섹션에서 항목 10, 11을 설계 완료로 업데이트한다.

현재 상태:
```
10. 14개 핵심 검증 시나리오와 4개 보안 시나리오가 설계 문서에 명시됨
11. 각 시나리오의 테스트 레벨(Unit/Integration)이 정의됨
```

변경 후:
```
10. 14개 핵심 검증 시나리오와 4개 보안 시나리오가 설계 문서에 명시됨 -- **[설계 확정 -- Phase 40-01]** (38-sdk-mcp-interface.md 섹션 12에 검증 방법 + 관련 설계 결정 ID 포함)
11. 각 시나리오의 테스트 레벨(Unit/Integration)이 정의됨 -- **[설계 확정 -- Phase 40-01]** (T-01~T-14 Unit/Integration 분류 + S-01~S-04 보안 검증 방법 명시)
```

또한 파일 하단 업데이트 이력에 추가:
```
*Phase 40-01 업데이트: 2026-02-09 -- 18개 테스트 시나리오 설계 문서 명시 (TEST-01, TEST-02 설계 완료)*
```

주의: 기존 내용을 수정하지 않고, 성공 기준 10/11번 줄만 업데이트 + 하단 이력 1줄 추가.
  </action>
  <verify>
1. `grep "설계 확정.*Phase 40" objectives/v0.9-session-management-automation.md` -- 2개 매치 (10번, 11번)
2. `grep "Phase 40-01 업데이트" objectives/v0.9-session-management-automation.md` -- 1개 매치
  </verify>
  <done>
v0.9 objectives의 성공 기준 10번(테스트 시나리오 명시)과 11번(테스트 레벨 정의)이 "설계 확정 -- Phase 40-01"로 업데이트되고, 하단 업데이트 이력에 Phase 40-01 기록이 추가되어 있다.
  </done>
</task>

</tasks>

<verification>
Phase 40-01 전체 검증:
1. 38-sdk-mcp-interface.md에 "## 12. v0.9 테스트 설계 [v0.9]" 섹션이 존재한다
2. T-01~T-14 14개 핵심 시나리오 각각에 검증 방법과 관련 설계 결정 ID가 명시되어 있다
3. S-01~S-04 4개 보안 시나리오 각각에 검증 방법과 관련 설계 결정 ID가 명시되어 있다
4. objectives 성공 기준 10/11번이 Phase 40-01 완료로 표기되어 있다
</verification>

<success_criteria>
- TEST-01 충족: T-01~T-14 각 시나리오의 검증 내용 + 테스트 레벨 + 검증 방법이 38-sdk-mcp-interface.md에 존재
- TEST-02 충족: S-01~S-04 각 시나리오의 검증 내용 + 검증 방법이 38-sdk-mcp-interface.md에 존재
- 18개 시나리오 모두 관련 설계 결정 ID를 참조하여 추적 가능
- objectives 성공 기준 10/11 설계 완료 표기
</success_criteria>

<output>
After completion, create `.planning/phases/40-test-design-doc-integration/40-01-SUMMARY.md`
</output>
