---
phase: 40-test-design-doc-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/38-sdk-mcp-interface.md
  - .planning/deliverables/35-notification-architecture.md
  - .planning/deliverables/40-telegram-bot-docker.md
  - .planning/deliverables/54-cli-flow-redesign.md
  - .planning/deliverables/53-session-renewal-protocol.md
  - .planning/deliverables/24-monorepo-data-directory.md
  - .planning/REQUIREMENTS.md
  - objectives/v0.9-session-management-automation.md
autonomous: true

must_haves:
  truths:
    - "7개 기존 설계 문서(38, 35, 40, 54, 53, 24, 25) 모두에 [v0.9] 태그가 존재한다"
    - "25-sqlite-schema.md에 EXT-03 이연 결정이 [v0.9] 태그로 기록되어 있다"
    - "pitfall 5건(C-01, C-02, C-03, H-04, H-05)의 대응 교차 참조 매트릭스가 38-sdk-mcp-interface.md에 존재한다"
    - "REQUIREMENTS.md의 21개 요구사항이 모두 Complete 상태이다"
  artifacts:
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "EXT-03 이연 결정 [v0.9] 태그"
      contains: "[v0.9]"
    - path: ".planning/deliverables/38-sdk-mcp-interface.md"
      provides: "pitfall 대응 교차 참조 매트릭스"
      contains: "Pitfall 대응 매트릭스"
    - path: ".planning/REQUIREMENTS.md"
      provides: "21개 요구사항 전체 Complete"
      contains: "[x] **TEST-01**"
  key_links:
    - from: "38-sdk-mcp-interface.md pitfall 매트릭스"
      to: "각 pitfall 대응 설계 섹션"
      via: "섹션 번호 참조 (6.4.3, 6.4.2, 6.5.7, 6.5.5)"
      pattern: "C-01|C-02|C-03|H-04|H-05"
    - from: "REQUIREMENTS.md 상태"
      to: "Phase 36-40 SUMMARY.md"
      via: "Complete 상태 + Phase 참조"
      pattern: "Complete"
---

<objective>
7개 기존 설계 문서의 v0.9 통합 완결성을 검증하고, 누락분(25-sqlite EXT-03 이연 태그)을 보완한다. pitfall 5건의 대응 교차 참조 매트릭스를 38-sdk-mcp-interface.md에 추가한다. REQUIREMENTS.md의 상태를 갱신하여 v0.9 21개 요구사항을 모두 Complete로 만든다.

Purpose: v0.9 마일스톤의 문서 일관성과 추적성을 확보하여, 구현 단계에서 "설계 문서가 진실의 원천(SSoT)"인 상태를 보장한다.
Output: 7개 설계 문서 검증/보완 완료, pitfall 매트릭스 추가, REQUIREMENTS.md 갱신, objectives 갱신
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-test-design-doc-integration/40-RESEARCH.md
@.planning/REQUIREMENTS.md
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/38-sdk-mcp-interface.md
@.planning/deliverables/35-notification-architecture.md
@.planning/deliverables/40-telegram-bot-docker.md
@.planning/deliverables/54-cli-flow-redesign.md
@.planning/deliverables/53-session-renewal-protocol.md
@.planning/deliverables/24-monorepo-data-directory.md
@objectives/v0.9-session-management-automation.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 7개 설계 문서 v0.9 통합 검증 + 보완 (INTEG-01)</name>
  <files>
    .planning/deliverables/25-sqlite-schema.md
    .planning/deliverables/38-sdk-mcp-interface.md
    .planning/deliverables/35-notification-architecture.md
    .planning/deliverables/40-telegram-bot-docker.md
    .planning/deliverables/54-cli-flow-redesign.md
    .planning/deliverables/53-session-renewal-protocol.md
    .planning/deliverables/24-monorepo-data-directory.md
  </files>
  <action>
**Step 1: 7개 문서 [v0.9] 태그 현황 확인**

각 문서에 대해 `grep -c "\[v0\.9\]"` 실행하여 태그 수 확인. 40-RESEARCH.md 기준값과 비교:
- 38-sdk-mcp-interface.md: 37회 이상 (기준: 37)
- 35-notification-architecture.md: 9회 이상 (기준: 9)
- 40-telegram-bot-docker.md: 15회 이상 (기준: 15)
- 54-cli-flow-redesign.md: 9회 이상 (기준: 9)
- 53-session-renewal-protocol.md: 8회 이상 (기준: 8)
- 24-monorepo-data-directory.md: 5회 이상 (기준: 5)
- 25-sqlite-schema.md: 0회 (보완 필요)

**Step 2: 25-sqlite-schema.md에 EXT-03 이연 결정 추가**

25-sqlite-schema.md의 agents 테이블 관련 섹션을 찾아, 적절한 위치에 다음 내용을 추가한다:

```markdown
<!-- [v0.9] agents.default_constraints: EXT-03으로 이연.
     v0.9에서 기본 constraints 결정 규칙 설계 (TG-04, TG-05: resolveDefaultConstraints 공용 함수).
     config.toml > 하드코딩 기본값 2-level 우선순위로 동작.
     agents 테이블에 default_constraints 컬럼 추가 여부는 구현 시점(v1.x)에 최종 결정.
     추가 시 3-level: agents.default_constraints > config.toml > 하드코딩. -->
```

주석 형태([v0.9] 태그 포함)로 추가하여, 스키마 문서 자체의 CREATE TABLE 문을 변경하지 않는다. agents 테이블 정의 직후 또는 해당 테이블 설명 섹션에 삽입한다.

**Step 3: 나머지 6개 문서 완결성 스팟 체크**

각 문서에 대해 Phase 36-39에서 반영했어야 할 핵심 항목이 존재하는지 확인:

- 35-notification-architecture.md: "SESSION_EXPIRING_SOON" 이벤트, shouldNotifyExpiringSession 함수, WARNING 심각도 존재 확인
- 40-telegram-bot-docker.md: "/newsession" 명령어, 인라인 키보드, resolveDefaultConstraints 존재 확인
- 54-cli-flow-redesign.md: "mcp setup", "mcp refresh-token", constraints 계승 존재 확인
- 53-session-renewal-protocol.md: shouldNotifyExpiringSession, MCP SessionManager 참조 존재 확인
- 24-monorepo-data-directory.md: "mcp-token", write-then-rename, 0o600 존재 확인
- 38-sdk-mcp-interface.md: SessionManager, ApiClient, handleUnauthorized 존재 확인

누락 항목이 발견되면 해당 문서에 [v0.9] 태그로 보완한다. 40-RESEARCH.md에 따르면 6개 문서는 이미 완전할 것으로 예상되므로, 스팟 체크만 수행하고 누락 시에만 보완한다.

주의사항:
- 이미 반영된 내용을 중복 작성하지 않는다 (Pitfall 1)
- 25-sqlite-schema.md에 실제 스키마 변경(CREATE TABLE, ALTER TABLE)을 하지 않는다 (Pitfall 2)
- 스팟 체크는 grep 기반 정량 확인. 전수 재검토는 범위 외
  </action>
  <verify>
7개 문서 모두에 [v0.9] 태그가 1개 이상 존재:
```
for f in 38-sdk-mcp-interface 35-notification-architecture 40-telegram-bot-docker 54-cli-flow-redesign 53-session-renewal-protocol 24-monorepo-data-directory 25-sqlite-schema; do
  echo "$f: $(grep -c '\[v0\.9\]' .planning/deliverables/$f.md)"
done
```
모든 결과 >= 1 확인. 특히 25-sqlite-schema.md >= 1.
  </verify>
  <done>
7개 설계 문서 모두에 [v0.9] 태그가 존재하고, 25-sqlite-schema.md에 EXT-03 이연 결정이 주석으로 기록되어 있다. 나머지 6개 문서는 Phase 36-39에서 반영된 핵심 항목이 스팟 체크로 확인되었다.
  </done>
</task>

<task type="auto">
  <name>Task 2: pitfall 교차 참조 매트릭스 + REQUIREMENTS.md 갱신 (INTEG-02)</name>
  <files>
    .planning/deliverables/38-sdk-mcp-interface.md
    .planning/REQUIREMENTS.md
    objectives/v0.9-session-management-automation.md
  </files>
  <action>
**Part A: pitfall 대응 교차 참조 매트릭스 추가**

38-sdk-mcp-interface.md의 테스트 설계 섹션(12) 내에 새 하위 섹션을 추가한다.

Plan 40-01이 먼저 실행되어 섹션 12가 이미 존재하는 경우: "### 12.3 Pitfall 대응 매트릭스 [v0.9 Phase 40]"로 추가.
Plan 40-01과 병렬 실행되어 섹션 12가 없는 경우: "## 12. Pitfall 대응 매트릭스 [v0.9]"로 독립 섹션 추가 (구현 노트 다음, 참조 문서 목록 앞에). 단, 이 경우 Plan 40-01 완료 후 섹션 번호를 조정해야 할 수 있으므로, 가능하면 38-sdk-mcp-interface.md의 현재 상태를 확인 후 결정한다.

매트릭스 내용 (40-RESEARCH.md에서 확인된 검증 결과 사용):

```markdown
### 12.3 Pitfall 대응 매트릭스 [v0.9 Phase 40]

v0.9 리서치에서 식별된 5건의 구현 pitfall과 설계 수준 대응 현황이다.

| Pitfall ID | 설명 | 대응 설계 결정 | 설계 문서 위치 | 검증 상태 |
|------------|------|--------------|--------------|----------|
| C-01 | setTimeout 32-bit overflow (2^31-1 ms = ~24.8일 초과 시 즉시 실행) | SM-08: safeSetTimeout 래퍼 (MAX_TIMEOUT_MS 상수, 체이닝) | 38-sdk-mcp 섹션 6.4.3 | Verified |
| C-02 | 토큰 파일 쓰기 경합 (동시 쓰기 시 파일 손상) | TF-02: write-then-rename 원자적 쓰기 패턴 | 24-monorepo 섹션 4.3 | Verified |
| C-03 | JWT 미검증 디코딩 보안 (악의적 payload 주입) | SM-05: 방어적 범위 검증 (exp 과거 10년~미래 1년) | 38-sdk-mcp 섹션 6.4.2 Step 5 | Verified |
| H-04 | Claude Desktop 반복 에러 시 연결 해제 | SMGI-D01: toToolResult/toResourceResult isError 회피 + 안내 메시지 | 38-sdk-mcp 섹션 6.5.7 | Verified |
| H-05 | 토큰 로테이션 중 tool 호출 401 | SMGI-D02: 50ms 대기 + 401 재시도 (Node.js 단일 스레드 활용) | 38-sdk-mcp 섹션 6.5.5 | Verified |

> 5건 모두 Phase 37-38 실행 시 설계 문서에 직접 반영 완료. 상세 대응은 각 섹션 참조.
> Pitfall 원본: .planning/research/v0.9-PITFALLS.md
```

**Part B: REQUIREMENTS.md 상태 갱신**

REQUIREMENTS.md의 Traceability 테이블에서 다음 항목을 갱신한다:

1. SMGI-01~04: "Pending" -> "Complete" (Phase 38에서 실제 완료)
2. TEST-01, TEST-02: "Pending" -> "Complete" (Phase 40에서 완료)
3. INTEG-01, INTEG-02: "Pending" -> "Complete" (Phase 40에서 완료)

또한 상단 체크박스:
- `- [ ] **TEST-01**` -> `- [x] **TEST-01**`
- `- [ ] **TEST-02**` -> `- [x] **TEST-02**`
- `- [ ] **INTEG-01**` -> `- [x] **INTEG-01**`
- `- [ ] **INTEG-02**` -> `- [x] **INTEG-02**`

하단 Last updated 갱신:
```
*Last updated: 2026-02-09 after Phase 40 completion -- all 21 requirements Complete*
```

**Part C: objectives 최종 갱신**

objectives/v0.9-session-management-automation.md 하단 업데이트 이력에 추가:
```
*Phase 40-02 업데이트: 2026-02-09 -- 7개 설계 문서 v0.9 통합 검증 + pitfall 매트릭스 반영 (INTEG-01, INTEG-02 설계 완료)*
```

주의사항:
- 38-sdk-mcp-interface.md 수정 시 Plan 40-01의 파일 수정과 충돌하지 않도록 주의. 40-01은 섹션 12.1/12.2를 추가하고, 이 Task는 섹션 12.3을 추가한다. 병렬 실행 시 38-sdk-mcp-interface.md를 읽어 현재 상태를 확인 후 적절한 위치에 삽입한다.
- SMGI-01~04 상태 갱신은 Phase 38 SUMMARY 존재를 근거로 한다 (Pitfall 4 대응)
  </action>
  <verify>
1. `grep "Pitfall 대응 매트릭스" .planning/deliverables/38-sdk-mcp-interface.md` -- 1개 매치
2. `grep -c "C-01\|C-02\|C-03\|H-04\|H-05" .planning/deliverables/38-sdk-mcp-interface.md` -- 5개 이상
3. `grep "Pending" .planning/REQUIREMENTS.md` -- 0개 매치 (전부 Complete)
4. `grep -c "Complete" .planning/REQUIREMENTS.md` -- 21개 이상 (Traceability 테이블)
5. `grep "\[x\] \*\*TEST-01\*\*" .planning/REQUIREMENTS.md` -- 1개 매치
6. `grep "\[x\] \*\*INTEG-01\*\*" .planning/REQUIREMENTS.md` -- 1개 매치
7. `grep "Phase 40-02 업데이트" objectives/v0.9-session-management-automation.md` -- 1개 매치
  </verify>
  <done>
38-sdk-mcp-interface.md에 pitfall 대응 교차 참조 매트릭스(5건: C-01, C-02, C-03, H-04, H-05)가 추가되어 있다. REQUIREMENTS.md의 21개 요구사항이 모두 Complete 상태이고, Pending이 0개이다. objectives에 Phase 40-02 업데이트 이력이 기록되어 있다.
  </done>
</task>

</tasks>

<verification>
Phase 40-02 전체 검증:
1. 7개 설계 문서 모두에 [v0.9] 태그가 1개 이상 존재한다
2. 25-sqlite-schema.md에 EXT-03 이연 결정이 [v0.9] 태그로 기록되어 있다
3. 38-sdk-mcp-interface.md에 pitfall 대응 교차 참조 매트릭스가 존재하고 5건을 모두 포함한다
4. REQUIREMENTS.md에 "Pending" 상태 요구사항이 0개이다 (21개 전부 Complete)
5. objectives 하단에 Phase 40-02 업데이트 이력이 기록되어 있다
</verification>

<success_criteria>
- INTEG-01 충족: 7개 설계 문서 모두에 [v0.9] 태그 존재, 25-sqlite에 EXT-03 이연 기록
- INTEG-02 충족: pitfall 5건 교차 참조 매트릭스가 설계 문서에 존재, 각 pitfall의 대응 설계 결정 + 문서 위치 + 검증 상태 명시
- REQUIREMENTS.md 21개 요구사항 전부 Complete
- v0.9 문서 추적성 완전 (설계 결정 -> 설계 문서 -> pitfall 대응 모두 연결)
</success_criteria>

<output>
After completion, create `.planning/phases/40-test-design-doc-integration/40-02-SUMMARY.md`
</output>
