---
phase: 193-components-existing-threshold
plan: 02
type: execute
wave: 2
depends_on:
  - 193-01
files_modified:
  - packages/admin/src/__tests__/sessions.test.tsx
  - packages/admin/src/__tests__/notifications-coverage.test.tsx
  - packages/admin/src/__tests__/wallets-coverage.test.tsx
  - packages/admin/vitest.config.ts
autonomous: true
requirements:
  - EXIST-01
  - EXIST-02
  - EXIST-03
  - INFRA-01
  - INFRA-02

must_haves:
  truths:
    - "notifications 관련 테스트 커버리지가 70%+ 수준으로 개선된다"
    - "sessions 관련 테스트 커버리지가 70%+ 수준으로 개선된다"
    - "wallets 관련 테스트 커버리지가 70%+ 수준으로 개선된다"
    - "vitest.config.ts의 lines/statements/functions 임계값이 70으로 설정된다"
    - "pnpm turbo run lint && pnpm turbo run typecheck && pnpm --filter @waiaas/admin test:unit 전체 통과한다"
  artifacts:
    - path: "packages/admin/vitest.config.ts"
      provides: "70% 임계값 설정"
      contains: "lines: 70"
    - path: "packages/admin/src/__tests__/sessions.test.tsx"
      provides: "sessions 추가 테스트"
    - path: "packages/admin/src/__tests__/notifications-coverage.test.tsx"
      provides: "notifications 추가 테스트"
    - path: "packages/admin/src/__tests__/wallets-coverage.test.tsx"
      provides: "wallets 추가 테스트"
  key_links:
    - from: "packages/admin/vitest.config.ts"
      to: "coverage thresholds"
      via: "thresholds config"
      pattern: "lines: 70.*statements: 70.*functions: 70"
---

<objective>
기존 페이지(notifications, sessions, wallets) 테스트 커버리지를 개선하고, vitest.config.ts 임계값을 70%로 복원하여 CI 게이트를 통과시킨다.

Purpose: Plan 01에서 공용 컴포넌트 테스트를 추가하여 전체 커버리지가 올라간 상태에서, 나머지 미검증 분기를 커버하고 임계값을 복원하여 v2.4.1 마일스톤의 최종 목표를 달성한다.
Output: 3개 기존 테스트 파일 개선 + vitest.config.ts 임계값 업데이트 + CI 전체 통과 확인
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/193-components-existing-threshold/193-01-SUMMARY.md

@packages/admin/vitest.config.ts
@packages/admin/src/__tests__/sessions.test.tsx
@packages/admin/src/__tests__/notifications-coverage.test.tsx
@packages/admin/src/__tests__/wallets-coverage.test.tsx
@packages/admin/src/pages/notifications.tsx
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/pages/wallets.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: 기존 페이지 테스트 커버리지 개선</name>
  <files>
    packages/admin/src/__tests__/sessions.test.tsx
    packages/admin/src/__tests__/notifications-coverage.test.tsx
    packages/admin/src/__tests__/wallets-coverage.test.tsx
  </files>
  <action>
**순서:** 먼저 현재 커버리지를 측정하여 어느 파일의 어떤 분기가 미커버인지 확인한 후, 필요한 테스트만 정확히 추가한다.

**Step 0: 현재 커버리지 측정**
```bash
pnpm --filter @waiaas/admin test:unit -- --coverage 2>&1 | tail -80
```
출력에서 notifications.tsx, sessions.tsx, wallets.tsx의 lines/branches/functions 퍼센트를 확인한다. 전체 summary의 lines/statements/functions/branches 임계값 대비 현재 수치도 확인한다.

**Plan 01의 공용 컴포넌트 테스트 추가 후** 전체 lines/statements가 이미 70%에 근접하거나 넘었을 수 있음. 그 경우 기존 페이지 개선은 최소한으로 수행.

**Step 1: 커버리지 갭 분석**
coverage JSON 리포트(`packages/admin/coverage/coverage-summary.json`)에서 각 파일의 미커버 라인을 확인:
```bash
cat packages/admin/coverage/coverage-summary.json | node -e "const d=require('fs').readFileSync('/dev/stdin','utf8');const j=JSON.parse(d);for(const[k,v]of Object.entries(j)){if(k.includes('notifications.tsx')||k.includes('sessions.tsx')||k.includes('wallets.tsx'))console.log(k,JSON.stringify(v))}"
```

**Step 2: sessions.test.tsx 개선** (EXIST-02, 55% → 70%+):

sessions.test.tsx에 기존 pre-existing failures 3건이 있을 수 있음 (STATE.md 참조). 이 failures는 무시하고 추가 테스트만 작성.

커버리지 갭에서 확인된 미커버 분기 기준으로 추가. 일반적으로 필요한 테스트:
- error handling path (apiGet 실패 시 에러 toast)
- empty state 렌더링 (세션 0개일 때)
- token copy 동작 (CopyButton 렌더링 확인)
- session revoke 동작 + 에러 처리
- pagination (페이지 넘김)

기존 sessions.test.tsx 파일의 마지막 describe 블록 아래에 새 describe 블록을 추가한다. 기존 mock 구조를 재사용.

**Step 3: notifications-coverage.test.tsx 개선** (EXIST-01, 50% → 70%+):

기존 notifications-coverage.test.tsx에 이미 handleTestChannel, handlePrevPage, handleNextPage 등이 있음. 추가 필요한 것들:
- error path (apiGet 실패 시)
- empty state (알림 0개)
- notification detail (행 클릭 → 상세 보기)
- channel enable/disable toggle 에러 처리
- pagination edge case (첫 페이지에서 prev, 마지막 페이지에서 next)

기존 파일의 describe 블록 아래에 새 테스트를 추가.

**Step 4: wallets-coverage.test.tsx 개선** (EXIST-03, 61% → 70%+):

wallets-coverage.test.tsx에 이미 WalletDetailView의 주요 함수들이 커버됨. 추가 필요한 것:
- error handling paths for uncovered functions
- edge cases in fetchBalance/fetchTransactions error handling

**중요:** 각 파일 개선 후 개별적으로 테스트 실행하여 통과 확인. 기존 pre-existing failures(sessions 3건)는 건드리지 않음.

**판단 기준:** coverage --coverage 실행 결과 전체 admin lines/statements/functions가 70% 이상이면 추가 테스트 없이 다음 태스크로 진행. 미달이면 가장 낮은 커버리지 파일부터 테스트 추가.
  </action>
  <verify>
pnpm --filter @waiaas/admin test:unit -- --coverage 실행 후 전체 lines >= 70%, statements >= 70%, functions >= 70% 확인
  </verify>
  <done>notifications/sessions/wallets 각 페이지의 미커버 분기가 감소하고, 전체 admin 패키지 lines/statements/functions가 70% 이상이다</done>
</task>

<task type="auto">
  <name>Task 2: 임계값 복원 + CI 전체 검증</name>
  <files>packages/admin/vitest.config.ts</files>
  <action>
**Step 1: vitest.config.ts 임계값 업데이트**

packages/admin/vitest.config.ts 파일의 coverage.thresholds를 다음으로 변경:
```typescript
thresholds: {
  branches: 65,    // 유지 (변경 없음)
  functions: 70,   // 60 → 70
  lines: 70,       // 66 → 70
  statements: 70,  // 66 → 70
},
```

**Step 2: 커버리지 게이트 통과 확인**
```bash
pnpm --filter @waiaas/admin test:unit -- --coverage
```
임계값 70% 설정 후 테스트가 통과하는지 확인. 만약 특정 metric이 70% 미달이면 Task 1으로 돌아가서 추가 테스트 작성. (Task 1에서 이미 확인했으므로 통과해야 함)

**Step 3: CI 전체 파이프라인 검증**
```bash
pnpm turbo run lint && pnpm turbo run typecheck && pnpm --filter @waiaas/admin test:unit
```
lint, typecheck, test:unit 3개 모두 통과 확인. 에러 시 수정.

**주의:** lint/typecheck에서 새로 추가한 테스트 파일에 대해 에러가 발생할 수 있음. unused import, type 에러 등 발견 시 해당 테스트 파일 수정.
  </action>
  <verify>pnpm turbo run lint && pnpm turbo run typecheck && pnpm --filter @waiaas/admin test:unit 전체 통과, exit code 0</verify>
  <done>vitest.config.ts의 lines/statements/functions가 70으로 설정되어 있고, lint + typecheck + test:unit + coverage gate 전체 통과한다</done>
</task>

</tasks>

<verification>
```bash
# 1. 임계값 확인
grep -A4 'thresholds' packages/admin/vitest.config.ts

# 2. 전체 CI 파이프라인
pnpm turbo run lint && pnpm turbo run typecheck && pnpm --filter @waiaas/admin test:unit -- --coverage
```
모든 체크 통과, coverage gate 70% 이상.
</verification>

<success_criteria>
1. vitest.config.ts의 lines: 70, statements: 70, functions: 70 으로 설정됨
2. 전체 admin 패키지 lines >= 70%, statements >= 70%, functions >= 70%, branches >= 65%
3. `pnpm turbo run lint` 통과
4. `pnpm turbo run typecheck` 통과
5. `pnpm --filter @waiaas/admin test:unit` 통과 (coverage gate 포함)
6. 기존 테스트 regression 없음
</success_criteria>

<output>
After completion, create `.planning/phases/193-components-existing-threshold/193-02-SUMMARY.md`
</output>
