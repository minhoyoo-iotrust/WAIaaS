---
phase: 31-데이터-모델-타입-기반-설계
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/25-sqlite-schema.md
  - .planning/deliverables/32-transaction-pipeline-api.md
autonomous: true

must_haves:
  truths:
    - "agents 테이블 DDL에서 owner_address가 nullable이고, owner_verified INTEGER NOT NULL DEFAULT 0 컬럼이 정의되어 있다"
    - "OwnerState 타입(NONE/GRACE/LOCKED)이 Zod SSoT 패턴으로 정의되어 있다"
    - "SweepResult 타입이 정의되어 AssetInfo를 재사용하고, transactions/nativeRecovered/tokensRecovered/rentRecovered/failed 필드가 명세되어 있다"
    - "PolicyDecision에 downgraded(boolean)와 originalTier('APPROVAL') optional 필드가 추가되어 있다"
    - "agents Drizzle ORM 정의에 ownerVerified 컬럼과 check_owner_verified CHECK 제약이 포함되어 있다"
    - "테이블 재생성 마이그레이션 SQL에 PRAGMA foreign_keys = OFF/ON과 foreign_key_check가 포함되어 있다"
  artifacts:
    - path: ".planning/deliverables/25-sqlite-schema.md"
      provides: "agents 스키마 v0.8 변경 (nullable owner_address, owner_verified 컬럼, CHECK 제약, 마이그레이션 SQL)"
      contains: "[v0.8]"
    - path: ".planning/deliverables/32-transaction-pipeline-api.md"
      provides: "PolicyDecision 타입 v0.8 확장 (downgraded, originalTier)"
      contains: "[v0.8]"
  key_links:
    - from: "25-sqlite-schema.md agents 테이블"
      to: "resolveOwnerState() (Plan 31-02에서 설계)"
      via: "owner_address + owner_verified 컬럼 조합이 OwnerState 파생의 입력"
    - from: "32-transaction-pipeline-api.md PolicyDecision"
      to: "Phase 33 다운그레이드 로직"
      via: "downgraded 필드가 알림 분기 조건의 기반"
---

<objective>
agents 테이블의 owner_address nullable 전환, owner_verified 컬럼 추가, 마이그레이션 SQL 확정, 그리고 OwnerState/SweepResult/PolicyDecision.downgraded 핵심 타입을 설계 문서에 반영한다.

Purpose: v0.8의 모든 후속 설계(Owner 생명주기, 정책 다운그레이드, 자금 회수)가 의존하는 데이터 모델과 타입 기반을 확립한다. 이 플랜이 완료되면 Phase 31-02가 참조할 스키마와 타입이 확정된다.

Output: 25-sqlite-schema.md와 32-transaction-pipeline-api.md에 [v0.8] 태그로 변경 사항이 반영된 설계 문서
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/31-데이터-모델-타입-기반-설계/31-RESEARCH.md
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/32-transaction-pipeline-api.md
@.planning/research/v0.8-ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: agents 스키마 v0.8 변경 + 마이그레이션 SQL + OwnerState/SweepResult 타입 정의를 25-sqlite-schema.md에 반영</name>
  <files>.planning/deliverables/25-sqlite-schema.md</files>
  <action>
25-sqlite-schema.md (CORE-02) 설계 문서에 다음 v0.8 변경 사항을 [v0.8] 태그로 반영한다. 기존 내용은 유지하고, 변경/추가 부분에 [v0.8] 주석을 달아 변경 이력을 명확히 한다.

**1. 문서 헤더 업데이트:**
- 기존 업데이트 이력 목록에 `**v0.8 업데이트:** 2026-02-08` 추가
- 참조에 `objectives/v0.8-optional-owner-progressive-security.md` 추가

**2. 섹션 2.1 agents 테이블 Drizzle ORM 정의 수정:**
- `ownerAddress` 필드: `.notNull()` 제거 -> nullable로 변경. 주석에 `[v0.8] NOT NULL 제거 -> nullable (OWNER-01)` 표기
- `ownerVerified` 필드 신규 추가: `integer('owner_verified', { mode: 'boolean' }).notNull().default(false)`. 주석에 `[v0.8] 신규: ownerAuth 사용 이력 (OWNER-07)` 표기
- 인덱스/CHECK 제약 섹션에 `check('check_owner_verified', sql\`owner_verified IN (0, 1)\`)` 추가. 주석에 `[v0.8] boolean CHECK 제약` 표기
- 기존 CHECK 제약(check_chain, check_network, check_status)은 그대로 유지

**3. 섹션 2.1 agents 테이블 DDL(raw SQL) 수정:**
- `owner_address TEXT NOT NULL` -> `owner_address TEXT` (NOT NULL 제거)
- `owner_verified INTEGER NOT NULL DEFAULT 0` 컬럼 추가 (owner_address 다음 줄)
- `CHECK (owner_verified IN (0, 1))` 추가

**4. 마이그레이션 섹션에 v0.8 마이그레이션 SQL 추가:**
기존 마이그레이션 섹션(섹션 4.6 또는 적절한 위치)에 다음 내용의 서브섹션을 추가한다:

제목: `### X.X v0.8 마이그레이션: owner_address nullable + owner_verified 추가`

내용:
- SQLite는 ALTER TABLE로 NOT NULL 제거 불가하므로 테이블 재생성 필요
- 마이그레이션 SQL 전문:
  ```sql
  PRAGMA foreign_keys = OFF;
  BEGIN;
  CREATE TABLE agents_new ( ... owner_address TEXT, owner_verified INTEGER NOT NULL DEFAULT 0, ... );
  INSERT INTO agents_new SELECT id, name, chain, network, public_key, status, owner_address, 0, created_at, updated_at, suspended_at, suspension_reason FROM agents;
  DROP TABLE agents;
  ALTER TABLE agents_new RENAME TO agents;
  -- 인덱스 재생성 (5개)
  CREATE UNIQUE INDEX idx_agents_public_key ON agents(public_key);
  CREATE INDEX idx_agents_status ON agents(status);
  CREATE INDEX idx_agents_chain_network ON agents(chain, network);
  CREATE INDEX idx_agents_owner_address ON agents(owner_address);
  COMMIT;
  PRAGMA foreign_keys = ON;
  PRAGMA foreign_key_check;
  ```
- 핵심 주의사항 3가지: (1) PRAGMA foreign_keys OFF/ON 필수, (2) 기존 에이전트는 모두 owner_verified = 0 (안전한 기본값), (3) Drizzle-kit 자동 생성 시 수동 검증 필수
- 참고: v1.1 첫 구현에서는 초기 스키마에 이미 v0.8 변경이 포함되므로, 이 마이그레이션은 기존 v0.7 DB 업그레이드 시에만 필요

**5. 신규 섹션 추가: v0.8 핵심 타입 정의**

제목: `### X.X [v0.8] 핵심 타입 정의 (OwnerState, SweepResult)`

**5-1. OwnerState 타입 (Zod SSoT):**
```typescript
// packages/core/src/types/owner.ts
import { z } from 'zod'

/** Owner 상태. owner_address + owner_verified 조합에서 런타임에 파생된다. DB에 저장하지 않는다. */
export const OwnerStateSchema = z.enum(['NONE', 'GRACE', 'LOCKED'])
export type OwnerState = z.infer<typeof OwnerStateSchema>
```
- NONE: owner_address = NULL, owner_verified = 0 (Owner 미등록)
- GRACE: owner_address != NULL, owner_verified = 0 (유예 구간)
- LOCKED: owner_address != NULL, owner_verified = 1 (잠금 구간)
- 안티패턴 경고: OwnerState를 DB 컬럼으로 저장하면 동기화 오류 발생. 반드시 resolveOwnerState() 유틸리티로 런타임 산출

**5-2. SweepResult 타입:**
```typescript
// packages/core/src/interfaces/chain-adapter.types.ts
import type { AssetInfo } from './chain-adapter.types'

interface SweepResult {
  transactions: Array<{ txHash: string; assets: Array<{ mint: string; amount: string }> }>
  nativeRecovered: string
  tokensRecovered: AssetInfo[]
  rentRecovered?: string
  failed: Array<{ mint: string; error: string }>
}
```
- SweepResult.tokensRecovered는 v0.6 AssetInfo를 직접 재사용한다
- 부분 실패 시 failed 배열이 비어있지 않으며, HTTP 207 응답으로 매핑된다 (Phase 34에서 상세)
- 파일 위치: `packages/core/src/interfaces/chain-adapter.types.ts` (기존 AssetInfo와 같은 파일)

**6. 안티패턴 섹션에 v0.8 주의사항 추가:**
- owner_verified에 타임스탬프 저장 금지 (boolean 0/1이지 타임스탬프가 아님. "언제 verified되었는가"는 audit_log OWNER_VERIFIED 이벤트로 추적)
- OwnerState를 DB 컬럼으로 저장 금지 (파생 상태는 런타임 산출)
- SweepResult를 Drizzle 스키마에 정의 금지 (체인 어댑터 반환 타입이지 DB 저장 타입이 아님)
- Drizzle `{ mode: 'boolean' }` 주의: ORM에서는 true/false, raw SQL에서는 0/1 사용
  </action>
  <verify>
25-sqlite-schema.md 파일에서 다음을 확인:
1. `[v0.8]` 태그가 최소 6곳에 존재 (Drizzle 정의 2곳, DDL 2곳, 마이그레이션 1곳, 타입 정의 1곳)
2. agents Drizzle ORM 정의에서 ownerAddress가 `.notNull()` 없이 nullable
3. ownerVerified 필드가 `integer('owner_verified', { mode: 'boolean' }).notNull().default(false)` 패턴
4. check_owner_verified CHECK 제약이 존재
5. 마이그레이션 SQL에 `PRAGMA foreign_keys = OFF` / `PRAGMA foreign_keys = ON` / `PRAGMA foreign_key_check` 존재
6. OwnerState Zod 스키마(NONE/GRACE/LOCKED)가 정의되어 있음
7. SweepResult 타입이 AssetInfo[]를 tokensRecovered로 재사용
  </verify>
  <done>
25-sqlite-schema.md에 v0.8 agents 스키마 변경(nullable owner_address, owner_verified 컬럼, CHECK 제약), 테이블 재생성 마이그레이션 SQL, OwnerState 타입, SweepResult 타입이 [v0.8] 태그로 반영되어 있다. OWNER-01, OWNER-07, WITHDRAW-06 요구사항의 데이터 모델 기반이 확정된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: PolicyDecision 타입 v0.8 확장을 32-transaction-pipeline-api.md에 반영</name>
  <files>.planning/deliverables/32-transaction-pipeline-api.md</files>
  <action>
32-transaction-pipeline-api.md (TX-PIPE) 설계 문서에 PolicyDecision 타입 확장을 [v0.8] 태그로 반영한다.

**1. 문서 헤더 업데이트:**
- 기존 업데이트 이력에 `**v0.8 업데이트:** 2026-02-08` 추가
- 참조에 `objectives/v0.8-optional-owner-progressive-security.md` 추가

**2. PolicyDecision 인터페이스 수정:**
문서 내 PolicyDecision 타입 정의를 찾아 다음 2개 필드를 추가한다:

```typescript
interface PolicyDecision {
  // 기존 필드 (변경 없음)
  allowed: boolean
  tier: 'INSTANT' | 'NOTIFY' | 'DELAY' | 'APPROVAL'
  reason?: string
  policyId?: string
  delaySeconds?: number
  approvalTimeoutSeconds?: number

  // ── [v0.8 추가] ──

  /** APPROVAL -> DELAY 다운그레이드 여부. true이면 알림에 Owner 등록 안내 포함. */
  downgraded?: boolean

  /** 다운그레이드 전 원래 티어. 감사 로그용. 현재는 APPROVAL만 다운그레이드 가능. */
  originalTier?: 'APPROVAL'
}
```

- 기존 6개 필드는 변경하지 않는다 (하위 호환성 유지)
- `downgraded`와 `originalTier`는 모두 optional이므로 기존 코드에 영향 없음
- `downgraded === true`일 때: NotificationService가 Owner 등록 안내를 알림에 포함한다
- `originalTier`는 감사 로그 기록용으로, Phase 33에서 실제 다운그레이드 로직이 설계된다

**3. Zod 스키마 수정:**
문서 내 PolicyDecision의 Zod 스키마(PolicyDecisionSchema 또는 유사)가 있다면 동일하게 확장:

```typescript
// [v0.8 추가]
downgraded: z.boolean().optional(),
originalTier: z.literal('APPROVAL').optional(),
```

**4. PolicyDecision 소비자 목록 추가:**
downgraded 필드의 소비자를 명시하는 문단을 추가한다:
- **NotificationService**: `downgraded === true`이면 Owner 등록 안내 메시지를 알림에 포함 (Phase 33에서 상세)
- **감사 로그**: `originalTier` 기록으로 다운그레이드 추적 (DOWNGRADED 이벤트 타입)
- **CLI/API 응답**: 다운그레이드 여부를 클라이언트에 표시
- **Phase 33 의존**: 실제 다운그레이드 분기 로직(evaluate() Step 9 이후)은 Phase 33에서 설계

**5. Stage 3 정책 평가 흐름에 v0.8 주석 추가:**
Stage 3 정책 평가 흐름 설명 부분에 다음 주석을 추가한다:
- `[v0.8] Stage 3 정책 평가 후 OwnerState에 따라 APPROVAL -> DELAY 다운그레이드가 삽입될 수 있다. 상세 로직은 Phase 33에서 설계한다.`
  </action>
  <verify>
32-transaction-pipeline-api.md 파일에서 다음을 확인:
1. PolicyDecision 인터페이스에 `downgraded?: boolean`과 `originalTier?: 'APPROVAL'` 필드가 존재
2. [v0.8] 태그가 최소 3곳에 존재 (헤더, PolicyDecision, Stage 3)
3. 기존 6개 필드가 변경되지 않았음 (하위 호환성)
4. 소비자 목록(NotificationService, 감사 로그, CLI/API, Phase 33 의존)이 명시되어 있음
  </verify>
  <done>
32-transaction-pipeline-api.md에 PolicyDecision 타입 v0.8 확장(downgraded, originalTier)이 반영되어 있다. Phase 33 정책 다운그레이드 설계의 타입 기반이 확정된다.
  </done>
</task>

</tasks>

<verification>
1. 25-sqlite-schema.md에서 agents 테이블 Drizzle ORM 정의를 확인: ownerAddress가 nullable이고, ownerVerified 컬럼이 존재하며, check_owner_verified CHECK 제약이 있다
2. 25-sqlite-schema.md에서 agents DDL(raw SQL)을 확인: owner_address TEXT (NOT NULL 없음), owner_verified INTEGER NOT NULL DEFAULT 0이 있다
3. 25-sqlite-schema.md에서 마이그레이션 SQL을 확인: PRAGMA foreign_keys OFF/ON, 테이블 재생성, foreign_key_check가 있다
4. 25-sqlite-schema.md에서 OwnerState 타입(NONE/GRACE/LOCKED)과 SweepResult 타입이 정의되어 있다
5. 32-transaction-pipeline-api.md에서 PolicyDecision에 downgraded?/originalTier? 필드가 추가되어 있다
6. 두 문서 모두 [v0.8] 태그로 변경점이 명확히 표시되어 있다
7. 기존 내용의 하위 호환성이 유지된다 (기존 필드, CHECK 제약, 인덱스 등 변경 없음)
</verification>

<success_criteria>
- OWNER-01 기반: agents.owner_address가 nullable로 전환되어 Owner 없이 에이전트 생성 가능
- OWNER-07 기반: owner_verified 컬럼이 정의되어 유예->잠금 전이의 데이터 모델 확보
- WITHDRAW-06 기반: SweepResult 타입이 정의되어 IChainAdapter.sweepAll 시그니처의 반환 타입 확보
- 타입 안전성: OwnerState Zod SSoT, PolicyDecision optional 확장, CHECK 제약으로 데이터 무결성 확보
- 마이그레이션 안전성: PRAGMA foreign_keys OFF/ON + foreign_key_check로 참조 무결성 보장
</success_criteria>

<output>
After completion, create `.planning/phases/31-데이터-모델-타입-기반-설계/31-01-SUMMARY.md`
</output>
