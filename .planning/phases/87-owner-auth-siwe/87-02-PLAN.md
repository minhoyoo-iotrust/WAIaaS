---
phase: 87-owner-auth-siwe
plan: 02
type: execute
wave: 2
depends_on: ["87-01"]
files_modified:
  - packages/daemon/src/api/middleware/owner-auth.ts
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/__tests__/owner-auth.test.ts
  - packages/daemon/src/__tests__/owner-auth-siwe.test.ts
autonomous: true

must_haves:
  truths:
    - "EVM owner with valid SIWE signature passes owner-auth middleware"
    - "Owner-auth middleware branches by agent.chain: solana=Ed25519, ethereum=SIWE"
    - "setOwner rejects EVM address without EIP-55 checksum"
    - "setOwner rejects Solana address that is not 32-byte base58"
    - "All existing Solana owner-auth tests pass unchanged (SIWE-04 regression)"
  artifacts:
    - path: "packages/daemon/src/api/middleware/owner-auth.ts"
      provides: "Chain-branching owner auth middleware"
      exports: ["createOwnerAuth"]
    - path: "packages/daemon/src/api/routes/agents.ts"
      provides: "setOwner with chain-aware address validation"
    - path: "packages/daemon/src/__tests__/owner-auth-siwe.test.ts"
      provides: "SIWE owner-auth integration tests"
    - path: "packages/daemon/src/__tests__/owner-auth.test.ts"
      provides: "Existing Solana tests (regression)"
  key_links:
    - from: "packages/daemon/src/api/middleware/owner-auth.ts"
      to: "packages/daemon/src/api/middleware/siwe-verify.ts"
      via: "verifySIWE import"
      pattern: "verifySIWE"
    - from: "packages/daemon/src/api/middleware/owner-auth.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "agent.chain lookup for branching"
      pattern: "agent\\.chain"
    - from: "packages/daemon/src/api/routes/agents.ts"
      to: "packages/daemon/src/api/middleware/address-validation.ts"
      via: "validateOwnerAddress import in setOwner handler"
      pattern: "validateOwnerAddress"
---

<objective>
Refactor the owner-auth middleware to branch verification by agent.chain (solana=Ed25519, ethereum=SIWE), add chain-aware address validation to the setOwner route, and ensure all existing Solana owner-auth tests pass without modification.

Purpose: Complete the SIWE integration by wiring the Plan 01 building blocks into the middleware and routes, enabling EVM owners to authenticate and register addresses.

Output: Updated owner-auth.ts with chain branching, updated agents.ts with address validation, new SIWE integration tests, existing tests passing (SIWE-02, SIWE-03, SIWE-04).
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/middleware/owner-auth.ts
@packages/daemon/src/api/routes/agents.ts
@packages/daemon/src/__tests__/owner-auth.test.ts
@packages/daemon/src/api/middleware/siwe-verify.ts (from Plan 87-01)
@packages/daemon/src/api/middleware/address-validation.ts (from Plan 87-01)
@.planning/phases/87-owner-auth-siwe/87-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor owner-auth middleware with chain branching (SIWE-02)</name>
  <files>
    packages/daemon/src/api/middleware/owner-auth.ts
    packages/daemon/src/__tests__/owner-auth-siwe.test.ts
    packages/daemon/src/__tests__/owner-auth.test.ts
  </files>
  <action>
Refactor `createOwnerAuth` in `owner-auth.ts` to support both Solana Ed25519 and Ethereum SIWE verification, branching by the agent's `chain` field.

**Changes to owner-auth.ts:**

1. Import `verifySIWE` from `./siwe-verify.js`
2. Import `decodeBase58` from `./address-validation.js` (replace the inline decodeBase58 function, which was extracted in Plan 01)
3. Remove the inline `decodeBase58` function and `BASE58_ALPHABET` constant (they now live in address-validation.ts)

4. After the existing agent lookup and ownerAddress match check (lines ~120-138), add chain branching:

```typescript
// Branch verification by chain type
if (agent.chain === 'ethereum') {
  // EVM SIWE verification (EIP-4361 + EIP-191)
  // For SIWE: X-Owner-Message is the full EIP-4361 message, X-Owner-Signature is 0x-prefixed hex
  const result = await verifySIWE({
    message,
    signature,  // already hex 0x-prefixed from header
    expectedAddress: ownerAddress,
  });

  if (!result.valid) {
    throw new WAIaaSError('INVALID_SIGNATURE', {
      message: result.error ?? 'SIWE signature verification failed',
    });
  }
} else {
  // Solana Ed25519 verification (existing logic)
  // X-Owner-Signature is base64-encoded Ed25519 detached signature
  try {
    const sodium = loadSodium();
    const signatureBytes = Buffer.from(signature, 'base64');
    const messageBytes = Buffer.from(message, 'utf8');
    const publicKeyBytes = decodeBase58(ownerAddress);

    if (publicKeyBytes.length !== sodium.crypto_sign_PUBLICKEYBYTES) {
      throw new WAIaaSError('INVALID_SIGNATURE', {
        message: `Invalid public key length: expected ${String(sodium.crypto_sign_PUBLICKEYBYTES)}, got ${String(publicKeyBytes.length)}`,
      });
    }
    if (signatureBytes.length !== sodium.crypto_sign_BYTES) {
      throw new WAIaaSError('INVALID_SIGNATURE', {
        message: `Invalid signature length: expected ${String(sodium.crypto_sign_BYTES)}, got ${String(signatureBytes.length)}`,
      });
    }

    const valid = sodium.crypto_sign_verify_detached(signatureBytes, messageBytes, publicKeyBytes);
    if (!valid) {
      throw new WAIaaSError('INVALID_SIGNATURE', {
        message: 'Ed25519 signature verification failed',
      });
    }
  } catch (err) {
    if (err instanceof WAIaaSError) throw err;
    throw new WAIaaSError('INVALID_SIGNATURE', {
      message: 'Signature verification failed',
      cause: err instanceof Error ? err : undefined,
    });
  }
}
```

5. Keep the existing `c.set('ownerAddress', ownerAddress)` and `await next()` at the end.

**Key point:** The Solana path is unchanged functionally -- same logic, just decodeBase58 imported from address-validation.ts instead of defined inline. This ensures SIWE-04 (regression safety).

**New test file** `owner-auth-siwe.test.ts`:

Create integration tests for EVM owner-auth using the same Hono `app.request()` pattern as the existing `owner-auth.test.ts`:

1. **Setup:** Create test app with ownerAuth middleware on `/protected/:id/action`, seed agent with `chain='ethereum'`, `network='mainnet'`, `ownerAddress` = test EVM account address (EIP-55 checksum)

2. **Test keypair:** Use `privateKeyToAccount('0xac0974...')` from `viem/accounts`

3. **SIWE message construction:** Use `createSiweMessage` from `viem/siwe` with the test account address, chainId=1, domain='localhost', uri='http://localhost:3000'

4. **Signing:** `await testAccount.signMessage({ message: siweMessage })` to get 0x-prefixed hex signature

5. **Test cases:**
   a. `passes through when valid SIWE signature matches EVM owner address` -- seed EVM agent, send valid SIWE headers, expect 200
   b. `rejects with 401 when SIWE signature is from different account` -- sign with different key than the owner address
   c. `rejects with 401 when SIWE message is expired` -- create message with past expirationTime
   d. `rejects with 401 when headers missing` -- no headers at all (same as Solana test)
   e. `rejects with 404 when EVM agent has no owner` -- seed agent without ownerAddress

6. **seedAgent for EVM:** Modify the seed helper to accept chain parameter:
```typescript
function seedAgent(opts?: { ownerAddress?: string | null; chain?: string; network?: string }) {
  const ts = nowSeconds();
  sqlite.prepare(
    `INSERT INTO agents (id, name, chain, network, public_key, status, owner_verified, owner_address, created_at, updated_at)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
  ).run(
    TEST_AGENT_ID, 'SIWE Test Agent',
    opts?.chain ?? 'ethereum',
    opts?.network ?? 'mainnet',
    'pk-siwe-test', 'ACTIVE', 0,
    opts?.ownerAddress ?? null, ts, ts
  );
}
```

**Regression test:** Run existing `owner-auth.test.ts` without any modification -- all 6 tests must pass. The only change to the existing test file should be NONE (zero modifications). The Solana verification path is identical.
  </action>
  <verify>
1. `pnpm vitest run packages/daemon/src/__tests__/owner-auth-siwe.test.ts` -- all 5 SIWE tests pass
2. `pnpm vitest run packages/daemon/src/__tests__/owner-auth.test.ts` -- all 6 existing Solana tests pass (SIWE-04)
3. `pnpm tsc -p packages/daemon/tsconfig.json --noEmit` -- no type errors
  </verify>
  <done>
Owner-auth middleware branches by agent.chain: solana uses Ed25519 (unchanged), ethereum uses SIWE via verifySIWE. All existing Solana tests pass without modification. EVM SIWE flow tested with real viem signing.
  </done>
</task>

<task type="auto">
  <name>Task 2: setOwner chain-aware address validation (SIWE-03)</name>
  <files>
    packages/daemon/src/api/routes/agents.ts
    packages/daemon/src/__tests__/owner-auth-siwe.test.ts
  </files>
  <action>
Add chain-aware address validation to the `setOwner` route (PUT /agents/:id/owner) in `agents.ts`.

**Changes to agents.ts:**

1. Import `validateOwnerAddress` from `../middleware/address-validation.js`

2. In the setOwner handler, after the LOCKED state check and before `ownerLifecycle.setOwner(agentId, ownerAddress)`, add validation:

```typescript
// Validate owner_address format by chain type
const validation = validateOwnerAddress(agent.chain as ChainType, ownerAddress);
if (!validation.valid) {
  throw new WAIaaSError('ACTION_VALIDATION_FAILED', {
    message: `Invalid owner address for ${agent.chain}: ${validation.error}`,
  });
}

// Use normalized address (EIP-55 for ethereum, as-is for solana)
const normalizedAddress = validation.normalized!;

// Set owner with normalized address
ownerLifecycle.setOwner(agentId, normalizedAddress);
```

3. Update the notification and response to use `normalizedAddress` instead of raw `ownerAddress`.

**Tests to add to `owner-auth-siwe.test.ts`** (or create a separate section):

Since setOwner needs the full agent routes setup with masterAuth, add tests in the existing SIWE test file using the full app setup pattern (or add to `api-new-endpoints.test.ts` if that pattern is already established):

Actually, the simplest approach: add address validation tests directly in `owner-auth-siwe.test.ts` under a new describe block. Create a minimal Hono app that includes the agentRoutes with setOwner, protected by masterAuth:

a. `setOwner rejects EVM agent with non-checksummed ethereum address` -- all-lowercase 0x address -> 400 ACTION_VALIDATION_FAILED
b. `setOwner rejects EVM agent with non-0x address` -- base58 address for ethereum agent -> 400
c. `setOwner accepts EVM agent with valid EIP-55 address` -- proper checksum -> 200
d. `setOwner rejects Solana agent with 0x ethereum address` -- 0x address for solana agent -> 400
e. `setOwner accepts Solana agent with valid base58 32-byte address` -- proper base58 -> 200

For these tests, you need:
- In-memory SQLite DB with agents table
- Master password for masterAuth
- Seed EVM/Solana agents
- Use `app.request()` for PUT /agents/:id/owner

If wiring the full agentRoutes is too complex, test the `validateOwnerAddress` function directly via the unit tests in `address-validation.test.ts` (Plan 01 already covers this). The integration here is to verify the route handler calls validateOwnerAddress and returns the right HTTP status.

**Keep it simple:** Since Plan 01's address-validation tests already cover the validation logic thoroughly, focus the integration tests on:
- One happy path per chain (setOwner succeeds)
- One rejection per chain (setOwner rejects invalid format)
  </action>
  <verify>
1. `pnpm vitest run packages/daemon/src/__tests__/owner-auth-siwe.test.ts` -- all tests pass including setOwner validation
2. `pnpm vitest run packages/daemon/src/__tests__/owner-auth.test.ts` -- regression: all 6 pass
3. `pnpm vitest run packages/daemon` -- full daemon test suite passes
  </verify>
  <done>
setOwner route validates owner_address format by agent.chain: Solana requires base58 32B, Ethereum requires 0x EIP-55 checksum. Invalid format returns 400 ACTION_VALIDATION_FAILED. Normalized address (EIP-55) stored in DB.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/daemon/src/__tests__/siwe-verify.test.ts` -- SIWE-01
2. `pnpm vitest run packages/daemon/src/__tests__/address-validation.test.ts` -- SIWE-03 validation logic
3. `pnpm vitest run packages/daemon/src/__tests__/owner-auth-siwe.test.ts` -- SIWE-02 + SIWE-03 integration
4. `pnpm vitest run packages/daemon/src/__tests__/owner-auth.test.ts` -- SIWE-04 regression
5. `pnpm tsc -p packages/daemon/tsconfig.json --noEmit` -- clean compile
6. `pnpm vitest run packages/daemon` -- full daemon suite passes
</verification>

<success_criteria>
- EVM owner passes ownerAuth with valid SIWE message + signature
- Owner-auth middleware branches correctly by agent.chain
- setOwner validates address format per chain type
- All existing Solana owner-auth tests pass unchanged
- Full daemon test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/87-owner-auth-siwe/87-02-SUMMARY.md`
</output>
