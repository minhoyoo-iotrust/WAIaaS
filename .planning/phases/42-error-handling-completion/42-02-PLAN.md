---
phase: 42-error-handling-completion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/37-rest-api-complete-spec.md
autonomous: true

must_haves:
  truths:
    - "37-rest-api에 64개+ 에러 코드 전수의 HTTP status + retryable + backoff 통합 매트릭스가 단일 테이블로 존재한다"
    - "429 응답 포맷(Retry-After 헤더 + 본문 retryAfter)이 37-rest-api에 확정되어 있다"
    - "37-rest-api SS8.9의 PolicyType enum이 10개로 확장되어 있고, CreatePolicyRequestSchema에 .superRefine() 로직이 명시되어 있다"
    - "PolicySummarySchema의 type enum도 10개로 동기화되어 있다"
  artifacts:
    - path: ".planning/deliverables/37-rest-api-complete-spec.md"
      provides: "에러 코드 통합 매트릭스 + 429 포맷 + PolicyType 10개 확장 + superRefine"
      contains: "통합 매트릭스|superRefine"
  key_links:
    - from: "37-rest-api 통합 매트릭스"
      to: "37-rest-api SS10.2~10.10 도메인별 테이블"
      via: "SSoT 참조 (통합 매트릭스가 SSoT)"
      pattern: "통합 매트릭스.*SSoT"
    - from: "37-rest-api SS8.9 superRefine"
      to: "33-time-lock SS2.2 PolicyRuleSchema"
      via: "SSoT 참조 (33-time-lock이 rules 스키마 SSoT)"
      pattern: "PolicyRuleSchema|33-time-lock"
---

<objective>
37-rest-api-complete-spec.md에 (1) 에러 코드 통합 매트릭스와 429 응답 포맷을 추가하고, (2) PolicyType enum을 10개로 확장하며 type별 rules 검증 분기를 명시한다.

Purpose: 구현자가 에러 응답 매핑과 정책 타입 검증을 단일 문서에서 즉시 참조할 수 있도록 하여, 여러 문서를 교차 참조하거나 추측하는 상황을 제거한다.
Output: 37-rest-api SS10에 통합 매트릭스 + SS8.9에 PolicyType 10개 확장 + superRefine 로직
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/29-api-framework-design.md (SS7.5 -- 429 응답 헤더 포맷)
@.planning/deliverables/33-time-lock-approval-mechanism.md (SS2.2 -- PolicyRuleSchema 10개 타입)
@.planning/deliverables/45-enum-unified-mapping.md (SS2.5 -- PolicyType 10개 enum SSoT)
@.planning/phases/42-error-handling-completion/42-RESEARCH.md
@.planning/phases/41-policy-engine-completion/41-01-SUMMARY.md
@objectives/v0.10-pre-implementation-design-completion.md (Phase B: B-1, B-3)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 에러 코드 통합 매트릭스 + 429 응답 포맷 추가 (ERRH-01)</name>
  <files>.planning/deliverables/37-rest-api-complete-spec.md</files>
  <action>
37-rest-api-complete-spec.md의 SS10(에러 코드 체계)에 통합 매트릭스를 추가한다.

**1) SS10.11(에러 코드 요약 통계) 뒤에 SS10.12 "에러 코드 통합 매트릭스 (v0.10)" 섹션을 신설:**

배치 이유: objectives는 "SS3.3"을 지시하나 현재 SS3.3은 masterAuth 섹션이다. 에러 코드 체계(SS10) 내가 논리적으로 적합하므로 SS10.12에 배치한다.

통합 매트릭스 구조:
```markdown
### 10.12 [v0.10] 에러 코드 통합 매트릭스

> 이 매트릭스가 에러 코드 → HTTP 매핑의 **SSoT**이다. SS10.2~10.10의 도메인별 테이블은 상세 설명 참조용이며, HTTP status/retryable/backoff는 이 매트릭스를 따른다.

| # | 에러 코드 | 도메인 | HTTP | retryable | backoff | hint |
|---|----------|--------|------|-----------|---------|------|
```

매트릭스에 포함할 에러 코드 전수 (SS10.2~10.10에서 수집):

AUTH 도메인 (8개):
1. INVALID_TOKEN | AUTH | 401 | false | - | O
2. TOKEN_EXPIRED | AUTH | 401 | false | - | O
3. SESSION_REVOKED | AUTH | 401 | false | - | O
4. INVALID_SIGNATURE | AUTH | 401 | false | - | O
5. INVALID_NONCE | AUTH | 401 | false | - | O
6. INVALID_MASTER_PASSWORD | AUTH | 401 | false | - | O
7. MASTER_PASSWORD_LOCKED | AUTH | 429 | false | 30분 대기 | O
8. SYSTEM_LOCKED | AUTH | 503 | false | - | O

SESSION 도메인 (8개):
9. SESSION_NOT_FOUND | SESSION | 404 | false | - | O
10. SESSION_EXPIRED | SESSION | 401 | false | - | O
11. SESSION_LIMIT_EXCEEDED | SESSION | 403 | false | - | O
12. CONSTRAINT_VIOLATED | SESSION | 403 | false | - | O
13. RENEWAL_LIMIT_REACHED | SESSION | 403 | false | - | O
14. SESSION_ABSOLUTE_LIFETIME_EXCEEDED | SESSION | 403 | false | - | O
15. RENEWAL_TOO_EARLY | SESSION | 403 | true | exp(1,2,4) | O
16. SESSION_RENEWAL_MISMATCH | SESSION | 403 | false | - | O

TX 도메인 (20개):
17. INSUFFICIENT_BALANCE | TX | 400 | false | - | O
18. INVALID_ADDRESS | TX | 400 | false | - | O
19. TX_NOT_FOUND | TX | 404 | false | - | -
20. TX_EXPIRED | TX | 410 | false | - | O
21. TX_ALREADY_PROCESSED | TX | 409 | false | - | -
22. CHAIN_ERROR | TX | 502 | true | exp(1,2,4) | O
23. SIMULATION_FAILED | TX | 422 | false | - | O
24. TOKEN_NOT_FOUND | TX | 404 | false | - | -
25. TOKEN_NOT_ALLOWED | TX | 403 | false | - | -
26. INSUFFICIENT_TOKEN_BALANCE | TX | 400 | false | - | -
27. CONTRACT_CALL_DISABLED | TX | 403 | false | - | -
28. CONTRACT_NOT_WHITELISTED | TX | 403 | false | - | -
29. METHOD_NOT_WHITELISTED | TX | 403 | false | - | -
30. APPROVE_DISABLED | TX | 403 | false | - | -
31. SPENDER_NOT_APPROVED | TX | 403 | false | - | -
32. APPROVE_AMOUNT_EXCEEDED | TX | 403 | false | - | -
33. UNLIMITED_APPROVE_BLOCKED | TX | 403 | false | - | -
34. BATCH_NOT_SUPPORTED | TX | 400 | false | - | -
35. BATCH_SIZE_EXCEEDED | TX | 400 | false | - | -
36. BATCH_POLICY_VIOLATION | TX | 403 | false | - | -

POLICY 도메인 (4개):
37. POLICY_DENIED | POLICY | 403 | false | - | O
38. SPENDING_LIMIT_EXCEEDED | POLICY | 403 | false | - | O
39. RATE_LIMIT_EXCEEDED | POLICY | 429 | true | Retry-After | O
40. WHITELIST_DENIED | POLICY | 403 | false | - | O

OWNER 도메인 (5개 -- 기존 SS10.11 통계 "4"에서 정정):
41. OWNER_ALREADY_CONNECTED | OWNER | 409 | false | - | -
42. OWNER_NOT_CONNECTED | OWNER | 404 | false | - | -
43. OWNER_NOT_FOUND | OWNER | 404 | false | - | -
44. APPROVAL_TIMEOUT | OWNER | 410 | false | - | O
45. APPROVAL_NOT_FOUND | OWNER | 404 | false | - | -

SYSTEM 도메인 (6개):
46. KILL_SWITCH_ACTIVE | SYSTEM | 409 | false | - | -
47. KILL_SWITCH_NOT_ACTIVE | SYSTEM | 409 | false | - | -
48. KEYSTORE_LOCKED | SYSTEM | 503 | true | exp(1,2,4) | -
49. CHAIN_NOT_SUPPORTED | SYSTEM | 400 | false | - | -
50. SHUTTING_DOWN | SYSTEM | 503 | false | Retry-After | -
51. ADAPTER_NOT_AVAILABLE | SYSTEM | 503 | true | exp(1,2,4) | -

AGENT 도메인 (3개):
52. AGENT_NOT_FOUND | AGENT | 404 | false | - | -
53. AGENT_SUSPENDED | AGENT | 409 | false | - | -
54. AGENT_TERMINATED | AGENT | 410 | false | - | -

WITHDRAW 도메인 (4개):
55. NO_OWNER | WITHDRAW | 404 | false | - | -
56. WITHDRAW_LOCKED_ONLY | WITHDRAW | 403 | false | - | -
57. SWEEP_TOTAL_FAILURE | WITHDRAW | 500 | true | exp(1,2,4) | -
58. INSUFFICIENT_FOR_FEE | WITHDRAW | 500 | false | - | -

ACTION 도메인 (7개):
59. ACTION_NOT_FOUND | ACTION | 404 | false | - | -
60. ACTION_VALIDATION_FAILED | ACTION | 400 | false | - | -
61. ACTION_RESOLVE_FAILED | ACTION | 502 | true | exp(1,2,4) | -
62. ACTION_RETURN_INVALID | ACTION | 500 | false | - | -
63. ACTION_PLUGIN_LOAD_FAILED | ACTION | 500 | false | - | -
64. ACTION_NAME_CONFLICT | ACTION | 409 | false | - | -
65. ACTION_CHAIN_MISMATCH | ACTION | 400 | false | - | -

ADMIN 도메인 (SS9.3에서 발견, SS10 미등록):
66. ROTATION_TOO_RECENT | ADMIN | 429 | false | 5분 대기 | -

합계: **66개** (기존 SS10.11의 "64개"에서 정정)

**backoff 전략 열 값 범례:**
```markdown
> **backoff 범례:**
> - `-`: 재시도 불필요 (retryable=false)
> - `Retry-After`: 서버가 응답 헤더로 제공하는 대기 시간(초) 참조
> - `exp(1,2,4)`: 지수 백오프 1초/2초/4초, 최대 3회
> - `N분 대기`: 고정 대기 시간 (lockout 해제 대기)
```

**2) SS10.11 에러 코드 요약 통계를 정정:**

- OWNER: 4 -> 5 (OWNER_NOT_FOUND 포함)
- ADMIN: 1 (ROTATION_TOO_RECENT 신규 도메인 또는 SYSTEM에 편입)
- 합계: 64 -> 66
- ADMIN 도메인이 신규면 도메인 행 추가. 대안으로 ROTATION_TOO_RECENT를 SYSTEM에 편입하여 SYSTEM=7, 합계=65도 가능. Recommendation: SS9.3에서 rotate-secret 전용 에러이므로 ADMIN 도메인으로 독립 등록하여 명확성 확보. 도메인 10개(AUTH, SESSION, TX, POLICY, OWNER, SYSTEM, AGENT, WITHDRAW, ACTION, ADMIN).

**3) SS10.12 아래에 429 응답 포맷 서브섹션 추가:**

```markdown
**429 응답 포맷 (SSoT: 29-api-framework SS7.5):**

429 응답에는 반드시 다음을 포함한다:
- `Retry-After` HTTP 헤더 (초 단위)
- 본문 `details.retryAfter` 필드 (초 단위, 헤더와 동일 값)
- 본문 `details.stage` 필드 (`"global"` 또는 `"session"`) -- Rate Limiter 제한 단계 식별

429를 사용하는 에러 코드:
| 에러 코드 | 도메인 | retryable | backoff 특성 |
|-----------|--------|-----------|-------------|
| MASTER_PASSWORD_LOCKED | AUTH | false | 30분 lockout, 재시도 무의미 |
| RATE_LIMIT_EXCEEDED | POLICY | true | Retry-After 헤더 참조 |
| ROTATION_TOO_RECENT | ADMIN | false | 5분 대기 (전환 윈도우) |

> MASTER_PASSWORD_LOCKED는 429이지만 retryable=false이다. 30분 lockout은 보안 메커니즘이며 "동일 요청 재시도"로 해결되지 않는다.
```

**4) 문서 상단 메타데이터에 v0.10 변경 이력 추가:**

기존 `**v0.8 보완:** 2026-02-09` 아래에:
`**v0.10 보완:** 2026-02-09`

문서 개요(SS1.1) 또는 SS10 서두에 "[v0.10] SS10.12 에러 코드 통합 매트릭스 추가, 에러 코드 총 수 64->66 정정" 메모.
  </action>
  <verify>
검증 명령:
1. `grep -c "통합 매트릭스" .planning/deliverables/37-rest-api-complete-spec.md` -- 3회 이상 (제목 + SSoT 선언 + 범례)
2. `grep "10.12" .planning/deliverables/37-rest-api-complete-spec.md` -- SS10.12 섹션 존재
3. `grep "Retry-After" .planning/deliverables/37-rest-api-complete-spec.md | wc -l` -- 5회 이상 (기존 + 429 포맷 섹션)
4. `grep "ROTATION_TOO_RECENT" .planning/deliverables/37-rest-api-complete-spec.md | wc -l` -- 2회 이상 (SS9.3 + SS10.12)
5. `grep "66" .planning/deliverables/37-rest-api-complete-spec.md` -- 정정된 합계
  </verify>
  <done>
37-rest-api SS10.12에 66개 에러 코드 통합 매트릭스(에러코드/도메인/HTTP/retryable/backoff/hint)가 존재하고, 429 응답 포맷(Retry-After 헤더 + 본문 retryAfter + stage)이 확정되어 있으며, SS10.11 합계가 66개로 정정되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: PolicyType enum 10개 확장 + superRefine 검증 분기 (ERRH-03)</name>
  <files>.planning/deliverables/37-rest-api-complete-spec.md</files>
  <action>
37-rest-api-complete-spec.md의 SS8.9와 SS8.10을 다음과 같이 수정한다.

**1) PolicyTypeEnum 상수 추출 (SS8.9 코드 블록 상단에 추가):**

SS8.9의 Request Zod 스키마 코드 블록 앞에 공통 enum 상수를 정의:

```typescript
// [v0.10] PolicyType 10개 enum -- SSoT: 45-enum-unified-mapping.md §2.5
const PolicyTypeEnum = z.enum([
  'SPENDING_LIMIT',
  'WHITELIST',
  'TIME_RESTRICTION',
  'RATE_LIMIT',
  'ALLOWED_TOKENS',
  'CONTRACT_WHITELIST',
  'METHOD_WHITELIST',
  'APPROVED_SPENDERS',
  'APPROVE_AMOUNT_LIMIT',
  'APPROVE_TIER_OVERRIDE',
]).openapi({ description: '정책 유형 (10개)' })
```

**2) CreatePolicyRequestSchema 수정:**

기존:
```typescript
type: z.enum(['SPENDING_LIMIT', 'WHITELIST', 'TIME_RESTRICTION', 'RATE_LIMIT']).openapi({...})
```

변경:
```typescript
type: PolicyTypeEnum.openapi({
  description: '정책 유형. SSoT: 45-enum §2.5',
}),
```

`rules: z.unknown()` 유지하되 openapi description을 업데이트:
```typescript
rules: z.unknown().openapi({
  description: '정책 규칙 JSON. type에 따라 .superRefine()으로 검증. SSoT: 33-time-lock §2.2 PolicyRuleSchema',
}),
```

전체 스키마 끝에 `.superRefine()` 추가:
```typescript
const CreatePolicyRequestSchema = z.object({
  agentId: z.string().uuid().optional().openapi({
    description: '대상 에이전트 ID. 미지정 시 글로벌 정책',
  }),
  type: PolicyTypeEnum.openapi({
    description: '정책 유형. SSoT: 45-enum §2.5',
  }),
  rules: z.unknown().openapi({
    description: '정책 규칙 JSON. type에 따라 .superRefine()으로 검증. SSoT: 33-time-lock §2.2 PolicyRuleSchema',
  }),
  priority: z.number().int().optional().default(0).openapi({
    description: '우선순위 (높을수록 먼저 평가)',
  }),
  enabled: z.boolean().optional().default(true),
}).superRefine((data, ctx) => {
  // [v0.10] type별 rules JSON 검증 분기
  // SSoT: 33-time-lock-approval-mechanism.md §2.2 PolicyRuleSchema
  const schemaMap: Record<string, ZodSchema> = {
    SPENDING_LIMIT: SpendingLimitRuleSchema,
    WHITELIST: WhitelistRuleSchema,
    TIME_RESTRICTION: TimeRestrictionRuleSchema,
    RATE_LIMIT: RateLimitRuleSchema,
    ALLOWED_TOKENS: AllowedTokensRuleSchema,
    CONTRACT_WHITELIST: ContractWhitelistRuleSchema,
    METHOD_WHITELIST: MethodWhitelistRuleSchema,
    APPROVED_SPENDERS: ApprovedSpendersRuleSchema,
    APPROVE_AMOUNT_LIMIT: ApproveAmountLimitRuleSchema,
    APPROVE_TIER_OVERRIDE: ApproveTierOverrideRuleSchema,
  }
  const schema = schemaMap[data.type]
  if (!schema) return  // enum 검증에서 이미 걸림
  const result = schema.safeParse(data.rules)
  if (!result.success) {
    result.error.issues.forEach(issue => {
      ctx.addIssue({
        ...issue,
        path: ['rules', ...issue.path],
      })
    })
  }
}).openapi('CreatePolicyRequest')
```

**3) PolicySummarySchema 수정:**

기존:
```typescript
type: z.enum(['SPENDING_LIMIT', 'WHITELIST', 'TIME_RESTRICTION', 'RATE_LIMIT']),
```

변경:
```typescript
type: PolicyTypeEnum,
```

**4) SS8.10 UpdatePolicyRequestSchema에도 superRefine 적용 안내:**

UpdatePolicyRequestSchema는 rules와 type이 동시에 변경될 수 있으므로, type이 제공되지 않은 경우 기존 DB의 type을 조회하여 검증해야 한다. 이는 런타임 로직이므로 스키마 수준에서는 다음 패턴을 명시:

```markdown
> **[v0.10] UpdatePolicyRequest의 rules 검증:**
> `rules` 필드가 제공된 경우, 서비스 계층에서 `policies.type`을 조회하여 33-time-lock §2.2의 해당 PolicyRuleSchema로 검증한다. Zod 스키마 수준의 `.superRefine()`은 `type` 필드가 요청에 포함되지 않으므로 적용 불가 -- 서비스 계층 검증으로 대체.
```

**5) SS8.9에 type별 rules 요약 테이블 추가 (superRefine 코드 아래):**

```markdown
**[v0.10] type별 rules 스키마 요약 (SSoT: 33-time-lock §2.2 PolicyRuleSchema):**

| PolicyType | rules 스키마 | 핵심 필드 |
|------------|-------------|----------|
| SPENDING_LIMIT | SpendingLimitRuleSchema | tiers: { INSTANT, NOTIFY, DELAY, APPROVAL }, usdEquivalent? |
| WHITELIST | WhitelistRuleSchema | addresses: string[] |
| TIME_RESTRICTION | TimeRestrictionRuleSchema | allowedHours: { start, end }, allowedDays: number[], timezone |
| RATE_LIMIT | RateLimitRuleSchema | maxTransactions: number, windowSeconds: number |
| ALLOWED_TOKENS | AllowedTokensRuleSchema | tokens: { mint/address, symbol, decimals }[] |
| CONTRACT_WHITELIST | ContractWhitelistRuleSchema | contracts: { address, name?, methods? }[] |
| METHOD_WHITELIST | MethodWhitelistRuleSchema | methods: { selector, name?, contracts? }[] |
| APPROVED_SPENDERS | ApprovedSpendersRuleSchema | spenders: { address, label?, maxAmount? }[] |
| APPROVE_AMOUNT_LIMIT | ApproveAmountLimitRuleSchema | maxApproveAmount: string, allowUnlimited: boolean |
| APPROVE_TIER_OVERRIDE | ApproveTierOverrideRuleSchema | overrides: { tokenMint/address, tier }[] |
```

**6) 문서 상단 메타데이터에 v0.10 변경 이력 추가 (Task 1과 동일 줄에 합칠 수 있음):**

SS8.9 변경도 v0.10 이력에 포함: "SS8.9 PolicyType 4->10개 확장, superRefine 검증 추가".
  </action>
  <verify>
검증 명령:
1. `grep "PolicyTypeEnum" .planning/deliverables/37-rest-api-complete-spec.md` -- 3회 이상 (정의 + CreatePolicyRequest + PolicySummary)
2. `grep "superRefine" .planning/deliverables/37-rest-api-complete-spec.md` -- 2회 이상 (코드 + 설명)
3. `grep "APPROVE_TIER_OVERRIDE" .planning/deliverables/37-rest-api-complete-spec.md` -- 2회 이상 (enum + 테이블)
4. `grep "33-time-lock.*2.2\|PolicyRuleSchema" .planning/deliverables/37-rest-api-complete-spec.md` -- 3회 이상 (SSoT 참조)
5. SS8.9의 CreatePolicyRequestSchema에서 4개 enum이 아닌 PolicyTypeEnum 참조인지 확인
6. PolicySummarySchema에서도 PolicyTypeEnum을 사용하는지 확인
  </verify>
  <done>
37-rest-api SS8.9의 PolicyType enum이 10개(PolicyTypeEnum)로 확장되어 있고, CreatePolicyRequestSchema에 .superRefine() type별 rules 검증 분기가 명시되어 있으며, PolicySummarySchema도 10개 enum으로 동기화되어 있고, UpdatePolicyRequest의 서비스 계층 검증 가이드가 추가되어 있다. type별 rules 요약 테이블이 33-time-lock SS2.2를 SSoT로 참조한다.
  </done>
</task>

</tasks>

<verification>
Phase 42 Success Criteria #1 + #3 충족 확인:
- [ ] SS10.12에 66개 에러 코드 통합 매트릭스가 존재한다
- [ ] 429 응답 포맷(Retry-After 헤더 + 본문 retryAfter)이 확정되어 있다
- [ ] SS8.9의 PolicyType enum이 10개로 확장되어 있다
- [ ] CreatePolicyRequestSchema에 .superRefine() 로직이 명시되어 있다
- [ ] PolicySummarySchema의 type도 10개로 동기화되어 있다
- [ ] type별 rules 요약 테이블이 33-time-lock SS2.2를 SSoT로 참조한다
</verification>

<success_criteria>
1. 37-rest-api SS10.12에 66개 에러 코드 통합 매트릭스가 존재하고 SSoT로 선언되어 있다
2. 429 응답 포맷(Retry-After 헤더 + 본문 retryAfter + stage)이 확정되어 있다
3. SS10.11 합계가 66개로 정정되어 있다
4. SS8.9의 PolicyType enum이 10개(PolicyTypeEnum)로 확장되어 있다
5. CreatePolicyRequestSchema에 .superRefine()으로 type별 rules 검증 분기가 명시되어 있다
6. PolicySummarySchema의 type도 PolicyTypeEnum을 공유한다
7. type별 rules 요약 테이블이 33-time-lock SS2.2를 SSoT로 참조한다
</success_criteria>

<output>
After completion, create `.planning/phases/42-error-handling-completion/42-02-SUMMARY.md`
</output>
