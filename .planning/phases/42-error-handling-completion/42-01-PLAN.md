---
phase: 42-error-handling-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/deliverables/27-chain-adapter-interface.md
autonomous: true

must_haves:
  truths:
    - "27-chain-adapter의 ChainError 클래스에 category 필드가 PERMANENT|TRANSIENT|STALE 3개 리터럴로 정의되어 있다"
    - "24개 에러 코드 전체가 PERMANENT/TRANSIENT/STALE 중 하나로 분류되어 있고, 분류가 누락된 코드가 없다"
    - "카테고리별 복구 전략(재시도 횟수, 백오프 방식, 재시도 시작 단계)이 테이블로 정의되어 있다"
  artifacts:
    - path: ".planning/deliverables/27-chain-adapter-interface.md"
      provides: "ChainError category 필드 + 카테고리 분류 테이블 + 복구 전략"
      contains: "category.*PERMANENT.*TRANSIENT.*STALE"
  key_links:
    - from: "27-chain-adapter SS4.4 ChainError class"
      to: "27-chain-adapter SS4.5 매핑 테이블"
      via: "category 열 추가"
      pattern: "category"
    - from: "27-chain-adapter 카테고리별 복구 전략"
      to: "Phase 43 Stage 5 의사코드"
      via: "카테고리 기반 재시도 분기"
      pattern: "PERMANENT|TRANSIENT|STALE"
---

<objective>
27-chain-adapter-interface.md의 ChainError 에러 체계(SS4)에 category 3-카테고리 분류를 추가한다.

Purpose: Phase 43의 Stage 5 완전 의사코드가 이 카테고리를 참조하여 재시도/폐기를 결정론적으로 구현할 수 있도록, ChainError의 모든 코드를 PERMANENT/TRANSIENT/STALE로 분류하고 카테고리별 복구 전략을 정의한다.
Output: 27-chain-adapter SS4에 category 필드 추가 + 전체 에러 코드 카테고리 분류 + 복구 전략 테이블
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/deliverables/27-chain-adapter-interface.md
@.planning/phases/42-error-handling-completion/42-RESEARCH.md
@objectives/v0.10-pre-implementation-design-completion.md (Phase B: B-2)
</context>

<tasks>

<task type="auto">
  <name>Task 1: ChainError 클래스 category 필드 추가 + 에러 매핑 테이블 확장</name>
  <files>.planning/deliverables/27-chain-adapter-interface.md</files>
  <action>
27-chain-adapter-interface.md의 SS4를 다음과 같이 수정한다:

**1) SS4.4 ChainError 클래스에 category 필드 추가 (line ~1244 부근):**

`readonly retryable: boolean` 바로 아래에 추가:
```typescript
  /**
   * [v0.10] 에러 카테고리.
   * Stage 5 파이프라인에서 재시도 전략을 결정하는 기준.
   * - PERMANENT: 입력 수정 없이 재시도 불가. 클라이언트 수정 필요.
   * - TRANSIENT: 일시적 외부 장애. 동일 요청으로 지수 백오프 재시도 가능.
   * - STALE: 데이터 유효기간 만료. 새 데이터로 재빌드 후 즉시 1회 재시도.
   */
  readonly category: 'PERMANENT' | 'TRANSIENT' | 'STALE'
```

constructor params에도 `category: 'PERMANENT' | 'TRANSIENT' | 'STALE'` 추가하고, constructor body에 `this.category = params.category` 추가.

**2) SS4.5 에러 코드 매핑 테이블에 category 열 추가:**

기존 테이블 헤더를 확장:
`| 에러 코드 | 체인 | HTTP | 카테고리 | 재시도 | 복구 방법 |`

모든 24개(+) 에러 코드에 카테고리를 배정한다. 분류 기준 (42-RESEARCH.md 참조):

PERMANENT (재시도 불가):
- INSUFFICIENT_BALANCE, INVALID_ADDRESS, TRANSACTION_FAILED, SOLANA_PROGRAM_ERROR, EVM_REVERT
- v0.6 추가: TOKEN_NOT_FOUND, TOKEN_NOT_ALLOWED, INSUFFICIENT_TOKEN_BALANCE, CONTRACT_NOT_WHITELISTED, METHOD_NOT_WHITELISTED, SPENDER_NOT_APPROVED (= APPROVE_LIMIT_EXCEEDED도 동일), UNLIMITED_APPROVE_BLOCKED, BATCH_NOT_SUPPORTED, BATCH_SIZE_EXCEEDED, BATCH_INSTRUCTION_INVALID, CONTRACT_CALL_FAILED(기본 PERMANENT -- 조건부 재시도는 구현 시 개별 판단)

TRANSIENT (지수 백오프, max 3회):
- RPC_ERROR, NETWORK_ERROR, SIMULATION_FAILED
- EVM_GAS_TOO_LOW (gas limit 상향 후 1회 재빌드)

STALE (즉시 1회, 재빌드 필요):
- TRANSACTION_EXPIRED, SOLANA_BLOCKHASH_EXPIRED, SOLANA_BLOCKHASH_STALE, EVM_NONCE_TOO_LOW

기존 "재시도" 열의 O/X/조건부를 카테고리와 일관되게 정리. "조건부"는 해당 카테고리 분류에 따라 구체화.

**3) SS4.5 아래(또는 SS4.5를 확장하여) 카테고리별 복구 전략 서브섹션 추가:**

SS4.5 테이블 바로 아래에 다음 복구 전략 테이블을 추가:

```markdown
**카테고리별 복구 전략:**

| 카테고리 | 재시도 횟수 | 백오프 방식 | 재시도 시작 단계 | 복구 방법 |
|----------|:----------:|-----------|:---------------:|----------|
| PERMANENT | 0 | - | - | 클라이언트에 에러 반환. 입력 수정 또는 정책 변경 필요 |
| TRANSIENT | max 3회 | 지수 백오프 (1s, 2s, 4s) | 실패한 단계에서 재시도 | 대기 후 동일 호출 재시도 |
| STALE | 1회 | 즉시 (대기 없음) | Stage 5a (buildTransaction) | 새 데이터(blockhash/nonce)로 재빌드 후 재시도 |
```

추가 설명:
- STALE 카테고리는 TRANSIENT과 달리 "동일 요청으로 재시도"가 아닌 "새 데이터로 재빌드"가 필요하다. SOLANA_BLOCKHASH_STALE은 refreshBlockhash()로 빠른 복구가 가능하고, 나머지는 buildTransaction() 재실행이 필요하다.
- EVM_GAS_TOO_LOW는 TRANSIENT으로 분류하되, 재시도 시 gas limit을 1.2x로 상향하여 재빌드하는 특수 케이스임을 비고로 명시.
- Phase 43(CONC-01)의 Stage 5 완전 의사코드가 이 카테고리를 `err.category` 필드로 직접 참조하여 switch 분기한다.

**4) SS4.4 ChainError 코드 예시(기존 try-catch 예시)를 category 기반 분기로 업데이트:**

기존 switch(err.code) 예시를 category 기반으로 보강:
```typescript
if (err instanceof ChainError) {
  switch (err.category) {
    case 'PERMANENT':
      // 즉시 실패 반환, 재시도 없음
      return { status: 'FAILED', error: err }
    case 'TRANSIENT':
      // 지수 백오프 재시도 (max 3회)
      if (retryCount < 3) { await backoff(retryCount); continue }
      return { status: 'FAILED', error: err }
    case 'STALE':
      // 즉시 1회 재빌드 재시도
      if (retryCount < 1) { retryCount++; goto buildTransaction }
      return { status: 'FAILED', error: err }
  }
}
```

**주의사항:**
- v0.10 objectives(B-2)는 "§5"를 지시하나 현재 §5는 AdapterRegistry이다. 에러 체계는 §4에 있으므로 §4에 추가한다. 문서 상단 또는 변경 이력에 "[v0.10] §4에 에러 카테고리 추가" 메모를 남긴다.
- 기존 `retryable` 필드는 유지한다 (backward compatibility). category가 전략을 결정하고 retryable은 클라이언트 hint 역할. 단, retryable 값이 category와 일관되도록 정리: PERMANENT은 항상 false, TRANSIENT/STALE은 항상 true.
  </action>
  <verify>
검증 명령:
1. `grep -c "category" .planning/deliverables/27-chain-adapter-interface.md` -- 10회 이상 출현 (클래스 정의 + 테이블 + 복구 전략 + 코드 예시)
2. `grep -c "PERMANENT\|TRANSIENT\|STALE" .planning/deliverables/27-chain-adapter-interface.md` -- 30회 이상 출현 (24개 에러 코드 각각 + 복구 전략 테이블 + 설명)
3. `grep "카테고리별 복구 전략" .planning/deliverables/27-chain-adapter-interface.md` -- 복구 전략 테이블 존재 확인
4. ChainError 클래스 내에 `readonly category` 필드가 존재하는지 확인
  </verify>
  <done>
27-chain-adapter SS4.4 ChainError 클래스에 category 필드가 추가되어 있고, SS4.5 매핑 테이블에 24개 전체 에러 코드의 카테고리가 배정되어 있으며, 카테고리별 복구 전략 테이블(재시도 횟수/백오프/시작 단계)이 정의되어 있다. Phase 43 Stage 5 의사코드가 err.category로 분기할 수 있는 상태.
  </done>
</task>

</tasks>

<verification>
Phase 42 Success Criteria #2 충족 확인:
- [ ] 27-chain-adapter SS4에 모든 ChainError가 PERMANENT/TRANSIENT/STALE 3개 카테고리로 분류되어 있다
- [ ] 카테고리별 복구 전략(재시도 횟수, 백오프 방식)이 테이블로 정의되어 있다
- [ ] ChainError 클래스에 category 필드가 추가되어 있다
- [ ] 기존 retryable 필드와 category가 일관적이다
</verification>

<success_criteria>
1. ChainError 클래스에 `readonly category: 'PERMANENT' | 'TRANSIENT' | 'STALE'` 필드가 존재한다
2. 24개 에러 코드 전체가 3-카테고리로 분류된 테이블이 SS4.5에 존재한다
3. 카테고리별 복구 전략 테이블(3행: PERMANENT/TRANSIENT/STALE)이 존재한다
4. Phase 43 Stage 5 의사코드가 category 기반으로 분기할 수 있는 인터페이스가 확정되어 있다
</success_criteria>

<output>
After completion, create `.planning/phases/42-error-handling-completion/42-01-SUMMARY.md`
</output>
