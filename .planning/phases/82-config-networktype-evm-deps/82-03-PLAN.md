---
phase: 82-config-networktype-evm-deps
plan: 03
type: execute
wave: 2
depends_on: ["82-01"]
files_modified:
  - packages/core/src/schemas/agent.schema.ts
  - packages/core/src/__tests__/schemas.test.ts
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/__tests__/api-agents.test.ts
autonomous: true

must_haves:
  truths:
    - "CreateAgentRequestSchema network field is optional (undefined when omitted)"
    - "POST /v1/agents with chain='solana' and no network gets network='devnet'"
    - "POST /v1/agents with chain='ethereum' and no network gets config.rpc.evm_default_network"
    - "POST /v1/agents with chain='ethereum' + network='devnet' returns 400 VALIDATION_ERROR"
    - "POST /v1/agents with chain='solana' + network='ethereum-sepolia' returns 400 VALIDATION_ERROR"
    - "POST /v1/agents with chain='ethereum' + network='polygon-mainnet' succeeds"
  artifacts:
    - path: "packages/core/src/schemas/agent.schema.ts"
      provides: "CreateAgentRequestSchema with optional network"
      contains: "network.*optional"
    - path: "packages/daemon/src/api/routes/agents.ts"
      provides: "Agent creation with chain-based default network + validateChainNetwork"
      contains: "validateChainNetwork"
    - path: "packages/daemon/src/__tests__/api-agents.test.ts"
      provides: "Tests for chain-network validation and defaults"
  key_links:
    - from: "packages/daemon/src/api/routes/agents.ts"
      to: "@waiaas/core validateChainNetwork"
      via: "import and call in POST /agents handler"
      pattern: "validateChainNetwork"
    - from: "packages/daemon/src/api/routes/agents.ts"
      to: "config.rpc.evm_default_network"
      via: "deps.config for EVM default network"
      pattern: "evm_default_network"
---

<objective>
Make CreateAgentRequestSchema network optional with chain-based defaults, and integrate validateChainNetwork into agent creation to reject invalid combos.

Purpose: EVM agents need a different default network than Solana agents. Making network optional with chain-based service-layer defaults simplifies API usage while validateChainNetwork prevents invalid combos from reaching the DB.

Output: Updated agent schema, agent route with validation + defaults, integration tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/82-config-networktype-evm-deps/82-01-SUMMARY.md

@packages/core/src/schemas/agent.schema.ts
@packages/core/src/__tests__/schemas.test.ts
@packages/daemon/src/api/routes/agents.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/__tests__/api-agents.test.ts
@packages/daemon/src/infrastructure/config/loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CreateAgentRequestSchema network optional + route validation</name>
  <files>
    packages/core/src/schemas/agent.schema.ts
    packages/core/src/__tests__/schemas.test.ts
    packages/daemon/src/api/routes/agents.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
  </files>
  <action>
**1. Update CreateAgentRequestSchema in agent.schema.ts:**

Change network from `.default('devnet')` to `.optional()`:

```typescript
export const CreateAgentRequestSchema = z.object({
  name: z.string().min(1).max(100),
  chain: ChainTypeEnum.default('solana'),
  network: NetworkTypeEnum.optional(),
});
```

This means `network` can be `undefined` when omitted from the request body. The service layer (agent route) applies the default based on chain.

**2. Update schema tests in schemas.test.ts:**

Find/update the test for CreateAgentRequestSchema. Current test likely verifies `network` defaults to `'devnet'`. Change to verify:
- `{ name: 'test' }` parses to `{ name: 'test', chain: 'solana', network: undefined }`
- `{ name: 'test', network: 'devnet' }` parses to `{ ..., network: 'devnet' }`
- `{ name: 'test', chain: 'ethereum', network: 'ethereum-sepolia' }` parses successfully
- `{ name: 'test', network: 'invalid-network' }` fails Zod validation

**3. Update POST /agents handler in agents.ts:**

After `const parsed = c.req.valid('json');` add chain-based default network resolution and validation:

```typescript
const parsed = c.req.valid('json');
const chain = parsed.chain;

// Resolve default network if not specified
let network = parsed.network;
if (!network) {
  if (chain === 'solana') {
    network = 'devnet';
  } else if (chain === 'ethereum') {
    network = deps.config.rpc.evm_default_network;
  }
}

// Cross-validate chain + network
try {
  validateChainNetwork(chain as ChainType, network as NetworkType);
} catch (err) {
  throw new WAIaaSError('VALIDATION_ERROR', {
    message: err instanceof Error ? err.message : String(err),
  });
}
```

Import `validateChainNetwork` and `NetworkType` from `@waiaas/core`. Use the resolved `network` (not `parsed.network`) for the DB insert and key generation.

Update the DB insert and response to use the resolved `network` variable instead of `parsed.network`.

**4. Update openapi-schemas.ts if needed:**

Check `CreateAgentRequestOpenAPI`. If it uses `CreateAgentRequestSchema.openapi(...)`, verify it still works with optional network. The OpenAPI spec should show network as optional. If the OpenAPI schema needs explicit marking, add `.openapi({ description: ... })` to the network field.

**IMPORTANT:** Do NOT change `AgentSchema` (the DB/response schema) -- its `network` field remains required (NetworkTypeEnum, not optional) because agents in the DB always have a resolved network value.
  </action>
  <verify>
Run `cd packages/core && npx vitest run src/__tests__/schemas.test.ts` -- schema tests pass.
Run `cd packages/daemon && npx vitest run src/__tests__/api-agents.test.ts` -- check existing agent tests still pass.
  </verify>
  <done>
CreateAgentRequestSchema.network is optional. Agent route resolves default network from chain (solana->devnet, ethereum->config.rpc.evm_default_network). validateChainNetwork rejects invalid combos with VALIDATION_ERROR.
  </done>
</task>

<task type="auto">
  <name>Task 2: Agent creation chain-network validation integration tests</name>
  <files>
    packages/daemon/src/__tests__/api-agents.test.ts
  </files>
  <action>
**Add new test group to api-agents.test.ts** (append to existing tests, do not modify existing passing tests):

Add `describe('chain-network validation')` block with the following tests. Use the existing test app setup pattern from the file (likely `createApp()` or `createTestApp()` helper):

1. **`POST /agents with chain=solana, no network -> defaults to devnet`**:
   POST `{ name: 'sol-agent', chain: 'solana' }` (omit network). Expect 201 with `network: 'devnet'`.

2. **`POST /agents with chain=ethereum, no network -> defaults to evm_default_network`**:
   POST `{ name: 'eth-agent', chain: 'ethereum' }` (omit network). Expect 201 with `network: 'ethereum-sepolia'` (the config default).

3. **`POST /agents with chain=ethereum + network=ethereum-sepolia -> success`**:
   POST `{ name: 'eth-agent', chain: 'ethereum', network: 'ethereum-sepolia' }`. Expect 201.

4. **`POST /agents with chain=ethereum + network=polygon-mainnet -> success`**:
   POST `{ name: 'poly-agent', chain: 'ethereum', network: 'polygon-mainnet' }`. Expect 201 with `network: 'polygon-mainnet'`.

5. **`POST /agents with chain=ethereum + network=devnet -> 400`**:
   POST `{ name: 'bad-agent', chain: 'ethereum', network: 'devnet' }`. Expect 400 response with error code 'VALIDATION_ERROR'.

6. **`POST /agents with chain=solana + network=ethereum-sepolia -> 400`**:
   POST `{ name: 'bad-agent', chain: 'solana', network: 'ethereum-sepolia' }`. Expect 400 with 'VALIDATION_ERROR'.

7. **`POST /agents with chain=solana + network=mainnet -> success`**:
   POST `{ name: 'sol-main', chain: 'solana', network: 'mainnet' }`. Expect 201.

**IMPORTANT adaptation notes:**
- The agent creation calls `keyStore.generateKeyPair()` -- for chain='ethereum' this will throw because EVM key generation is not yet implemented (Phase 83). **Tests that expect 201 for chain='ethereum' should be marked with `it.skip` or wrapped to catch the expected keystore error and assert 500.** Add a comment: `// Will pass after Phase 83 (keystore multi-curve)`.
- Alternatively, mock the keyStore to return a fake publicKey for chain='ethereum'. Check the existing test setup to see if keyStore is already mocked.
- Tests 5 and 6 (400 validation errors) should work NOW because validation happens before keyStore.generateKeyPair.
- Test 1 and 7 (Solana) should work NOW.

The key insight: validation tests (400 responses) and Solana default tests work immediately. EVM 201 success tests need keyStore mock or Phase 83.
  </action>
  <verify>
Run `cd packages/daemon && npx vitest run src/__tests__/api-agents.test.ts` -- all tests pass (EVM 201 tests are either skipped or use mocked keyStore).
Run `cd packages/core && npx vitest run` -- core tests pass.
Run `cd packages/adapters/evm && npx vitest run` -- evm adapter tests pass.
  </verify>
  <done>
POST /agents validates chain-network cross-combinations. Invalid combos (solana+ethereum-sepolia, ethereum+devnet) return 400 VALIDATION_ERROR. Solana defaults to devnet, Ethereum defaults to config.rpc.evm_default_network. Tests confirm all validation paths.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/core && npx vitest run` -- all pass
2. `cd packages/daemon && npx vitest run src/__tests__/api-agents.test.ts` -- all pass
3. CreateAgentRequestSchema parses `{ name: 'x' }` without network field (no ZodError)
4. POST /v1/agents with chain=solana, no network -> 201 with network='devnet'
5. POST /v1/agents with chain=ethereum + network=devnet -> 400 VALIDATION_ERROR
6. POST /v1/agents with chain=solana + network=ethereum-sepolia -> 400 VALIDATION_ERROR
7. No regressions in existing agent CRUD tests
</verification>

<success_criteria>
- CreateAgentRequestSchema.network is optional (not default('devnet'))
- Service layer applies chain-based defaults (solana->devnet, ethereum->evm_default_network)
- validateChainNetwork integrated in POST /agents, returns 400 on invalid combos
- All existing agent tests pass without modification
- New integration tests cover all validation paths
</success_criteria>

<output>
After completion, create `.planning/phases/82-config-networktype-evm-deps/82-03-SUMMARY.md`
</output>
