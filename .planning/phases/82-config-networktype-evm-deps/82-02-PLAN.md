---
phase: 82-config-networktype-evm-deps
plan: 02
type: execute
wave: 2
depends_on: ["82-01"]
files_modified:
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/__tests__/config-loader.test.ts
  - packages/adapters/evm/src/adapter.ts
  - packages/adapters/evm/src/__tests__/evm-adapter.test.ts
autonomous: true

must_haves:
  truths:
    - "DaemonConfigSchema.rpc has 16 keys (5 Solana + 10 EVM + evm_default_network)"
    - "ethereum_mainnet/ethereum_sepolia keys are removed from config schema"
    - "evm_default_network defaults to 'ethereum-sepolia' and validates with EvmNetworkTypeEnum"
    - "EvmAdapter constructor accepts nativeSymbol/nativeName and getBalance/getAssets use them"
    - "Env override WAIAAS_RPC_EVM_DEFAULT_NETWORK correctly sets evm_default_network"
    - "All 10 EVM RPC keys have public drpc.org default URLs"
  artifacts:
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "DaemonConfigSchema with 16 rpc keys including evm_default_network"
      contains: "evm_default_network"
    - path: "packages/daemon/src/__tests__/config-loader.test.ts"
      provides: "Tests for EVM RPC defaults, evm_default_network validation, env overrides"
    - path: "packages/adapters/evm/src/adapter.ts"
      provides: "EvmAdapter with nativeSymbol/nativeName constructor params"
      contains: "nativeSymbol"
    - path: "packages/adapters/evm/src/__tests__/evm-adapter.test.ts"
      provides: "Tests for nativeSymbol/nativeName in getBalance/getAssets"
  key_links:
    - from: "packages/daemon/src/infrastructure/config/loader.ts"
      to: "@waiaas/core EvmNetworkTypeEnum"
      via: "import for evm_default_network validation"
      pattern: "EvmNetworkTypeEnum"
    - from: "packages/adapters/evm/src/adapter.ts"
      to: "getBalance return"
      via: "nativeSymbol replaces hardcoded 'ETH'"
      pattern: "this\\._nativeSymbol"
---

<objective>
Add EVM RPC keys to DaemonConfigSchema and make EvmAdapter return chain-specific native token symbols.

Purpose: Config schema provides default RPC URLs for all Tier 1 EVM networks so the daemon works without manual config. EvmAdapter nativeSymbol/nativeName ensures getBalance/getAssets return correct symbols (e.g., POL on Polygon instead of ETH).

Output: Updated config loader with 16 RPC keys, updated EvmAdapter constructor, comprehensive tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/82-config-networktype-evm-deps/82-01-SUMMARY.md

@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/__tests__/config-loader.test.ts
@packages/adapters/evm/src/adapter.ts
@packages/adapters/evm/src/__tests__/evm-adapter.test.ts
@objectives/v1.4.1-evm-wallet-infrastructure.md (section 3: Config extension, RPC keys)
</context>

<tasks>

<task type="auto">
  <name>Task 1: DaemonConfigSchema EVM RPC keys + evm_default_network + tests</name>
  <files>
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/__tests__/config-loader.test.ts
  </files>
  <action>
**1. Update DaemonConfigSchema rpc section in loader.ts:**

Remove the existing `ethereum_mainnet` and `ethereum_sepolia` keys (empty-string defaults, unused). Add 10 EVM Tier 1 RPC keys + `evm_default_network`:

```typescript
rpc: z.object({
  // Solana (unchanged)
  solana_mainnet:    z.string().default('https://api.mainnet-beta.solana.com'),
  solana_devnet:     z.string().default('https://api.devnet.solana.com'),
  solana_testnet:    z.string().default('https://api.testnet.solana.com'),
  solana_ws_mainnet: z.string().default('wss://api.mainnet-beta.solana.com'),
  solana_ws_devnet:  z.string().default('wss://api.devnet.solana.com'),

  // EVM Tier 1 (replaces ethereum_mainnet/ethereum_sepolia)
  evm_ethereum_mainnet:  z.string().default('https://eth.drpc.org'),
  evm_ethereum_sepolia:  z.string().default('https://sepolia.drpc.org'),
  evm_polygon_mainnet:   z.string().default('https://polygon.drpc.org'),
  evm_polygon_amoy:      z.string().default('https://polygon-amoy.drpc.org'),
  evm_arbitrum_mainnet:  z.string().default('https://arbitrum.drpc.org'),
  evm_arbitrum_sepolia:  z.string().default('https://arbitrum-sepolia.drpc.org'),
  evm_optimism_mainnet:  z.string().default('https://optimism.drpc.org'),
  evm_optimism_sepolia:  z.string().default('https://optimism-sepolia.drpc.org'),
  evm_base_mainnet:      z.string().default('https://base.drpc.org'),
  evm_base_sepolia:      z.string().default('https://base-sepolia.drpc.org'),

  // EVM default network for agent creation when network not specified
  evm_default_network:   EvmNetworkTypeEnum.default('ethereum-sepolia'),
}).default({}),
```

Import `EvmNetworkTypeEnum` from `@waiaas/core` at the top of the file.

**Note:** RPC URLs use `.default()` with non-empty strings (public drpc.org endpoints). Previous ethereum_* had empty string defaults which was a design gap. The `.default()` values are plain strings (not `.url()` validated) since some users may want to set custom RPC providers without strict URL validation.

**2. Add tests in config-loader.test.ts:**

Add a new `describe('EVM RPC config')` block:

- `test('default config has all 10 EVM RPC URLs')`: Load config from empty dir (no config.toml), verify all 10 `evm_*` keys exist and are non-empty strings containing 'drpc.org'.

- `test('default config has evm_default_network = ethereum-sepolia')`: Load default config, verify `config.rpc.evm_default_network === 'ethereum-sepolia'`.

- `test('evm_default_network rejects Solana network values')`: Verify that `DaemonConfigSchema.parse({ rpc: { evm_default_network: 'devnet' } })` throws ZodError (EvmNetworkTypeEnum rejects 'devnet').

- `test('evm_default_network accepts valid EVM network')`: Verify that `DaemonConfigSchema.parse({ rpc: { evm_default_network: 'polygon-mainnet' } })` succeeds and value is 'polygon-mainnet'.

- `test('env override WAIAAS_RPC_EVM_DEFAULT_NETWORK works')`: Set env var `WAIAAS_RPC_EVM_DEFAULT_NETWORK=polygon-mainnet`, load config, verify `config.rpc.evm_default_network === 'polygon-mainnet'`.

- `test('env override WAIAAS_RPC_EVM_ETHEREUM_MAINNET works')`: Set env var, load config, verify RPC URL overridden.

- `test('old ethereum_mainnet key is not in schema')`: Verify `'ethereum_mainnet' in config.rpc` is false for default config. This confirms the old keys are removed.

**3. Update existing tests if any reference `ethereum_mainnet`/`ethereum_sepolia`:** Search the test file for these keys and update any assertions that expect them to exist.
  </action>
  <verify>
Run `cd packages/daemon && npx vitest run src/__tests__/config-loader.test.ts` -- all tests pass including new EVM RPC tests.
  </verify>
  <done>
DaemonConfigSchema.rpc has 16 keys (5 Solana + 10 EVM + evm_default_network). Old ethereum_mainnet/ethereum_sepolia removed. evm_default_network defaults to 'ethereum-sepolia' and validates via EvmNetworkTypeEnum. Env overrides work for all EVM keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: EvmAdapter nativeSymbol/nativeName constructor params + tests</name>
  <files>
    packages/adapters/evm/src/adapter.ts
    packages/adapters/evm/src/__tests__/evm-adapter.test.ts
  </files>
  <action>
**1. Modify EvmAdapter constructor in adapter.ts:**

Add optional `nativeSymbol` and `nativeName` parameters with defaults:

```typescript
private _nativeSymbol: string;
private _nativeName: string;

constructor(
  network: NetworkType,
  chain?: Chain,
  nativeSymbol: string = 'ETH',
  nativeName: string = 'Ether',
) {
  this.network = network;
  this._chain = chain;
  this._nativeSymbol = nativeSymbol;
  this._nativeName = nativeName;
}
```

**2. Update getBalance() to use nativeSymbol:**

Replace hardcoded `'ETH'`:
```typescript
return {
  address: addr,
  balance,
  decimals: 18,
  symbol: this._nativeSymbol,  // was 'ETH'
};
```

**3. Update getAssets() to use nativeSymbol and nativeName:**

Replace hardcoded `'ETH'` and `'Ethereum'` in the native asset entry:
```typescript
const assets: AssetInfo[] = [
  {
    mint: 'native',
    symbol: this._nativeSymbol,    // was 'ETH'
    name: this._nativeName,        // was 'Ethereum'
    balance: ethBalance,
    decimals: 18,
    isNative: true,
  },
];
```

**4. Add/update tests in evm-adapter.test.ts:**

Add a new `describe('nativeSymbol/nativeName')` block:

- `test('default constructor uses ETH/Ether')`: Create `new EvmAdapter('ethereum-sepolia')`, mock connect + getBalance RPC, verify balance response has `symbol: 'ETH'`.

- `test('custom nativeSymbol for Polygon')`: Create `new EvmAdapter('polygon-mainnet', undefined, 'POL', 'POL')`, mock connect + getBalance RPC, verify balance response has `symbol: 'POL'`.

- `test('getAssets returns custom native symbol')`: Create adapter with nativeSymbol='POL', nativeName='POL', mock connect + getAssets RPC (mock `getBalance` and empty multicall), verify first asset has `symbol: 'POL'` and `name: 'POL'`.

**IMPORTANT:** Existing tests create `new EvmAdapter(network)` or `new EvmAdapter(network, chain)` without nativeSymbol/nativeName. These MUST continue to work with defaults ('ETH'/'Ether'). Do NOT break existing test signatures. The new params are optional with defaults.

**5. Verify no regressions:** Ensure all existing evm-adapter tests pass unchanged since the new params have defaults matching the previous hardcoded values.
  </action>
  <verify>
Run `cd packages/adapters/evm && npx vitest run` -- all tests pass including new nativeSymbol tests.
Run `cd packages/daemon && npx vitest run src/__tests__/config-loader.test.ts` -- config tests pass.
Run from repo root `npx vitest run --reporter=verbose 2>&1 | tail -30` to confirm no cross-package regressions.
  </verify>
  <done>
EvmAdapter constructor accepts optional nativeSymbol/nativeName (defaults 'ETH'/'Ether'). getBalance returns correct symbol per chain. getAssets native entry uses custom symbol/name. Polygon adapter returns 'POL'. All existing tests pass without modification.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/daemon && npx vitest run src/__tests__/config-loader.test.ts` -- all pass
2. `cd packages/adapters/evm && npx vitest run` -- all pass
3. Default config has 16 rpc keys (5 Solana + 10 EVM + evm_default_network)
4. `config.rpc.ethereum_mainnet` does not exist (old key removed)
5. `config.rpc.evm_ethereum_mainnet` is 'https://eth.drpc.org'
6. `config.rpc.evm_default_network` is 'ethereum-sepolia'
7. EvmAdapter('polygon-mainnet', chain, 'POL', 'POL').getBalance() returns symbol: 'POL'
8. EvmAdapter('ethereum-sepolia').getBalance() returns symbol: 'ETH' (backward compatible)
</verification>

<success_criteria>
- DaemonConfigSchema has 16 RPC keys with working defaults
- Old ethereum_mainnet/ethereum_sepolia removed
- evm_default_network validated by EvmNetworkTypeEnum
- EvmAdapter uses nativeSymbol/nativeName from constructor
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/82-config-networktype-evm-deps/82-02-SUMMARY.md`
</output>
