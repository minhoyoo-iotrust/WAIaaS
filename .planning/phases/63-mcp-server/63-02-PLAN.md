---
phase: 63-mcp-server
plan: 02
type: execute
wave: 2
depends_on: ["63-01"]
files_modified:
  - packages/mcp/src/session-manager.ts
  - packages/mcp/src/__tests__/session-manager.test.ts
  - packages/cli/src/index.ts
  - packages/cli/src/commands/mcp-setup.ts
  - packages/cli/src/__tests__/mcp-setup.test.ts
autonomous: true

must_haves:
  truths:
    - "SessionManager retries renewal on failure with exponential backoff (1s, 2s, 4s) up to 3 times"
    - "SessionManager prevents concurrent renewal via isRenewing flag"
    - "SessionManager handles 409 RENEWAL_CONFLICT by checking current token validity"
    - "SessionManager handles 5 error types: TOO_EARLY, LIMIT, LIFETIME, NETWORK, EXPIRED"
    - "SessionManager recovery loop polls mcp-token file every 60s when in expired/error state"
    - "CLI waiaas mcp setup creates session, writes mcp-token file, and prints config.json snippet"
    - "CLI mcp setup uses masterAuth to create session via POST /v1/sessions"
  artifacts:
    - path: "packages/mcp/src/session-manager.ts"
      provides: "SessionManager with retry, conflict handling, recovery loop"
      exports: ["SessionManager"]
    - path: "packages/mcp/src/__tests__/session-manager.test.ts"
      provides: "Comprehensive SessionManager tests including retry, conflict, recovery"
      min_lines: 200
    - path: "packages/cli/src/commands/mcp-setup.ts"
      provides: "CLI mcp setup command implementation"
      exports: ["mcpSetupCommand"]
    - path: "packages/cli/src/__tests__/mcp-setup.test.ts"
      provides: "CLI mcp setup tests"
      min_lines: 50
  key_links:
    - from: "packages/mcp/src/session-manager.ts"
      to: "daemon PUT /v1/sessions/:id/renew"
      via: "fetch in renew()"
      pattern: "sessions.*renew"
    - from: "packages/cli/src/commands/mcp-setup.ts"
      to: "daemon POST /v1/sessions"
      via: "fetch to create session"
      pattern: "/v1/sessions"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/mcp-setup.ts"
      via: "commander subcommand"
      pattern: "mcp.*setup"
---

<objective>
Harden SessionManager with exponential backoff retry on renewal failure, isRenewing concurrency guard, 409 RENEWAL_CONFLICT handling, recovery loop, and implement CLI `waiaas mcp setup` command that creates session + writes mcp-token file + outputs Claude Desktop config.json snippet.

Purpose: Complete the session management lifecycle (MCP-03 through MCP-06) so MCP server automatically maintains valid sessions and users can set up MCP integration with a single CLI command.

Output: Enhanced SessionManager with failure handling + recovery, CLI mcp setup command, ~50 tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-mcp-server/63-01-SUMMARY.md
@.planning/phases/39-cli-telegram-integration-design/39-01-SUMMARY.md
@packages/cli/src/index.ts
@packages/cli/src/commands/init.ts
@packages/cli/src/utils/data-dir.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SessionManager hardening -- retry, conflict, recovery loop + tests</name>
  <files>
    packages/mcp/src/session-manager.ts
    packages/mcp/src/__tests__/session-manager.test.ts
  </files>
  <action>
Enhance the SessionManager from Plan 63-01 with the following features from design Phase 37-02 and Phase 38-02:

**1. Exponential backoff retry on renewal failure (MCP-04, SM-11):**

Add `retryRenewal()` method:
- Max 3 retries with delays: 1s, 2s, 4s (exponential backoff)
- Only retry on NETWORK errors and specific retryable HTTP statuses (429, 500, 502, 503, 504)
- Do NOT retry on: 409 (RENEWAL_CONFLICT), 400 (TOO_EARLY), 403 (LIMIT/LIFETIME_EXPIRED), 401 (session expired)
- Log each retry attempt to stderr: `[waiaas-mcp:session] Renewal retry ${attempt}/${maxRetries} in ${delay}ms`
- After all retries exhausted, call handleRenewalError()

**2. handleRenewalError() (SM-11) -- 5 error type branches:**

| HTTP Status | Error Type | Action | State Transition |
|-------------|-----------|--------|------------------|
| 400 (RENEWAL_TOO_EARLY) | TOO_EARLY | Wait 30s, retry once | Stay active |
| 403 (RENEWAL_LIMIT_EXCEEDED) | LIMIT | Log, give up, start recovery loop | -> expired |
| 403 (SESSION_LIFETIME_EXPIRED) | LIFETIME | Log, give up, start recovery loop | -> expired |
| 0 (network/timeout) | NETWORK | Already retried in retryRenewal. Start recovery loop | -> error |
| 401 (SESSION_EXPIRED) | EXPIRED | Start recovery loop | -> expired |

**3. isRenewing concurrency guard (MCP-05):**

In renew():
```typescript
if (this.isRenewing) {
  console.error('[waiaas-mcp:session] Renewal already in progress, skipping');
  return;
}
this.isRenewing = true;
try {
  // ... renewal logic
} finally {
  this.isRenewing = false;
}
```

**4. 409 RENEWAL_CONFLICT handling (MCP-05, CONC-02):**

When PUT /v1/sessions/:id/renew returns 409:
1. Log: `[waiaas-mcp:session] Renewal conflict (409), checking current token`
2. Read token from file (if dataDir exists)
3. If file token differs from memory token, update memory token and decode new expiration
4. If new token is still valid (exp > now), schedule next renewal
5. If no valid token found, start recovery loop

**5. Recovery loop (SMGI-D03):**

Add `startRecoveryLoop()` method:
- Called when state transitions to 'expired' or 'error'
- Polls readMcpToken() every 60 seconds
- If valid token found (different from current, exp > now):
  - Update memory state
  - Set state='active'
  - Schedule renewal
  - Stop recovery loop
- Stop on dispose()

Add `stopRecoveryLoop()` method to clear the recovery timer.

**6. safeSetTimeout wrapper (SM-08):**

Add helper to handle setTimeout 32-bit overflow (>2^31-1 ms = ~24.8 days):
```typescript
function safeSetTimeout(fn: () => void, delay: number): NodeJS.Timeout {
  const MAX = 2_147_483_647; // 2^31 - 1
  if (delay > MAX) {
    return setTimeout(() => safeSetTimeout(fn, delay - MAX), MAX);
  }
  return setTimeout(fn, delay);
}
```

**Tests (~35 tests in __tests__/session-manager.test.ts):**

Use vi.useFakeTimers() for timer-dependent tests. Mock fetch via vi.stubGlobal.

- **Token loading (5 tests):**
  - Load from env var when no dataDir
  - Load from mcp-token file when dataDir provided (mock fs.readFile)
  - File takes priority over env var (SM-04)
  - Invalid JWT (no exp) sets state='error'
  - Expired token sets state='expired'

- **Renewal scheduling (5 tests):**
  - scheduleRenewal sets timer at 60% of TTL
  - Timer fires and calls renew()
  - Successful renewal updates token + reschedules
  - Renewal writes to file first, then updates memory (H-02 file-first)
  - getToken() returns old token during renewal (SM-14)

- **Retry on failure (5 tests):**
  - Network error triggers retry with exponential backoff
  - Retries 3 times with delays 1s, 2s, 4s
  - Gives up after max retries, transitions to error state
  - 400 TOO_EARLY: waits 30s and retries once
  - Non-retryable errors (403, 401) skip retry

- **isRenewing concurrency (3 tests):**
  - Concurrent renew() call is skipped when isRenewing=true
  - isRenewing reset to false after successful renewal
  - isRenewing reset to false after failed renewal

- **409 RENEWAL_CONFLICT (4 tests):**
  - 409 triggers file re-read
  - If file has newer valid token, update and reschedule
  - If file has same token, start recovery loop
  - If no file, start recovery loop

- **Recovery loop (5 tests):**
  - Recovery loop polls every 60s
  - Valid token in file -> active + scheduleRenewal + stop loop
  - Invalid token in file -> continue polling
  - dispose() stops recovery loop
  - Recovery loop does not start when already running

- **Error handling (3 tests):**
  - RENEWAL_LIMIT_EXCEEDED -> expired state + recovery loop
  - SESSION_LIFETIME_EXPIRED -> expired state + recovery loop
  - getToken() returns null when state='expired'

- **Dispose (2 tests):**
  - dispose() clears renewal timer
  - dispose() clears recovery timer

- **safeSetTimeout (3 tests):**
  - Normal delay works normally
  - Large delay (>2^31) chains setTimeout calls
  - Chained timeout eventually fires callback
  </action>
  <verify>
    - `pnpm test --filter @waiaas/mcp -- session-manager` passes with ~35 tests
    - `pnpm typecheck --filter @waiaas/mcp` passes
    - `grep -c 'isRenewing' packages/mcp/src/session-manager.ts` >= 5
    - `grep -c 'recoveryLoop\|recoveryTimer' packages/mcp/src/session-manager.ts` >= 3
  </verify>
  <done>
    SessionManager hardened with: exponential backoff retry (1s/2s/4s, max 3), isRenewing concurrency guard, 409 RENEWAL_CONFLICT file re-read, 5-type error handling (TOO_EARLY/LIMIT/LIFETIME/NETWORK/EXPIRED), recovery loop (60s polling), safeSetTimeout overflow guard. ~35 tests passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI waiaas mcp setup command + tests</name>
  <files>
    packages/cli/src/index.ts
    packages/cli/src/commands/mcp-setup.ts
    packages/cli/src/__tests__/mcp-setup.test.ts
  </files>
  <action>
Implement CLI `waiaas mcp setup` command following design from Phase 39-01 (CLI-01 through CLI-06).

**1. Create packages/cli/src/commands/mcp-setup.ts:**

Following the 7-step flow from CLI-02:

```typescript
export async function mcpSetupCommand(opts: McpSetupOptions): Promise<void> {
  // Step 1: Check daemon is running
  // Try GET /v1/admin/status or just check if port responds
  const baseUrl = opts.baseUrl ?? 'http://127.0.0.1:3100';

  // Step 2: Resolve agent ID
  // If --agent provided, use it
  // If not provided, GET /v1/agents to list agents
  //   - 1 agent: auto-select (CLI-04)
  //   - 0 agents: error "No agents found. Run waiaas init first."
  //   - 2+ agents: error "Multiple agents found. Specify --agent <id>"

  // Step 3: Build session constraints
  // Use --expires-in (default: 86400 = 24h)
  // Optional: --max-amount, --allowed-ops

  // Step 4: Create session via POST /v1/sessions
  // Send masterAuth (X-Master-Password header with password)
  // Request body: { agentId, expiresIn, constraints }
  // Response: { id, token, expiresAt }

  // Step 5: Write token to mcp-token file
  // Path: dataDir/mcp-token (using resolveDataDir utility)
  // Atomic write: write to .tmp, rename
  const tokenPath = path.join(dataDir, 'mcp-token');
  await fs.writeFile(tokenPath + '.tmp', token, 'utf-8');
  await fs.rename(tokenPath + '.tmp', tokenPath);

  // Step 6: Output result
  console.log('MCP session created successfully!');
  console.log(`  Token file: ${tokenPath}`);
  console.log(`  Expires at: ${new Date(expiresAt * 1000).toISOString()}`);
  console.log(`  Agent: ${agentId}`);

  // Step 7: Print Claude Desktop config.json snippet (CLI-05)
  const configSnippet = {
    mcpServers: {
      'waiaas-wallet': {
        command: 'npx',
        args: ['@waiaas/mcp'],
        env: {
          WAIAAS_DATA_DIR: dataDir,
          WAIAAS_BASE_URL: baseUrl,
        },
      },
    },
  };
  console.log('\nAdd to your Claude Desktop config.json:');
  console.log(JSON.stringify(configSnippet, null, 2));

  // Print config.json path per platform (CLI-05)
  const platform = process.platform;
  if (platform === 'darwin') {
    console.log(`\nConfig location: ~/Library/Application Support/Claude/claude_desktop_config.json`);
  } else if (platform === 'win32') {
    console.log(`\nConfig location: %APPDATA%\\Claude\\claude_desktop_config.json`);
  } else {
    console.log(`\nConfig location: ~/.config/Claude/claude_desktop_config.json`);
  }
}
```

Options interface:
```typescript
interface McpSetupOptions {
  dataDir?: string;
  baseUrl?: string;
  agent?: string;
  expiresIn?: number;
  masterPassword?: string;
}
```

Note on masterAuth: The mcp setup command needs to create a session, which requires masterAuth. The command should prompt for (or accept --password) the master password. Use the same password utility from packages/cli/src/utils/password.ts if available. If the daemon has a default/init password, use that. The session creation endpoint POST /v1/sessions requires masterAuth header (X-Master-Password).

**2. Update packages/cli/src/index.ts:**

Add mcp subcommand group using commander:
```typescript
import { mcpSetupCommand } from './commands/mcp-setup.js';

const mcp = program.command('mcp').description('MCP integration commands');

mcp
  .command('setup')
  .description('Set up MCP integration for Claude Desktop')
  .option('--data-dir <path>', 'Data directory path')
  .option('--base-url <url>', 'Daemon base URL', 'http://127.0.0.1:3100')
  .option('--agent <id>', 'Agent ID (auto-detected if only one)')
  .option('--expires-in <seconds>', 'Session expiration in seconds', '86400')
  .option('--password <password>', 'Master password')
  .action(async (opts) => {
    const dataDir = resolveDataDir(opts);
    await mcpSetupCommand({
      dataDir,
      baseUrl: opts.baseUrl,
      agent: opts.agent,
      expiresIn: parseInt(opts.expiresIn, 10),
      masterPassword: opts.password,
    });
  });
```

**3. Tests (~15 tests in __tests__/mcp-setup.test.ts):**

Mock fetch to simulate daemon responses:
- Test successful setup flow (1 agent auto-detect, session created, file written)
- Test --agent flag passed to session creation
- Test multiple agents without --agent -> error
- Test no agents -> error
- Test daemon unreachable -> error
- Test session creation failure (401 bad password) -> error
- Test mcp-token file written with correct content
- Test config.json snippet output format
- Test platform-specific config path (mock process.platform)
- Test --expires-in passed correctly
- Test file atomic write (tmp + rename pattern)

Use vi.stubGlobal('fetch') and mock fs operations where needed.

Run `pnpm test --filter @waiaas/cli -- mcp-setup` to verify tests pass.
  </action>
  <verify>
    - `pnpm test --filter @waiaas/cli -- mcp-setup` passes with ~15 tests
    - `pnpm typecheck --filter @waiaas/cli` passes
    - `grep 'mcp.*setup' packages/cli/src/index.ts` shows the command registration
    - `ls packages/cli/src/commands/mcp-setup.ts` exists
  </verify>
  <done>
    CLI `waiaas mcp setup` command: creates session via masterAuth, writes mcp-token file (atomic), outputs config.json snippet with platform-specific paths. Auto-detects agent when single agent exists. ~15 tests passing. MCP-06 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test --filter @waiaas/mcp` passes with all tests (~60 from 63-01 + ~35 new = ~95)
2. `pnpm test --filter @waiaas/cli -- mcp-setup` passes (~15 tests)
3. `pnpm typecheck` passes across all packages
4. SessionManager handles: renewal retry (1s/2s/4s), isRenewing guard, 409 conflict, recovery loop (60s)
5. CLI `waiaas mcp setup --help` shows options
6. No console.log in packages/mcp/src/ (excluding test files)
</verification>

<success_criteria>
- SessionManager retries with exponential backoff 1s/2s/4s up to 3 times on transient failures (MCP-04)
- isRenewing flag prevents concurrent renewal (MCP-05)
- 409 RENEWAL_CONFLICT triggers file re-read and token validity check (MCP-05)
- Recovery loop polls every 60s when token expired/error
- 5 error types handled correctly with appropriate state transitions
- CLI mcp setup creates session + writes mcp-token + prints config.json (MCP-06)
- ~50 new tests (35 SessionManager + 15 CLI) all passing
</success_criteria>

<output>
After completion, create `.planning/phases/63-mcp-server/63-02-SUMMARY.md`
</output>
