---
phase: 15-security-test-scenarios
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - docs/v0.4/46-keystore-external-security-scenarios.md
  - docs/v0.4/47-boundary-value-chain-scenarios.md
autonomous: true

must_haves:
  truths:
    - "키스토어 보안 시나리오 4개 이상(파일 변조, 틀린 패스워드, 권한, 메모리 잔존)이 정의되어 있다"
    - "4-tier 경계값(금액 +/-1, 시간 -1초/정확히/+1초)이 표로 정리되어 있다"
    - "TOCTOU 동시성 경계 테스트 케이스가 정의되어 있다"
    - "3-5개 E2E 연쇄 공격 체인이 Layer 1-2-3을 관통하는 형태로 정의되어 있다"
    - "연쇄 체인에 성공+실패 양쪽과 복구 흐름이 포함되어 있다"
  artifacts:
    - path: "docs/v0.4/46-keystore-external-security-scenarios.md"
      provides: "키스토어 보안 시나리오 + 외부 위협 시나리오"
      contains: "SEC-04"
      min_lines: 100
    - path: "docs/v0.4/47-boundary-value-chain-scenarios.md"
      provides: "경계값 테스트 케이스 표 + E2E 연쇄 공격 체인"
      contains: "SEC-05"
      min_lines: 150
  key_links:
    - from: "docs/v0.4/47-boundary-value-chain-scenarios.md"
      to: "docs/v0.4/43-layer1-session-auth-attacks.md"
      via: "연쇄 체인에서 Layer 1 시나리오 참조"
      pattern: "SEC-01"
    - from: "docs/v0.4/47-boundary-value-chain-scenarios.md"
      to: "docs/v0.4/44-layer2-policy-bypass-attacks.md"
      via: "연쇄 체인에서 Layer 2 시나리오 참조"
      pattern: "SEC-02"
    - from: "docs/v0.4/47-boundary-value-chain-scenarios.md"
      to: "docs/v0.4/45-layer3-killswitch-recovery-attacks.md"
      via: "연쇄 체인에서 Layer 3 시나리오 참조"
      pattern: "SEC-03"
    - from: "docs/v0.4/46-keystore-external-security-scenarios.md"
      to: ".planning/deliverables/26-keystore-spec.md"
      via: "키스토어 공격 벡터 원본"
      pattern: "AES-256-GCM|Argon2id|sodium_memzero"
---

<objective>
키스토어 보안 시나리오, 외부 위협 시나리오, 경계값 테스트 케이스, 그리고 3계층을 관통하는 E2E 연쇄 공격 체인을 정의한다.

Purpose: Layer 1-2-3 개별 시나리오(Plan 01, 02)를 보완하는 키스토어 보안, localhost 외부 위협, 금액/시간/동시성 경계값, 그리고 계층 간 연쇄 공격 시나리오를 정의하여 보안 테스트의 완전성을 확보한다.
Output: `docs/v0.4/46-keystore-external-security-scenarios.md` (SEC-04), `docs/v0.4/47-boundary-value-chain-scenarios.md` (SEC-05 + E2E chains)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-security-test-scenarios/15-CONTEXT.md
@.planning/phases/15-security-test-scenarios/15-RESEARCH.md

# Phase 14 outputs
@docs/v0.4/41-test-levels-matrix-coverage.md
@docs/v0.4/42-mock-boundaries-interfaces-contracts.md

# 키스토어 원본 설계 문서
@.planning/deliverables/26-keystore-spec.md

# 경계값 수치 원본
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/36-killswitch-autostop-evm.md

# 에러 코드 SSoT
@.planning/deliverables/45-enum-unified-mapping.md

# Plan 01, 02 산출물 참조 (연쇄 체인에서 개별 시나리오 번호 참조)
@.planning/phases/15-security-test-scenarios/15-01-SUMMARY.md
@.planning/phases/15-security-test-scenarios/15-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 키스토어 보안 + 외부 위협 시나리오 정의 (SEC-04)</name>
  <files>docs/v0.4/46-keystore-external-security-scenarios.md</files>
  <action>
키스토어 보안 및 외부 위협 시나리오 문서를 생성한다.

**문서 헤더:**
- 제목: 키스토어 보안 및 외부 위협 시나리오
- 요구사항: SEC-04
- 관련 설계 문서: 26-keystore-spec.md, 29-api-framework-design.md

**키스토어 보안 시나리오 6건:**

1. SEC-04-01: 잠금 상태에서 서명 시도 (Critical)
   - 테스트 레벨: Unit
   - Mock: MockKeyStore
   - Given: keyStore.lock() 호출 후. When: sign(agentId, message). Then: KEYSTORE_NOT_UNLOCKED

2. SEC-04-02: authTag 변조 탐지 (Critical)
   - 테스트 레벨: Integration (실제 파일시스템 + 암호화 라이브러리 필요)
   - Given: 정상 키스토어 파일에서 authTag 1바이트 변경. When: unlock(password). Then: KEYSTORE_CORRUPTED (AES-256-GCM 인증 실패)

3. SEC-04-03: 잘못된 마스터 패스워드 (High)
   - 테스트 레벨: Integration (실제 Argon2id 파생 필요)
   - Given: 올바른 패스워드 = "correct". When: unlock("wrong"). Then: KEYSTORE_WRONG_PASSWORD

4. SEC-04-04: 키스토어 파일 경로 순회 (High)
   - 테스트 레벨: Unit
   - Given: agentId = "../../etc/passwd". When: 키스토어 파일 경로 생성. Then: 경로 순회 차단 (agentId 검증)

5. SEC-04-05: sodium_memzero 메모리 클리어 검증 (High)
   - 테스트 레벨: Unit
   - Given: unlock 후 키가 메모리에 로드됨. When: lock() 호출. Then: 이전 키 Buffer 참조가 0으로 채워져 있음 확인
   - 참고: sodium_memzero는 C++ 바인딩이므로 Unit에서는 tweetnacl 기반 MockKeyStore로 제로화 동작만 검증

6. SEC-04-06: 존재하지 않는 에이전트 키 접근 (Medium)
   - 테스트 레벨: Unit
   - Given: 등록된 에이전트 = ["agent-001"]. When: getPublicKey("agent-999"). Then: AGENT_NOT_FOUND

**외부 위협 시나리오 4건 (Claude 재량 -- localhost 아키텍처에 맞는 수준):**

7. SEC-04-EX-01: Host header 변조 (High)
   - 테스트 레벨: Integration (Hono test client)
   - Given: hostGuard 미들웨어 활성화. When: Host: "evil.com" 또는 X-Forwarded-Host: "attacker.com". Then: 403 FORBIDDEN
   - hostGuard가 127.0.0.1 / localhost만 허용하는지 확인

8. SEC-04-EX-02: 파일시스템 접근 -- 키스토어 직접 읽기 (High)
   - 테스트 레벨: Unit (파일 권한 검증)
   - Given: ~/.waiaas/keystore/ 디렉토리. When: 파일 권한 확인. Then: 0700 (Owner만 접근). 다른 사용자 읽기 시도 -> Permission denied
   - 참고: 이 시나리오는 파일 퍼미션이 올바르게 설정되는지 확인하는 방어적 테스트

9. SEC-04-EX-03: config.toml JWT secret 노출 (High)
   - 테스트 레벨: Unit
   - Given: config.toml에 jwt_secret 존재. When: /health 또는 /doc 등 공개 엔드포인트 응답 검사. Then: 응답에 secret이 노출되지 않음
   - config.toml 파일 권한도 0600 확인

10. SEC-04-EX-04: Rate Limit 우회 -- 다중 세션 글로벌 한도 소진 (Medium)
    - 테스트 레벨: Integration
    - Given: 글로벌 Rate Limit = 100 req/min. When: 3개 세션에서 각 40 req. Then: 글로벌 한도 초과 시 429 TOO_MANY_REQUESTS

**시나리오 우선순위 요약 표** 포함

**주의사항:**
- 키스토어 Integration 테스트(02, 03)는 실제 sodium-native/argon2 바인딩이 필요하므로 테스트 레벨 명확히 구분
- 외부 위협은 localhost 전용 아키텍처에 맞는 범위로 제한 (DDoS, TLS, DNS, 브라우저 공격 제외)
  </action>
  <verify>
1. SEC-04-01 ~ SEC-04-06 키스토어 시나리오 6건 존재
2. SEC-04-EX-01 ~ SEC-04-EX-04 외부 위협 시나리오 4건 존재
3. 파일 변조(02), 틀린 패스워드(03), 파일 권한(EX-02), 메모리 잔존(05) 4가지가 요구사항에 명시된 대로 포함
4. 각 시나리오에 Given-When-Then + Mock 참조 + 우선순위 포함
  </verify>
  <done>
SEC-04 요구사항 충족: 키스토어 보안 시나리오 6건(>= 4건 요구)이 파일 변조/틀린 패스워드/파일 권한/메모리 잔존을 포함하며, 외부 위협 4건이 추가로 정의되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 경계값 테스트 + E2E 연쇄 공격 체인 정의 (SEC-05)</name>
  <files>docs/v0.4/47-boundary-value-chain-scenarios.md</files>
  <action>
경계값 테스트 케이스와 E2E 연쇄 공격 체인 문서를 생성한다.

**문서 헤더:**
- 제목: 경계값 테스트 케이스 및 E2E 연쇄 공격 체인
- 요구사항: SEC-05
- 관련 설계 문서: 33-time-lock, 30-session-token, 36-killswitch, 31-solana-adapter

**Part 1: 경계값 테스트 케이스**

금액 경계 테스트 -- 4-tier SPENDING_LIMIT (표 형식, RESEARCH에서 직접 사용):

NOTE: CONTEXT.md에서는 "0.1/1/10 SOL"이라고 기술했지만, 실제 설계 문서(33-time-lock)의 기본 정책은 1/10/50 SOL이다. 테스트에서는 정책 설정값 기반 +/-1 lamport 패턴을 사용하므로, 경계값 표에 두 가지를 모두 명시한다:
- 기본 정책 기준(1/10/50 SOL): 메인 표
- 사용자 커스텀 정책 기준(0.1/1/10 SOL): 보조 표 -- CONTEXT.md에서 언급한 값으로 동일 +/-1 패턴 적용

| 경계 | -1 lamport | 정확히 | +1 lamport | 기대 티어 변화 |
|------|-----------|--------|-----------|--------------|
| INSTANT/NOTIFY (1 SOL) | 999_999_999 | 1_000_000_000 | 1_000_000_001 | INSTANT->INSTANT->NOTIFY |
| NOTIFY/DELAY (10 SOL) | 9_999_999_999 | 10_000_000_000 | 10_000_000_001 | NOTIFY->NOTIFY->DELAY |
| DELAY/APPROVAL (50 SOL) | 49_999_999_999 | 50_000_000_000 | 50_000_000_001 | DELAY->DELAY->APPROVAL |

보조 표 (커스텀 정책 0.1/1/10 SOL):
| 경계 | -1 lamport | 정확히 | +1 lamport | 기대 티어 변화 |
|------|-----------|--------|-----------|--------------|
| INSTANT/NOTIFY (0.1 SOL) | 99_999_999 | 100_000_000 | 100_000_001 | INSTANT->INSTANT->NOTIFY |
| NOTIFY/DELAY (1 SOL) | 999_999_999 | 1_000_000_000 | 1_000_000_001 | NOTIFY->NOTIFY->DELAY |
| DELAY/APPROVAL (10 SOL) | 9_999_999_999 | 10_000_000_000 | 10_000_000_001 | DELAY->DELAY->APPROVAL |

시간 경계 테스트 (표 형식, RESEARCH에서 직접 사용):

| 경계 | 기준값 | -1초 | 정확히 | +1초 | 방어 지점 |
|------|--------|------|--------|------|----------|
| JWT exp | 세션 만료 시각 | 유효 | 유효(정확히 만료 시각) | 만료 거부 | sessionAuth Stage 1 |
| DELAY 쿨다운 | 15분 (900초) | 실행 차단 | 실행 허용 | 실행 허용 | DelayQueueWorker |
| APPROVAL 타임아웃 | 1시간 (3600초) | 승인 가능 | 만료 | 만료 | ApprovalTimeoutWorker |
| 세션 최대 수명 | 7일 (604800초) | 발급 성공 | 발급 성공 | 발급 거부 | Zod expiresIn max |
| 세션 최소 수명 | 5분 (300초) | 발급 거부 | 발급 성공 | 발급 성공 | Zod expiresIn min |
| Blockhash 만료 | 50초 | 유효 | 경계 | 만료 | waitForConfirmation |
| Nonce TTL | 5분 (300초) | 유효 | 만료 | 만료 | verifyAndConsumeNonce |
| ownerAuth timestamp | 5분 (300초) | 유효 | 만료 | 만료 | ownerAuth Step 2 |

각 시간 경계에 대해 FakeClock 기반 Given-When-Then을 기술한다.

TOCTOU 동시성 경계 테스트 (표 + Given-When-Then):

| 시나리오 | 설정 | 동시 요청 | 기대 결과 |
|---------|------|----------|----------|
| reserved_amount 경합 | maxTotalAmount=10 SOL, 현재 8 SOL | 2개 동시 각 3 SOL | 1개 성공, 1개 거부 |
| 세션 usageStats 경합 | maxTransactions=10, 현재 9 | 2개 동시 요청 | 1개 성공, 1개 거부 |
| BEGIN IMMEDIATE 직렬화 | 임의 동시 트랜잭션 | N개 동시 | 모든 요청 직렬 처리 확인 |

**세션 한도 경계 (+/-1 패턴):**
- maxAmountPerTx: limit-1 허용, limit 허용, limit+1 거부
- maxTotalAmount: 남은 한도-1 허용, 남은 한도 허용, 남은 한도+1 거부
- maxTransactions: max-1회 허용, max회 허용, max+1회 거부

**Part 2: E2E 연쇄 공격 체인 (3-5개)**

RESEARCH에서 추천한 5개 체인을 상세 정의한다. 각 체인은 "공격자 관점 스토리"로 서술:

**체인 1: 세션 한도 소진 체인** (가장 흔한 악의적 에이전트 패턴)
- 공격자: 악의적 AI 에이전트 (유효 세션 보유)
- 흐름: 유효 토큰 -> 반복 소액 거래 -> 누적 한도 도달 -> SESSION_LIMIT_TOTAL 차단 (Layer 1에서 차단)
- 참조: SEC-01-06
- Given-When-Then: FakeClock + MockChainAdapter, 한도 근접 설정, 마지막 거래에서 거부
- 결과: 성공적 방어 (Layer 1에서 차단)

**체인 2: 정책 우회 + TOCTOU 체인** (정교한 동시성 공격)
- 흐름: 2개 세션 동시 요청 -> reserved_amount 경합 -> BEGIN IMMEDIATE 직렬화 -> 1개만 성공 (Layer 2에서 차단)
- 참조: SEC-02-01
- 테스트 레벨: Integration (실제 SQLite)
- 결과: 성공적 방어 (Layer 2 TOCTOU 방어)

**체인 3: 금액 에스컬레이션 -> Kill Switch 체인** (3계층 전체 관통)
- 흐름: 소액(INSTANT) 성공 -> 중액(DELAY) 15분 대기 -> 대액(APPROVAL) 요청 -> Owner 미승인 -> AutoStop(velocity 규칙) 트리거 -> Kill Switch ACTIVATED -> 모든 API 차단
- 참조: SEC-01-05, SEC-02-02, SEC-02-06, SEC-03-04
- 결과: Layer 1 통과 -> Layer 2 에스컬레이션 -> Layer 3 발동

**체인 4: 세션 탈취 + 복구 체인** (공격-방어-복구 완전 E2E)
- 흐름: Agent B가 Agent A의 토큰 사용 시도 -> agentId 불일치 감지 -> 보안 이벤트 -> AutoStop 트리거 -> Kill Switch 발동 -> Owner dual-auth 복구 -> NORMAL 복귀 -> 이전 토큰 재사용 시도 -> SESSION_REVOKED
- 참조: SEC-01-04, SEC-03-01, SEC-03-03, SEC-03-06
- 결과: 공격 탐지 -> 비상 정지 -> 복구 -> 정상화 (완전 E2E)

**체인 5: 시간 기반 우회 + 연속 실패 체인** (시간 관련 공격 집중)
- 흐름: JWT 만료 직전 요청 성공 -> 만료 후 재시도 거부 -> 새 세션 발급 -> DELAY 쿨다운 우회 시도 -> 차단 -> 연속 실패 3회 -> AutoStop 트리거
- 참조: SEC-01-02, SEC-02-06, SEC-03-04
- FakeClock이 핵심 제어 수단
- 결과: Layer 1 시간 차단 -> Layer 2 시간 차단 -> Layer 3 AutoStop

각 체인에 다음을 포함:
- 체인 개요 (1-2줄)
- 단계별 "공격자 행동 / 시스템 반응" 교대 서술 (CONTEXT.md의 "공격자 관점 스토리" 요구사항)
- 차단점 (어느 Layer에서 차단되는지)
- Given-When-Then (전체 체인에 대한)
- Mock 설정 (FakeClock, MockChainAdapter, FakeOwnerSigner 등)
- 참조 시나리오 번호 (SEC-01-XX, SEC-02-XX, SEC-03-XX)

**시나리오 전체 통계 요약 표:**
모든 5개 문서(43~47)의 시나리오 수, Critical/High/Medium 분포, 테스트 레벨 분포를 정리한다.

**주의사항:**
- 금액 경계에서 설계 문서 기본값(1/10/50 SOL)과 CONTEXT.md 언급값(0.1/1/10 SOL) 차이를 명시
- 모든 금액은 lamport 단위 BigInt 문자열
- TOCTOU 경계 테스트는 Integration 레벨
- 연쇄 체인은 개별 시나리오를 SEC-XX-XX로 참조하되, 전체 흐름을 새로 기술
  </action>
  <verify>
1. 금액 경계 표 (기본 정책 3행 + 커스텀 정책 3행) 존재
2. 시간 경계 표 8행 (JWT exp, DELAY, APPROVAL, 세션 최대/최소, blockhash, nonce TTL, ownerAuth) 존재
3. TOCTOU 동시성 경계 표 3행 존재
4. 세션 한도 +/-1 패턴 포함
5. E2E 연쇄 체인 5건이 각각 단계별 서술 + Given-When-Then + 참조 시나리오 번호를 포함
6. 체인 4에 복구 흐름(dual-auth 복구 -> 정상 복귀)이 포함
7. 체인 3에 3계층 전체 관통이 포함
8. 전체 통계 요약 표 존재
  </verify>
  <done>
SEC-05 요구사항 충족: 금액 경계(4-tier +/-1), 시간 경계(8가지), TOCTOU 동시성 경계가 표로 정리되어 있고, 5개 E2E 연쇄 공격 체인이 성공/실패 양쪽과 복구 흐름을 포함하여 정의되어 있다. Phase 15 전체 보안 테스트 시나리오의 통계 요약이 완성되어 있다.
  </done>
</task>

</tasks>

<verification>
- docs/v0.4/46-keystore-external-security-scenarios.md: 100줄 이상, SEC-04-01~06 + SEC-04-EX-01~04
- docs/v0.4/47-boundary-value-chain-scenarios.md: 150줄 이상, 경계값 표 3종 + 연쇄 체인 5건
- 경계값 표에 lamport 단위 BigInt 문자열 사용
- 연쇄 체인이 Layer 1-2-3을 참조하며 SEC-XX-XX 번호로 연결
- 전체 Phase 15 통계 요약 포함
</verification>

<success_criteria>
키스토어 6건 + 외부 위협 4건 + 경계값 표 + 연쇄 체인 5건이 테스트 케이스 수준으로 정의되어, Phase 15 전체 보안 테스트 시나리오(SEC-01~05)가 완성된 상태
</success_criteria>

<output>
After completion, create `.planning/phases/15-security-test-scenarios/15-03-SUMMARY.md`
</output>
