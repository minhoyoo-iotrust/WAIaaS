---
phase: 15-security-test-scenarios
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/v0.4/43-layer1-session-auth-attacks.md
autonomous: true

must_haves:
  truths:
    - "Layer 1 세션 인증 공격 시나리오 9개 이상이 각각 공격 방법/기대 방어/테스트 레벨과 함께 정의되어 있다"
    - "모든 시나리오에 Given-When-Then이 있고, Given절에 Mock 설정(FakeClock, FakeOwnerSigner 등)이 명시되어 있다"
    - "각 시나리오에 Critical/High/Medium 우선순위 태그가 부여되어 있다"
    - "주요 공격자가 '악의적 AI 에이전트'로 설정되어 있다"
  artifacts:
    - path: "docs/v0.4/43-layer1-session-auth-attacks.md"
      provides: "Layer 1 세션 인증 공격 시나리오 전체"
      contains: "SEC-01"
      min_lines: 150
  key_links:
    - from: "docs/v0.4/43-layer1-session-auth-attacks.md"
      to: "docs/v0.4/42-mock-boundaries-interfaces-contracts.md"
      via: "Given절 Mock 참조"
      pattern: "FakeClock|FakeOwnerSigner|MockChainAdapter"
    - from: "docs/v0.4/43-layer1-session-auth-attacks.md"
      to: "docs/v0.4/41-test-levels-matrix-coverage.md"
      via: "테스트 레벨 참조"
      pattern: "Unit|Integration|Security"
    - from: "docs/v0.4/43-layer1-session-auth-attacks.md"
      to: ".planning/deliverables/30-session-token-protocol.md"
      via: "공격 벡터 원본 참조"
      pattern: "sessionAuth|jwtVerify|validateSessionConstraints"
---

<objective>
Layer 1 세션 인증 계층의 모든 공격 시나리오를 Given-When-Then 테스트 케이스 수준으로 정의한다.

Purpose: WAIaaS의 첫 번째 방어선인 JWT 세션 인증(sessionAuth 2-stage)이 올바르게 동작하는지를 검증하는 공격 시나리오를 문서화하여, 구현 단계에서 Security 테스트를 바로 작성할 수 있게 한다.
Output: `docs/v0.4/43-layer1-session-auth-attacks.md` -- SEC-01 요구사항을 충족하는 Layer 1 공격 시나리오 문서
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-security-test-scenarios/15-CONTEXT.md
@.planning/phases/15-security-test-scenarios/15-RESEARCH.md

# Phase 14 outputs (Mock 경계 + 테스트 레벨 정의)
@docs/v0.4/41-test-levels-matrix-coverage.md
@docs/v0.4/42-mock-boundaries-interfaces-contracts.md

# 공격 벡터 원본 설계 문서
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/34-owner-wallet-connection.md

# 에러 코드 SSoT
@.planning/deliverables/45-enum-unified-mapping.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Layer 1 세션 인증 공격 시나리오 12건 정의 (SEC-01)</name>
  <files>docs/v0.4/43-layer1-session-auth-attacks.md</files>
  <action>
Layer 1 세션 인증 공격 시나리오 문서를 생성한다. 다음 구조를 따른다:

**문서 헤더:**
- 제목: Layer 1: 세션 인증 공격 시나리오
- 요구사항: SEC-01
- 관련 설계 문서: 30-session-token-protocol.md, 34-owner-wallet-connection.md
- Phase 14 참조: 41-test-levels-matrix-coverage.md (Security 레벨), 42-mock-boundaries-interfaces-contracts.md (FakeClock, FakeOwnerSigner)
- 위협 모델 요약: 주요 공격자 = 악의적 AI 에이전트 (유효 세션 보유, 범위 초과 시도)

**시나리오 12건** -- 15-RESEARCH.md의 공격 벡터 카탈로그를 기반으로, 각각 아래 템플릿을 따른다:

```
### SEC-01-NN: [공격명]

**우선순위:** Critical | High | Medium
**공격자:** 악의적 AI 에이전트 | 외부 공격자
**테스트 레벨:** Unit | Integration | Security
**공격 대상:** [구체적 컴포넌트/메서드]

#### 공격 단계
1. [공격자 행동 단계별 기술]

#### 기대 방어
- [시스템이 취해야 할 방어 동작]

#### Given-When-Then

Given: [Mock 설정 - Phase 14 Mock 구현체 명시. 예: FakeClock.setTime(), MockDb 설정 등]
When:  [공격 행위 - 구체적 메서드 호출 또는 API 요청]
Then:  [기대 결과 - 에러 코드(45-enum 참조), HTTP 상태, 상태 변화]

**Phase 14 Mock 참조:** [사용할 Mock 클래스 목록]
```

**12건 목록 (RESEARCH에서 식별됨, 정확히 이 순서와 내용으로):**

1. SEC-01-01: JWT 서명 위조 (Critical) -- 다른 secret으로 서명한 JWT, sessionAuth Stage 1 jwtVerify 거부
2. SEC-01-02: JWT 만료 우회 (Critical) -- FakeClock으로 exp+1초 설정, AUTH_TOKEN_EXPIRED
3. SEC-01-03: 폐기된 세션 사용 (Critical) -- revokedAt 설정된 세션 토큰, sessionAuth Stage 2에서 SESSION_REVOKED
4. SEC-01-04: 타 에이전트 세션 탈취 (Critical) -- Agent A 토큰으로 Agent B 리소스 접근, agentId 불일치 거부
5. SEC-01-05: 세션 제약 초과 - 단건 한도 (High) -- maxAmountPerTx 초과 금액 전송 시도, SESSION_LIMIT_PER_TX
6. SEC-01-06: 세션 제약 초과 - 누적 한도 (High) -- maxTotalAmount 근접 후 초과, SESSION_LIMIT_TOTAL
7. SEC-01-07: 세션 제약 초과 - 거래 횟수 (High) -- maxTransactions = max-1에서 추가 요청, SESSION_LIMIT_TX_COUNT
8. SEC-01-08: 세션 제약 초과 - 허용 작업 (High) -- allowedOperations에 없는 TRANSFER 시도, SESSION_OPERATION_NOT_ALLOWED
9. SEC-01-09: 세션 제약 초과 - 허용 주소 (High) -- allowedDestinations 화이트리스트에 없는 주소, SESSION_DESTINATION_NOT_ALLOWED
10. SEC-01-10: Nonce Replay 공격 (High) -- 동일 nonce 재사용, INVALID_NONCE (LRU 캐시 기반 탐지)
11. SEC-01-11: 토큰 접두사 변조 (Medium) -- wai_sess_ 접두사 없는 토큰, AUTH_TOKEN_INVALID
12. SEC-01-12: Authorization 헤더 누락 (Medium) -- 헤더 없이 보호 엔드포인트 접근, AUTH_TOKEN_MISSING

**추가 섹션:**
- "ownerAuth 공격 벡터 참조" 섹션: 34-owner-wallet-connection.md 기반 ownerAuth 8단계 공격 벡터 8건을 요약 표로 포함 (SEC-01-OA-01 ~ SEC-01-OA-08). 이들은 Layer 1과 Layer 3 교차점이므로 여기서 정의하되, Kill Switch 관련 부분은 45-layer3에서 상세화한다고 명시
- "인증 제외 경로 검증" 섹션: /health, /doc, /v1/auth/nonce, POST /v1/sessions에 대한 검증 시나리오 (인증 없이 접근 가능 확인 + 다른 경로는 인증 필수 확인)
- "시나리오 우선순위 요약" 표: 전체 시나리오를 Critical/High/Medium으로 분류한 요약

**주의사항:**
- 에러 코드는 45-enum-unified-mapping.md SSoT에서 정확히 가져온다
- Given절의 Mock 설정은 42-mock-boundaries-interfaces-contracts.md의 FakeClock, FakeOwnerSigner 스펙을 참조한다
- 금액은 lamport 단위 문자열("1000000000")로 BigInt 비교를 명시한다
- 우선순위 기준: Critical = 자금 직접 유출, High = 자금 유출 경로 열림, Medium = 정보 노출/가용성 저하
  </action>
  <verify>
문서가 존재하고 다음을 포함하는지 확인:
1. SEC-01-01 ~ SEC-01-12 시나리오 12건이 모두 존재
2. 각 시나리오에 우선순위, 테스트 레벨, Given-When-Then이 포함
3. ownerAuth 공격 벡터 8건 요약 표 존재
4. 인증 제외 경로 검증 섹션 존재
5. Phase 14 Mock 참조(FakeClock, FakeOwnerSigner 등)가 Given절에 명시
  </verify>
  <done>
SEC-01 요구사항 충족: Layer 1 세션 인증 공격 시나리오 12건(>= 9건 요구)이 각각 공격 방법/기대 방어 동작/테스트 레벨/Given-When-Then/Mock 참조/우선순위와 함께 정의되어 있다. ownerAuth 8건 포함 시 총 20건의 Layer 1 관련 공격 벡터가 문서화되어 있다.
  </done>
</task>

</tasks>

<verification>
- docs/v0.4/43-layer1-session-auth-attacks.md 파일이 150줄 이상
- SEC-01-01 ~ SEC-01-12 시나리오 번호가 모두 존재
- "Critical" 시나리오 4건(01~04), "High" 시나리오 6건(05~10), "Medium" 시나리오 2건(11~12)
- Given절에 FakeClock, FakeOwnerSigner 등 Phase 14 Mock 구현체가 명시
- 에러 코드가 45-enum-unified-mapping.md SSoT와 일치
</verification>

<success_criteria>
Layer 1 세션 인증 공격 시나리오 12건 + ownerAuth 8건 요약이 테스트 케이스 수준으로 정의되어, 구현 시 Security 테스트를 바로 작성할 수 있는 상태
</success_criteria>

<output>
After completion, create `.planning/phases/15-security-test-scenarios/15-01-SUMMARY.md`
</output>
