---
phase: 109-db-migration-environment-ssot
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/enums/chain.ts
  - packages/core/src/enums/index.ts
  - packages/core/src/__tests__/environment.test.ts
autonomous: true

must_haves:
  truths:
    - "ENVIRONMENT_TYPES SSoT 배열이 ['testnet', 'mainnet'] 2값으로 정의되어 있다"
    - "EnvironmentTypeEnum Zod 스키마가 'testnet'/'mainnet'만 수용하고 잘못된 값을 거부한다"
    - "getNetworksForEnvironment()가 chain+env 조합에 대해 올바른 네트워크 목록을 반환한다"
    - "getDefaultNetwork()가 chain+env 조합에 대해 올바른 기본 네트워크를 반환한다"
    - "deriveEnvironment()가 13개 NetworkType 모두에 대해 올바른 환경을 역파생한다"
    - "validateNetworkEnvironment()가 유효 조합은 통과시키고 불일치 시 throw한다"
    - "ENVIRONMENT_NETWORK_MAP이 13개 NETWORK_TYPES를 빠짐없이 커버한다"
  artifacts:
    - path: "packages/core/src/enums/chain.ts"
      provides: "EnvironmentType SSoT + 매핑 상수 + 4개 함수"
      exports: ["ENVIRONMENT_TYPES", "EnvironmentType", "EnvironmentTypeEnum", "ENVIRONMENT_NETWORK_MAP", "ENVIRONMENT_DEFAULT_NETWORK", "getNetworksForEnvironment", "getDefaultNetwork", "deriveEnvironment", "validateNetworkEnvironment"]
    - path: "packages/core/src/enums/index.ts"
      provides: "Barrel export 추가"
      contains: "ENVIRONMENT_TYPES"
    - path: "packages/core/src/__tests__/environment.test.ts"
      provides: "환경 모델 함수 4개 + SSoT 검증 테스트"
      min_lines: 80
  key_links:
    - from: "packages/core/src/enums/chain.ts"
      to: "packages/core/src/enums/index.ts"
      via: "barrel re-export"
      pattern: "export.*ENVIRONMENT_TYPES"
    - from: "packages/core/src/enums/chain.ts"
      to: "NETWORK_TYPES constant"
      via: "ENVIRONMENT_NETWORK_MAP covers all 13 values"
      pattern: "ENVIRONMENT_NETWORK_MAP"
---

<objective>
EnvironmentType Zod SSoT와 환경-네트워크 매핑 함수 4개를 TDD로 구현한다.

Purpose: Phase 109-02 DB 마이그레이션과 Phase 110+ 스키마/파이프라인/API 전환의 기반이 되는 환경 데이터 모델 SSoT를 확립한다. 이 SSoT에서 TypeScript 타입, Zod 스키마, DB CHECK 제약이 모두 파생된다.

Output: `packages/core/src/enums/chain.ts`에 EnvironmentType SSoT + 매핑 상수 2개 + 순수 함수 4개가 추가되고, barrel export가 업데이트되며, 테스트가 통과하는 상태.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@docs/68-environment-model-design.md -- 섹션 1~3: EnvironmentType SSoT 정의, 매핑 테이블, 함수 4개 시그니처/의사코드/입출력 예시
@packages/core/src/enums/chain.ts -- 현재 코드: CHAIN_TYPES, NETWORK_TYPES, validateChainNetwork 패턴 참조
@packages/core/src/enums/index.ts -- 현재 barrel export: 새 exports 추가 위치
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- 환경 모델 테스트 작성 (실패하는 테스트)</name>
  <files>packages/core/src/__tests__/environment.test.ts</files>
  <action>
docs/68 섹션 1~3의 입출력 예시를 기반으로 테스트를 작성한다. 아직 구현이 없으므로 모든 테스트가 FAIL해야 한다.

테스트 파일 `packages/core/src/__tests__/environment.test.ts` 생성:

**1. ENVIRONMENT_TYPES SSoT 검증 (3개 테스트):**
- `ENVIRONMENT_TYPES`가 정확히 `['testnet', 'mainnet']`인지 확인
- `EnvironmentTypeEnum`이 'testnet' parse 성공, 'staging' parse 실패
- `EnvironmentType` 타입이 존재하는지 (타입 레벨 -- 컴파일로 검증)

**2. ENVIRONMENT_NETWORK_MAP 전수 커버리지 (2개 테스트):**
- MAP의 모든 값을 flat하면 NETWORK_TYPES 13개와 정확히 일치 (누락/중복 없음)
- 4개 key(`solana:mainnet`, `solana:testnet`, `ethereum:mainnet`, `ethereum:testnet`)가 모두 존재

**3. getNetworksForEnvironment() (4개 테스트):**
- `('solana', 'mainnet')` -> `['mainnet']`
- `('solana', 'testnet')` -> `['devnet', 'testnet']`
- `('ethereum', 'mainnet')` -> 5개 EVM mainnet 네트워크
- `('ethereum', 'testnet')` -> 5개 EVM testnet 네트워크

**4. getDefaultNetwork() (4개 테스트):**
- `('solana', 'mainnet')` -> `'mainnet'`
- `('solana', 'testnet')` -> `'devnet'` (설계 결정 ENV-04)
- `('ethereum', 'mainnet')` -> `'ethereum-mainnet'`
- `('ethereum', 'testnet')` -> `'ethereum-sepolia'`

**5. deriveEnvironment() (13개 값 전수 테스트):**
- 6개 mainnet 네트워크: `'mainnet'`, `'ethereum-mainnet'`, `'polygon-mainnet'`, `'arbitrum-mainnet'`, `'optimism-mainnet'`, `'base-mainnet'` -> 모두 `'mainnet'`
- 7개 testnet 네트워크: `'devnet'`, `'testnet'`, `'ethereum-sepolia'`, `'polygon-amoy'`, `'arbitrum-sepolia'`, `'optimism-sepolia'`, `'base-sepolia'` -> 모두 `'testnet'`

**6. validateNetworkEnvironment() (5개 테스트):**
- 유효: `('solana', 'mainnet', 'mainnet')` -> no throw
- 유효: `('ethereum', 'testnet', 'polygon-amoy')` -> no throw
- 불일치: `('solana', 'mainnet', 'devnet')` -> throw Error
- 불일치: `('ethereum', 'testnet', 'ethereum-mainnet')` -> throw Error
- 크로스체인: `('solana', 'mainnet', 'ethereum-mainnet')` -> throw Error

Import path: `from '../enums/chain.js'` (직접 import, barrel 통해서도 테스트 가능하지만 직접이 명확)

테스트 실행 확인: `pnpm --filter @waiaas/core test -- --run environment.test` (FAIL 확인)
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core test -- --run environment.test 2>&1` 실행 결과에서 import 에러 또는 test failure 확인 (아직 구현이 없으므로 FAIL이 정상)
  </verify>
  <done>environment.test.ts 파일이 존재하고, 테스트 실행 시 FAIL한다 (RED 상태)</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- EnvironmentType SSoT + 매핑 상수 + 함수 4개 구현 + barrel export 업데이트</name>
  <files>packages/core/src/enums/chain.ts, packages/core/src/enums/index.ts</files>
  <action>
docs/68 섹션 1~3의 의사코드를 그대로 구현한다.

**chain.ts에 추가할 코드 (기존 validateChainNetwork 뒤에 배치):**

1. **ENVIRONMENT_TYPES SSoT (Step 1~3):**
```typescript
export const ENVIRONMENT_TYPES = ['testnet', 'mainnet'] as const;
export type EnvironmentType = (typeof ENVIRONMENT_TYPES)[number];
export const EnvironmentTypeEnum = z.enum(ENVIRONMENT_TYPES);
```

2. **ENVIRONMENT_NETWORK_MAP 상수:**
```typescript
export const ENVIRONMENT_NETWORK_MAP: Record<
  `${ChainType}:${EnvironmentType}`,
  readonly NetworkType[]
> = {
  'solana:mainnet': ['mainnet'],
  'solana:testnet': ['devnet', 'testnet'],
  'ethereum:mainnet': ['ethereum-mainnet', 'polygon-mainnet', 'arbitrum-mainnet', 'optimism-mainnet', 'base-mainnet'],
  'ethereum:testnet': ['ethereum-sepolia', 'polygon-amoy', 'arbitrum-sepolia', 'optimism-sepolia', 'base-sepolia'],
} as const;
```

3. **ENVIRONMENT_DEFAULT_NETWORK 상수:**
```typescript
export const ENVIRONMENT_DEFAULT_NETWORK: Record<
  `${ChainType}:${EnvironmentType}`,
  NetworkType
> = {
  'solana:mainnet': 'mainnet',
  'solana:testnet': 'devnet',
  'ethereum:mainnet': 'ethereum-mainnet',
  'ethereum:testnet': 'ethereum-sepolia',
} as const;
```

4. **getNetworksForEnvironment() 함수:**
```typescript
export function getNetworksForEnvironment(chain: ChainType, env: EnvironmentType): readonly NetworkType[] {
  const key = `${chain}:${env}` as const;
  return ENVIRONMENT_NETWORK_MAP[key];
}
```

5. **getDefaultNetwork() 함수:**
```typescript
export function getDefaultNetwork(chain: ChainType, env: EnvironmentType): NetworkType {
  const key = `${chain}:${env}` as const;
  return ENVIRONMENT_DEFAULT_NETWORK[key];
}
```

6. **deriveEnvironment() 함수:**
```typescript
const MAINNET_NETWORKS: readonly NetworkType[] = [
  'mainnet', 'ethereum-mainnet', 'polygon-mainnet',
  'arbitrum-mainnet', 'optimism-mainnet', 'base-mainnet',
];

export function deriveEnvironment(network: NetworkType): EnvironmentType {
  if ((MAINNET_NETWORKS as readonly string[]).includes(network)) {
    return 'mainnet';
  }
  return 'testnet';
}
```

7. **validateNetworkEnvironment() 함수:**
```typescript
export function validateNetworkEnvironment(
  chain: ChainType, env: EnvironmentType, network: NetworkType,
): void {
  const allowed = getNetworksForEnvironment(chain, env);
  if (!(allowed as readonly string[]).includes(network)) {
    throw new Error(
      `Invalid network '${network}' for chain '${chain}' in environment '${env}'. Valid: ${allowed.join(', ')}`,
    );
  }
}
```

**index.ts barrel export에 추가:**
```typescript
export {
  // ... 기존 exports
  ENVIRONMENT_TYPES,
  type EnvironmentType,
  EnvironmentTypeEnum,
  ENVIRONMENT_NETWORK_MAP,
  ENVIRONMENT_DEFAULT_NETWORK,
  getNetworksForEnvironment,
  getDefaultNetwork,
  deriveEnvironment,
  validateNetworkEnvironment,
} from './chain.js';
```

기존 chain.ts exports 블록에 병합한다 (별도 export 블록 추가 아님).

`pnpm --filter @waiaas/core build` 실행하여 TypeScript 컴파일 확인.
`pnpm --filter @waiaas/core test -- --run environment.test` 실행하여 GREEN 확인.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build && pnpm --filter @waiaas/core test -- --run environment.test` 모든 테스트 PASS
  </verify>
  <done>
chain.ts에 ENVIRONMENT_TYPES/EnvironmentType/EnvironmentTypeEnum + ENVIRONMENT_NETWORK_MAP + ENVIRONMENT_DEFAULT_NETWORK + 4개 함수가 존재하고, index.ts에서 re-export되며, 모든 테스트가 GREEN이다.
기존 테스트 회귀 없음: `pnpm --filter @waiaas/core test -- --run` 전체 PASS.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core build` -- 타입 에러 없이 빌드 성공
2. `pnpm --filter @waiaas/core test -- --run` -- 기존 + 신규 테스트 모두 PASS
3. `packages/core/src/enums/chain.ts`에서 ENVIRONMENT_TYPES, EnvironmentType, EnvironmentTypeEnum, ENVIRONMENT_NETWORK_MAP, ENVIRONMENT_DEFAULT_NETWORK, getNetworksForEnvironment, getDefaultNetwork, deriveEnvironment, validateNetworkEnvironment 9개 export 존재
4. `packages/core/src/enums/index.ts`에서 9개 re-export 존재
5. ENVIRONMENT_NETWORK_MAP의 모든 값을 flat하면 NETWORK_TYPES 13개와 정확히 일치 (테스트로 검증)
</verification>

<success_criteria>
- EnvironmentType Zod SSoT 5단계 파생 체인 중 Step 1~3 완성 (TS 배열 -> Zod -> TS 타입)
- 환경-네트워크 매핑 함수 4개 동작 확인 (docs/68 입출력 예시 전수 검증)
- 기존 코드 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/109-db-migration-environment-ssot/109-01-SUMMARY.md`
</output>
