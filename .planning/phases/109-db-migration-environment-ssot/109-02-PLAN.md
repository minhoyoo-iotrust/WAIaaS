---
phase: 109-db-migration-environment-ssot
plan: 02
type: execute
wave: 2
depends_on: ["109-01"]
files_modified:
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/__tests__/migration-v6-v8.test.ts
autonomous: true

must_haves:
  truths:
    - "v6a 마이그레이션 실행 후 transactions 테이블에 network 컬럼이 존재하고, 기존 레코드가 wallets.network 값으로 채워져 있다"
    - "v6b 마이그레이션 실행 후 wallets 테이블이 environment + default_network 컬럼을 가지며, network 컬럼은 존재하지 않는다"
    - "v6b 실행 후 기존 wallets.network 값이 deriveEnvironment() 로직과 일치하는 environment 값으로 변환되어 있다"
    - "v6b 실행 후 기존 wallets.network 값이 default_network에 그대로 보존되어 있다"
    - "v8 마이그레이션 실행 후 policies 테이블에 nullable network 컬럼이 존재하고, 기존 정책의 network은 모두 NULL이다"
    - "pushSchema()로 생성한 새 DB와 v1~v8 마이그레이션을 순차 적용한 DB의 스키마가 동일하다"
    - "모든 마이그레이션 후 PRAGMA foreign_key_check가 빈 결과를 반환한다 (FK 무결성)"
    - "Drizzle ORM schema.ts가 wallets.environment + wallets.defaultNetwork + transactions.network + policies.network을 반영한다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v6a/v6b/v8 마이그레이션 3개 + pushSchema DDL/인덱스 동기화 + LATEST_SCHEMA_VERSION=8"
      contains: "version: 6"
    - path: "packages/daemon/src/infrastructure/database/schema.ts"
      provides: "Drizzle 스키마 환경 모델 전환"
      contains: "environment"
    - path: "packages/daemon/src/__tests__/migration-v6-v8.test.ts"
      provides: "마이그레이션 데이터 무결성 테스트"
      min_lines: 150
  key_links:
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "@waiaas/core ENVIRONMENT_TYPES"
      via: "import for inList(ENVIRONMENT_TYPES)"
      pattern: "ENVIRONMENT_TYPES"
    - from: "packages/daemon/src/infrastructure/database/schema.ts"
      to: "@waiaas/core ENVIRONMENT_TYPES"
      via: "import for buildCheckSql"
      pattern: "ENVIRONMENT_TYPES"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "LATEST_SCHEMA_VERSION"
      via: "version constant updated to 8"
      pattern: "LATEST_SCHEMA_VERSION = 8"
---

<objective>
DB 마이그레이션 v6a/v6b/v8을 구현하고, pushSchema DDL과 Drizzle 스키마를 동기화하여, 데이터 레이어가 환경 모델로 완전히 전환된 상태를 달성한다.

Purpose: 환경 모델(environment + default_network)을 DB 레벨에서 확립하여 Phase 110+의 스키마/파이프라인/API 전환이 가능한 상태를 만든다. 기존 데이터를 무손실로 변환하여 하위 호환성을 보장한다.

Output: migrate.ts에 v6a/v6b/v8 마이그레이션 3개가 추가되고, pushSchema DDL이 동기화되며, schema.ts가 새 컬럼을 반영하고, 마이그레이션 테스트가 통과하는 상태.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/109-db-migration-environment-ssot/109-01-SUMMARY.md -- Plan 01 결과: ENVIRONMENT_TYPES, ENVIRONMENT_NETWORK_MAP 등 SSoT 확인
@docs/69-db-migration-v6-design.md -- v6a/v6b 마이그레이션 상세 SQL, 12-step 재생성 절차, 검증 쿼리, 의사코드 전문
@docs/71-policy-engine-network-extension-design.md -- 섹션 6: v8 마이그레이션 상세 SQL, 의사코드
@docs/68-environment-model-design.md -- 부록 B: Drizzle 스키마 변경, 섹션 4: pushSchema DDL 동기화
@packages/daemon/src/infrastructure/database/migrate.ts -- 현재 코드: v2/v3/v4/v5 마이그레이션 패턴, inList(), pushSchema(), runMigrations()
@packages/daemon/src/infrastructure/database/schema.ts -- 현재 Drizzle 스키마: wallets.network, 인덱스, CHECK
@packages/daemon/src/__tests__/migration-runner.test.ts -- 기존 마이그레이션 테스트 패턴 참조
</context>

<tasks>

<task type="auto">
  <name>Task 1: migrate.ts -- v6a/v6b/v8 마이그레이션 구현 + pushSchema DDL 동기화</name>
  <files>packages/daemon/src/infrastructure/database/migrate.ts</files>
  <action>
docs/69와 docs/71의 의사코드를 기반으로 migrate.ts에 3개 마이그레이션을 추가하고, pushSchema DDL을 동기화한다.

**1. import 추가:**
기존 import에 `ENVIRONMENT_TYPES`를 추가한다:
```typescript
import {
  WALLET_STATUSES,
  CHAIN_TYPES,
  NETWORK_TYPES,
  ENVIRONMENT_TYPES,  // NEW
  TRANSACTION_STATUSES,
  TRANSACTION_TYPES,
  POLICY_TYPES,
  POLICY_TIERS,
  NOTIFICATION_LOG_STATUSES,
} from '@waiaas/core';
```

**2. LATEST_SCHEMA_VERSION 변경:**
```typescript
export const LATEST_SCHEMA_VERSION = 8;  // was 5
```

**3. getCreateTableStatements() DDL 동기화:**

wallets 테이블 DDL 변경:
- `network TEXT NOT NULL CHECK (network IN (${inList(NETWORK_TYPES)})),` 제거
- 그 위치에 다음 2줄 추가:
  ```
  environment TEXT NOT NULL CHECK (environment IN (${inList(ENVIRONMENT_TYPES)})),
  default_network TEXT CHECK (default_network IS NULL OR default_network IN (${inList(NETWORK_TYPES)})),
  ```

transactions 테이블 DDL 변경:
- `metadata TEXT` 뒤에 쉼표 추가하고 다음 줄 추가:
  ```
  network TEXT CHECK (network IS NULL OR network IN (${inList(NETWORK_TYPES)}))
  ```

policies 테이블 DDL 변경:
- `updated_at INTEGER NOT NULL` 줄 앞에 다음 줄 삽입 (updated_at 줄에 쉼표가 필요 없음 -- network이 먼저 와야 하므로 순서 조정):
  실제로는 docs/71 설계에 따라 network을 enabled 뒤, created_at 앞에 배치:
  ```
  enabled INTEGER NOT NULL DEFAULT 1,
  network TEXT CHECK (network IS NULL OR network IN (${inList(NETWORK_TYPES)})),
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
  ```

**4. getCreateIndexStatements() 변경:**
- `'CREATE INDEX IF NOT EXISTS idx_wallets_chain_network ON wallets(chain, network)',` 를
  `'CREATE INDEX IF NOT EXISTS idx_wallets_chain_environment ON wallets(chain, environment)',` 로 변경
- policies 인덱스 섹션에 추가:
  `'CREATE INDEX IF NOT EXISTS idx_policies_network ON policies(network)',`

**5. v6a 마이그레이션 추가 (version: 6):**
docs/69 섹션 2.5 의사코드를 그대로 구현한다.
- `managesOwnTransaction: false` (표준 마이그레이션)
- SQL 1: `ALTER TABLE transactions ADD COLUMN network TEXT`
- SQL 2: `UPDATE transactions SET network = (SELECT w.network FROM wallets w WHERE w.id = transactions.wallet_id)`

**6. v6b 마이그레이션 추가 (version: 7):**
docs/69 섹션 3.4 의사코드를 그대로 구현한다.
- `managesOwnTransaction: true` (12-step 재생성)
- Step 1: BEGIN
- Step 2: CREATE TABLE wallets_new (environment + default_network, inList() 유틸 사용)
- Step 3: INSERT INTO wallets_new SELECT ... CASE WHEN 13분기 ... (docs/69 섹션 3.2 Step 3 SQL 그대로)
- Step 4: DROP TABLE wallets
- Step 5: ALTER TABLE wallets_new RENAME TO wallets
- Step 6: 인덱스 재생성 (idx_wallets_chain_environment 신규)
- Step 7: sessions 재생성 (FK 재연결, 스키마 변경 없음)
- Step 8: transactions 재생성 (network 컬럼 + CHECK 포함)
- Step 9: policies 재생성 (FK 재연결, 스키마 변경 없음 -- v8에서 network 추가)
- Step 10: audit_log 재생성 (일관성)
- Step 11: COMMIT (try/catch ROLLBACK)
- Step 12: PRAGMA foreign_keys=ON + foreign_key_check

IMPORTANT: v6b의 policies 재생성에서는 아직 network 컬럼을 추가하지 않는다 (v8 범위). POLICY_TYPES는 현재 10개 SSoT 값 사용 (ALLOWED_NETWORKS는 Phase 110에서 추가). CHECK 제약에는 현재 POLICY_TYPES를 그대로 사용한다.

**7. v8 마이그레이션 추가 (version: 8):**
docs/71 섹션 6.3 의사코드를 기반으로 구현한다.
- `managesOwnTransaction: true` (12-step 재생성)
- Step 1: BEGIN
- Step 2: CREATE TABLE policies_new (network 컬럼 추가 + type CHECK는 inList(POLICY_TYPES) 사용)
- Step 3: INSERT INTO policies_new ... SELECT ... NULL ... FROM policies
- Step 4: DROP TABLE policies
- Step 5: ALTER TABLE policies_new RENAME TO policies
- Step 6: 기존 인덱스 재생성 (idx_policies_wallet_enabled, idx_policies_type)
- Step 7: 신규 인덱스 (idx_policies_network)
- Step 8: COMMIT (try/catch ROLLBACK)
- Step 9: PRAGMA foreign_keys=ON + foreign_key_check

**8. 기존 pushSchema() 함수 자체는 변경 불필요.** LATEST_SCHEMA_VERSION=8로 변경되면 새 DB에서 version 1~8이 모두 기록되어 마이그레이션이 스킵된다. MIGRATIONS 배열에 v6a/v6b/v8이 추가되면 pushSchema의 for-loop에서 자동 반영된다.

파일 상단 주석에 v6a/v6b/v8 추가 기록 갱신.

빌드 확인: `pnpm --filter @waiaas/daemon build`
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon build` -- 타입 에러 없이 빌드 성공
  </verify>
  <done>
migrate.ts에 v6a(version 6)/v6b(version 7)/v8(version 8) 마이그레이션이 추가되고, LATEST_SCHEMA_VERSION=8, pushSchema DDL이 환경 모델을 반영하며, 빌드 성공.
  </done>
</task>

<task type="auto">
  <name>Task 2: schema.ts Drizzle 스키마 환경 모델 전환 + 마이그레이션 테스트</name>
  <files>packages/daemon/src/infrastructure/database/schema.ts, packages/daemon/src/__tests__/migration-v6-v8.test.ts</files>
  <action>
**Part A: schema.ts Drizzle 스키마 변경**

docs/68 부록 B와 docs/69 섹션 5를 기반으로 schema.ts를 변경한다.

1. **import에 ENVIRONMENT_TYPES 추가:**
```typescript
import {
  WALLET_STATUSES,
  CHAIN_TYPES,
  NETWORK_TYPES,
  ENVIRONMENT_TYPES,  // NEW
  TRANSACTION_STATUSES,
  TRANSACTION_TYPES,
  POLICY_TYPES,
  POLICY_TIERS,
  NOTIFICATION_LOG_STATUSES,
} from '@waiaas/core';
```

2. **wallets 테이블 변경:**
- `network: text('network').notNull(),` 제거
- 대신 다음 2개 필드 추가 (chain 뒤에 배치):
  ```typescript
  environment: text('environment').notNull(),
  defaultNetwork: text('default_network'),
  ```
- 인덱스/CHECK 변경:
  - `index('idx_wallets_chain_network').on(table.chain, table.network)` -> `index('idx_wallets_chain_environment').on(table.chain, table.environment)`
  - `check('check_network', buildCheckSql('network', NETWORK_TYPES))` ->
    `check('check_environment', buildCheckSql('environment', ENVIRONMENT_TYPES))`
  - 추가: `check('check_default_network', sql.raw(\`default_network IS NULL OR default_network IN (${NETWORK_TYPES.map((v) => \`'\${v}'\`).join(', ')})\`))`

3. **transactions 테이블 변경:**
- `metadata: text('metadata'),` 뒤에 추가:
  ```typescript
  network: text('network'),
  ```
- CHECK 제약 추가 (table 콜백 배열에):
  ```typescript
  check('check_tx_network', sql.raw(`network IS NULL OR network IN (${NETWORK_TYPES.map((v) => `'${v}'`).join(', ')})`)),
  ```

4. **policies 테이블 변경:**
- `updatedAt` 필드 뒤에 추가:
  ```typescript
  network: text('network'),
  ```
- CHECK 제약 추가 (table 콜백 배열에):
  ```typescript
  check('check_policy_network', sql.raw(`network IS NULL OR network IN (${NETWORK_TYPES.map((v) => `'${v}'`).join(', ')})`)),
  ```
- 인덱스 추가:
  ```typescript
  index('idx_policies_network').on(table.network),
  ```

파일 상단 주석 업데이트: wallets.network 대신 wallets.environment + wallets.defaultNetwork 설명.

**Part B: 마이그레이션 데이터 무결성 테스트**

새 테스트 파일 `packages/daemon/src/__tests__/migration-v6-v8.test.ts` 생성.

기존 `migration-runner.test.ts`의 패턴(createDatabase(':memory:'), pushSchema)을 따르되, 마이그레이션 전 v5 상태의 DB를 수동으로 구성하여 v6a/v6b/v8을 순차 적용한다.

**핵심: v5 상태의 DB를 구성하는 방법:**
pushSchema()는 최신 스키마(v8)를 생성하므로 사용할 수 없다. 대신:
1. 인메모리 DB 생성 (`:memory:`)
2. PRAGMAs 설정 (journal_mode=WAL, foreign_keys=ON 등)
3. v5 시점의 DDL을 직접 실행 (wallets에 network 컬럼 있는 old 스키마)
4. schema_version 테이블 생성 + version 1~5 기록
5. 테스트 데이터 삽입
6. runMigrations() 호출 (v6a/v6b/v8 순차 실행)
7. 결과 검증

**테스트 케이스 (8개):**

1. **v6a -- transactions.network 역참조 성공:**
   - v5 DB에 wallet(network='devnet') + transaction 생성
   - runMigrations() 실행 후 `SELECT network FROM transactions` = 'devnet'

2. **v6a -- EVM wallet 역참조:**
   - v5 DB에 wallet(network='ethereum-sepolia') + transaction 생성
   - v6a 후 transactions.network = 'ethereum-sepolia'

3. **v6b -- Solana mainnet wallet 변환:**
   - v5 + v6a 상태에서 wallet(network='mainnet')
   - v6b 후: environment='mainnet', default_network='mainnet'

4. **v6b -- EVM testnet wallet 변환:**
   - wallet(network='polygon-amoy')
   - v6b 후: environment='testnet', default_network='polygon-amoy'

5. **v6b -- FK 무결성 보존:**
   - wallet + session + transaction + policy 모두 존재하는 상태에서 v6b
   - PRAGMA foreign_key_check = empty

6. **v6b -- 인덱스 전환:**
   - v6b 후 idx_wallets_chain_environment 존재
   - idx_wallets_chain_network 미존재

7. **v8 -- policies.network 컬럼 추가:**
   - v6b 후 policy 존재 상태에서 v8
   - 기존 policy의 network = NULL
   - PRAGMA foreign_key_check = empty

8. **pushSchema vs 마이그레이션 스키마 동일성:**
   - DB A: pushSchema()로 새 DB 생성
   - DB B: v5 DDL -> v6a -> v6b -> v8 순차 적용
   - 비교: wallets/transactions/policies 테이블의 PRAGMA table_info() 컬럼 목록 일치
   - 비교: sqlite_master에서 인덱스 이름 목록 일치

**v5 DDL 구성 함수:**
테스트 내부에 `createV5Database()` 헬퍼를 만들어 v5 시점의 wallets(network 컬럼 포함), sessions, transactions(network 없음), policies(network 없음), audit_log, schema_version 테이블을 생성한다. 이 DDL은 migrate.ts의 현재(변경 전) getCreateTableStatements()에서 가져온 것을 기반으로 한다.

`pnpm --filter @waiaas/daemon test -- --run migration-v6-v8.test` 실행.
전체 daemon 테스트 회귀 확인: `pnpm --filter @waiaas/daemon test -- --run`
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon build && pnpm --filter @waiaas/daemon test -- --run migration-v6-v8.test` -- 빌드 성공 + 마이그레이션 테스트 PASS
`pnpm --filter @waiaas/daemon test -- --run migration-runner.test` -- 기존 마이그레이션 테스트도 PASS (LATEST_SCHEMA_VERSION=8 반영)
  </verify>
  <done>
schema.ts가 wallets.environment/defaultNetwork + transactions.network + policies.network을 반영하고,
마이그레이션 테스트 8개가 PASS하며,
pushSchema DB와 마이그레이션 DB의 스키마 동일성이 검증되고,
기존 daemon 테스트에 회귀가 없다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon build` -- 모노레포 빌드 성공
2. `pnpm --filter @waiaas/daemon test -- --run migration-v6-v8.test` -- 신규 마이그레이션 테스트 8개 PASS
3. `pnpm --filter @waiaas/daemon test -- --run migration-runner.test` -- 기존 마이그레이션 테스트 PASS
4. `pnpm --filter @waiaas/daemon test -- --run` -- daemon 전체 테스트 PASS (기존 코드에서 wallets.network 참조하는 곳은 Phase 110에서 변경 예정이므로, 이 Phase에서는 Drizzle 스키마 변경으로 인한 타입 에러가 발생할 수 있음 -- 이 경우 schema.ts의 wallets.network 제거를 보류하고 deprecated 주석으로 처리하거나, 영향받는 테스트를 최소한으로 수정)

**IMPORTANT 판단 기준:** Drizzle schema에서 wallets.network을 제거하면 이를 참조하는 daemon 코드(routes, pipeline 등)에서 타입 에러가 발생한다. 이 타입 에러는 Phase 110에서 해결할 범위이다.

**전략:**
- schema.ts에서는 wallets에 environment + defaultNetwork를 **추가**하고, network은 **제거**한다
- migrate.ts의 DDL과 schema.ts가 일치해야 하므로 network 제거는 필수
- 타입 에러가 발생하는 daemon 코드에서 `wallet.network` 참조를 `wallet.defaultNetwork`로 임시 변경하거나, `as any`로 suppress할 수 있지만, 깨끗한 방법은 이 Phase에서 schema.ts의 wallets.network을 제거하되, daemon의 wallet.network 참조를 wallet.defaultNetwork로 일괄 변환하는 것이다 (Phase 110 부하를 분산)
- 판단: Phase 109는 "데이터 레이어 전환"이 목표이므로, schema.ts에서 network 제거 + daemon 코드의 `wallet.network` -> `wallet.defaultNetwork` 최소 변환을 수행한다. 이는 DB 컬럼명이 `default_network`이므로 Drizzle 매핑이 `defaultNetwork`가 되어 자연스럽다.
- 단, 라우트/파이프라인의 비즈니스 로직 변경은 Phase 110/111 범위이므로, 여기서는 **타입 에러만 해소**하는 최소 변경에 그친다.

5. LATEST_SCHEMA_VERSION = 8 확인
6. pushSchema() 새 DB에서 wallets 테이블에 environment/default_network 컬럼 존재, network 컬럼 미존재 확인
</verification>

<success_criteria>
- v6a/v6b/v8 마이그레이션 3개가 migrate.ts에 존재하고 올바른 version 순서(6, 7, 8)로 등록됨
- pushSchema DDL이 마이그레이션 결과와 동일한 스키마를 생성함 (테스트 케이스 8로 검증)
- Drizzle schema.ts가 새 컬럼(wallets.environment/defaultNetwork, transactions.network, policies.network)을 반영함
- 기존 데이터 무결성 보존 (network -> environment 변환 정확, default_network 보존, FK 무결성)
- 마이그레이션 테스트 8개 PASS
</success_criteria>

<output>
After completion, create `.planning/phases/109-db-migration-environment-ssot/109-02-SUMMARY.md`
</output>
