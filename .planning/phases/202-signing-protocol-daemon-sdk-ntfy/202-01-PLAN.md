---
phase: 202-signing-protocol-daemon-sdk-ntfy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/errors/error-codes.ts
  - packages/core/src/schemas/signing-protocol.ts
  - packages/core/src/index.ts
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/services/signing-sdk/wallet-link-registry.ts
autonomous: true
requirements:
  - PROTO-02
  - WALLET-01
  - WALLET-02
  - WALLET-03
  - CONF-01
  - CONF-02

must_haves:
  truths:
    - "SignRequest/SignResponse Zod 스키마로 유효한 데이터를 검증하고 잘못된 데이터를 거부한다"
    - "wallets 테이블에 owner_approval_method 컬럼이 존재하고 CHECK 제약이 동작한다"
    - "SettingsService에 signing_sdk.* 7개 키가 등록되어 get/set 가능하다 (CONF-01 6개 운영 키 + CONF-02 wallets JSON 키)"
    - "WalletLinkRegistry에 지갑을 등록하고 조회할 수 있으며 미등록 지갑은 에러를 반환한다"
    - "Signing SDK 관련 7개 에러 코드가 ERROR_CODES에 등록되어 WAIaaSError 생성이 타입 안전하다"
  artifacts:
    - path: "packages/core/src/errors/error-codes.ts"
      provides: "SIGNING 도메인 7개 에러 코드 (WALLET_NOT_REGISTERED, SIGNING_SDK_DISABLED, SIGN_REQUEST_NOT_FOUND, SIGN_REQUEST_EXPIRED, SIGNER_ADDRESS_MISMATCH, INVALID_SIGN_RESPONSE, SIGN_REQUEST_ALREADY_PROCESSED)"
      contains: "SIGNING"
    - path: "packages/core/src/schemas/signing-protocol.ts"
      provides: "SignRequest/SignResponse Zod 스키마 + 타입 + base64url 인코딩 유틸"
      exports: ["SignRequestSchema", "SignResponseSchema", "SignRequest", "SignResponse", "WalletLinkConfigSchema", "WalletLinkConfig", "APPROVAL_METHODS", "encodeSignRequest", "decodeSignRequest"]
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v18 migration: wallets.owner_approval_method 컬럼 추가"
      contains: "version: 18"
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "signing_sdk 카테고리 7개 키 정의 (CONF-01: 6개 운영 키, CONF-02: wallets JSON 키)"
      contains: "signing_sdk"
    - path: "packages/daemon/src/services/signing-sdk/wallet-link-registry.ts"
      provides: "WalletLinkRegistry 클래스 (등록/조회/URL 생성)"
      exports: ["WalletLinkRegistry"]
  key_links:
    - from: "packages/core/src/schemas/signing-protocol.ts"
      to: "packages/core/src/index.ts"
      via: "re-export"
      pattern: "export.*signing-protocol"
    - from: "packages/daemon/src/services/signing-sdk/wallet-link-registry.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      via: "SettingsService.get('signing_sdk.wallets')"
      pattern: "settings.*get.*signing_sdk"
    - from: "packages/daemon/src/services/signing-sdk/wallet-link-registry.ts"
      to: "packages/core/src/errors/error-codes.ts"
      via: "WAIaaSError('WALLET_NOT_REGISTERED')"
      pattern: "WALLET_NOT_REGISTERED"
---

<objective>
Signing Protocol 기반 인프라 (에러 코드, Zod 스키마, DB 마이그레이션, Settings 키, WalletLinkRegistry) 구축

Purpose: 후속 플랜(SignRequestBuilder, NtfySigningChannel, wallet-sdk)이 사용할 에러 코드, 공유 스키마, DB 컬럼, 설정 키, 지갑 링크 레지스트리를 먼저 확립한다.
Output: 7개 파일 생성/수정 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/objectives/m26-01-wallet-signing-sdk.md
@internal/design/73-signing-protocol-v1.md
@internal/design/74-wallet-sdk-daemon-components.md
@packages/core/src/errors/error-codes.ts
@packages/core/src/errors/base-error.ts
@packages/core/src/index.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/infrastructure/settings/settings-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Signing SDK 에러 코드 등록 + Signing Protocol Zod 스키마 + base64url 유틸</name>
  <files>
    packages/core/src/errors/error-codes.ts
    packages/core/src/schemas/signing-protocol.ts
    packages/core/src/index.ts
  </files>
  <action>
1. **에러 코드 등록** (`packages/core/src/errors/error-codes.ts`):
   - ErrorDomain 유니온에 `'SIGNING'` 추가
   - ERROR_CODES 객체에 다음 7개 에러 코드 추가 (// --- SIGNING domain (7) --- 주석 블록):
     ```
     WALLET_NOT_REGISTERED: { code: 'WALLET_NOT_REGISTERED', domain: 'SIGNING', httpStatus: 404, retryable: false, message: 'Wallet not registered in signing SDK' }
     SIGNING_SDK_DISABLED: { code: 'SIGNING_SDK_DISABLED', domain: 'SIGNING', httpStatus: 403, retryable: false, message: 'Signing SDK is disabled' }
     SIGN_REQUEST_NOT_FOUND: { code: 'SIGN_REQUEST_NOT_FOUND', domain: 'SIGNING', httpStatus: 404, retryable: false, message: 'Sign request not found' }
     SIGN_REQUEST_EXPIRED: { code: 'SIGN_REQUEST_EXPIRED', domain: 'SIGNING', httpStatus: 408, retryable: false, message: 'Sign request has expired' }
     SIGNER_ADDRESS_MISMATCH: { code: 'SIGNER_ADDRESS_MISMATCH', domain: 'SIGNING', httpStatus: 403, retryable: false, message: 'Signer address does not match wallet owner' }
     INVALID_SIGN_RESPONSE: { code: 'INVALID_SIGN_RESPONSE', domain: 'SIGNING', httpStatus: 400, retryable: false, message: 'Invalid sign response format' }
     SIGN_REQUEST_ALREADY_PROCESSED: { code: 'SIGN_REQUEST_ALREADY_PROCESSED', domain: 'SIGNING', httpStatus: 409, retryable: false, message: 'Sign request has already been processed' }
     ```
   - 주석의 총 에러 코드 수를 74에서 81로 업데이트
   - 기존 에러 코드 INVALID_SIGNATURE (AUTH 도메인)는 서명 검증 실패에 재사용 (새로 추가하지 않음)

2. **Signing Protocol Zod 스키마** (`packages/core/src/schemas/signing-protocol.ts` 생성):
   - doc 73 Section 3의 SignRequestSchema 정의 (version literal '1', requestId uuid, chain enum['solana','evm'], network string, message string, displayMessage string, metadata object, responseChannel discriminatedUnion('type', [ntfy, telegram]), expiresAt datetime)
   - doc 73 Section 4의 SignResponseSchema 정의 (version literal '1', requestId uuid, action enum['approve','reject'], signature optional string, signerAddress string, signedAt datetime)
   - SignRequestMetadataSchema (txId uuid, type string, from string, to string, amount optional, symbol optional, policyTier enum['APPROVAL','DELAY'])
   - NtfyResponseChannelSchema, TelegramResponseChannelSchema, ResponseChannelSchema (discriminatedUnion on 'type')
   - WalletLinkConfigSchema (name string, displayName string, universalLink object{base url, signPath string}, deepLink optional object{scheme string, signPath string}, ntfy optional object{requestTopic string})
   - APPROVAL_METHODS array: ['sdk_ntfy', 'sdk_telegram', 'walletconnect', 'telegram_bot', 'rest'] as const
   - ApprovalMethodSchema: z.enum(APPROVAL_METHODS)
   - base64url 유틸: encodeSignRequest(request: SignRequest) -> string (JSON.stringify -> base64url encode), decodeSignRequest(encoded: string) -> SignRequest (base64url decode -> JSON.parse -> SignRequestSchema.parse)
   - buildUniversalLinkUrl(walletConfig: WalletLinkConfig, request: SignRequest) -> string (https://{base}{signPath}?data={encoded})
   - z.infer로 모든 타입 derive 후 export
   - base64url 인코딩은 Buffer.from(str).toString('base64url') 사용 (Node.js 22 built-in), 디코딩은 Buffer.from(str, 'base64url').toString('utf-8')

3. `packages/core/src/index.ts` 수정:
   - signing-protocol.ts의 모든 export를 re-export 추가: `export * from './schemas/signing-protocol.js';`
  </action>
  <verify>
  `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/core` 통과.
  core 패키지 테스트에서 SignRequestSchema.parse() / SignResponseSchema.parse() / encodeSignRequest() / decodeSignRequest() / buildUniversalLinkUrl() 동작 확인하는 단위 테스트를 `packages/core/src/__tests__/signing-protocol.test.ts`에 작성하고 `pnpm turbo run test --filter=@waiaas/core` 통과.
  기존 에러 코드 enum SSoT 검증 테스트가 있으면 count를 81로 업데이트.
  </verify>
  <done>
  - ERROR_CODES에 SIGNING 도메인 7개 에러 코드 등록 (WALLET_NOT_REGISTERED, SIGNING_SDK_DISABLED, SIGN_REQUEST_NOT_FOUND, SIGN_REQUEST_EXPIRED, SIGNER_ADDRESS_MISMATCH, INVALID_SIGN_RESPONSE, SIGN_REQUEST_ALREADY_PROCESSED)
  - ErrorDomain 유니온에 'SIGNING' 추가
  - WAIaaSError('WALLET_NOT_REGISTERED') 등 7개 코드가 타입 체크 통과
  - SignRequestSchema, SignResponseSchema, WalletLinkConfigSchema, ApprovalMethodSchema가 유효한 데이터를 검증하고 잘못된 데이터를 거부
  - encodeSignRequest/decodeSignRequest가 round-trip 성공
  - buildUniversalLinkUrl이 올바른 유니버셜 링크 URL 생성
  - APPROVAL_METHODS 배열에 5개 값 포함
  - @waiaas/core에서 모든 스키마/타입/유틸이 import 가능
  </done>
</task>

<task type="auto">
  <name>Task 2: DB 마이그레이션 (wallets.owner_approval_method) + Settings 키 등록 + WalletLinkRegistry</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/infrastructure/database/schema.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/services/signing-sdk/wallet-link-registry.ts
  </files>
  <action>
1. **DB 마이그레이션 v18** (`migrate.ts`에 MIGRATIONS.push 추가):
   - `ALTER TABLE wallets ADD COLUMN owner_approval_method TEXT` (nullable, NULL = 글로벌 fallback)
   - CHECK 제약은 SQLite ALTER로 추가 불가 -> 단순 ALTER TABLE ADD COLUMN만 수행 (CHECK는 애플리케이션 레벨 Zod 검증으로 대체, 기존 패턴 따름)
   - LATEST_SCHEMA_VERSION을 18로 업데이트
   - `getCreateTableStatements()`의 wallets DDL에 `owner_approval_method TEXT` 컬럼 추가 (CHECK 포함: `CHECK (owner_approval_method IS NULL OR owner_approval_method IN ('sdk_ntfy', 'sdk_telegram', 'walletconnect', 'telegram_bot', 'rest'))`)

2. **Drizzle 스키마** (`schema.ts`):
   - wallets 테이블 정의에 `ownerApprovalMethod: text('owner_approval_method')` 필드 추가

3. **Settings 키 등록** (`setting-keys.ts`):
   - SETTING_CATEGORIES에 `'signing_sdk'` 추가
   - SETTING_DEFINITIONS에 7개 키 추가 (CONF-01: 6개 운영 키, CONF-02: 1개 wallets JSON 키):
     - CONF-01 범위 (6개 운영 키):
       - `signing_sdk.enabled` (category: 'signing_sdk', configPath: 'signing_sdk.enabled', default: 'false', isCredential: false)
       - `signing_sdk.request_expiry_min` (default: '30')
       - `signing_sdk.preferred_channel` (default: 'ntfy')
       - `signing_sdk.preferred_wallet` (default: '')
       - `signing_sdk.ntfy_request_topic_prefix` (default: 'waiaas-sign')
       - `signing_sdk.ntfy_response_topic_prefix` (default: 'waiaas-response')
     - CONF-02 범위 (1개 wallets JSON 키):
       - `signing_sdk.wallets` (default: '[]', JSON 배열, category: 'signing_sdk') -- WalletLinkRegistry가 관리하는 등록 지갑 설정 저장

4. **WalletLinkRegistry** (`packages/daemon/src/services/signing-sdk/wallet-link-registry.ts` 신규):
   - SettingsService를 주입받아 `signing_sdk.wallets` JSON 배열에서 지갑 설정 관리
   - `getWallet(name: string): WalletLinkConfig` -- 이름으로 조회, 미등록 시 WAIaaSError('WALLET_NOT_REGISTERED') throw (Task 1에서 등록한 에러 코드 사용)
   - `getAllWallets(): WalletLinkConfig[]` -- 전체 목록 반환
   - `registerWallet(config: WalletLinkConfig): void` -- JSON 배열에 추가 (중복 이름 방지)
   - `removeWallet(name: string): void` -- JSON 배열에서 제거
   - `buildSignUrl(walletName: string, request: SignRequest): string` -- getWallet() + buildUniversalLinkUrl() 조합
   - 내부적으로 SettingsService.get('signing_sdk.wallets')를 JSON.parse하고 WalletLinkConfigSchema 배열로 검증
   - @waiaas/core의 WalletLinkConfigSchema, buildUniversalLinkUrl, SignRequest 타입, WAIaaSError import

5. **테스트 작성**:
   - `packages/daemon/src/__tests__/signing-sdk-migration.test.ts`: v18 마이그레이션이 wallets 테이블에 owner_approval_method 컬럼을 추가하는지 검증 (기존 마이그레이션 테스트 패턴 따름)
   - `packages/daemon/src/__tests__/wallet-link-registry.test.ts`: 등록/조회/미등록에러/URL생성 테스트 (SettingsService mock)
  </action>
  <verify>
  `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/daemon` 통과.
  `pnpm turbo run test --filter=@waiaas/daemon` 통과 (기존 테스트 깨지지 않음).
  신규 테스트 파일 2개 통과.
  </verify>
  <done>
  - MIGRATIONS 배열에 version 18이 추가되어 wallets.owner_approval_method 컬럼 생성
  - LATEST_SCHEMA_VERSION이 18이고 fresh DB DDL에 owner_approval_method 포함
  - Drizzle 스키마에 ownerApprovalMethod 필드 존재
  - SETTING_DEFINITIONS에 signing_sdk.* 7개 키 등록: CONF-01 범위 6개 운영 키(enabled, request_expiry_min, preferred_channel, preferred_wallet, ntfy_request_topic_prefix, ntfy_response_topic_prefix) + CONF-02 범위 1개 wallets JSON 키
  - WalletLinkRegistry가 getWallet/getAllWallets/registerWallet/removeWallet/buildSignUrl 메서드 제공
  - 미등록 지갑 조회 시 WAIaaSError('WALLET_NOT_REGISTERED') 에러 반환 (타입 안전)
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck` -- 전체 monorepo 타입 체크 통과 (특히 새로운 에러 코드가 ErrorCode 타입에 포함)
2. `pnpm turbo run test --filter=@waiaas/core --filter=@waiaas/daemon` -- 기존 + 신규 테스트 전체 통과
3. DB 마이그레이션이 기존 DB에서 안전하게 적용되는지 마이그레이션 테스트로 검증
4. WAIaaSError('WALLET_NOT_REGISTERED') 등 7개 새 에러 코드가 타입 체크 통과 확인
</verification>

<success_criteria>
- ERROR_CODES에 SIGNING 도메인 7개 에러 코드 등록 + ErrorDomain에 'SIGNING' 추가
- SignRequest/SignResponse Zod 스키마가 core 패키지에서 export되고 daemon 패키지에서 import 가능
- wallets 테이블에 owner_approval_method 컬럼 존재 (v18 migration)
- SettingsService에서 signing_sdk.* 키들을 get/set 가능
- WalletLinkRegistry에서 지갑 메타데이터 CRUD + 유니버셜 링크 URL 생성 동작
- 전체 테스트 스위트 통과 (기존 테스트 깨지지 않음)
</success_criteria>

<output>
After completion, create `.planning/phases/202-signing-protocol-daemon-sdk-ntfy/202-01-SUMMARY.md`
</output>
