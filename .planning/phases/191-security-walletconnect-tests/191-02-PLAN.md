---
phase: 191-security-walletconnect-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/__tests__/walletconnect.test.tsx
autonomous: true
requirements:
  - NEWPG-10
  - NEWPG-11
  - NEWPG-12

must_haves:
  truths:
    - "walletconnect.test.tsx 파일이 존재하고 모든 테스트가 통과한다"
    - "월렛 목록이 WC 세션 상태와 함께 테이블로 렌더링되는 것이 테스트로 검증된다"
    - "Connect 버튼 클릭 시 pairing API 호출 + QR 모달 표시가 테스트로 검증된다"
    - "Disconnect 버튼 클릭 시 session delete API 호출이 테스트로 검증된다"
    - "월렛이 없을 때 empty state 메시지가 표시되는 것이 테스트로 검증된다"
  artifacts:
    - path: "packages/admin/src/__tests__/walletconnect.test.tsx"
      provides: "walletconnect.tsx 전체 테스트"
      min_lines: 150
  key_links:
    - from: "packages/admin/src/__tests__/walletconnect.test.tsx"
      to: "packages/admin/src/pages/walletconnect.tsx"
      via: "import WalletConnectPage from '../pages/walletconnect'"
      pattern: "import.*WalletConnectPage.*from.*pages/walletconnect"
    - from: "packages/admin/src/__tests__/walletconnect.test.tsx"
      to: "../api/client"
      via: "vi.mock('../api/client')"
      pattern: "vi\\.mock\\('\\.\\.\/api\/client'"
---

<objective>
walletconnect.tsx 페이지의 월렛 테이블 렌더링, Connect/Disconnect 동작, QR 모달, 폴링, empty state를 테스트하는 파일을 작성한다.

Purpose: v2.3 메뉴 재구성으로 신규 생성된 walletconnect.tsx 페이지의 테스트 커버리지 확보
Output: packages/admin/src/__tests__/walletconnect.test.tsx
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/admin/src/pages/walletconnect.tsx
@packages/admin/src/__tests__/settings-coverage.test.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/__tests__/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: walletconnect.tsx 테이블 렌더링 + empty state + 세션 표시 테스트</name>
  <files>packages/admin/src/__tests__/walletconnect.test.tsx</files>
  <action>
walletconnect.test.tsx 파일을 생성한다. settings-coverage.test.tsx와 동일한 mock 패턴을 따른다.

**vi.useFakeTimers() 사용:** walletconnect.tsx는 setInterval(3000ms) 폴링을 사용하므로 반드시 `vi.useFakeTimers()` / `vi.useRealTimers()` 로 타이머를 제어해야 한다. beforeEach에서 `vi.useFakeTimers()`, afterEach에서 `vi.useRealTimers()` 호출.

**주의:** `vi.useFakeTimers()`를 사용하면 `waitFor`가 timeout되는 문제가 있을 수 있다. 이 경우 테스트별로 필요할 때만 fake timers를 활성화하고, 일반 렌더링 테스트에서는 real timers를 사용한다. 또는 `vi.useFakeTimers({ shouldAdvanceTime: true })` 옵션을 사용한다.

**Mock 설정 (파일 상단, vi.mock):**
- `../api/client` — apiGet, apiPost, apiDelete, ApiError mock (apiPut는 walletconnect.tsx에서 사용하지 않지만 일관성을 위해 포함해도 됨)
- `../components/toast` — showToast, ToastContainer mock
- `../auth/store` — masterPassword, isAuthenticated 등 기본 mock
- `../utils/error-messages` — getErrorMessage mock

**Import:** `import WalletConnectPage from '../pages/walletconnect';`

**Mock 데이터:**
```typescript
const mockWallets = {
  items: [
    { id: 'w1', name: 'My Solana Wallet', chain: 'solana', environment: 'devnet' },
    { id: 'w2', name: 'My EVM Wallet', chain: 'evm', environment: 'testnet' },
  ],
};

const mockWcSession: WcSession = {
  walletId: 'w1',
  topic: 'topic-abc',
  peerName: 'MetaMask',
  peerUrl: 'https://metamask.io',
  chainId: 'eip155:1',
  ownerAddress: '0x1234567890abcdef1234567890abcdef12345678',
  expiry: 1707696000,
  createdAt: 1707609600,
};
```

(WcSession 타입은 인라인 interface로 정의 -- walletconnect.tsx의 interface와 동일한 shape)

**Helper:**
```typescript
function mockApiCalls(walletData = mockWallets, sessions: Record<string, any> = {}) {
  vi.mocked(apiGet).mockImplementation(async (path: string) => {
    if (path === '/v1/wallets') return walletData;
    // Per-wallet WC session: /v1/wallets/{id}/wc/session
    const wcMatch = path.match(/\/v1\/wallets\/(.+)\/wc\/session$/);
    if (wcMatch) {
      const wId = wcMatch[1];
      if (sessions[wId]) return sessions[wId];
      throw new ApiError(404, 'NOT_FOUND', 'No session');
    }
    return {};
  });
}
```

**describe('WalletConnect page: 렌더링')** (NEWPG-11 부분):
1. `it('renders wallet table with WC status columns')` — mockApiCalls(mockWallets, { w1: mockWcSession }), render, waitFor 'My Solana Wallet' visible, verify columns: 'Wallet', 'Chain', 'WC Status', 'Peer', 'Owner Address', 'Expiry', 'Actions' headers present
2. `it('shows Connected badge for wallet with session')` — mockApiCalls with w1 having session, render, waitFor 'Connected' badge visible for w1 row, verify 'MetaMask' peer name displayed
3. `it('shows Not Connected badge for wallet without session')` — mockApiCalls with no sessions, render, waitFor 'Not Connected' badges visible for both wallets
4. `it('shows owner address formatted for connected wallet')` — mockApiCalls with w1 session, render, waitFor formatted address (formatAddress shortens to 0x1234...5678 pattern) visible
5. `it('shows -- for peer/address/expiry when not connected')` — mockApiCalls with no sessions, render, waitFor '--' texts for peer/address/expiry columns

**describe('WalletConnect page: empty state')** (NEWPG-12):
1. `it('shows empty message when no wallets exist')` — mockApiCalls({ items: [] }), render, waitFor 'No wallets found. Create a wallet first.' text visible
2. `it('shows description card about WalletConnect')` — mockApiCalls(), render, waitFor text containing 'Manage WalletConnect sessions' visible

**describe('WalletConnect page: fetch error'):**
1. `it('shows error toast on fetch failure')` — mock apiGet to reject with ApiError, render, waitFor showToast('error', ...) called

afterEach: cleanup() + vi.clearAllMocks()
  </action>
  <verify>pnpm --filter @waiaas/admin test:unit -- --reporter=verbose walletconnect.test 실행 시 렌더링 + empty state 테스트 통과</verify>
  <done>walletconnect.test.tsx가 존재하고, 렌더링 5개 + empty state 2개 + fetch error 1개 테스트가 통과한다</done>
</task>

<task type="auto">
  <name>Task 2: walletconnect.tsx Connect/Disconnect + QR 모달 + 폴링 테스트 추가</name>
  <files>packages/admin/src/__tests__/walletconnect.test.tsx</files>
  <action>
Task 1에서 생성한 walletconnect.test.tsx에 Connect/Disconnect 동작과 QR 모달 테스트를 추가한다.

**describe('WalletConnect page: Connect flow')** (NEWPG-10 부분):
1. `it('clicking Connect calls apiPost for pairing and shows QR modal')` — mockApiCalls(mockWallets, {}), render, waitFor 'Connect' button, mock apiPost.mockResolvedValueOnce({ uri: 'wc:xxx', qrCode: 'data:image/png;base64,abc', expiresAt: 9999999999 }), click first 'Connect' button, waitFor 'Scan QR Code' modal title visible, verify img[alt="WalletConnect QR Code"] present, verify apiPost called with '/v1/wallets/w1/wc/pair'
2. `it('QR modal shows waiting text')` — after Connect + QR modal open, verify 'Waiting for connection...' text visible
3. `it('closing QR modal clears pairing state')` — open QR modal via Connect, click Cancel on modal, waitFor 'Scan QR Code' to disappear
4. `it('connect error shows error toast')` — mockApiCalls, mock apiPost to reject, click Connect, waitFor showToast('error', ...) called, QR modal should NOT appear
5. `it('polling detects connected status and closes modal')` — 이 테스트에서 vi.useFakeTimers({ shouldAdvanceTime: true }) 사용. mockApiCalls, mock apiPost for pairing success, click Connect, QR modal opens, then mock apiGet for pair-status to return { status: 'connected', session: mockWcSession }, vi.advanceTimersByTime(3000), waitFor showToast('success', 'Wallet connected via WalletConnect'), QR modal closes
6. `it('polling detects expired status and shows error toast')` — fake timers, Connect + QR, mock pair-status to return { status: 'expired' }, advance 3000ms, waitFor showToast('error', 'Pairing expired. Try again.'), modal closes

**describe('WalletConnect page: Disconnect flow')** (NEWPG-10 부분):
1. `it('clicking Disconnect calls apiDelete and updates UI')` — mockApiCalls(mockWallets, { w1: mockWcSession }), render, waitFor 'Disconnect' button visible (w1 has session), mock apiDelete.mockResolvedValueOnce(undefined), click 'Disconnect', waitFor apiDelete called with '/v1/wallets/w1/wc/session', verify showToast('success', 'WalletConnect session disconnected'), verify badge changes to 'Not Connected'
2. `it('disconnect error shows error toast')` — mockApiCalls with w1 session, mock apiDelete to reject, click Disconnect, waitFor showToast('error', ...) called

**폴링 테스트 시 주의사항:**
- vi.useFakeTimers()를 쓸 때 waitFor와 충돌할 수 있으므로 `vi.useFakeTimers({ shouldAdvanceTime: true })` 사용하거나, `act(() => { vi.advanceTimersByTime(3000) })` 후 `await waitFor(...)` 사용
- 폴링 테스트에서 apiGet mock은 pair-status 경로를 추가로 처리해야 함: `/v1/wallets/{id}/wc/pair/status` 패턴
- 테스트 종료 시 타이머 정리: afterEach에서 vi.useRealTimers() 호출
- setInterval이 cleanup에서 clearInterval 되므로 component unmount 시 자동 정리됨

**폴링 apiGet mock 확장:**
```typescript
// pair-status 경로 추가
const statusMatch = path.match(/\/v1\/wallets\/(.+)\/wc\/pair\/status$/);
if (statusMatch) return pairStatusResponse; // 테스트별로 설정
```

afterEach: cleanup() + vi.clearAllMocks() + vi.useRealTimers()
  </action>
  <verify>pnpm --filter @waiaas/admin test:unit -- --reporter=verbose walletconnect.test 실행 시 전체 테스트 통과 (렌더링 5 + empty 2 + error 1 + connect 6 + disconnect 2 = ~16개)</verify>
  <done>walletconnect.test.tsx에 Connect 6개 + Disconnect 2개 테스트가 추가되어 전체 ~16개 테스트가 통과한다</done>
</task>

</tasks>

<verification>
```bash
pnpm --filter @waiaas/admin test:unit -- --reporter=verbose walletconnect.test
```
모든 테스트 통과, 0 failures.
</verification>

<success_criteria>
1. packages/admin/src/__tests__/walletconnect.test.tsx 파일이 존재한다
2. 월렛 테이블 렌더링 + WC 세션 상태 표시 테스트 5개 이상 통과
3. empty state 메시지 표시 테스트 2개 이상 통과
4. Connect 버튼 + QR 모달 + 폴링 테스트 6개 이상 통과
5. Disconnect 동작 테스트 2개 이상 통과
6. `pnpm --filter @waiaas/admin test:unit` 실행 시 walletconnect.test 전체 통과
</success_criteria>

<output>
After completion, create `.planning/phases/191-security-walletconnect-tests/191-02-SUMMARY.md`
</output>
