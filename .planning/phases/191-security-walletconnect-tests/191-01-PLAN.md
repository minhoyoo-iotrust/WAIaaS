---
phase: 191-security-walletconnect-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/__tests__/security.test.tsx
autonomous: true
requirements:
  - NEWPG-01
  - NEWPG-02
  - NEWPG-03
  - NEWPG-04

must_haves:
  truths:
    - "security.test.tsx 파일이 존재하고 모든 테스트가 통과한다"
    - "3개 탭(Kill Switch, AutoStop Rules, Invalidate Sessions) 전환이 테스트로 검증된다"
    - "Kill Switch 3-state(ACTIVE/SUSPENDED/LOCKED) 각각의 렌더링과 버튼 동작이 테스트로 검증된다"
    - "AutoStop Rules 설정 폼의 dirty tracking, save, discard가 테스트로 검증된다"
    - "JWT Rotation 모달 열기/확인/취소/에러가 테스트로 검증된다"
  artifacts:
    - path: "packages/admin/src/__tests__/security.test.tsx"
      provides: "security.tsx 전체 테스트"
      min_lines: 200
  key_links:
    - from: "packages/admin/src/__tests__/security.test.tsx"
      to: "packages/admin/src/pages/security.tsx"
      via: "import SecurityPage from '../pages/security'"
      pattern: "import.*SecurityPage.*from.*pages/security"
    - from: "packages/admin/src/__tests__/security.test.tsx"
      to: "../api/client"
      via: "vi.mock('../api/client')"
      pattern: "vi\\.mock\\('\\.\\.\/api\/client'"
---

<objective>
security.tsx 페이지의 렌더링, 탭 네비게이션, Kill Switch 3-state 동작, AutoStop Rules 설정 폼, JWT Rotation 모달을 테스트하는 파일을 작성한다.

Purpose: v2.3 메뉴 재구성으로 신규 생성된 security.tsx 페이지의 테스트 커버리지 확보
Output: packages/admin/src/__tests__/security.test.tsx
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/admin/src/pages/security.tsx
@packages/admin/src/__tests__/settings-coverage.test.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/__tests__/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: security.tsx 렌더링 + 탭 네비게이션 + Kill Switch 테스트 작성</name>
  <files>packages/admin/src/__tests__/security.test.tsx</files>
  <action>
security.test.tsx 파일을 생성한다. settings-coverage.test.tsx와 동일한 mock 패턴을 따른다.

**Mock 설정 (파일 상단, vi.mock):**
- `../api/client` — apiGet, apiPost, apiPut, ApiError, apiCall mock (settings-coverage.test.tsx 패턴 그대로)
- `../components/toast` — showToast, ToastContainer mock
- `../auth/store` — masterPassword, isAuthenticated, adminTimeout, daemonShutdown, login, logout, resetInactivityTimer mock
- `../utils/error-messages` — getErrorMessage mock
- `../components/settings-search` — pendingNavigation (signal mock: `{ value: null }`), highlightField (signal mock: `{ value: null }`) mock
- `../utils/dirty-guard` — registerDirty (`vi.fn()`), unregisterDirty (`vi.fn()`) mock

**Import:** `import SecurityPage from '../pages/security';`

**Mock 데이터:**
```typescript
const mockKsActive = { state: 'ACTIVE', activatedAt: null, activatedBy: null };
const mockKsSuspended = { state: 'SUSPENDED', activatedAt: 1707609600, activatedBy: 'admin' };
const mockKsLocked = { state: 'LOCKED', activatedAt: 1707609600, activatedBy: 'admin' };
const mockSettingsResponse = {
  autostop: { enabled: 'true', consecutive_failures_threshold: '5', unusual_activity_threshold: '20', unusual_activity_window_sec: '300', idle_timeout_sec: '3600', idle_check_interval_sec: '60' },
};
```

**Helper:**
```typescript
function mockApiCalls(ksState = mockKsActive, settingsData = mockSettingsResponse) {
  vi.mocked(apiGet).mockImplementation(async (path: string) => {
    if (path === '/v1/admin/kill-switch') return ksState;
    if (path === '/v1/admin/settings') return settingsData;
    return {};
  });
}
```

**describe('Security page: 렌더링 + 탭 네비게이션')** (NEWPG-01):
1. `it('renders with Kill Switch tab active by default')` — mockApiCalls() + render SecurityPage, waitFor 'Kill Switch' heading visible, ACTIVE badge visible
2. `it('switches to AutoStop Rules tab')` — render, click 'AutoStop Rules' tab text, waitFor 'AutoStop Rules' heading visible
3. `it('switches to Invalidate Sessions tab')` — render, click 'Invalidate Sessions' tab text, waitFor 'Invalidate All Session Tokens' heading visible
4. `it('Breadcrumb shows current tab name')` — render, verify 'Security' breadcrumb present; switch tab, verify tab label updates in breadcrumb

**describe('Security page: Kill Switch tab')** (NEWPG-02):
1. `it('ACTIVE state: shows ACTIVE badge and Activate button')` — mockApiCalls(mockKsActive), render, waitFor Badge text 'ACTIVE', button 'Activate Kill Switch' visible
2. `it('ACTIVE state: activate calls apiPost and shows success toast')` — mockApiCalls(mockKsActive), render, click 'Activate Kill Switch', verify apiPost called with '/v1/admin/kill-switch', verify showToast('success', ...) called
3. `it('SUSPENDED state: shows Recover and Escalate buttons')` — mockApiCalls(mockKsSuspended), render, waitFor 'Recover' button and 'Escalate to LOCKED' button visible, verify 'SUSPENDED' badge, verify info box text about 'suspended'
4. `it('SUSPENDED state: recover calls apiPost to /v1/admin/recover')` — mockApiCalls(mockKsSuspended), render, click 'Recover', verify apiPost('/v1/admin/recover'), verify showToast('success', ...)
5. `it('SUSPENDED state: escalate calls apiPost to /v1/admin/kill-switch/escalate')` — mockApiCalls(mockKsSuspended), render, click 'Escalate to LOCKED', verify apiPost('/v1/admin/kill-switch/escalate'), verify showToast('success', ...)
6. `it('LOCKED state: shows Recover from LOCKED button and warning box')` — mockApiCalls(mockKsLocked), render, waitFor 'Recover from LOCKED (5s wait)' button, verify 'LOCKED' badge, verify warning text about 'permanently locked'
7. `it('LOCKED state: recover calls apiPost to /v1/admin/recover')` — mockApiCalls(mockKsLocked), render, click 'Recover from LOCKED (5s wait)', verify apiPost('/v1/admin/recover')
8. `it('shows loading state initially')` — mock apiGet to never resolve (pending promise), render, verify 'Loading...' text visible
9. `it('handles fetch error with toast')` — mock apiGet to reject with ApiError, render, waitFor showToast('error', ...) called
10. `it('handles activate error with toast')` — mockApiCalls(mockKsActive), render, mock apiPost to reject, click activate, waitFor showToast('error', ...) called

afterEach: cleanup() + vi.clearAllMocks()

**중요:** 모든 apiPost mock은 resolve 후 apiGet이 다시 호출되므로 (fetchKillSwitchState 재호출), apiGet mock이 이미 mockImplementation으로 설정되어 있어 자동으로 처리됨. apiPost mock은 mockResolvedValueOnce 사용.
  </action>
  <verify>pnpm --filter @waiaas/admin test:unit -- --reporter=verbose security.test 실행 시 렌더링/탭/Kill Switch 관련 테스트 전체 통과</verify>
  <done>security.test.tsx가 존재하고, 렌더링 4개 + Kill Switch 10개 테스트가 모두 통과한다</done>
</task>

<task type="auto">
  <name>Task 2: security.tsx AutoStop Rules + JWT Rotation 테스트 추가</name>
  <files>packages/admin/src/__tests__/security.test.tsx</files>
  <action>
Task 1에서 생성한 security.test.tsx 파일에 AutoStop Rules와 JWT Rotation 테스트를 추가한다.

**describe('Security page: AutoStop Rules tab')** (NEWPG-04 — AutoStop settings form):
1. `it('renders AutoStop fields with current values')` — mockApiCalls(), render, click 'AutoStop Rules' tab, waitFor 'AutoStop Rules' heading, verify input[name="autostop.consecutive_failures_threshold"] has value '5', input[name="autostop.idle_timeout_sec"] has value '3600'
2. `it('changing a field shows save bar with dirty count')` — render, switch to AutoStop tab, change consecutive_failures_threshold input to '10' via fireEvent.input, waitFor 'unsaved change' text visible, verify Save and Discard buttons visible
3. `it('save calls apiPut with changed autostop entries')` — render, switch to AutoStop tab, change a field, click Save button, waitFor apiPut called with '/v1/admin/settings' and body containing `{ settings: [{ key: 'autostop.consecutive_failures_threshold', value: '10' }] }`, verify showToast('success', 'AutoStop settings saved and applied')
4. `it('discard clears dirty state')` — render, switch to AutoStop tab, change a field, verify unsaved text, click 'Discard', verify unsaved text disappears
5. `it('save error shows error toast')` — render, switch to AutoStop tab, change a field, mock apiPut to reject with ApiError, click Save, waitFor showToast('error', ...) called
6. `it('registers and unregisters dirty guard')` — render, verify registerDirty was called with id 'security-autostop', cleanup, verify unregisterDirty was called with 'security-autostop'
7. `it('shows loading state before settings load')` — mock apiGet for settings to use a pending promise, render, switch to AutoStop tab, verify 'Loading settings...' text visible
8. `it('enabled checkbox toggles autostop.enabled')` — render, switch to AutoStop tab, find checkbox input[name="autostop.enabled"], verify it's checked (enabled='true'), toggle it off via fireEvent.change, verify dirty count shows

**describe('Security page: Invalidate Sessions (JWT Rotation) tab')** (NEWPG-03):
1. `it('renders Invalidate button')` — render, click 'Invalidate Sessions' tab, waitFor 'Invalidate All Tokens' button visible
2. `it('clicking Invalidate All Tokens opens modal')` — render, switch to JWT tab, click 'Invalidate All Tokens' button, waitFor modal text 'rotate the signing key' visible
3. `it('confirming modal calls apiPost to rotate-secret')` — render, switch to JWT tab, click 'Invalidate All Tokens', waitFor modal, mock apiPost.mockResolvedValueOnce({ rotatedAt: 1707609600, message: 'ok' }), click 'Invalidate' confirm button, waitFor apiPost('/v1/admin/rotate-secret') called, verify showToast('success', 'All session tokens invalidated. Old tokens remain valid for 5 minutes.')
4. `it('canceling modal closes it')` — render, switch to JWT tab, click button, waitFor modal, click Cancel, waitFor modal text to be null
5. `it('rotate error shows error toast')` — render, switch to JWT tab, click button, waitFor modal, mock apiPost to reject, click Invalidate, waitFor showToast('error', ...) called

**중요:**
- AutoStop tab 전환은 `fireEvent.click(screen.getByText('AutoStop Rules'))` 사용
- JWT tab 전환은 `fireEvent.click(screen.getByText('Invalidate Sessions'))` 사용
- FormField의 checkbox는 `fireEvent.change(input, { target: { checked: false } })` 패턴 사용
- 모든 describe 블록에 afterEach: cleanup() + vi.clearAllMocks()
  </action>
  <verify>pnpm --filter @waiaas/admin test:unit -- --reporter=verbose security.test 실행 시 전체 테스트 통과 (렌더링 4 + Kill Switch 10 + AutoStop 8 + JWT 5 = ~27개)</verify>
  <done>security.test.tsx에 AutoStop 8개 + JWT 5개 테스트가 추가되어 전체 ~27개 테스트가 통과한다</done>
</task>

</tasks>

<verification>
```bash
pnpm --filter @waiaas/admin test:unit -- --reporter=verbose security.test
```
모든 테스트 통과, 0 failures.
</verification>

<success_criteria>
1. packages/admin/src/__tests__/security.test.tsx 파일이 존재한다
2. 렌더링 + 탭 네비게이션 테스트 4개 이상 통과
3. Kill Switch 3-state(ACTIVE/SUSPENDED/LOCKED) 테스트 10개 이상 통과
4. AutoStop Rules 설정 폼 테스트 8개 이상 통과
5. JWT Rotation 모달 테스트 5개 이상 통과
6. `pnpm --filter @waiaas/admin test:unit` 실행 시 security.test 전체 통과
</success_criteria>

<output>
After completion, create `.planning/phases/191-security-walletconnect-tests/191-01-SUMMARY.md`
</output>
