---
phase: 45-core-impl-objectives
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - objectives/v1.1-core-infrastructure.md
  - objectives/v1.2-auth-policy-engine.md
autonomous: true

must_haves:
  truths:
    - "v1.1 objective 문서가 설계 문서 24-29, 31, 45, 54를 참조하고, 패키지별 산출물과 REST API 최소 엔드포인트를 정의하며, 6-stage 파이프라인 골격 + SOL 전송 E2E 시나리오가 포함된다"
    - "v1.2 objective 문서가 설계 문서 30, 32-34, 52-53을 참조하고, 3-tier 인증 + 4-tier 정책 구현 범위를 정의하며, Owner 미등록 시 APPROVAL 비활성 시나리오를 포함한다"
    - "두 문서 모두 부록 구조(목표, 구현 대상 설계 문서, 산출물, 기술 결정 사항, E2E 검증 시나리오, 의존, 리스크)를 갖추고, 각 E2E 시나리오에 [L0]~[L3] 또는 [HUMAN] 태그가 부여된다"
  artifacts:
    - path: "objectives/v1.1-core-infrastructure.md"
      provides: "v1.1 코어 인프라 + 기본 전송 마일스톤 objective"
      contains: "## 목표"
    - path: "objectives/v1.2-auth-policy-engine.md"
      provides: "v1.2 인증 + 정책 엔진 마일스톤 objective"
      contains: "## 목표"
  key_links:
    - from: "objectives/v1.1-core-infrastructure.md"
      to: "objectives/v1.0-implementation-planning.md"
      via: "v1.1 섹션 확장"
      pattern: "v1\\.1.*코어 인프라"
    - from: "objectives/v1.2-auth-policy-engine.md"
      to: "objectives/v1.0-implementation-planning.md"
      via: "v1.2 섹션 확장"
      pattern: "v1\\.2.*인증.*정책"
---

<objective>
v1.1(코어 인프라 + 기본 전송)과 v1.2(인증 + 정책 엔진) 마일스톤의 objective 문서 2개를 생성한다.

Purpose: 각 구현 마일스톤에서 무엇을 구현하고, 어떤 설계 문서를 참조하며, 어떻게 검증하는지를 명확히 정의하여 구현 착수 시 해석 여지를 제거한다.
Output: objectives/v1.1-core-infrastructure.md, objectives/v1.2-auth-policy-engine.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.0-implementation-planning.md

설계 문서 참조 (v1.1 대상):
@.planning/deliverables/24-monorepo-data-directory.md
@.planning/deliverables/25-sqlite-schema.md
@.planning/deliverables/26-keystore-spec.md
@.planning/deliverables/27-chain-adapter-interface.md
@.planning/deliverables/28-daemon-lifecycle-cli.md
@.planning/deliverables/29-api-framework-design.md
@.planning/deliverables/31-solana-adapter-detail.md
@.planning/deliverables/45-enum-unified-mapping.md
@.planning/deliverables/54-cli-flow-redesign.md

설계 문서 참조 (v1.2 대상):
@.planning/deliverables/30-session-token-protocol.md
@.planning/deliverables/32-transaction-pipeline-api.md
@.planning/deliverables/33-time-lock-approval-mechanism.md
@.planning/deliverables/34-owner-wallet-connection.md
@.planning/deliverables/52-auth-model-redesign.md
@.planning/deliverables/53-session-renewal-protocol.md

v0.10 설계 결정 참조:
@objectives/v0.10-pre-implementation-design-completion.md

v0.8 Owner 선택적 등록 참조:
@objectives/v0.8-optional-owner-progressive-security.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: v1.1 코어 인프라 + 기본 전송 objective 문서 생성</name>
  <files>objectives/v1.1-core-infrastructure.md</files>
  <action>
objectives/v1.0-implementation-planning.md의 "v1.1 — 코어 인프라 + 기본 전송" 섹션을 기반으로, 부록 템플릿 구조에 맞는 완전한 objective 문서를 생성한다. 한글로 작성한다.

**1. 목표:** v1.0-implementation-planning.md에서 그대로 가져온다 — "CLI로 init → start → SOL 전송 → 확인까지 동작하는 최소 데몬"

**2. 구현 대상 설계 문서:** 아래 설계 문서를 읽고 각각의 구현 범위(전체/부분)를 테이블로 정리한다:
- 24 (monorepo) — 전체: 7-pkg 모노레포 구조, ~/.waiaas/, config.toml
- 25 (sqlite) — 전체: 7 테이블, Drizzle ORM, UUID v7
- 26 (keystore) — 전체: AES-256-GCM, Argon2id, sodium guarded memory
- 27 (chain-adapter) — 부분: getBalance, buildTransaction, simulateTransaction, signTransaction, submitTransaction, waitForConfirmation만 (나머지 v1.4)
- 28 (daemon) — 전체: 6단계 시작(타임아웃 fail-fast/soft), 10-step 종료
- 29 (api-framework) — 부분: 미들웨어 1~6만 (7~8은 v1.2)
- 31 (solana-adapter) — 부분: 네이티브 SOL 전송만 (SPL은 v1.4)
- 45 (enum) — 전체: 12 Enum SSoT (as const → Zod → Drizzle)
- 54 (cli) — 부분: init/start/stop/status 4개 명령어만

각 문서에서 v1.1에서 구현할 구체적 범위와 v1.1에서 구현하지 않는 범위(나머지 마일스톤 명시)를 상세히 기술한다.

**3. 산출물:** v1.0-implementation-planning.md의 산출물 테이블을 확장한다:
- @waiaas/core: Zod 스키마, 타입, Enum SSoT, 66 에러 코드 통합 매트릭스, 인터페이스 (IChainAdapter, IKeystore 등)
- @waiaas/adapter-solana: SolanaAdapter 6개 메서드
- @waiaas/daemon: Hono 서버, SQLite+Drizzle 7테이블, Keystore, 라이프사이클, config.toml
- @waiaas/cli: 4개 명령어
- 모노레포: pnpm workspace, Turborepo, tsconfig, ESLint, Vitest
- REST API 6개 최소 엔드포인트 (POST /v1/agents, GET /v1/wallet/balance, GET /v1/wallet/address, POST /v1/transactions, GET /v1/transactions/:id, GET /v1/health)
- 파이프라인: 6-stage 골격 (Stage 3 INSTANT 고정 패스스루)

각 패키지의 주요 파일/모듈 구조를 나열한다.

**4. 기술 결정 사항:** 구현 과정에서 확정해야 할 기술적 선택지를 식별한다:
- 모노레포 도구: pnpm workspace + Turborepo (확정)
- ESLint 룰셋 + Prettier 설정
- Vitest 설정 (워크스페이스별 또는 루트)
- TypeScript tsconfig 전략 (프로젝트 레퍼런스 vs 단일)
- SQLite WAL 모드 활성화 시점
- config.toml 파서 선택 (TOML 라이브러리)
- 데몬 프로세스 관리 (PID 파일 vs flock — v0.7에서 flock 확정)

**5. E2E 검증 시나리오:** v1.0-implementation-planning.md의 E2E 섹션을 확장한다. 각 시나리오에 [L0]~[L3] 또는 [HUMAN] 태그를 부여한다. v1.1은 [HUMAN] 0건이다. 시나리오를 더 세분화한다:
- waiaas init → 데이터 디렉토리 생성, config.toml 생성, 키스토어 초기화 [L0]
- waiaas start → 데몬 시작, health check 200 [L0]
- POST /v1/agents → 에이전트 생성 201 [L0]
- GET /v1/wallet/balance → SOL 잔액 반환 [L0]
- GET /v1/wallet/address → Solana 주소 반환 [L0]
- POST /v1/transactions → SOL 전송 요청, 상태 QUEUED [L0]
- GET /v1/transactions/:id → 폴링 후 CONFIRMED [L0]
- waiaas stop → 정상 종료, SQLite WAL 체크포인트 [L0]
- 잘못된 config.toml → 데몬 시작 실패 에러 메시지 [L0]
- 존재하지 않는 에이전트 → 404 [L0]

**6. 의존:** 없음 (첫 번째 구현 마일스톤)

**7. 리스크:**
- sodium-native + better-sqlite3 네이티브 addon 빌드 호환성 (v0.7 prebuildify 전략 설계 완료, 구현 시 검증 필요)
- Solana RPC 로컬 validator 테스트 환경 안정성
- SQLite WAL 모드 동시 접근 제한 (단일 프로세스 사용이므로 낮은 리스크)

**작성 규칙:**
- 한글로 작성
- v1.0-implementation-planning.md의 내용을 복제하지 않고, 참조하면서 구체적 구현 범위를 확장
- 설계 문서 번호와 이름을 정확히 기재
- 각 E2E 시나리오에 자동화 수준 태그 필수
- 구현하지 않는 범위를 명시적으로 기술 (어느 마일스톤에서 다루는지)
  </action>
  <verify>
- objectives/v1.1-core-infrastructure.md 파일이 존재한다
- 문서에 "## 목표", "## 구현 대상 설계 문서", "## 산출물", "## 기술 결정 사항", "## E2E 검증 시나리오", "## 의존", "## 리스크" 7개 섹션이 모두 존재한다
- 구현 대상 설계 문서 테이블에 9개 문서(24, 25, 26, 27, 28, 29, 31, 45, 54)가 나열된다
- E2E 검증 시나리오에 [L0] 태그가 부여되고, [HUMAN] 항목이 0건이다
- REST API 6개 엔드포인트가 산출물에 명시된다
  </verify>
  <done>objectives/v1.1-core-infrastructure.md가 부록 구조를 완전히 갖추고, 9개 설계 문서의 구현 범위(전체/부분)가 명시되며, 10개 이상 E2E 검증 시나리오에 자동화 수준 태그가 부여된 상태</done>
</task>

<task type="auto">
  <name>Task 2: v1.2 인증 + 정책 엔진 objective 문서 생성</name>
  <files>objectives/v1.2-auth-policy-engine.md</files>
  <action>
objectives/v1.0-implementation-planning.md의 "v1.2 — 인증 + 정책 엔진" 섹션을 기반으로, 부록 템플릿 구조에 맞는 완전한 objective 문서를 생성한다. 한글로 작성한다.

**1. 목표:** "세션 인증으로 에이전트 접근을 제어하고, 금액별 4-tier 정책이 동작하며, Owner가 고액 거래를 승인/거부할 수 있는 상태"

**2. 구현 대상 설계 문서:** 아래 설계 문서를 읽고 각각의 구현 범위를 테이블로 정리한다:
- 30 (session-token-protocol) — 전체: JWT HS256 발급/검증, SIWS/SIWE, SessionConstraints
- 32 (transaction-pipeline) — 부분: Stage 2(인증 검증), Stage 3(정책 평가 4-tier), Stage 4(DELAY/APPROVAL 대기) 완성 (Stage 1/5/6은 v1.1 골격 + v1.4 확장)
- 33 (time-lock-approval) — 전체: DatabasePolicyEngine, 4-tier, TOCTOU 방지, APPROVAL 타임아웃 3단계 우선순위
- 34 (owner-wallet-connection) — 전체: WalletConnect v2, ownerAuth, Owner API
- 52 (auth-model-redesign) — 전체: 3-tier 인증 책임 분리
- 53 (session-renewal-protocol) — 전체: 낙관적 갱신, 5종 안전 장치, token_hash CAS
- 29 (api-framework) — 부분: 미들웨어 7~8 (rateLimiter, authRouter 완성)

v0.8 설계(Owner 선택적 등록, owner_address nullable)와 v0.10 설계(APPROVAL 타임아웃 3단계 우선순위 PLCY-01/03, GRACE->LOCKED 전이 PLCY-02, 세션 갱신 token_hash CAS CONC-02)도 구현 범위에 포함한다.

각 문서에서 v1.2에서 구현할 구체적 범위와 구현하지 않는 범위를 상세히 기술한다.

**3. 산출물:** v1.0-implementation-planning.md의 산출물 테이블을 확장한다:
- sessionAuth: JWT HS256 발급/검증, wai_sess_ 접두사, SessionConstraints DB 조회
- masterAuth: Argon2id 검증, X-Master-Password 헤더 (localhost only)
- ownerAuth: SIWS/SIWE per-request 서명 검증, replay nonce
- DatabasePolicyEngine: 4-tier (INSTANT/NOTIFY/DELAY/APPROVAL), policies 테이블 Zod 규칙
- DELAY Worker: 15분 쿨다운, 10초 폴링, Owner 취소 가능
- APPROVAL Worker: 3단계 타임아웃(정책별>config>3600초), 30초 폴링, Owner SIWS/SIWE 서명
- TOCTOU 방지: BEGIN IMMEDIATE + reserved_amount
- Owner API: approve/reject, sessions list/revoke, status (8 엔드포인트)
- 세션 관리: 생성/조회/해지/갱신, 낙관적 갱신, token_hash CAS (RENEWAL_CONFLICT 409)
- Rate Limiter 2단계: 미인증/인증 분리 (v0.7 설계)
- authRouter: masterAuth/ownerAuth/sessionAuth 라우트 분기

각 컴포넌트의 주요 인터페이스/클래스와 핵심 메서드를 기술한다.

**4. 기술 결정 사항:**
- Owner 서명 검증: SIWS(@solana/wallet-standard) vs SIWE(viem/siwe) 라이브러리 확정
- WalletConnect v2 vs CLI 수동 서명 우선순위
- DELAY/APPROVAL Worker 구현: setInterval vs setTimeout 재귀
- 정책 규칙 스키마: Zod superRefine 패턴 확정
- JWT Secret dual-key 로테이션: 5분 윈도우 구현 방식
- Owner 상태(NONE/GRACE/LOCKED) resolveOwnerState() 위치

**5. E2E 검증 시나리오:** v1.0-implementation-planning.md의 E2E 섹션을 확장한다. v1.2도 [HUMAN] 0건이다:
- 마스터 패스워드로 세션 토큰 발급 → JWT 반환 [L0]
- 세션 토큰으로 API 호출 → 인증 성공 200 [L0]
- 만료된 세션 토큰 → 401 거부 [L0]
- 세션 갱신 (PUT /renew) → 새 토큰 반환 [L0]
- 세션 갱신 동시 요청 → RENEWAL_CONFLICT 409 [L0]
- 소액(0.01 SOL) 전송 → INSTANT → 즉시 실행 → CONFIRMED [L0]
- 중액(5 SOL) 전송 → DELAY → 대기 → 자동 실행 [L0] (타이머 단축)
- 고액(100 SOL) 전송 → APPROVAL → 서명 승인 → 실행 [L0] (테스트 키 자동 서명)
- APPROVAL 타임아웃 → REJECTED [L0]
- Owner 미등록 에이전트 → APPROVAL 비활성, DELAY 다운그레이드 [L0]
- Owner 등록 (NONE→GRACE) → 정책 활성화 [L0]
- Owner API: 대기 중 트랜잭션 approve/reject [L0]
- Owner API: 세션 목록 조회 + 특정 세션 해지 [L0]
- Rate Limiter 초과 → 429 [L0]
- TOCTOU 방어: reserved_amount 확인 [L0]
- Kill Switch 활성 중 → 모든 요청 503 [L0]

**6. 의존:** v1.1 (코어 인프라)

**7. 리스크:**
- DELAY/APPROVAL 타이머 테스트 안정성 (테스트 시 타임아웃 단축 필요)
- WalletConnect v2 Reown SDK 호환성 (Tauri 전용이므로 v1.2에서는 CLI 수동 서명만)
- Owner 상태 전이 edge case (GRACE→LOCKED 타이밍)
- 정책 규칙 Zod 스키마 복잡도 (PolicyType 10개 + superRefine)

**작성 규칙:**
- 한글로 작성
- v0.8(Owner 선택적), v0.10(APPROVAL 타임아웃, GRACE→LOCKED, token_hash CAS) 설계를 반드시 반영
- 설계 문서 번호와 이름을 정확히 기재
- 각 E2E 시나리오에 자동화 수준 태그 필수
- v1.1에서 이미 구현된 부분과 v1.2에서 새로 추가하는 부분을 구분
  </action>
  <verify>
- objectives/v1.2-auth-policy-engine.md 파일이 존재한다
- 문서에 7개 섹션(목표, 구현 대상 설계 문서, 산출물, 기술 결정 사항, E2E 검증 시나리오, 의존, 리스크)이 모두 존재한다
- 구현 대상 설계 문서 테이블에 7개 문서(30, 32, 33, 34, 52, 53, 29)가 나열된다
- E2E 검증 시나리오에 [L0] 태그가 부여되고, [HUMAN] 항목이 0건이다
- Owner 미등록 시 APPROVAL 비활성 시나리오가 포함된다
- v0.8, v0.10 설계 결정이 구현 범위에 반영된다
  </verify>
  <done>objectives/v1.2-auth-policy-engine.md가 부록 구조를 완전히 갖추고, 7개 설계 문서의 구현 범위가 명시되며, 16개 이상 E2E 검증 시나리오에 자동화 수준 태그가 부여되고, Owner 미등록 시 APPROVAL 비활성/DELAY 다운그레이드 시나리오가 포함된 상태</done>
</task>

</tasks>

<verification>
1. objectives/v1.1-core-infrastructure.md 존재 + 7개 섹션 구조 확인
2. objectives/v1.2-auth-policy-engine.md 존재 + 7개 섹션 구조 확인
3. 두 문서 모두 설계 문서 테이블에 전체/부분 구분이 명시되어 있음
4. 모든 E2E 검증 시나리오에 [L0]~[L3] 또는 [HUMAN] 태그가 부여됨
5. v1.1의 [HUMAN] 0건, v1.2의 [HUMAN] 0건
6. v1.2에 Owner 미등록 시 APPROVAL 비활성 시나리오 포함
7. 두 문서의 산출물이 v1.0-implementation-planning.md의 내용을 포함하면서 확장함
</verification>

<success_criteria>
- objectives/v1.1-core-infrastructure.md: 설계 문서 9개 참조, 패키지 5개 + REST API 6개 산출물, E2E 10개+ 시나리오, [HUMAN] 0건
- objectives/v1.2-auth-policy-engine.md: 설계 문서 7개 참조, 컴포넌트 11개 산출물, E2E 16개+ 시나리오, [HUMAN] 0건, Owner 미등록 시나리오 포함
- 두 문서 모두 부록 구조(7개 섹션) 완전 준수
</success_criteria>

<output>
After completion, create `.planning/phases/45-core-impl-objectives/45-01-SUMMARY.md`
</output>
