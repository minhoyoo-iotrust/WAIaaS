---
phase: 45-core-impl-objectives
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - objectives/v1.3-sdk-mcp-notifications.md
  - objectives/v1.4-token-contract-extension.md
autonomous: true

must_haves:
  truths:
    - "v1.3 objective 문서가 설계 문서 35, 37-38, 55 + v0.9 SessionManager를 참조하고, TS/Python SDK + MCP 6+3 도구 + 3채널 알림 구현 범위와 MCP 세션 자동 갱신 E2E 시나리오를 포함한다"
    - "v1.4 objective 문서가 설계 문서 27, 36, 56-60을 참조하고, SPL/ERC-20 토큰 + 컨트랙트 호출 + Approve + 배치 + EVM 어댑터 구현 범위를 정의하며, Stage 5 완전 의사코드 기반 E2E 시나리오를 포함한다"
    - "두 문서 모두 부록 구조(목표, 구현 대상 설계 문서, 산출물, 기술 결정 사항, E2E 검증 시나리오, 의존, 리스크)를 갖추고, 각 E2E 시나리오에 [L0]~[L3] 또는 [HUMAN] 태그가 부여된다"
  artifacts:
    - path: "objectives/v1.3-sdk-mcp-notifications.md"
      provides: "v1.3 SDK + MCP + 알림 마일스톤 objective"
      contains: "## 목표"
    - path: "objectives/v1.4-token-contract-extension.md"
      provides: "v1.4 토큰 + 컨트랙트 확장 마일스톤 objective"
      contains: "## 목표"
  key_links:
    - from: "objectives/v1.3-sdk-mcp-notifications.md"
      to: "objectives/v1.0-implementation-planning.md"
      via: "v1.3 섹션 확장"
      pattern: "v1\\.3.*SDK.*MCP"
    - from: "objectives/v1.4-token-contract-extension.md"
      to: "objectives/v1.0-implementation-planning.md"
      via: "v1.4 섹션 확장"
      pattern: "v1\\.4.*토큰.*컨트랙트"
---

<objective>
v1.3(SDK + MCP + 알림)과 v1.4(토큰 + 컨트랙트 확장) 마일스톤의 objective 문서 2개를 생성한다.

Purpose: v1.3은 AI 에이전트가 실제로 지갑을 사용하는 인터페이스(SDK, MCP)와 Owner 알림 채널을 정의하고, v1.4는 토큰/컨트랙트/배치 등 블록체인 기능 확장과 EVM 어댑터 본격 가동을 정의하여, 구현 시 해석 여지를 제거한다.
Output: objectives/v1.3-sdk-mcp-notifications.md, objectives/v1.4-token-contract-extension.md
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.0-implementation-planning.md

설계 문서 참조 (v1.3 대상):
@.planning/deliverables/35-notification-architecture.md
@.planning/deliverables/37-rest-api-complete-spec.md
@.planning/deliverables/38-sdk-mcp-interface.md
@.planning/deliverables/55-dx-improvement-spec.md

v0.9 SessionManager 참조:
@objectives/v0.9-session-management-automation.md

설계 문서 참조 (v1.4 대상):
@.planning/deliverables/27-chain-adapter-interface.md
@.planning/deliverables/36-killswitch-autostop-evm.md
@docs/56-token-transfer-extension-spec.md
@docs/57-asset-query-fee-estimation-spec.md
@docs/58-contract-call-spec.md
@docs/59-approve-management-spec.md
@docs/60-batch-transaction-spec.md

v0.10 설계 결정 참조:
@objectives/v0.10-pre-implementation-design-completion.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: v1.3 SDK + MCP + 알림 objective 문서 생성</name>
  <files>objectives/v1.3-sdk-mcp-notifications.md</files>
  <action>
objectives/v1.0-implementation-planning.md의 "v1.3 — SDK + MCP + 알림" 섹션을 기반으로, 부록 템플릿 구조에 맞는 완전한 objective 문서를 생성한다. 한글로 작성한다.

**1. 목표:** "AI 에이전트가 TS/Python SDK 또는 MCP로 지갑을 사용하고, Owner가 Telegram/Discord로 알림을 받는 상태"

**2. 구현 대상 설계 문서:** 아래 설계 문서를 읽고 각각의 구현 범위를 테이블로 정리한다:
- 37 (rest-api-complete-spec) — 전체 완성: 38 엔드포인트 전체 (v1.1에서 6개 기본, v1.2에서 인증/정책 추가, v1.3에서 나머지 전체)
- 38 (sdk-mcp-interface) — 전체: TS SDK(WAIaaSClient), Python SDK(httpx+Pydantic), MCP Server(6 도구 + 3 리소스)
- 35 (notification-architecture) — 전체: INotificationChannel, 3채널(Telegram/Discord/ntfy.sh), 17 이벤트
- 55 (dx-improvement-spec) — 전체: hint 31/40, MCP 개선, 원격 접근

v0.9 설계(SessionManager, 토큰 파일 인프라, MCP 통합, CLI mcp setup, Telegram /newsession, SESSION_EXPIRING_SOON)를 참조하여 MCP 세션 자동 갱신 구현 범위를 명시한다.

각 문서에서 v1.3에서 구현할 구체적 범위를 상세히 기술한다. v1.1/v1.2에서 이미 구현된 REST API 엔드포인트와 v1.3에서 새로 추가하는 엔드포인트를 구분한다.

**3. 산출물:** v1.0-implementation-planning.md의 산출물 테이블을 확장한다:
- @waiaas/sdk: TypeScript SDK — 0 외부 의존성, WAIaaSClient 클래스, 주요 메서드(getBalance, sendToken, getTransactionStatus, listAgents 등)
- @waiaas/mcp: MCP Server — 6 도구(waiaas_get_balance, waiaas_send_token, waiaas_get_assets, waiaas_get_tx_status, waiaas_list_agents, waiaas_agent_info) + 3 리소스(wallet://balance, wallet://transactions, wallet://agents), stdio transport, SessionManager 통합
- Python SDK: httpx + Pydantic v2, pip 패키지, WAIaaSClient 동일 인터페이스
- 알림 시스템: INotificationChannel 인터페이스, TelegramChannel(MarkdownV2), DiscordChannel(Webhook), NtfyChannel(ntfy.sh), 17 이벤트 매핑
- REST API: v1.3에서 추가하는 엔드포인트 목록 (v1.1 6개 + v1.2 인증/정책 엔드포인트 이후 나머지)
- OpenAPI 3.0 자동 생성 스펙

각 패키지의 주요 파일/모듈 구조를 나열한다.

**4. 기술 결정 사항:**
- TypeScript SDK 빌드: ESM + CJS dual publish 또는 ESM-only
- Python SDK 패키징: pyproject.toml + hatch vs setuptools
- MCP Server: @modelcontextprotocol/sdk 버전 + stdio transport 구현
- 알림 채널 설정: config.toml에 채널별 credentials 위치
- OpenAPI 3.0 생성: Hono OpenAPI 미들웨어 vs 수동 스키마
- Python SDK 테스트: pytest + httpx mock 전략
- MCP 세션 자동 갱신: SessionManager 초기화 시점 (lazy vs eager)

**5. E2E 검증 시나리오:** v1.3은 [HUMAN] 1~2건이다:
- TypeScript: new WAIaaSClient(url) → getBalance() → 잔액 반환 [L0]
- TypeScript: sendToken({to, amount}) → 트랜잭션 ID 반환 → CONFIRMED 대기 [L0]
- TypeScript: 인증 실패 → WaiaasError 예외 + 에러 코드 [L0]
- Python: WAIaaSClient(url) → get_balance() → 잔액 반환 [L0]
- Python: send_token() → 트랜잭션 ID → 상태 폴링 [L0]
- MCP: stdio transport 연결 → tool 목록 조회 → 6 도구 확인 [L0]
- MCP: waiaas_get_balance 호출 → JSON 응답 [L0]
- MCP: waiaas_send_token 호출 → 트랜잭션 실행 [L0]
- MCP: 세션 만료 → SessionManager 자동 갱신 → 중단 없이 계속 [L0] (TTL 단축)
- MCP: 갱신 실패 → 에러 로그(stderr) + 재시도 [L0]
- 알림: SOL 전송 → TelegramChannel mock 수신 검증 [L0]
- 알림: APPROVAL 대기 → Discord webhook mock 검증 [L0]
- 알림: Kill Switch 활성화 → ntfy.sh mock 검증 [L0]
- 알림: SESSION_EXPIRING_SOON → 알림 발송 [L0]
- REST API: OpenAPI 스펙 엔드포인트 → 유효한 OpenAPI 3.0 JSON [L0]
- REST API: 38개 엔드포인트 전수 호출 → 정의된 응답 코드 [L0]
- [HUMAN] Claude Desktop에서 MCP 도구 실제 호출 확인 (UI 통합)

**6. 의존:** v1.2 (인증 + 정책 엔진)

**7. 리스크:**
- MCP SDK 버전 업데이트 속도 (API 변경 가능성)
- Python SDK 외부 의존성 관리 (httpx 버전 호환)
- 알림 채널 외부 API 의존성 (Telegram Bot API, Discord Webhook, ntfy.sh)
- Claude Desktop MCP 통합 테스트 자동화 불가 ([HUMAN] 항목)
- REST API 38개 엔드포인트 전수 구현 범위 확인 (v1.1/v1.2 구현분과 중복 없이)

**작성 규칙:**
- 한글로 작성
- v0.9 SessionManager 설계를 반드시 반영 (자동 갱신, 토큰 파일, MCP 통합)
- 설계 문서 번호와 이름을 정확히 기재
- 각 E2E 시나리오에 자동화 수준 태그 필수
- v1.1/v1.2에서 이미 구현된 부분과 v1.3에서 새로 추가하는 부분을 구분
  </action>
  <verify>
- objectives/v1.3-sdk-mcp-notifications.md 파일이 존재한다
- 문서에 7개 섹션(목표, 구현 대상 설계 문서, 산출물, 기술 결정 사항, E2E 검증 시나리오, 의존, 리스크)이 모두 존재한다
- 구현 대상 설계 문서 테이블에 4개 문서(35, 37, 38, 55) + v0.9 SessionManager 참조가 나열된다
- E2E 검증 시나리오에 [L0] 태그가 부여되고, [HUMAN] 항목이 1~2건이다
- MCP 세션 자동 갱신 E2E 시나리오가 포함된다
- 산출물에 TS SDK, Python SDK, MCP Server, 알림 시스템, REST API가 모두 포함된다
  </verify>
  <done>objectives/v1.3-sdk-mcp-notifications.md가 부록 구조를 완전히 갖추고, 4개 설계 문서 + v0.9 SessionManager의 구현 범위가 명시되며, 17개 이상 E2E 검증 시나리오에 자동화 수준 태그가 부여되고, MCP 세션 자동 갱신 시나리오가 포함된 상태</done>
</task>

<task type="auto">
  <name>Task 2: v1.4 토큰 + 컨트랙트 확장 objective 문서 생성</name>
  <files>objectives/v1.4-token-contract-extension.md</files>
  <action>
objectives/v1.0-implementation-planning.md의 "v1.4 — 토큰 + 컨트랙트 확장" 섹션을 기반으로, 부록 템플릿 구조에 맞는 완전한 objective 문서를 생성한다. 한글로 작성한다.

**1. 목표:** "SPL/ERC-20 토큰 전송, 자산 조회, 스마트 컨트랙트 호출, Approve 관리, 배치 트랜잭션이 동작하며, EVM 어댑터가 본격 가동되는 상태"

**2. 구현 대상 설계 문서:** 아래 설계 문서를 읽고 각각의 구현 범위를 테이블로 정리한다:
- 56 (token-transfer-extension) — 전체: SPL/ERC-20, ALLOWED_TOKENS 정책
- 57 (asset-query-fee-estimation) — 전체: getAssets(), 수수료 추정
- 58 (contract-call-spec) — 전체: ContractCallRequest, CONTRACT_WHITELIST
- 59 (approve-management-spec) — 전체: ApproveRequest, 3 approve 정책
- 60 (batch-transaction-spec) — 전체: Solana 원자적 배치, 부모-자식 2계층 DB
- 36 (killswitch-autostop-evm) — 부분: EVM 어댑터 본격 구현 (Kill Switch/AutoStop은 v1.6)
- 27 (chain-adapter-interface) — 완성: IChainAdapter 20 메서드 전체 구현 (v1.1에서 6개, 나머지 14개 추가)

v0.10 설계를 반드시 반영한다:
- Stage 5 완전 의사코드 CONC-01 (build→simulate→sign→submit + 에러 분기 + TRANSIENT 재시도)
- ChainError 3-카테고리 ERRH-02 (PERMANENT 17/TRANSIENT 4/STALE 4, category→retryable 자동 파생)
- Batch 부모-자식 2계층 DB OPER-02 (metadata JSON→정규화, ON DELETE CASCADE, PARTIAL_FAILURE)
- PolicyType 10개 확장 + superRefin ERRH-03
- discriminatedUnion 5-type Stage 1 확장

각 문서에서 v1.4에서 구현할 구체적 범위를 상세히 기술한다.

**3. 산출물:** v1.0-implementation-planning.md의 산출물 테이블을 확장한다:
- 토큰 전송: TransferRequest.token 필드, SPL(getTransferCheckedInstruction), ERC-20(transfer)
- 자산 조회: getAssets() — Solana getTokenAccountsByOwner, EVM 멀티콜 패턴
- ALLOWED_TOKENS: 에이전트별 토큰 화이트리스트 정책
- ContractCallRequest: EVM calldata, Solana programId+instructionData+accounts
- CONTRACT_WHITELIST: 기본 전면 거부, opt-in 화이트리스트
- ApproveRequest: 독립 타입, APPROVED_SPENDERS/AMOUNT_LIMIT/TIER_OVERRIDE 3 정책
- BatchRequest: Solana 원자적 배치 (min2/max20), 2단계 정책 합산, 부모-자식 DB+PARTIAL_FAILURE
- @waiaas/adapter-evm: EVM 어댑터 — viem 2.x, EIP-1559, ERC-20, gas 추정
- 파이프라인 확장: Stage 1 discriminatedUnion 5-type, Stage 3 11단계 평가, Stage 5 완전 의사코드
- ChainError: 3-카테고리(PERMANENT/TRANSIENT/STALE), category→retryable 자동 파생
- IChainAdapter 나머지 14개 메서드: getAssets, buildTokenTransfer, buildContractCall, buildApprove, buildBatch, getTransactionFee, estimateGas, getTokenInfo, getContractInfo, sweepAll 등

각 컴포넌트의 주요 인터페이스와 핵심 메서드를 기술한다.

**4. 기술 결정 사항:**
- EVM 테스트 노드: Hardhat vs Anvil (Foundry) 선택
- Solana SPL 토큰 테스트: solana-test-validator + SPL token create
- ERC-20 토큰 테스트: Hardhat 로컬 배포
- 배치 트랜잭션 DB 스키마: batch_items 테이블 정규화 수준
- ChainError 코드: 25개 에러 코드 최종 확정
- Stage 5 재시도: 지수 백오프 파라미터 (초기 1초, 최대 3회)
- EVM gas 추정: viem estimateGas vs 고정 배수(1.2x)
- CONTRACT_WHITELIST 저장: DB 테이블 vs config.toml

**5. E2E 검증 시나리오:** v1.4는 [HUMAN] 0건이다:
- USDC 전송 (SPL) → CONFIRMED [L1] (solana-test-validator)
- USDC 전송 (ERC-20) → CONFIRMED [L1] (Hardhat)
- getAssets() → SOL + USDC + BONK 잔액 반환 [L0] (mock RPC)
- getAssets() (EVM) → ETH + USDC 잔액 반환 [L0] (mock RPC)
- 미허용 토큰 전송 → ALLOWED_TOKENS 거부 → 에러 코드 [L0]
- 컨트랙트 호출 (허용된 주소) → 실행 → CONFIRMED [L1] (Hardhat/validator)
- 미허용 컨트랙트 호출 → CONTRACT_WHITELIST 거부 → 에러 코드 [L0]
- Approve 요청 → 독립 정책 평가 → APPROVED_SPENDERS 검증 [L0]
- Approve 무제한 금액 요청 → 차단 [L0]
- Solana 3-instruction 배치 → 원자적 실행 → CONFIRMED [L1] (validator)
- 배치 부분 실패 (EVM) → PARTIAL_FAILURE 상태 + 자식 트랜잭션 상태 [L0]
- EVM ETH 전송 → CONFIRMED [L1] (Hardhat)
- EVM ERC-20 전송 → CONFIRMED [L1] (Hardhat)
- Stage 5 TRANSIENT 에러 → 재시도 → 성공 [L0] (mock adapter)
- Stage 5 PERMANENT 에러 → 즉시 FAILED → 에러 코드 [L0]
- Stage 5 STALE blockhash → 갱신 → 재시도 [L0] (mock adapter)
- discriminatedUnion: TransferRequest/ContractCallRequest/ApproveRequest/BatchRequest/NativeTransferRequest 각각 파싱 [L0]
- IChainAdapter 20 메서드 전수: 각 어댑터(Solana/EVM)에서 호출 가능 [L0]

**6. 의존:** v1.3 (SDK + MCP + 알림)

**7. 리스크:**
- EVM 어댑터 viem 2.x API 변경 가능성
- Solana SPL 토큰 프로그램 API 변경 (@solana-program/token 호환성)
- 배치 트랜잭션 Solana 크기 제한 (1232 바이트 패킷)
- PARTIAL_FAILURE 상태 복구 UX (사용자가 부분 실패를 어떻게 처리하는지)
- ChainError 25개 코드 실제 체인 에러와의 매핑 정확도
- Stage 5 의사코드 구현 복잡도 (build→simulate→sign→submit→에러 분기→재시도 경로 수)

**작성 규칙:**
- 한글로 작성
- v0.10 설계 결정(Stage 5, ChainError, Batch 2계층 DB, PolicyType 10개)을 반드시 반영
- 설계 문서 번호와 이름을 정확히 기재
- 각 E2E 시나리오에 자동화 수준 태그 필수
- v1.1~v1.3에서 이미 구현된 부분과 v1.4에서 새로 추가/확장하는 부분을 구분
- Stage 5 완전 의사코드의 주요 분기 경로를 E2E 시나리오에 반영
  </action>
  <verify>
- objectives/v1.4-token-contract-extension.md 파일이 존재한다
- 문서에 7개 섹션(목표, 구현 대상 설계 문서, 산출물, 기술 결정 사항, E2E 검증 시나리오, 의존, 리스크)이 모두 존재한다
- 구현 대상 설계 문서 테이블에 7개 문서(56, 57, 58, 59, 60, 36, 27)가 나열된다
- E2E 검증 시나리오에 [L0]/[L1] 태그가 부여되고, [HUMAN] 항목이 0건이다
- Stage 5 완전 의사코드 기반 시나리오(TRANSIENT 재시도, PERMANENT 실패, STALE 갱신)가 포함된다
- v0.10 설계 결정이 구현 범위에 반영된다
  </verify>
  <done>objectives/v1.4-token-contract-extension.md가 부록 구조를 완전히 갖추고, 7개 설계 문서의 구현 범위가 명시되며, 18개 이상 E2E 검증 시나리오에 자동화 수준 태그가 부여되고, Stage 5 의사코드 기반 TRANSIENT/PERMANENT/STALE 시나리오가 포함된 상태</done>
</task>

</tasks>

<verification>
1. objectives/v1.3-sdk-mcp-notifications.md 존재 + 7개 섹션 구조 확인
2. objectives/v1.4-token-contract-extension.md 존재 + 7개 섹션 구조 확인
3. 두 문서 모두 설계 문서 테이블에 전체/부분 구분이 명시되어 있음
4. 모든 E2E 검증 시나리오에 [L0]~[L3] 또는 [HUMAN] 태그가 부여됨
5. v1.3의 [HUMAN] 1~2건 (Claude Desktop MCP), v1.4의 [HUMAN] 0건
6. v1.3에 MCP 세션 자동 갱신 E2E 시나리오 포함
7. v1.4에 Stage 5 완전 의사코드 기반 분기 시나리오 포함
8. 두 문서의 산출물이 v1.0-implementation-planning.md의 내용을 포함하면서 확장함
</verification>

<success_criteria>
- objectives/v1.3-sdk-mcp-notifications.md: 설계 문서 4개 + v0.9 참조, 패키지 4개 + REST API 전수 산출물, E2E 17개+ 시나리오, [HUMAN] 1~2건, MCP 세션 자동 갱신 포함
- objectives/v1.4-token-contract-extension.md: 설계 문서 7개 참조, 컴포넌트 11개+ 산출물, E2E 18개+ 시나리오, [HUMAN] 0건, Stage 5 분기 시나리오 포함
- 두 문서 모두 부록 구조(7개 섹션) 완전 준수
</success_criteria>

<output>
After completion, create `.planning/phases/45-core-impl-objectives/45-02-SUMMARY.md`
</output>
