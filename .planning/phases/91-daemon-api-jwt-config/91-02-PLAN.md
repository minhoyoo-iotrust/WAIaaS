---
phase: 91-daemon-api-jwt-config
plan: 02
type: execute
wave: 2
depends_on: ["91-01"]
files_modified:
  - packages/daemon/src/__tests__/api-agents.test.ts
  - packages/daemon/src/__tests__/api-sessions.test.ts
  - packages/daemon/src/__tests__/api-session-renewal.test.ts
  - packages/daemon/src/__tests__/api-transactions.test.ts
  - packages/daemon/src/__tests__/api-policies.test.ts
  - packages/daemon/src/__tests__/api-admin-endpoints.test.ts
  - packages/daemon/src/__tests__/api-server.test.ts
  - packages/daemon/src/__tests__/api-new-endpoints.test.ts
  - packages/daemon/src/__tests__/api-hint-field.test.ts
  - packages/daemon/src/__tests__/session-auth.test.ts
  - packages/daemon/src/__tests__/jwt-secret-manager.test.ts
  - packages/daemon/src/__tests__/config-loader.test.ts
  - packages/daemon/src/__tests__/pipeline.test.ts
  - packages/daemon/src/__tests__/pipeline-integration.test.ts
  - packages/daemon/src/__tests__/pipeline-notification.test.ts
  - packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts
  - packages/daemon/src/__tests__/pipeline-stage4.test.ts
  - packages/daemon/src/__tests__/pipeline-stage5-execute.test.ts
  - packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts
  - packages/daemon/src/__tests__/database-policy-engine.test.ts
  - packages/daemon/src/__tests__/database.test.ts
  - packages/daemon/src/__tests__/owner-state.test.ts
  - packages/daemon/src/__tests__/approval-workflow.test.ts
  - packages/daemon/src/__tests__/delay-queue.test.ts
  - packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts
  - packages/daemon/src/__tests__/workflow-owner-e2e.test.ts
  - packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts
  - packages/daemon/src/__tests__/owner-auth.test.ts
  - packages/daemon/src/__tests__/owner-auth-siwe.test.ts
  - packages/daemon/src/__tests__/keystore.test.ts
  - packages/daemon/src/__tests__/notification-service.test.ts
  - packages/daemon/src/__tests__/notification-channels.test.ts
  - packages/daemon/src/__tests__/notification-log.test.ts
  - packages/daemon/src/__tests__/route-notification.test.ts
  - packages/daemon/src/__tests__/admin-notification-api.test.ts
  - packages/daemon/src/__tests__/admin-serving.test.ts
  - packages/daemon/src/__tests__/auth-coverage-audit.test.ts
  - packages/daemon/src/__tests__/policy-engine-coverage-audit.test.ts
  - packages/daemon/src/__tests__/migration-runner.test.ts
autonomous: true

must_haves:
  truths:
    - "All daemon tests compile with tsc --noEmit"
    - "pnpm test --filter daemon passes (same count as before, no regressions)"
    - "Zero agentId/agentCount/agt references in daemon test files (except intentional legacy/migration test data)"
    - "Test assertions use walletId in response bodies and JWT claims"
  artifacts:
    - path: "packages/daemon/src/__tests__/api-agents.test.ts"
      provides: "Wallet CRUD API tests with /v1/wallets paths"
      contains: "wallets"
    - path: "packages/daemon/src/__tests__/session-auth.test.ts"
      provides: "Session auth tests with wlt JWT claim"
      contains: "wlt"
    - path: "packages/daemon/src/__tests__/config-loader.test.ts"
      provides: "Config tests with max_sessions_per_wallet"
      contains: "max_sessions_per_wallet"
  key_links:
    - from: "packages/daemon/src/__tests__/api-agents.test.ts"
      to: "packages/daemon/src/api/routes/wallets.ts"
      via: "HTTP requests to /v1/wallets endpoints"
      pattern: "/v1/wallets"
    - from: "packages/daemon/src/__tests__/jwt-secret-manager.test.ts"
      to: "packages/daemon/src/infrastructure/jwt/jwt-secret-manager.ts"
      via: "JwtPayload with wlt claim"
      pattern: "wlt"
---

<objective>
Update all ~37 daemon test files to wallet terminology: imports, test data, assertions, API paths, JWT claims, config keys. Ensure full daemon test suite passes.

Purpose: Complete Phase 91 by ensuring test suite validates the wallet-renamed API, JWT, and config. Without test updates, the daemon test suite cannot compile or pass.

Output: ~37 test files updated, daemon test suite passes with same count as before, zero agent terminology in test files.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/91-daemon-api-jwt-config/91-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update API/route test files (12 files)</name>
  <files>
    packages/daemon/src/__tests__/api-agents.test.ts
    packages/daemon/src/__tests__/api-sessions.test.ts
    packages/daemon/src/__tests__/api-session-renewal.test.ts
    packages/daemon/src/__tests__/api-transactions.test.ts
    packages/daemon/src/__tests__/api-policies.test.ts
    packages/daemon/src/__tests__/api-admin-endpoints.test.ts
    packages/daemon/src/__tests__/api-server.test.ts
    packages/daemon/src/__tests__/api-new-endpoints.test.ts
    packages/daemon/src/__tests__/api-hint-field.test.ts
    packages/daemon/src/__tests__/auth-coverage-audit.test.ts
    packages/daemon/src/__tests__/admin-serving.test.ts
    packages/daemon/src/__tests__/admin-notification-api.test.ts
  </files>
  <action>
    Systematic rename across all 12 API/route test files. For each file apply ALL of:

    **Import renames:**
    - `import { agents } from '../infrastructure/database/schema.js'` -> `import { wallets } from '../infrastructure/database/schema.js'`
    - `import { agentRoutes }` -> `import { walletCrudRoutes }` from `'../api/routes/wallets.js'` (was `agents.js`)
    - Any `CreateAgentRequestSchema` -> `CreateWalletRequestSchema` (from @waiaas/core)

    **API path renames in HTTP requests:**
    - `'/v1/agents'` -> `'/v1/wallets'`
    - `'/v1/agents/${id}'` -> `'/v1/wallets/${id}'`
    - `'/v1/agents/${id}/owner'` -> `'/v1/wallets/${id}/owner'`
    - All `app.request('/v1/agents...')` calls updated

    **DB operations in test setup/helpers:**
    - `db.insert(agents)` -> `db.insert(wallets)`
    - `db.select().from(agents)` -> `db.select().from(wallets)`
    - `agents.id`, `agents.status` etc. -> `wallets.id`, `wallets.status`

    **Test data/fixtures:**
    - `agentId` variable names -> `walletId`
    - `{ agentId: ... }` in request bodies -> `{ walletId: ... }` (for CreateSession, etc.)
    - `createApp({ ... })` deps: use renamed types/functions

    **Assertion renames:**
    - `expect(body.agentId)` -> `expect(body.walletId)`
    - `expect(body.agentCount)` -> `expect(body.walletCount)`
    - `expect(body).toHaveProperty('agentId')` -> `expect(body).toHaveProperty('walletId')`

    **JWT claim:**
    - `{ agt: agentId }` -> `{ wlt: walletId }` in JWT payload construction
    - `payload.agt` -> `payload.wlt` in assertions

    **Config:**
    - `max_sessions_per_agent` -> `max_sessions_per_wallet` in config fixtures

    **Error messages (in string assertions):**
    - `'Agent '...` -> `'Wallet '...` if tests assert on error messages

    **Special file notes:**
    - `api-agents.test.ts`: This is the main CRUD test for /v1/agents -> /v1/wallets. Most changes here.
    - `api-admin-endpoints.test.ts`: Has agentCount assertion
    - `api-sessions.test.ts`: Has agentId in query params, request bodies, response assertions
    - `auth-coverage-audit.test.ts`: May have path assertions for /v1/agents
    - `admin-notification-api.test.ts`: May have agentId in notification log assertions
    - `admin-serving.test.ts`: May reference agent count

    **Migration test exception:** `migration-runner.test.ts` intentionally tests old agent->wallet migration. It should retain `agents` references in migration test data/assertions that verify the migration itself. Only update non-migration-specific references (like imports, or where it uses post-migration schema).

    Run `npx tsc --noEmit -p packages/daemon/tsconfig.json 2>&1 | grep -c '__tests__.*error'` after changes to track remaining errors.
  </action>
  <verify>
    `grep -rn 'agentId\|agentCount\|agentRoutes\|AgentRouteDeps\|from.*agents\.js\|from(agents)' packages/daemon/src/__tests__/api-*.test.ts packages/daemon/src/__tests__/auth-coverage-audit.test.ts packages/daemon/src/__tests__/admin-*.test.ts` -- 0 results (excluding migration-specific test data)
  </verify>
  <done>
    12 API/route test files updated to wallet terminology. All import paths, API paths, assertions, and test data use walletId/walletCount/wallets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update infrastructure/pipeline/workflow test files (25+ files) + run full test suite</name>
  <files>
    packages/daemon/src/__tests__/session-auth.test.ts
    packages/daemon/src/__tests__/jwt-secret-manager.test.ts
    packages/daemon/src/__tests__/config-loader.test.ts
    packages/daemon/src/__tests__/pipeline.test.ts
    packages/daemon/src/__tests__/pipeline-integration.test.ts
    packages/daemon/src/__tests__/pipeline-notification.test.ts
    packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts
    packages/daemon/src/__tests__/pipeline-stage4.test.ts
    packages/daemon/src/__tests__/pipeline-stage5-execute.test.ts
    packages/daemon/src/__tests__/pipeline-5type-e2e.test.ts
    packages/daemon/src/__tests__/database-policy-engine.test.ts
    packages/daemon/src/__tests__/database.test.ts
    packages/daemon/src/__tests__/owner-state.test.ts
    packages/daemon/src/__tests__/approval-workflow.test.ts
    packages/daemon/src/__tests__/delay-queue.test.ts
    packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts
    packages/daemon/src/__tests__/workflow-owner-e2e.test.ts
    packages/daemon/src/__tests__/evm-lifecycle-e2e.test.ts
    packages/daemon/src/__tests__/owner-auth.test.ts
    packages/daemon/src/__tests__/owner-auth-siwe.test.ts
    packages/daemon/src/__tests__/keystore.test.ts
    packages/daemon/src/__tests__/notification-service.test.ts
    packages/daemon/src/__tests__/notification-channels.test.ts
    packages/daemon/src/__tests__/notification-log.test.ts
    packages/daemon/src/__tests__/route-notification.test.ts
    packages/daemon/src/__tests__/policy-engine-coverage-audit.test.ts
    packages/daemon/src/__tests__/migration-runner.test.ts
  </files>
  <action>
    Systematic rename across all remaining ~27 test files, same pattern as Task 1:

    **Import renames:**
    - `import { agents }` -> `import { wallets }` from schema
    - Any `PipelineContext` usage with `agentId` -> `walletId`

    **Variable renames:**
    - `agentId` -> `walletId` (local variables, mock data, test fixtures)
    - `const agent = ...` -> `const wallet = ...` where referring to DB row or test fixture

    **DB operations:**
    - `db.insert(agents)` -> `db.insert(wallets)`, `.from(agents)` -> `.from(wallets)`
    - Column access: `agents.id` -> `wallets.id`, `agents.status` -> `wallets.status`
    - Insert values: `agentId: ...` -> `walletId: ...` for sessions/transactions/policies inserts

    **JWT/session-auth tests:**
    - `session-auth.test.ts`: `payload.agt` -> `payload.wlt`, JWT mock payload `{ agt: ... }` -> `{ wlt: ... }`, `c.get('agentId')` assertions -> `c.get('walletId')`
    - `jwt-secret-manager.test.ts`: JwtPayload construction `{ agt: ... }` -> `{ wlt: ... }`, verification assertions

    **Config tests:**
    - `config-loader.test.ts`: `max_sessions_per_agent` -> `max_sessions_per_wallet` in all fixtures and assertions

    **Pipeline tests (7 files):**
    - `PipelineContext` mock: `agentId` -> `walletId`
    - `ctx.agentId` -> `ctx.walletId` in all setup/assertions
    - DB insert agent fixtures: `.insert(wallets).values(...)` with `walletId` references
    - Transaction inserts: `agentId` -> `walletId` column
    - Notification mock assertions: second arg check for walletId

    **Workflow tests (approval, delay-queue, owner-state, owner-e2e, session-lifecycle-e2e, evm-lifecycle-e2e):**
    - Same pattern: agents -> wallets, agentId -> walletId in all DB operations and assertions

    **Database test:**
    - `database.test.ts`: agents -> wallets table operations, column refs

    **Notification tests:**
    - `notification-service.test.ts`, `notification-channels.test.ts`, `notification-log.test.ts`, `route-notification.test.ts`: agentId -> walletId in test data and assertions

    **migration-runner.test.ts SPECIAL HANDLING:**
    - This file tests the DB migration from agents->wallets. It MUST retain `agents` references in migration-specific test data that verifies pre-migration state.
    - Only update: imports that reference current schema (use `wallets` table for post-migration assertions), any non-migration-specific helpers
    - Keep: migration SQL strings referencing old `agents` table, pre-migration assertion data

    **After all test files updated:**
    1. Run `npx tsc --noEmit -p packages/daemon/tsconfig.json` -- 0 errors
    2. Run `pnpm test --filter daemon 2>&1 | tail -20` -- all tests pass
    3. Count test results to verify no regressions vs. pre-phase count

    **Known pre-existing failures to IGNORE:**
    - `lifecycle.test.ts` -- flaky (pre-existing)
    - `e2e-errors.test.ts` -- OpenAPIHono side effect (pre-existing, if it exists in daemon)
  </action>
  <verify>
    1. `npx tsc --noEmit -p packages/daemon/tsconfig.json` -- 0 errors
    2. `pnpm test --filter daemon` -- all tests pass (excluding known pre-existing failures)
    3. `grep -rn '\bagentId\b\|\bagentCount\b\|\bagentRoutes\b\|\.agt\b\|max_sessions_per_agent' packages/daemon/src/__tests__/ --include='*.ts'` -- 0 results (excluding migration-runner.test.ts migration-specific data)
  </verify>
  <done>
    All ~37 daemon test files updated. Full daemon test suite compiles and passes. Zero unintended agent terminology in test files. Phase 91 complete.
  </done>
</task>

</tasks>

<verification>
Phase 91 is complete when ALL of these are true:
1. `POST /v1/wallets` route exists in wallets.ts, `/v1/agents` path is gone (agents.ts deleted)
2. All response schemas use `walletId` field (grep -r agentId in openapi-schemas.ts = 0)
3. JWT claim is `wlt` (grep `agt` in jwt-secret-manager.ts = 0)
4. `max_sessions_per_wallet` in config schema (grep max_sessions_per_agent = 0)
5. `GET /doc` OpenAPI spec: zero agentId, walletId present
6. `npx tsc --noEmit -p packages/daemon/tsconfig.json` -- 0 errors
7. `pnpm test --filter daemon` -- passes (excluding known pre-existing flaky tests)
8. `grep -rn 'agentId\|agentCount\|AgentResponse\|\.agt\b\|max_sessions_per_agent' packages/daemon/src/ --include='*.ts' | grep -v migration` -- 0 results
</verification>

<success_criteria>
- All 37+ daemon test files compile and pass with wallet terminology
- Zero regressions in test count
- Full Phase 91 verification passes (8 criteria above)
</success_criteria>

<output>
After completion, create `.planning/phases/91-daemon-api-jwt-config/91-02-SUMMARY.md`
</output>
