---
phase: 91-daemon-api-jwt-config
plan: 03
type: execute
wave: 1
depends_on: ["91-02"]
files_modified:
  - packages/core/src/interfaces/INotificationChannel.ts
  - packages/core/src/interfaces/ILocalKeyStore.ts
  - packages/daemon/src/notifications/notification-service.ts
  - packages/daemon/src/notifications/channels/ntfy.ts
  - packages/daemon/src/notifications/channels/telegram.ts
  - packages/daemon/src/notifications/channels/discord.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/infrastructure/keystore/keystore.ts
  - packages/daemon/src/__tests__/notification-service.test.ts
  - packages/daemon/src/__tests__/notification-channels.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "NotificationPayload interface uses walletId field, not agentId"
    - "ILocalKeyStore interface methods use walletId parameter name, not agentId"
    - "All notification channel implementations (ntfy, telegram, discord) reference payload.walletId"
    - "NotificationService.notify() accepts walletId parameter and builds payload with walletId"
    - "Admin test notification payload uses walletId field"
    - "LocalKeyStore implementation uses walletId parameter names throughout"
    - "tsc --noEmit passes for both core and daemon packages"
    - "All 681+ daemon tests pass with zero regressions"
  artifacts:
    - path: "packages/core/src/interfaces/INotificationChannel.ts"
      provides: "NotificationPayload with walletId field"
      contains: "walletId: string"
    - path: "packages/core/src/interfaces/ILocalKeyStore.ts"
      provides: "ILocalKeyStore with walletId parameters"
      contains: "walletId: string"
    - path: "packages/daemon/src/notifications/notification-service.ts"
      provides: "NotificationService with walletId-based notify()"
      contains: "walletId"
    - path: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      provides: "LocalKeyStore with walletId parameter names"
      contains: "walletId: string"
  key_links:
    - from: "packages/core/src/interfaces/INotificationChannel.ts"
      to: "packages/daemon/src/notifications/notification-service.ts"
      via: "NotificationPayload.walletId field used in payload construction and DB mapping"
      pattern: "payload\\.walletId"
    - from: "packages/core/src/interfaces/INotificationChannel.ts"
      to: "packages/daemon/src/notifications/channels/*.ts"
      via: "NotificationPayload.walletId field used in message formatting"
      pattern: "payload\\.walletId"
    - from: "packages/core/src/interfaces/ILocalKeyStore.ts"
      to: "packages/daemon/src/infrastructure/keystore/keystore.ts"
      via: "ILocalKeyStore interface implementation with walletId parameters"
      pattern: "walletId: string"
---

<objective>
Close 2 verification gaps in @waiaas/core interfaces by renaming agentId to walletId in NotificationPayload and ILocalKeyStore, then propagating changes to all daemon consumers.

Purpose: Phase 91 success criterion #2 requires "All API response bodies use walletId not agentId." The verification found NotificationPayload.agentId in @waiaas/core and ILocalKeyStore agentId parameter names as the remaining gaps. This plan renames both core interfaces and updates all downstream references.

Output: Zero agentId references in core interfaces and daemon notification/keystore code; all tests pass.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/91-daemon-api-jwt-config/91-01-SUMMARY.md
@.planning/phases/91-daemon-api-jwt-config/91-02-SUMMARY.md
@.planning/phases/91-daemon-api-jwt-config/91-VERIFICATION.md

# Source files to modify
@packages/core/src/interfaces/INotificationChannel.ts
@packages/core/src/interfaces/ILocalKeyStore.ts
@packages/daemon/src/notifications/notification-service.ts
@packages/daemon/src/notifications/channels/ntfy.ts
@packages/daemon/src/notifications/channels/telegram.ts
@packages/daemon/src/notifications/channels/discord.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/infrastructure/keystore/keystore.ts
@packages/daemon/src/__tests__/notification-service.test.ts
@packages/daemon/src/__tests__/notification-channels.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename core interfaces + daemon notification chain</name>
  <files>
    packages/core/src/interfaces/INotificationChannel.ts
    packages/core/src/interfaces/ILocalKeyStore.ts
    packages/daemon/src/notifications/notification-service.ts
    packages/daemon/src/notifications/channels/ntfy.ts
    packages/daemon/src/notifications/channels/telegram.ts
    packages/daemon/src/notifications/channels/discord.ts
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/infrastructure/keystore/keystore.ts
  </files>
  <action>
**Gap 1: NotificationPayload.agentId -> walletId**

1. In `packages/core/src/interfaces/INotificationChannel.ts`:
   - Line 5 comment: "agent context" -> "wallet context"
   - Line 10 comment: "Agent ID associated with the event" -> "Wallet ID associated with the event"
   - Line 11: `agentId: string;` -> `walletId: string;`

2. Rebuild core dist: `cd packages/core && npx tsc --build`

3. In `packages/daemon/src/notifications/notification-service.ts`:
   - Line 66: `notify()` parameter `agentId: string` -> `walletId: string`
   - Line 75: `agentId,` -> `walletId,` (payload construction)
   - Line 183: `walletId: payload.agentId,` -> `walletId: payload.walletId,` (logDelivery DB insert)
   - Line 205: `agentId: payload.agentId,` -> `walletId: payload.walletId,` (logCriticalFailure console.error)
   - Line 224: `walletId: payload.agentId,` -> `walletId: payload.walletId,` (logCriticalFailure audit_log insert)

4. In `packages/daemon/src/notifications/channels/ntfy.ts`:
   - Line 29: `payload.agentId` -> `payload.walletId` (also change label "Agent:" to "Wallet:")

5. In `packages/daemon/src/notifications/channels/telegram.ts`:
   - Line 44: `escape(\`Agent: ${payload.agentId}\`)` -> `escape(\`Wallet: ${payload.walletId}\`)`

6. In `packages/daemon/src/notifications/channels/discord.ts`:
   - Line 23: `{ name: 'Agent', value: payload.agentId, inline: true }` -> `{ name: 'Wallet', value: payload.walletId, inline: true }`

7. In `packages/daemon/src/api/routes/admin.ts`:
   - Line 437: `agentId: 'admin-test',` -> `walletId: 'admin-test',`

**Gap 2: ILocalKeyStore agentId parameters -> walletId**

8. In `packages/core/src/interfaces/ILocalKeyStore.ts`:
   - Line 6 comment: "per-agent JSON files" -> "per-wallet JSON files"
   - Line 13: `agentId: string,` -> `walletId: string,`
   - Line 23: `decryptPrivateKey(agentId: string,` -> `decryptPrivateKey(walletId: string,`
   - Line 28 comment: "agent" -> "wallet"
   - Line 29: `hasKey(agentId: string)` -> `hasKey(walletId: string)`
   - Line 31 comment: "agent" -> "wallet"
   - Line 32: `deleteKey(agentId: string)` -> `deleteKey(walletId: string)`

9. Rebuild core dist again: `cd packages/core && npx tsc --build`

10. In `packages/daemon/src/infrastructure/keystore/keystore.ts`:
    - Line 10 comment: "per-agent JSON keystore files" -> "per-wallet JSON keystore files"
    - Line 69 comment: "agentId" -> "walletId"
    - Line 89: `agentId: string,` -> `walletId: string,` in generateKeyPair
    - Line 95: `this.generateSecp256k1KeyPair(agentId,` -> `this.generateSecp256k1KeyPair(walletId,`
    - Line 99: `this.generateEd25519KeyPair(agentId,` -> `this.generateEd25519KeyPair(walletId,`
    - Line 111: `agentId: string,` -> `walletId: string,` in generateEd25519KeyPair
    - Line 151: `name: agentId,` -> `name: walletId,`
    - Line 158: `this.writeKeystoreFile(agentId,` -> `this.writeKeystoreFile(walletId,`
    - Line 171: `agentId: string,` -> `walletId: string,` in generateSecp256k1KeyPair
    - Line 211: `name: agentId,` -> `name: walletId,`
    - Line 218: `this.writeKeystoreFile(agentId,` -> `this.writeKeystoreFile(walletId,`
    - Line 231: `decryptPrivateKey(agentId: string,` -> `decryptPrivateKey(walletId: string,`
    - Line 232: `this.readKeystoreFile(agentId)` -> `this.readKeystoreFile(walletId)`
    - Line 252: `this.guardedKeys.set(guarded, agentId)` -> `this.guardedKeys.set(guarded, walletId)`
    - Line 256: `this.writeKeystoreFile(agentId,` -> `this.writeKeystoreFile(walletId,`
    - Line 284: `hasKey(agentId: string)` -> `hasKey(walletId: string)`
    - Line 286: `this.keystorePath(agentId)` -> `this.keystorePath(walletId)`
    - Line 296: `deleteKey(agentId: string)` -> `deleteKey(walletId: string)`
    - Line 299: `if (id === agentId)` -> `if (id === walletId)`
    - Line 307: `this.keystorePath(agentId)` -> `this.keystorePath(walletId)`
    - Line 336: `keystorePath(agentId: string)` -> `keystorePath(walletId: string)`
    - Line 337: `\`${agentId}.json\`` -> `\`${walletId}.json\``
    - Line 344: `writeKeystoreFile(agentId: string,` -> `writeKeystoreFile(walletId: string,`
    - Line 345: `this.keystorePath(agentId)` -> `this.keystorePath(walletId)`
    - Line 346: `.${agentId}.json.tmp` -> `.${walletId}.json.tmp`
    - Line 353: `readKeystoreFile(agentId: string)` -> `readKeystoreFile(walletId: string)`
    - Line 361: `wallet '${agentId}'` -> `wallet '${walletId}'`

**Strategy:** Use replace_all where safe (parameter names within a single file). Use targeted edits for comments and string labels.

11. Verify: `cd packages/daemon && npx tsc --noEmit` (must pass with zero errors)
  </action>
  <verify>
1. `cd packages/core && npx tsc --build` succeeds
2. `cd packages/daemon && npx tsc --noEmit` succeeds with zero errors
3. `grep -r 'agentId' packages/core/src/interfaces/INotificationChannel.ts` returns 0 matches
4. `grep -r 'agentId' packages/core/src/interfaces/ILocalKeyStore.ts` returns 0 matches
5. `grep -r 'payload\.agentId' packages/daemon/src/notifications/` returns 0 matches
6. `grep -r 'agentId' packages/daemon/src/infrastructure/keystore/keystore.ts` returns 0 matches
7. `grep 'agentId' packages/daemon/src/api/routes/admin.ts` returns 0 matches (the admin-test payload now uses walletId)
  </verify>
  <done>
Both core interfaces use walletId (not agentId), all 3 notification channels use payload.walletId, notification-service.ts notify() accepts walletId, admin test payload uses walletId, keystore implementation uses walletId throughout. TypeScript compilation passes for both packages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update notification + keystore test files and verify all tests pass</name>
  <files>
    packages/daemon/src/__tests__/notification-service.test.ts
    packages/daemon/src/__tests__/notification-channels.test.ts
  </files>
  <action>
1. In `packages/daemon/src/__tests__/notification-service.test.ts`:
   - All `payload.agentId` assertions -> `payload.walletId` (lines 55, 95, 163, 341 approximately)
   - These were previously kept as agentId because the core interface used agentId. Now the core interface uses walletId.

2. In `packages/daemon/src/__tests__/notification-channels.test.ts`:
   - Line 21: `agentId: 'agent-001'` in makePayload -> `walletId: 'agent-001'` (keep the test value string but use the new field name)
   - Line 366: `makePayload({ agentId: 'test-wallet' })` -> `makePayload({ walletId: 'test-wallet' })`
   - Any other `payload.agentId` references -> `payload.walletId`
   - Update any assertion strings that check for "Agent:" label in channel output to "Wallet:" (since ntfy/telegram/discord now output "Wallet:")

3. Run full daemon test suite: `cd packages/daemon && npx vitest run`
   - All 681+ tests must pass
   - Zero regressions

4. Run grep verification:
   - `grep -rn 'agentId' packages/core/src/interfaces/` should return 0 matches
   - `grep -rn 'payload\.agentId' packages/daemon/src/` should return 0 matches (excluding .planning/ and migration-runner.test.ts)
   - `grep -rn '\.agentId' packages/daemon/src/notifications/` should return 0 matches
  </action>
  <verify>
1. `cd packages/daemon && npx vitest run` passes all tests (681+ tests, 0 failures)
2. `grep -rn 'payload\.agentId' packages/daemon/src/` returns 0 matches
3. `grep -rn 'agentId' packages/core/src/interfaces/` returns 0 matches
4. `grep -rn '\.agentId' packages/daemon/src/__tests__/notification-service.test.ts` returns 0 matches
5. `grep -rn '\.agentId' packages/daemon/src/__tests__/notification-channels.test.ts` returns 0 matches
  </verify>
  <done>
All notification and keystore test files use walletId consistently. All 681+ daemon tests pass. Zero agentId references remain in core interfaces or daemon notification/keystore code paths.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'agentId' packages/core/src/interfaces/` returns 0 matches
2. `grep -rn 'payload\.agentId' packages/daemon/src/` returns 0 matches
3. `grep -rn '\.agentId' packages/daemon/src/notifications/` returns 0 matches
4. `grep -rn 'agentId' packages/daemon/src/infrastructure/keystore/keystore.ts` returns 0 matches
5. `cd packages/core && npx tsc --build` succeeds
6. `cd packages/daemon && npx tsc --noEmit` succeeds
7. `cd packages/daemon && npx vitest run` passes all 681+ tests
8. Phase 91 VERIFICATION.md truth #2 ("All API response bodies use walletId not agentId") is now VERIFIED (not partial)
</verification>

<success_criteria>
- NotificationPayload.walletId field exists in @waiaas/core (agentId removed)
- ILocalKeyStore methods use walletId parameter names (agentId removed)
- All 3 notification channels (ntfy, telegram, discord) reference payload.walletId
- NotificationService.notify() parameter is walletId
- LocalKeyStore uses walletId in all method signatures and internal logic
- Admin test payload uses walletId: 'admin-test'
- tsc --noEmit passes for both core and daemon
- All 681+ daemon tests pass with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/91-daemon-api-jwt-config/91-03-SUMMARY.md`
</output>
