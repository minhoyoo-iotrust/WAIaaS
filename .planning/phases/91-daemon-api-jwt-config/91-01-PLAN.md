---
phase: 91-daemon-api-jwt-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/agents.ts
  - packages/daemon/src/api/routes/wallets.ts
  - packages/daemon/src/api/routes/wallet.ts
  - packages/daemon/src/api/routes/sessions.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/routes/policies.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/api/middleware/session-auth.ts
  - packages/daemon/src/api/middleware/owner-auth.ts
  - packages/daemon/src/infrastructure/jwt/jwt-secret-manager.ts
  - packages/daemon/src/infrastructure/jwt/index.ts
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/infrastructure/database/index.ts
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/pipeline/pipeline.ts
  - packages/daemon/src/pipeline/database-policy-engine.ts
autonomous: true

must_haves:
  truths:
    - "POST /v1/wallets endpoint exists and /v1/agents returns 404"
    - "All API response bodies use walletId not agentId"
    - "JWT payload claim is wlt not agt"
    - "session-auth middleware sets walletId on Hono context"
    - "config key is max_sessions_per_wallet"
    - "OpenAPI spec (GET /doc) shows walletId fields, zero agentId"
    - "tsc --noEmit passes for daemon package"
  artifacts:
    - path: "packages/daemon/src/api/routes/wallets.ts"
      provides: "Wallet CRUD route handlers (renamed from agents.ts)"
      contains: "walletRoutes"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "WalletResponseSchema, WalletListResponseSchema, etc."
      contains: "WalletResponseSchema"
    - path: "packages/daemon/src/infrastructure/jwt/jwt-secret-manager.ts"
      provides: "JwtPayload with wlt claim"
      contains: "wlt"
  key_links:
    - from: "packages/daemon/src/api/middleware/session-auth.ts"
      to: "packages/daemon/src/api/routes/transactions.ts"
      via: "c.get('walletId') context variable"
      pattern: "c\\.get\\('walletId'"
    - from: "packages/daemon/src/infrastructure/jwt/jwt-secret-manager.ts"
      to: "packages/daemon/src/api/middleware/session-auth.ts"
      via: "payload.wlt JWT claim extraction"
      pattern: "payload\\.wlt"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/wallets.ts"
      via: "walletCrudRoutes import and /v1 route registration"
      pattern: "walletCrudRoutes"
---

<objective>
Rename all agent-related identifiers in daemon source files (non-test) to wallet terminology: OpenAPI schemas, route handlers, JWT claims, session-auth middleware, config keys, and pipeline context.

Purpose: Make daemon API externally visible as wallet-based (routes, responses, JWT, OpenAPI spec), satisfying Phase 91 requirements API-01 through API-05, SCHEMA-03, SCHEMA-04, CONF-01.

Output: 19 daemon source files updated, agents.ts renamed to wallets.ts, all agent->wallet renames complete, `tsc --noEmit` passes.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/90-core-types-error-codes/90-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename OpenAPI schemas + agents.ts -> wallets.ts + route/middleware source files</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/agents.ts (delete after creating wallets.ts)
    packages/daemon/src/api/routes/wallets.ts (new, renamed from agents.ts)
    packages/daemon/src/api/routes/wallet.ts
    packages/daemon/src/api/routes/sessions.ts
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/api/routes/policies.ts
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/api/middleware/session-auth.ts
    packages/daemon/src/api/middleware/owner-auth.ts
    packages/daemon/src/infrastructure/database/index.ts
  </files>
  <action>
    **openapi-schemas.ts** -- Rename OpenAPI response schemas and fields:
    1. Import `CreateWalletRequestSchema` instead of `CreateAgentRequestSchema` from `@waiaas/core`
    2. Rename `AgentResponseSchema` -> `WalletCrudResponseSchema` (to avoid collision with existing `WalletAddressResponseSchema`/`WalletBalanceResponseSchema`). Schema `.openapi('AgentResponse')` -> `.openapi('WalletCrudResponse')`.
    3. Rename `AgentOwnerResponseSchema` -> `WalletOwnerResponseSchema`, openapi name `WalletOwnerResponse`
    4. In `WalletAddressResponseSchema`, `WalletBalanceResponseSchema`, `WalletAssetsResponseSchema`: rename `agentId` field to `walletId`
    5. In `SessionCreateResponseSchema`, `SessionListItemSchema`: rename `agentId` field to `walletId`
    6. In `TxDetailResponseSchema`: rename `agentId` field to `walletId`
    7. In `PolicyResponseSchema`: rename `agentId` field to `walletId`
    8. In `NotificationLogEntrySchema`: rename `agentId` field to `walletId`
    9. In `AdminStatusResponseSchema`: rename `agentCount` field to `walletCount`
    10. Rename `AgentListResponseSchema` -> `WalletListResponseSchema`, openapi name `WalletListResponse`, inner array references `WalletCrudResponseSchema`
    11. Rename `AgentDetailResponseSchema` -> `WalletDetailResponseSchema`, openapi name `WalletDetailResponse`
    12. Rename `AgentDeleteResponseSchema` -> `WalletDeleteResponseSchema`, openapi name `WalletDeleteResponse`
    13. Rename `CreateAgentRequestOpenAPI` -> `CreateWalletRequestOpenAPI` with openapi name `CreateWalletRequest`
    14. Rename `UpdateAgentRequestSchema` -> `UpdateWalletRequestSchema`, openapi name `UpdateWalletRequest`
    15. Update `buildErrorResponses` calls: `'AGENT_NOT_FOUND'` -> `'WALLET_NOT_FOUND'`, `'AGENT_TERMINATED'` -> `'WALLET_TERMINATED'` (these error codes were already renamed in Phase 90)
    16. Update section comments from "Agent" to "Wallet" where applicable

    **agents.ts -> wallets.ts** -- File rename + content update:
    1. Create `wallets.ts` as a copy of `agents.ts` with ALL of the following changes
    2. Update module-level JSDoc: "Wallet route handlers", paths `/v1/wallets`, etc.
    3. Import `wallets` (not `agents`) from `../../infrastructure/database/schema.js`
    4. Import renamed schemas from `./openapi-schemas.js` (WalletCrudResponseSchema, WalletOwnerResponseSchema, WalletListResponseSchema, WalletDetailResponseSchema, WalletDeleteResponseSchema, CreateWalletRequestOpenAPI, UpdateWalletRequestSchema)
    5. Rename interface `AgentRouteDeps` -> `WalletCrudRouteDeps`
    6. Rename route definitions: `createAgentRoute` -> `createWalletRoute`, path `/wallets`, tags `['Wallets']`, summary `'Create a new wallet'`, error codes `WALLET_NOT_FOUND`
    7. `setOwnerRoute`: path `/wallets/{id}/owner`, tags `['Wallets']`, error codes `WALLET_NOT_FOUND`
    8. `listAgentsRoute` -> `listWalletsRoute`: path `/wallets`, tags `['Wallets']`, summary `'List all wallets'`
    9. `agentDetailRoute` -> `walletDetailRoute`: path `/wallets/{id}`, tags `['Wallets']`
    10. `updateAgentRoute` -> `updateWalletRoute`: path `/wallets/{id}`, tags `['Wallets']`
    11. `deleteAgentRoute` -> `deleteWalletRoute`: path `/wallets/{id}`, tags `['Wallets']`
    12. Rename export function `agentRoutes` -> `walletCrudRoutes` (to avoid collision with `walletRoutes` in wallet.ts)
    13. Internal variable names: `agentId` -> `walletId`, `allAgents` -> `allWallets`, `agent` -> `wallet` (local vars)
    14. DB operations: `.from(wallets)` instead of `.from(agents)`, `wallets.id` instead of `agents.id`
    15. Error messages: `Agent '${walletId}' not found` -> `Wallet '${walletId}' not found`, etc.
    16. WAIaaSError codes: `'AGENT_NOT_FOUND'` -> `'WALLET_NOT_FOUND'`, `'AGENT_TERMINATED'` -> `'WALLET_TERMINATED'`
    17. Notification service calls: second arg is now `walletId` (already was, but ensure variable name matches)
    18. Delete `agents.ts` after creating `wallets.ts`

    **wallet.ts** -- Session-auth based wallet query routes:
    1. Update JSDoc: "Agent identification via JWT payload walletId"
    2. Import `wallets` instead of `agents` from schema
    3. Rename `resolveAgentById` -> `resolveWalletById`, parameter `agentId` -> `walletId`
    4. Error messages: `Wallet '${walletId}' not found`
    5. In route handlers: `c.get('walletId' as never)` instead of `c.get('agentId' as never)`
    6. Response bodies: `walletId: wallet.id` instead of `agentId: agent.id` (note: walletId already exists in OpenAPI schema after openapi-schemas.ts rename)
    7. Local variable names: `agent` -> `wallet` where it refers to the DB row

    **sessions.ts**:
    1. Import `wallets` instead of `agents` from schema
    2. `CreateSessionRequestSchema` already uses `walletId` (from Phase 90 core). Update `parsed.agentId` -> `parsed.walletId` in all usages
    3. DB queries: `sessions.walletId` instead of `sessions.agentId` (schema column is already `walletId` from Phase 89)
    4. DB insert: `walletId: parsed.walletId` instead of `agentId: parsed.agentId`
    5. Agent lookup: `.where(eq(wallets.id, parsed.walletId))`, variable `agent` -> `wallet`
    6. Config: `deps.config.security.max_sessions_per_wallet` instead of `max_sessions_per_agent`
    7. Error messages: `Agent has ${activeCount}` -> `Wallet has ${activeCount}`
    8. Response bodies: `walletId: parsed.walletId` instead of `agentId: parsed.agentId`
    9. List sessions: query param rename `agentId` -> `walletId` in OpenAPI schema + handler
    10. Row mapping: `row.walletId` instead of `row.agentId`
    11. Renewal: `session.walletId` instead of `session.agentId` in JwtPayload construction
    12. Notification calls: second arg `parsed.walletId`

    **transactions.ts**:
    1. Import `wallets` instead of `agents` from schema
    2. `c.get('walletId' as never)` instead of `c.get('agentId' as never)` in all handlers
    3. DB queries: `.from(wallets)`, `wallets.id`, `transactions.walletId` instead of `transactions.agentId`
    4. Error messages: `Wallet '${walletId}' not found`
    5. Response bodies: `walletId: tx.walletId` instead of `agentId: tx.agentId`
    6. Pipeline context: `walletId` instead of `agentId` (matching stages.ts change below)
    7. `sessionAgentId` -> `sessionWalletId` in cancel handler, `tx.walletId` comparison
    8. WAIaaSError codes: `WALLET_NOT_FOUND` instead of `AGENT_NOT_FOUND`

    **policies.ts**:
    1. Import `wallets` instead of `agents` from schema
    2. DB queries: `policies.walletId` instead of `policies.agentId`
    3. Insert: `walletId: parsed.walletId` instead of `agentId: parsed.agentId`
    4. Query param and validation: `walletId` instead of `agentId`
    5. Response: `walletId: row.walletId`, `walletId: updated.walletId`
    6. Agent lookup: `.from(wallets)`, `wallets.id`

    **admin.ts**:
    1. Import `wallets` instead of `agents` from schema
    2. `agentCountResult` -> `walletCountResult`, `.from(wallets)`, response field `walletCount`
    3. Notification test: `agentId: 'admin-test'` -> `walletId: 'admin-test'` (if NotificationPayload now expects walletId)
    4. Notification log response: `walletId: row.walletId` instead of `agentId: row.agentId`

    **routes/index.ts** -- Barrel export update:
    1. `export { walletCrudRoutes, type WalletCrudRouteDeps } from './wallets.js'` (was `agentRoutes` from `agents.js`)
    2. Keep other exports unchanged

    **server.ts** -- Route registration + auth middleware paths:
    1. Import `walletCrudRoutes` instead of `agentRoutes` from `./routes/wallets.js` (was `./routes/agents.js`)
    2. Master auth paths: `/v1/agents` -> `/v1/wallets`, `/v1/agents/:id` -> `/v1/wallets/:id`, `/v1/agents/:id/owner` -> `/v1/wallets/:id/owner`
    3. Comments update: "masterAuth: /v1/wallets" etc.
    4. Route registration: `walletCrudRoutes({...})` instead of `agentRoutes({...})`

    **session-auth.ts**:
    1. Update JSDoc to reference walletId
    2. `c.set('walletId', payload.wlt)` instead of `c.set('agentId', payload.agt)` -- note this depends on JWT claim rename below

    **owner-auth.ts**:
    1. Import `wallets` instead of `agents` from schema
    2. DB query: `.from(wallets)`, `wallets.id`

    **database/index.ts**:
    1. Remove the backward-compat alias line: `export { wallets as agents } from './schema.js';`
    2. Update JSDoc to remove the alias note

    **IMPORTANT naming convention**: The agents.ts route file is being renamed to wallets.ts. The export function name changes from `agentRoutes` to `walletCrudRoutes` to avoid collision with the existing `walletRoutes` function in wallet.ts (which handles session-based wallet queries like /wallet/address, /wallet/balance). The interface `AgentRouteDeps` becomes `WalletCrudRouteDeps`.
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/daemon/tsconfig.json 2>&1 | head -5` -- should show 0 errors (or only test file errors which Plan 91-02 will fix).
    Verify `agents.ts` no longer exists: `test ! -f packages/daemon/src/api/routes/agents.ts`.
    Verify `wallets.ts` exists: `test -f packages/daemon/src/api/routes/wallets.ts`.
    Grep: `grep -r 'agentId\|agentCount\|AgentResponse\|AgentList\|CreateAgentRequest\|max_sessions_per_agent' packages/daemon/src/api/ packages/daemon/src/infrastructure/ packages/daemon/src/pipeline/ --include='*.ts' | grep -v __tests__ | grep -v '.d.ts'` should return 0 lines.
  </verify>
  <done>
    All daemon non-test source files use wallet terminology. Route paths are /v1/wallets. JWT claim is wlt. Config key is max_sessions_per_wallet. OpenAPI schemas named Wallet*. No agentId/agentCount/agt in any daemon source file (excluding tests).
  </done>
</task>

<task type="auto">
  <name>Task 2: JWT claim rename + pipeline context + config key</name>
  <files>
    packages/daemon/src/infrastructure/jwt/jwt-secret-manager.ts
    packages/daemon/src/infrastructure/jwt/index.ts
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/pipeline/pipeline.ts
    packages/daemon/src/pipeline/database-policy-engine.ts
  </files>
  <action>
    **jwt-secret-manager.ts**:
    1. In `JwtPayload` interface: rename `agt: string` -> `wlt: string` and update JSDoc comment from "agentId" to "walletId"
    2. In `signToken()`: change `agt: payload.agt` -> `wlt: payload.wlt` in the SignJWT payload
    3. In `verifyToken()`: change `agt: payload.agt as string` -> `wlt: payload.wlt as string` in the return

    **jwt/index.ts**:
    1. No changes needed (already re-exports JwtPayload type)

    **config/loader.ts**:
    1. In `DaemonConfigSchema.security`: rename `max_sessions_per_agent` -> `max_sessions_per_wallet`

    **pipeline/stages.ts**:
    1. In `PipelineContext` interface: rename `agentId: string` -> `walletId: string`
    2. In `stage1Validate()`: `ctx.walletId` instead of `ctx.agentId` for DB insert (`walletId: ctx.walletId`), notification calls
    3. In `stage3Policy()`: `ctx.walletId` instead of `ctx.agentId` for policy evaluation calls
    4. In `stage3Policy()`: agent row lookup: import `wallets` not `agents`, `.from(wallets)`, `wallets.id`, `eq(wallets.id, ctx.walletId)`
    5. In `stage5Execute()`: `ctx.walletId` for keyStore.decryptPrivateKey and notification calls
    6. In `stage6Confirm()`: `ctx.walletId` for notification calls
    7. All notification `notify()` second arg: `ctx.walletId`
    8. Import `wallets` instead of `agents` from schema

    **pipeline/pipeline.ts**:
    1. Import `wallets` instead of `agents` from schema
    2. All `agentId` references -> `walletId` in pipeline context construction
    3. DB queries: `.from(wallets)`, `wallets.id`

    **pipeline/database-policy-engine.ts**:
    1. `policies.walletId` instead of `policies.agentId` in DB queries (already using `walletId` column from schema)

    After both tasks complete, verify: `npx tsc --noEmit -p packages/daemon/tsconfig.json 2>&1 | grep -c 'error TS'` should show only test-file errors.
  </action>
  <verify>
    Run `grep -r '\bagt\b' packages/daemon/src/infrastructure/jwt/ packages/daemon/src/pipeline/ --include='*.ts' | grep -v __tests__` -- should return 0 lines.
    Run `grep -r 'max_sessions_per_agent' packages/daemon/src/ --include='*.ts' | grep -v __tests__` -- should return 0 lines.
    Run `grep -r 'agentId' packages/daemon/src/pipeline/ --include='*.ts' | grep -v __tests__` -- should return 0 lines.
  </verify>
  <done>
    JWT claim is `wlt`. PipelineContext uses `walletId`. Config key is `max_sessions_per_wallet`. All pipeline/JWT/config source files use wallet terminology. Combined with Task 1, ALL daemon non-test source files are migrated.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/daemon/tsconfig.json 2>&1 | grep -v '__tests__' | grep 'error TS'` -- 0 errors in non-test files
2. `grep -rn 'agentId\|agentCount\|AgentResponse\|AgentList\|AgentDetail\|AgentDelete\|CreateAgentRequest\|UpdateAgentRequest\|AgentOwnerResponse\|max_sessions_per_agent\|AgentRouteDeps\|agentRoutes' packages/daemon/src/ --include='*.ts' | grep -v __tests__ | grep -v '.d.ts'` -- 0 results
3. `grep -rn "\.agt\b\|'agt'" packages/daemon/src/ --include='*.ts' | grep -v __tests__` -- 0 results (JWT claim is now wlt)
4. `test -f packages/daemon/src/api/routes/wallets.ts` -- exists
5. `test ! -f packages/daemon/src/api/routes/agents.ts` -- deleted
</verification>

<success_criteria>
- All daemon non-test source files (~19 files) use wallet terminology exclusively
- `/v1/wallets` routes defined, `/v1/agents` paths removed
- JWT payload claim is `wlt`, not `agt`
- Config key is `max_sessions_per_wallet`
- OpenAPI response schemas named Wallet* with walletId fields
- `tsc --noEmit` passes for non-test daemon source
</success_criteria>

<output>
After completion, create `.planning/phases/91-daemon-api-jwt-config/91-01-SUMMARY.md`
</output>
