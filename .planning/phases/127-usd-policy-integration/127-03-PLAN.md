---
phase: 127-usd-policy-integration
plan: 03
type: execute
wave: 3
depends_on: ["127-01", "127-02"]
files_modified:
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts
autonomous: true

must_haves:
  truths:
    - "OracleChain이 daemon 시작 시 생성되어 PipelineContext.priceOracle에 주입된다"
    - "stage3Policy가 evaluateAndReserve 진입 전에 resolveEffectiveAmountUsd를 호출한다"
    - "PriceResult.success 시 usdAmount가 evaluateAndReserve에 전달된다"
    - "PriceResult.oracleDown 시 네이티브 금액만으로 평가가 계속된다 (usdAmount 미전달)"
    - "PriceResult.notListed 시 최소 NOTIFY로 격상되고 UNLISTED_TOKEN_TRANSFER 감사 로그가 기록된다"
    - "CoinGecko 키 미설정 + notListed 시 최초 1회 키 안내 힌트가 알림에 포함된다"
    - "priceOracle 미설정 시 기존 네이티브 전용 평가가 그대로 동작한다 (하위 호환)"
    - "AdminRouteDeps.priceOracle에 OracleChain 인스턴스가 전달된다"
  artifacts:
    - path: "packages/daemon/src/pipeline/stages.ts"
      provides: "stage3Policy에서 resolveEffectiveAmountUsd 호출 + notListed 격상 + oracleDown fallback + 힌트"
      contains: "resolveEffectiveAmountUsd"
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "TransactionRouteDeps.priceOracle + PipelineContext.priceOracle 주입"
      contains: "priceOracle"
    - path: "packages/daemon/src/lifecycle/daemon.ts"
      provides: "OracleChain DI 생성 + createApp deps에 priceOracle 전달"
      contains: "OracleChain"
    - path: "packages/daemon/src/api/server.ts"
      provides: "CreateAppDeps.priceOracle + adminRoutes/transactionRoutes에 전달"
      contains: "priceOracle"
    - path: "packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts"
      provides: "Stage 3 USD 통합 테스트"
  key_links:
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/infrastructure/oracle/oracle-chain.ts"
      via: "new OracleChain() 생성 + createApp에 전달"
      pattern: "new OracleChain"
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "packages/daemon/src/pipeline/resolve-effective-amount-usd.ts"
      via: "resolveEffectiveAmountUsd 호출"
      pattern: "resolveEffectiveAmountUsd"
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "auditLog.insert for UNLISTED_TOKEN_TRANSFER"
      pattern: "UNLISTED_TOKEN_TRANSFER"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/admin.ts"
      via: "adminRoutes deps에 priceOracle 전달"
      pattern: "priceOracle.*deps"
---

<objective>
Stage 3 파이프라인에 USD 정책 평가를 통합하고, OracleChain DI를 연결하며, notListed NOTIFY 격상 + 감사 로그 + CoinGecko 힌트를 구현한다.

Purpose: Phase 125-126의 오라클 인프라와 Phase 127-01/02의 USD 환산/정책 엔진을 실제 트랜잭션 파이프라인에 연결하여 모든 트랜잭션이 USD 기준으로도 평가되게 한다. 가격 불명 토큰과 오라클 장애에 대한 안전한 fallback을 제공한다.
Output: stages.ts (Stage 3 통합), daemon.ts (OracleChain DI), server.ts (priceOracle 전달), transactions.ts (PipelineContext 확장), 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/127-usd-policy-integration/127-RESEARCH.md
@.planning/phases/127-usd-policy-integration/127-01-SUMMARY.md
@.planning/phases/127-usd-policy-integration/127-02-SUMMARY.md
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/api/routes/transactions.ts
@packages/daemon/src/api/routes/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: OracleChain DI 연결 + PipelineContext priceOracle 주입</name>
  <files>
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/lifecycle/daemon.ts
  </files>
  <action>
4개 파일을 수정하여 OracleChain을 daemon 부트스트랩부터 PipelineContext까지 연결한다.

**1. packages/daemon/src/pipeline/stages.ts -- PipelineContext 확장:**
```typescript
import type { IPriceOracle } from '@waiaas/core';
```
PipelineContext 인터페이스에 추가:
```typescript
// v1.5: price oracle for USD policy evaluation
priceOracle?: IPriceOracle;
// v1.5: settings service for CoinGecko hint
settingsService?: SettingsService;
```
SettingsService import가 이미 있는지 확인. 없으면 추가:
```typescript
import type { SettingsService } from '../infrastructure/settings/settings-service.js';
```

**2. packages/daemon/src/api/routes/transactions.ts -- TransactionRouteDeps 확장:**
```typescript
import type { IPriceOracle } from '@waiaas/core';
import type { SettingsService } from '../../infrastructure/settings/settings-service.js';
```
TransactionRouteDeps에 추가:
```typescript
priceOracle?: IPriceOracle;
settingsService?: SettingsService;
```
PipelineContext 생성 부분(~라인 326)에 추가:
```typescript
priceOracle: deps.priceOracle,
settingsService: deps.settingsService,
```

**3. packages/daemon/src/api/server.ts -- CreateAppDeps + 전달:**
CreateAppDeps에 이미 없으면 추가:
```typescript
import type { IPriceOracle } from '@waiaas/core';
```
CreateAppDeps 인터페이스에 추가 (이미 없는 경우):
```typescript
priceOracle?: IPriceOracle;
```
transactionRoutes 호출에 priceOracle 전달:
```typescript
priceOracle: deps.priceOracle,
settingsService: deps.settingsService,
```
adminRoutes 호출에 priceOracle 전달 (현재 미전달 상태):
```typescript
priceOracle: deps.priceOracle,
```

**4. packages/daemon/src/lifecycle/daemon.ts -- OracleChain 생성 + createApp에 전달:**
Step 4와 Step 5 사이 (Step 4d 이후, notificationService 초기화 후)에 OracleChain 생성:
```typescript
// Step 4e: Price Oracle (fail-soft)
let priceOracle: IPriceOracle | undefined;
try {
  const { InMemoryPriceCache, PythOracle, CoinGeckoOracle, OracleChain } =
    await import('../infrastructure/oracle/index.js');

  const priceCache = new InMemoryPriceCache();
  const pythOracle = new PythOracle();

  const coingeckoApiKey = this._settingsService?.get('oracle.coingecko_api_key');
  const coingeckoOracle = coingeckoApiKey
    ? new CoinGeckoOracle(this._settingsService!)
    : undefined;

  const thresholdStr = this._settingsService?.get('oracle.cross_validation_threshold');
  const crossValidationThreshold = thresholdStr ? Number(thresholdStr) : 5;

  priceOracle = new OracleChain({
    primary: pythOracle,
    fallback: coingeckoOracle,
    cache: priceCache,
    crossValidationThreshold,
  });

  console.log(
    `Step 4e: PriceOracle initialized (Pyth primary${coingeckoOracle ? ' + CoinGecko fallback' : ''})`,
  );
} catch (err) {
  console.warn('Step 4e (fail-soft): PriceOracle init warning:', err);
}
```

createApp 호출에 priceOracle 추가:
```typescript
const app = createApp({
  ...기존 props,
  priceOracle,  // Phase 127 추가
});
```

import 추가:
```typescript
import type { IPriceOracle } from '@waiaas/core';
```

커밋: `feat(127-03): OracleChain DI 연결 + PipelineContext priceOracle 주입`
  </action>
  <verify>
npx tsc --noEmit -p packages/daemon -- 타입 체크 통과
npx vitest run packages/daemon -- 기존 테스트 회귀 없음
  </verify>
  <done>OracleChain이 daemon.ts에서 생성되어 createApp -> transactionRoutes -> PipelineContext 경로로 priceOracle이 전달되고, adminRoutes에도 전달된다</done>
</task>

<task type="auto">
  <name>Task 2: Stage 3 USD 통합 -- resolveEffectiveAmountUsd + notListed 격상 + oracleDown fallback + 힌트</name>
  <files>
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts
  </files>
  <action>
**1. packages/daemon/src/pipeline/stages.ts -- stage3Policy 확장:**

import 추가:
```typescript
import { resolveEffectiveAmountUsd, type PriceResult } from './resolve-effective-amount-usd.js';
import { auditLog } from '../infrastructure/database/schema.js';
```
(auditLog이 이미 import되어 있는지 확인)

**모듈 레벨 in-memory Set (hintedTokens):**
```typescript
// v1.5: CoinGecko 키 안내 힌트 최초 1회 추적 (데몬 재시작 시 리셋 OK)
const hintedTokens = new Set<string>();
```

**stage3Policy 함수 내부, evaluateAndReserve 호출 전에 Oracle 호출 삽입:**

BATCH 분기와 non-BATCH 분기 모두에서 resolveEffectiveAmountUsd를 호출한다.

```typescript
// [Phase 127] Oracle HTTP 호출 (evaluateAndReserve 진입 전 완료)
let priceResult: PriceResult | undefined;
if (ctx.priceOracle) {
  priceResult = await resolveEffectiveAmountUsd(
    req, txType, ctx.wallet.chain, ctx.priceOracle,
  );
}
```

이 코드를 txParam.network 설정 직후, BATCH/non-BATCH 분기 직전에 배치한다.

**non-BATCH 분기에서 usdAmount 전달:**
```typescript
// evaluateAndReserve에 usdAmount 전달 (Phase 127)
const usdAmount = priceResult?.type === 'success' ? priceResult.usdAmount : undefined;

if (ctx.policyEngine instanceof DatabasePolicyEngine && ctx.sqlite) {
  evaluation = ctx.policyEngine.evaluateAndReserve(
    ctx.walletId,
    txParam,
    ctx.txId,
    usdAmount,  // Phase 127 추가
  );
} else {
  evaluation = await ctx.policyEngine.evaluate(ctx.walletId, txParam);
}
```

**BATCH 분기에서 usdAmount 전달:**
```typescript
// evaluateBatch에 batchUsdAmount 전달 (Phase 127)
const batchUsdAmount = priceResult?.type === 'success' ? priceResult.usdAmount : undefined;
evaluation = await ctx.policyEngine.evaluateBatch(ctx.walletId, params, batchUsdAmount);
```

**evaluation 후, tier 결정 후 notListed/oracleDown 처리:**

`let tier = evaluation.tier;` 이후, downgradeIfNoOwner 이전에:

```typescript
// [Phase 127] PriceResult에 따른 후처리
if (priceResult?.type === 'notListed') {
  // 감사 로그: UNLISTED_TOKEN_TRANSFER
  await ctx.db.insert(auditLog).values({
    timestamp: Math.floor(Date.now() / 1000),
    eventType: 'UNLISTED_TOKEN_TRANSFER',
    actor: ctx.sessionId ?? 'system',
    walletId: ctx.walletId,
    txId: ctx.txId,
    details: JSON.stringify({
      tokenAddress: priceResult.tokenAddress,
      chain: priceResult.chain,
      failedCount: priceResult.failedCount,
    }),
    severity: 'warning',
  });

  // 최소 NOTIFY 격상 (evaluation tier와 NOTIFY 중 보수적)
  const TIER_ORDER: PolicyTier[] = ['INSTANT', 'NOTIFY', 'DELAY', 'APPROVAL'];
  const currentIdx = TIER_ORDER.indexOf(tier);
  const notifyIdx = TIER_ORDER.indexOf('NOTIFY');
  if (currentIdx < notifyIdx) {
    tier = 'NOTIFY';
  }

  // CoinGecko 키 미설정 + 최초 1회 힌트
  const cacheKey = `${priceResult.chain}:${priceResult.tokenAddress}`;
  const coingeckoKey = ctx.settingsService?.get('oracle.coingecko_api_key');
  if (!coingeckoKey && !hintedTokens.has(cacheKey)) {
    hintedTokens.add(cacheKey);
    // POLICY_VIOLATION 알림에 힌트 포함 (알림은 아래에서 발생)
    // 힌트 메시지를 evaluation.reason 또는 별도 컨텍스트에 첨부
  }
}
// oracleDown: 아무것도 하지 않음 -- 네이티브 금액 기준 tier가 이미 설정됨
```

**힌트 포함 알림 처리:**
notListed + 힌트 조건일 때 POLICY_VIOLATION 알림의 extras에 힌트를 포함한다. 기존 ctx.notificationService?.notify 호출 패턴을 활용. 단, policy가 deny하지 않은 경우(allowed=true)에도 notListed는 발생할 수 있으므로, tier 설정 후 별도 알림을 발송한다:

```typescript
if (priceResult?.type === 'notListed') {
  const hint = (!coingeckoKey && shouldShowHint)
    ? 'CoinGecko API 키를 설정하면 이 토큰의 USD 가격을 조회할 수 있습니다. Admin Settings > Oracle에서 설정하세요.'
    : undefined;

  void ctx.notificationService?.notify('SPENDING_LIMIT', ctx.walletId, {
    amount: getRequestAmount(ctx.request),
    to: getRequestTo(ctx.request),
    reason: `가격 불명 토큰 (${priceResult.tokenAddress}) -- 최소 NOTIFY 격상`,
    policyType: 'SPENDING_LIMIT',
    hint,
  }, { txId: ctx.txId });
}
```

주의: 기존 `if (!evaluation.allowed)` 분기(deny 처리)는 그대로 유지. notListed 처리는 deny가 아닌 경우에만 실행 (tier 격상은 allowed=true인 상태에서 적용).

**2. packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts -- Stage 3 USD 통합 테스트:**

기존 pipeline-stage1-stage3.test.ts에 "Stage 3: USD Policy Integration" describe 블록을 추가한다.

테스트 케이스 (최소 7개):
1. **priceOracle 있음 + TRANSFER + success**: stage3Policy 호출 후 tier가 USD 기준으로 결정됨 (mock priceOracle + mock DatabasePolicyEngine)
2. **priceOracle 있음 + TOKEN_TRANSFER + notListed**: tier가 최소 NOTIFY로 격상됨 + audit_log에 UNLISTED_TOKEN_TRANSFER 삽입 확인
3. **priceOracle 있음 + oracleDown**: 네이티브 금액만으로 평가 (usdAmount 미전달)
4. **priceOracle 미설정 (undefined)**: 기존 네이티브 전용 평가 (하위 호환)
5. **notListed + CoinGecko 키 미설정**: 힌트 포함 알림 발송 + hintedTokens에 등록
6. **notListed + 동일 토큰 재전송**: 힌트가 두 번째에는 포함되지 않음 (최초 1회)
7. **BATCH + 일부 notListed**: notListed 격상 + 감사 로그

mock 패턴: ctx.priceOracle를 vi.fn()으로 모킹. ctx.policyEngine을 DatabasePolicyEngine 대신 mock IPolicyEngine으로. ctx.db는 인메모리 SQLite.

커밋: `feat(127-03): Stage 3 파이프라인 USD 통합 + notListed 격상 + oracleDown fallback + 힌트`
  </action>
  <verify>
npx vitest run packages/daemon/src/__tests__/pipeline-stage1-stage3.test.ts -- 모든 테스트 PASS
npx vitest run packages/daemon -- 전체 daemon 테스트 회귀 없음
npx tsc --noEmit -p packages/daemon -- 타입 체크 통과
  </verify>
  <done>
stage3Policy가 evaluateAndReserve 전에 resolveEffectiveAmountUsd를 호출하고, success/oracleDown/notListed 3-state에 따라 올바르게 분기한다. notListed 시 NOTIFY 격상 + 감사 로그 + 힌트가 동작하고 7개 이상의 통합 테스트가 PASS한다.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon` -- 전체 daemon 테스트 PASS (기존 + 신규)
2. `npx tsc --noEmit -p packages/daemon` -- 타입 체크 통과
3. `npx tsc --noEmit -p packages/core` -- core 타입 체크 통과
4. OracleChain DI: daemon.ts에서 OracleChain 생성 확인 (grep "new OracleChain")
5. PipelineContext.priceOracle: stages.ts에서 priceOracle 필드 확인
6. audit_log: UNLISTED_TOKEN_TRANSFER eventType 삽입 확인 (grep "UNLISTED_TOKEN_TRANSFER")
7. 힌트: hintedTokens Set + settingsService.get('oracle.coingecko_api_key') 확인
</verification>

<success_criteria>
- OracleChain이 daemon 시작 시 Pyth primary + (optional) CoinGecko fallback으로 생성된다
- stage3Policy가 evaluateAndReserve 진입 전에 resolveEffectiveAmountUsd를 호출한다
- PriceResult.success -> usdAmount가 evaluateAndReserve에 전달된다
- PriceResult.oracleDown -> 네이티브 금액만으로 평가가 계속된다
- PriceResult.notListed -> 최소 NOTIFY 격상 + UNLISTED_TOKEN_TRANSFER 감사 로그
- CoinGecko 키 미설정 + notListed -> 최초 1회 키 안내 힌트 알림
- priceOracle 미설정 시 기존 동작과 100% 하위 호환
- AdminRouteDeps.priceOracle에 OracleChain 인스턴스가 전달되어 GET /admin/oracle-status가 동작한다
- 7개 이상의 Stage 3 통합 테스트가 PASS
</success_criteria>

<output>
After completion, create `.planning/phases/127-usd-policy-integration/127-03-SUMMARY.md`
</output>
