---
phase: 231-core-caip-module-network-map
plan: 02
type: execute
wave: 2
depends_on: ["231-01"]
files_modified:
  - packages/core/src/caip/network-map.ts
  - packages/core/src/caip/asset-helpers.ts
  - packages/core/src/caip/index.ts
  - packages/core/src/interfaces/x402.types.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/interfaces/price-oracle.types.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/caip.test.ts
  - packages/core/src/__tests__/package-exports.test.ts
  - packages/daemon/src/services/wc-session-service.ts
autonomous: true
requirements:
  - CAIP-06
  - CAIP-07
  - CAIP-08
  - CAIP-09
  - CAIP-10
  - TOKN-01

must_haves:
  truths:
    - "networkToCaip2('ethereum-mainnet') returns 'eip155:1' and all 13 NetworkType values resolve correctly"
    - "caip2ToNetwork('eip155:1') returns { chain: 'ethereum', network: 'ethereum-mainnet' } and all 13 CAIP-2 IDs resolve"
    - "nativeAssetId('ethereum-mainnet') returns 'eip155:1/slip44:60'"
    - "nativeAssetId('polygon-mainnet') returns 'eip155:137/slip44:966' (NOT slip44:60)"
    - "nativeAssetId('mainnet') returns 'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/slip44:501'"
    - "tokenAssetId('ethereum-mainnet', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48') lowercases the address"
    - "tokenAssetId('mainnet', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v') preserves Solana base58 case"
    - "isNativeAsset('eip155:1/slip44:60') returns true; isNativeAsset('eip155:1/erc20:0x...') returns false"
    - "x402.types.ts re-exports CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, parseCaip2 from caip/ module"
    - "Existing x402-types.test.ts passes without modification after re-export refactor"
    - "wc-session-service.ts uses NETWORK_TO_CAIP2 from @waiaas/core instead of local CAIP2_CHAIN_IDS"
    - "TokenRefSchema.parse succeeds with and without optional assetId/network fields"
    - "All caip/ exports available via import from '@waiaas/core'"
  artifacts:
    - path: "packages/core/src/caip/network-map.ts"
      provides: "CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, networkToCaip2, caip2ToNetwork"
      exports: ["CAIP2_TO_NETWORK", "NETWORK_TO_CAIP2", "networkToCaip2", "caip2ToNetwork"]
    - path: "packages/core/src/caip/asset-helpers.ts"
      provides: "nativeAssetId, tokenAssetId, isNativeAsset"
      exports: ["nativeAssetId", "tokenAssetId", "isNativeAsset"]
    - path: "packages/core/src/interfaces/x402.types.ts"
      provides: "Backward-compatible re-exports of CAIP maps from caip/ module"
    - path: "packages/core/src/interfaces/price-oracle.types.ts"
      provides: "TokenRefSchema with optional assetId and network fields"
      contains: "assetId.*Caip19Schema.*optional"
    - path: "packages/daemon/src/services/wc-session-service.ts"
      provides: "WC session service using consolidated NETWORK_TO_CAIP2"
  key_links:
    - from: "packages/core/src/caip/network-map.ts"
      to: "packages/core/src/enums/chain.ts"
      via: "import ChainType, NetworkType"
      pattern: "import.*ChainType.*NetworkType.*from.*enums"
    - from: "packages/core/src/caip/asset-helpers.ts"
      to: "packages/core/src/caip/network-map.ts"
      via: "import networkToCaip2"
      pattern: "import.*networkToCaip2.*from.*network-map"
    - from: "packages/core/src/caip/asset-helpers.ts"
      to: "packages/core/src/caip/caip2.ts"
      via: "import parseCaip2 for namespace detection"
      pattern: "import.*parseCaip2.*from.*caip2"
    - from: "packages/core/src/interfaces/x402.types.ts"
      to: "packages/core/src/caip/index.ts"
      via: "import + re-export CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, parseCaip2"
      pattern: "import.*from.*caip/index"
    - from: "packages/daemon/src/services/wc-session-service.ts"
      to: "@waiaas/core"
      via: "import NETWORK_TO_CAIP2"
      pattern: "import.*NETWORK_TO_CAIP2.*from.*@waiaas/core"
    - from: "packages/core/src/index.ts"
      to: "packages/core/src/caip/index.ts"
      via: "barrel export caip module to package public API"
      pattern: "export.*from.*caip/index"
---

<objective>
Build the 13-network bidirectional map, asset helper functions (nativeAssetId, tokenAssetId, isNativeAsset), integrate with existing codebase (x402 re-export, WC consolidation), extend TokenRef schema, and wire barrel exports.

Purpose: Complete the CAIP module so that any code in the monorepo can import CAIP-2/19 utilities from `@waiaas/core`. Consolidate duplicate CAIP-2 maps (x402.types.ts + wc-session-service.ts) into the single caip/ module. Extend TokenRef with optional CAIP-19 assetId for Phase 232 price cache migration.

Output: 2 new source files (network-map.ts, asset-helpers.ts), 4 modified source files (x402.types.ts, interfaces/index.ts, price-oracle.types.ts, core/index.ts), 1 modified daemon file (wc-session-service.ts), extended caip.test.ts with network map + asset helper tests, updated package-exports.test.ts.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/231-core-caip-module-network-map/231-RESEARCH.md
@.planning/phases/231-core-caip-module-network-map/231-01-SUMMARY.md
@packages/core/src/caip/index.ts
@packages/core/src/interfaces/x402.types.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/interfaces/price-oracle.types.ts
@packages/core/src/index.ts
@packages/core/src/enums/chain.ts
@packages/daemon/src/services/wc-session-service.ts
@packages/core/src/__tests__/x402-types.test.ts
@packages/core/src/__tests__/package-exports.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement network-map.ts, asset-helpers.ts, extend caip/index.ts + tests</name>
  <files>
    packages/core/src/caip/network-map.ts
    packages/core/src/caip/asset-helpers.ts
    packages/core/src/caip/index.ts
    packages/core/src/__tests__/caip.test.ts
  </files>
  <action>
**1. Create `packages/core/src/caip/network-map.ts`:**

Consolidate the CAIP-2 <-> NetworkType mapping from x402.types.ts. This becomes the SSoT for all CAIP-2/NetworkType conversions.

- Import `ChainType` and `NetworkType` types from `../enums/chain.js`
- Define `CAIP2_TO_NETWORK: Record<string, { chain: ChainType; network: NetworkType }>` with all 13 entries (identical to current x402.types.ts lines 20-36)
- Define `NETWORK_TO_CAIP2` as reverse mapping (same `Object.fromEntries` pattern as x402.types.ts lines 39-41), typed as `Record<NetworkType, string>`
- Implement `networkToCaip2(network: NetworkType): string` -- throws if not found
- Implement `caip2ToNetwork(caip2: string): { chain: ChainType; network: NetworkType }` -- throws if not found

**2. Create `packages/core/src/caip/asset-helpers.ts`:**

- Import `NetworkType` from `../enums/chain.js`
- Import `parseCaip2` from `./caip2.js`
- Import `formatCaip19`, `parseCaip19` from `./caip19.js`
- Import `networkToCaip2` from `./network-map.js`
- Define `NATIVE_SLIP44: Record<string, number>` -- keyed by CAIP-2 chain ID:
  - `eip155:1` -> 60, `eip155:11155111` -> 60
  - `eip155:137` -> 966, `eip155:80002` -> 966 (Polygon uses POL, NOT ETH!)
  - `eip155:42161` -> 60, `eip155:421614` -> 60
  - `eip155:10` -> 60, `eip155:11155420` -> 60
  - `eip155:8453` -> 60, `eip155:84532` -> 60
  - `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp` -> 501
  - `solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1` -> 501
  - `solana:4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z` -> 501
- Implement `nativeAssetId(network: NetworkType): string` -- uses networkToCaip2 + NATIVE_SLIP44 + formatCaip19
- Implement `tokenAssetId(network: NetworkType, address: string): string`:
  - Get CAIP-2 from networkToCaip2, parse namespace via parseCaip2
  - If `namespace === 'eip155'`: use `erc20` asset namespace, `address.toLowerCase()` (EVM normalization)
  - If `namespace === 'solana'`: use `token` asset namespace, preserve address as-is (NEVER lowercase Solana base58!)
  - Throw for unsupported namespace
- Implement `isNativeAsset(caip19: string): boolean` -- returns `parseCaip19(caip19).assetNamespace === 'slip44'`

**3. Update `packages/core/src/caip/index.ts`:**

Add exports for network-map.ts and asset-helpers.ts:
```typescript
// Network map (CAIP-2 <-> NetworkType bidirectional)
export { CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, networkToCaip2, caip2ToNetwork } from './network-map.js';

// Asset helpers (native + token CAIP-19 generation)
export { nativeAssetId, tokenAssetId, isNativeAsset } from './asset-helpers.js';
```

**4. Extend `packages/core/src/__tests__/caip.test.ts`:**

Add test groups AFTER existing tests (from plan 231-01):

9. **CAIP2_TO_NETWORK / NETWORK_TO_CAIP2 maps** (~5 tests):
   - 13 entries each
   - Every value maps to valid ChainType and NetworkType
   - 10 EVM + 3 Solana entries
   - Bidirectional roundtrip consistency

10. **networkToCaip2()** (~4 tests):
    - `networkToCaip2('ethereum-mainnet')` returns `'eip155:1'`
    - `networkToCaip2('mainnet')` returns `'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp'`
    - All 13 NetworkType values resolve without error (loop test)
    - Throws for unknown network string

11. **caip2ToNetwork()** (~3 tests):
    - `caip2ToNetwork('eip155:1')` returns `{ chain: 'ethereum', network: 'ethereum-mainnet' }`
    - `caip2ToNetwork('solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp')` returns `{ chain: 'solana', network: 'mainnet' }`
    - Throws for unknown CAIP-2 string

12. **nativeAssetId()** (~6 tests):
    - `nativeAssetId('ethereum-mainnet')` returns `'eip155:1/slip44:60'`
    - `nativeAssetId('polygon-mainnet')` returns `'eip155:137/slip44:966'` (NOT 60!)
    - `nativeAssetId('polygon-amoy')` returns `'eip155:80002/slip44:966'`
    - `nativeAssetId('mainnet')` returns `'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/slip44:501'`
    - `nativeAssetId('base-mainnet')` returns `'eip155:8453/slip44:60'`
    - All 13 native asset IDs are valid CAIP-19 strings (loop + Caip19Schema.parse)

13. **tokenAssetId()** (~5 tests):
    - `tokenAssetId('ethereum-mainnet', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48')` returns with lowercased address and `erc20` namespace
    - `tokenAssetId('mainnet', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v')` preserves Solana base58 case, uses `token` namespace
    - `tokenAssetId('polygon-mainnet', '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359')` lowercases address
    - All token asset IDs are valid CAIP-19 strings
    - EVM addresses that are already lowercase produce same result (idempotent)

14. **isNativeAsset()** (~4 tests):
    - `isNativeAsset('eip155:1/slip44:60')` returns `true`
    - `isNativeAsset('solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/slip44:501')` returns `true`
    - `isNativeAsset('eip155:1/erc20:0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')` returns `false`
    - `isNativeAsset('solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v')` returns `false`

Import the new exports: `import { CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, networkToCaip2, caip2ToNetwork, nativeAssetId, tokenAssetId, isNativeAsset, Caip19Schema } from '../caip/index.js';`
Also import `{ NETWORK_TYPES, CHAIN_TYPES } from '../enums/chain.js';` for validation.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec vitest run src/__tests__/caip.test.ts` -- ALL tests pass (both plan-01 tests and new tests).
  </verify>
  <done>network-map.ts and asset-helpers.ts implemented with all 13 networks. caip.test.ts extended with ~27 additional tests. All tests pass. Polygon correctly uses slip44:966. EVM addresses lowercased. Solana base58 preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate with x402, WC, TokenRef, and barrel exports</name>
  <files>
    packages/core/src/interfaces/x402.types.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/interfaces/price-oracle.types.ts
    packages/core/src/index.ts
    packages/core/src/__tests__/package-exports.test.ts
    packages/daemon/src/services/wc-session-service.ts
  </files>
  <action>
**1. Refactor `packages/core/src/interfaces/x402.types.ts`:**

Remove the local definitions of `CAIP2_TO_NETWORK`, `NETWORK_TO_CAIP2`, and `parseCaip2`. Import from the new caip/ module and re-export for backward compatibility.

BEFORE (lines 18-54): Local `CAIP2_TO_NETWORK` map, `NETWORK_TO_CAIP2` derivation, `parseCaip2()` function.
AFTER:
- Add import at top: `import { CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, parseCaip2 } from '../caip/index.js';`
- Add re-export: `export { CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, parseCaip2 };`
- Delete the local `CAIP2_TO_NETWORK` definition (lines 20-36)
- Delete the local `NETWORK_TO_CAIP2` definition (lines 38-41)
- Delete the local `parseCaip2()` function (lines 43-54)
- Keep `resolveX402Network()` as-is (it's x402-specific business logic, references `CAIP2_TO_NETWORK` which is now imported)
- Keep all x402 Zod schemas and @x402/core re-exports unchanged

**CRITICAL:** The `import type { ChainType, NetworkType }` at line 2 is still needed for `resolveX402Network` return type. Keep it.

**2. Update `packages/core/src/interfaces/index.ts`:**

The existing exports from x402.types.ts (`CAIP2_TO_NETWORK`, `NETWORK_TO_CAIP2`, `parseCaip2`, `resolveX402Network`) continue to work because x402.types.ts now re-exports from caip/. No change needed to the x402 section.

Add new caip/ module exports (directly from caip/, NOT through x402.types.ts -- caip/ is a utility module like enums/):

```typescript
// v27.2 CAIP-2/19 module (Zod schemas, parsers, formatters, network map, asset helpers)
export {
  Caip2Schema,
  type Caip2,
  type Caip2Params,
  formatCaip2,
  Caip19AssetTypeSchema,
  Caip19Schema,
  type Caip19AssetType,
  type Caip19,
  type Caip19Params,
  formatCaip19,
  parseCaip19,
  networkToCaip2,
  caip2ToNetwork,
  nativeAssetId,
  tokenAssetId,
  isNativeAsset,
} from '../caip/index.js';
```

NOTE: `parseCaip2`, `CAIP2_TO_NETWORK`, `NETWORK_TO_CAIP2` are already exported via the x402.types.ts re-export path. Do NOT duplicate them here. Only add the NEW symbols that don't already go through x402.

**3. Extend `packages/core/src/interfaces/price-oracle.types.ts` (TokenRef):**

Add imports at top:
```typescript
import { Caip19Schema } from '../caip/index.js';
import { NetworkTypeEnum } from '../enums/chain.js';
```

Extend TokenRefSchema with two new optional fields (after the existing `chain` field):
```typescript
  /** CAIP-19 asset type URI (optional, for standard asset identification). */
  assetId: Caip19Schema.optional(),
  /** L2 network disambiguation (optional, complements chain for multi-network). */
  network: NetworkTypeEnum.optional(),
```

This is additive -- both fields are `.optional()`, so existing consumers that don't provide them continue to work.

**4. Update `packages/core/src/index.ts`:**

Add new caip/ exports. These go through `interfaces/index.ts` which now re-exports them.

Add in the interfaces type exports section:
```typescript
  // v27.2 CAIP types
  Caip2,
  Caip2Params,
  Caip19AssetType,
  Caip19,
  Caip19Params,
```

Add in the value exports section (new block after the x402 block):
```typescript
// v27.2 CAIP-2/19 module (schemas, parsers, formatters, network map, asset helpers)
export {
  Caip2Schema,
  formatCaip2,
  Caip19AssetTypeSchema,
  Caip19Schema,
  formatCaip19,
  parseCaip19,
  networkToCaip2,
  caip2ToNetwork,
  nativeAssetId,
  tokenAssetId,
  isNativeAsset,
} from './interfaces/index.js';
```

NOTE: `parseCaip2`, `CAIP2_TO_NETWORK`, `NETWORK_TO_CAIP2` are already exported in the x402 block at lines 236-247. Do NOT re-export them -- that would cause duplicate export errors.

**5. Refactor `packages/daemon/src/services/wc-session-service.ts`:**

Delete the local `CAIP2_CHAIN_IDS` map (lines 41-57). Import `NETWORK_TO_CAIP2` from `@waiaas/core`:

- Add to existing imports from `@waiaas/core`: `NETWORK_TO_CAIP2`
- Delete the `CAIP2_CHAIN_IDS` constant entirely (lines 36-57)
- At line 223 where `CAIP2_CHAIN_IDS[network]` is used, replace with `NETWORK_TO_CAIP2[network]`:
  ```typescript
  const chainId = NETWORK_TO_CAIP2[network] ??
    (chain === 'solana' ? `solana:${network}` : `eip155:${network}`);
  ```
  This is a direct replacement -- both maps have the same shape (`Record<string, string>` mapping NetworkType -> CAIP-2).

**6. Update `packages/core/src/__tests__/package-exports.test.ts`:**

Add a new test case:
```typescript
it('CAIP-2/19 module exports are available', () => {
  // Schemas
  expect(core.Caip2Schema).toBeDefined();
  expect(core.Caip19Schema).toBeDefined();
  expect(core.Caip19AssetTypeSchema).toBeDefined();
  // Parsers/formatters
  expect(core.parseCaip2).toBeDefined();
  expect(core.formatCaip2).toBeDefined();
  expect(core.parseCaip19).toBeDefined();
  expect(core.formatCaip19).toBeDefined();
  // Network map
  expect(core.CAIP2_TO_NETWORK).toBeDefined();
  expect(core.NETWORK_TO_CAIP2).toBeDefined();
  expect(core.networkToCaip2).toBeDefined();
  expect(core.caip2ToNetwork).toBeDefined();
  // Asset helpers
  expect(core.nativeAssetId).toBeDefined();
  expect(core.tokenAssetId).toBeDefined();
  expect(core.isNativeAsset).toBeDefined();
});
```
  </action>
  <verify>
Run the full test suites that could be affected:
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec vitest run src/__tests__/caip.test.ts` -- all CAIP tests pass
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec vitest run src/__tests__/x402-types.test.ts` -- existing x402 tests still pass (backward compat confirmed)
3. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec vitest run src/__tests__/package-exports.test.ts` -- package export test passes including new caip exports
4. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck` -- all packages compile without errors (cross-package resolution works)
  </verify>
  <done>x402.types.ts re-exports from caip/ (backward-compatible). wc-session-service.ts uses NETWORK_TO_CAIP2 from @waiaas/core (CAIP2_CHAIN_IDS deleted). TokenRefSchema includes optional assetId and network fields. All caip/ exports available via `import from '@waiaas/core'`. Existing x402-types.test.ts passes unchanged. Package typecheck passes across all packages.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core exec vitest run` -- all core package tests pass
2. `pnpm turbo run typecheck` -- all packages compile (daemon imports NETWORK_TO_CAIP2 from @waiaas/core)
3. `pnpm turbo run lint` -- no lint errors
4. Verify `x402-types.test.ts` passes unchanged (backward compatibility)
5. Verify `package-exports.test.ts` asserts all 15 caip/ module exports
6. Verify `nativeAssetId('polygon-mainnet')` produces `slip44:966` not `slip44:60`
7. Verify `tokenAssetId('mainnet', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v')` preserves exact Solana address case
8. Verify `wc-session-service.ts` no longer defines `CAIP2_CHAIN_IDS`
</verification>

<success_criteria>
- network-map.ts SSoT with 13-network bidirectional mapping (CAIP2_TO_NETWORK, NETWORK_TO_CAIP2, networkToCaip2, caip2ToNetwork)
- asset-helpers.ts with nativeAssetId (slip44 per network), tokenAssetId (erc20/token namespace), isNativeAsset
- x402.types.ts refactored to import+re-export from caip/ (no local CAIP map definitions)
- wc-session-service.ts uses NETWORK_TO_CAIP2 from @waiaas/core (CAIP2_CHAIN_IDS deleted)
- TokenRefSchema extended with optional assetId (Caip19Schema) and network (NetworkTypeEnum)
- All caip/ exports wired through interfaces/index.ts and core/index.ts barrel
- All tests pass: caip.test.ts (~65 tests), x402-types.test.ts (unchanged), package-exports.test.ts (extended)
- pnpm turbo run typecheck passes across all packages
- pnpm turbo run lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/231-core-caip-module-network-map/231-02-SUMMARY.md`
</output>
