---
phase: 138-forex-display-currency
plan: 02
type: execute
wave: 2
depends_on: ["138-01"]
files_modified:
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/infrastructure/settings/hot-reload.ts
  - packages/daemon/src/daemon.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/admin/src/pages/settings.tsx
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/components/currency-select.tsx
autonomous: true

must_haves:
  truths:
    - "SettingsService.get('display.currency')로 현재 표시 통화 코드를 조회할 수 있다"
    - "Admin Settings에서 검색 가능한 드롭다운으로 43개 통화 중 하나를 선택할 수 있다"
    - "통화 선택 시 드롭다운 옆에 현재 환율 미리보기가 표시된다 (예: '1 USD = ₩1,450')"
    - "통화 변경이 SettingsService를 통해 저장되고 hot-reload로 즉시 반영된다"
    - "daemon 부트스트랩에서 ForexRateService가 초기화되어 REST API에서 사용 가능하다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "DaemonConfigSchema에 display 섹션 추가"
      contains: "display"
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "display.currency 설정 키 정의"
      contains: "display.currency"
    - path: "packages/admin/src/components/currency-select.tsx"
      provides: "검색 가능한 통화 드롭다운 + 환율 미리보기 컴포넌트"
      exports: ["CurrencySelect"]
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "Display 섹션이 추가된 Settings 페이지"
      contains: "DisplaySettings"
  key_links:
    - from: "packages/admin/src/components/currency-select.tsx"
      to: "/v1/admin/forex/rates"
      via: "fetch로 환율 미리보기 조회"
      pattern: "admin/forex/rates"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "packages/admin/src/components/currency-select.tsx"
      via: "CurrencySelect 컴포넌트 import"
      pattern: "CurrencySelect"
    - from: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      via: "SETTING_DEFINITIONS에 display.currency 등록"
      pattern: "display\\.currency"
    - from: "packages/daemon/src/daemon.ts"
      to: "packages/daemon/src/infrastructure/oracle/forex-rate-service.ts"
      via: "ForexRateService 인스턴스 생성 + admin route deps 주입"
      pattern: "ForexRateService"
---

<objective>
SettingsService display 카테고리 + config.toml display 섹션 + Admin Settings 통화 드롭다운 + daemon 부트스트랩 통합

Purpose: Admin에서 표시 통화를 선택하고 환율 미리보기를 확인하며, hot-reload로 즉시 반영되는 설정 인프라를 완성한다.
Output: display.currency 설정, 검색 가능한 CurrencySelect 컴포넌트, ForexRateService daemon 통합
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@objectives/v1.5.3-usd-policy-enhancement.md
@.planning/phases/138-forex-display-currency/138-01-SUMMARY.md

@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/infrastructure/settings/settings-service.ts
@packages/daemon/src/infrastructure/settings/hot-reload.ts
@packages/daemon/src/api/routes/admin.ts
@packages/admin/src/pages/settings.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/components/form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: config.toml display 섹션 + SettingsService display 카테고리 + daemon 부트스트랩 ForexRateService 통합</name>
  <files>
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/infrastructure/settings/hot-reload.ts
    packages/daemon/src/daemon.ts
    packages/daemon/src/api/routes/admin.ts
  </files>
  <action>
    **1. `packages/daemon/src/infrastructure/config/loader.ts` 수정**

    DaemonConfigSchema에 `display` 섹션 추가:

    ```typescript
    display: z
      .object({
        currency: z.string().default('USD'),
      })
      .default({}),
    ```

    KNOWN_SECTIONS에 `'display'` 추가.

    환경변수: `WAIAAS_DISPLAY_CURRENCY=KRW` -> display.currency = 'KRW' (applyEnvOverrides가 자동 처리).

    **2. `packages/daemon/src/infrastructure/settings/setting-keys.ts` 수정**

    SETTING_CATEGORIES에 `'display'` 추가:
    ```typescript
    export const SETTING_CATEGORIES = [
      'notifications', 'rpc', 'security', 'daemon', 'walletconnect', 'oracle', 'display',
    ] as const;
    ```

    SETTING_DEFINITIONS에 display.currency 추가:
    ```typescript
    // --- display category ---
    { key: 'display.currency', category: 'display', configPath: 'display.currency', defaultValue: 'USD', isCredential: false },
    ```

    **3. `packages/daemon/src/infrastructure/settings/hot-reload.ts` 수정**

    display 카테고리 변경 감지 추가. display.currency 변경은 별도 reload 로직 불필요 (SettingsService.get()이 DB에서 직접 읽으므로 즉시 반영). 단, 로깅은 추가:

    ```typescript
    const DISPLAY_KEYS = new Set(['display.currency']);
    // handleChangedKeys에서:
    const hasDisplayChanges = changedKeys.some((k) => DISPLAY_KEYS.has(k));
    if (hasDisplayChanges) {
      console.log('Hot-reload: Display currency updated (effective immediately)');
    }
    ```

    **4. `packages/daemon/src/daemon.ts` 수정**

    daemon 부트스트랩에서 ForexRateService 인스턴스 생성:

    ```typescript
    // 기존 OracleChain 생성 근처에 추가
    import { CoinGeckoForexProvider, ForexRateService, InMemoryPriceCache } from './infrastructure/oracle/index.js';

    // ForexRateService 초기화 (30분 TTL 전용 캐시)
    const forexCache = new InMemoryPriceCache(
      30 * 60 * 1000,   // TTL: 30분
      2 * 60 * 60 * 1000, // staleMax: 2시간
      64,                // maxEntries: 64 (43 통화 + 여유)
    );
    const coingeckoApiKey = settingsService.get('oracle.coingecko_api_key');
    const forexProvider = new CoinGeckoForexProvider(coingeckoApiKey);
    const forexRateService = new ForexRateService({ forexProvider, cache: forexCache });
    ```

    admin route deps에 forexRateService 주입:
    ```typescript
    const adminDeps = {
      // ... 기존 deps ...
      forexRateService,
    };
    ```

    **5. `packages/daemon/src/api/routes/admin.ts` 수정**

    138-01에서 추가한 GET /admin/forex/rates 핸들러가 deps.forexRateService를 사용하도록 연결.

    AdminRouteDeps 타입 수정 (138-01에서 이미 추가됨):
    ```typescript
    forexRateService?: IForexRateService;
    ```

    PUT /admin/settings 응답에서 display 카테고리도 포함:
    ```typescript
    return c.json({
      updated: entries.length,
      settings: {
        notifications: masked.notifications ?? {},
        rpc: masked.rpc ?? {},
        security: masked.security ?? {},
        daemon: masked.daemon ?? {},
        walletconnect: masked.walletconnect ?? {},
        oracle: masked.oracle ?? {},
        display: masked.display ?? {},  // 추가
      },
    }, 200);
    ```

    GET /admin/settings 응답에도 display 카테고리 포함 (getAllMasked()가 자동으로 포함하므로, 응답 포맷만 확인).
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/daemon` 빌드 성공
    2. `grep "display" packages/daemon/src/infrastructure/config/loader.ts` -- display 섹션 확인
    3. `grep "display.currency" packages/daemon/src/infrastructure/settings/setting-keys.ts` -- 설정 키 확인
    4. `grep "forexRateService" packages/daemon/src/daemon.ts` -- 부트스트랩 확인
    5. 기존 테스트 회귀: `npx vitest run packages/daemon/tests/ --reporter=verbose 2>&1 | tail -20`
  </verify>
  <done>
    - config.toml에 [display] 섹션이 정의되고 WAIAAS_DISPLAY_CURRENCY 환경변수로 오버라이드 가능
    - SettingsService에서 display.currency 설정을 get/set 가능
    - display.currency 변경이 hot-reload로 즉시 반영 (DB 직접 읽기)
    - daemon 부트스트랩에서 ForexRateService가 30분 TTL 전용 캐시로 초기화
    - admin route deps에 forexRateService 주입 완료
    - DISP-03 (SettingsService display 카테고리 + hot-reload) 충족
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin Settings 통화 드롭다운 (CurrencySelect 컴포넌트) + 환율 미리보기</name>
  <files>
    packages/admin/src/components/currency-select.tsx
    packages/admin/src/pages/settings.tsx
    packages/admin/src/api/endpoints.ts
  </files>
  <action>
    **1. `packages/admin/src/api/endpoints.ts` 수정**

    forex rates 엔드포인트 추가:
    ```typescript
    ADMIN_FOREX_RATES: '/v1/admin/forex/rates',
    ```

    **2. `packages/admin/src/components/currency-select.tsx` (신규)**

    검색 가능한 통화 드롭다운 + 환율 미리보기 컴포넌트.
    외부 라이브러리 사용하지 않고, 순수 Preact + @preact/signals로 구현 (프로젝트 원칙: 0 new npm packages).

    ```tsx
    import { useSignal, useComputed } from '@preact/signals';
    import { useEffect } from 'preact/hooks';
    import { apiGet } from '../api/client';
    import { API } from '../api/endpoints';

    // 43개 통화 메타데이터 (인라인 -- daemon의 forex-currencies.ts와 동기화)
    // Admin은 CSP(default-src 'none') 환경이므로 daemon 코드 직접 import 불가 -> 프론트엔드용 사본 유지
    const CURRENCIES = [
      { code: 'USD', name: 'US Dollar', symbol: '$' },
      { code: 'KRW', name: 'Korean Won', symbol: '₩' },
      { code: 'JPY', name: 'Japanese Yen', symbol: '¥' },
      { code: 'EUR', name: 'Euro', symbol: '€' },
      { code: 'GBP', name: 'British Pound', symbol: '£' },
      // ... 43개 전부
    ];

    interface CurrencySelectProps {
      value: string;                    // 현재 선택된 통화 코드
      onChange: (code: string) => void; // 변경 콜백
    }

    export function CurrencySelect({ value, onChange }: CurrencySelectProps) {
      const search = useSignal('');
      const isOpen = useSignal(false);
      const ratePreview = useSignal<string | null>(null);
      const rateLoading = useSignal(false);

      // 검색 필터
      const filtered = useComputed(() => {
        const q = search.value.toLowerCase();
        if (!q) return CURRENCIES;
        return CURRENCIES.filter(c =>
          c.code.toLowerCase().includes(q) ||
          c.name.toLowerCase().includes(q) ||
          c.symbol.includes(q)
        );
      });

      // 환율 미리보기 조회 (value 변경 시)
      useEffect(() => {
        if (value === 'USD') {
          ratePreview.value = '1 USD = $1.00';
          return;
        }
        rateLoading.value = true;
        apiGet<{ rates: Record<string, { rate: number; preview: string }> }>(
          `${API.ADMIN_FOREX_RATES}?currencies=${value}`
        )
          .then((data) => {
            const info = data.rates[value];
            ratePreview.value = info?.preview ?? null;
          })
          .catch(() => {
            ratePreview.value = null;
          })
          .finally(() => {
            rateLoading.value = false;
          });
      }, [value]);

      // 현재 선택된 통화 메타
      const selected = CURRENCIES.find(c => c.code === value) ?? CURRENCIES[0];

      return (
        <div class="currency-select">
          {/* 선택된 통화 표시 + 토글 버튼 */}
          <button
            type="button"
            class="currency-select-trigger"
            onClick={() => { isOpen.value = !isOpen.value; }}
          >
            <span class="currency-select-value">
              {selected.code} - {selected.name} ({selected.symbol})
            </span>
            <span class="currency-select-chevron">{isOpen.value ? '▲' : '▼'}</span>
          </button>

          {/* 환율 미리보기 */}
          {ratePreview.value && (
            <div class="currency-rate-preview">
              {rateLoading.value ? '...' : ratePreview.value}
            </div>
          )}

          {/* 드롭다운 */}
          {isOpen.value && (
            <div class="currency-select-dropdown">
              <input
                type="text"
                class="currency-select-search"
                placeholder="Search currency..."
                value={search.value}
                onInput={(e) => { search.value = (e.target as HTMLInputElement).value; }}
                autoFocus
              />
              <div class="currency-select-list">
                {filtered.value.map((c) => (
                  <button
                    key={c.code}
                    type="button"
                    class={`currency-select-option ${c.code === value ? 'currency-select-option--active' : ''}`}
                    onClick={() => {
                      onChange(c.code);
                      isOpen.value = false;
                      search.value = '';
                    }}
                  >
                    <span class="currency-option-code">{c.code}</span>
                    <span class="currency-option-name">{c.name}</span>
                    <span class="currency-option-symbol">{c.symbol}</span>
                  </button>
                ))}
                {filtered.value.length === 0 && (
                  <div class="currency-select-empty">No currencies found</div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }
    ```

    CSS 클래스는 기존 Admin 스타일 패턴(settings.css 또는 global.css)에 추가. 드롭다운은 absolute 포지셔닝, max-height 300px, overflow-y auto.

    드롭다운 외부 클릭 시 닫기: useEffect + document.addEventListener('mousedown', handler) 패턴.

    **3. `packages/admin/src/pages/settings.tsx` 수정**

    Display 섹션을 기존 카테고리 섹션들 사이에 추가 (DaemonSettings 다음, ApiKeysSection 전):

    ```tsx
    import { CurrencySelect } from '../components/currency-select';

    function DisplaySettings() {
      return (
        <div class="settings-category">
          <div class="settings-category-header">
            <h3>Display</h3>
            <p class="settings-description">Configure display currency for USD amount conversion</p>
          </div>
          <div class="settings-category-body">
            <div class="settings-fields-grid">
              <div class="settings-field-full">
                <label>Display Currency</label>
                <CurrencySelect
                  value={getEffectiveValue('display', 'currency') || 'USD'}
                  onChange={(code) => handleFieldChange('display.currency', code)}
                />
              </div>
            </div>
            <div class="settings-info-box">
              All USD amounts in the dashboard, notifications, and API responses will be
              converted to the selected currency. Policy evaluation always uses USD.
              The "≈" prefix indicates an approximate conversion.
            </div>
          </div>
        </div>
      );
    }
    ```

    메인 렌더에서 DisplaySettings 추가:
    ```tsx
    <NotificationSettings />
    <RpcSettings />
    <SecuritySettings />
    <WalletConnectSettings />
    <DaemonSettings />
    <DisplaySettings />       {/* 신규 */}
    <ApiKeysSection />
    ```

    **keyToLabel에 display 키 추가:**
    ```typescript
    currency: 'Display Currency',
    ```

    **settings 응답의 display 카테고리 처리:**
    getAllMasked()가 이미 display 카테고리를 포함하므로, getEffectiveValue('display', 'currency')가 정상 동작.

    **CSS 스타일 추가** (기존 admin CSS 파일에):
    ```css
    .currency-select { position: relative; }
    .currency-select-trigger {
      width: 100%; display: flex; justify-content: space-between; align-items: center;
      padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);
      background: var(--bg); cursor: pointer; font-size: var(--font-size-sm);
    }
    .currency-rate-preview {
      margin-top: 0.25rem; font-size: var(--font-size-xs); color: var(--text-secondary);
    }
    .currency-select-dropdown {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      border: 1px solid var(--border); border-radius: var(--radius);
      background: var(--bg); box-shadow: var(--shadow-md);
      margin-top: 0.25rem;
    }
    .currency-select-search {
      width: 100%; padding: 0.5rem 0.75rem; border: none;
      border-bottom: 1px solid var(--border); outline: none;
    }
    .currency-select-list { max-height: 300px; overflow-y: auto; }
    .currency-select-option {
      width: 100%; display: flex; gap: 0.5rem; padding: 0.5rem 0.75rem;
      border: none; background: none; cursor: pointer; text-align: left;
    }
    .currency-select-option:hover { background: var(--bg-hover); }
    .currency-select-option--active { background: var(--bg-active); font-weight: 600; }
    .currency-option-code { font-weight: 600; min-width: 3rem; }
    .currency-option-name { flex: 1; }
    .currency-option-symbol { color: var(--text-secondary); }
    .currency-select-empty { padding: 0.75rem; text-align: center; color: var(--text-secondary); }
    ```

    CSS 추가 위치는 기존 admin CSS 파일 패턴을 따른다 (global.css 또는 settings-specific).
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/admin` 빌드 성공
    2. `npx turbo build` 전체 빌드 성공
    3. `grep "CurrencySelect" packages/admin/src/pages/settings.tsx` -- 컴포넌트 통합 확인
    4. `grep "display.currency" packages/daemon/src/infrastructure/settings/setting-keys.ts` -- 설정 키 확인
    5. `grep "ADMIN_FOREX_RATES" packages/admin/src/api/endpoints.ts` -- 엔드포인트 확인
    6. 기존 테스트 회귀: `npx vitest run --reporter=verbose 2>&1 | tail -20`
  </verify>
  <done>
    - Admin Settings에 Display 섹션이 추가되어 43개 통화를 검색/선택 가능
    - 통화 선택 시 드롭다운 옆에 환율 미리보기 표시 (예: "1 USD = ₩1,450")
    - display.currency 변경이 SettingsService를 통해 저장되고 hot-reload 즉시 반영
    - daemon 부트스트랩에서 ForexRateService가 CoinGecko provider + 30분 캐시로 초기화
    - DISP-03 (SettingsService display 카테고리 + hot-reload), DISP-04 (Admin Settings 통화 드롭다운 + 환율 미리보기) 충족
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` -- 전체 모노레포 빌드 성공
2. `npx vitest run` -- 전체 테스트 스위트 통과 (신규 + 기존)
3. Admin Settings 페이지에 Display 섹션 렌더링 확인 (빌드 출력물에 CurrencySelect 포함)
4. config.toml에 `[display]` 섹션 파싱 가능, `WAIAAS_DISPLAY_CURRENCY` 환경변수 오버라이드 가능
5. SettingsService.get('display.currency') 기본값 'USD' 반환 확인
</verification>

<success_criteria>
- DaemonConfigSchema에 display.currency가 정의되고 기본값 'USD'
- SETTING_DEFINITIONS에 display.currency가 등록되고 SettingsService CRUD 동작
- display.currency 변경 시 hot-reload 로그 출력 (즉시 반영)
- ForexRateService가 daemon 부트스트랩에서 생성되어 admin routes에 주입
- CurrencySelect 컴포넌트가 43개 통화를 검색 가능한 드롭다운으로 표시
- 통화 선택 시 GET /admin/forex/rates로 환율 조회하여 미리보기 표시
- 전체 빌드 + 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/138-forex-display-currency/138-02-SUMMARY.md`
</output>
