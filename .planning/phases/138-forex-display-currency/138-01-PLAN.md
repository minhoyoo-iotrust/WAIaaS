---
phase: 138-forex-display-currency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/forex-rate.types.ts
  - packages/core/src/interfaces/index.ts
  - packages/daemon/src/infrastructure/oracle/coingecko-forex.ts
  - packages/daemon/src/infrastructure/oracle/forex-rate-service.ts
  - packages/daemon/src/infrastructure/oracle/forex-currencies.ts
  - packages/daemon/src/infrastructure/oracle/index.ts
  - packages/daemon/src/infrastructure/oracle/oracle-errors.ts
  - packages/core/src/utils/format-currency.ts
  - packages/core/src/utils/index.ts
  - packages/core/src/index.ts
autonomous: true

must_haves:
  truths:
    - "IForexRateService.getRate('USD', 'KRW') 호출 시 환율(number)이 반환된다"
    - "CoinGecko vs_currencies=krw 쿼리로 환율이 조회되고, InMemoryPriceCache에 30분 TTL로 캐시된다"
    - "환율 조회 실패 시 null이 반환되어 graceful fallback이 가능하다"
    - "formatDisplayCurrency(500, 'KRW', 1450)가 '(approx)W725,000' 형태로 포맷된다"
    - "USD 외 통화에는 'approx' 접두사가 붙고, USD는 접두사 없이 '$500.00'으로 포맷된다"
  artifacts:
    - path: "packages/core/src/interfaces/forex-rate.types.ts"
      provides: "IForexRateService 인터페이스 + ForexRate + CurrencyCode + SUPPORTED_CURRENCIES"
      exports: ["IForexRateService", "ForexRateSchema", "CurrencyCodeSchema", "SUPPORTED_CURRENCIES"]
    - path: "packages/daemon/src/infrastructure/oracle/coingecko-forex.ts"
      provides: "CoinGecko vs_currencies 기반 forex 환율 조회 구현"
      exports: ["CoinGeckoForexProvider"]
    - path: "packages/daemon/src/infrastructure/oracle/forex-rate-service.ts"
      provides: "ForexRateService -- InMemoryPriceCache 통합, CoinGeckoForexProvider 래핑"
      exports: ["ForexRateService"]
    - path: "packages/daemon/src/infrastructure/oracle/forex-currencies.ts"
      provides: "43개 법정 통화 메타데이터 (코드, 이름, 기호, 소수점 자릿수)"
      exports: ["CURRENCY_META", "getCurrencyMeta"]
    - path: "packages/core/src/utils/format-currency.ts"
      provides: "Intl.NumberFormat 기반 통화 포매팅 유틸리티"
      exports: ["formatDisplayCurrency", "formatCurrencySymbol"]
  key_links:
    - from: "packages/daemon/src/infrastructure/oracle/forex-rate-service.ts"
      to: "packages/daemon/src/infrastructure/oracle/coingecko-forex.ts"
      via: "CoinGeckoForexProvider 의존 주입"
      pattern: "CoinGeckoForexProvider"
    - from: "packages/daemon/src/infrastructure/oracle/forex-rate-service.ts"
      to: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      via: "InMemoryPriceCache.getOrFetch() 30분 TTL"
      pattern: "cache\\.getOrFetch"
    - from: "packages/core/src/utils/format-currency.ts"
      to: "Intl.NumberFormat"
      via: "Node.js 내장 Intl API"
      pattern: "Intl\\.NumberFormat"
---

<objective>
IForexRateService 인터페이스와 CoinGecko 기반 forex 환율 조회 구현 + Intl.NumberFormat 포매팅 유틸리티

Purpose: Phase 139 표시 통화 통합의 기반. USD -> 43개 법정 통화 환율 조회와 통화별 포매팅을 제공한다.
Output: IForexRateService 인터페이스, CoinGeckoForexProvider, ForexRateService, 통화 메타데이터, formatDisplayCurrency 유틸
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@objectives/v1.5.3-usd-policy-enhancement.md

@packages/core/src/interfaces/price-oracle.types.ts
@packages/core/src/interfaces/index.ts
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
@packages/daemon/src/infrastructure/oracle/oracle-chain.ts
@packages/daemon/src/infrastructure/oracle/oracle-errors.ts
@packages/daemon/src/infrastructure/oracle/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: IForexRateService 인터페이스 + CoinGeckoForexProvider + ForexRateService + 통화 메타데이터</name>
  <files>
    packages/core/src/interfaces/forex-rate.types.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/index.ts
    packages/daemon/src/infrastructure/oracle/forex-currencies.ts
    packages/daemon/src/infrastructure/oracle/coingecko-forex.ts
    packages/daemon/src/infrastructure/oracle/forex-rate-service.ts
    packages/daemon/src/infrastructure/oracle/oracle-errors.ts
    packages/daemon/src/infrastructure/oracle/index.ts
  </files>
  <action>
    **1. `packages/core/src/interfaces/forex-rate.types.ts` (신규)**

    Zod SSoT 패턴으로 forex 타입 정의:

    ```typescript
    // CurrencyCodeSchema -- 43개 법정 통화 enum
    export const CurrencyCodeSchema = z.enum(['USD', 'KRW', 'JPY', 'EUR', 'GBP', 'CNY', 'CAD', 'AUD', 'CHF', 'SGD', 'HKD', 'INR', 'TWD', 'THB', 'MYR', 'IDR', 'PHP', 'VND', 'BRL', 'MXN', 'CLP', 'TRY', 'PLN', 'CZK', 'HUF', 'SEK', 'NOK', 'DKK', 'NZD', 'ZAR', 'ILS', 'SAR', 'AED', 'KWD', 'BHD', 'NGN', 'RUB', 'UAH', 'PKR', 'BDT', 'LKR', 'MMK', 'GEL']);
    export type CurrencyCode = z.infer<typeof CurrencyCodeSchema>;

    // ForexRateSchema
    export const ForexRateSchema = z.object({
      from: z.literal('USD'),
      to: CurrencyCodeSchema,
      rate: z.number().positive(),
      source: z.enum(['coingecko', 'cache']),
      fetchedAt: z.number().int().positive(),
      expiresAt: z.number().int().positive(),
    });
    export type ForexRate = z.infer<typeof ForexRateSchema>;

    // IForexRateService interface -- IPriceOracle과 별도 (기술 결정 #10)
    export interface IForexRateService {
      getRate(to: CurrencyCode): Promise<ForexRate | null>;
      getRates(currencies: CurrencyCode[]): Promise<Map<CurrencyCode, ForexRate>>;
    }
    ```

    getRate()는 실패 시 throw 대신 null 반환 (graceful fallback 원칙).

    **2. `packages/core/src/interfaces/index.ts` 수정**

    forex-rate.types.ts에서 export 추가:
    ```typescript
    // v1.5.3 Forex Rate types (Zod SSoT)
    export type { ForexRate, CurrencyCode, IForexRateService } from './forex-rate.types.js';
    export { ForexRateSchema, CurrencyCodeSchema } from './forex-rate.types.js';
    ```

    **3. `packages/core/src/index.ts` 수정**

    interfaces/index.ts가 이미 re-export하므로, forex 타입이 core에서 접근 가능한지 확인. 필요하면 추가.

    **4. `packages/daemon/src/infrastructure/oracle/forex-currencies.ts` (신규)**

    43개 법정 통화 메타데이터. Admin UI 드롭다운과 Intl.NumberFormat에서 사용:

    ```typescript
    export interface CurrencyMeta {
      code: string;       // 'KRW'
      name: string;       // 'Korean Won'
      symbol: string;     // '₩'
      decimals: number;   // 0 (KRW/JPY), 2 (EUR/GBP), 3 (KWD/BHD)
      locale: string;     // 'ko-KR' (Intl.NumberFormat용)
    }

    export const CURRENCY_META: readonly CurrencyMeta[] = [
      { code: 'USD', name: 'US Dollar', symbol: '$', decimals: 2, locale: 'en-US' },
      { code: 'KRW', name: 'Korean Won', symbol: '₩', decimals: 0, locale: 'ko-KR' },
      { code: 'JPY', name: 'Japanese Yen', symbol: '¥', decimals: 0, locale: 'ja-JP' },
      { code: 'EUR', name: 'Euro', symbol: '€', decimals: 2, locale: 'de-DE' },
      // ... 43개 전부 작성 (objective 문서 Part 2 표 참조)
    ];

    export function getCurrencyMeta(code: string): CurrencyMeta | undefined {
      return CURRENCY_META.find((c) => c.code === code);
    }
    ```

    KWD/BHD는 decimals: 3 (1000분의 1 단위). 대부분은 2, KRW/JPY/VND/CLP/HUF/PKR는 0.

    **5. `packages/daemon/src/infrastructure/oracle/coingecko-forex.ts` (신규)**

    CoinGecko의 `/simple/price?ids=usd&vs_currencies=krw,jpy,eur,...` 엔드포인트로 환율 조회.
    기존 CoinGeckoOracle과 동일한 HTTP 패턴 사용 (x-cg-demo-api-key 헤더, AbortSignal.timeout 5초).

    핵심: CoinGecko는 crypto 가격을 vs_currencies로 변환한다. 1 USD의 다른 통화 가격을 구하려면 `/simple/price?ids=tether&vs_currencies=krw,jpy,eur,...`를 사용 (USDT = ~1 USD 근사).
    또는 더 정확하게: CoinGecko에서 직접 forex는 제공하지 않으므로, 다음 전략 사용:
    - BTC의 USD 가격과 KRW 가격을 동시에 조회 -> KRW/USD = BTC_KRW / BTC_USD
    - 또는 stablecoin(tether)의 vs_currencies로 조회: `/simple/price?ids=tether&vs_currencies=krw,jpy,eur`

    **tether 방식 채택** (더 간단, 1 API call, USDT ~ 1 USD):

    ```typescript
    export class CoinGeckoForexProvider {
      private readonly apiKey: string;

      constructor(apiKey: string) { this.apiKey = apiKey; }

      async getRates(currencies: string[]): Promise<Map<string, number>> {
        // GET /simple/price?ids=tether&vs_currencies=krw,jpy,eur,...
        // Response: { "tether": { "krw": 1450.12, "jpy": 150.5, ... } }
        const vsCurrencies = currencies.map(c => c.toLowerCase()).join(',');
        const url = `https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=${vsCurrencies}`;
        const res = await fetch(url, {
          headers: { 'x-cg-demo-api-key': this.apiKey },
          signal: AbortSignal.timeout(5000),
        });
        if (!res.ok) throw new Error(`CoinGecko forex error: ${res.status}`);
        const data = await res.json();
        const tetherData = data.tether ?? {};
        const result = new Map<string, number>();
        for (const curr of currencies) {
          const rate = tetherData[curr.toLowerCase()];
          if (typeof rate === 'number' && rate > 0) {
            result.set(curr, rate);
          }
        }
        return result;
      }
    }
    ```

    CoinGecko API 키가 없으면(`apiKey === ''`) getRates에서 빈 Map 반환 (throw하지 않음 -- graceful).

    **6. `packages/daemon/src/infrastructure/oracle/forex-rate-service.ts` (신규)**

    ForexRateService -- IForexRateService 구현. InMemoryPriceCache 재사용 (30분 TTL):

    ```typescript
    export interface ForexRateServiceDeps {
      forexProvider: CoinGeckoForexProvider;
      cache: InMemoryPriceCache;  // 기존 crypto cache와 별도 인스턴스 (TTL 30분)
    }

    export class ForexRateService implements IForexRateService {
      private static readonly FOREX_TTL_MS = 30 * 60 * 1000; // 30분

      constructor(private deps: ForexRateServiceDeps) {}

      async getRate(to: CurrencyCode): Promise<ForexRate | null> {
        if (to === 'USD') return { from: 'USD', to: 'USD', rate: 1, source: 'cache', fetchedAt: Date.now(), expiresAt: Date.now() + ... };
        const cacheKey = `forex:USD/${to}`;
        // cache에서 조회, 없으면 CoinGeckoForexProvider로 fetch
        // PriceInfo 형태로 저장하기 위해 어댑팅 필요
        // 실패 시 null 반환 (graceful fallback)
      }

      async getRates(currencies: CurrencyCode[]): Promise<Map<CurrencyCode, ForexRate>> {
        // batch: 캐시 미스 통화만 CoinGecko 호출
      }
    }
    ```

    cache 키 패턴: `forex:USD/KRW` -- 기존 crypto 캐시 키(`chain:address`)와 충돌 안 함.
    InMemoryPriceCache는 PriceInfo 타입을 기대하므로, forex rate를 PriceInfo로 래핑하여 저장 (usdPrice = rate, source = 'coingecko'/'cache').
    getRate() try-catch로 감싸서 어떤 오류든 null 반환 (graceful fallback 보장).

    **중요**: InMemoryPriceCache를 별도 인스턴스로 생성 (ttlMs=30분, staleMaxMs=2시간). 기존 crypto 캐시와 분리하여 TTL 충돌 방지.

    **7. `packages/daemon/src/infrastructure/oracle/oracle-errors.ts` 수정**

    ForexNotAvailableError 클래스 추가 (선택 -- ForexRateService가 null 반환하므로 외부 노출은 안 하지만, 내부 로깅용).

    **8. `packages/daemon/src/infrastructure/oracle/index.ts` 수정**

    신규 모듈 barrel export 추가:
    ```typescript
    export { CoinGeckoForexProvider } from './coingecko-forex.js';
    export { ForexRateService, type ForexRateServiceDeps } from './forex-rate-service.js';
    export { CURRENCY_META, getCurrencyMeta, type CurrencyMeta } from './forex-currencies.js';
    ```
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build --filter=@waiaas/core --filter=@waiaas/daemon` 빌드 성공
    2. TypeScript 컴파일 에러 없음
    3. `grep -r "IForexRateService" packages/core/src/` -- 인터페이스 export 확인
    4. `grep -r "CoinGeckoForexProvider" packages/daemon/src/` -- provider 존재 확인
    5. `grep -r "CURRENCY_META" packages/daemon/src/` -- 43개 통화 메타 확인
  </verify>
  <done>
    - IForexRateService 인터페이스가 @waiaas/core에서 export됨
    - CoinGeckoForexProvider가 tether vs_currencies로 환율 조회
    - ForexRateService가 InMemoryPriceCache(30분 TTL)로 캐시하며, 실패 시 null 반환
    - CURRENCY_META에 43개 통화의 code/name/symbol/decimals/locale 포함
    - ForexRateSchema Zod 스키마로 타입 안전성 보장
  </done>
</task>

<task type="auto">
  <name>Task 2: formatDisplayCurrency 유틸리티 + REST API forex/rates 엔드포인트 + 테스트</name>
  <files>
    packages/core/src/utils/format-currency.ts
    packages/core/src/utils/index.ts
    packages/core/src/index.ts
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/tests/unit/oracle/forex-rate-service.test.ts
    packages/daemon/tests/unit/oracle/coingecko-forex.test.ts
    packages/core/tests/unit/utils/format-currency.test.ts
  </files>
  <action>
    **1. `packages/core/src/utils/format-currency.ts` (신규)**

    Intl.NumberFormat 기반 통화 포매팅 유틸리티 (DISP-09):

    ```typescript
    /**
     * Format a USD amount in the specified display currency.
     *
     * @param amountUsd - USD 금액
     * @param currencyCode - 표시 통화 코드 ('KRW', 'JPY', 'EUR', ...)
     * @param rate - USD -> 통화 환율 (1 USD = rate 통화)
     * @returns 포맷된 문자열. USD 외 통화는 "≈" 접두사.
     *
     * 예시:
     *   formatDisplayCurrency(500, 'USD', 1) => '$500.00'
     *   formatDisplayCurrency(500, 'KRW', 1450) => '≈₩725,000'
     *   formatDisplayCurrency(500, 'JPY', 150) => '≈¥75,000'
     *   formatDisplayCurrency(500, 'EUR', 0.93) => '≈€465.00'
     */
    export function formatDisplayCurrency(
      amountUsd: number,
      currencyCode: string,
      rate: number,
    ): string {
      const converted = amountUsd * rate;
      const formatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 0,
        maximumFractionDigits: currencyCode === 'KRW' || currencyCode === 'JPY' || ... ? 0 : 2,
      }).format(converted);

      // USD는 "≈" 접두사 없음
      if (currencyCode === 'USD') return formatted;
      return `≈${formatted}`;
    }
    ```

    'en-US' locale 사용으로 일관된 숫자 형식 (1,000.00). Intl.NumberFormat이 통화별 기호를 자동 처리.
    소수점 자릿수: KRW/JPY/VND/CLP/HUF 등 0자리 통화는 maximumFractionDigits: 0. 나머지는 2. KWD/BHD는 3.
    forex-currencies.ts의 CurrencyMeta.decimals를 참조하여 결정 (getCurrencyMeta import).

    추가 함수:
    ```typescript
    /**
     * Format a rate preview string for Admin Settings.
     * 예: formatRatePreview(1450, 'KRW') => '1 USD = ₩1,450'
     */
    export function formatRatePreview(rate: number, currencyCode: string): string {
      if (currencyCode === 'USD') return '1 USD = $1.00';
      const formatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 0,
        maximumFractionDigits: currencyCode === 'KRW' || ... ? 0 : 2,
      }).format(rate);
      return `1 USD = ${formatted}`;
    }
    ```

    **2. `packages/core/src/utils/index.ts` 수정 (또는 신규 생성)**

    format-currency.ts barrel export. core의 index.ts에서 utils를 re-export하는 패턴이 있으면 따른다. 없으면 `packages/core/src/index.ts`에 직접 추가:
    ```typescript
    export { formatDisplayCurrency, formatRatePreview } from './utils/format-currency.js';
    ```

    **3. Admin REST API: `GET /admin/forex/rates` 엔드포인트 (admin.ts)**

    Admin Settings 통화 드롭다운의 환율 미리보기를 위한 엔드포인트.

    packages/daemon/src/api/routes/admin.ts에 추가:

    ```typescript
    // GET /admin/forex/rates?currencies=KRW,JPY,EUR
    // Response: { rates: { KRW: { rate: 1450.12, preview: "1 USD = ₩1,450" }, ... } }
    ```

    Route definition:
    - method: 'get'
    - path: '/admin/forex/rates'
    - tags: ['Admin']
    - query: currencies (optional, comma-separated) -- 미지정 시 현재 display.currency만 반환
    - Response 200: `{ rates: Record<string, { rate: number; preview: string }> }`

    핸들러에서 ForexRateService.getRates()를 호출하여 환율 조회.
    deps에 forexRateService 추가 필요 (daemon.ts 부트스트랩에서 주입은 138-02에서 처리).
    이 태스크에서는 route 정의 + 핸들러만 작성. deps.forexRateService가 없으면 빈 rates 반환.

    admin.ts의 AdminRouteDeps에 `forexRateService?: IForexRateService` 추가.

    **4. 테스트 작성**

    **`packages/daemon/tests/unit/oracle/coingecko-forex.test.ts`**:
    - CoinGeckoForexProvider.getRates(['KRW', 'JPY']) -- mock fetch, 정상 응답 -> Map에 2개 rate
    - API 키 없으면 빈 Map 반환
    - HTTP 오류 시 throw

    **`packages/daemon/tests/unit/oracle/forex-rate-service.test.ts`**:
    - ForexRateService.getRate('KRW') -- provider mock, 정상 -> ForexRate 반환
    - ForexRateService.getRate('USD') -- rate 1 즉시 반환 (오라클 미호출)
    - ForexRateService.getRate('KRW') 실패 시 -> null 반환 (graceful)
    - 캐시 히트 -> provider 미호출 확인
    - 30분 TTL 만료 후 재조회

    **`packages/core/tests/unit/utils/format-currency.test.ts`**:
    - formatDisplayCurrency(500, 'USD', 1) => '$500.00'
    - formatDisplayCurrency(500, 'KRW', 1450) => '≈₩725,000' (소수점 없음)
    - formatDisplayCurrency(500, 'JPY', 150) => '≈¥75,000' (소수점 없음)
    - formatDisplayCurrency(500, 'EUR', 0.93) => '≈€465.00'
    - formatDisplayCurrency(500, 'GBP', 0.79) => '≈£395.00'
    - formatRatePreview(1450, 'KRW') => '1 USD = ₩1,450'
    - formatRatePreview(1, 'USD') => '1 USD = $1.00'
    - 소수점 0자리 통화 (KRW, JPY, VND) 확인
    - KWD/BHD 3자리 소수점 확인

    테스트 디렉토리 패턴: 기존 코드베이스의 test 위치를 따른다.
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx turbo build` 전체 빌드 성공
    2. `npx vitest run packages/core/tests/unit/utils/format-currency.test.ts` 통과
    3. `npx vitest run packages/daemon/tests/unit/oracle/coingecko-forex.test.ts` 통과
    4. `npx vitest run packages/daemon/tests/unit/oracle/forex-rate-service.test.ts` 통과
    5. 기존 테스트 회귀 없음: `npx vitest run --reporter=verbose 2>&1 | tail -20`
  </verify>
  <done>
    - formatDisplayCurrency가 Intl.NumberFormat 기반으로 통화별 올바른 기호/소수점/포맷 적용
    - USD 외 통화에 "≈" 접두사 부착
    - GET /admin/forex/rates 엔드포인트가 환율 + 미리보기 문자열 반환
    - CoinGeckoForexProvider, ForexRateService, formatDisplayCurrency 각각 유닛 테스트 통과
    - DISP-01 (IForexRateService), DISP-02 (CoinGecko + 30분 캐시), DISP-09 (Intl.NumberFormat 포매팅) 충족
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` -- 전체 모노레포 빌드 성공 (TS 컴파일 오류 없음)
2. `npx vitest run` -- 신규 테스트 포함 전체 테스트 스위트 통과
3. `grep -r "IForexRateService" packages/core/dist/` -- 컴파일된 타입 export 확인
4. `grep -r "ForexRateService" packages/daemon/dist/` -- 서비스 클래스 빌드 확인
5. `grep -r "formatDisplayCurrency" packages/core/dist/` -- 유틸리티 빌드 확인
</verification>

<success_criteria>
- IForexRateService 인터페이스가 @waiaas/core에서 import 가능
- CoinGecko tether vs_currencies로 USD->KRW/JPY/EUR 환율 조회 동작 (mock 테스트)
- InMemoryPriceCache(30분 TTL)로 환율 캐시되고, 캐시 히트 시 API 미호출
- 환율 조회 실패 시 null 반환 (throw하지 않음)
- Intl.NumberFormat으로 KRW(₩, 0자리), JPY(¥, 0자리), EUR(€, 2자리) 등 올바른 포맷
- USD 외 통화는 "≈" 접두사, USD는 접두사 없음
- GET /admin/forex/rates 엔드포인트 존재
- 모든 신규 테스트 통과, 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/138-forex-display-currency/138-01-SUMMARY.md`
</output>
