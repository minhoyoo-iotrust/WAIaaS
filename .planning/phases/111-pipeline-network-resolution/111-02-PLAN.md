---
phase: 111-pipeline-network-resolution
plan: 02
type: execute
wave: 2
depends_on: ["111-01"]
files_modified:
  - packages/daemon/src/api/routes/transactions.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/pipeline/pipeline.ts
  - packages/daemon/src/__tests__/pipeline-network-resolve.test.ts
autonomous: true

must_haves:
  truths:
    - "POST /transactions/send에 network를 지정하면 해당 네트워크의 어댑터로 실행되고, 미지정 시 wallet.defaultNetwork가 사용된다"
    - "testnet 월렛이 mainnet 네트워크를 요청하면 ENVIRONMENT_NETWORK_MISMATCH (400)가 반환되고 PENDING 트랜잭션이 DB에 INSERT되지 않는다"
    - "daemon.ts executeFromStage5 재진입 시 tx.network(DB 기록값)을 사용하고 resolveNetwork()를 재호출하지 않는다"
    - "transactions 테이블에 실행 네트워크가 정확히 기록된다"
  artifacts:
    - path: "packages/daemon/src/api/routes/transactions.ts"
      provides: "resolveNetwork() 호출 + WAIaaSError 변환 + AdapterPool resolvedNetwork 전달"
      contains: "resolveNetwork"
    - path: "packages/daemon/src/lifecycle/daemon.ts"
      provides: "executeFromStage5 tx.network 직접 사용 + PipelineContext environment 모델"
      contains: "tx.network"
    - path: "packages/daemon/src/pipeline/pipeline.ts"
      provides: "TransactionPipeline.executeSend() PipelineContext resolvedNetwork 전달"
      contains: "resolvedNetwork"
    - path: "packages/daemon/src/__tests__/pipeline-network-resolve.test.ts"
      provides: "네트워크 해결 통합 테스트"
      min_lines: 80
  key_links:
    - from: "packages/daemon/src/api/routes/transactions.ts"
      to: "packages/daemon/src/pipeline/network-resolver.ts"
      via: "import resolveNetwork"
      pattern: "import.*resolveNetwork.*network-resolver"
    - from: "packages/daemon/src/api/routes/transactions.ts"
      to: "packages/daemon/src/pipeline/stages.ts"
      via: "PipelineContext.resolvedNetwork"
      pattern: "resolvedNetwork"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "transactions.network DB column"
      via: "tx.network direct read"
      pattern: "tx\\.network"
---

<objective>
Route Handler(transactions.ts), daemon.ts(executeFromStage5), pipeline.ts에서 resolveNetwork()를 호출하고, 환경 불일치 에러를 WAIaaSError로 변환하며, AdapterPool에 resolvedNetwork를 전달하는 통합 구현

Purpose: 실제 HTTP 요청 → 파이프라인 → 온체인 실행 경로에서 네트워크가 올바르게 해결/검증/기록/재진입되는 end-to-end 흐름을 완성한다.
Output: transactions.ts/daemon.ts/pipeline.ts 수정 + 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/111-pipeline-network-resolution/111-01-SUMMARY.md
@docs/70-pipeline-network-resolve-design.md (섹션 4: 환경 검증, 섹션 6: AdapterPool 호출부 변경)
@packages/daemon/src/api/routes/transactions.ts (POST /transactions/send 현재 구현)
@packages/daemon/src/lifecycle/daemon.ts (executeFromStage5 현재 구현, line 598-674)
@packages/daemon/src/pipeline/pipeline.ts (TransactionPipeline.executeSend 현재 구현)
@packages/daemon/src/pipeline/network-resolver.ts (111-01에서 생성)
@packages/daemon/src/pipeline/stages.ts (111-01에서 PipelineContext 확장 완료)
</context>

<tasks>

<task type="auto">
  <name>Task 1: transactions.ts + daemon.ts + pipeline.ts 네트워크 해결 통합</name>
  <files>
    packages/daemon/src/api/routes/transactions.ts
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/pipeline/pipeline.ts
  </files>
  <action>
    **1. transactions.ts POST /transactions/send 수정** (docs/70 섹션 6.4):
    - `import { resolveNetwork } from '../../pipeline/network-resolver.js';` 추가
    - `import type { EnvironmentType } from '@waiaas/core';` 추가 (기존 ChainType, NetworkType import에 병합)
    - wallet 조회 후, request JSON 파싱 후, 어댑터 해결 전에 resolveNetwork() 호출:
      ```typescript
      // Resolve network: request > wallet.defaultNetwork > environment default
      let resolvedNetwork: string;
      try {
        resolvedNetwork = resolveNetwork(
          request.network as NetworkType | undefined,
          wallet.defaultNetwork as NetworkType | null,
          wallet.environment as EnvironmentType,
          wallet.chain as ChainType,
        );
      } catch (err) {
        if (err instanceof Error && err.message.includes('environment')) {
          console.warn(
            `[SECURITY] Environment-network mismatch attempt: ` +
            `wallet=${walletId}, chain=${wallet.chain}, env=${wallet.environment}, ` +
            `requestedNetwork=${request.network ?? 'null'}`,
          );
          throw new WAIaaSError('ENVIRONMENT_NETWORK_MISMATCH', {
            message: err.message,
          });
        }
        throw new WAIaaSError('ACTION_VALIDATION_FAILED', {
          message: err instanceof Error ? err.message : 'Network validation failed',
        });
      }
      ```
    - resolveRpcUrl 호출의 3번째 인자를 `wallet.defaultNetwork!` -> `resolvedNetwork`로 변경
    - adapterPool.resolve 호출의 2번째 인자를 `wallet.defaultNetwork as NetworkType` -> `resolvedNetwork as NetworkType`로 변경
    - PipelineContext 생성부의 wallet 객체를 변경:
      ```typescript
      wallet: {
        publicKey: wallet.publicKey,
        chain: wallet.chain,
        environment: wallet.environment,
        defaultNetwork: wallet.defaultNetwork,
      },
      resolvedNetwork,
      ```

    **2. daemon.ts executeFromStage5 수정** (docs/70 섹션 6.5):
    - `import { getDefaultNetwork } from '@waiaas/core';` 추가 (또는 기존 import에 병합)
    - `import type { EnvironmentType } from '@waiaas/core';` 추가 (또는 기존 import에 병합)
    - tx.network 직접 사용 (resolveNetwork 재호출 안 함 -- PIPE-D04):
      ```typescript
      // Use network recorded at Stage 1 (NOT re-resolve -- wallet.defaultNetwork may have changed)
      const resolvedNetwork: string =
        tx.network
        ?? getDefaultNetwork(wallet.chain as ChainType, wallet.environment as EnvironmentType);
      ```
    - resolveRpcUrl 호출의 3번째 인자를 `wallet.defaultNetwork!` -> `resolvedNetwork`로 변경
    - adapterPool.resolve 호출의 2번째 인자를 `wallet.defaultNetwork as NetworkType` -> `resolvedNetwork as NetworkType`로 변경
    - PipelineContext의 wallet 객체를 변경:
      ```typescript
      wallet: {
        publicKey: wallet.publicKey,
        chain: wallet.chain,
        environment: wallet.environment,
        defaultNetwork: wallet.defaultNetwork,
      },
      resolvedNetwork,
      ```

    **3. pipeline.ts TransactionPipeline.executeSend 수정**:
    - `import { resolveNetwork } from './network-resolver.js';` 추가
    - `import type { ChainType, NetworkType, EnvironmentType } from '@waiaas/core';` 추가 (기존 import에 병합)
    - wallet 조회 후 resolveNetwork() 호출:
      ```typescript
      const resolvedNetwork = resolveNetwork(
        (request as { network?: string }).network as NetworkType | undefined,
        wallet.defaultNetwork as NetworkType | null,
        wallet.environment as EnvironmentType,
        wallet.chain as ChainType,
      );
      ```
    - PipelineContext의 wallet 객체를 변경:
      ```typescript
      wallet: {
        publicKey: wallet.publicKey,
        chain: wallet.chain,
        environment: wallet.environment,
        defaultNetwork: wallet.defaultNetwork,
      },
      resolvedNetwork,
      ```
    - Note: pipeline.ts는 직접 route handler에서 사용되지 않고 (transactions.ts가 직접 stages를 호출), approve/reject 워크플로우에서 사용될 수 있으므로 resolveNetwork를 여기서도 호출한다. 단, pipeline.ts에서 adapter 해결이 필요한 경우만 변경 (현재 PipelineDeps에 단일 adapter를 받으므로, resolvedNetwork는 PipelineContext에만 반영하고 adapter는 그대로).

    **커밋:** `feat(111-02): transactions.ts/daemon.ts/pipeline.ts resolveNetwork 통합 + 에러 변환`
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` 모노레포 전체 빌드 성공
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && grep -r 'wallet\.network' packages/daemon/src/pipeline/pipeline.ts packages/daemon/src/api/routes/transactions.ts packages/daemon/src/lifecycle/daemon.ts` -> 결과 없음 (모두 resolvedNetwork로 전환)
    - PipelineContext 생성부에 resolvedNetwork 필드가 존재
  </verify>
  <done>
    - transactions.ts에서 resolveNetwork() 호출 + ENVIRONMENT_NETWORK_MISMATCH WAIaaSError 변환 완료
    - daemon.ts executeFromStage5에서 tx.network 직접 사용 (resolveNetwork 재호출 안 함)
    - pipeline.ts에서 PipelineContext에 environment/defaultNetwork/resolvedNetwork 전달
    - 모노레포 전체 빌드 성공
  </done>
</task>

<task type="auto">
  <name>Task 2: 네트워크 해결 통합 테스트 + 기존 테스트 회귀 수정</name>
  <files>
    packages/daemon/src/__tests__/pipeline-network-resolve.test.ts
  </files>
  <action>
    **1. 통합 테스트 작성** (`packages/daemon/src/__tests__/pipeline-network-resolve.test.ts` 신규):
    - docs/70 부록 B 통합 테스트 기반:
      a. **Stage 1 네트워크 기록**: PipelineContext에 resolvedNetwork 설정 -> stage1Validate 실행 -> DB transactions.network 컬럼에 resolvedNetwork 기록 확인
      b. **Stage 3 네트워크 전달**: PipelineContext에 resolvedNetwork 설정 -> stage3Policy 실행 -> txParam.network이 resolvedNetwork로 전달되는지 확인 (DatabasePolicyEngine.evaluate의 transaction.network 인자)
      c. **환경 불일치 에러 변환 (route layer 시뮬레이션)**: resolveNetwork()에 mainnet wallet + devnet network 전달 -> catch -> WAIaaSError('ENVIRONMENT_NETWORK_MISMATCH') 생성 확인
      d. **chain 불일치 에러 변환**: resolveNetwork()에 solana + ethereum-sepolia 전달 -> catch -> WAIaaSError('ACTION_VALIDATION_FAILED') 생성 확인
      e. **daemon.ts 재진입 시뮬레이션**: tx.network이 있으면 그 값 사용, null이면 getDefaultNetwork fallback 확인

    - 테스트 구조:
      ```typescript
      import { describe, it, expect, vi, beforeEach } from 'vitest';
      import { resolveNetwork } from '../pipeline/network-resolver.js';
      import { WAIaaSError, getDefaultNetwork } from '@waiaas/core';
      // DB 테스트는 in-memory SQLite 사용 (기존 패턴 참조)
      ```

    **2. 기존 파이프라인 테스트 회귀 수정** (필요한 경우):
    - `pipeline.test.ts`, `pipeline-integration.test.ts`, `pipeline-stage1-stage3.test.ts` 등에서 PipelineContext mock이 `wallet.network` 대신 `wallet.environment + wallet.defaultNetwork` + `resolvedNetwork`를 사용하도록 수정
    - 패턴: `wallet: { publicKey: '...', chain: 'solana', network: 'devnet' }` -> `wallet: { publicKey: '...', chain: 'solana', environment: 'testnet', defaultNetwork: 'devnet' }, resolvedNetwork: 'devnet'`
    - 수정 대상 파일을 grep으로 찾기: `grep -rn "wallet:.*network:" packages/daemon/src/__tests__/pipeline*`

    **커밋:** `test(111-02): 네트워크 해결 통합 테스트 + 기존 파이프라인 테스트 회귀 수정`
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run packages/daemon/src/__tests__/pipeline-network-resolve.test.ts` PASS
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` 전체 통과 (pre-existing failures 제외)
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && grep -rn 'wallet:.*network:' packages/daemon/src/__tests__/pipeline* | grep -v resolvedNetwork` -> 결과 없음 (모두 전환됨)
  </verify>
  <done>
    - 네트워크 해결 통합 테스트 5개 PASS
    - 기존 파이프라인 테스트 회귀 없음 (PipelineContext mock 전환)
    - 전체 모노레포 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `transactions.ts`에서 `resolveNetwork` import + 호출 확인
2. `daemon.ts` executeFromStage5에서 `tx.network` 직접 사용 + `getDefaultNetwork` fallback 확인
3. `wallet.network` 참조가 pipeline.ts, transactions.ts, daemon.ts 3개 파일에서 모두 제거됨 확인
4. 통합 테스트: 환경 불일치 -> ENVIRONMENT_NETWORK_MISMATCH WAIaaSError 생성 확인
5. 통합 테스트: Stage 1 INSERT에 resolvedNetwork가 transactions.network에 기록 확인
6. 통합 테스트: Stage 3에서 policy evaluate에 network 전달 확인
7. `pnpm build` + `pnpm test` 전체 통과 (pre-existing failures 제외)
</verification>

<success_criteria>
- transactions.ts에서 resolveNetwork() 호출 + 에러 변환 완료
- daemon.ts에서 tx.network 직접 사용 (PIPE-D04 준수)
- pipeline.ts에서 PipelineContext environment 모델 전달
- 통합 테스트 5개 + 기존 테스트 회귀 없음
- 모노레포 전체 빌드 + 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/111-pipeline-network-resolution/111-02-SUMMARY.md`
</output>
