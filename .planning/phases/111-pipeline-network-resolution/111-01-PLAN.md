---
phase: 111-pipeline-network-resolution
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/pipeline/network-resolver.ts
  - packages/daemon/src/__tests__/network-resolver.test.ts
  - packages/core/src/errors/error-codes.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/core/src/__tests__/errors.test.ts
  - packages/core/src/__tests__/package-exports.test.ts
  - packages/daemon/src/pipeline/stages.ts
autonomous: true

must_haves:
  truths:
    - "resolveNetwork()가 3단계 우선순위(request > wallet.defaultNetwork > getDefaultNetwork)로 네트워크를 해결한다"
    - "chain-network 불일치 시 Error를 throw한다 (solana + ethereum-sepolia)"
    - "environment-network 불일치 시 Error를 throw한다 (mainnet wallet + devnet network)"
    - "ENVIRONMENT_NETWORK_MISMATCH 에러 코드가 ERROR_CODES에 존재한다"
    - "PipelineContext.wallet이 environment + defaultNetwork 필드를 가지고 resolvedNetwork가 최상위 필드로 존재한다"
  artifacts:
    - path: "packages/daemon/src/pipeline/network-resolver.ts"
      provides: "resolveNetwork() 순수 함수"
      exports: ["resolveNetwork"]
    - path: "packages/daemon/src/__tests__/network-resolver.test.ts"
      provides: "resolveNetwork() TDD 테스트"
      min_lines: 60
    - path: "packages/core/src/errors/error-codes.ts"
      provides: "ENVIRONMENT_NETWORK_MISMATCH 에러 코드"
      contains: "ENVIRONMENT_NETWORK_MISMATCH"
  key_links:
    - from: "packages/daemon/src/pipeline/network-resolver.ts"
      to: "@waiaas/core"
      via: "import getDefaultNetwork, validateChainNetwork, validateNetworkEnvironment"
      pattern: "import.*getDefaultNetwork.*validateChainNetwork.*validateNetworkEnvironment"
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "PipelineContext"
      via: "wallet.environment + wallet.defaultNetwork + resolvedNetwork"
      pattern: "resolvedNetwork.*string"
---

<objective>
resolveNetwork() 순수 함수 TDD 구현 + ENVIRONMENT_NETWORK_MISMATCH 에러 코드 추가 + PipelineContext 인터페이스 확장

Purpose: 트랜잭션 요청 시 네트워크를 3단계 우선순위로 자동 해결하고, 환경 불일치를 보안 에러로 차단하는 핵심 함수를 TDD로 구현한다.
Output: network-resolver.ts (순수 함수) + 테스트 + error-codes.ts 확장 + PipelineContext 인터페이스 변경
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/70-pipeline-network-resolve-design.md (섹션 2: resolveNetwork 설계, 섹션 3: 에러 코드, 섹션 5: PipelineContext)
@packages/core/src/enums/chain.ts (getDefaultNetwork, validateChainNetwork, validateNetworkEnvironment)
@packages/core/src/errors/error-codes.ts (기존 68개 에러 코드, BATCH_POLICY_VIOLATION 뒤에 추가)
@packages/daemon/src/pipeline/stages.ts (PipelineContext 인터페이스)
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- resolveNetwork() 테스트 + ENVIRONMENT_NETWORK_MISMATCH 에러 코드 + PipelineContext 확장</name>
  <files>
    packages/daemon/src/__tests__/network-resolver.test.ts
    packages/core/src/errors/error-codes.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/core/src/__tests__/errors.test.ts
    packages/core/src/__tests__/package-exports.test.ts
    packages/daemon/src/pipeline/stages.ts
  </files>
  <action>
    **1. ENVIRONMENT_NETWORK_MISMATCH 에러 코드 추가** (`packages/core/src/errors/error-codes.ts`):
    - `BATCH_POLICY_VIOLATION` 뒤에 추가:
      ```typescript
      ENVIRONMENT_NETWORK_MISMATCH: {
        code: 'ENVIRONMENT_NETWORK_MISMATCH',
        domain: 'TX',
        httpStatus: 400,
        retryable: false,
        message: "Network is not allowed in this wallet's environment",
      },
      ```
    - i18n/en.ts에 추가: `ENVIRONMENT_NETWORK_MISMATCH: "Network is not allowed in this wallet's environment"`
    - i18n/ko.ts에 추가: `ENVIRONMENT_NETWORK_MISMATCH: '네트워크가 이 지갑의 환경에서 허용되지 않습니다'`
    - `errors.test.ts`: ERROR_CODES 개수 68 -> 69로 수정
    - `package-exports.test.ts`: ERROR_CODES 개수 68 -> 69로 수정

    **2. PipelineContext 인터페이스 확장** (`packages/daemon/src/pipeline/stages.ts`):
    - `wallet: { publicKey: string; chain: string; network: string }` 를 다음으로 변경:
      ```typescript
      wallet: { publicKey: string; chain: string; environment: string; defaultNetwork: string | null };
      ```
    - `resolvedNetwork: string;` 필드를 `request` 바로 위에 추가
    - Stage 1 `stage1Validate`의 `db.insert(transactions).values({...})`에 `network: ctx.resolvedNetwork,` 추가 (chain 뒤)
    - Stage 3 `stage3Policy`의 `buildTransactionParam` 호출 후 `txParam.network = ctx.resolvedNetwork;` 한 줄 추가 (evaluate/evaluateAndReserve에 network 전달)
    - Stage 3 BATCH 분기에서도 각 params 항목에 `network: ctx.resolvedNetwork` 추가
    - `ctx.wallet.network` 참조가 있으면 `ctx.resolvedNetwork`로 변경

    **3. resolveNetwork() 테스트 작성** (`packages/daemon/src/__tests__/network-resolver.test.ts`):
    - docs/70 섹션 2.6 입출력 테이블 기반 11개 테스트 케이스:
      1. 모든 파라미터 null -> 3순위 fallback (solana+testnet -> devnet)
      2. requestNetwork 명시 -> 1순위 (solana+testnet+testnet -> testnet)
      3. requestNetwork 우선 (ethereum+testnet, request=polygon-amoy, wallet=ethereum-sepolia -> polygon-amoy)
      4. walletDefaultNetwork 사용 (ethereum+mainnet, wallet=polygon-mainnet -> polygon-mainnet)
      5. 3순위 fallback (ethereum+mainnet, null, null -> ethereum-mainnet)
      6. environment 불일치 FAIL (solana+mainnet+devnet -> throw)
      7. environment 불일치 FAIL (ethereum+testnet+ethereum-mainnet -> throw)
      8. chain 불일치 FAIL (solana+testnet+ethereum-sepolia -> throw)
      9. chain 불일치 FAIL (ethereum+mainnet+devnet -> throw)
      10. L2 testnet 사용 (ethereum+testnet, wallet=polygon-amoy -> polygon-amoy)
      11. requestNetwork 우선 override (solana+testnet, request=devnet, wallet=testnet -> devnet)
    - 테스트에서 `resolveNetwork` import: `from '../../pipeline/network-resolver.js'` (파일 미존재 -> RED)

    **커밋:** `test(111-01): resolveNetwork 11개 테스트 + ENVIRONMENT_NETWORK_MISMATCH 에러 코드 + PipelineContext 확장 (RED)`
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build` 성공
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core test` 통과 (에러 코드 69개 확인)
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run packages/daemon/src/__tests__/network-resolver.test.ts` FAIL (network-resolver.ts 미존재)
  </verify>
  <done>
    - ERROR_CODES에 ENVIRONMENT_NETWORK_MISMATCH가 69번째로 존재
    - PipelineContext에 wallet.environment + wallet.defaultNetwork + resolvedNetwork 필드 존재
    - Stage 1 INSERT에 network: ctx.resolvedNetwork 포함
    - Stage 3에서 txParam.network = ctx.resolvedNetwork 전달
    - network-resolver.test.ts에 11개 테스트가 존재하고 모두 FAIL (RED 상태)
  </done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- resolveNetwork() 순수 함수 구현 + 빌드/테스트 회귀 확인</name>
  <files>
    packages/daemon/src/pipeline/network-resolver.ts
  </files>
  <action>
    **resolveNetwork() 순수 함수 구현** (`packages/daemon/src/pipeline/network-resolver.ts` 신규 생성):
    - docs/70 섹션 2.2 시그니처 그대로 구현:
      ```typescript
      import {
        type ChainType,
        type EnvironmentType,
        type NetworkType,
        getDefaultNetwork,
        validateChainNetwork,
        validateNetworkEnvironment,
      } from '@waiaas/core';

      export function resolveNetwork(
        requestNetwork: NetworkType | undefined | null,
        walletDefaultNetwork: NetworkType | null,
        environment: EnvironmentType,
        chain: ChainType,
      ): NetworkType {
        // Step 1: 3-level priority
        const resolved: NetworkType =
          requestNetwork
          ?? walletDefaultNetwork
          ?? getDefaultNetwork(chain, environment);

        // Step 2: chain-network cross-validation
        validateChainNetwork(chain, resolved);

        // Step 3: environment-network cross-validation
        validateNetworkEnvironment(chain, environment, resolved);

        return resolved;
      }
      ```
    - 함수만 포함, 클래스 없음 (PIPE-D01 설계 결정)

    **빌드 + 테스트 회귀 확인:**
    - `pnpm --filter @waiaas/daemon build` 성공 확인
    - `pnpm --filter @waiaas/daemon test -- --run packages/daemon/src/__tests__/network-resolver.test.ts` 11개 PASS 확인
    - 기존 파이프라인 테스트에 PipelineContext 변경으로 인한 빌드 에러가 있으면, 테스트 파일의 PipelineContext mock에서 `wallet.network` -> `wallet: { ..., environment: 'testnet', defaultNetwork: 'devnet' }` + `resolvedNetwork: 'devnet'` 로 수정. `wallet.network` 참조를 `resolvedNetwork`로 변경.

    **커밋:** `feat(111-01): resolveNetwork() 순수 함수 구현 (GREEN)`
  </action>
  <verify>
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon test -- --run packages/daemon/src/__tests__/network-resolver.test.ts` 11개 PASS
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build` 모노레포 전체 빌드 성공
    - `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test` 기존 테스트 회귀 없음 (pre-existing failures 제외)
  </verify>
  <done>
    - resolveNetwork() 순수 함수가 3단계 우선순위로 네트워크를 해결한다
    - chain-network/environment-network 불일치 시 Error를 throw한다
    - 11개 TDD 테스트 모두 PASS
    - 모노레포 전체 빌드 성공 + 기존 테스트 회귀 없음
  </done>
</task>

</tasks>

<verification>
1. `packages/daemon/src/pipeline/network-resolver.ts` 파일이 존재하고 `resolveNetwork` export
2. `resolveNetwork('devnet', null, 'mainnet', 'solana')` 호출 시 Error throw (environment 불일치)
3. `resolveNetwork(null, null, 'testnet', 'solana')` 호출 시 'devnet' 반환 (3순위 fallback)
4. ERROR_CODES 객체에 ENVIRONMENT_NETWORK_MISMATCH 키 존재 (총 69개)
5. PipelineContext 인터페이스에 `resolvedNetwork: string` 필드 존재
6. Stage 1 INSERT에 `network: ctx.resolvedNetwork` 포함
7. Stage 3에서 policy evaluate 시 `txParam.network = ctx.resolvedNetwork` 전달
8. `pnpm build` + `pnpm test` 전체 통과 (pre-existing failures 제외)
</verification>

<success_criteria>
- resolveNetwork() 11개 TDD 테스트 PASS
- ENVIRONMENT_NETWORK_MISMATCH 에러 코드 69번째로 등록
- PipelineContext wallet.environment + wallet.defaultNetwork + resolvedNetwork 확장 완료
- Stage 1/3에서 resolvedNetwork 참조 완료
- 모노레포 빌드 + 기존 테스트 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/111-pipeline-network-resolution/111-01-SUMMARY.md`
</output>
