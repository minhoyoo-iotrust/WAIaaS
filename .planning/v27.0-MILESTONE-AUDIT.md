---
milestone: v27.0
audited: 2026-02-21
status: tech_debt
scores:
  requirements: 29/29
  phases: 7/7
  integration: 22/25
  flows: 3/4
gaps:
  requirements: []
  integration:
    - id: "GAP-1"
      description: "reconnectLoop이 IChainSubscriber에 없는 connect()/waitForDisconnect() 호출"
      location: "doc 76, §5.2 vs §1.4"
      affected_reqs: ["MON-01"]
      severity: "high"
    - id: "GAP-2"
      description: "EVM/Solana 폴링 BackgroundWorker 미등록 — pollAll() 호출자 없음"
      location: "doc 76, §4.7/§3.5 vs §8.9"
      affected_reqs: ["MON-03", "MON-04"]
      severity: "critical"
    - id: "GAP-3"
      description: "Summary API SQL이 미정의 incoming_tx_suspicious 테이블 참조"
      location: "doc 76, §7.6"
      affected_reqs: ["API-05"]
      severity: "critical"
  flows:
    - id: "FLOW-2"
      description: "WebSocket 실패 → 폴링 폴백 흐름이 폴링 워커 미등록으로 중단"
      broken_at: "polling workers activate"
      affected_reqs: ["MON-03", "MON-04"]
tech_debt:
  - phase: "215-ichainsubscriber-db-schema"
    items:
      - "GAP-4: eventBus.emit('transaction:incoming', { count }) 타입 충돌 — IncomingTxEvent와 불일치 (§2.6 vs §6.1)"
  - phase: "218-websocket-polling-fallback"
    items:
      - "GAP-1: reconnectLoop subscriber.connect()/waitForDisconnect() IChainSubscriber에 미정의"
      - "GAP-2: incoming-tx-poll-evm, incoming-tx-poll-solana BackgroundWorker 미등록"
  - phase: "219-notification-events-safety"
    items:
      - "NOTIFY-1: SUSPICIOUS 이벤트 priority:high 라우팅 메커니즘 미명세 (코멘트만 존재)"
      - "getDecimals() 헬퍼 함수 미정의 (DustAttackRule, LargeAmountRule에서 사용)"
  - phase: "220-rest-api-sdk-mcp"
    items:
      - "GAP-3: summary SQL에서 incoming_tx_suspicious 테이블 참조 — is_suspicious 컬럼으로 대체 필요"
  - phase: "221-config-integration-verify"
    items:
      - "PATCH /v1/wallet/:id 변경이 doc 31 영향 분석에 누락"
      - "skills/ 파일 업데이트 요구사항 미언급 (wallet.skill.md, transactions.skill.md)"
---

# v27.0 Milestone Audit: 수신 트랜잭션 모니터링 설계

## Overview

| Metric | Score |
|--------|-------|
| Requirements | 29/29 satisfied |
| Phases | 7/7 completed |
| Integration | 22/25 connections wired |
| E2E Flows | 3/4 complete |
| Design Doc | docs/design/76-incoming-transaction-monitoring.md (2,161 lines) |
| Status | **tech_debt** — all reqs met, design-internal inconsistencies for impl resolution |

## Requirements Coverage (3-Source Cross-Reference)

### Phase 215: IChainSubscriber 인터페이스 + DB 스키마

| REQ-ID | REQUIREMENTS.md | SUMMARY.md | Evidence | Status |
|--------|----------------|------------|----------|--------|
| MON-01 | [x] Done | ✅ Phase 215 | IChainSubscriber 4메서드 + IncomingTransaction 타입 (§1) | **satisfied** |
| DATA-01 | [x] Done | ✅ Phase 215 | incoming_transactions DDL 완성 (§2.1) | **satisfied** |
| DATA-02 | [x] Done | ✅ Phase 215 | UNIQUE(tx_hash, wallet_id) + ON CONFLICT DO NOTHING (§2.4) | **satisfied** |
| DATA-03 | [x] Done | ✅ Phase 215 | retention_days 기반 삭제 스케줄러 (§2.5) | **satisfied** |
| DATA-04 | [x] Done | ✅ Phase 215 | IncomingTxQueue + 5초 flush (§2.6) | **satisfied** |

### Phase 216: Solana 수신 감지 전략

| REQ-ID | REQUIREMENTS.md | SUMMARY.md | Evidence | Status |
|--------|----------------|------------|----------|--------|
| MON-02 | [x] Done | ✅ Phase 216 | logsSubscribe + getTransaction 파싱 (§3) | **satisfied** |
| MON-08 | [x] Done | ✅ Phase 216 | mentions 구독으로 ATA 자동 감지 (§3.4) | **satisfied** |

### Phase 217: EVM 수신 감지 전략

| REQ-ID | REQUIREMENTS.md | SUMMARY.md | Evidence | Status |
|--------|----------------|------------|----------|--------|
| MON-03 | [x] Done | ✅ Phase 217 | getLogs Transfer + getBlock ETH 이중 전략 (§4) | **satisfied** |

### Phase 218: WebSocket 관리 + 폴링 폴백

| REQ-ID | REQUIREMENTS.md | SUMMARY.md | Evidence | Status |
|--------|----------------|------------|----------|--------|
| MON-04 | [x] Done | ✅ Phase 218 | 3-state 상태 머신 (§5.1) | **satisfied** |
| MON-05 | [x] Done | ✅ Phase 218 | 지수 백오프 + heartbeat 60초 (§5.2, §5.3) | **satisfied** |
| MON-06 | [x] Done | ✅ Phase 218 | syncSubscriptions() 동적 관리 (§5.5) | **satisfied** |
| MON-07 | [x] Done | ✅ Phase 218 | SubscriptionMultiplexer (§5.4) | **satisfied** |
| MON-09 | [x] Done | ✅ Phase 218 | recoverBlindGap 커서 기반 복구 (§5.6) | **satisfied** |

### Phase 219: 알림 이벤트 + 의심 감지

| REQ-ID | REQUIREMENTS.md | SUMMARY.md | Evidence | Status |
|--------|----------------|------------|----------|--------|
| EVT-01 | [x] Done | ✅ Phase 219 | INCOMING_TX_DETECTED 스키마 (§6.2) | **satisfied** |
| EVT-02 | [x] Done | ✅ Phase 219 | INCOMING_TX_SUSPICIOUS + suspiciousReasons (§6.3) | **satisfied** |
| EVT-03 | [x] Done | ✅ Phase 219 | 5채널 연동 명세 (§6.4) | **satisfied** |
| EVT-04 | [x] Done | ✅ Phase 219 | i18n 메시지 en/ko (§6.7) | **satisfied** |
| EVT-05 | [x] Done | ✅ Phase 219 | IIncomingSafetyRule + 3규칙 (§6.5, §6.6) | **satisfied** |

### Phase 220: REST API + SDK/MCP

| REQ-ID | REQUIREMENTS.md | SUMMARY.md | Evidence | Status |
|--------|----------------|------------|----------|--------|
| API-01 | [x] Done | ✅ Phase 220 | GET /v1/wallet/incoming (§7.1) | **satisfied** |
| API-02 | [x] Done | ✅ Phase 220 | Zod SSoT 스키마 (§7.2) | **satisfied** |
| API-03 | [x] Done | ✅ Phase 220 | SDK listIncomingTransactions (§7.4) | **satisfied** |
| API-04 | [x] Done | ✅ Phase 220 | MCP list_incoming_transactions (§7.5) | **satisfied** |
| API-05 | [x] Done | ✅ Phase 220 | GET /v1/wallet/incoming/summary (§7.6) | **satisfied** (GAP-3: SQL 내부 불일치) |

### Phase 221: 설정 + 통합 검증

| REQ-ID | REQUIREMENTS.md | SUMMARY.md | Evidence | Status |
|--------|----------------|------------|----------|--------|
| CFG-01 | [x] Done | ✅ Phase 221 | [incoming] 6키 (§8.1) | **satisfied** |
| CFG-02 | [x] Done | ✅ Phase 221 | wallets.monitor_incoming opt-in (§8.4) | **satisfied** |
| CFG-03 | [x] Done | ✅ Phase 221 | WAIAAS_INCOMING_* 매핑 (§8.3) | **satisfied** |
| VER-01 | [x] Done | ✅ Phase 221 | 9개 문서 영향 분석 (§8.6) | **satisfied** (minor: PATCH 누락) |
| VER-02 | [x] Done | ✅ Phase 221 | T-01~T-17 + S-01~S-04 (§8.7) | **satisfied** |
| VER-03 | [x] Done | ✅ Phase 221 | 12개 교차 검증 PASS (§8.8) | **satisfied** |

## Integration Check

### Cross-Phase Wiring (22/25 connected)

| From → To | Status | Notes |
|-----------|--------|-------|
| P215 IChainSubscriber → P216 SolanaIncomingSubscriber implements | WIRED | 4 메서드 매칭 |
| P215 IChainSubscriber → P217 EvmIncomingSubscriber implements | WIRED | 4 메서드 매칭 |
| P215 IncomingTransaction → P219 IIncomingSafetyRule.check() | WIRED | 타입 정확히 참조 |
| P215 DB 스키마 → P220 API 쿼리 | WIRED | 인덱스 정렬 |
| P216/217 구독 전략 → P218 멀티플렉서 | WIRED | 체인별 분리 |
| P218 3-state 머신 → P218 폴링 워커 | **BROKEN** | GAP-2: 워커 미등록 |
| P218 reconnectLoop → IChainSubscriber | **BROKEN** | GAP-1: connect()/waitForDisconnect() 미정의 |
| P220 summary SQL → P215 DB 스키마 | **BROKEN** | GAP-3: 미정의 테이블 참조 |

### E2E Flows (3/4 complete)

| Flow | Status | Broken At |
|------|--------|-----------|
| TX 감지 → DB → 이벤트 → 알림 → API | **COMPLETE** | — |
| WebSocket 실패 → 폴링 폴백 → 복구 | **BROKEN** | 폴링 워커 미등록 (GAP-2) |
| 의심 TX 감지 → 규칙 → 알림 | **COMPLETE** | (priority 라우팅 미명세) |
| 지갑 opt-in/out → 구독 관리 | **COMPLETE** | — |

## Tech Debt Summary

### Critical (구현 전 해결 필요)

1. **GAP-2**: `incoming-tx-poll-evm`, `incoming-tx-poll-solana` BackgroundWorker를 §8.9 DaemonLifecycle Step 6에 추가
2. **GAP-3**: `incoming_tx_suspicious` 테이블 참조를 `is_suspicious INTEGER DEFAULT 0` 컬럼으로 대체 (§2.1, §2.7 v21 migration 수정)

### High

3. **GAP-1**: `IChainSubscriber`에 `connect()`, `waitForDisconnect()` 추가 또는 `reconnectLoop` 시그니처 변경
4. **GAP-4**: `eventBus.emit('transaction:incoming', { count })` → `'incoming:flush:complete'`로 변경 또는 제거

### Medium

5. **NOTIFY-1**: SUSPICIOUS 이벤트 `priority: 'high'` 라우팅 메커니즘 명시 (NotificationService.notify() 호출 시 priority 전달 방법)
6. `getDecimals()` 헬퍼 함수 정의 (DustAttackRule, LargeAmountRule에서 사용)

### Low

7. §8.6 doc 31 영향 분석에 `PATCH /v1/wallet/:id` 변경 추가
8. `skills/` 파일 업데이트 요구사항 명시 (`wallet.skill.md`, `transactions.skill.md`)

**Total: 8 items across 5 phases**

## Conclusion

v27.0은 설계 마일스톤으로서 29개 요구사항을 모두 충족합니다. 설계 문서(76-incoming-transaction-monitoring.md, 2,161줄)가 8개 섹션으로 완성되었으며, 7개 phase가 모두 완료되었습니다.

다만 설계 문서 내부에 4개의 불일치(GAP-1~4)가 발견되었으며, 이는 구현 마일스톤 시작 전 설계 문서 수정으로 해결해야 합니다. 이 불일치들은 요구사항 충족 여부에는 영향이 없으나(모든 설계가 "정의됨"), 구현 시 타입 오류나 런타임 문제를 유발할 수 있습니다.
