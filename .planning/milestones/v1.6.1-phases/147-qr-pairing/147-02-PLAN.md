---
phase: 147-qr-pairing
plan: 02
type: execute
wave: 2
depends_on: ["147-01"]
files_modified:
  - packages/admin/src/pages/wallets.tsx
  - packages/admin/src/api/endpoints.ts
  - packages/cli/src/commands/owner.ts
  - packages/cli/src/index.ts
  - packages/cli/package.json
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "Admin UI 월렛 상세 페이지에서 WC Connect 버튼을 클릭하면 QR 코드가 모달로 표시된다"
    - "Admin UI QR 모달에서 페어링 상태가 3초 폴링으로 자동 갱신된다"
    - "Admin UI에서 세션 성립 후 세션 정보가 표시되고 Disconnect 버튼이 나타난다"
    - "CLI waiaas owner connect 명령이 터미널에 QR 코드를 출력한다"
    - "CLI waiaas owner connect --poll 옵션으로 세션 성립 대기가 가능하다"
    - "CLI waiaas owner disconnect 명령으로 WC 세션 해제가 가능하다"
  artifacts:
    - path: "packages/admin/src/pages/wallets.tsx"
      provides: "WC Connect 섹션 + QR 모달 + 세션 정보 표시 + Disconnect 버튼"
      contains: "WalletConnect"
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "WALLET_WC_PAIR, WALLET_WC_SESSION, WALLET_WC_PAIR_STATUS 엔드포인트 상수"
      contains: "WALLET_WC_PAIR"
    - path: "packages/cli/src/commands/owner.ts"
      provides: "owner connect / owner disconnect CLI 명령어"
      exports: ["ownerConnectCommand", "ownerDisconnectCommand"]
    - path: "packages/cli/src/index.ts"
      provides: "owner 서브커맨드 그룹 등록"
      contains: "owner"
  key_links:
    - from: "packages/admin/src/pages/wallets.tsx"
      to: "/v1/wallets/:id/wc/pair"
      via: "apiPost(API.WALLET_WC_PAIR(id))"
      pattern: "WALLET_WC_PAIR"
    - from: "packages/cli/src/commands/owner.ts"
      to: "/v1/wallets/:id/wc/pair"
      via: "fetch POST"
      pattern: "wc/pair"
---

<objective>
Admin UI 월렛 상세 페이지에 WC QR 모달을 추가하고, CLI에 owner connect/disconnect 명령을 구현하여 두 인터페이스에서 WC 페어링과 세션 관리가 가능하게 한다.

Purpose: Owner가 Admin UI와 CLI 두 경로로 외부 지갑을 연결할 수 있도록 DX 완성
Output: Admin UI QR 모달 섹션 + CLI owner 서브커맨드 그룹
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/147-qr-pairing/147-RESEARCH.md
@.planning/phases/147-qr-pairing/147-01-SUMMARY.md

@packages/admin/src/pages/wallets.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/components/modal.tsx
@packages/cli/src/index.ts
@packages/cli/src/commands/wallet.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin UI QR 모달 + 세션 상태 표시 + Disconnect</name>
  <files>
    packages/admin/src/pages/wallets.tsx
    packages/admin/src/api/endpoints.ts
  </files>
  <action>
**endpoints.ts에 WC 엔드포인트 상수 추가:**

```typescript
WALLET_WC_PAIR: (id: string) => `/v1/wallets/${id}/wc/pair`,
WALLET_WC_SESSION: (id: string) => `/v1/wallets/${id}/wc/session`,
WALLET_WC_PAIR_STATUS: (id: string) => `/v1/wallets/${id}/wc/pair/status`,
```

**wallets.tsx WalletDetailView에 WC Connect 섹션 추가:**

1. **인터페이스 추가** (파일 상단, 기존 인터페이스 근처):
```typescript
interface WcSession {
  walletId: string;
  topic: string;
  peerName: string | null;
  peerUrl: string | null;
  chainId: string;
  ownerAddress: string;
  expiry: number;
  createdAt: number;
}

interface WcPairingResult {
  uri: string;
  qrCode: string;
  expiresAt: number;
}

interface WcPairingStatus {
  status: 'pending' | 'connected' | 'expired' | 'none';
  session?: WcSession | null;
}
```

2. **WalletDetailView에 signal 추가** (기존 signal 선언 뒤에):
```typescript
const wcQrModal = useSignal(false);
const wcQrData = useSignal<WcPairingResult | null>(null);
const wcPairingLoading = useSignal(false);
const wcSession = useSignal<WcSession | null>(null);
const wcSessionLoading = useSignal(true);
const wcDisconnectLoading = useSignal(false);
```

3. **fetchWcSession 함수** 추가 (기존 fetch 함수들 근처):
```typescript
const fetchWcSession = async () => {
  wcSessionLoading.value = true;
  try {
    wcSession.value = await apiGet<WcSession>(API.WALLET_WC_SESSION(id));
  } catch {
    wcSession.value = null;
  } finally {
    wcSessionLoading.value = false;
  }
};
```
- useEffect에 fetchWcSession() 호출 추가 (fetchBalance, fetchTransactions 뒤에)

4. **handleWcConnect 함수:**
```typescript
const handleWcConnect = async () => {
  wcPairingLoading.value = true;
  try {
    const result = await apiPost<WcPairingResult>(API.WALLET_WC_PAIR(id));
    wcQrData.value = result;
    wcQrModal.value = true;
    // 3초 폴링 시작
    startPairingPoll();
  } catch (err) {
    const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
    showToast('error', getErrorMessage(e.code));
  } finally {
    wcPairingLoading.value = false;
  }
};
```

5. **startPairingPoll 함수** -- setInterval 3초로 pair/status 폴링:
```typescript
const pollRef = useSignal<ReturnType<typeof setInterval> | null>(null);

const startPairingPoll = () => {
  if (pollRef.value) clearInterval(pollRef.value);
  pollRef.value = setInterval(async () => {
    try {
      const status = await apiGet<WcPairingStatus>(API.WALLET_WC_PAIR_STATUS(id));
      if (status.status === 'connected') {
        // 세션 성립 -- 모달 닫고 폴링 중지
        if (pollRef.value) clearInterval(pollRef.value);
        pollRef.value = null;
        wcQrModal.value = false;
        wcQrData.value = null;
        wcSession.value = status.session ?? null;
        showToast('success', 'Wallet connected via WalletConnect');
      } else if (status.status === 'expired' || status.status === 'none') {
        // 만료 -- 폴링 중지
        if (pollRef.value) clearInterval(pollRef.value);
        pollRef.value = null;
        wcQrModal.value = false;
        wcQrData.value = null;
        showToast('error', 'Pairing expired. Try again.');
      }
    } catch {
      // 네트워크 에러 시 폴링 계속
    }
  }, 3000);
};
```
- 컴포넌트 unmount 시 폴링 정리: useEffect cleanup에 `return () => { if (pollRef.value) clearInterval(pollRef.value); }` 추가 (기존 useEffect와 별도 useEffect)

6. **handleWcDisconnect 함수:**
```typescript
const handleWcDisconnect = async () => {
  wcDisconnectLoading.value = true;
  try {
    await apiDelete(API.WALLET_WC_SESSION(id));
    wcSession.value = null;
    showToast('success', 'WalletConnect session disconnected');
  } catch (err) {
    const e = err instanceof ApiError ? err : new ApiError(0, 'UNKNOWN', 'Unknown error');
    showToast('error', getErrorMessage(e.code));
  } finally {
    wcDisconnectLoading.value = false;
  }
};
```

7. **JSX 섹션 추가** -- MCP Setup 섹션 바로 위에 (transactions-section 뒤, mcp-setup-section 전):

```tsx
<div class="wc-section" style={{ marginTop: 'var(--space-6)' }}>
  <h3 style={{ marginBottom: 'var(--space-3)' }}>WalletConnect</h3>
  {wcSessionLoading.value ? (
    <div class="stat-skeleton" style={{ height: '60px' }} />
  ) : wcSession.value ? (
    <div>
      <DetailRow label="Status">
        <Badge variant="success">Connected</Badge>
      </DetailRow>
      <DetailRow label="Peer" value={wcSession.value.peerName ?? 'Unknown'} />
      <DetailRow label="Owner Address" value={wcSession.value.ownerAddress} copy />
      <DetailRow label="Chain ID" value={wcSession.value.chainId} />
      <DetailRow label="Expires" value={formatDate(wcSession.value.expiry)} />
      <div style={{ marginTop: 'var(--space-3)' }}>
        <Button variant="danger" onClick={handleWcDisconnect} loading={wcDisconnectLoading.value}>
          Disconnect
        </Button>
      </div>
    </div>
  ) : (
    <div>
      <p style={{ marginBottom: 'var(--space-3)', color: 'var(--color-text-secondary)' }}>
        Connect an external wallet (MetaMask, Phantom) via WalletConnect for transaction approval.
      </p>
      <Button onClick={handleWcConnect} loading={wcPairingLoading.value}>
        Connect Wallet
      </Button>
    </div>
  )}
</div>
```

8. **QR 모달 추가** -- 기존 deleteModal 뒤에:

```tsx
<Modal
  open={wcQrModal.value}
  title="Scan QR Code"
  onCancel={() => {
    wcQrModal.value = false;
    if (pollRef.value) clearInterval(pollRef.value);
    pollRef.value = null;
  }}
>
  {wcQrData.value && (
    <div style={{ textAlign: 'center' }}>
      <img
        src={wcQrData.value.qrCode}
        alt="WalletConnect QR Code"
        style={{ width: '280px', height: '280px', margin: '0 auto' }}
      />
      <p style={{ marginTop: 'var(--space-3)', color: 'var(--color-text-secondary)', fontSize: '0.85rem' }}>
        Scan with MetaMask, Phantom, or any WalletConnect-compatible wallet
      </p>
      <p style={{ marginTop: 'var(--space-2)', color: 'var(--color-text-secondary)', fontSize: '0.75rem' }}>
        Waiting for connection...
      </p>
    </div>
  )}
</Modal>
```
주의: QR 모달에는 Confirm 버튼이 필요 없으므로 onConfirm prop을 생략 -- Modal 컴포넌트가 onConfirm 없으면 Confirm 버튼을 렌더링하지 않음.
  </action>
  <verify>
- `pnpm build --filter=@waiaas/admin` 성공
- Admin UI에서 월렛 상세 페이지에 "WalletConnect" 섹션이 보인다
- "Connect Wallet" 버튼 클릭 시 QR 모달이 표시된다
  </verify>
  <done>
Admin UI 월렛 상세 페이지에 WC Connect 섹션이 있고, QR 모달이 동작하며, 세션 성립 시 세션 정보가 표시되고 Disconnect가 가능하다.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI owner connect/disconnect 명령</name>
  <files>
    packages/cli/src/commands/owner.ts
    packages/cli/src/index.ts
    packages/cli/package.json
    pnpm-lock.yaml
  </files>
  <action>
**CLI package.json에 qrcode 의존성 추가:**

```json
"dependencies": {
  "@waiaas/core": "workspace:*",
  "@waiaas/daemon": "workspace:*",
  "commander": "^13.0.0",
  "qrcode": "^1.5.4"
},
"devDependencies": {
  "@hono/node-server": "^1.19.9",
  "@types/qrcode": "^1.5.6",
  "argon2": "^0.44.0"
}
```

`pnpm install` 실행하여 lock 파일 갱신.

**owner.ts 파일 생성** (`packages/cli/src/commands/owner.ts`):

기존 wallet.ts 패턴을 따라 구현:

```typescript
/**
 * `waiaas owner` subcommand group:
 *   owner connect              -- Connect external wallet via WalletConnect QR
 *   owner disconnect           -- Disconnect WC session
 *   owner status               -- Show WC session status
 */

import QRCode from 'qrcode';
import { resolvePassword } from '../utils/password.js';
```

1. **OwnerCommandOptions 인터페이스:**
```typescript
export interface OwnerCommandOptions {
  baseUrl: string;
  password?: string;
  walletId?: string;
  poll?: boolean;
}
```

2. **daemonRequest 헬퍼** -- wallet.ts와 동일한 패턴 (fetch + masterAuth). wallet.ts의 daemonRequest와 selectWallet을 재사용하려면 wallet.ts에서 export하거나, 동일 함수를 owner.ts에 복사. 깔끔하게 하려면 wallet.ts에서 export하고 import -- 하지만 기존 wallet.ts가 export하지 않으므로, owner.ts에 자체 구현하여 독립성 유지. 패턴 동일하게:
```typescript
async function daemonRequest<T>(baseUrl: string, method: string, path: string, password: string, body?: unknown): Promise<T>
async function selectWallet(baseUrl: string, password: string, walletId?: string): Promise<WalletListItem>
```

3. **ownerConnectCommand 함수:**
- 비밀번호 resolve
- selectWallet으로 대상 월렛 결정
- POST `/v1/wallets/${wallet.id}/wc/pair` 호출 -> { uri, qrCode, expiresAt }
- `QRCode.toString(uri, { type: 'terminal', small: true })` 로 터미널 QR 생성
- 터미널에 QR 출력 + URI 텍스트 출력 + "Scan with your wallet app" 안내
- `--poll` 옵션이 있으면:
  - 3초 간격으로 GET `/v1/wallets/${wallet.id}/wc/pair/status` 폴링
  - status === 'connected' 시 "Connected! Peer: {peerName}" 출력 후 종료
  - status === 'expired' 시 "Pairing expired." 출력 후 종료
  - 최대 100회 폴링 (5분)
- `--poll` 없으면 QR 출력 후 바로 종료

4. **ownerDisconnectCommand 함수:**
- 비밀번호 resolve
- selectWallet
- DELETE `/v1/wallets/${wallet.id}/wc/session` 호출
- "WalletConnect session disconnected." 출력

5. **ownerStatusCommand 함수:**
- 비밀번호 resolve
- selectWallet
- GET `/v1/wallets/${wallet.id}/wc/session` 호출 (404면 "No active session")
- 세션 있으면 peer name, owner address, chain ID, expiry 출력

**index.ts에 owner 서브커맨드 그룹 등록:**

```typescript
import { ownerConnectCommand, ownerDisconnectCommand, ownerStatusCommand } from './commands/owner.js';
```

기존 wallet 서브커맨드 그룹 패턴을 따라:

```typescript
// Owner subcommand group
const owner = program.command('owner').description('Owner wallet connection commands');

owner
  .command('connect')
  .description('Connect external wallet via WalletConnect QR code')
  .option('--base-url <url>', 'Daemon base URL', 'http://127.0.0.1:3100')
  .option('--wallet <id>', 'Wallet ID or name (auto-detected if only one)')
  .option('--password <password>', 'Master password')
  .option('--poll', 'Wait for wallet to connect')
  .action(async (opts: { baseUrl?: string; wallet?: string; password?: string; poll?: boolean }) => {
    await ownerConnectCommand({
      baseUrl: opts.baseUrl ?? 'http://127.0.0.1:3100',
      password: opts.password,
      walletId: opts.wallet,
      poll: opts.poll ?? false,
    });
  });

owner
  .command('disconnect')
  .description('Disconnect WalletConnect session')
  .option('--base-url <url>', 'Daemon base URL', 'http://127.0.0.1:3100')
  .option('--wallet <id>', 'Wallet ID or name (auto-detected if only one)')
  .option('--password <password>', 'Master password')
  .action(async (opts: { baseUrl?: string; wallet?: string; password?: string }) => {
    await ownerDisconnectCommand({
      baseUrl: opts.baseUrl ?? 'http://127.0.0.1:3100',
      password: opts.password,
      walletId: opts.wallet,
    });
  });

owner
  .command('status')
  .description('Show WalletConnect session status')
  .option('--base-url <url>', 'Daemon base URL', 'http://127.0.0.1:3100')
  .option('--wallet <id>', 'Wallet ID or name (auto-detected if only one)')
  .option('--password <password>', 'Master password')
  .action(async (opts: { baseUrl?: string; wallet?: string; password?: string }) => {
    await ownerStatusCommand({
      baseUrl: opts.baseUrl ?? 'http://127.0.0.1:3100',
      password: opts.password,
      walletId: opts.wallet,
    });
  });
```

index.ts 파일 상단 주석에도 owner 명령어 추가.
  </action>
  <verify>
- `pnpm install` 성공 (qrcode 의존성 추가)
- `pnpm build --filter=@waiaas/cli` 성공
- `pnpm build` 전체 모노레포 빌드 성공
- `node packages/cli/dist/index.js owner --help` 에서 connect/disconnect/status 서브커맨드 표시
- `pnpm test --filter=@waiaas/daemon` 전체 테스트 통과
  </verify>
  <done>
CLI waiaas owner connect/disconnect/status 명령이 존재하고, connect 시 터미널에 QR 코드가 출력되며, --poll 옵션으로 세션 성립 대기가 가능하다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` 전체 모노레포 빌드 성공
2. `pnpm test` 전체 테스트 통과
3. Admin UI: 월렛 상세 -> WalletConnect 섹션 -> "Connect Wallet" 버튼 -> QR 모달 표시
4. Admin UI: QR 모달에서 3초 폴링 동작 확인 (개발자 도구 Network 탭)
5. CLI: `waiaas owner connect --wallet <id> --password <pw>` -> 터미널 QR 출력
6. CLI: `waiaas owner disconnect --wallet <id> --password <pw>` -> 세션 해제 메시지
7. CLI: `waiaas owner status --wallet <id> --password <pw>` -> 세션 상태 출력
</verification>

<success_criteria>
- Admin UI 월렛 상세 페이지에 WalletConnect 섹션이 존재 (Connect/Disconnect/상태표시)
- QR 모달이 base64 data URL 이미지로 렌더링 (CSP 위반 없음)
- 페어링 폴링이 3초 간격으로 동작하고, 세션 성립 시 자동으로 모달 닫힘
- CLI owner connect가 터미널에 QR 코드를 출력하고, --poll로 대기 가능
- CLI owner disconnect가 세션을 해제
- 전체 빌드/테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/147-qr-pairing/147-02-SUMMARY.md`
</output>
