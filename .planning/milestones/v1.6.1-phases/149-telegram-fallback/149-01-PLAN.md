---
phase: 149-telegram-fallback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/events/event-types.ts
  - packages/core/src/enums/notification.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/daemon/src/services/wc-signing-bridge.ts
  - packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
  - packages/daemon/src/lifecycle/daemon.ts
autonomous: true

must_haves:
  truths:
    - "WC 세션이 없으면 approval_channel이 'telegram'으로 설정되고 EventBus 이벤트가 발행된다"
    - "WC 서명 요청이 타임아웃(8000) 또는 네트워크 에러로 실패하면 Telegram fallback이 트리거된다"
    - "사용자 명시적 거부(4001/5000)는 기존대로 reject 처리되고 fallback하지 않는다"
    - "Telegram 봇으로 approve/reject 시 approval_channel이 'telegram'으로 기록된다"
    - "채널 전환 시 APPROVAL_CHANNEL_SWITCHED 알림이 NotificationService로 전송된다"
  artifacts:
    - path: "packages/core/src/events/event-types.ts"
      provides: "ApprovalChannelSwitchedEvent 인터페이스 + WaiaasEventMap 확장"
      contains: "approval:channel-switched"
    - path: "packages/core/src/enums/notification.ts"
      provides: "APPROVAL_CHANNEL_SWITCHED 알림 이벤트 타입"
      contains: "APPROVAL_CHANNEL_SWITCHED"
    - path: "packages/daemon/src/services/wc-signing-bridge.ts"
      provides: "fallbackToTelegram 메서드 + handleSignatureError fallback 분기"
      contains: "fallbackToTelegram"
    - path: "packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts"
      provides: "handleApprove/handleReject에서 approval_channel = 'telegram' 설정"
      contains: "approval_channel = 'telegram'"
  key_links:
    - from: "packages/daemon/src/services/wc-signing-bridge.ts"
      to: "packages/core/src/events/event-types.ts"
      via: "eventBus.emit('approval:channel-switched', ...)"
      pattern: "emit.*approval:channel-switched"
    - from: "packages/daemon/src/services/wc-signing-bridge.ts"
      to: "packages/daemon/src/notifications/notification-service.ts"
      via: "notificationService.notify('APPROVAL_CHANNEL_SWITCHED', ...)"
      pattern: "notify.*APPROVAL_CHANNEL_SWITCHED"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/services/wc-signing-bridge.ts"
      via: "WcSigningBridge DI에 notificationService + eventBus 주입"
      pattern: "notificationService.*eventBus"
---

<objective>
WcSigningBridge에 Telegram fallback 로직을 추가하고, 채널 전환 이벤트/알림 인프라를 구축한다.

Purpose: WC 채널이 불가능할 때(세션 없음/타임아웃/에러) Telegram Bot으로 자동 전환되며, 어떤 경우에도 단일 채널에서만 승인이 처리되도록 보장한다.
Output: WcSigningBridge fallback 동작, Telegram approval_channel 추적, EventBus/Notification 채널 전환 이벤트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/149-telegram-fallback/149-RESEARCH.md
@.planning/phases/148-wc-signing/148-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: EventBus 이벤트 타입 + 알림 이벤트 타입 + i18n 템플릿 추가</name>
  <files>
    packages/core/src/events/event-types.ts
    packages/core/src/enums/notification.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
  </files>
  <action>
    1. `packages/core/src/events/event-types.ts`:
       - `ApprovalChannelSwitchedEvent` 인터페이스를 추가한다:
         ```typescript
         export interface ApprovalChannelSwitchedEvent {
           walletId: string;
           txId: string;
           fromChannel: string;
           toChannel: string;
           reason: string;
           timestamp: number;
         }
         ```
       - `WaiaasEventMap`에 `'approval:channel-switched': ApprovalChannelSwitchedEvent` 항목을 추가한다.
       - JSDoc 상단 주석에 `approval:channel-switched` 설명을 추가한다.

    2. `packages/core/src/enums/notification.ts`:
       - `NOTIFICATION_EVENT_TYPES` 배열에 `'APPROVAL_CHANNEL_SWITCHED'`를 `'LOW_BALANCE'` 뒤에 추가한다.
       - (이 배열은 Zod enum의 SSoT이므로, 여기만 변경하면 타입이 자동으로 확장됨)

    3. `packages/core/src/i18n/en.ts`:
       - `notifications` 섹션에 `LOW_BALANCE` 항목 다음에 추가:
         ```
         APPROVAL_CHANNEL_SWITCHED: { title: 'Approval Channel Switched', body: 'Approval for transaction {txId} switched from {from_channel} to {to_channel}. Reason: {reason}' },
         ```

    4. `packages/core/src/i18n/ko.ts`:
       - `notifications` 섹션에 `LOW_BALANCE` 항목 다음에 추가:
         ```
         APPROVAL_CHANNEL_SWITCHED: { title: '승인 채널 전환', body: '거래 {txId}의 승인 채널이 {from_channel}에서 {to_channel}(으)로 전환되었습니다. 사유: {reason}' },
         ```
  </action>
  <verify>
    `pnpm build --filter=@waiaas/core` 빌드 성공. TypeScript 컴파일 에러 없음.
  </verify>
  <done>
    `ApprovalChannelSwitchedEvent`가 `WaiaasEventMap`에 등록되어 있고, `APPROVAL_CHANNEL_SWITCHED`가 `NotificationEventType`에 포함되어 있으며, en/ko i18n 템플릿이 존재한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: WcSigningBridge fallback 로직 + Telegram approval_channel 갱신 + DI 배선</name>
  <files>
    packages/daemon/src/services/wc-signing-bridge.ts
    packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts
    packages/daemon/src/lifecycle/daemon.ts
  </files>
  <action>
    1. `packages/daemon/src/services/wc-signing-bridge.ts` 수정:

       a. import 추가: `EventBus`를 `@waiaas/core`에서, `NotificationService`를 `../notifications/notification-service.js`에서 타입 import한다.

       b. `WcSigningBridgeDeps` 인터페이스에 옵셔널 필드 2개 추가:
          ```typescript
          notificationService?: NotificationService;
          eventBus?: EventBus;
          ```

       c. 클래스에 private readonly 필드 2개 추가하고 constructor에서 할당한다:
          ```typescript
          private readonly notificationService?: NotificationService;
          private readonly eventBus?: EventBus;
          ```
          (둘 다 optional이므로 undefined 가능)

       d. `requestSignature()` 메서드의 3개 guard clause에 fallback 호출을 추가한다:
          - `if (!signClient)` -> `this.fallbackToTelegram(walletId, txId, 'wc_not_initialized'); return;`
          - `if (!topic)` -> `this.fallbackToTelegram(walletId, txId, 'no_wc_session'); return;`
          - `if (!sessionInfo)` -> `this.fallbackToTelegram(walletId, txId, 'no_session_info'); return;`
          (기존 `return;`만 하던 것에 fallback 호출 추가)

       e. `handleSignatureError(txId, error)` 시그니처를 `handleSignatureError(walletId: string, txId: string, error: any)`로 확장한다. `requestSignature()`의 catch 블록에서 `this.handleSignatureError(walletId, txId, error)`로 변경한다.

       f. `handleSignatureError()`에서 user rejected(4001/5000) 분기는 기존 로직 유지. WC_REQUEST_EXPIRED(8000)와 기타 에러 분기에서 기존 `console.warn` 후 `return` 대신 `this.fallbackToTelegram(walletId, txId, errorCode === WC_REQUEST_EXPIRED ? 'wc_timeout' : 'wc_error')`를 호출한다. 이미 처리된 approval은 `isApprovalStillPending` 체크로 보호한다.

       g. 새 private 메서드 `isApprovalStillPending(txId: string): boolean` 추가:
          ```typescript
          private isApprovalStillPending(txId: string): boolean {
            const row = this.sqlite
              .prepare(
                'SELECT 1 FROM pending_approvals WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL',
              )
              .get(txId);
            return !!row;
          }
          ```

       h. 새 private 메서드 `fallbackToTelegram(walletId, txId, reason)` 추가:
          ```typescript
          private fallbackToTelegram(walletId: string, txId: string, reason: string): void {
            // Only act if approval is still pending
            if (!this.isApprovalStillPending(txId)) return;

            // Update approval_channel to 'telegram'
            this.sqlite
              .prepare(
                `UPDATE pending_approvals SET approval_channel = 'telegram'
                 WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL`,
              )
              .run(txId);

            // Emit EventBus event
            this.eventBus?.emit('approval:channel-switched', {
              walletId,
              txId,
              fromChannel: 'walletconnect',
              toChannel: 'telegram',
              reason,
              timestamp: Math.floor(Date.now() / 1000),
            });

            // Send channel-switched notification
            void this.notificationService?.notify(
              'APPROVAL_CHANNEL_SWITCHED',
              walletId,
              { from_channel: 'walletconnect', to_channel: 'telegram', reason },
              { txId },
            );

            console.log(`[WcSigningBridge] Fallback to Telegram for ${txId}: ${reason}`);
          }
          ```

    2. `packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts` 수정:

       a. `handleApprove()` 메서드의 approve SQL 업데이트:
          기존: `'UPDATE pending_approvals SET approved_at = unixepoch() WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL'`
          변경: `"UPDATE pending_approvals SET approved_at = unixepoch(), approval_channel = 'telegram' WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL"`

       b. `handleReject()` 메서드의 reject SQL 업데이트:
          기존: `'UPDATE pending_approvals SET rejected_at = unixepoch() WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL'`
          변경: `"UPDATE pending_approvals SET rejected_at = unixepoch(), approval_channel = 'telegram' WHERE tx_id = ? AND approved_at IS NULL AND rejected_at IS NULL"`

    3. `packages/daemon/src/lifecycle/daemon.ts` Step 4c-7 수정:

       WcSigningBridge 생성자 호출에 `notificationService`와 `eventBus`를 추가한다:
       ```typescript
       this.wcSigningBridge = new WcSigningBridge({
         wcSessionService: this.wcSessionService,
         approvalWorkflow: this.approvalWorkflow,
         sqlite: this.sqlite,
         notificationService: this.notificationService ?? undefined,
         eventBus: this.eventBus,
       });
       ```

    주의사항:
    - EventBus import는 `@waiaas/core`에서 가져온다 (type import 사용: `import type { EventBus } from '@waiaas/core';`)
    - NotificationService import는 type import로 `../notifications/notification-service.js`에서 가져온다
    - notify() 호출 시 4번째 인자 `{ txId }` 패턴은 기존 stages.ts의 사용 패턴과 동일하다
    - Telegram 봇이 구성되지 않은 경우에도 NotificationService가 다른 채널(Discord/ntfy/Slack)로 알림을 보내므로 fallback 로직은 유효하다
  </action>
  <verify>
    1. `pnpm build` 전체 모노레포 빌드 성공
    2. `pnpm test --filter=@waiaas/daemon` 기존 1,598 테스트 전체 통과 (기존 테스트 회귀 없음)
    3. `grep fallbackToTelegram packages/daemon/src/services/wc-signing-bridge.ts` -- 메서드 존재 확인
    4. `grep "approval_channel = 'telegram'" packages/daemon/src/infrastructure/telegram/telegram-bot-service.ts` -- SQL 수정 확인
    5. `grep notificationService packages/daemon/src/lifecycle/daemon.ts | grep -c wcSigningBridge` -- DI 배선 존재 확인
  </verify>
  <done>
    WC 세션 없음/타임아웃/에러 시 fallbackToTelegram()이 호출되어 approval_channel='telegram' + EventBus 이벤트 + 알림이 전송된다. Telegram 봇 approve/reject 시 approval_channel='telegram'이 DB에 기록된다. DI 배선이 daemon.ts에서 완성된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` -- 전체 모노레포 빌드 성공 (core + daemon 포함)
2. `pnpm test --filter=@waiaas/daemon` -- 기존 1,598 테스트 전체 통과
3. WcSigningBridge에 `fallbackToTelegram`, `isApprovalStillPending` 메서드 존재
4. WcSigningBridgeDeps에 `notificationService`, `eventBus` 필드 존재
5. TelegramBotService handleApprove/handleReject에 `approval_channel = 'telegram'` 포함
6. WaiaasEventMap에 `'approval:channel-switched'` 키 존재
7. NOTIFICATION_EVENT_TYPES에 `'APPROVAL_CHANNEL_SWITCHED'` 포함
8. en.ts/ko.ts에 APPROVAL_CHANNEL_SWITCHED 템플릿 존재
</verification>

<success_criteria>
- WC 세션 없음/WC 에러/WC 타임아웃 시 Telegram fallback이 트리거됨
- 사용자 명시적 거부(4001/5000)는 fallback 없이 기존대로 reject 처리됨
- Telegram 봇 approve/reject 시 approval_channel이 'telegram'으로 기록됨
- 채널 전환 시 EventBus 이벤트 + NotificationService 알림이 발행됨
- 기존 1,598 테스트 전부 통과 (회귀 없음)
</success_criteria>

<output>
After completion, create `.planning/phases/149-telegram-fallback/149-01-SUMMARY.md`
</output>
