---
phase: 146-wc-infra
plan: 02
type: execute
wave: 2
depends_on: ["146-01"]
files_modified:
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/infrastructure/settings/hot-reload.ts
  - packages/daemon/src/__tests__/migration-chain.test.ts
  - packages/daemon/src/__tests__/wc-storage.test.ts
  - packages/daemon/src/__tests__/wc-session-service.test.ts
autonomous: true

must_haves:
  truths:
    - "데몬 재시작 시 기존 WC 세션이 wc_sessions 테이블에서 복구되어 sessionMap에 적재된다"
    - "Admin Settings에서 walletconnect.relay_url을 변경할 수 있다"
    - "walletconnect.project_id 변경 시 hot-reload로 로그가 출력된다"
    - "SqliteKeyValueStorage가 getKeys/getEntries/getItem/setItem/removeItem을 올바르게 구현한다"
    - "v16 마이그레이션이 chain test에서 검증된다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "walletconnect.relay_url 설정 키 정의"
      contains: "walletconnect.relay_url"
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "walletconnect.relay_url Zod 스키마"
      contains: "relay_url"
    - path: "packages/daemon/src/__tests__/wc-storage.test.ts"
      provides: "SqliteKeyValueStorage 단위 테스트"
      exports: []
    - path: "packages/daemon/src/__tests__/wc-session-service.test.ts"
      provides: "WcSessionService 세션 복원/삭제 테스트"
      exports: []
    - path: "packages/daemon/src/__tests__/migration-chain.test.ts"
      provides: "v16 마이그레이션 체인 테스트 업데이트"
      contains: "v16"
  key_links:
    - from: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      to: "packages/daemon/src/services/wc-session-service.ts"
      via: "settingsService.get('walletconnect.relay_url')"
      pattern: "walletconnect\\.relay_url"
    - from: "packages/daemon/src/infrastructure/settings/hot-reload.ts"
      to: "packages/daemon/src/services/wc-session-service.ts"
      via: "walletconnect 키 변경 감지 -> 로그 출력"
      pattern: "walletconnect"
---

<objective>
Admin Settings에 walletconnect.relay_url을 추가하고, WC 세션 복구 로직과 hot-reload를 구현하며, SqliteKeyValueStorage/WcSessionService/migration-chain 테스트를 작성한다.

Purpose: 데몬 재시작 시 기존 WC 세션이 자동 복구되고, Admin Settings에서 WC 관련 설정을 런타임으로 변경할 수 있게 한다. 테스트로 SqliteKeyValueStorage의 정확성과 DB v16 마이그레이션 체인 무결성을 보장한다.

Output: setting-keys.ts 확장, loader.ts 확장, hot-reload.ts 확장, wc-storage.test.ts, wc-session-service.test.ts, migration-chain.test.ts 업데이트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/146-wc-infra/146-RESEARCH.md
@.planning/phases/146-wc-infra/146-01-SUMMARY.md
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/infrastructure/settings/hot-reload.ts
@packages/daemon/src/__tests__/migration-chain.test.ts
@packages/daemon/src/services/wc-storage.ts
@packages/daemon/src/services/wc-session-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin Settings 확장 (walletconnect.relay_url) + config.toml Zod 스키마 + hot-reload</name>
  <files>
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/infrastructure/settings/hot-reload.ts
  </files>
  <action>
    **1. `setting-keys.ts`에 walletconnect.relay_url 추가:**
    - 기존 `walletconnect.project_id` 항목 (line 99) 바로 뒤에 추가:
      ```typescript
      { key: 'walletconnect.relay_url', category: 'walletconnect', configPath: 'walletconnect.relay_url', defaultValue: 'wss://relay.walletconnect.com', isCredential: false },
      ```

    **2. `loader.ts` DaemonConfigSchema walletconnect 섹션 확장:**
    - 기존 `project_id: z.string().default('')` 뒤에 추가:
      ```typescript
      relay_url: z.string().default('wss://relay.walletconnect.com'),
      ```

    **3. `hot-reload.ts`에 walletconnect 키 변경 감지 추가:**
    - 새 상수 추가: `const WALLETCONNECT_KEYS_PREFIX = 'walletconnect.';`
    - `handleChangedKeys` 메서드에 walletconnect 변경 감지 추가:
      ```typescript
      const hasWalletConnectChanges = changedKeys.some((k) => k.startsWith(WALLETCONNECT_KEYS_PREFIX));
      ```
    - 변경 시 처리 블록 추가 (monitoring 처리 뒤):
      ```typescript
      if (hasWalletConnectChanges) {
        // WalletConnect settings require daemon restart for full effect (SignClient re-init).
        // project_id change requires SignClient recreation which is complex -- log guidance.
        console.log('Hot-reload: WalletConnect settings updated. Note: project_id changes require daemon restart for full effect.');
      }
      ```
    - (주의: WC 설정 변경 시 SignClient 재생성은 이벤트 리스너 누적 위험이 있어, 이 Phase에서는 로그만 출력. 향후 필요 시 재초기화 로직 추가)
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build --filter=@waiaas/daemon` 빌드 성공
    2. `grep -n 'walletconnect.relay_url' packages/daemon/src/infrastructure/settings/setting-keys.ts` -- 존재 확인
    3. `grep -n 'relay_url' packages/daemon/src/infrastructure/config/loader.ts` -- 존재 확인
    4. `grep -n 'WALLETCONNECT_KEYS_PREFIX' packages/daemon/src/infrastructure/settings/hot-reload.ts` -- 존재 확인
  </verify>
  <done>
    - setting-keys.ts에 walletconnect.relay_url 정의가 추가되어 Admin Settings UI에 노출됨
    - config.toml walletconnect 섹션에 relay_url 기본값이 정의됨
    - hot-reload가 walletconnect 카테고리 키 변경을 감지하고 로그를 출력함
  </done>
</task>

<task type="auto">
  <name>Task 2: SqliteKeyValueStorage 테스트 + WcSessionService 세션 복원/삭제 테스트 + migration-chain 업데이트</name>
  <files>
    packages/daemon/src/__tests__/wc-storage.test.ts
    packages/daemon/src/__tests__/wc-session-service.test.ts
    packages/daemon/src/__tests__/migration-chain.test.ts
  </files>
  <action>
    **1. `wc-storage.test.ts` 생성 (SqliteKeyValueStorage 단위 테스트):**
    - in-memory SQLite DB 사용 (`createDatabase(':memory:')` + `pushSchema(sqlite)`)
    - 테스트 케이스:
      - `setItem + getItem`: 문자열, 숫자, 객체, 배열 값을 저장하고 정확히 읽기
      - `setItem` 덮어쓰기: 같은 key에 새 값 저장 후 최신 값 반환
      - `removeItem`: 삭제 후 getItem이 undefined 반환
      - `getKeys`: 여러 항목 저장 후 key 목록 반환
      - `getEntries`: 여러 항목 저장 후 [key, value] 배열 반환
      - `getItem` 존재하지 않는 key: undefined 반환
      - 빈 DB에서 `getKeys`, `getEntries`: 빈 배열 반환
    - 각 테스트 후 DB close (afterEach)

    **2. `wc-session-service.test.ts` 생성 (WcSessionService 세션 복원/삭제 테스트):**
    - **SignClient.init()을 호출하지 않는다** (외부 relay 연결 필요하므로). SQLite 레벨의 세션 복원/삭제 로직만 테스트.
    - in-memory SQLite DB 사용 + pushSchema
    - 테스트 케이스:
      - `restoreSessions`: wc_sessions 테이블에 데이터를 직접 INSERT한 후, WcSessionService의 내부 `restoreSessions`가 sessionMap에 적재하는지 검증. WcSessionService를 생성하되 initialize()는 호출하지 않고, private restoreSessions를 테스트하기 위해:
        - 방법: wc_sessions에 테스트 데이터 INSERT -> 서비스 인스턴스 생성 -> initialize() 호출 대신, restoreSessions가 constructor나 별도 메서드로 호출되는 구조라면 그에 맞게 테스트. 또는 hasActiveSession() 으로 간접 검증.
        - **대안:** WcSessionService에 `restoreSessionsFromDb()` public 메서드를 추가하여 테스트 가능하게 하거나, initialize()에서 SignClient 없이도 DB 복원만 수행하도록 분리. 실제 구현은 146-01에서 이미 완료되었으므로 코드를 읽고 적합한 방식을 선택.
      - `handleSessionDelete`: wc_sessions에 데이터 INSERT한 후, topic 기반 삭제가 DB와 sessionMap 모두에서 동작하는지 검증
      - `hasActiveSession`: 빈 상태에서 false, 세션 추가 후 true
    - (주의: WcSessionService의 private 메서드 테스트가 어려우면, `handleSessionDelete`를 protected 또는 public으로 변경하거나, DB 직접 조작 + hasActiveSession으로 간접 검증)

    **3. `migration-chain.test.ts` 업데이트:**
    - 기존 테스트 파일을 읽고 패턴을 파악한 후:
    - `LATEST_SCHEMA_VERSION`이 16인지 확인하는 assertion이 있으면 업데이트
    - v16 마이그레이션 관련 테스트 추가:
      - 기존 DB (v15)에서 pushSchema -> wc_sessions, wc_store 테이블 존재 확인
      - 기존 DB에서 pending_approvals.approval_channel 컬럼 존재 확인
      - 신규 DB에서 pushSchema -> wc_sessions, wc_store, approval_channel 모두 존재 확인
      - wc_sessions 테이블에 INSERT/SELECT 동작 확인
      - wc_store 테이블에 INSERT/SELECT 동작 확인
    - 스키마 동등성 테스트 (T-2/T-6 패턴): migrated DB와 fresh DB의 테이블 구조가 동일한지 확인 -- 기존 테스트에서 이미 이 패턴이 있으면 v16 신규 테이블/컬럼도 커버되는지 확인
    - createV1SchemaDatabase, createV5SchemaDatabase 등 기존 헬퍼에는 v16 변경사항을 추가하지 않는다 (v1에서 v16까지 전체 체인이 마이그레이션으로 도달해야 하므로)
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm test --filter=@waiaas/daemon -- --run src/__tests__/wc-storage.test.ts` 통과
    2. `pnpm test --filter=@waiaas/daemon -- --run src/__tests__/wc-session-service.test.ts` 통과
    3. `pnpm test --filter=@waiaas/daemon -- --run src/__tests__/migration-chain.test.ts` 통과
    4. `pnpm test --filter=@waiaas/daemon` 전체 테스트 통과
  </verify>
  <done>
    - SqliteKeyValueStorage의 5개 메서드가 단위 테스트로 검증됨
    - WcSessionService의 세션 복원/삭제 로직이 DB 레벨 테스트로 검증됨
    - migration-chain 테스트가 v16 마이그레이션을 커버하여 신규/기존 DB 모두에서 정상 동작 확인
    - 전체 daemon 테스트 스위트가 통과함
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter=@waiaas/daemon` -- TypeScript 컴파일 성공
2. `pnpm test --filter=@waiaas/daemon` -- 전체 테스트 통과
3. Admin Settings에서 walletconnect 카테고리에 project_id, relay_url 2개 키가 존재
4. hot-reload에서 walletconnect 키 변경 감지 동작
5. SqliteKeyValueStorage 테스트가 set/get/remove/keys/entries 모두 커버
6. migration-chain 테스트가 v16 DDL 동등성을 검증
</verification>

<success_criteria>
- Admin Settings UI에서 walletconnect.project_id와 walletconnect.relay_url 2개 설정을 변경할 수 있음
- hot-reload가 walletconnect 카테고리 변경을 감지하여 로그 출력
- SqliteKeyValueStorage가 모든 IKeyValueStorage 메서드를 올바르게 구현함이 테스트로 증명됨
- WcSessionService의 세션 복원/삭제 로직이 테스트로 검증됨
- DB v16 마이그레이션 체인이 v1->v16 전체 경로에서 무결하게 동작함이 테스트로 증명됨
</success_criteria>

<output>
After completion, create `.planning/phases/146-wc-infra/146-02-SUMMARY.md`
</output>
