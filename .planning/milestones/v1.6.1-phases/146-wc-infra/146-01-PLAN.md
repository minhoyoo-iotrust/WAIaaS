---
phase: 146-wc-infra
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/services/wc-storage.ts
  - packages/daemon/src/services/wc-session-service.ts
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/infrastructure/database/schema.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/package.json
autonomous: true

must_haves:
  truths:
    - "데몬 시작 시 walletconnect.project_id가 설정되어 있으면 WC SignClient가 초기화된다"
    - "walletconnect.project_id가 미설정이면 WC 서비스 없이 데몬이 정상 시작된다"
    - "WC 초기화 실패해도 데몬이 정상 시작된다 (fail-soft)"
    - "데몬 종료 시 WC SignClient가 정상 해제된다"
    - "DB v16 마이그레이션으로 wc_sessions, wc_store 테이블이 생성된다"
    - "pending_approvals에 approval_channel 컬럼이 추가된다"
  artifacts:
    - path: "packages/daemon/src/services/wc-storage.ts"
      provides: "SqliteKeyValueStorage (IKeyValueStorage SQLite 구현)"
      exports: ["SqliteKeyValueStorage"]
    - path: "packages/daemon/src/services/wc-session-service.ts"
      provides: "WcSessionService (SignClient 래퍼, 초기화/종료)"
      exports: ["WcSessionService"]
    - path: "packages/daemon/src/infrastructure/database/migrate.ts"
      provides: "v16 마이그레이션 (wc_sessions + wc_store + approval_channel)"
      contains: "version: 16"
  key_links:
    - from: "packages/daemon/src/services/wc-session-service.ts"
      to: "packages/daemon/src/services/wc-storage.ts"
      via: "SqliteKeyValueStorage를 SignClient.init() storage 옵션으로 주입"
      pattern: "new SqliteKeyValueStorage"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/services/wc-session-service.ts"
      via: "Step 4c-6 fail-soft 초기화 + shutdown에서 해제"
      pattern: "WcSessionService"
    - from: "packages/daemon/src/infrastructure/database/migrate.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "DDL과 migration 동기화 (approval_channel 포함)"
      pattern: "approval_channel"
---

<objective>
WcSessionService, SqliteKeyValueStorage, DB v16 마이그레이션을 구현하고 DaemonLifecycle에 통합한다.

Purpose: WalletConnect SignClient가 데몬 라이프사이클에 fail-soft로 통합되어 시작/종료 시 안정적으로 동작하는 인프라 기반을 구축한다. WC SDK의 세션 데이터가 SQLite에 영속화되어 데몬 재시작 후에도 세션이 유지되는 토대를 마련한다.

Output: wc-storage.ts, wc-session-service.ts, migrate.ts v16, schema.ts 확장, daemon.ts/server.ts WC 통합
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/146-wc-infra/146-RESEARCH.md
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/api/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: @walletconnect/sign-client 설치 + SqliteKeyValueStorage + WcSessionService + DB v16 마이그레이션</name>
  <files>
    packages/daemon/package.json
    packages/daemon/src/services/wc-storage.ts
    packages/daemon/src/services/wc-session-service.ts
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/infrastructure/database/schema.ts
  </files>
  <action>
    **1. NPM 패키지 설치:**
    ```bash
    cd packages/daemon && pnpm add @walletconnect/sign-client@^2.23.5 qrcode@^1.5.4 && pnpm add -D @types/qrcode@^1.5.6
    ```
    qrcode는 Phase 147에서 사용하지만 Phase 146에서 미리 설치한다 (패키지 의존성 1회 정리).

    **2. `packages/daemon/src/services/wc-storage.ts` 생성:**
    - `IKeyValueStorage` 인터페이스를 `@walletconnect/keyvaluestorage` 에서 import (WC SDK의 스토리지 인터페이스)
    - `SqliteKeyValueStorage` 클래스가 IKeyValueStorage를 구현
    - constructor에 `Database` (better-sqlite3) 주입
    - 5개 메서드 구현: `getKeys()`, `getEntries<T>()`, `getItem<T>(key)`, `setItem<T>(key, value)`, `removeItem(key)`
    - 모든 메서드는 `wc_store` 테이블을 대상으로 동작
    - `setItem`은 `INSERT OR REPLACE INTO wc_store (key, value) VALUES (?, ?)` 패턴으로 JSON.stringify
    - `getItem`은 `SELECT value FROM wc_store WHERE key = ?` 후 JSON.parse, 없으면 undefined 반환
    - `removeItem`은 `DELETE FROM wc_store WHERE key = ?`
    - `getKeys`는 `SELECT key FROM wc_store`로 key[] 반환
    - `getEntries`는 `SELECT key, value FROM wc_store`로 [key, T][] 반환
    - **주의:** `@walletconnect/keyvaluestorage` 패키지를 별도 설치하지 않는다. `@walletconnect/sign-client`에 이미 의존성으로 포함되어 있다. 만약 타입 import가 안 되면, 5개 메서드 시그니처를 인터페이스로 직접 정의한다:
      ```typescript
      interface IKeyValueStorage {
        getKeys(): Promise<string[]>;
        getEntries<T = any>(): Promise<[string, T][]>;
        getItem<T = any>(key: string): Promise<T | undefined>;
        setItem<T = any>(key: string, value: T): Promise<void>;
        removeItem(key: string): Promise<void>;
      }
      ```

    **3. `packages/daemon/src/services/wc-session-service.ts` 생성:**
    - `WcSessionServiceDeps` 인터페이스: `{ sqlite: Database; settingsService: SettingsService }`
    - `WcSessionService` 클래스:
      - `private signClient: SignClient | null = null`
      - `private readonly sessionMap = new Map<string, string>()` (walletId -> session topic)
      - `private readonly sqlite: Database`
      - `private readonly settingsService: SettingsService`
    - `async initialize(): Promise<void>`:
      - `settingsService.get('walletconnect.project_id')` 로 projectId 읽기. 빈 문자열이면 return (비활성화)
      - `settingsService.get('walletconnect.relay_url')` 로 relayUrl 읽기. 없으면 `'wss://relay.walletconnect.com'` 기본값
      - `new SqliteKeyValueStorage(this.sqlite)` 생성
      - `SignClient.init({ projectId, relayUrl, storage, metadata })` 호출. metadata는 `{ name: 'WAIaaS Daemon', description: 'AI Agent Wallet-as-a-Service', url: 'http://localhost', icons: [] }`
      - **만약 SignClient.init()에 storage 직접 전달이 안 되면**, `@walletconnect/core`의 `Core` 클래스를 사용하여 `new Core({ projectId, relayUrl, storage })` 후 `SignClient.init({ core })` 패턴으로 전환
      - 이벤트 리스너 등록: `session_delete`, `session_expire` -> `this.handleSessionDelete(topic)`
      - `this.restoreSessions()` 호출하여 wc_sessions 테이블에서 기존 세션 복원
    - `private restoreSessions(): void`: `SELECT wallet_id, topic FROM wc_sessions` -> sessionMap에 적재
    - `hasActiveSession(walletId: string): boolean`: sessionMap.has(walletId)
    - `getSignClient(): SignClient | null`: 테스트/외부 접근용 getter
    - `async shutdown(): Promise<void>`:
      - `signClient.core.relayer.provider.disconnect()` 를 try/catch로 시도 (WebSocket 정리)
      - 실패해도 무시하고 `this.signClient = null; this.sessionMap.clear()`
    - `private handleSessionDelete(topic: string): void`:
      - `DELETE FROM wc_sessions WHERE topic = ?` 실행
      - sessionMap에서 해당 topic의 walletId를 찾아 삭제
    - import는 `import SignClient from '@walletconnect/sign-client'` (default export)

    **4. DB v16 마이그레이션 (`migrate.ts`):**
    - `LATEST_SCHEMA_VERSION`을 `15`에서 `16`으로 변경
    - MIGRATIONS 배열에 v16 추가:
      ```typescript
      MIGRATIONS.push({
        version: 16,
        description: 'Add WC infra: wc_sessions table, wc_store table, pending_approvals.approval_channel',
        up: (sqlite) => {
          // 1. pending_approvals.approval_channel 추가
          sqlite.exec("ALTER TABLE pending_approvals ADD COLUMN approval_channel TEXT DEFAULT 'rest_api'");
          // 2. wc_sessions 테이블 생성
          sqlite.exec(`CREATE TABLE IF NOT EXISTS wc_sessions (
            wallet_id TEXT PRIMARY KEY REFERENCES wallets(id) ON DELETE CASCADE,
            topic TEXT NOT NULL UNIQUE,
            peer_meta TEXT,
            chain_id TEXT NOT NULL,
            owner_address TEXT NOT NULL,
            namespaces TEXT,
            expiry INTEGER NOT NULL,
            created_at INTEGER NOT NULL
          )`);
          sqlite.exec('CREATE INDEX IF NOT EXISTS idx_wc_sessions_topic ON wc_sessions(topic)');
          // 3. wc_store 테이블 생성 (IKeyValueStorage용)
          sqlite.exec(`CREATE TABLE IF NOT EXISTS wc_store (
            key TEXT PRIMARY KEY,
            value TEXT NOT NULL
          )`);
        },
      });
      ```

    **5. DDL 동기화 (`migrate.ts` getCreateTableStatements + getCreateIndexStatements):**
    - `getCreateTableStatements()`에 3개 추가:
      - pending_approvals 테이블 DDL에 `approval_channel TEXT DEFAULT 'rest_api'` 컬럼 추가 (ownerSignature 다음, createdAt 앞)
      - wc_sessions 테이블 DDL 추가 (Table 14)
      - wc_store 테이블 DDL 추가 (Table 15)
    - `getCreateIndexStatements()`에 1개 추가: `idx_wc_sessions_topic`
    - 파일 상단 주석 업데이트: "13 tables" -> "15 tables" (wc_sessions, wc_store 추가)

    **6. Drizzle 스키마 확장 (`schema.ts`):**
    - `pendingApprovals` 테이블에 `approvalChannel: text('approval_channel').default('rest_api')` 필드 추가
    - `wcSessions` 테이블 정의 추가:
      ```typescript
      export const wcSessions = sqliteTable('wc_sessions', {
        walletId: text('wallet_id').primaryKey().references(() => wallets.id, { onDelete: 'cascade' }),
        topic: text('topic').notNull().unique(),
        peerMeta: text('peer_meta'),
        chainId: text('chain_id').notNull(),
        ownerAddress: text('owner_address').notNull(),
        namespaces: text('namespaces'),
        expiry: integer('expiry').notNull(),
        createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
      }, (table) => [
        index('idx_wc_sessions_topic').on(table.topic),
      ]);
      ```
    - `wcStore` 테이블 정의 추가:
      ```typescript
      export const wcStore = sqliteTable('wc_store', {
        key: text('key').primaryKey(),
        value: text('value').notNull(),
      });
      ```
    - 파일 상단 주석 업데이트: "12 tables" -> "14 tables" (wc_sessions, wc_store 추가. pending_approvals에 필드만 추가되므로 테이블 수는 2개 증가)
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build --filter=@waiaas/daemon` 빌드 성공
    2. `pnpm test --filter=@waiaas/daemon -- --grep "migration"` 기존 마이그레이션 테스트 통과 확인
    3. TypeScript 컴파일 에러 없음 확인
  </verify>
  <done>
    - SqliteKeyValueStorage가 IKeyValueStorage 5개 메서드를 구현하고 wc_store 테이블을 대상으로 동작
    - WcSessionService가 SignClient 초기화/종료/세션 복원 메서드를 제공
    - DB v16 마이그레이션이 wc_sessions, wc_store, approval_channel을 추가
    - DDL과 v16 마이그레이션이 동기화되어 신규 DB와 기존 DB 모두 정상 동작
    - Drizzle 스키마가 pendingApprovals.approvalChannel, wcSessions, wcStore를 포함
  </done>
</task>

<task type="auto">
  <name>Task 2: DaemonLifecycle 통합 (Step 4c-6 초기화 + shutdown 해제) + CreateAppDeps 확장</name>
  <files>
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
    **1. `daemon.ts` 클래스 필드 추가:**
    - `private wcSessionService: import('../services/wc-session-service.js').WcSessionService | null = null;` 필드 추가 (telegramBotService 아래에)

    **2. `daemon.ts` Step 4c-6 추가 (Step 4c-5 TelegramBot 이후, Step 4e PriceOracle 이전):**
    ```typescript
    // ------------------------------------------------------------------
    // Step 4c-6: WalletConnect service initialization (fail-soft)
    // ------------------------------------------------------------------
    try {
      const wcProjectId = this._settingsService?.get('walletconnect.project_id');
      if (wcProjectId) {
        const { WcSessionService } = await import('../services/wc-session-service.js');
        this.wcSessionService = new WcSessionService({
          sqlite: this.sqlite!,
          settingsService: this._settingsService!,
        });
        await this.wcSessionService.initialize();
        console.log('Step 4c-6: WalletConnect service initialized');
      } else {
        console.log('Step 4c-6: WalletConnect disabled (no project_id)');
      }
    } catch (err) {
      console.warn('Step 4c-6 (fail-soft): WalletConnect init warning:', err);
      this.wcSessionService = null;
    }
    ```

    **3. `daemon.ts` shutdown() 확장:**
    - `// Stop TelegramBotService` 블록 직후, `// Step 6b: Remove all EventBus listeners` 직전에 추가:
    ```typescript
    // Stop WcSessionService (before EventBus cleanup)
    if (this.wcSessionService) {
      try {
        await this.wcSessionService.shutdown();
      } catch (err) {
        console.warn('WcSessionService shutdown warning:', err);
      }
      this.wcSessionService = null;
    }
    ```

    **4. `daemon.ts` createApp() deps에 wcSessionService 전달:**
    - Step 5 HTTP server start에서 createApp 호출부에 `wcSessionService: this.wcSessionService ?? undefined` 추가

    **5. `server.ts` CreateAppDeps에 wcSessionService 필드 추가:**
    - `import type { WcSessionService } from '../services/wc-session-service.js';` 추가
    - `CreateAppDeps` 인터페이스에 `wcSessionService?: WcSessionService;` 필드 추가 (killSwitchService 아래에)
    - (주의: 이 Phase에서는 WC REST 라우트를 추가하지 않는다. Phase 147에서 추가 예정. CreateAppDeps에만 등록하여 향후 라우트가 접근할 수 있는 토대를 마련)

    **6. `daemon.ts` 파일 상단 JSDoc 업데이트:**
    - Startup sequence 주석에 `4c-6. WalletConnect service (fail-soft)` 추가
    - Shutdown sequence 주석에 WcSessionService stop 항목 추가
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm build --filter=@waiaas/daemon` 빌드 성공
    2. `pnpm test --filter=@waiaas/daemon` 전체 테스트 통과 (기존 lifecycle.test.ts 포함)
    3. daemon.ts에서 grep으로 `Step 4c-6` 존재 확인
    4. server.ts에서 grep으로 `wcSessionService` 존재 확인
  </verify>
  <done>
    - DaemonLifecycle이 Step 4c-6에서 WcSessionService를 fail-soft로 초기화
    - 데몬 종료 시 WcSessionService.shutdown()이 호출되어 SignClient WebSocket 정리
    - CreateAppDeps에 wcSessionService가 등록되어 Phase 147에서 REST 라우트 접근 가능
    - projectId 미설정 시 "WalletConnect disabled" 로그, 설정 시 "WalletConnect service initialized" 로그
    - WC 초기화 실패 시에도 데몬이 정상 시작되고 경고 로그 출력
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter=@waiaas/daemon` -- TypeScript 컴파일 성공
2. `pnpm test --filter=@waiaas/daemon -- --grep "migration"` -- 기존 마이그레이션 체인 테스트 통과
3. `pnpm test --filter=@waiaas/daemon` -- 전체 데몬 테스트 통과
4. migrate.ts에서 LATEST_SCHEMA_VERSION이 16인지 확인
5. DDL의 pending_approvals에 approval_channel 필드 존재 확인
6. schema.ts에 wcSessions, wcStore, approvalChannel 정의 존재 확인
</verification>

<success_criteria>
- WcSessionService가 SignClient 초기화/종료/세션 복원 메서드를 제공하고 DaemonLifecycle에 통합됨
- SqliteKeyValueStorage가 IKeyValueStorage를 구현하여 WC SDK 데이터를 SQLite에 영속화
- DB v16 마이그레이션이 wc_sessions, wc_store 테이블과 approval_channel 컬럼을 추가
- DDL, Drizzle 스키마, v16 마이그레이션이 모두 동기화됨
- 데몬 시작/종료/실패 시 모두 안정적으로 동작 (fail-soft 패턴)
</success_criteria>

<output>
After completion, create `.planning/phases/146-wc-infra/146-01-SUMMARY.md`
</output>
