---
phase: 205-admin-settings-skills-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/__tests__/admin-settings-api.test.ts
autonomous: true
requirements: [CONF-01]

must_haves:
  truths:
    - "GET /admin/settings returns all 11 categories including signing_sdk and telegram"
    - "PUT /admin/settings response includes all 11 categories"
    - "signing_sdk.* keys are runtime-changeable via PUT /admin/settings"
    - "SettingsResponseSchema includes all 11 categories"
  artifacts:
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "SettingsResponseSchema with all 11 categories"
      contains: "signing_sdk"
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "GET/PUT handlers passing all categories"
      contains: "signing_sdk"
    - path: "packages/daemon/src/__tests__/admin-settings-api.test.ts"
      provides: "Tests verifying signing_sdk/telegram categories in responses"
      contains: "signing_sdk"
  key_links:
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "SettingsService.getAllMasked()"
      via: "passthrough all categories from SettingsService result"
      pattern: "masked\\.signing_sdk"
---

<objective>
Fix GET/PUT /admin/settings API endpoints to expose all 11 setting categories (currently only 7 are passed through) and update the OpenAPI schema to match.

Purpose: The SettingsService already stores and retrieves all 11 categories (notifications, rpc, security, daemon, walletconnect, oracle, display, autostop, monitoring, telegram, signing_sdk), but the admin route handlers cherry-pick only 7 categories, dropping autostop, monitoring, telegram, and signing_sdk. This blocks the Admin UI from reading/writing signing_sdk settings. Closing GAP-3 requirement CONF-01.

Output: API endpoints returning all 11 categories with updated OpenAPI schema and tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/__tests__/admin-settings-api.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SettingsResponseSchema and admin route handlers to pass all 11 categories</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/admin.ts
  </files>
  <action>
**openapi-schemas.ts:**
The SettingsResponseSchema currently only declares 5 categories (notifications, rpc, security, daemon, walletconnect). Add the missing 6 categories so all 11 from SETTING_CATEGORIES are represented. Each category uses the same `z.record(z.union([z.string(), z.boolean()]))` type. Add:
- `oracle: z.record(z.union([z.string(), z.boolean()]))`
- `display: z.record(z.union([z.string(), z.boolean()]))`
- `autostop: z.record(z.union([z.string(), z.boolean()]))`
- `monitoring: z.record(z.union([z.string(), z.boolean()]))`
- `telegram: z.record(z.union([z.string(), z.boolean()]))`
- `signing_sdk: z.record(z.union([z.string(), z.boolean()]))`

Note: oracle and display are already in the admin.ts handler but were never in the schema. All 6 are missing from the schema.

**admin.ts:**
In the GET /admin/settings handler (~line 1263-1292), replace the cherry-picked category passthrough with a dynamic approach that passes through ALL categories from `SettingsService.getAllMasked()`. The simplest approach: just return `masked` directly. But to maintain backward compat for the fallback case (no settingsService), update the fallback to return all 11 empty categories too.

Change the GET handler from:
```typescript
return c.json({
  notifications: masked.notifications ?? {},
  rpc: masked.rpc ?? {},
  security: masked.security ?? {},
  daemon: masked.daemon ?? {},
  walletconnect: masked.walletconnect ?? {},
  oracle: masked.oracle ?? {},
  display: masked.display ?? {},
}, 200);
```
to:
```typescript
return c.json(masked, 200);
```

Since `getAllMasked()` already initializes all categories from SETTING_CATEGORIES as empty objects before populating, this is safe.

For the fallback case (no settingsService), update to return all 11 categories as empty Records:
```typescript
const emptyCategory = {} as Record<string, string | boolean>;
return c.json({
  notifications: emptyCategory,
  rpc: emptyCategory,
  security: emptyCategory,
  daemon: emptyCategory,
  walletconnect: emptyCategory,
  oracle: emptyCategory,
  display: emptyCategory,
  autostop: emptyCategory,
  monitoring: emptyCategory,
  telegram: emptyCategory,
  signing_sdk: emptyCategory,
}, 200);
```

Similarly, in the PUT /admin/settings handler (~line 1326-1341), change the response from cherry-picked categories to just `settings: masked`.
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=@waiaas/daemon` -- should pass with no errors.
  </verify>
  <done>
SettingsResponseSchema declares all 11 categories. GET /admin/settings returns all categories from getAllMasked(). PUT response includes all categories. TypeScript compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for signing_sdk/telegram categories in admin settings API</name>
  <files>
    packages/daemon/src/__tests__/admin-settings-api.test.ts
  </files>
  <action>
Add 3 new test cases to the existing admin-settings-api.test.ts:

1. **"GET /admin/settings returns all 11 categories including signing_sdk and telegram"**:
   - Send GET request with masterAuth
   - Assert response has all 11 category keys: notifications, rpc, security, daemon, walletconnect, oracle, display, autostop, monitoring, telegram, signing_sdk
   - Assert signing_sdk category includes `enabled` key with default value 'false'
   - Assert signing_sdk category includes `request_expiry_min` key
   - Assert telegram category includes `enabled` key

2. **"PUT /admin/settings can update signing_sdk.enabled"**:
   - Send PUT with `[{key: "signing_sdk.enabled", value: "true"}]`
   - Assert 200 response
   - Assert response.settings.signing_sdk.enabled === 'true'
   - Send GET to verify persistence
   - Assert GET response signing_sdk.enabled === 'true'

3. **"PUT /admin/settings can update signing_sdk.request_expiry_min"**:
   - Send PUT with `[{key: "signing_sdk.request_expiry_min", value: "15"}]`
   - Assert 200 response
   - Assert response.settings.signing_sdk.request_expiry_min === '15'

Follow the existing test pattern in the file: use createApp() + app.request() integration pattern with real SettingsService. The test header is `X-Master-Password: ${TEST_PASSWORD}`. Update the file doc comment to reflect the new test count.
  </action>
  <verify>
Run `pnpm turbo run test --filter=@waiaas/daemon -- --run packages/daemon/src/__tests__/admin-settings-api.test.ts` -- all tests pass.
  </verify>
  <done>
3 new tests verify signing_sdk/telegram categories appear in GET response and signing_sdk keys can be updated via PUT. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` passes
2. `pnpm turbo run test --filter=@waiaas/daemon -- --run packages/daemon/src/__tests__/admin-settings-api.test.ts` passes
3. GET /admin/settings response JSON has all 11 categories
4. PUT /admin/settings with signing_sdk.enabled=true persists and returns in response
</verification>

<success_criteria>
- SettingsResponseSchema includes all 11 categories from SETTING_CATEGORIES
- GET /admin/settings returns signing_sdk category with all 7 keys (enabled, request_expiry_min, preferred_channel, preferred_wallet, ntfy_request_topic_prefix, ntfy_response_topic_prefix, wallets)
- GET /admin/settings returns telegram category with all 3 keys (enabled, bot_token, locale)
- PUT /admin/settings can update signing_sdk.* and telegram.* keys
- 3 new tests pass covering signing_sdk/telegram categories
</success_criteria>

<output>
After completion, create `.planning/phases/205-admin-settings-skills-sync/205-01-SUMMARY.md`
</output>
