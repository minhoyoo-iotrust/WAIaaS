---
phase: 202-signing-protocol-daemon-sdk-ntfy
plan: 03
type: execute
wave: 2
depends_on: ["202-01"]
files_modified:
  - packages/wallet-sdk/package.json
  - packages/wallet-sdk/tsconfig.json
  - packages/wallet-sdk/tsconfig.build.json
  - packages/wallet-sdk/src/index.ts
  - packages/wallet-sdk/src/parse-request.ts
  - packages/wallet-sdk/src/build-response.ts
  - packages/wallet-sdk/src/display.ts
  - packages/wallet-sdk/src/channels/ntfy.ts
  - packages/wallet-sdk/src/channels/telegram.ts
  - packages/wallet-sdk/src/channels/index.ts
  - packages/wallet-sdk/src/errors.ts
  - packages/wallet-sdk/src/__tests__/parse-request.test.ts
  - packages/wallet-sdk/src/__tests__/build-response.test.ts
  - packages/wallet-sdk/src/__tests__/display.test.ts
  - packages/wallet-sdk/src/__tests__/channels.test.ts
  - turbo.json
autonomous: true
requirements:
  - SDK-01
  - SDK-02
  - SDK-03
  - SDK-04
  - SDK-05
  - SDK-06

must_haves:
  truths:
    - "parseSignRequest(url)이 유니버셜 링크 URL에서 SignRequest를 추출하고 Zod 검증을 통과한다"
    - "buildSignResponse()가 유효한 SignResponse 객체를 생성한다"
    - "formatDisplayMessage()가 사람이 읽을 수 있는 트랜잭션 요약을 반환한다"
    - "sendViaNtfy()가 ntfy 응답 토픽에 HTTP POST로 publish한다"
    - "sendViaTelegram()이 Telegram 딥링크 URL을 생성한다"
    - "subscribeToRequests()가 ntfy SSE 스트림에서 새 서명 요청 수신 시 콜백을 호출한다"
  artifacts:
    - path: "packages/wallet-sdk/package.json"
      provides: "@waiaas/wallet-sdk npm 패키지 설정"
      contains: "@waiaas/wallet-sdk"
    - path: "packages/wallet-sdk/src/index.ts"
      provides: "SDK 공개 API (6개 함수 + 타입 re-export)"
      exports: ["parseSignRequest", "buildSignResponse", "formatDisplayMessage", "sendViaNtfy", "sendViaTelegram", "subscribeToRequests"]
    - path: "packages/wallet-sdk/src/parse-request.ts"
      provides: "parseSignRequest 구현"
      exports: ["parseSignRequest"]
    - path: "packages/wallet-sdk/src/build-response.ts"
      provides: "buildSignResponse 구현"
      exports: ["buildSignResponse"]
    - path: "packages/wallet-sdk/src/display.ts"
      provides: "formatDisplayMessage 구현"
      exports: ["formatDisplayMessage"]
    - path: "packages/wallet-sdk/src/channels/ntfy.ts"
      provides: "sendViaNtfy + subscribeToRequests 구현"
      exports: ["sendViaNtfy", "subscribeToRequests"]
    - path: "packages/wallet-sdk/src/channels/telegram.ts"
      provides: "sendViaTelegram 구현"
      exports: ["sendViaTelegram"]
  key_links:
    - from: "packages/wallet-sdk/src/parse-request.ts"
      to: "packages/core/src/schemas/signing-protocol.ts"
      via: "import SignRequestSchema, decodeSignRequest from @waiaas/core"
      pattern: "import.*@waiaas/core"
    - from: "packages/wallet-sdk/src/index.ts"
      to: "packages/wallet-sdk/src/parse-request.ts"
      via: "re-export"
      pattern: "export.*parse-request"
---

<objective>
@waiaas/wallet-sdk 신규 npm 패키지 생성 (6개 공개 함수)

Purpose: 지갑 개발사(D'CENT 등)가 npm install하여 WAIaaS Signing Protocol v1을 통합할 수 있는 SDK 패키지를 생성한다. parseSignRequest, buildSignResponse, formatDisplayMessage, sendViaNtfy, sendViaTelegram, subscribeToRequests 6개 함수를 제공한다.
Output: packages/wallet-sdk 디렉토리 (신규 패키지) + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/202-signing-protocol-daemon-sdk-ntfy/202-01-SUMMARY.md
@internal/objectives/m26-01-wallet-signing-sdk.md
@internal/design/73-signing-protocol-v1.md
@internal/design/74-wallet-sdk-daemon-components.md
@packages/core/src/schemas/signing-protocol.ts
@packages/sdk/package.json
@packages/sdk/tsconfig.json
@turbo.json
@pnpm-workspace.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: @waiaas/wallet-sdk 패키지 scaffolding + parseSignRequest + buildSignResponse + formatDisplayMessage</name>
  <files>
    packages/wallet-sdk/package.json
    packages/wallet-sdk/tsconfig.json
    packages/wallet-sdk/tsconfig.build.json
    packages/wallet-sdk/src/index.ts
    packages/wallet-sdk/src/errors.ts
    packages/wallet-sdk/src/parse-request.ts
    packages/wallet-sdk/src/build-response.ts
    packages/wallet-sdk/src/display.ts
    packages/wallet-sdk/src/__tests__/parse-request.test.ts
    packages/wallet-sdk/src/__tests__/build-response.test.ts
    packages/wallet-sdk/src/__tests__/display.test.ts
    turbo.json
  </files>
  <action>
1. **패키지 scaffolding:**

   `packages/wallet-sdk/package.json`:
   - name: "@waiaas/wallet-sdk"
   - version: "0.1.0" (신규 패키지, 첫 릴리스)
   - description: "WAIaaS Wallet Signing SDK - integrate wallet apps with WAIaaS signing protocol"
   - type: "module"
   - main: "dist/index.js", types: "dist/index.d.ts"
   - exports: { ".": { "import": "./dist/index.js", "types": "./dist/index.d.ts" } }
   - files: ["dist", "README.md"]
   - scripts: build(tsc -p tsconfig.build.json), test(vitest run), lint(eslint src/), typecheck(tsc --noEmit), clean(rm -rf dist)
   - engines: { node: ">=18.0.0" } -- 지갑 앱(React Native 등) 호환성 위해 core보다 낮은 버전
   - dependencies: { "@waiaas/core": "workspace:*", "zod": "^3.24.0" }
   - devDependencies: { "@types/node": "^25.2.3", "vitest": "^3.0.0" }
   - publishConfig: { access: "public" }
   - repository, homepage, bugs: 기존 @waiaas/sdk 패턴 따름

   `packages/wallet-sdk/tsconfig.json`: @waiaas/sdk의 tsconfig.json 패턴 따름 (extends ../../tsconfig.json 또는 자체 config). compilerOptions에 target: "ES2022", module: "ESNext", moduleResolution: "bundler" 설정.

   `packages/wallet-sdk/tsconfig.build.json`: outDir "dist", declaration true, 기존 패턴 따름.

   `turbo.json` 수정: wallet-sdk 패키지가 turbo pipeline에 포함되도록 확인 (보통 packages/* glob이므로 자동 포함이나, 명시적 의존성 확인)

   `pnpm install` 실행하여 workspace 링크 갱신

2. **errors.ts:**
   - InvalidSignRequestUrlError extends Error
   - SignRequestExpiredError extends Error (expiresAt 포함)
   - SignRequestValidationError extends Error (Zod 에러 메시지 포함)
   - 각 에러 클래스에 name 프로퍼티 설정

3. **parseSignRequest (parse-request.ts):**
   doc 74 Section 2.1 시그니처 구현:
   ```typescript
   function parseSignRequest(url: string): SignRequest | Promise<SignRequest>
   ```
   - URL 파싱: `new URL(url).searchParams`
   - Case 1 (data 파라미터): base64url 디코딩 -> JSON.parse -> SignRequestSchema.parse()
     - base64url 디코딩: `Buffer.from(data, 'base64url').toString('utf-8')`
     - 만료 확인: expiresAt < Date.now() -> throw SignRequestExpiredError
   - Case 2 (requestId 파라미터): ntfy 토픽에서 HTTP 조회 (fetchSignRequestFromNtfy 내부 함수)
     - GET `{serverUrl}/{topic}/json?poll=1&since=all` 에서 메시지 검색
     - 이 모드는 async -> Promise<SignRequest> 반환
   - data도 requestId도 없으면: throw InvalidSignRequestUrlError
   - Zod 검증 실패: throw SignRequestValidationError (ZodError 메시지 포함)

4. **buildSignResponse (build-response.ts):**
   doc 74 Section 2.2 시그니처 구현:
   ```typescript
   function buildSignResponse(
     requestId: string,
     action: 'approve' | 'reject',
     signature?: string,
     signerAddress: string
   ): SignResponse
   ```
   - version: '1'
   - signedAt: new Date().toISOString()
   - action='approve' + signature 누락 시: throw Error('signature required for approve action')
   - SignResponseSchema.parse()로 자기 검증

5. **formatDisplayMessage (display.ts):**
   doc 74 Section 2.4 시그니처 구현:
   ```typescript
   function formatDisplayMessage(request: SignRequest): string
   ```
   - 사람 읽기용 트랜잭션 요약 텍스트 생성:
     ```
     Transaction Approval Request

     Type: {metadata.type}
     From: {metadata.from}
     To: {metadata.to}
     Amount: {metadata.amount} {metadata.symbol}  // 있을 때만
     Network: {network}
     Policy: {metadata.policyTier}
     Expires: {expiresAt}
     ```
   - amount/symbol 없으면 Amount 줄 생략

6. **index.ts:**
   - re-export: parseSignRequest, buildSignResponse, formatDisplayMessage
   - re-export types: SignRequest, SignResponse, WalletLinkConfig from @waiaas/core
   - re-export errors: InvalidSignRequestUrlError, SignRequestExpiredError, SignRequestValidationError
   - 채널 함수는 Task 2에서 추가

7. **테스트:**
   - `parse-request.test.ts`:
     - 유효한 data 파라미터 URL -> SignRequest 정상 파싱
     - 잘못된 base64url -> InvalidSignRequestUrlError
     - 만료된 요청 -> SignRequestExpiredError
     - Zod 검증 실패 (필수 필드 누락) -> SignRequestValidationError
     - data/requestId 없는 URL -> InvalidSignRequestUrlError
     - 딥링크 URL (커스텀 스키마) 파싱
   - `build-response.test.ts`:
     - approve + signature -> 유효한 SignResponse
     - reject + 서명 없음 -> 유효한 SignResponse (signature optional)
     - approve + signature 누락 -> Error
     - signedAt이 ISO 8601 형식
   - `display.test.ts`:
     - TRANSFER (amount + symbol) -> Amount 줄 포함
     - CONTRACT_CALL (amount 없음) -> Amount 줄 없음
     - 모든 필드 정확한 포맷
  </action>
  <verify>
  `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm install` 후 `pnpm turbo run typecheck --filter=@waiaas/wallet-sdk` 통과.
  `pnpm turbo run test --filter=@waiaas/wallet-sdk` 통과.
  </verify>
  <done>
  - @waiaas/wallet-sdk 패키지가 monorepo에 올바르게 등록되고 빌드/테스트 가능
  - parseSignRequest()가 유니버셜 링크 URL에서 SignRequest를 추출 + Zod 검증 + 만료 체크
  - buildSignResponse()가 유효한 SignResponse 생성 (approve 시 signature 필수)
  - formatDisplayMessage()가 사람 읽기용 트랜잭션 요약 반환
  </done>
</task>

<task type="auto">
  <name>Task 2: 채널 함수 (sendViaNtfy, sendViaTelegram, subscribeToRequests) + index 통합</name>
  <files>
    packages/wallet-sdk/src/channels/ntfy.ts
    packages/wallet-sdk/src/channels/telegram.ts
    packages/wallet-sdk/src/channels/index.ts
    packages/wallet-sdk/src/index.ts
    packages/wallet-sdk/src/__tests__/channels.test.ts
  </files>
  <action>
1. **sendViaNtfy (channels/ntfy.ts):**
   doc 73 Section 7.4 구현:
   ```typescript
   async function sendViaNtfy(
     response: SignResponse,
     responseTopic: string,
     serverUrl: string = 'https://ntfy.sh'
   ): Promise<void>
   ```
   - SignResponse를 JSON.stringify -> base64url 인코딩
   - `fetch(`${serverUrl}/${responseTopic}`, { method: 'POST', body: encoded })` 실행
   - HTTP 에러 시 Error throw (상태 코드 포함)

2. **subscribeToRequests (channels/ntfy.ts):**
   doc 74 Section 2.6 구현:
   ```typescript
   function subscribeToRequests(
     topic: string,
     callback: (request: SignRequest) => void,
     serverUrl: string = 'https://ntfy.sh'
   ): { unsubscribe: () => void }
   ```
   - ntfy SSE 구독: `fetch(`${serverUrl}/${topic}/sse`, { signal: abortController.signal })`
   - ReadableStream으로 SSE 이벤트 파싱
   - 각 메시지의 data 필드를 JSON.parse -> message 필드에서 base64url 디코딩 -> SignRequestSchema.parse()
   - 유효한 SignRequest면 callback 호출
   - 만료된 요청은 무시 (로그만)
   - unsubscribe(): AbortController.abort()로 SSE 연결 종료
   - 네트워크 에러 시 자동 재연결 (최대 3회, 5초 간격)

3. **sendViaTelegram (channels/telegram.ts):**
   doc 73 Section 8.5 구현:
   ```typescript
   function sendViaTelegram(
     response: SignResponse,
     botUsername: string
   ): string
   ```
   - SignResponse를 JSON.stringify -> base64url 인코딩
   - text: `/sign_response ${encoded}`
   - Telegram 유니버셜 링크 URL 생성: `https://t.me/${botUsername}?text=${encodeURIComponent(text)}`
   - URL string 반환 (실제 Telegram 열기는 지갑 앱의 책임)
   - 참고: 플랫폼 감지(Android tg:// vs iOS https://t.me)는 지갑 앱이 처리. SDK는 https://t.me URL만 반환.

4. **channels/index.ts:**
   - re-export: sendViaNtfy, subscribeToRequests from './ntfy.js'
   - re-export: sendViaTelegram from './telegram.js'

5. **index.ts 업데이트:**
   - 채널 함수 re-export 추가: `export { sendViaNtfy, subscribeToRequests, sendViaTelegram } from './channels/index.js';`

6. **테스트 (channels.test.ts):**
   - sendViaNtfy: fetch mock으로 올바른 URL, method POST, body(base64url encoded) 검증
   - sendViaNtfy: HTTP 에러 시 Error throw
   - sendViaTelegram: botUsername으로 올바른 https://t.me URL 생성
   - sendViaTelegram: 반환 URL에 /sign_response + base64url 인코딩된 SignResponse 포함
   - subscribeToRequests: mock SSE 스트림에서 SignRequest 파싱 후 콜백 호출 확인
   - subscribeToRequests: unsubscribe() 호출 시 연결 종료 확인
   - subscribeToRequests: 만료된 요청은 콜백 호출하지 않음
   - global.fetch를 vi.fn()으로 mock (vitest 환경)
  </action>
  <verify>
  `pnpm turbo run typecheck --filter=@waiaas/wallet-sdk` 통과.
  `pnpm turbo run test --filter=@waiaas/wallet-sdk` 전체 통과.
  `pnpm turbo run build --filter=@waiaas/wallet-sdk` 빌드 성공 (dist/ 생성).
  </verify>
  <done>
  - sendViaNtfy()가 ntfy 응답 토픽에 base64url(SignResponse)를 HTTP POST
  - sendViaTelegram()이 https://t.me/{botUsername}?text=... 형식의 Telegram 딥링크 URL 반환
  - subscribeToRequests()가 ntfy SSE 스트림을 구독하여 SignRequest 수신 시 콜백 호출
  - @waiaas/wallet-sdk에서 6개 함수 + 3개 에러 클래스 + 타입이 모두 export됨
  - 패키지 빌드 성공 (npm publish 준비 완료)
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/wallet-sdk` -- 타입 체크 통과
2. `pnpm turbo run test --filter=@waiaas/wallet-sdk` -- 모든 테스트 통과
3. `pnpm turbo run build --filter=@waiaas/wallet-sdk` -- 빌드 성공
4. SDK index.ts에서 6개 함수 + 타입 + 에러 모두 export 확인
</verification>

<success_criteria>
- @waiaas/wallet-sdk 패키지가 monorepo에 등록되고 빌드/테스트/타입체크 모두 통과
- 6개 공개 함수 (parseSignRequest, buildSignResponse, formatDisplayMessage, sendViaNtfy, sendViaTelegram, subscribeToRequests) 모두 구현 + 테스트
- 3개 에러 클래스 (InvalidSignRequestUrlError, SignRequestExpiredError, SignRequestValidationError) export
- SignRequest, SignResponse, WalletLinkConfig 타입 re-export
</success_criteria>

<output>
After completion, create `.planning/phases/202-signing-protocol-daemon-sdk-ntfy/202-03-SUMMARY.md`
</output>
