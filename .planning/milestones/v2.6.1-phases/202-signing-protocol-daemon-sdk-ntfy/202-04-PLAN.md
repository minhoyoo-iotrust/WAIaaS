---
phase: 202-signing-protocol-daemon-sdk-ntfy
plan: 04
type: execute
wave: 3
depends_on: ["202-02", "202-03"]
files_modified:
  - packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts
  - packages/daemon/src/services/signing-sdk/channels/index.ts
  - packages/daemon/src/services/signing-sdk/index.ts
  - packages/daemon/src/__tests__/ntfy-signing-channel.test.ts
  - packages/daemon/src/__tests__/signing-sdk-e2e.test.ts
autonomous: true
requirements:
  - CHAN-01
  - CHAN-02

must_haves:
  truths:
    - "NtfySigningChannel이 ntfy 요청 토픽에 SignRequest를 publish한다"
    - "NtfySigningChannel이 ntfy 응답 토픽을 subscribe하여 SignResponse를 수신한다"
    - "approve 응답 수신 시 SignResponseHandler를 통해 트랜잭션이 승인된다"
    - "reject 응답 수신 시 트랜잭션이 CANCELLED 상태로 변경된다"
    - "요청 만료 시 SSE 구독이 종료된다"
  artifacts:
    - path: "packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts"
      provides: "NtfySigningChannel 클래스 (ntfy publish/subscribe 서명 채널)"
      exports: ["NtfySigningChannel"]
    - path: "packages/daemon/src/services/signing-sdk/index.ts"
      provides: "signing-sdk 모듈 통합 export"
      exports: ["SignRequestBuilder", "SignResponseHandler", "WalletLinkRegistry", "NtfySigningChannel"]
  key_links:
    - from: "packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts"
      to: "packages/daemon/src/services/signing-sdk/sign-request-builder.ts"
      via: "SignRequestBuilder.buildRequest() 결과를 ntfy에 publish"
      pattern: "signRequestBuilder.*buildRequest"
    - from: "packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts"
      to: "packages/daemon/src/services/signing-sdk/sign-response-handler.ts"
      via: "수신한 SignResponse를 SignResponseHandler.handle()에 전달"
      pattern: "signResponseHandler.*handle"
    - from: "packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts"
      to: "packages/daemon/src/infrastructure/settings/settings-service.ts"
      via: "ntfy_server URL, topic prefix 조회"
      pattern: "settings.*get.*ntfy"
---

<objective>
NtfySigningChannel 구현 + signing-sdk 모듈 통합 + E2E 통합 테스트

Purpose: PENDING_APPROVAL 트랜잭션 발생 시 ntfy 요청 토픽에 SignRequest를 publish하고, 응답 토픽을 SSE로 subscribe하여 지갑 앱의 SignResponse를 수신/처리하는 E2E 플로우를 완성한다.
Output: NtfySigningChannel + 모듈 index + E2E 통합 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/202-signing-protocol-daemon-sdk-ntfy/202-01-SUMMARY.md
@.planning/phases/202-signing-protocol-daemon-sdk-ntfy/202-02-SUMMARY.md
@.planning/phases/202-signing-protocol-daemon-sdk-ntfy/202-03-SUMMARY.md
@internal/objectives/m26-01-wallet-signing-sdk.md
@internal/design/73-signing-protocol-v1.md
@internal/design/74-wallet-sdk-daemon-components.md
@packages/daemon/src/services/signing-sdk/sign-request-builder.ts
@packages/daemon/src/services/signing-sdk/sign-response-handler.ts
@packages/daemon/src/services/signing-sdk/wallet-link-registry.ts
@packages/daemon/src/infrastructure/settings/settings-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: NtfySigningChannel 구현</name>
  <files>
    packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts
    packages/daemon/src/services/signing-sdk/channels/index.ts
    packages/daemon/src/__tests__/ntfy-signing-channel.test.ts
  </files>
  <action>
1. `packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts` 생성:

   **의존성:**
   - SignRequestBuilder, SignResponseHandler (같은 signing-sdk 디렉토리)
   - SettingsService (ntfy 서버 URL, 토픽 접두어)
   - @waiaas/core: SignRequest, SignResponse, SignResponseSchema, encodeSignRequest

   **NtfySigningChannel 클래스:**
   ```typescript
   constructor(opts: {
     signRequestBuilder: SignRequestBuilder;
     signResponseHandler: SignResponseHandler;
     settingsService: SettingsService;
   })
   ```

   **sendRequest(params) 메서드:**
   PENDING_APPROVAL 트랜잭션에 대해 ntfy 요청 토픽에 SignRequest를 publish하고 응답 토픽을 subscribe한다.

   입력: SignRequestBuilder.buildRequest()에 전달할 파라미터 + walletId (ntfy 요청 토픽에 사용)

   로직 (doc 73 Section 7.2 + 7.3):
   1. SignRequestBuilder.buildRequest(params)로 SignRequest + universalLinkUrl 생성
   2. SignResponseHandler.registerRequest(request)로 대기 목록에 등록
   3. ntfy 서버 URL: settingsService.get('notifications.ntfy_server') || 'https://ntfy.sh'
   4. 요청 토픽: `{ntfy_request_topic_prefix}-{walletId}`
   5. ntfy 요청 publish (doc 73 Section 7.2 프로토콜):
      ```
      POST {ntfyServer}/{requestTopic}
      Content-Type: application/json
      Body: {
        topic: requestTopic,
        message: displayMessage,
        title: "WAIaaS Sign Request",
        priority: 5,
        tags: ["waiaas", "sign"],
        actions: [{ action: "view", label: "Sign in wallet", url: universalLinkUrl }],
        click: universalLinkUrl
      }
      ```
   6. 응답 토픽 SSE 구독 시작 (비동기, 백그라운드):
      - URL: `GET {ntfyServer}/{responseTopic}/sse`
      - responseTopic: request.responseChannel.responseTopic
      - ReadableStream으로 SSE 이벤트 파싱
      - "message" 이벤트의 data 필드 -> JSON.parse -> base64url 디코딩 -> SignResponseSchema.parse()
      - 유효한 SignResponse 수신 시: SignResponseHandler.handle(signResponse) 호출
      - 타임아웃: setTimeout(expiresAt - now) 시 AbortController.abort() -> 구독 종료
      - 네트워크 에러: 최대 3회 재연결 (5초 간격), 3회 초과 시 구독 종료 + 로그
   7. 반환: `{ requestId: string, requestTopic: string, responseTopic: string }`

   **활성 구독 관리:**
   - `activeSubscriptions: Map<string, AbortController>` -- requestId -> AbortController
   - cancelSubscription(requestId): 특정 구독 취소
   - shutdown(): 모든 활성 구독 종료 (데몬 종료 시)

   **SSE 파싱 헬퍼** (private):
   - parseSseStream(reader: ReadableStreamDefaultReader): AsyncGenerator<NtfyMessage>
   - ntfy SSE 형식: `event: message\ndata: {json}\n\n`
   - JSON 필드: { id, time, event, topic, message, ... }
   - message 필드 (plain text body)가 base64url 인코딩된 SignResponse

2. `packages/daemon/src/services/signing-sdk/channels/index.ts`:
   - re-export NtfySigningChannel

3. **테스트** (`ntfy-signing-channel.test.ts`):
   - 요청 publish: fetch mock으로 올바른 ntfy JSON 형식, priority 5, actions URL 확인
   - 응답 subscribe: mock SSE 스트림 -> SignResponse 수신 -> SignResponseHandler.handle() 호출 확인
   - reject 응답: handle() 결과가 'rejected' 확인
   - 만료 타임아웃: expiresAt 도달 시 SSE 구독 종료 확인 (AbortController.abort 호출)
   - 네트워크 에러 재연결: fetch 실패 -> 재시도 로직 확인
   - shutdown(): 모든 활성 구독 종료 확인
   - ntfy 서버 URL이 SettingsService에서 올바르게 조회되는지 확인
   - SignRequestBuilder, SignResponseHandler, SettingsService는 mock/stub 사용
   - global.fetch를 vi.fn()으로 mock
  </action>
  <verify>
  `pnpm turbo run typecheck --filter=@waiaas/daemon` 통과.
  `pnpm vitest run packages/daemon/src/__tests__/ntfy-signing-channel.test.ts` 모든 테스트 통과.
  </verify>
  <done>
  - NtfySigningChannel.sendRequest()가 ntfy 요청 토픽에 올바른 JSON 형식으로 publish
  - SSE 구독이 SignResponse 수신 시 SignResponseHandler.handle() 호출
  - 만료 시 SSE 구독 자동 종료
  - shutdown()으로 모든 활성 구독 정리
  </done>
</task>

<task type="auto">
  <name>Task 2: signing-sdk 모듈 index + E2E 통합 테스트</name>
  <files>
    packages/daemon/src/services/signing-sdk/index.ts
    packages/daemon/src/__tests__/signing-sdk-e2e.test.ts
  </files>
  <action>
1. `packages/daemon/src/services/signing-sdk/index.ts` 생성:
   - re-export: SignRequestBuilder from './sign-request-builder.js'
   - re-export: SignResponseHandler from './sign-response-handler.js'
   - re-export: WalletLinkRegistry from './wallet-link-registry.js'
   - re-export: NtfySigningChannel from './channels/index.js'
   - ISigningChannel 인터페이스 정의 (향후 TelegramSigningChannel도 구현):
     ```typescript
     export interface ISigningChannel {
       sendRequest(params: SignRequestParams): Promise<{ requestId: string }>;
       shutdown(): void;
     }
     ```

2. **E2E 통합 테스트** (`signing-sdk-e2e.test.ts`):
   전체 플로우를 mock ntfy 서버로 시뮬레이션:

   **시나리오 1: ntfy E2E approve 플로우**
   1. WalletLinkRegistry에 'dcent' 지갑 등록
   2. SettingsService mock: signing_sdk.enabled=true, ntfy 서버 URL, 토픽 접두어 설정
   3. NtfySigningChannel.sendRequest({ txId, chain:'evm', network:'ethereum-mainnet', type:'TRANSFER', from, to, amount:'1.5', symbol:'ETH', policyTier:'APPROVAL', walletName:'dcent', walletId })
   4. fetch mock에서 ntfy publish 호출 검증 (요청 토픽, JSON body, 유니버셜 링크 actions)
   5. mock SSE 스트림에 approve SignResponse publish (유효한 서명 포함)
   6. SignResponseHandler.handle() 호출 확인 -> 결과: approved
   7. 구독 자동 종료 확인

   **시나리오 2: ntfy E2E reject 플로우**
   1. 동일 설정
   2. sendRequest() 호출
   3. mock SSE 스트림에 reject SignResponse publish
   4. SignResponseHandler.handle() -> 결과: rejected
   5. 구독 자동 종료 확인

   **시나리오 3: 만료 시나리오**
   1. request_expiry_min을 0.01 (매우 짧게)로 설정
   2. sendRequest() 호출
   3. setTimeout으로 만료 대기
   4. SSE 구독이 종료되는지 확인

   **시나리오 4: SDK parseSignRequest round-trip**
   1. SignRequestBuilder.buildRequest()로 SignRequest + universalLinkUrl 생성
   2. @waiaas/wallet-sdk의 parseSignRequest(universalLinkUrl)로 파싱
   3. 원본 SignRequest와 파싱 결과가 동일한지 deep equal 비교
   4. formatDisplayMessage() 결과가 사람 읽기 가능한 형식인지 확인

   **시나리오 5: SDK sendViaNtfy round-trip**
   1. buildSignResponse()로 SignResponse 생성
   2. sendViaNtfy() -> fetch mock에서 올바른 ntfy publish 검증
   3. mock SSE에서 동일 SignResponse를 NtfySigningChannel이 수신하는지 확인

   **참고:** 실제 ntfy 서버는 사용하지 않음. 모든 HTTP 호출은 vi.fn() mock.
   DB 조작이 필요한 SignResponseHandler 내부 로직은 mock 또는 최소한의 in-memory 처리.
  </action>
  <verify>
  `pnpm turbo run typecheck --filter=@waiaas/daemon` 통과.
  `pnpm vitest run packages/daemon/src/__tests__/signing-sdk-e2e.test.ts` 모든 테스트 통과.
  `pnpm turbo run test --filter=@waiaas/daemon` 전체 테스트 통과 (기존 테스트 깨지지 않음).
  `pnpm turbo run test --filter=@waiaas/wallet-sdk` SDK 테스트 통과.
  </verify>
  <done>
  - signing-sdk 모듈에서 SignRequestBuilder, SignResponseHandler, WalletLinkRegistry, NtfySigningChannel 모두 import 가능
  - E2E approve 플로우: SignRequest 생성 -> ntfy publish -> SSE 수신 -> approve 처리 완료
  - E2E reject 플로우: reject 응답 -> CANCELLED 처리 완료
  - 만료 시나리오: SSE 구독 자동 종료
  - SDK round-trip: 데몬이 생성한 SignRequest를 SDK가 정확히 파싱
  - 전체 monorepo 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck` -- 전체 monorepo 타입 체크 통과
2. `pnpm turbo run test --filter=@waiaas/daemon --filter=@waiaas/wallet-sdk` -- 모든 테스트 통과
3. E2E 통합 테스트가 ntfy 기반 전체 서명 플로우를 검증
4. Phase 202 Success Criteria 5개 모두 충족:
   - (1) PENDING_APPROVAL -> SignRequest -> 유니버셜 링크 URL + 만료/서명 에러
   - (2) NtfySigningChannel publish + subscribe -> approve/cancel
   - (3) wallet-sdk 6개 함수 동작
   - (4) WalletLinkRegistry + SettingsService signing_sdk.* 키
   - (5) wallets.owner_approval_method DB 마이그레이션
</verification>

<success_criteria>
- NtfySigningChannel이 ntfy 요청 토픽에 publish + 응답 토픽을 SSE로 subscribe
- approve SignResponse 수신 시 트랜잭션 승인, reject 시 CANCELLED
- 만료 시 SSE 구독 자동 종료
- signing-sdk 모듈이 4개 클래스를 통합 export
- E2E 통합 테스트로 전체 플로우 검증 완료
- Phase 202의 5가지 Success Criteria 모두 충족
</success_criteria>

<output>
After completion, create `.planning/phases/202-signing-protocol-daemon-sdk-ntfy/202-04-SUMMARY.md`
</output>
