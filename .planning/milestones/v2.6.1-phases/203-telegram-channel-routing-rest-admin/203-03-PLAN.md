---
phase: 203-telegram-channel-routing-rest-admin
plan: 03
type: execute
wave: 2
depends_on: [203-01]
files_modified:
  - packages/daemon/src/services/signing-sdk/approval-channel-router.ts
  - packages/daemon/src/services/signing-sdk/index.ts
  - packages/daemon/src/__tests__/approval-channel-router.test.ts
autonomous: true
requirements: [CHAN-05, CHAN-06, CHAN-07]

must_haves:
  truths:
    - "ApprovalChannelRouter routes to the correct ISigningChannel based on wallet's owner_approval_method"
    - "When owner_approval_method is not set, ApprovalChannelRouter follows global fallback priority: SDK ntfy > SDK Telegram > WalletConnect > Telegram Bot > REST"
    - "When signing_sdk.enabled=false, SDK channels are skipped and fallback goes to WalletConnect > Telegram Bot > REST"
  artifacts:
    - path: "packages/daemon/src/services/signing-sdk/approval-channel-router.ts"
      provides: "ApprovalChannelRouter class with route() method"
      exports: ["ApprovalChannelRouter"]
      min_lines: 80
    - path: "packages/daemon/src/__tests__/approval-channel-router.test.ts"
      provides: "Unit tests for routing logic and fallback"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/services/signing-sdk/approval-channel-router.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "reads wallets.ownerApprovalMethod to determine channel"
      pattern: "owner_approval_method"
    - from: "packages/daemon/src/services/signing-sdk/approval-channel-router.ts"
      to: "packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts"
      via: "routes to NtfySigningChannel for sdk_ntfy method"
      pattern: "NtfySigningChannel|ntfyChannel"
    - from: "packages/daemon/src/services/signing-sdk/approval-channel-router.ts"
      to: "packages/daemon/src/services/signing-sdk/channels/telegram-signing-channel.ts"
      via: "routes to TelegramSigningChannel for sdk_telegram method"
      pattern: "TelegramSigningChannel|telegramChannel"
---

<objective>
ApprovalChannelRouter 구현: 지갑별 owner_approval_method에 따라 올바른 서명 채널로 라우팅하고, 미설정 시 글로벌 5단계 우선순위로 fallback

Purpose: 단일 라우터에서 5가지 승인 방법(sdk_ntfy, sdk_telegram, walletconnect, telegram_bot, rest)을 통합 관리하여, PENDING_APPROVAL 트랜잭션 발생 시 올바른 채널로 자동 라우팅
Output: ApprovalChannelRouter 클래스 + 포괄적 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/203-telegram-channel-routing-rest-admin/203-01-PLAN.md

@packages/daemon/src/services/signing-sdk/index.ts
@packages/daemon/src/services/signing-sdk/channels/ntfy-signing-channel.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/core/src/schemas/signing-protocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ApprovalChannelRouter 구현</name>
  <files>
    packages/daemon/src/services/signing-sdk/approval-channel-router.ts
    packages/daemon/src/services/signing-sdk/index.ts
  </files>
  <action>
Create `packages/daemon/src/services/signing-sdk/approval-channel-router.ts`:

**Constructor dependencies:**
```ts
interface ApprovalChannelRouterDeps {
  sqlite: Database;  // better-sqlite3 for reading wallet's owner_approval_method
  settingsService: SettingsService;
  ntfyChannel?: NtfySigningChannel;
  telegramChannel?: TelegramSigningChannel;
  // walletconnect and telegram_bot don't use ISigningChannel -- they use existing ApprovalWorkflow flow
  // REST also doesn't use ISigningChannel -- it's the existing REST API flow
}
```

**`async route(walletId: string, params: SendRequestParams): Promise<RouteResult>`:**

1. Read wallet's `owner_approval_method` from DB:
   ```ts
   const row = this.sqlite.prepare(
     'SELECT owner_approval_method FROM wallets WHERE id = ?'
   ).get(walletId) as { owner_approval_method: string | null } | undefined;
   ```

2. If `row.owner_approval_method` is set (not null), use explicit method:
   - `sdk_ntfy`: if `ntfyChannel` exists and signing_sdk enabled, call `ntfyChannel.sendRequest(params)`, return `{ method: 'sdk_ntfy', result }`
   - `sdk_telegram`: if `telegramChannel` exists and signing_sdk enabled, call `telegramChannel.sendRequest(params)`, return `{ method: 'sdk_telegram', result }`
   - `walletconnect`: return `{ method: 'walletconnect', result: null }` (handled by existing WcSigningBridge, not by this router)
   - `telegram_bot`: return `{ method: 'telegram_bot', result: null }` (handled by existing TelegramBotService /pending approval flow)
   - `rest`: return `{ method: 'rest', result: null }` (handled by existing REST API /approve endpoint)
   - If the explicitly set method is an SDK method but SDK is disabled (`signing_sdk.enabled !== 'true'`), fall through to global fallback.

3. If `owner_approval_method` is null or the explicit method can't be used, apply global fallback priority (CHAN-06):
   Priority order: SDK ntfy > SDK Telegram > WalletConnect > Telegram Bot > REST

   - Check `signing_sdk.enabled === 'true'` (CHAN-07: if false, skip SDK channels entirely)
     - If enabled and `ntfyChannel` exists: use `sdk_ntfy`
     - If enabled and `telegramChannel` exists: use `sdk_telegram`
   - Check `walletconnect.project_id` is non-empty: use `walletconnect`
   - Check `telegram.enabled === 'true'` and `telegram.bot_token` is non-empty: use `telegram_bot`
   - Default: use `rest`

**Return type:**
```ts
interface RouteResult {
  method: ApprovalMethod;  // from @waiaas/core
  channelResult: { requestId: string } | null;  // non-null for SDK channels, null for wc/telegram_bot/rest
}
```

**`shutdown(): void`:**
Call `ntfyChannel?.shutdown()` and `telegramChannel?.shutdown()`.

**Export from signing-sdk/index.ts:**
Add `export { ApprovalChannelRouter } from './approval-channel-router.js';` and export the `RouteResult` type.
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/daemon` passes.
`grep "ApprovalChannelRouter" packages/daemon/src/services/signing-sdk/index.ts` shows the export.
  </verify>
  <done>ApprovalChannelRouter routes to correct channel based on wallet's owner_approval_method, falls back to global 5-priority when unset, skips SDK channels when signing_sdk.enabled=false</done>
</task>

<task type="auto">
  <name>Task 2: ApprovalChannelRouter 단위 테스트</name>
  <files>
    packages/daemon/src/__tests__/approval-channel-router.test.ts
  </files>
  <action>
Create `packages/daemon/src/__tests__/approval-channel-router.test.ts` with comprehensive unit tests:

**Setup:** Create mock instances for sqlite (better-sqlite3), SettingsService, NtfySigningChannel, TelegramSigningChannel. Use jest.fn() / vi.fn() for mocking (follow existing test patterns in codebase).

**Test groups:**

1. **Explicit method routing (CHAN-05):**
   - wallet has `owner_approval_method = 'sdk_ntfy'` -> routes to NtfySigningChannel
   - wallet has `owner_approval_method = 'sdk_telegram'` -> routes to TelegramSigningChannel
   - wallet has `owner_approval_method = 'walletconnect'` -> returns `{ method: 'walletconnect', channelResult: null }`
   - wallet has `owner_approval_method = 'telegram_bot'` -> returns `{ method: 'telegram_bot', channelResult: null }`
   - wallet has `owner_approval_method = 'rest'` -> returns `{ method: 'rest', channelResult: null }`

2. **Global fallback (CHAN-06):**
   - wallet has `owner_approval_method = null`, signing_sdk enabled, ntfy available -> routes to sdk_ntfy
   - wallet has `owner_approval_method = null`, signing_sdk enabled, no ntfy, telegram available -> routes to sdk_telegram
   - wallet has `owner_approval_method = null`, signing_sdk disabled, walletconnect configured -> routes to walletconnect
   - wallet has `owner_approval_method = null`, all SDK+WC disabled, telegram bot enabled -> routes to telegram_bot
   - wallet has `owner_approval_method = null`, nothing configured -> routes to rest (final fallback)

3. **SDK disabled fallback (CHAN-07):**
   - wallet has `owner_approval_method = 'sdk_ntfy'`, signing_sdk disabled -> falls through to global fallback
   - wallet has `owner_approval_method = null`, signing_sdk disabled -> skips SDK channels, tries WC/telegram_bot/rest

4. **Edge cases:**
   - wallet not found in DB -> throws appropriate error
   - sendRequest on SDK channel throws error -> propagates error (does not silently fallback)

Each test should verify both the returned `method` value and whether `sendRequest` was called on the correct channel mock.
  </action>
  <verify>
`pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern="approval-channel-router" --no-coverage` passes.
  </verify>
  <done>15+ test cases covering explicit routing, global fallback priority, SDK-disabled fallback, and edge cases. All pass.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` -- no type errors
2. `pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern="approval-channel-router" --no-coverage` -- all tests pass
3. No regression: `pnpm turbo run test --filter=@waiaas/daemon -- --testPathPattern="signing" --no-coverage` -- all signing-related tests pass
</verification>

<success_criteria>
- ApprovalChannelRouter.route() dispatches to correct channel based on owner_approval_method
- Global fallback priority: SDK ntfy > SDK Telegram > WC > Telegram Bot > REST
- SDK disabled: skips SDK channels entirely (CHAN-07)
- 15+ unit tests covering all routing scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/203-telegram-channel-routing-rest-admin/203-03-SUMMARY.md`
</output>
