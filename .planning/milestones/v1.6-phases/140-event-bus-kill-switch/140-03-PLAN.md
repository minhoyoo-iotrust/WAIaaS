---
phase: 140-event-bus-kill-switch
plan: 03
type: execute
wave: 2
depends_on: ["140-01", "140-02"]
files_modified:
  - packages/daemon/src/services/kill-switch-service.ts
  - packages/daemon/src/api/middleware/kill-switch-guard.ts
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/server.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/notifications/templates/message-templates.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/daemon/src/__tests__/kill-switch-cascade.test.ts
  - packages/daemon/src/__tests__/kill-switch-api.test.ts
autonomous: true

must_haves:
  truths:
    - "POST /v1/admin/kill-switch(masterAuth)로 ACTIVE->SUSPENDED 전이 + 6-step cascade가 실행된다"
    - "POST /v1/owner/kill-switch(ownerAuth)로 ACTIVE->SUSPENDED 전이 + 6-step cascade가 실행된다"
    - "6-step cascade가 순차 실행된다: 세션 무효화->거래 중단->월렛 정지->API 503->알림->감사 로그"
    - "SUSPENDED 상태에서 dual-auth(Owner 서명 + Master 패스워드)로 ACTIVE 복구가 가능하다"
    - "LOCKED 상태에서 dual-auth + 추가 대기 시간으로 ACTIVE 복구가 가능하다"
    - "killSwitch 미들웨어가 SUSPENDED/LOCKED일 때 503 SYSTEM_LOCKED를 반환한다"
  artifacts:
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "Kill Switch REST API (activate/escalate/recover + owner route)"
      exports: ["adminRoutes"]
    - path: "packages/daemon/src/api/middleware/kill-switch-guard.ts"
      provides: "3-state killSwitch 미들웨어 (SUSPENDED/LOCKED -> 503)"
      exports: ["createKillSwitchGuard"]
    - path: "packages/daemon/src/__tests__/kill-switch-cascade.test.ts"
      provides: "6-step cascade 테스트"
    - path: "packages/daemon/src/__tests__/kill-switch-api.test.ts"
      provides: "Kill Switch REST API 테스트"
  key_links:
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "packages/daemon/src/services/kill-switch-service.ts"
      via: "KillSwitchService method calls"
      pattern: "killSwitchService\\.(activate|escalate|recover)"
    - from: "packages/daemon/src/api/middleware/kill-switch-guard.ts"
      to: "packages/daemon/src/services/kill-switch-service.ts"
      via: "getState() for guard check"
      pattern: "getState|SUSPENDED|LOCKED"
    - from: "packages/daemon/src/services/kill-switch-service.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "6-step cascade DB operations"
      pattern: "sessions|transactions|wallets|auditLog"
---

<objective>
Kill Switch 6-step cascade 로직, REST API(admin + owner), dual-auth 복구 API, killSwitch 미들웨어 3-state 리팩토링을 구현한다.

Purpose: Kill Switch 발동 시 세션 무효화/거래 중단/월렛 정지/API 차단/알림/감사로그가 순차 실행되고, masterAuth 또는 ownerAuth로 발동, dual-auth로 복구할 수 있는 완전한 Kill Switch 시스템을 완성한다.
Output: 6-step cascade 로직, admin/owner Kill Switch REST API, dual-auth 복구 API, 3-state 미들웨어, 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@objectives/v1.6-desktop-telegram-docker.md
@.planning/phases/140-event-bus-kill-switch/140-01-SUMMARY.md
@.planning/phases/140-event-bus-kill-switch/140-02-SUMMARY.md
@packages/daemon/src/services/kill-switch-service.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/middleware/kill-switch-guard.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/lifecycle/daemon.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 6-step Cascade + killSwitch 미들웨어 3-state 리팩토링</name>
  <files>
    packages/daemon/src/services/kill-switch-service.ts
    packages/daemon/src/api/middleware/kill-switch-guard.ts
    packages/daemon/src/notifications/templates/message-templates.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/daemon/src/__tests__/kill-switch-cascade.test.ts
  </files>
  <action>
1. `KillSwitchService`에 6-step cascade 메서드 추가 (packages/daemon/src/services/kill-switch-service.ts):

   cascade 의존성을 constructor에 추가:
   ```
   constructor(opts: {
     sqlite: Database;
     db: BetterSQLite3Database<typeof schema>;
     notificationService?: NotificationService;
     eventBus?: EventBus;
   })
   ```

   `async executeCascade(activatedBy: string): Promise<void>` 메서드:
   - Step 1: 세션 무효화 -- `UPDATE sessions SET revoked_at = ? WHERE revoked_at IS NULL` (현재 시각)
   - Step 2: 진행 중 거래 중단 -- `UPDATE transactions SET status = 'CANCELLED', error = 'Kill switch activated' WHERE status IN ('PENDING', 'QUEUED', 'EXECUTING')`
   - Step 3: 월렛 전체 정지 -- `UPDATE wallets SET status = 'SUSPENDED', suspended_at = ?, suspension_reason = 'Kill switch activated' WHERE status = 'ACTIVE'` (주의: 현재 wallet status ENUM에 SUSPENDED가 있는지 확인. WALLET_STATUSES를 확인하여 'SUSPENDED' 포함 여부 검증. 포함되지 않으면 적절한 상태값 사용)
   - Step 4: API 503은 미들웨어가 처리 (KillSwitchService 상태가 SUSPENDED/LOCKED이면 미들웨어에서 차단)
   - Step 5: 알림 발송 -- `void this.notificationService?.notify('KILL_SWITCH_ACTIVATED', 'system', { activatedBy })`
   - Step 6: 감사 로그 -- `INSERT INTO audit_log (timestamp, event_type, actor, details, severity) VALUES (?, 'KILL_SWITCH_ACTIVATED', ?, ?, 'critical')`
   - EventBus emit: `this.eventBus?.emit('wallet:activity', { walletId: 'system', activity: 'TX_REQUESTED', details: { action: 'kill_switch_activated', activatedBy }, timestamp })`

   `activateWithCascade(activatedBy: string): { success: boolean; error?: string }` 메서드:
   - CAS activate() 호출
   - 성공 시 executeCascade() 호출
   - 실패 시 현재 상태에 따라 에러 메시지 반환

   `escalateWithCascade(escalatedBy: string): { success: boolean; error?: string }` 메서드:
   - CAS escalate() 호출
   - 성공 시 알림 발송 (KILL_SWITCH_ESCALATED) + 감사 로그

2. `packages/daemon/src/api/middleware/kill-switch-guard.ts` 수정:
   - `GetKillSwitchState` 타입을 `() => string`에서 `() => { state: string }` 으로 변경
   - `if (state === 'ACTIVATED')` 체크를 `if (state === 'SUSPENDED' || state === 'LOCKED')` 으로 변경
   - 에러를 `WAIaaSError('KILL_SWITCH_ACTIVE')` 에서 `WAIaaSError('SYSTEM_LOCKED')` 으로 변경 (503)
   - Owner API paths도 bypass 추가: `/v1/owner/` 경로 (owner kill-switch 발동 + 복구에 필요)
   - Recovery API bypass: `/v1/admin/recover`, `/v1/admin/kill-switch` (관리용)

3. `packages/core/src/i18n/en.ts` 수정:
   - KILL_SWITCH_ESCALATED 메시지 추가: title "Kill Switch Escalated", body "Kill switch escalated to LOCKED state by {escalatedBy}"
   - KILL_SWITCH_RECOVERED에 이미 메시지가 있는지 확인, 없으면 추가

4. `packages/core/src/i18n/ko.ts` 수정:
   - KILL_SWITCH_ESCALATED 메시지: title "Kill Switch 격상", body "Kill Switch가 {escalatedBy}에 의해 LOCKED 상태로 격상되었습니다"
   - KILL_SWITCH_RECOVERED 메시지 확인/추가

5. `packages/daemon/src/notifications/templates/message-templates.ts` 수정:
   - KILL_SWITCH_ESCALATED 이벤트를 notification template에 추가 (기존 패턴 따라)

6. `packages/daemon/src/__tests__/kill-switch-cascade.test.ts` 생성:
   - in-memory DB에 sessions, transactions, wallets 테이블 생성 + 테스트 데이터 삽입
   - executeCascade() 후 sessions.revoked_at 설정 확인
   - executeCascade() 후 PENDING/QUEUED 거래가 CANCELLED로 변경 확인
   - executeCascade() 후 ACTIVE 월렛이 SUSPENDED로 변경 확인
   - 알림 발송 mock 호출 확인
   - 감사 로그 INSERT 확인
   - activateWithCascade() 성공 시나리오 (ACTIVE -> SUSPENDED + cascade)
   - activateWithCascade() 실패 시나리오 (이미 SUSPENDED -> false)
   - escalateWithCascade() 성공/실패 테스트
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/kill-switch-cascade.test.ts --reporter=verbose
  </verify>
  <done>
6-step cascade가 순차 실행되어 세션 무효화/거래 중단/월렛 정지/알림/감사 로그가 완료되고, killSwitch 미들웨어가 SUSPENDED/LOCKED에서 503 반환
  </done>
</task>

<task type="auto">
  <name>Task 2: Kill Switch REST API + dual-auth 복구 + DaemonLifecycle 통합</name>
  <files>
    packages/daemon/src/api/routes/admin.ts
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/server.ts
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/__tests__/kill-switch-api.test.ts
  </files>
  <action>
1. `packages/daemon/src/api/routes/openapi-schemas.ts` 수정:
   - KillSwitchActivateResponseSchema 업데이트: state를 'SUSPENDED' 반환
   - KillSwitchResponseSchema 업데이트: state 가능값 'ACTIVE' | 'SUSPENDED' | 'LOCKED'
   - RecoverResponseSchema 업데이트: state를 'ACTIVE' 반환
   - 새 스키마 추가:
     - `KillSwitchEscalateResponseSchema`: `{ state: 'LOCKED', escalatedAt: number }`
     - `KillSwitchRecoverRequestSchema`: dual-auth body `{ ownerSignature: string, ownerAddress: string, chain: 'solana' | 'evm', message: string }` -- Owner SIWS/SIWE 서명 + Master 패스워드는 masterAuth 미들웨어에서 처리
     - `OwnerKillSwitchResponseSchema`: `{ state: 'SUSPENDED', activatedAt: number }`

2. `packages/daemon/src/api/routes/admin.ts` 수정:
   - `AdminRouteDeps`에 `killSwitchService?: KillSwitchService` 추가
   - `getKillSwitchState`/`setKillSwitchState` 기존 인라인 로직을 KillSwitchService로 교체

   - POST /admin/kill-switch 핸들러 리팩토링:
     - `deps.killSwitchService.activateWithCascade('master')` 호출
     - 실패 시: 현재 상태 확인 후 KILL_SWITCH_ACTIVE (이미 SUSPENDED) 또는 적절한 에러 반환
     - 성공 시: `{ state: 'SUSPENDED', activatedAt }` 반환

   - POST /admin/kill-switch/escalate 라우트 신규:
     - `deps.killSwitchService.escalateWithCascade('master')` 호출
     - 실패 시 409 INVALID_STATE_TRANSITION
     - 성공 시 `{ state: 'LOCKED', escalatedAt }` 반환

   - GET /admin/kill-switch 핸들러 리팩토링:
     - `deps.killSwitchService.getState()` 사용
     - 반환: `{ state, activatedAt, activatedBy }`

   - POST /admin/recover 핸들러 리팩토링 (dual-auth 복구):
     - Request body: `{ ownerSignature, ownerAddress, chain, message }`
     - Step 1: Master 패스워드는 masterAuth 미들웨어에서 이미 검증됨
     - Step 2: Owner 서명 검증 -- ownerAddress가 등록된 어느 월렛의 ownerAddress와 일치하는지 확인 + 서명 검증 (기존 ownerAuth 로직 재활용, chain에 따라 SIWS/SIWE 검증)
     - Step 3: 현재 상태에 따라 recoverFromSuspended() 또는 recoverFromLocked() 호출
     - LOCKED 복구 시: 추가 대기 시간 (5초) -- `await sleep(5000)` (config로 조정 가능하게 하되 기본값 5000ms)
     - 성공 시: `{ state: 'ACTIVE', recoveredAt }` + 알림 KILL_SWITCH_RECOVERED + 감사 로그 KILL_SWITCH_RECOVERED
     - 실패 시: 409 INVALID_STATE_TRANSITION (ACTIVE 상태에서 복구 시도 등)
     - Owner가 미등록인 경우(NONE 상태): Master 패스워드만으로 복구 허용 (dual-auth에서 owner 부분 skip, 월렛 ownerAddress 중 하나라도 있으면 owner 서명 필수)

3. Owner Kill Switch 라우트 신규 추가 (admin.ts 또는 별도 파일):
   - POST /v1/owner/kill-switch -- ownerAuth 미들웨어로 보호
   - Owner가 직접 Kill Switch 발동 가능
   - `deps.killSwitchService.activateWithCascade(ownerAddress)` 호출
   - 성공 시 `{ state: 'SUSPENDED', activatedAt }` 반환

4. `packages/daemon/src/api/server.ts` 수정:
   - `CreateAppDeps`에 `killSwitchService?: KillSwitchService` 추가
   - `getKillSwitchState` 함수를 KillSwitchService.getState() 기반으로 변경
   - killSwitchGuard에 전달하는 getState 함수 업데이트
   - Owner kill-switch 라우트 등록
   - /v1/owner/kill-switch에 ownerAuth 미들웨어 적용
   - /v1/admin/kill-switch/escalate에 masterAuth 미들웨어 적용
   - adminRoutes에 killSwitchService deps 전달

5. `packages/daemon/src/lifecycle/daemon.ts` 수정:
   - KillSwitchService 인스턴스 생성 (sqlite 전달)
   - startup 시 killSwitchService.ensureInitialized() 호출
   - createApp()에 killSwitchService 전달
   - 기존 인라인 killSwitch 상태 관리 코드를 KillSwitchService로 교체

6. `packages/daemon/src/__tests__/kill-switch-api.test.ts` 생성:
   - createApp()으로 테스트 Hono 앱 생성 (KillSwitchService mock)
   - POST /v1/admin/kill-switch 테스트: 정상 발동 -> 200 + state='SUSPENDED'
   - POST /v1/admin/kill-switch 중복 테스트: 이미 SUSPENDED -> 409
   - POST /v1/admin/kill-switch/escalate 테스트: SUSPENDED -> LOCKED -> 200
   - POST /v1/admin/kill-switch/escalate 잘못된 상태 테스트: ACTIVE -> 409
   - GET /v1/admin/kill-switch 테스트: 현재 상태 반환
   - POST /v1/admin/recover 테스트: dual-auth 성공 -> ACTIVE
   - POST /v1/admin/recover Owner 미등록 시: master-only 복구 가능
   - POST /v1/admin/recover LOCKED 시: 추가 대기 시간 적용
   - POST /v1/owner/kill-switch 테스트: owner 발동 -> SUSPENDED
   - killSwitch 미들웨어 테스트: SUSPENDED 상태에서 일반 API 요청 -> 503
   - killSwitch 미들웨어 테스트: SUSPENDED 상태에서 /health -> 200 (bypass)
   - killSwitch 미들웨어 테스트: SUSPENDED 상태에서 /v1/admin/ -> 200 (bypass)
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/kill-switch-api.test.ts src/__tests__/kill-switch-cascade.test.ts --reporter=verbose && pnpm --filter @waiaas/daemon exec vitest run --reporter=verbose 2>&1 | tail -30
  </verify>
  <done>
Kill Switch REST API(admin + owner)가 동작하고, 6-step cascade가 발동되며, dual-auth 복구가 SUSPENDED/LOCKED 모두에서 가능하고, 미들웨어가 SUSPENDED/LOCKED에서 503을 반환하며, 전체 테스트가 통과함
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon build` 성공
2. Kill Switch cascade 테스트 통과 (6-step 각 단계 검증)
3. Kill Switch API 테스트 통과 (activate/escalate/recover/owner)
4. killSwitch 미들웨어 테스트 통과 (SUSPENDED/LOCKED -> 503, bypass 경로)
5. `pnpm --filter @waiaas/daemon exec vitest run` 전체 테스트 통과 (기존 admin 테스트 포함)
6. `pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon build` 빌드 성공
</verification>

<success_criteria>
- KILL-03: 6-step cascade(세션 무효화->거래 중단->월렛 정지->API 503->알림->감사 로그) 순차 실행
- KILL-04: SUSPENDED 상태에서 dual-auth(Owner 서명 + Master 패스워드)로 ACTIVE 복구
- KILL-05: LOCKED 상태에서 dual-auth + 추가 대기 시간으로 ACTIVE 복구
- KILL-08: POST /v1/admin/kill-switch(masterAuth) + POST /v1/owner/kill-switch(ownerAuth) API 제공
- KILL-09: killSwitch 미들웨어가 SUSPENDED/LOCKED에서 503 SYSTEM_LOCKED 반환
</success_criteria>

<output>
After completion, create `.planning/phases/140-event-bus-kill-switch/140-03-SUMMARY.md`
</output>
