---
phase: 140-event-bus-kill-switch
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/enums/system.ts
  - packages/core/src/enums/audit.ts
  - packages/core/src/enums/notification.ts
  - packages/core/src/errors/error-codes.ts
  - packages/daemon/src/services/kill-switch-service.ts
  - packages/daemon/src/infrastructure/database/migrate.ts
  - packages/daemon/src/__tests__/kill-switch-service.test.ts
  - packages/daemon/src/__tests__/migration-v14.test.ts
autonomous: true

must_haves:
  truths:
    - "KillSwitchService가 3-state 상태 머신(ACTIVE/SUSPENDED/LOCKED)으로 동작한다"
    - "ACTIVE->SUSPENDED, SUSPENDED->LOCKED, SUSPENDED->ACTIVE, LOCKED->ACTIVE 4전이가 CAS ACID 패턴으로 원자적으로 수행된다"
    - "동시에 두 상태 전이 요청이 도착하면 하나만 성공하고 나머지는 실패한다"
    - "잘못된 상태 전이(ACTIVE->LOCKED 직접 등)가 거부된다"
    - "DB 마이그레이션이 NORMAL->ACTIVE, ACTIVATED->SUSPENDED로 기존 값을 변환한다"
  artifacts:
    - path: "packages/daemon/src/services/kill-switch-service.ts"
      provides: "KillSwitchService 3-state 상태 머신 + CAS ACID"
      exports: ["KillSwitchService"]
    - path: "packages/core/src/enums/system.ts"
      provides: "KILL_SWITCH_STATES SSoT (ACTIVE/SUSPENDED/LOCKED)"
      exports: ["KILL_SWITCH_STATES", "KillSwitchState", "KillSwitchStateEnum"]
    - path: "packages/daemon/src/__tests__/kill-switch-service.test.ts"
      provides: "KillSwitchService CAS ACID + 상태 전이 테스트"
  key_links:
    - from: "packages/daemon/src/services/kill-switch-service.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "keyValueStore table CAS pattern"
      pattern: "BEGIN IMMEDIATE|UPDATE.*WHERE.*value.*="
    - from: "packages/core/src/enums/system.ts"
      to: "packages/daemon/src/services/kill-switch-service.ts"
      via: "KILL_SWITCH_STATES SSoT import"
      pattern: "KILL_SWITCH_STATES"
---

<objective>
KillSwitchService 3-state 상태 머신(ACTIVE/SUSPENDED/LOCKED)을 CAS ACID 패턴으로 구현하고, 기존 DB kill_switch_state 값을 마이그레이션한다.

Purpose: Kill Switch의 핵심 상태 관리 로직을 분리된 서비스로 구현. v0.10 CONC-03에서 확정된 CAS ACID 패턴(BEGIN IMMEDIATE + UPDATE WHERE state = expected)으로 동시성을 제어한다.
Output: KillSwitchService 클래스 + DB v14 마이그레이션 + 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@objectives/v1.6-desktop-telegram-docker.md
@packages/core/src/enums/system.ts
@packages/core/src/enums/audit.ts
@packages/core/src/enums/notification.ts
@packages/core/src/errors/error-codes.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/database/migrate.ts
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/middleware/kill-switch-guard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core 타입 업데이트 + KillSwitchService 3-state 상태 머신 + CAS ACID</name>
  <files>
    packages/core/src/enums/system.ts
    packages/core/src/enums/audit.ts
    packages/core/src/enums/notification.ts
    packages/core/src/errors/error-codes.ts
    packages/daemon/src/services/kill-switch-service.ts
    packages/daemon/src/__tests__/kill-switch-service.test.ts
  </files>
  <action>
1. `packages/core/src/enums/system.ts` 수정:
   - `KILL_SWITCH_STATES`를 `['ACTIVE', 'SUSPENDED', 'LOCKED'] as const`로 변경 (기존: `['NORMAL', 'ACTIVATED', 'RECOVERING']`)
   - KillSwitchState, KillSwitchStateEnum은 자동으로 갱신됨 (Zod SSoT)

2. `packages/core/src/enums/audit.ts` 수정:
   - AUDIT_ACTIONS에 `'KILL_SWITCH_RECOVERED'`, `'KILL_SWITCH_ESCALATED'` 추가 (기존 KILL_SWITCH_ACTIVATED 유지)

3. `packages/core/src/enums/notification.ts` 수정:
   - NOTIFICATION_EVENT_TYPES에 `'KILL_SWITCH_ESCALATED'` 추가 (KILL_SWITCH_ACTIVATED, KILL_SWITCH_RECOVERED 이미 존재)

4. `packages/core/src/errors/error-codes.ts` 수정:
   - `KILL_SWITCH_ALREADY_ACTIVE` 에러 추가: `{ code: 'KILL_SWITCH_ALREADY_ACTIVE', status: 409, message: 'Kill switch transition conflict' }`
   - `INVALID_STATE_TRANSITION` 에러 추가: `{ code: 'INVALID_STATE_TRANSITION', status: 409, message: 'Invalid kill switch state transition' }`
   - 기존 SYSTEM_LOCKED (status 503) 유지

5. `packages/daemon/src/services/kill-switch-service.ts` 생성:
   ```
   import type { Database } from 'better-sqlite3';
   import { KILL_SWITCH_STATES } from '@waiaas/core';

   export class KillSwitchService {
     private sqlite: Database;

     constructor(sqlite: Database) {
       this.sqlite = sqlite;
     }

     /** 현재 상태 조회 */
     getState(): { state: string; activatedAt: number | null; activatedBy: string | null } {
       // key_value_store에서 kill_switch_state, kill_switch_activated_at, kill_switch_activated_by 조회
       // 없으면 기본값 { state: 'ACTIVE', activatedAt: null, activatedBy: null }
     }

     /** ACTIVE -> SUSPENDED 전이 (Kill Switch 발동) */
     activate(activatedBy: string): boolean {
       // BEGIN IMMEDIATE
       // UPDATE key_value_store SET value = 'SUSPENDED' WHERE key = 'kill_switch_state' AND value = 'ACTIVE'
       // changes() === 0이면 CAS 실패 -> ROLLBACK, return false
       // UPSERT kill_switch_activated_at, kill_switch_activated_by
       // COMMIT
       // return true
     }

     /** SUSPENDED -> LOCKED 전이 (심각도 격상) */
     escalate(escalatedBy: string): boolean {
       // BEGIN IMMEDIATE
       // UPDATE ... WHERE value = 'SUSPENDED' -> SET value = 'LOCKED'
       // CAS 패턴 동일
     }

     /** SUSPENDED -> ACTIVE 전이 (복구) */
     recoverFromSuspended(): boolean {
       // BEGIN IMMEDIATE
       // UPDATE ... WHERE value = 'SUSPENDED' -> SET value = 'ACTIVE'
       // 성공 시 activated_at, activated_by 초기화
     }

     /** LOCKED -> ACTIVE 전이 (복구) */
     recoverFromLocked(): boolean {
       // BEGIN IMMEDIATE
       // UPDATE ... WHERE value = 'LOCKED' -> SET value = 'ACTIVE'
       // 성공 시 activated_at, activated_by 초기화
     }

     /** 초기 상태 설정 (데몬 시작 시 key가 없으면 ACTIVE 설정) */
     ensureInitialized(): void {
       // INSERT OR IGNORE INTO key_value_store (key, value, updated_at) VALUES ('kill_switch_state', 'ACTIVE', now)
     }
   }
   ```

   CAS ACID 패턴 핵심:
   - `sqlite.exec('BEGIN IMMEDIATE')` -- 즉시 EXCLUSIVE lock 획득
   - `const result = sqlite.prepare('UPDATE key_value_store SET value = ?, updated_at = ? WHERE key = ? AND value = ?').run(newState, now, 'kill_switch_state', expectedState)`
   - `if (result.changes === 0)` -> CAS 실패, ROLLBACK
   - 성공 시 activated_at/activated_by도 같은 트랜잭션에서 UPSERT
   - `sqlite.exec('COMMIT')`
   - 반드시 try/catch로 ROLLBACK 보장

6. `packages/daemon/src/__tests__/kill-switch-service.test.ts` 생성:
   - beforeEach에서 in-memory SQLite DB 생성, key_value_store 테이블 + kill_switch_state ACTIVE 초기화
   - getState() 테스트: 기본 ACTIVE 반환
   - activate() 성공 테스트: ACTIVE -> SUSPENDED, activatedAt/activatedBy 기록
   - activate() CAS 실패 테스트: 이미 SUSPENDED일 때 activate() -> false
   - escalate() 성공 테스트: SUSPENDED -> LOCKED
   - escalate() CAS 실패 테스트: ACTIVE일 때 escalate() -> false (잘못된 전이)
   - recoverFromSuspended() 성공/실패 테스트
   - recoverFromLocked() 성공/실패 테스트
   - 잘못된 전이 테스트: ACTIVE에서 직접 LOCKED 불가, LOCKED에서 직접 SUSPENDED 불가
   - 동시성 테스트: 두 activate() 호출 중 하나만 성공 (in-memory DB는 직렬이지만 CAS 로직 검증)
   - ensureInitialized() 테스트: 키가 없을 때 생성, 이미 있으면 무시
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/kill-switch-service.test.ts --reporter=verbose
  </verify>
  <done>
KillSwitchService가 4전이 CAS ACID 패턴으로 동작하고, 잘못된 전이가 거부되며, 동시 요청에서 하나만 성공하는 것이 테스트로 검증됨
  </done>
</task>

<task type="auto">
  <name>Task 2: DB v14 마이그레이션 (kill_switch_state 값 변환) + 마이그레이션 테스트</name>
  <files>
    packages/daemon/src/infrastructure/database/migrate.ts
    packages/daemon/src/__tests__/migration-v14.test.ts
  </files>
  <action>
1. `packages/daemon/src/infrastructure/database/migrate.ts` 수정:
   - `LATEST_SCHEMA_VERSION`을 14로 변경 (기존 13)
   - v14 마이그레이션 추가:
   ```
   MIGRATIONS.push({
     version: 14,
     description: 'Migrate kill_switch_state values: NORMAL->ACTIVE, ACTIVATED->SUSPENDED',
     up: (sqlite) => {
       // UPDATE key_value_store SET value = 'ACTIVE', updated_at = {now}
       //   WHERE key = 'kill_switch_state' AND value = 'NORMAL'
       sqlite.prepare(
         "UPDATE key_value_store SET value = 'ACTIVE', updated_at = ? WHERE key = 'kill_switch_state' AND value = 'NORMAL'"
       ).run(Math.floor(Date.now() / 1000));

       // UPDATE key_value_store SET value = 'SUSPENDED', updated_at = {now}
       //   WHERE key = 'kill_switch_state' AND value = 'ACTIVATED'
       sqlite.prepare(
         "UPDATE key_value_store SET value = 'SUSPENDED', updated_at = ? WHERE key = 'kill_switch_state' AND value = 'ACTIVATED'"
       ).run(Math.floor(Date.now() / 1000));

       // RECOVERING 상태도 ACTIVE로 변환 (v0.10 설계에서 제거)
       sqlite.prepare(
         "UPDATE key_value_store SET value = 'ACTIVE', updated_at = ? WHERE key = 'kill_switch_state' AND value = 'RECOVERING'"
       ).run(Math.floor(Date.now() / 1000));
     },
   });
   ```
   - 주의: 단순 UPDATE이므로 managesOwnTransaction 불필요 (기본 트랜잭션 래핑)

2. `packages/daemon/src/__tests__/migration-v14.test.ts` 생성:
   - in-memory SQLite DB에 v13까지의 스키마 생성 (pushSchema 활용 또는 수동 DDL)
   - key_value_store에 `kill_switch_state = 'NORMAL'` 삽입
   - v14 마이그레이션 실행
   - 결과 검증: value가 'ACTIVE'로 변환됨
   - ACTIVATED -> SUSPENDED 변환 테스트
   - RECOVERING -> ACTIVE 변환 테스트
   - 마이그레이션이 없는 경우 (키 없음) 에러 없이 통과 테스트
   - schema_version 테이블에 v14 기록 확인

3. 기존 migration-chain.test.ts 호환성 확인: v14가 추가되어도 체인 테스트가 통과하는지 확인 필요 (기존 테스트가 MIGRATIONS 배열을 전체 순회하므로 자동으로 포함됨)
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/migration-v14.test.ts src/__tests__/migration-chain.test.ts --reporter=verbose
  </verify>
  <done>
DB v14 마이그레이션이 NORMAL->ACTIVE, ACTIVATED->SUSPENDED, RECOVERING->ACTIVE로 기존 값을 변환하고, 마이그레이션 체인 테스트를 포함한 모든 테스트가 통과함
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core build` 성공 (enum 변경 반영)
2. KillSwitchService 테스트 전체 통과 (CAS ACID, 잘못된 전이, 동시성)
3. DB v14 마이그레이션 테스트 통과 (NORMAL->ACTIVE, ACTIVATED->SUSPENDED)
4. 마이그레이션 체인 테스트 통과 (v1~v14 전체 경로)
5. `pnpm --filter @waiaas/daemon exec vitest run` 전체 기존 테스트 통과
</verification>

<success_criteria>
- KILL-01: ACTIVE->SUSPENDED CAS ACID 전이 동작
- KILL-02: SUSPENDED->LOCKED CAS ACID 전이 동작
- KILL-06: 동시 요청 시 하나만 성공
- KILL-07: 잘못된 상태 전이 거부
- KILL-10: DB 마이그레이션 NORMAL->ACTIVE, ACTIVATED->SUSPENDED 완료
</success_criteria>

<output>
After completion, create `.planning/phases/140-event-bus-kill-switch/140-02-SUMMARY.md`
</output>
