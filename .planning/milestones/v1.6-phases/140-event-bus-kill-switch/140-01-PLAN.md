---
phase: 140-event-bus-kill-switch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/events/event-bus.ts
  - packages/core/src/events/event-types.ts
  - packages/core/src/events/index.ts
  - packages/core/src/index.ts
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/pipeline/sign-only.ts
  - packages/daemon/src/api/routes/x402.ts
  - packages/daemon/src/api/routes/sessions.ts
  - packages/daemon/src/api/routes/wallets.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/event-bus.test.ts
autonomous: true

must_haves:
  truths:
    - "EventEmitter 기반 이벤트 버스가 TransactionCompleted/TransactionFailed/WalletActivity 이벤트를 발행한다"
    - "기존 파이프라인 NotificationService.notify() 호출 지점에서 이벤트가 동시 발행된다"
    - "AutoStopService와 BalanceMonitorService가 구독할 수 있는 typed 이벤트 인터페이스가 존재한다"
  artifacts:
    - path: "packages/core/src/events/event-bus.ts"
      provides: "EventBus class (typed EventEmitter wrapper)"
      exports: ["EventBus"]
    - path: "packages/core/src/events/event-types.ts"
      provides: "Event type definitions (TransactionCompleted, TransactionFailed, WalletActivity)"
      exports: ["WaiaasEventMap", "TransactionCompletedEvent", "TransactionFailedEvent", "WalletActivityEvent"]
    - path: "packages/daemon/src/__tests__/event-bus.test.ts"
      provides: "EventBus unit tests"
  key_links:
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "packages/core/src/events/event-bus.ts"
      via: "ctx.eventBus?.emit()"
      pattern: "eventBus\\??\\.emit\\("
    - from: "packages/core/src/events/event-bus.ts"
      to: "packages/core/src/events/event-types.ts"
      via: "WaiaasEventMap generic"
      pattern: "WaiaasEventMap"
---

<objective>
EventEmitter 기반 이벤트 버스 인프라를 구축하고, 기존 파이프라인의 모든 NotificationService.notify() 호출 지점에서 이벤트를 동시 발행한다.

Purpose: Phase 141(AutoStop)과 Phase 142(BalanceMonitor)가 구독할 이벤트 버스 기반을 마련한다. 기존 알림 시스템은 유지하면서 병렬로 이벤트를 emit하여 하위 서비스들이 비동기 이벤트 기반으로 동작할 수 있게 한다.
Output: @waiaas/core에 EventBus + 이벤트 타입 정의, 파이프라인/라우트에서 이벤트 발행 코드
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@objectives/v1.6-desktop-telegram-docker.md
@packages/core/src/enums/notification.ts
@packages/core/src/index.ts
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/pipeline/sign-only.ts
@packages/daemon/src/api/routes/x402.ts
@packages/daemon/src/api/routes/sessions.ts
@packages/daemon/src/api/routes/wallets.ts
@packages/daemon/src/notifications/notification-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: @waiaas/core EventBus 인프라 + 이벤트 타입 정의</name>
  <files>
    packages/core/src/events/event-types.ts
    packages/core/src/events/event-bus.ts
    packages/core/src/events/index.ts
    packages/core/src/index.ts
    packages/daemon/src/__tests__/event-bus.test.ts
  </files>
  <action>
1. `packages/core/src/events/event-types.ts` 생성:
   - `TransactionCompletedEvent` 인터페이스: `{ walletId: string; txId: string; txHash: string; amount?: string; network?: string; type: string; timestamp: number }`
   - `TransactionFailedEvent` 인터페이스: `{ walletId: string; txId: string; error: string; network?: string; type: string; timestamp: number }`
   - `WalletActivityEvent` 인터페이스: `{ walletId: string; activity: 'TX_REQUESTED' | 'SESSION_CREATED' | 'OWNER_SET' | 'TX_SUBMITTED'; details?: Record<string, unknown>; timestamp: number }`
   - `WaiaasEventMap` 타입: `{ 'transaction:completed': TransactionCompletedEvent; 'transaction:failed': TransactionFailedEvent; 'wallet:activity': WalletActivityEvent }`

2. `packages/core/src/events/event-bus.ts` 생성:
   - Node.js EventEmitter 기반 typed wrapper 클래스 `EventBus`
   - `import { EventEmitter } from 'node:events';`
   - generic `on<K extends keyof WaiaasEventMap>(event: K, listener: (data: WaiaasEventMap[K]) => void): this`
   - generic `emit<K extends keyof WaiaasEventMap>(event: K, data: WaiaasEventMap[K]): boolean`
   - `removeAllListeners()` 메서드 expose (테스트 cleanup용)
   - 에러 핸들링: constructor에서 `this.emitter.on('error', (err) => console.error('[EventBus] listener error:', err))` 등록하여 unhandled rejection 방지
   - 리스너 내부 에러가 다른 리스너/파이프라인에 영향을 주지 않도록 emit 시 try/catch로 각 리스너 호출을 감싸는 것이 아닌, EventEmitter 기본 동작 + error 리스너로 처리 (Node.js EventEmitter는 동기 호출이므로 리스너 에러가 전파됨 -- 따라서 emit 메서드에서 try/catch wrapper를 추가하여 리스너 에러 격리)

3. `packages/core/src/events/index.ts` 생성: re-export all

4. `packages/core/src/index.ts` 수정: `export * from './events/index.js';` 추가

5. `packages/daemon/src/__tests__/event-bus.test.ts` 생성:
   - EventBus 생성 테스트
   - `transaction:completed` emit/on 테스트
   - `transaction:failed` emit/on 테스트
   - `wallet:activity` emit/on 테스트
   - 리스너 에러 격리 테스트 (하나의 리스너가 throw해도 다른 리스너는 호출됨)
   - removeAllListeners 테스트
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/event-bus.test.ts
  </verify>
  <done>
EventBus 클래스가 @waiaas/core에서 export되고, 3가지 이벤트 타입(transaction:completed, transaction:failed, wallet:activity)이 typed으로 정의되며, 리스너 에러 격리가 테스트로 검증됨
  </done>
</task>

<task type="auto">
  <name>Task 2: 파이프라인 + 라우트에서 EventBus 이벤트 동시 발행</name>
  <files>
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/pipeline/sign-only.ts
    packages/daemon/src/api/routes/x402.ts
    packages/daemon/src/api/routes/sessions.ts
    packages/daemon/src/api/routes/wallets.ts
    packages/daemon/src/lifecycle/daemon.ts
  </files>
  <action>
1. `PipelineContext` 인터페이스에 `eventBus?: EventBus` 필드 추가 (packages/daemon/src/pipeline/stages.ts)

2. 파이프라인 stages.ts 이벤트 발행 추가 -- 기존 notify() 호출 지점에서 동시 발행:
   - Stage 1 `TX_REQUESTED` notify 지점: `ctx.eventBus?.emit('wallet:activity', { walletId: ctx.walletId, activity: 'TX_REQUESTED', details: { txId: ctx.txId }, timestamp: Math.floor(Date.now() / 1000) })`
   - Stage 5 `TX_SUBMITTED` notify 지점: `ctx.eventBus?.emit('wallet:activity', { walletId: ctx.walletId, activity: 'TX_SUBMITTED', details: { txId: ctx.txId }, timestamp: Math.floor(Date.now() / 1000) })`
   - Stage 5 `TX_FAILED` notify 지점들(여러 곳): `ctx.eventBus?.emit('transaction:failed', { walletId: ctx.walletId, txId: ctx.txId, error: (에러메시지), network: ctx.resolvedNetwork, type: (request.type), timestamp: Math.floor(Date.now() / 1000) })`
   - Stage 6 `TX_CONFIRMED` notify 지점: `ctx.eventBus?.emit('transaction:completed', { walletId: ctx.walletId, txId: ctx.txId, txHash: (hash), amount: getRequestAmount(ctx.request), network: ctx.resolvedNetwork, type: (request.type), timestamp: Math.floor(Date.now() / 1000) })`
   - Stage 6 `TX_FAILED` notify 지점: `ctx.eventBus?.emit('transaction:failed', ...)` (확인 실패)

3. sign-only.ts 이벤트 발행 추가:
   - deps 인터페이스에 `eventBus?: EventBus` 추가
   - `TX_REQUESTED` 지점: `wallet:activity` emit
   - `TX_SUBMITTED` 지점: `wallet:activity` emit (sign-only는 완료 시 TX_SUBMITTED)

4. x402.ts 이벤트 발행 추가:
   - deps 인터페이스에 `eventBus?: EventBus` 추가
   - `TX_REQUESTED` 지점: `wallet:activity` emit
   - `TX_CONFIRMED` 지점: `transaction:completed` emit
   - `TX_FAILED` 지점들: `transaction:failed` emit

5. sessions.ts 이벤트 발행 추가:
   - deps 인터페이스에 `eventBus?: EventBus` 추가
   - `SESSION_CREATED` 지점: `wallet:activity` emit (activity: 'SESSION_CREATED')

6. wallets.ts 이벤트 발행 추가:
   - deps 인터페이스에 `eventBus?: EventBus` 추가
   - `OWNER_SET` 지점: `wallet:activity` emit (activity: 'OWNER_SET')

7. daemon.ts DaemonLifecycle에 EventBus 인스턴스 생성 + 종속성 주입:
   - `private eventBus: EventBus` 멤버 추가
   - constructor에서 `this.eventBus = new EventBus()` 생성
   - createApp() deps에 eventBus 전달
   - pipeline context 생성 시 eventBus 전달
   - sign-only deps에 eventBus 전달
   - shutdown 시 `this.eventBus.removeAllListeners()` 호출

주의: 기존 `void ctx.notificationService?.notify(...)` 호출은 그대로 유지. eventBus emit은 바로 아래에 추가. 둘 다 fire-and-forget 패턴이므로 파이프라인 흐름에 영향 없음.

주의: import 경로는 `@waiaas/core`에서 EventBus, WaiaasEventMap 등을 가져옴.
  </action>
  <verify>
cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core build && pnpm --filter @waiaas/daemon build && pnpm --filter @waiaas/daemon exec vitest run --reporter=verbose 2>&1 | tail -30
  </verify>
  <done>
모든 파이프라인 notify() 호출 지점에서 EventBus 이벤트가 동시 발행되고, DaemonLifecycle이 EventBus를 생성하여 종속성으로 주입하며, 기존 테스트가 모두 통과함
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core build` 성공 (EventBus export 확인)
2. `pnpm --filter @waiaas/daemon build` 성공 (파이프라인 이벤트 발행 코드 컴파일)
3. `pnpm --filter @waiaas/daemon exec vitest run` 전체 테스트 통과
4. EventBus 단위 테스트에서 3가지 이벤트 타입이 typed으로 emit/on 가능
5. 리스너 에러 격리 테스트 통과
</verification>

<success_criteria>
- EVNT-01: EventBus가 TransactionCompleted/TransactionFailed/WalletActivity 이벤트를 발행한다
- EVNT-02: 기존 파이프라인 notify() 호출 지점에서 이벤트가 동시 발행된다
- EVNT-03 준비: AutoStopService/BalanceMonitorService가 구독할 typed 인터페이스가 존재한다 (실제 구독은 Phase 141/142)
</success_criteria>

<output>
After completion, create `.planning/phases/140-event-bus-kill-switch/140-01-SUMMARY.md`
</output>
