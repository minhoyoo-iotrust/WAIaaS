---
phase: 144-admin-ui-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/pages/settings.tsx
  - packages/admin/src/__tests__/settings.test.tsx
autonomous: true

must_haves:
  truths:
    - "Admin UI Settings에서 AutoStop 카테고리(enabled, 연속 실패 임계값, 이상 활동 임계값/윈도우, 유휴 타임아웃, 유휴 체크 간격)를 조회/수정할 수 있다"
    - "Admin UI Settings에서 Balance Monitoring 카테고리(enabled, 체크 간격, SOL/ETH 잔액 임계값, 쿨다운 시간)를 조회/수정할 수 있다"
    - "AutoStop/Monitoring 설정 변경 시 기존 Settings Save/Discard 메커니즘이 동일하게 적용된다"
  artifacts:
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "AutoStopSettings + MonitoringSettings 섹션 컴포넌트"
      contains: "AutoStopSettings"
    - path: "packages/admin/src/__tests__/settings.test.tsx"
      provides: "AutoStop/Monitoring 섹션 렌더 + 필드 변경 테스트"
      contains: "AutoStop|Monitoring"
  key_links:
    - from: "packages/admin/src/pages/settings.tsx"
      to: "/v1/admin/settings"
      via: "apiGet/apiPut (GET 카테고리별 조회 + PUT 설정 업데이트)"
      pattern: "API\\.ADMIN_SETTINGS"
    - from: "packages/admin/src/pages/settings.tsx"
      to: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      via: "autostop.*/monitoring.* 키 매칭"
      pattern: "autostop\\.|monitoring\\."
---

<objective>
Admin UI Settings 페이지에 AutoStop 규칙 임계값과 Balance Monitoring 임계값 설정 섹션을 추가한다.

Purpose: AutoStop과 Balance Monitoring 설정을 Admin UI에서 런타임으로 조회/수정할 수 있게 하여 데몬 재시작 없이 임계값을 조정한다. (ADUI-03, ADUI-04)
Output: Settings 페이지에 AutoStop + Monitoring 카테고리 섹션 추가 + 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@packages/admin/src/pages/settings.tsx
@packages/admin/src/api/client.ts
@packages/admin/src/api/endpoints.ts
@packages/admin/src/components/form.tsx
@packages/admin/src/components/toast.tsx
@packages/admin/src/__tests__/settings.test.tsx
@packages/daemon/src/infrastructure/settings/setting-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AutoStop Settings 섹션 추가</name>
  <files>
    packages/admin/src/pages/settings.tsx
  </files>
  <action>
Settings 페이지에 `AutoStopSettings` 서브 컴포넌트를 추가한다. 기존 `SecuritySettings` 패턴을 따른다.

**keyToLabel 맵에 AutoStop 키 추가:**
```typescript
// autostop keys
enabled: 'Enabled',                         // (이미 존재 -- 중복 무시)
consecutive_failures_threshold: 'Consecutive Failures Threshold',
unusual_activity_threshold: 'Unusual Activity Threshold',
unusual_activity_window_sec: 'Unusual Activity Window (seconds)',
idle_timeout_sec: 'Idle Timeout (seconds)',
idle_check_interval_sec: 'Idle Check Interval (seconds)',
```

**AutoStopSettings 컴포넌트 구현:**

```tsx
function AutoStopSettings() {
  const fields: { key: string; type: 'number' | 'checkbox'; min?: number; max?: number }[] = [
    { key: 'enabled', type: 'checkbox' },
    { key: 'consecutive_failures_threshold', type: 'number', min: 1, max: 100 },
    { key: 'unusual_activity_threshold', type: 'number', min: 5, max: 1000 },
    { key: 'unusual_activity_window_sec', type: 'number', min: 60, max: 86400 },
    { key: 'idle_timeout_sec', type: 'number', min: 60, max: 604800 },
    { key: 'idle_check_interval_sec', type: 'number', min: 10, max: 3600 },
  ];

  return (
    <div class="settings-category">
      <div class="settings-category-header">
        <h3>AutoStop Rules</h3>
        <p class="settings-description">
          Automatic protection rules that suspend wallets or trigger Kill Switch on anomalies.
          Changes apply immediately without daemon restart.
        </p>
      </div>
      <div class="settings-category-body">
        <div class="settings-fields-grid">
          {fields.map((f) =>
            f.type === 'checkbox' ? (
              <div class="settings-field-full" key={f.key}>
                <FormField
                  label={keyToLabel(f.key)}
                  name={`autostop.${f.key}`}
                  type="checkbox"
                  value={getEffectiveBoolValue('autostop', f.key)}
                  onChange={(v) => handleFieldChange(`autostop.${f.key}`, v)}
                />
              </div>
            ) : (
              <FormField
                key={f.key}
                label={keyToLabel(f.key)}
                name={`autostop.${f.key}`}
                type="number"
                value={Number(getEffectiveValue('autostop', f.key)) || 0}
                onChange={(v) => handleFieldChange(`autostop.${f.key}`, v)}
                min={f.min}
                max={f.max}
              />
            ),
          )}
        </div>
        <div class="settings-info-box">
          <strong>Consecutive Failures:</strong> Suspends wallet after N consecutive failed transactions.<br />
          <strong>Unusual Activity:</strong> Suspends wallet if transaction count exceeds threshold within the time window.<br />
          <strong>Idle Timeout:</strong> Revokes sessions with no activity for the configured duration.
        </div>
      </div>
    </div>
  );
}
```

**렌더 위치**: 메인 렌더에서 기존 카테고리 섹션 뒤에 배치한다. 순서: NotificationSettings -> RpcSettings -> SecuritySettings -> WalletConnectSettings -> DaemonSettings -> DisplaySettings -> ApiKeysSection -> **AutoStopSettings** -> **MonitoringSettings** -> KillSwitchSection -> JWT Rotation -> Danger Zone.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin build` -- 빌드 성공 (TSX 컴파일 정상).
  </verify>
  <done>
Settings 페이지에 AutoStop Rules 카테고리 섹션이 표시되고, enabled 토글 + 5개 숫자 필드(consecutive_failures_threshold, unusual_activity_threshold, unusual_activity_window_sec, idle_timeout_sec, idle_check_interval_sec)가 조회/수정 가능하며, 기존 Save/Discard 메커니즘으로 저장된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: Balance Monitoring Settings 섹션 + 통합 테스트</name>
  <files>
    packages/admin/src/pages/settings.tsx
    packages/admin/src/__tests__/settings.test.tsx
  </files>
  <action>
**1. Settings 페이지에 `MonitoringSettings` 서브 컴포넌트 추가:**

**keyToLabel 맵에 Monitoring 키 추가:**
```typescript
// monitoring keys
check_interval_sec: 'Check Interval (seconds)',
low_balance_threshold_sol: 'Low Balance Threshold (SOL)',
low_balance_threshold_eth: 'Low Balance Threshold (ETH)',
cooldown_hours: 'Alert Cooldown (hours)',
```

**MonitoringSettings 컴포넌트 구현:**

```tsx
function MonitoringSettings() {
  const fields: { key: string; type: 'number' | 'checkbox'; min?: number; max?: number; step?: string }[] = [
    { key: 'enabled', type: 'checkbox' },
    { key: 'check_interval_sec', type: 'number', min: 60, max: 86400 },
    { key: 'low_balance_threshold_sol', type: 'number', min: 0 },
    { key: 'low_balance_threshold_eth', type: 'number', min: 0 },
    { key: 'cooldown_hours', type: 'number', min: 1, max: 168 },
  ];

  return (
    <div class="settings-category">
      <div class="settings-category-header">
        <h3>Balance Monitoring</h3>
        <p class="settings-description">
          Periodic balance checks for all active wallets. Sends LOW_BALANCE alerts when
          native token balance drops below thresholds. Changes apply immediately.
        </p>
      </div>
      <div class="settings-category-body">
        <div class="settings-fields-grid">
          {fields.map((f) =>
            f.type === 'checkbox' ? (
              <div class="settings-field-full" key={f.key}>
                <FormField
                  label={keyToLabel(f.key)}
                  name={`monitoring.${f.key}`}
                  type="checkbox"
                  value={getEffectiveBoolValue('monitoring', f.key)}
                  onChange={(v) => handleFieldChange(`monitoring.${f.key}`, v)}
                />
              </div>
            ) : (
              <FormField
                key={f.key}
                label={keyToLabel(f.key)}
                name={`monitoring.${f.key}`}
                type="number"
                value={Number(getEffectiveValue('monitoring', f.key)) || 0}
                onChange={(v) => handleFieldChange(`monitoring.${f.key}`, v)}
                min={f.min}
                max={f.max}
              />
            ),
          )}
        </div>
        <div class="settings-info-box">
          Monitors all active wallet native token balances (SOL, ETH) at the configured interval.
          When balance drops below threshold, a LOW_BALANCE notification is sent.
          Duplicate alerts are suppressed for the cooldown period (per wallet).
        </div>
      </div>
    </div>
  );
}
```

**렌더 위치**: AutoStopSettings 뒤에 배치 (AutoStopSettings -> MonitoringSettings -> KillSwitchSection).

**2. packages/admin/src/__tests__/settings.test.tsx**에 테스트 추가:

기존 Settings 테스트 파일에 AutoStop + Monitoring 관련 테스트를 추가한다.

Mock 데이터 확장 -- apiGet mock이 반환하는 settings 객체에 `autostop`과 `monitoring` 카테고리를 추가:
```typescript
const mockSettings = {
  notifications: { enabled: 'true', /* ... */ },
  rpc: { /* ... */ },
  security: { /* ... */ },
  // ... 기존 카테고리
  autostop: {
    enabled: 'true',
    consecutive_failures_threshold: '5',
    unusual_activity_threshold: '20',
    unusual_activity_window_sec: '300',
    idle_timeout_sec: '3600',
    idle_check_interval_sec: '60',
  },
  monitoring: {
    enabled: 'true',
    check_interval_sec: '300',
    low_balance_threshold_sol: '0.01',
    low_balance_threshold_eth: '0.005',
    cooldown_hours: '24',
  },
};
```

테스트 케이스:
1. **AutoStop 섹션 렌더**: Settings 페이지 렌더 후 "AutoStop Rules" 헤딩이 표시되는지 확인
2. **AutoStop 필드 표시**: "Consecutive Failures Threshold" 라벨이 렌더되는지 확인
3. **Monitoring 섹션 렌더**: "Balance Monitoring" 헤딩이 표시되는지 확인
4. **Monitoring 필드 표시**: "Low Balance Threshold (SOL)" 라벨이 렌더되는지 확인
5. **필드 변경 -> dirty**: AutoStop 필드 값 변경 -> Save 바 "1 unsaved change" 표시 확인
6. **Save 동작**: dirty 상태에서 Save 클릭 -> apiPut('/v1/admin/settings', ...) 호출 확인 + body에 `autostop.*` 또는 `monitoring.*` 키 포함
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin test -- --run` -- 전체 통과 (AutoStop/Monitoring 테스트 포함).
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin build` -- 빌드 성공.
  </verify>
  <done>
Settings 페이지에 AutoStop Rules 카테고리(enabled + 5 필드)와 Balance Monitoring 카테고리(enabled + 4 필드)가 표시되고, 값 변경 시 기존 Save/Discard 메커니즘으로 저장된다. 6개 테스트 통과.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin build` 성공
2. `pnpm --filter @waiaas/admin test -- --run` 전체 통과
3. Settings 페이지에 AutoStop Rules 섹션이 표시되고, 6개 필드(enabled + 5개 숫자)가 조회/수정 가능
4. Settings 페이지에 Balance Monitoring 섹션이 표시되고, 5개 필드(enabled + 4개 숫자)가 조회/수정 가능
5. Save 클릭 시 autostop.*/monitoring.* 키가 PUT /v1/admin/settings로 전송됨
</verification>

<success_criteria>
- AutoStop 규칙 임계값(연속 실패, 이상 활동, 유휴 타임아웃)이 Admin UI Settings에서 조회/수정 가능하다 (ADUI-03)
- 잔액 모니터링 임계값(SOL/ETH 임계값, 체크 간격, 쿨다운)이 Admin UI Settings에서 조회/수정 가능하다 (ADUI-04)
- 모든 Admin UI 테스트가 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/144-admin-ui-integration/144-02-SUMMARY.md`
</output>
