---
phase: 141-autostop-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/services/autostop-service.ts
  - packages/daemon/src/services/autostop-rules.ts
  - packages/daemon/src/__tests__/autostop-service.test.ts
autonomous: true

must_haves:
  truths:
    - "5회 연속 트랜잭션 실패 이벤트가 동일 월렛에서 발생하면 해당 월렛이 SUSPENDED 상태가 된다"
    - "정상 패턴 대비 이상 빈도 거래가 감지되면 해당 월렛이 SUSPENDED 상태가 된다"
    - "설정 시간 이상 유휴 상태인 세션이 자동 해지(revoked_at 설정)된다"
    - "MANUAL_TRIGGER 호출 시 KillSwitchService.activateWithCascade()가 실행된다"
    - "규칙 트리거 후 연속 실패 카운터가 리셋되어 동일 월렛에서 다시 5회 연속 실패해야 재트리거된다"
  artifacts:
    - path: "packages/daemon/src/services/autostop-service.ts"
      provides: "AutoStopService 클래스 (4 규칙 + EventBus 구독)"
      exports: ["AutoStopService"]
    - path: "packages/daemon/src/services/autostop-rules.ts"
      provides: "개별 규칙 로직 (ConsecutiveFailures, UnusualActivity, IdleTimeout)"
      exports: ["ConsecutiveFailuresRule", "UnusualActivityRule", "IdleTimeoutRule"]
    - path: "packages/daemon/src/__tests__/autostop-service.test.ts"
      provides: "AutoStopService 단위 테스트"
  key_links:
    - from: "packages/daemon/src/services/autostop-service.ts"
      to: "packages/core/src/events/event-bus.ts"
      via: "eventBus.on('transaction:failed', ...) 구독"
      pattern: "eventBus\\.on\\('transaction:failed'"
    - from: "packages/daemon/src/services/autostop-service.ts"
      to: "packages/daemon/src/services/kill-switch-service.ts"
      via: "MANUAL_TRIGGER에서 killSwitchService.activateWithCascade() 호출"
      pattern: "killSwitchService\\.activateWithCascade"
    - from: "packages/daemon/src/services/autostop-service.ts"
      to: "SQLite wallets/sessions 테이블"
      via: "better-sqlite3 직접 SQL로 월렛 SUSPENDED 전환 및 세션 revoke"
      pattern: "UPDATE wallets SET status.*SUSPENDED|UPDATE sessions SET revoked_at"
---

<objective>
AutoStopService 4 규칙 엔진 구현 + EventBus 이벤트 구독

Purpose: 이상 상황(연속 실패, 이상 빈도, 유휴 타임아웃)이 감지되면 자동으로 월렛을 정지하거나 Kill Switch를 발동하여 피해를 최소화한다. AUTO-01, AUTO-02, AUTO-03, AUTO-04 요구사항을 충족한다.

Output: AutoStopService 클래스 + 개별 규칙 구현 + 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md (AUTO-01 ~ AUTO-06)

# Phase 140 결과물 (EventBus + KillSwitchService)
@packages/core/src/events/event-bus.ts
@packages/core/src/events/event-types.ts
@packages/daemon/src/services/kill-switch-service.ts
@.planning/phases/140-event-bus-kill-switch/140-01-SUMMARY.md
@.planning/phases/140-event-bus-kill-switch/140-03-SUMMARY.md

# 기존 패턴 참조 (월렛 정지, 세션 해지)
@packages/daemon/src/infrastructure/database/schema.ts (wallets, sessions 테이블)
</context>

<tasks>

<task type="auto">
  <name>Task 1: autostop-rules.ts 개별 규칙 구현 + autostop-service.ts AutoStopService 핵심 로직</name>
  <files>
    packages/daemon/src/services/autostop-rules.ts
    packages/daemon/src/services/autostop-service.ts
  </files>
  <action>
**autostop-rules.ts -- 3개 규칙 클래스 (MANUAL_TRIGGER는 서비스에서 직접 처리)**

1. `ConsecutiveFailuresRule`:
   - 인메모리 Map<walletId, number> failureCounts 관리
   - `onTransactionFailed(walletId)`: failureCounts[walletId]++ 후 threshold 이상이면 `{ triggered: true, walletId }` 반환
   - `onTransactionCompleted(walletId)`: failureCounts[walletId] = 0 (성공 시 리셋)
   - `resetWallet(walletId)`: failureCounts.delete(walletId) -- 트리거 후 리셋용
   - threshold는 constructor에서 주입 (기본값 5)

2. `UnusualActivityRule`:
   - 인메모리 Map<walletId, number[]> activityTimestamps (슬라이딩 윈도우)
   - `onWalletActivity(walletId, timestamp)`: 윈도우(기본 300초=5분) 내 타임스탬프 기록
   - 윈도우 내 활동 수가 threshold(기본 20회/5분) 이상이면 `{ triggered: true, walletId }` 반환
   - 오래된 타임스탬프는 슬라이딩 윈도우에서 자동 제거
   - threshold, windowSec은 constructor에서 주입

3. `IdleTimeoutRule`:
   - 인메모리 Map<walletId, Map<sessionId, number>> lastActivity (월렛별 세션 마지막 활동 시간)
   - `onWalletActivity(walletId, details?)`: details?.sessionId가 있으면 해당 세션 lastActivity 갱신, 없으면 월렛 전체 갱신
   - `checkIdle(nowSec)`: 모든 월렛의 모든 세션에 대해 (nowSec - lastActivity) > idleTimeoutSec인 세션 목록 반환: `Array<{ walletId, sessionId }>`
   - `registerSession(walletId, sessionId, nowSec)`: 세션 생성 시 등록 (SESSION_CREATED 이벤트에서)
   - `removeSession(walletId, sessionId)`: 세션 해지 후 정리
   - idleTimeoutSec는 constructor에서 주입 (기본 3600 = 1시간)

각 규칙 클래스는 export한다. 외부 의존성 없음(순수 인메모리 로직).

**autostop-service.ts -- AutoStopService 클래스**

```typescript
import type { Database } from 'better-sqlite3';
import type { EventBus } from '@waiaas/core';
import type { KillSwitchService } from './kill-switch-service.js';
import type { NotificationService } from '../notifications/notification-service.js';
import { ConsecutiveFailuresRule, UnusualActivityRule, IdleTimeoutRule } from './autostop-rules.js';
```

Constructor:
```typescript
constructor(opts: {
  sqlite: Database;
  eventBus: EventBus;
  killSwitchService: KillSwitchService;
  notificationService?: NotificationService;
  config: AutoStopConfig;
})
```

`AutoStopConfig` interface:
```typescript
interface AutoStopConfig {
  consecutiveFailuresThreshold: number;  // 기본 5
  unusualActivityThreshold: number;      // 기본 20
  unusualActivityWindowSec: number;      // 기본 300
  idleTimeoutSec: number;               // 기본 3600
  idleCheckIntervalSec: number;         // 기본 60
  enabled: boolean;                      // 기본 true
}
```

`start()` 메서드 -- EventBus 이벤트 구독 등록:
- `eventBus.on('transaction:failed', ...)` -> ConsecutiveFailuresRule.onTransactionFailed() -> 트리거 시 suspendWallet(walletId, 'CONSECUTIVE_FAILURES') + 알림
- `eventBus.on('transaction:completed', ...)` -> ConsecutiveFailuresRule.onTransactionCompleted() (성공 시 리셋)
- `eventBus.on('wallet:activity', ...)` -> UnusualActivityRule.onWalletActivity() -> 트리거 시 suspendWallet(walletId, 'UNUSUAL_ACTIVITY') + 알림
- `eventBus.on('wallet:activity', ...)` -> IdleTimeoutRule 세션 등록/갱신 (activity가 'SESSION_CREATED'이면 registerSession, 그 외 lastActivity 갱신)
- 유휴 세션 체크는 setInterval(idleCheckIntervalSec * 1000)으로 주기적 실행: IdleTimeoutRule.checkIdle() 반환 세션들 revoke + 알림

`stop()` 메서드:
- clearInterval(idle check timer)
- eventBus.removeAllListeners는 하지 않음 (EventBus는 공유 자원, 다른 서비스도 사용)

`manualTrigger(triggeredBy: string)` 메서드 (AUTO-04):
- killSwitchService.activateWithCascade(triggeredBy) 호출
- AUTOSTOP_TRIGGERED 알림 발송 (reason: 'MANUAL_TRIGGER')

`suspendWallet(walletId, reason)` private 메서드:
- better-sqlite3 직접 SQL: `UPDATE wallets SET status = 'SUSPENDED', suspended_at = ?, suspension_reason = ? WHERE id = ? AND status = 'ACTIVE'`
- 성공 시 ConsecutiveFailuresRule.resetWallet(walletId) (재트리거 방지)
- AUTOSTOP_TRIGGERED 알림 발송: `notificationService?.notify('AUTO_STOP_TRIGGERED', walletId, { reason, walletId })`
- audit_log INSERT: eventType='AUTO_STOP_TRIGGERED', actor='autostop', severity='warning'

`revokeSession(walletId, sessionId)` private 메서드:
- better-sqlite3 직접 SQL: `UPDATE sessions SET revoked_at = ? WHERE id = ? AND wallet_id = ? AND revoked_at IS NULL`
- IdleTimeoutRule.removeSession(walletId, sessionId)

`updateConfig(config: Partial<AutoStopConfig>)` 메서드 -- 런타임 설정 변경용:
- 규칙별 threshold 업데이트 (각 규칙 클래스에 updateThreshold() 메서드 추가)
- idleCheckInterval 변경 시 clearInterval + 새 setInterval

`getStatus()` 메서드 -- 디버깅/모니터링용:
- 각 규칙의 현재 상태 반환 (failureCounts 크기, activity 윈도우 크기, tracked sessions 수)

**중요 설계 결정:**
- better-sqlite3 `Database` 직접 사용 (KillSwitchService와 동일 패턴, Drizzle ORM 불필요)
- 월렛 정지는 `WHERE status = 'ACTIVE'` 조건 포함 (이미 정지된 월렛 중복 정지 방지)
- 알림은 fire-and-forget (void this.notificationService?.notify(...))
- MANUAL_TRIGGER는 Kill Switch 전체 발동, 나머지 3규칙은 개별 월렛 정지
  </action>
  <verify>
`pnpm --filter @waiaas/daemon build` 성공 (TypeScript 컴파일)
  </verify>
  <done>
autostop-rules.ts에 ConsecutiveFailuresRule, UnusualActivityRule, IdleTimeoutRule 3개 규칙 클래스가 구현되고, autostop-service.ts에 AutoStopService가 EventBus 구독 + 4개 규칙(CONSECUTIVE_FAILURES, UNUSUAL_ACTIVITY, IDLE_TIMEOUT, MANUAL_TRIGGER) + 월렛 정지/세션 해지 로직을 포함하여 빌드가 성공한다
  </done>
</task>

<task type="auto">
  <name>Task 2: AutoStopService 단위 테스트 (4 규칙 + 이벤트 구독 + 월렛 정지)</name>
  <files>
    packages/daemon/src/__tests__/autostop-service.test.ts
  </files>
  <action>
vitest 테스트 파일 `packages/daemon/src/__tests__/autostop-service.test.ts` 생성.

**테스트 셋업:**
- better-sqlite3 in-memory DB (`:memory:`)
- 필요한 테이블 생성: wallets (id, name, chain, network, public_key, status, created_at, updated_at, suspended_at, suspension_reason), sessions (id, wallet_id, token, created_at, expires_at, revoked_at), audit_log (timestamp, event_type, actor, details, severity), key_value_store (key, value, updated_at)
- EventBus 실제 인스턴스 사용 (mock 불필요 -- EventBus는 가볍다)
- KillSwitchService 실제 인스턴스 (sqlite 주입)
- NotificationService는 vi.fn() mock (notify 호출 추적용)

**테스트 케이스:**

describe('ConsecutiveFailuresRule')
1. "5회 연속 transaction:failed -> 월렛 SUSPENDED" -- 5번 emit transaction:failed 동일 walletId -> DB 확인 status='SUSPENDED'
2. "4회 실패 + 1회 성공 + 4회 실패 -> 정지 안 됨" -- 성공이 카운터 리셋 확인
3. "5회 실패 -> 정지 후 카운터 리셋 -> 다시 5회 실패 필요" -- 트리거 후 리셋 확인
4. "서로 다른 월렛 실패 -> 각자 독립 카운팅" -- walletA 3회 + walletB 5회 -> walletB만 정지

describe('UnusualActivityRule')
5. "윈도우 내 20회 이상 활동 -> 월렛 SUSPENDED" -- 빠르게 20회 wallet:activity 발행 -> 월렛 정지
6. "윈도우 밖 활동은 카운트 안 됨" -- 과거 타임스탬프로 활동 기록 후 현재 활동 -> 트리거 안 됨
7. "이상 활동 감지 시 AUTOSTOP_TRIGGERED 알림 발송" -- notificationService.notify 호출 확인

describe('IdleTimeoutRule')
8. "유휴 타임아웃 초과 세션 자동 해지" -- 세션 등록 후 idleCheckIntervalSec 경과 시뮬레이션 -> checkIdle 호출 -> DB sessions.revoked_at 설정 확인
9. "활동 있는 세션은 해지 안 됨" -- 마지막 활동이 최근이면 해지 안 됨

describe('ManualTrigger')
10. "manualTrigger 호출 -> KillSwitchService.activateWithCascade() 실행" -- service.manualTrigger('admin') 호출 -> KillSwitchService 상태 SUSPENDED 확인
11. "manualTrigger 시 AUTOSTOP_TRIGGERED 알림 발송" -- notificationService.notify 호출 확인

describe('EventBus integration')
12. "start() 후 EventBus 리스너 등록 확인" -- eventBus.listenerCount 확인
13. "stop() 후 idle check timer 정리" -- stop() 호출 후 setInterval 해제 확인 (vi.useFakeTimers 활용)

describe('suspendWallet')
14. "이미 SUSPENDED인 월렛 중복 정지 방지" -- 이미 SUSPENDED인 월렛에 suspendWallet -> affected rows=0 확인, 알림 미발송
15. "정지 시 audit_log에 기록" -- suspendWallet 호출 후 audit_log 테이블에 AUTO_STOP_TRIGGERED 레코드 확인

describe('updateConfig')
16. "런타임 threshold 변경 후 새 threshold 적용" -- updateConfig({ consecutiveFailuresThreshold: 3 }) 후 3회 실패 -> 월렛 정지

**IdleTimeout 타이머 테스트 주의사항:**
- `vi.useFakeTimers()` / `vi.advanceTimersByTime()` 사용
- setInterval 콜백이 checkIdle()을 호출하는 것 확인
- afterEach에서 `vi.useRealTimers()` 복원

**NotificationService mock 패턴:**
```typescript
const mockNotify = vi.fn().mockResolvedValue(undefined);
const mockNotificationService = { notify: mockNotify } as unknown as NotificationService;
```
  </action>
  <verify>
`pnpm --filter @waiaas/daemon test -- --reporter=verbose autostop-service` 실행하여 모든 테스트 통과
  </verify>
  <done>
16개 이상 테스트가 통과하여 4 규칙(CONSECUTIVE_FAILURES 5회 연속 정지, UNUSUAL_ACTIVITY 이상 빈도 정지, IDLE_TIMEOUT 유휴 세션 해지, MANUAL_TRIGGER Kill Switch 발동)이 정상 동작하고, 월렛 정지/세션 해지가 DB에 반영되며, 알림이 발송되는 것이 검증된다
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon build` -- TypeScript 컴파일 성공
2. `pnpm --filter @waiaas/daemon test -- --reporter=verbose autostop-service` -- 모든 단위 테스트 통과
3. autostop-service.ts에서 EventBus 구독 코드 확인: `eventBus.on('transaction:failed', ...)` 패턴 존재
4. autostop-service.ts에서 KillSwitchService 호출 코드 확인: `killSwitchService.activateWithCascade(...)` 패턴 존재
5. autostop-service.ts에서 월렛 정지 SQL 확인: `UPDATE wallets SET status = 'SUSPENDED'` 패턴 존재
</verification>

<success_criteria>
- AutoStopService가 EventBus의 transaction:failed, transaction:completed, wallet:activity 이벤트를 구독한다
- ConsecutiveFailuresRule이 5회(기본값) 연속 실패 시 월렛을 자동 SUSPENDED로 전환한다
- UnusualActivityRule이 슬라이딩 윈도우 내 이상 빈도 활동 감지 시 월렛을 정지한다
- IdleTimeoutRule이 설정 시간 이상 유휴 세션을 자동 해지한다
- MANUAL_TRIGGER가 KillSwitchService.activateWithCascade()를 호출한다
- 모든 규칙 트리거 시 AUTOSTOP_TRIGGERED 알림이 발송된다
- 16개 이상 단위 테스트가 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/141-autostop-engine/141-01-SUMMARY.md`
</output>
