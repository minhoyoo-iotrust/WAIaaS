---
phase: 142-balance-monitoring
plan: 02
type: execute
wave: 2
depends_on: ["142-01"]
files_modified:
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/infrastructure/settings/hot-reload.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/balance-monitor-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "잔액 모니터링 임계값이 config.toml security 섹션 flat key로 관리된다"
    - "Admin Settings에서 monitoring 카테고리로 임계값을 런타임 오버라이드할 수 있다"
    - "DaemonLifecycle에서 BalanceMonitorService가 초기화/시작/종료된다"
    - "HotReloadOrchestrator가 monitoring 키 변경 시 BalanceMonitorService.updateConfig()을 호출한다"
  artifacts:
    - path: "packages/daemon/src/infrastructure/config/loader.ts"
      provides: "monitoring_* config.toml flat key 5개"
      contains: "monitoring_check_interval_sec"
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "monitoring 카테고리 SETTING_DEFINITIONS 5개"
      contains: "monitoring"
    - path: "packages/daemon/src/infrastructure/settings/hot-reload.ts"
      provides: "reloadBalanceMonitor 핫 리로드 핸들러"
      contains: "reloadBalanceMonitor"
    - path: "packages/daemon/src/lifecycle/daemon.ts"
      provides: "Step 4c-4 BalanceMonitorService 초기화"
      contains: "BalanceMonitorService"
    - path: "packages/daemon/src/__tests__/balance-monitor-integration.test.ts"
      provides: "통합 테스트"
      min_lines: 80
  key_links:
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/services/monitoring/balance-monitor-service.ts"
      via: "new BalanceMonitorService({...}) + start() + stop()"
      pattern: "new BalanceMonitorService"
    - from: "packages/daemon/src/infrastructure/settings/hot-reload.ts"
      to: "packages/daemon/src/services/monitoring/balance-monitor-service.ts"
      via: "balanceMonitorService.updateConfig()"
      pattern: "balanceMonitorService.*updateConfig"
    - from: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      to: "packages/daemon/src/infrastructure/config/loader.ts"
      via: "configPath: 'security.monitoring_*'"
      pattern: "security\\.monitoring_"
---

<objective>
잔액 모니터링 설정 관리 + DaemonLifecycle 통합

Purpose: BalanceMonitorService의 임계값과 체크 주기를 config.toml flat key + Admin Settings 런타임 오버라이드로 관리하고, DaemonLifecycle에 통합하여 데몬 시작/종료 시 자동으로 잔액 모니터링이 동작하도록 한다.
Output: config.toml monitoring_* flat key 5개, SETTING_DEFINITIONS monitoring 카테고리, HotReloadOrchestrator 통합, DaemonLifecycle Step 4c-4, 통합 테스트
</objective>

<execution_context>
@.planning/phases/142-balance-monitoring/142-02-PLAN.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md (BMON-05)
@.planning/phases/141-autostop-engine/141-02-SUMMARY.md
@.planning/phases/142-balance-monitoring/142-01-SUMMARY.md

@packages/daemon/src/infrastructure/config/loader.ts (DaemonConfigSchema)
@packages/daemon/src/infrastructure/settings/setting-keys.ts (SETTING_DEFINITIONS 패턴)
@packages/daemon/src/infrastructure/settings/hot-reload.ts (HotReloadOrchestrator 패턴 -- reloadAutoStop 참조)
@packages/daemon/src/lifecycle/daemon.ts (Step 4c-3 AutoStop 패턴)
@packages/daemon/src/__tests__/autostop-integration.test.ts (통합 테스트 패턴)
</context>

<tasks>

<task type="auto">
  <name>Task 1: config.toml monitoring flat key + Admin Settings + HotReload</name>
  <files>
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/infrastructure/settings/hot-reload.ts
  </files>
  <action>
**1. DaemonConfigSchema에 monitoring flat key 추가** (`packages/daemon/src/infrastructure/config/loader.ts`):

security 섹션에 autostop 키 바로 다음에 추가 (CLAUDE.md flat key 규칙 준수):

```typescript
// Balance monitoring thresholds (BMON-05 runtime-overridable via Admin Settings)
monitoring_check_interval_sec: z.number().int().min(60).max(3600).default(300),
monitoring_low_balance_threshold_sol: z.number().min(0.001).max(100).default(0.01),
monitoring_low_balance_threshold_eth: z.number().min(0.0001).max(10).default(0.005),
monitoring_cooldown_hours: z.number().int().min(1).max(168).default(24),
monitoring_enabled: z.boolean().default(true),
```

주의: monitoring_low_balance_threshold_sol/eth는 z.number() (int가 아님 -- 소수점 허용).

**2. SETTING_DEFINITIONS에 monitoring 카테고리 추가** (`packages/daemon/src/infrastructure/settings/setting-keys.ts`):

SETTING_CATEGORIES 배열에 `'monitoring'` 추가 (autostop 다음).

SETTING_DEFINITIONS 배열 끝(autostop 다음)에 5개 키 추가:

```typescript
// --- monitoring category (BMON-05 runtime-overridable) ---
{ key: 'monitoring.check_interval_sec', category: 'monitoring', configPath: 'security.monitoring_check_interval_sec', defaultValue: '300', isCredential: false },
{ key: 'monitoring.low_balance_threshold_sol', category: 'monitoring', configPath: 'security.monitoring_low_balance_threshold_sol', defaultValue: '0.01', isCredential: false },
{ key: 'monitoring.low_balance_threshold_eth', category: 'monitoring', configPath: 'security.monitoring_low_balance_threshold_eth', defaultValue: '0.005', isCredential: false },
{ key: 'monitoring.cooldown_hours', category: 'monitoring', configPath: 'security.monitoring_cooldown_hours', defaultValue: '24', isCredential: false },
{ key: 'monitoring.enabled', category: 'monitoring', configPath: 'security.monitoring_enabled', defaultValue: 'true', isCredential: false },
```

패턴: autostop 키가 `security.autostop_*` configPath를 사용하는 것과 동일하게, monitoring 키도 `security.monitoring_*` configPath를 사용한다. Admin Settings에서는 별도 `monitoring` 카테고리로 표시된다.

**3. HotReloadOrchestrator에 monitoring 핸들러 추가** (`packages/daemon/src/infrastructure/settings/hot-reload.ts`):

autostop 패턴과 동일하게 synchronous 처리:

a. `HotReloadDeps` 인터페이스에 추가:
```typescript
balanceMonitorService?: BalanceMonitorService | null;
```

b. import 추가:
```typescript
import type { BalanceMonitorService, BalanceMonitorConfig } from '../../services/monitoring/balance-monitor-service.js';
```

c. `MONITORING_KEYS_PREFIX` 상수 추가:
```typescript
const MONITORING_KEYS_PREFIX = 'monitoring.';
```

d. `handleChangedKeys()`에 monitoring 감지 추가:
```typescript
const hasMonitoringChanges = changedKeys.some((k) => k.startsWith(MONITORING_KEYS_PREFIX));

if (hasMonitoringChanges) {
  try {
    this.reloadBalanceMonitor();
  } catch (err) {
    console.warn('Hot-reload balance monitor failed:', err);
  }
}
```

e. `reloadBalanceMonitor()` private 메서드 추가 (reloadAutoStop과 동일 패턴):
```typescript
private reloadBalanceMonitor(): void {
  const svc = this.deps.balanceMonitorService;
  if (!svc) return;

  const ss = this.deps.settingsService;
  const newConfig: Partial<BalanceMonitorConfig> = {
    checkIntervalSec: parseInt(ss.get('monitoring.check_interval_sec'), 10),
    lowBalanceThresholdSol: parseFloat(ss.get('monitoring.low_balance_threshold_sol')),
    lowBalanceThresholdEth: parseFloat(ss.get('monitoring.low_balance_threshold_eth')),
    cooldownHours: parseInt(ss.get('monitoring.cooldown_hours'), 10),
    enabled: ss.get('monitoring.enabled') === 'true',
  };

  svc.updateConfig(newConfig);
  console.log('Hot-reload: Balance monitor config updated (effective immediately)');
}
```

주의: lowBalanceThresholdSol/Eth는 parseFloat (parseInt가 아님).
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon build` 성공.
`grep monitoring_check_interval_sec packages/daemon/src/infrastructure/config/loader.ts` -- 존재.
`grep "category: 'monitoring'" packages/daemon/src/infrastructure/settings/setting-keys.ts` -- 존재.
`grep reloadBalanceMonitor packages/daemon/src/infrastructure/settings/hot-reload.ts` -- 존재.
  </verify>
  <done>
config.toml security 섹션에 monitoring_* flat key 5개가 추가되고, Admin Settings monitoring 카테고리로 런타임 오버라이드 가능하며, HotReloadOrchestrator가 monitoring 키 변경 시 BalanceMonitorService.updateConfig()을 호출한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: DaemonLifecycle 통합 + 통합 테스트</name>
  <files>
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/__tests__/balance-monitor-integration.test.ts
  </files>
  <action>
**1. DaemonLifecycle에 BalanceMonitorService 통합** (`packages/daemon/src/lifecycle/daemon.ts`):

AutoStopService Step 4c-3 패턴과 동일하게 추가한다.

a. import 추가 (파일 상단):
```typescript
import type { BalanceMonitorService } from '../services/monitoring/balance-monitor-service.js';
import type { BalanceMonitorConfig } from '../services/monitoring/balance-monitor-service.js';
```

b. 클래스 필드 추가 (autoStopService 아래):
```typescript
private balanceMonitorService: BalanceMonitorService | null = null;
```

c. Step 4c-4 추가 (Step 4c-3 AutoStop 블록 다음, Step 4e PriceOracle 이전):
```typescript
// ------------------------------------------------------------------
// Step 4c-4: BalanceMonitorService initialization (fail-soft)
// ------------------------------------------------------------------
try {
  if (this.sqlite && this.adapterPool && this._config && this._settingsService) {
    const { BalanceMonitorService: BalanceMonitorCls } = await import(
      '../services/monitoring/balance-monitor-service.js'
    );

    const monitorConfig: BalanceMonitorConfig = {
      checkIntervalSec: parseInt(this._settingsService.get('monitoring.check_interval_sec'), 10),
      lowBalanceThresholdSol: parseFloat(this._settingsService.get('monitoring.low_balance_threshold_sol')),
      lowBalanceThresholdEth: parseFloat(this._settingsService.get('monitoring.low_balance_threshold_eth')),
      cooldownHours: parseInt(this._settingsService.get('monitoring.cooldown_hours'), 10),
      enabled: this._settingsService.get('monitoring.enabled') === 'true',
    };

    this.balanceMonitorService = new BalanceMonitorCls({
      sqlite: this.sqlite,
      adapterPool: this.adapterPool,
      config: this._config,
      notificationService: this.notificationService ?? undefined,
      monitorConfig,
    });

    if (monitorConfig.enabled) {
      this.balanceMonitorService.start();
      console.log('Step 4c-4: Balance monitor started');
    } else {
      console.log('Step 4c-4: Balance monitor disabled');
    }
  }
} catch (err) {
  console.warn('Step 4c-4 (fail-soft): Balance monitor init warning:', err);
  this.balanceMonitorService = null;
}
```

d. Step 5 HotReloadOrchestrator 생성자에 balanceMonitorService 추가:
```typescript
const hotReloader = new HotReloadOrchestrator({
  settingsService: this._settingsService!,
  notificationService: this.notificationService,
  adapterPool: this.adapterPool,
  autoStopService: this.autoStopService,
  balanceMonitorService: this.balanceMonitorService,  // <-- 추가
});
```

e. shutdown() 메서드에 BalanceMonitorService.stop() 추가 (AutoStop stop 바로 다음):
```typescript
// Stop BalanceMonitorService (before EventBus cleanup)
if (this.balanceMonitorService) {
  this.balanceMonitorService.stop();
  this.balanceMonitorService = null;
}
```

**2. 통합 테스트** (`packages/daemon/src/__tests__/balance-monitor-integration.test.ts`):

autostop-integration.test.ts 패턴을 따름.

테스트 케이스:

1. **config.toml 키 존재**: DaemonConfigSchema에서 monitoring_* 5개 키가 기본값으로 파싱되는지 검증
   ```typescript
   const config = DaemonConfigSchema.parse({});
   expect(config.security.monitoring_check_interval_sec).toBe(300);
   expect(config.security.monitoring_low_balance_threshold_sol).toBe(0.01);
   expect(config.security.monitoring_low_balance_threshold_eth).toBe(0.005);
   expect(config.security.monitoring_cooldown_hours).toBe(24);
   expect(config.security.monitoring_enabled).toBe(true);
   ```

2. **SETTING_DEFINITIONS monitoring 카테고리**: SETTING_DEFINITIONS에서 category='monitoring'인 항목이 5개인지 검증

3. **SettingsService -> BalanceMonitorService config 파이프라인**: in-memory SQLite + SettingsService.importFromConfig() -> 설정값 조회 -> BalanceMonitorConfig 생성 파이프라인 검증

4. **BMON-06 LOW_BALANCE NotificationEventType**: NOTIFICATION_EVENT_TYPES에 'LOW_BALANCE'가 포함되는지 검증

5. **i18n LOW_BALANCE 템플릿**: getNotificationMessage('LOW_BALANCE', 'en', { walletId: 'w1', balance: '0.005', currency: 'SOL', threshold: '0.01' }) 호출 시 올바른 보간 결과 반환

6. **i18n LOW_BALANCE 한글**: getNotificationMessage('LOW_BALANCE', 'ko', ...) 호출 시 한글 템플릿 반환

7. **HotReload monitoring**: reloadBalanceMonitor 호출 시 updateConfig가 호출되는지 mock 검증

8. **config 유효성 검증**: monitoring_check_interval_sec가 범위 밖(59 또는 3601)이면 Zod 에러 발생

테스트에서 기존 settings-service.test.ts의 `validCategories`와 정의 수가 autostop-integration이 이미 갱신한 값에서 `monitoring` 카테고리 추가분(5개)을 반영하는지 확인하고 필요 시 갱신한다.

`pnpm --filter @waiaas/daemon exec vitest run src/__tests__/settings-service.test.ts` 도 함께 실행하여 기존 테스트 호환성 확인.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/balance-monitor` 전체 통과.
`pnpm --filter @waiaas/daemon exec vitest run src/__tests__/settings-service.test.ts` 전체 통과.
`pnpm --filter @waiaas/daemon build` 성공.
`grep 'BalanceMonitorService' packages/daemon/src/lifecycle/daemon.ts` -- 존재.
`grep 'balanceMonitorService' packages/daemon/src/infrastructure/settings/hot-reload.ts` -- 존재.
  </verify>
  <done>
DaemonLifecycle Step 4c-4에서 BalanceMonitorService가 초기화/시작되고, shutdown 시 stop()이 호출되며, HotReloadOrchestrator가 monitoring 키 변경을 감지하여 updateConfig()을 호출한다. config.toml -> Admin Settings -> BalanceMonitorService 전체 파이프라인이 통합 테스트로 검증된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/daemon build` -- 전체 빌드 성공 (타입 체크)
2. `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/balance-monitor-service.test.ts` -- 단위 테스트 통과
3. `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/balance-monitor-integration.test.ts` -- 통합 테스트 통과
4. `pnpm --filter @waiaas/daemon exec vitest run src/__tests__/settings-service.test.ts` -- 기존 테스트 통과
5. `grep 'Step 4c-4' packages/daemon/src/lifecycle/daemon.ts` -- DaemonLifecycle 통합 확인
6. `grep monitoring_check_interval_sec packages/daemon/src/infrastructure/config/loader.ts` -- config key 확인
7. `grep "category: 'monitoring'" packages/daemon/src/infrastructure/settings/setting-keys.ts` -- Admin Settings 카테고리 확인
</verification>

<success_criteria>
- config.toml security 섹션에 monitoring_* flat key 5개 추가 (Zod 기본값 반영)
- SETTING_DEFINITIONS에 monitoring 카테고리 5개 키 등록
- HotReloadOrchestrator가 monitoring.* 키 변경 시 reloadBalanceMonitor() 호출
- DaemonLifecycle Step 4c-4에서 BalanceMonitorService 초기화/시작/종료
- 8개 이상 통합 테스트 통과
- 기존 settings-service.test.ts 통과
</success_criteria>

<output>
After completion, create `.planning/phases/142-balance-monitoring/142-02-SUMMARY.md`
</output>
