---
phase: 145-docker
plan: 02
type: execute
wave: 2
depends_on: ["145-01"]
files_modified:
  - docker-compose.yml
  - docker-compose.secrets.yml
autonomous: false

must_haves:
  truths:
    - "docker compose up 후 HEALTHCHECK가 통과하고 데몬이 정상 실행된다"
    - "Docker Secrets + _FILE 패턴으로 시크릿 파일에서 환경변수가 주입되어 데몬이 시작된다"
    - "named volume 덕분에 docker compose down 후 up해도 데이터가 유지된다"
    - "SDK로 컨테이너 내부 데몬에 연결하여 기본 API 호출이 가능하다"
  artifacts:
    - path: "docker-compose.secrets.yml"
      provides: "Docker Secrets 오버라이드 compose 파일"
      contains: "secrets"
  key_links:
    - from: "docker-compose.secrets.yml"
      to: "docker/entrypoint.sh"
      via: "_FILE 환경변수 -> entrypoint file_env 함수"
      pattern: "WAIAAS_MASTER_PASSWORD_FILE"
    - from: "docker-compose.yml"
      to: "/data volume"
      via: "named volume mount"
      pattern: "waiaas-data:/data"
---

<objective>
Docker Secrets 오버라이드 파일 생성 + HEALTHCHECK 통과 + 데이터 영속성 + SDK 연동 검증 -- Docker 배포가 프로덕션 환경에서 안전하게 동작함을 확인한다.

Purpose: Docker Secrets 보안 패턴 + HEALTHCHECK + 영속성 완전성 검증 (DOCK-03, DOCK-04, DOCK-05)
Output: docker-compose.secrets.yml + 검증 완료
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/145-docker/145-01-SUMMARY.md

@Dockerfile
@docker-compose.yml
@docker/entrypoint.sh
@.dockerignore
@packages/daemon/src/api/routes/health.ts
@packages/cli/src/utils/password.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Docker Secrets 오버라이드 + 빌드/실행 검증</name>
  <files>docker-compose.secrets.yml</files>
  <action>
**1. docker-compose.secrets.yml 생성 (프로젝트 루트)**

Docker Compose Secrets 오버라이드 파일. 기본 docker-compose.yml 위에 덮어쓰기:

```yaml
# Docker Secrets override for production deployments.
# Usage: docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
#
# Before starting, create secret files:
#   mkdir -p secrets
#   echo "your_master_password" > secrets/master_password.txt
#   chmod 600 secrets/master_password.txt
#
# Optional (if Telegram Bot is enabled):
#   echo "your_bot_token" > secrets/telegram_bot_token.txt
#   chmod 600 secrets/telegram_bot_token.txt

services:
  daemon:
    secrets:
      - waiaas_master_password
      - waiaas_telegram_bot_token
    environment:
      - WAIAAS_MASTER_PASSWORD_FILE=/run/secrets/waiaas_master_password
      - WAIAAS_TELEGRAM_BOT_TOKEN_FILE=/run/secrets/waiaas_telegram_bot_token

secrets:
  waiaas_master_password:
    file: ./secrets/master_password.txt
  waiaas_telegram_bot_token:
    file: ./secrets/telegram_bot_token.txt
```

**2. .gitignore에 secrets/ 디렉토리 추가**

`.gitignore` 파일 끝에 추가:
```
# Docker secrets (never commit)
secrets/
```

**3. 이미지 빌드 + 기본 실행 검증**

순서대로 실행하여 전체 파이프라인을 검증한다:

a) **이미지 빌드:**
```bash
docker build -t waiaas:test .
```
- 빌드 에러 발생 시: 에러 메시지 분석 후 Dockerfile 수정
- native addon (sodium-native, better-sqlite3, argon2) 빌드 실패 시: builder 스테이지에 `python3 make g++` 설치 추가
- pnpm install 실패 시: pnpm-lock.yaml 동기화 확인

b) **non-root 유저 확인:**
```bash
docker run --rm waiaas:test whoami  # -> waiaas
docker run --rm waiaas:test id -u   # -> 1001
```

c) **기본 실행 검증 (환경변수로 패스워드 주입):**
```bash
docker compose up -d
# 10초 대기 후 health check
sleep 10
curl -f http://localhost:3100/health
docker compose ps  # STATUS에 (healthy) 표시 확인
```
- HEALTHCHECK 실패 시: `docker compose logs daemon`으로 데몬 에러 확인
- 데몬 시작 실패 시: WAIAAS_MASTER_PASSWORD 환경변수 필요. `.env` 파일 생성 또는 docker-compose.yml의 environment에 추가 후 재시도

d) **Docker Secrets 검증 (secrets 오버라이드):**
```bash
mkdir -p secrets
echo "test_master_password_123" > secrets/master_password.txt
echo "" > secrets/telegram_bot_token.txt
chmod 600 secrets/master_password.txt secrets/telegram_bot_token.txt

docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
sleep 10
curl -f http://localhost:3100/health
docker compose -f docker-compose.yml -f docker-compose.secrets.yml logs daemon | head -20
```
- entrypoint.sh의 file_env 함수가 `/run/secrets/waiaas_master_password` 파일을 읽어 `WAIAAS_MASTER_PASSWORD`로 설정
- 데몬이 성공적으로 시작되면 Docker Secrets 패턴이 동작함

e) **named volume 영속성 검증:**
```bash
# 1. 컨테이너 시작 (위에서 이미 실행 중)
# 2. health API로 uptime 확인
curl http://localhost:3100/health | jq .uptime

# 3. compose down (volume은 유지)
docker compose down
# 또는 secrets 오버라이드 사용 시:
docker compose -f docker-compose.yml -f docker-compose.secrets.yml down

# 4. 다시 시작
docker compose up -d
# 또는:
docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d

sleep 10

# 5. health 확인 -- 데몬 재시작 성공 (DB 파일이 volume에 유지)
curl -f http://localhost:3100/health
```

f) **발견된 문제 수정:**
- 빌드/실행 과정에서 발견된 모든 문제를 Dockerfile, docker-compose.yml, entrypoint.sh에 반영한다
- 예: 누락된 파일 COPY, 잘못된 경로, 권한 문제, native addon 호환성 등

g) **정리:**
```bash
docker compose down
# 테스트 secrets 정리
rm -rf secrets/
```
  </action>
  <verify>
1. `docker build -t waiaas:test .` 성공
2. `docker run --rm waiaas:test whoami` -> `waiaas`
3. `docker run --rm waiaas:test id -u` -> `1001`
4. `docker compose up -d` 후 `curl http://localhost:3100/health` -> 200
5. `docker compose down && docker compose up -d` 후 health 여전히 200 (영속성)
6. `docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d` 후 health 200 (Secrets 패턴)
  </verify>
  <done>
이미지 빌드 성공, non-root 실행 확인, HEALTHCHECK 통과, Docker Secrets _FILE 패턴 동작, named volume 영속성 검증 완료.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Docker 원클릭 배포 인프라 -- Multi-stage Dockerfile + docker-compose.yml + Docker Secrets + HEALTHCHECK + named volume 영속성</what-built>
  <how-to-verify>
1. 프로젝트 루트에서 빌드 확인:
   ```bash
   docker build -t waiaas:test .
   ```
   에러 없이 빌드 완료 확인

2. 기본 실행 확인:
   ```bash
   # .env 파일에 WAIAAS_MASTER_PASSWORD=your_password 설정 후:
   docker compose up -d
   docker compose ps   # (healthy) 상태 확인
   curl http://localhost:3100/health
   ```
   `{"status":"ok"}` 응답 확인

3. non-root 실행 확인:
   ```bash
   docker compose exec daemon whoami   # -> waiaas
   docker compose exec daemon id -u    # -> 1001
   ```

4. 데이터 영속성 확인:
   ```bash
   docker compose down
   docker compose up -d
   sleep 10
   curl http://localhost:3100/health   # 여전히 200
   ```

5. 이미지 크기 확인:
   ```bash
   docker images waiaas:test --format '{{.Size}}'
   ```
   500MB 이하이면 양호

6. 정리:
   ```bash
   docker compose down
   ```
  </how-to-verify>
  <resume-signal>"approved" 또는 발견된 문제 설명</resume-signal>
</task>

</tasks>

<verification>
1. `docker build` 에러 없이 완료
2. `docker compose up -d` 후 HEALTHCHECK 통과 (healthy 상태)
3. `curl http://localhost:3100/health` -> 200 `{"status":"ok"}`
4. `docker compose exec daemon whoami` -> `waiaas` (non-root)
5. `docker compose down && docker compose up -d` 후 데이터 유지 (named volume)
6. Docker Secrets _FILE 패턴으로 시크릿 안전 주입 동작
</verification>

<success_criteria>
- DOCK-03: Docker Secrets + _FILE 패턴으로 MASTER_PASSWORD_FILE 등 시크릿이 안전하게 주입된다
- DOCK-04: docker compose up 후 HEALTHCHECK가 통과하고 API 호출이 가능하다
- DOCK-05: named volume 덕분에 docker compose down -> up 후에도 데이터가 유지된다
- Phase 145 전체 완료: docker compose up 한 줄로 WAIaaS 데몬이 실행되고, 데이터가 영속되며, 시크릿이 안전하게 주입된다
</success_criteria>

<output>
After completion, create `.planning/phases/145-docker/145-02-SUMMARY.md`
</output>
