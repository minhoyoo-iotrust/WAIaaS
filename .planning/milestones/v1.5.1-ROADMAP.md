# Milestone v1.5.1: x402 클라이언트 지원

**Status:** SHIPPED 2026-02-15
**Phases:** 130-133
**Total Plans:** 10

## Overview

AI 에이전트가 x402 프로토콜로 보호된 외부 유료 API를 자동 결제하며 사용할 수 있는 상태를 달성. SSRF 가드, x402 핸들러(HTTP 402 파싱 + scheme 선택 + 결제 서명), REST API(POST /v1/x402/fetch), 정책 통합(X402_ALLOWED_DOMAINS + SPENDING_LIMIT 4-tier USD 환산), 감사 로그(X402_PAYMENT), TS/Python SDK + MCP 도구 + 스킬 파일까지 전체 스택 구현.

## Phases

### Phase 130: Core 타입 + CAIP-2 매핑 + DB 마이그레이션
**Goal**: x402 기능의 타입 시스템과 데이터베이스 기반이 준비되어 후속 구현이 컴파일 타임 안전성을 가지는 상태
**Depends on**: Nothing (v1.5 shipped 기반)
**Plans**: 2 plans (2 waves)

Plans:
- [x] 130-01-PLAN.md — @x402/core 의존성 + Enum 확장 + x402.types.ts + 에러 코드 + i18n + 테스트 (Wave 1)
- [x] 130-02-PLAN.md — DB 마이그레이션 v12 (transactions + policies CHECK 재생성) + 마이그레이션 테스트 (Wave 2)

### Phase 131: SSRF 가드 + x402 핸들러 + 결제 서명
**Goal**: 외부 URL에 대한 안전한 HTTP 요청, 402 응답 파싱, 체인별 결제 서명 생성이 단위 테스트 수준에서 동작하는 상태
**Depends on**: Phase 130
**Plans**: 3 plans (2 waves)

Plans:
- [x] 131-01-PLAN.md — SSRF 가드 TDD: DNS resolve + 사설 IP 차단 + 리다이렉트 재검증 + URL 정규화 (Wave 1)
- [x] 131-03-PLAN.md — 결제 서명 TDD: EVM EIP-3009 signTypedData + Solana TransferChecked 부분 서명 + 키 관리 (Wave 1)
- [x] 131-02-PLAN.md — x402 핸들러 TDD: 402 파싱 + scheme 선택 + 재요청 오케스트레이션 (Wave 2)

### Phase 132: REST API + 정책 통합 + 감사 로그
**Goal**: x402 결제가 기존 정책 엔진으로 제어되고, REST API로 노출되며, 모든 결제가 감사 추적되는 상태
**Depends on**: Phase 131
**Plans**: 3 plans (2 waves)

Plans:
- [x] 132-01-PLAN.md — X402_ALLOWED_DOMAINS 도메인 정책 TDD + config.toml [x402] 섹션 (Wave 1)
- [x] 132-02-PLAN.md — x402 결제 금액 USD 환산 TDD (USDC $1 직접 + IPriceOracle) (Wave 1)
- [x] 132-03-PLAN.md — POST /v1/x402/fetch 라우트 + server.ts 등록 + 통합 테스트 (Wave 2)

### Phase 133: SDK + MCP + 스킬 파일
**Goal**: AI 에이전트가 TS SDK, Python SDK, MCP 도구를 통해 x402 유료 API를 자율적으로 호출하고, 스킬 파일로 사용법을 학습할 수 있는 상태
**Depends on**: Phase 132
**Plans**: 2 plans (1 wave)

Plans:
- [x] 133-01-PLAN.md — TS SDK + Python SDK x402Fetch/x402_fetch 메서드 + 테스트 (Wave 1)
- [x] 133-02-PLAN.md — MCP x402_fetch 도구 + x402.skill.md + transactions.skill.md 갱신 + 스킬 등록 (Wave 1)

---

## Milestone Summary

**Key Decisions:**
- @x402/core 단일 의존성 추가 (Zod SSoT 호환)
- SSRF 가드 자체 구현 (node:dns + node:net, 외부 라이브러리 CVE 회피)
- x402-handler 독립 파이프라인 (기존 6-stage 미확장, sign-only 패턴 참조)
- DELAY/APPROVAL 즉시 거부 (동기 HTTP에서 대기 불가)
- RFC 5735/6890 전체 범위 차단 (CGNAT, 벤치마크, TEST-NET 3종, 멀티캐스트, 예약 포함)
- IChainAdapter 미경유, viem/solana-kit 직접 사용 (EIP-3009는 typed data 서명)
- USDC $1 직접 환산 + 비-USDC IPriceOracle USD 환산
- X402_ALLOWED_DOMAINS DatabasePolicyEngine 외부 독립 모듈
- Option A: handleX402Fetch 대신 parse402Response + selectPaymentRequirement + signPayment 직접 조합
- actions.skill.md 미등록 이슈를 x402 등록과 함께 해결 (5→7개 스킬)

**Issues Resolved:**
- actions.skill.md VALID_SKILLS/SKILL_NAMES 미등록 수정

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- Python SDK 테스트는 venv 미설치로 런타임 실행 검증 미완 (정적 분석 확인)

---

_For current project status, see .planning/ROADMAP.md_
