# Milestone v0.8: Owner 선택적 등록 + 점진적 보안 모델

**Status:** ✅ SHIPPED 2026-02-09
**Phases:** 31-35
**Total Plans:** 11

## Overview

Owner 지갑 등록을 필수에서 선택으로 전환하고, 등록 여부에 따라 보안 기능이 점진적으로 해금되는 모델을 설계한다. 데이터 모델 기반 설계(스키마/타입)에서 시작하여, Owner 생명주기, 정책 다운그레이드, 자금 회수/보안 분기를 순차적으로 설계한 뒤, 14개 기존 설계 문서에 일괄 통합한다. 본 마일스톤은 설계 문서 수정이 산출물이며, 코드 구현은 포함하지 않는다.

## Phases

### Phase 31: 데이터 모델 + 타입 기반 설계

**Goal**: 모든 후속 설계의 기반이 되는 스키마 변경과 타입 정의가 확정되어, Owner 유무에 따른 조건 분기를 설계할 수 있다
**Depends on**: Nothing (first phase of v0.8)
**Requirements**: OWNER-01, OWNER-07, OWNER-08, WITHDRAW-06
**Plans**: 2 plans (Wave 1 parallel)

Plans:
- [x] 31-01-PLAN.md -- agents 스키마 v0.8 변경(nullable owner_address, owner_verified) + 마이그레이션 SQL + OwnerState/SweepResult 타입 + PolicyDecision 확장
- [x] 31-02-PLAN.md -- IChainAdapter.sweepAll 시그니처(20번째 메서드) + resolveOwnerState() 유틸리티 + Grace->Locked BEGIN IMMEDIATE 원자화

**Details:**
- OwnerState는 DB 컬럼이 아닌 런타임 파생 상태 (동기화 오류 방지)
- SweepResult.tokensRecovered는 v0.6 AssetInfo 직접 재사용
- PolicyDecision 확장은 optional 필드로 하위 호환성 유지
- v0.8 마이그레이션에서 PRAGMA foreign_keys OFF/ON 패턴 적용

### Phase 32: Owner 생명주기 설계

**Goal**: Owner 주소의 등록/변경/해제 전체 생명주기가 설계되어, 유예/잠금 2단계에 따른 인증 요건과 제약이 명확하다
**Depends on**: Phase 31
**Requirements**: OWNER-02, OWNER-03, OWNER-04, OWNER-05, OWNER-06
**Plans**: 2 plans (Wave 1 -> Wave 2 sequential)

Plans:
- [x] 32-01-PLAN.md -- Owner 생명주기 상태 머신(3-State, 6전이) + OwnerLifecycleService + REST API/CLI 스펙 + 감사 이벤트/에러 코드
- [x] 32-02-PLAN.md -- ownerAuth Step 8.5 + change_owner action + 인증 맵 갱신 + 보안 공격 방어 C-01/C-02/H-02/H-03

**Details:**
- 인증 분기를 비즈니스 로직(OwnerLifecycleService)에서 처리 (미들웨어 정적 결정 불가)
- LOCKED 주소 변경 시 owner_verified 리셋 금지 (보안 다운그레이드 방지)
- Kill Switch ACTIVATED에서 Owner 변경 자동 차단

### Phase 33: 정책 다운그레이드 + 알림 설계

**Goal**: Owner 없는 에이전트의 APPROVAL 거래가 차단 없이 DELAY로 다운그레이드되어 실행되고, 알림에 Owner 등록 안내가 포함되는 설계가 완성된다
**Depends on**: Phase 31
**Requirements**: POLICY-01, POLICY-02, POLICY-03, NOTIF-01, NOTIF-02
**Plans**: 2 plans (Wave 1 parallel)

Plans:
- [x] 33-01-PLAN.md -- evaluate() Step 9.5 다운그레이드 로직 + evaluateBatch 다운그레이드 + TX_DOWNGRADED 감사 로그 + Owner LOCKED 후 정상 APPROVAL 복원 흐름
- [x] 33-02-PLAN.md -- TX_DOWNGRADED_DELAY 이벤트 추가 + 채널별 다운그레이드 알림 템플릿 + APPROVAL 대기 [승인]/[거부] 버튼 명세

**Details:**
- Step 9.5에서 return으로 Step 10 스킵 (APPROVE_TIER_OVERRIDE 다운그레이드 복원 방지)
- TX_DOWNGRADED_DELAY를 별도 이벤트로 분리 (하위 호환)
- Telegram url 기반 InlineKeyboard (ownerAuth 서명 필요)

### Phase 34: 자금 회수 + 보안 분기 설계

**Goal**: Owner 등록된 에이전트의 자금 전량 회수 프로토콜과, Owner 유무별 Kill Switch 복구/세션 갱신 분기가 설계된다
**Depends on**: Phase 31, Phase 32
**Requirements**: WITHDRAW-01~08, SECURITY-01~04, NOTIF-03
**Plans**: 2 plans (Wave 1 parallel)

Plans:
- [x] 34-01-PLAN.md -- withdraw API 엔드포인트 + WithdrawService 도메인 서비스 + sweepAll Solana 실행 순서 + scope 분기 + HTTP 207 부분 실패
- [x] 34-02-PLAN.md -- Kill Switch 복구 Owner 유무 분기(24h vs 30min) + 2단계 복구 패턴 + 세션 갱신 Owner 분기 + [거부하기] 버튼 3채널 명세

**Details:**
- withdraw API masterAuth(implicit)만 (수신 주소 owner_address 고정)
- scope 분기 WithdrawService 수준 (IChainAdapter.sweepAll에 scope 파라미터 없음)
- Kill Switch 복구는 시스템별 분기 (agents.owner_address IS NOT NULL 존재 여부)

### Phase 35: DX + 설계 문서 통합

**Goal**: CLI 명령어 변경이 설계되고, 14개 기존 설계 문서에 v0.8 Owner 선택적 모델이 일관되게 반영된다
**Depends on**: Phase 31, Phase 32, Phase 33, Phase 34
**Requirements**: DX-01~05, INTEG-01, INTEG-02
**Plans**: 3 plans (Wave 1 → Wave 2 → Wave 3 sequential)

Plans:
- [x] 35-01-PLAN.md -- 54-cli-flow-redesign.md v0.8 전면 갱신: agent create --owner 선택, set-owner/remove-owner/withdraw 신규 CLI, --quickstart 간소화
- [x] 35-02-PLAN.md -- Owner 상태 분기 매트릭스 SSoT 작성: API x OwnerState(NONE/GRACE/LOCKED) 18행 매트릭스
- [x] 35-03-PLAN.md -- 14개 설계 문서 v0.8 통합 반영: 4개 첫 v0.8 반영 + 10개 교차 검증 + 3개 참조 문서 보강

**Details:**
- Kill Switch withdraw 방안 A 채택 (killSwitchGuard 허용 경로 4→5개)
- Owner 상태 분기 매트릭스 18행x3열, 교차 검증 10건 전건 일치
- 총 240 [v0.8] 태그, 14개 primary + 3개 reference 문서 수정

## Progress

**Execution Order:** 31 → 32/33 (parallel) → 34 → 35

| Phase | Plans Complete | Status | Completed |
|-------|---------------|--------|-----------|
| 31. 데이터 모델 + 타입 기반 설계 | 2/2 | ✓ Complete | 2026-02-08 |
| 32. Owner 생명주기 설계 | 2/2 | ✓ Complete | 2026-02-09 |
| 33. 정책 다운그레이드 + 알림 설계 | 2/2 | ✓ Complete | 2026-02-09 |
| 34. 자금 회수 + 보안 분기 설계 | 2/2 | ✓ Complete | 2026-02-09 |
| 35. DX + 설계 문서 통합 | 3/3 | ✓ Complete | 2026-02-09 |

---

## Milestone Summary

**Key Decisions:**

- Owner 선택적 등록 (필수→선택): 자율 에이전트 시나리오 지원 + 온보딩 마찰 제거
- 점진적 보안 해금 (Base/Enhanced): DELAY 다운그레이드로 차단 없이 보안 유도
- OwnerState 런타임 파생: DB 비저장, 순수 함수로 산출하여 SSoT 유지
- sweepAll masterAuth만: 수신 주소 owner_address 고정이므로 공격자 이득 없음
- Kill Switch withdraw 방안 A: killSwitchGuard 5번째 허용 경로 추가
- GRACE APPROVAL = DELAY 다운그레이드: resolveOwnerState() !== 'LOCKED' 조건

**Issues Resolved:**

- Grace→Locked 레이스 컨디션 (C-01): BEGIN IMMEDIATE + WHERE owner_verified = 0 3중 보호
- 유예 구간 withdraw 공격 (H-02): owner_verified=1에서만 withdraw 활성화
- 보안 다운그레이드 공격 (C-02): LOCKED 해제 금지 + 알림 + killSwitchGuard
- sweepAll 부분 실패 (C-03): SOL 마지막 전송 + HTTP 207 부분 성공 처리
- Kill Switch Owner 변경 (H-03): killSwitchGuard 5개 허용 경로 외 503 차단

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/MILESTONES.md_
