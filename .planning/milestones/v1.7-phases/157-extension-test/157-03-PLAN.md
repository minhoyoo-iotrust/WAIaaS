---
phase: 157-extension-test
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/extension/action-provider.extension.test.ts
  - packages/daemon/src/__tests__/extension/chain-error.extension.test.ts
autonomous: true

must_haves:
  truths:
    - "ActionProviderRegistry.register()가 유효한 provider를 정상 등록한다"
    - "ActionProviderRegistry.executeResolve()가 ContractCallRequest를 올바르게 반환한다"
    - "resolve() 결과의 from이 context.walletAddress와 일치함이 검증된다"
    - "MCP Tool 변환(mcpExpose=true)이 올바르게 동작한다"
    - "ESM 플러그인 로드가 정상 동작하고 미존재 디렉토리에서 0개 로드된다"
    - "inputSchema Zod 검증이 잘못된 파라미터를 거부한다"
    - "ChainError 29 code가 3-category(PERMANENT 21, TRANSIENT 4, STALE 4)로 올바르게 분류된다"
    - "PERMANENT category는 retryable=false이고 TRANSIENT/STALE는 retryable=true이다"
    - "ChainError.toJSON()이 5개 필드(code, message, category, chain, retryable)를 정확히 반환한다"
    - "cause chaining이 올바르게 동작한다"
  artifacts:
    - path: "packages/daemon/src/__tests__/extension/action-provider.extension.test.ts"
      provides: "EXT-06 Action Provider 기능 테스트 16건"
      min_lines: 350
    - path: "packages/daemon/src/__tests__/extension/chain-error.extension.test.ts"
      provides: "EXT-07 ChainError 기능 테스트 12건"
      min_lines: 250
  key_links:
    - from: "action-provider.extension.test.ts"
      to: "ActionProviderRegistry"
      via: "register/executeResolve/getMcpExposedActions"
      pattern: "registry\\.(register|executeResolve|getMcpExposedActions)"
    - from: "action-provider.extension.test.ts"
      to: "MockActionProvider"
      via: "createMockActionProvider factory"
      pattern: "createMockActionProvider"
    - from: "chain-error.extension.test.ts"
      to: "ChainError"
      via: "constructor + category/retryable auto-derivation"
      pattern: "new ChainError"
    - from: "chain-error.extension.test.ts"
      to: "CHAIN_ERROR_CATEGORIES"
      via: "29-code category mapping exhaustive check"
      pattern: "CHAIN_ERROR_CATEGORIES"
---

<objective>
Action Provider(EXT-06, 16건) + ChainError(EXT-07, 12건) 기능 테스트 28건을 작성한다.

Purpose: IActionProvider/ActionProviderRegistry의 정상 resolve-then-execute 흐름과 MCP Tool 변환을 검증하고, ChainError 3-category 시스템의 올바른 분류/retryable 자동 파생/직렬화를 증명한다.
Output: 2개 확장 기능 테스트 파일 (extension/ 디렉토리)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

# 핵심 구현 파일
@packages/daemon/src/infrastructure/action/action-provider-registry.ts
@packages/core/src/errors/chain-error.ts
@packages/core/src/interfaces/action-provider.types.ts

# 기존 테스트 패턴 참조
@packages/daemon/src/__tests__/action-provider-registry.test.ts

# 보안 테스트 패턴 (동일 도메인, 보안 관점)
@packages/daemon/src/__tests__/security/extension/action-provider-attacks.security.test.ts
@packages/daemon/src/__tests__/security/extension/chain-error-attacks.security.test.ts

# Mock 인프라
@packages/daemon/src/__tests__/mocks/mock-action-provider.ts

# 기능 테스트 시나리오 정의 (doc 64, 섹션 6.7)
@docs/64-extension-test-strategy.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: EXT-06 Action Provider 기능 테스트 16건</name>
  <files>
    packages/daemon/src/__tests__/extension/action-provider.extension.test.ts
  </files>
  <action>
action-provider.extension.test.ts를 작성한다.

doc 64 섹션 6.7 ACT 시나리오 12건 + 추가 기능 동작 4건 = 16건.

**기존 action-provider-registry.test.ts와의 차별점:**
- 기존: ActionProviderRegistry 클래스 메서드별 단위 테스트 (register, unregister, getAction 등)
- 이 테스트: "확장 기능 시나리오" 관점으로 resolve-then-execute 흐름, MCP 변환, 플러그인 로드, 에러 케이스를 end-to-end로 검증

**테스트 구조 (describe 블록):**

1. `describe('ACT-U01~U04: Unit Registry 에러')` (4건)
   - ACT-U01: MCP Tool 상한 초과 (mcpExpose=true provider 17개 등록 시도) -> McpToolLimitExceededError 또는 16개 초과 경고
   - ACT-U02: 액션 이름 충돌 (동일 providerName 재등록) -> ACTION_NAME_CONFLICT
   - ACT-U03: 잘못된 입력 파라미터 (inputSchema.parse 실패) -> ACTION_VALIDATION_FAILED
   - ACT-U04: 체인 불일치 (ethereum wallet에 solana-only action) -> ACTION_VALIDATION_FAILED 또는 pipeline 레벨 거부 (156-02 결정: Registry는 체인 매칭 미강제)

2. `describe('ACT-I01~I04: Integration 플러그인 로드 + 파이프라인')` (4건)
   - ACT-I01: CJS 모듈 플러그인 로드 실패 -> ActionPluginLoadError
   - ACT-I02: resolve() 타임아웃 (AbortSignal 30초 시뮬레이션)
   - ACT-I03: CONTRACT_WHITELIST 미등록 시 resolve 성공 후 Stage 3 거부 -> CANCELLED
   - ACT-I04: 플러그인 디렉토리 미존재 -> 정상 (0개 로드, 에러 없음)

3. `describe('ACT-F01~F04: 정상 기능 동작')` (4건)
   - ACT-F01: 정상 provider 등록 + executeResolve -> ContractCallRequest 반환
   - ACT-F02: resolve() 반환값 from === context.walletAddress 검증 (validate-then-trust)
   - ACT-F03: getMcpExposedActions() -> mcpExpose=true인 action만 필터링
   - ACT-F04: listProviders/listActions -> 등록된 모든 provider/action 목록

4. `describe('ACT-X01~X04: 교차 검증')` (4건)
   - ACT-X01: resolve -> ContractCallRequest -> CONTRACT_WHITELIST 정상 통과 (화이트리스트 등록된 경우)
   - ACT-X02: 다중 provider 등록 (2~3개) -> 각 provider 독립 resolve
   - ACT-X03: provider unregister 후 재등록 -> 정상 동작 (상태 초기화)
   - ACT-X04: MCP Tool 변환 정확도 (ActionDefinition -> MCP tool schema 매핑: name, description, inputSchema)

**구현 패턴:**
- ActionProviderRegistry 직접 인스턴스화
- createMockActionProvider (packages/daemon/src/__tests__/mocks/) 사용
- 다양한 overrides로 provider 변형 (chains, mcpExpose, resolveResult 등)
- ContractCallRequestSchema import for Zod validation
- vi.fn() 기반 resolve spy로 호출 인자/횟수 검증
- 156-02 결정: ActionProviderRegistry는 resolve() 시 chain 매칭 미강제 (pipeline 레벨 검증)
  </action>
  <verify>
pnpm vitest run packages/daemon/src/__tests__/extension/action-provider.extension.test.ts
16건 전체 통과. 0 실패.
  </verify>
  <done>
ACT-U01~U04 (4건) + ACT-I01~I04 (4건) + ACT-F01~F04 (4건) + ACT-X01~X04 (4건) = 16건 Action Provider 기능 테스트가 모두 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: EXT-07 ChainError 기능 테스트 12건</name>
  <files>
    packages/daemon/src/__tests__/extension/chain-error.extension.test.ts
  </files>
  <action>
chain-error.extension.test.ts를 작성한다.

doc 64 + v1.7 objectives EXT-07 기반 12건. ChainError 3-category 시스템의 **정상 동작**을 검증한다.

**기존 chain-error-attacks.security.test.ts와의 차별점:**
- 보안 테스트(156-03): 에러 카테고리 오분류, 재시도 무한 루프 등 "공격/오용" 관점
- 기능 테스트(이 파일): 29 code 정상 분류, retryable 자동 파생, 직렬화, cause chaining 등 "정상 사용" 관점

**테스트 구조 (describe 블록):**

1. `describe('CE-01~CE-03: 3-category 분류 정확도')` (3건)
   - CE-01: PERMANENT 21 codes -> 각각 category='PERMANENT', retryable=false
     - for...of Object.entries(CHAIN_ERROR_CATEGORIES) 에서 PERMANENT 필터링 후 전수 검증
   - CE-02: TRANSIENT 4 codes -> 각각 category='TRANSIENT', retryable=true
     - RPC_TIMEOUT, RPC_CONNECTION_ERROR, RATE_LIMITED, NODE_BEHIND
   - CE-03: STALE 4 codes -> 각각 category='STALE', retryable=true
     - BLOCKHASH_EXPIRED, NONCE_TOO_LOW, NONCE_ALREADY_USED, SLOT_SKIPPED

2. `describe('CE-04~CE-06: constructor + retryable 자동 파생')` (3건)
   - CE-04: constructor에 code + chain만 전달 -> 기본 message = 'Chain error: {code}'
   - CE-05: constructor에 custom message 전달 -> message 오버라이드
   - CE-06: retryable = (category !== 'PERMANENT') 자동 파생 정확도 (모든 29 code 전수)

3. `describe('CE-07~CE-09: toJSON + cause chaining')` (3건)
   - CE-07: toJSON() 반환값 5개 필드 정확도 (code, message, category, chain, retryable)
   - CE-08: cause chaining (original Error -> ChainError.cause) -> instanceof Error 확인
   - CE-09: toJSON() 결과에 cause가 포함되지 않음 (leakage 방지)

4. `describe('CE-10~CE-12: 교차 검증 + 실사용 패턴')` (3건)
   - CE-10: 전체 29 codes = PERMANENT(21) + TRANSIENT(4) + STALE(4) -- disjoint partition 확인
   - CE-11: TRANSIENT errors retry 가능 확인 (같은 TX 재제출 safe)
   - CE-12: STALE errors rebuild 필요 확인 (STALE !== TRANSIENT: 같은 TX가 아닌 새 TX 빌드 필요)

**구현 패턴:**
- @waiaas/core 패키지 export로 ChainError, CHAIN_ERROR_CATEGORIES, ChainErrorCode import (156-03 결정: 상대 경로 불필요)
- Object.entries(CHAIN_ERROR_CATEGORIES) 전수 순회 (exhaustive enumeration)
- 각 category별 코드 배열 추출: const permanentCodes = Object.entries(...).filter(([,cat]) => cat === 'PERMANENT')
- new ChainError(code, chain, { message?, cause? }) 패턴
- toJSON() 반환값 구조 검증 (Object.keys 5개 확인)
  </action>
  <verify>
pnpm vitest run packages/daemon/src/__tests__/extension/chain-error.extension.test.ts
12건 전체 통과. 0 실패.
  </verify>
  <done>
CE-01~CE-03 (3건) + CE-04~CE-06 (3건) + CE-07~CE-09 (3건) + CE-10~CE-12 (3건) = 12건 ChainError 기능 테스트가 모두 통과한다.
  </done>
</task>

</tasks>

<verification>
전체 확장 기능 테스트 실행:
```
pnpm vitest run packages/daemon/src/__tests__/extension/
```
Phase 157 전체: 134건 (32+28+24+22+20+16+12 = 154건, 실제 ~148건 범위) 통과.

기존 테스트 회귀 없음:
```
pnpm vitest run --dir packages/daemon/src/__tests__/
```
</verification>

<success_criteria>
1. action-provider.extension.test.ts에 16건(ACT-U 4 + ACT-I 4 + ACT-F 4 + ACT-X 4) 테스트가 존재하고 모두 통과한다
2. chain-error.extension.test.ts에 12건(CE 12) 테스트가 존재하고 모두 통과한다
3. 기존 action-provider-registry.test.ts, 보안 테스트에 회귀가 없다
4. Phase 157 전체 7개 테스트 파일의 합계가 ~148건이다
</success_criteria>

<output>
After completion, create `.planning/phases/157-extension-test/157-03-SUMMARY.md`
</output>
