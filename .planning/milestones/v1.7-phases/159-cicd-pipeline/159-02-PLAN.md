---
phase: 159-cicd-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["159-01"]
files_modified:
  - .github/workflows/nightly.yml
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "nightly.yml이 UTC 02:30에 full-suite + local-validator + devnet 3개 job을 실행한다"
    - "nightly local-validator job이 solana-test-validator + Anvil을 시작하고 test:chain을 실행한다"
    - "nightly devnet job이 continue-on-error로 실패해도 전체를 중단하지 않는다"
    - "release.yml이 full-test + chain-integration + platform + Docker 빌드 + npm dry-run을 실행한다"
    - "release Docker 빌드가 GHA 캐시 백엔드를 사용한다"
    - "release npm dry-run이 core/sdk/cli/mcp 4개 패키지를 검증한다"
  artifacts:
    - path: ".github/workflows/nightly.yml"
      provides: "Nightly CI 워크플로우 - UTC 02:30 cron"
      contains: "cron: '30 2 * * *'"
    - path: ".github/workflows/release.yml"
      provides: "Release CI 워크플로우 - 릴리스 검증 파이프라인"
      contains: "types: [published]"
  key_links:
    - from: ".github/workflows/nightly.yml"
      to: ".github/actions/setup/action.yml"
      via: "uses: ./.github/actions/setup"
      pattern: "uses:.*\\./.github/actions/setup"
    - from: ".github/workflows/release.yml"
      to: ".github/actions/setup/action.yml"
      via: "uses: ./.github/actions/setup"
      pattern: "uses:.*\\./.github/actions/setup"
    - from: ".github/workflows/release.yml"
      to: "scripts/coverage-gate.sh"
      via: "bash scripts/coverage-gate.sh (hard 모드)"
      pattern: "COVERAGE_GATE_MODE.*hard"
    - from: ".github/workflows/release.yml"
      to: "Dockerfile"
      via: "docker/build-push-action@v6"
      pattern: "build-push-action"
---

<objective>
Nightly(야간 전체 테스트 + 블록체인 로컬 검증기)와 Release(릴리스 품질 게이트 + Docker 빌드 + npm dry-run) 워크플로우를 구축한다.

Purpose: push/PR CI 이외에 nightly 종합 검증과 release 시점 품질 게이트를 확보하여 4-stage CI/CD 파이프라인을 완성한다.
Output: nightly.yml 워크플로우 1개 + release.yml 워크플로우 1개
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/159-cicd-pipeline/159-RESEARCH.md
@.planning/phases/159-cicd-pipeline/159-01-SUMMARY.md
@turbo.json
@package.json
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: nightly.yml 워크플로우 생성</name>
  <files>.github/workflows/nightly.yml</files>
  <action>
`.github/workflows/nightly.yml` 생성:

**Trigger:**
- `schedule: cron: '30 2 * * *'` (UTC 02:30)
- `workflow_dispatch` (수동 실행, 60일 비활성화 방지용도 겸)

**Permissions:**
- `contents: read`

**Job 1: full-suite**
- `runs-on: ubuntu-latest`
- Step: `actions/checkout@v4`
- Step: `uses: ./.github/actions/setup`
- Step: `pnpm turbo run build` (name: Build)
- Step: `pnpm turbo run lint` (name: Lint)
- Step: `pnpm turbo run typecheck` (name: Typecheck)
- Step: `pnpm turbo run test:unit -- --coverage` (name: Unit Tests)
- Step: `pnpm turbo run test:integration` (name: Integration Tests)
- Step: `pnpm turbo run test:security` (name: Security Tests)
- Step: `pnpm run verify:enums` (name: Verify Enum SSoT)
- Step: Coverage Gate - `bash scripts/coverage-gate.sh` with env `COVERAGE_GATE_MODE: hard` (nightly는 hard)

**Job 2: local-validator**
- `runs-on: ubuntu-latest`
- Step: `actions/checkout@v4`
- Step: `uses: ./.github/actions/setup`
- Step: Setup Solana - `metadaoproject/setup-solana@v1.2` with `solana-cli-version: stable`
- Step: Start solana-test-validator - `solana-test-validator --reset --quiet &` + `sleep 10` + `solana cluster-version` (단일 run 블록)
- Step: Setup Foundry - `foundry-rs/foundry-toolchain@v1`
- Step: Start Anvil - `anvil --silent &` + `sleep 3` (단일 run 블록)
- Step: `pnpm turbo run build` (name: Build)
- Step: `pnpm turbo run test:chain` (name: Chain Tests)

**Job 3: devnet**
- `runs-on: ubuntu-latest`
- `continue-on-error: true` (devnet 실패 시 전체 중단 방지)
- Step: `actions/checkout@v4`
- Step: `uses: ./.github/actions/setup`
- Step: `pnpm turbo run build` (name: Build)
- Step: Chain Tests (Devnet) - `pnpm turbo run test:chain` with env `DEVNET_TEST: 'true'`

3개 job은 서로 독립(needs 없음) -- 병렬 실행.
  </action>
  <verify>
  - `cat .github/workflows/nightly.yml` 확인: `cron: '30 2 * * *'`, `workflow_dispatch`, 3개 job(full-suite, local-validator, devnet) 존재
  - local-validator job에 `metadaoproject/setup-solana@v1.2`, `foundry-rs/foundry-toolchain@v1`, `sleep` 포함
  - devnet job에 `continue-on-error: true` + `DEVNET_TEST` 환경변수 존재
  </verify>
  <done>nightly.yml이 UTC 02:30 cron + 수동 트리거로 full-suite(lint+typecheck+unit+integration+security+coverage-gate hard) + local-validator(Solana+Anvil+chain) + devnet(continue-on-error) 3개 독립 job을 병렬 실행</done>
</task>

<task type="auto">
  <name>Task 2: release.yml 워크플로우 생성</name>
  <files>.github/workflows/release.yml</files>
  <action>
`.github/workflows/release.yml` 생성:

**Trigger:**
- `release: types: [published]`
- `workflow_dispatch` (수동 실행)

**Permissions:**
- `contents: read`
- `packages: write` (Docker 이미지 메타데이터용, push는 하지 않지만 향후 대비)

**Job 1: test** (전체 테스트 스위트)
- `runs-on: ubuntu-latest`
- Step: `actions/checkout@v4` with `fetch-depth: 0`
- Step: `uses: ./.github/actions/setup`
- Step: `pnpm turbo run build` (name: Build)
- Step: `pnpm turbo run test:unit -- --coverage` (name: Unit Tests)
- Step: `pnpm turbo run test:integration` (name: Integration Tests)
- Step: `pnpm turbo run test:security` (name: Security Tests)
- Step: `pnpm run verify:enums` (name: Verify Enum SSoT)
- Step: Coverage Gate (Hard) - `bash scripts/coverage-gate.sh` with env `COVERAGE_GATE_MODE: hard`

**Job 2: chain-integration** (로컬 검증기 체인 테스트)
- `runs-on: ubuntu-latest`
- Step: `actions/checkout@v4`
- Step: `uses: ./.github/actions/setup`
- Step: `metadaoproject/setup-solana@v1.2` with `solana-cli-version: stable`
- Step: Start solana-test-validator: `solana-test-validator --reset --quiet &` + `sleep 10` + `solana cluster-version`
- Step: `foundry-rs/foundry-toolchain@v1`
- Step: Start Anvil: `anvil --silent &` + `sleep 3`
- Step: `pnpm turbo run build` (name: Build)
- Step: `pnpm turbo run test:chain` (name: Chain Tests)

**Job 3: platform** (플랫폼 테스트 + Docker 빌드)
- `runs-on: ubuntu-latest`
- `needs: test` (기본 테스트 통과 후)
- Step: `actions/checkout@v4`
- Step: `uses: ./.github/actions/setup`
- Step: `pnpm turbo run build` (name: Build)
- Step: `pnpm turbo run test:platform` (name: Platform Tests)
- Step: Setup Docker Buildx - `docker/setup-buildx-action@v3`
- Step: Build Docker Image - `docker/build-push-action@v6` with:
  - `context: .`
  - `push: false`
  - `load: true`
  - `tags: waiaas-daemon:release-test`
  - `cache-from: type=gha`
  - `cache-to: type=gha,mode=max`
- Step: Test Docker Image:
  ```
  docker run -d --name waiaas-release-test -p 3100:3100 \
    -e WAIAAS_MASTER_PASSWORD=ci-test-password waiaas-daemon:release-test
  sleep 10
  curl -f http://localhost:3100/health
  docker stop waiaas-release-test
  ```

**Job 4: publish-check** (npm dry-run)
- `runs-on: ubuntu-latest`
- `needs: test`
- Step: `actions/checkout@v4`
- Step: `uses: ./.github/actions/setup`
- Step: `pnpm turbo run build` (name: Build)
- Step: npm publish dry-run:
  ```
  for pkg in core sdk cli mcp; do
    echo "--- Checking packages/$pkg ---"
    cd packages/$pkg
    npm publish --dry-run 2>&1 || exit 1
    cd ../..
  done
  ```
  </action>
  <verify>
  - `cat .github/workflows/release.yml` 확인: `types: [published]`, `workflow_dispatch`, 4개 job(test, chain-integration, platform, publish-check)
  - test job에 `COVERAGE_GATE_MODE: hard` 존재
  - chain-integration job에 `setup-solana`, `foundry-toolchain`, `sleep` 포함
  - platform job에 `needs: test`, `docker/build-push-action@v6`, `cache-from: type=gha`, `curl -f http://localhost:3100/health` 포함
  - publish-check job에 `npm publish --dry-run` + 4개 패키지(core/sdk/cli/mcp) 포함
  </verify>
  <done>release.yml이 릴리스 발행 시 test(full-suite+coverage-gate hard) + chain-integration(Solana+Anvil) + platform(platform tests+Docker 빌드+health check) + publish-check(npm dry-run 4패키지)를 실행하여 릴리스 품질을 보장</done>
</task>

</tasks>

<verification>
1. `.github/workflows/nightly.yml` 존재하고 cron + 3개 job 구조인가
2. `.github/workflows/release.yml` 존재하고 release trigger + 4개 job 구조인가
3. 두 워크플로우 모두 `uses: ./.github/actions/setup` 참조가 올바른가
4. nightly devnet job에 `continue-on-error: true`가 설정되어 있는가
5. release platform job에 Docker 빌드 + health check가 포함되어 있는가
6. release publish-check job에 npm dry-run이 4개 패키지를 검증하는가
</verification>

<success_criteria>
- nightly.yml이 UTC 02:30 cron으로 3개 독립 job(full-suite, local-validator, devnet) 병렬 실행
- devnet job이 continue-on-error로 실패해도 전체 중단하지 않음
- release.yml이 4개 job(test, chain-integration, platform, publish-check)으로 릴리스 품질 검증
- Docker 빌드가 GHA 캐시 백엔드(type=gha, mode=max) 사용
- npm dry-run이 core/sdk/cli/mcp 4개 패키지 검증
- 모든 워크플로우가 Composite Action(./.github/actions/setup) 참조
</success_criteria>

<output>
After completion, create `.planning/phases/159-cicd-pipeline/159-02-SUMMARY.md`
</output>
