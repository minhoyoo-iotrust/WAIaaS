---
phase: 159-cicd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/actions/setup/action.yml
  - .github/workflows/ci.yml
  - scripts/coverage-gate.sh
autonomous: true

must_haves:
  truths:
    - "Composite Action이 Node.js 22 + pnpm 9.15.4 + Turborepo 캐시를 한 번에 설정한다"
    - "push 시 Stage 1(lint+typecheck+unit --affected)이 실행된다"
    - "PR 시 Stage 2(full suite + coverage gate)가 추가 실행된다"
    - "coverage-gate.sh가 Soft/Hard 모드로 패키지별 임계값을 검증한다"
    - "동일 PR의 이전 CI 실행이 cancel-in-progress로 자동 취소된다"
  artifacts:
    - path: ".github/actions/setup/action.yml"
      provides: "Composite Action - Node.js 22 + pnpm + turbo cache + install"
      contains: "using: 'composite'"
    - path: ".github/workflows/ci.yml"
      provides: "CI 워크플로우 - Stage 1(push) + Stage 2(PR)"
      contains: "cancel-in-progress: true"
    - path: "scripts/coverage-gate.sh"
      provides: "커버리지 게이트 스크립트 - Soft/Hard 모드"
      contains: "COVERAGE_GATE_MODE"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: ".github/actions/setup/action.yml"
      via: "uses: ./.github/actions/setup"
      pattern: "uses:.*\\./.github/actions/setup"
    - from: ".github/workflows/ci.yml"
      to: "scripts/coverage-gate.sh"
      via: "bash scripts/coverage-gate.sh"
      pattern: "coverage-gate\\.sh"
    - from: ".github/workflows/ci.yml"
      to: "turbo.json"
      via: "pnpm turbo run lint/typecheck/test:unit"
      pattern: "turbo run"
---

<objective>
GitHub Actions CI 파이프라인의 기반 인프라(Composite Action, ci.yml, coverage-gate.sh)를 구축한다.

Purpose: 모든 워크플로우가 공유하는 setup과 push/PR 시 자동 실행되는 핵심 CI 파이프라인을 확보한다.
Output: Composite Action 1개 + ci.yml 워크플로우 1개 + coverage-gate.sh 스크립트 1개
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/159-cicd-pipeline/159-RESEARCH.md
@turbo.json
@package.json
@packages/core/vitest.config.ts
@packages/daemon/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Composite Action + coverage-gate.sh 생성</name>
  <files>.github/actions/setup/action.yml, scripts/coverage-gate.sh</files>
  <action>
1. `.github/actions/setup/action.yml` Composite Action 생성:
   - `name: 'WAIaaS Setup'`, `description: 'Node.js 22 + pnpm + Turborepo cache'`
   - `runs.using: 'composite'`
   - Step 1: `pnpm/action-setup@v4` (version은 package.json packageManager 필드에서 자동 감지, 명시하지 않음)
   - Step 2: `actions/setup-node@v4` with `node-version: 22`, `cache: 'pnpm'`
   - Step 3: `actions/cache@v4` with `path: .turbo`, `key: ${{ runner.os }}-turbo-${{ github.sha }}`, `restore-keys: ${{ runner.os }}-turbo-`
   - Step 4: `shell: bash`, `run: pnpm install --frozen-lockfile`

2. `scripts/coverage-gate.sh` 생성:
   - Shebang: `#!/usr/bin/env bash`, `set -euo pipefail`
   - 환경변수: `COVERAGE_GATE_MODE` (soft|hard, 기본값 soft)
   - 핵심 4 패키지 배열: `packages/core`, `packages/daemon`, `packages/adapters/solana`, `packages/sdk`
   - 패키지별 Hard 임계값 (lines 기준): core=90, daemon=85, adapters/solana=80, sdk=80 (vitest.config.ts의 lines threshold와 동기)
   - `check_package()` 함수: `jq '.total.lines.pct' coverage-summary.json`으로 커버리지 읽기
   - 패키지별 모드 오버라이드: `COVERAGE_GATE_$(패키지경로를 대문자+언더스코어)` 환경변수 체크
   - soft 모드: `::warning::` GitHub Actions 어노테이션 출력
   - hard 모드: `::error::` 출력 + exit 1
   - 커버리지 파일 미존재 시: `::warning::` 출력하고 skip (에러가 아님)
   - `chmod +x scripts/coverage-gate.sh`
  </action>
  <verify>
  - `cat .github/actions/setup/action.yml` 확인: `using: 'composite'`, `pnpm/action-setup@v4`, `actions/setup-node@v4`, `actions/cache@v4`, `pnpm install --frozen-lockfile` 포함
  - `bash -n scripts/coverage-gate.sh` 문법 검증 통과
  - `head -1 scripts/coverage-gate.sh`가 `#!/usr/bin/env bash` 출력
  </verify>
  <done>Composite Action이 4개 step(pnpm setup, node setup, turbo cache, install)을 포함하고, coverage-gate.sh가 Soft/Hard 모드 전환 + 4개 패키지별 독립 임계값을 검증하는 실행 가능한 스크립트로 존재</done>
</task>

<task type="auto">
  <name>Task 2: ci.yml 워크플로우 생성 (Stage 1 + Stage 2 + Coverage Report)</name>
  <files>.github/workflows/ci.yml</files>
  <action>
`.github/workflows/ci.yml` 생성:

**Trigger:**
- `push: branches: [main]`
- `pull_request: branches: [main]`

**Concurrency:**
- `group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}`
- `cancel-in-progress: true`

**Permissions:**
- `contents: read`
- `pull-requests: write` (coverage report 코멘트용)

**Job: stage1** (push + PR 공통)
- `runs-on: ubuntu-latest`
- Step: `actions/checkout@v4` with `fetch-depth: 0`
- Step: `uses: ./.github/actions/setup`
- Step: `git fetch origin main` (shell: bash)
- Step: `pnpm turbo run lint --affected` with env `TURBO_SCM_BASE: origin/main`
- Step: `pnpm turbo run typecheck --affected` with env `TURBO_SCM_BASE: origin/main`
- Step: `pnpm turbo run test:unit --affected -- --coverage` with env `TURBO_SCM_BASE: origin/main`

**Job: stage2** (PR only)
- `if: github.event_name == 'pull_request'`
- `needs: stage1`
- `runs-on: ubuntu-latest`
- Step: `actions/checkout@v4` with `fetch-depth: 0`
- Step: `uses: ./.github/actions/setup`
- Step: `pnpm turbo run build` (name: Build)
- Step: `pnpm turbo run test:unit -- --coverage` (name: Unit Tests - Full)
- Step: `pnpm turbo run test:integration` (name: Integration Tests)
- Step: `pnpm turbo run test:security` (name: Security Tests)
- Step: `pnpm run verify:enums` (name: Verify Enum SSoT) -- 주의: turbo가 아닌 pnpm run (root script)
- Step: Coverage Gate - `bash scripts/coverage-gate.sh` with env `COVERAGE_GATE_MODE: soft`
- 4개 Coverage Report steps (CICD-04 통합, 각 `if: always()`):
  - `davelosert/vitest-coverage-report-action@v2` for @waiaas/core:
    - `name: '@waiaas/core'`
    - `json-summary-path: packages/core/coverage/coverage-summary.json`
    - `json-final-path: packages/core/coverage/coverage-final.json`
    - `working-directory: packages/core`
  - 동일 패턴으로 @waiaas/daemon (packages/daemon), @waiaas/adapter-solana (packages/adapters/solana), @waiaas/sdk (packages/sdk)

연구 결정 반영: coverage-report를 별도 워크플로우가 아닌 ci.yml Stage 2에 통합 (Research Open Question #1 recommendation).
  </action>
  <verify>
  - `cat .github/workflows/ci.yml` 확인: `cancel-in-progress: true`, `--affected`, `TURBO_SCM_BASE`, `fetch-depth: 0`, `coverage-gate.sh`, `vitest-coverage-report-action@v2` 포함
  - `stage1` job에 lint/typecheck/test:unit --affected 3 step 존재
  - `stage2` job에 `if: github.event_name == 'pull_request'` + `needs: stage1` 존재
  - 4개 coverage report step에 `if: always()` + 각각 다른 name/path 설정 확인
  </verify>
  <done>ci.yml이 push 시 Stage 1(lint+typecheck+unit --affected), PR 시 Stage 2(full suite + coverage gate + 4개 패키지 coverage report 코멘트)를 실행하며, cancel-in-progress로 동일 PR 이전 실행을 자동 취소</done>
</task>

</tasks>

<verification>
1. `.github/actions/setup/action.yml` 존재하고 composite action 구조가 올바른가
2. `.github/workflows/ci.yml` 존재하고 push/PR 트리거 + 2개 job(stage1, stage2) 구조인가
3. `scripts/coverage-gate.sh` 존재하고 bash 문법 검증(`bash -n`) 통과하는가
4. ci.yml에서 `uses: ./.github/actions/setup` 참조가 올바른가
5. ci.yml에서 `bash scripts/coverage-gate.sh` 참조가 올바른가
6. coverage-report steps가 4개 패키지에 대해 올바른 경로를 참조하는가
</verification>

<success_criteria>
- Composite Action이 Node.js 22 + pnpm + Turborepo 캐시 + 의존성 설치를 수행
- ci.yml Stage 1이 push에서 --affected 모드로 lint/typecheck/unit 실행
- ci.yml Stage 2가 PR에서 full suite + coverage gate + 4개 패키지 coverage report 실행
- coverage-gate.sh가 COVERAGE_GATE_MODE 환경변수로 Soft/Hard 모드 전환
- 모든 파일이 GitHub Actions YAML/bash 문법적으로 올바름
</success_criteria>

<output>
After completion, create `.planning/phases/159-cicd-pipeline/159-01-SUMMARY.md`
</output>
