---
phase: 156-security-test-p2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/security/extension/token-policy-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/extension/contract-whitelist-attacks.security.test.ts
  - packages/daemon/src/__tests__/security/extension/approve-attacks.security.test.ts
autonomous: true

must_haves:
  truths:
    - "ALLOWED_TOKENS 미설정 시 TOKEN_TRANSFER가 기본 거부된다"
    - "ALLOWED_TOKENS에 없는 토큰 전송이 거부된다"
    - "CONTRACT_WHITELIST 미설정 시 CONTRACT_CALL이 기본 거부된다"
    - "METHOD_WHITELIST가 설정된 컨트랙트에서 비허용 메서드 호출이 거부된다"
    - "APPROVED_SPENDERS 미설정 시 APPROVE가 기본 거부된다"
    - "무제한 approve(uint256.max)가 blockUnlimited=true 시 차단된다"
    - "APPROVE_TIER_OVERRIDE가 APPROVE 트랜잭션에 강제 적용된다"
  artifacts:
    - path: "packages/daemon/src/__tests__/security/extension/token-policy-attacks.security.test.ts"
      provides: "SEC-06 토큰 정책 보안 시나리오 32건"
      min_lines: 300
    - path: "packages/daemon/src/__tests__/security/extension/contract-whitelist-attacks.security.test.ts"
      provides: "SEC-07 컨트랙트 화이트리스트 보안 시나리오 28건"
      min_lines: 250
    - path: "packages/daemon/src/__tests__/security/extension/approve-attacks.security.test.ts"
      provides: "SEC-08 Approve 관리 보안 시나리오 24건"
      min_lines: 250
  key_links:
    - from: "token-policy-attacks.security.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluatePolicy/evaluate with type TOKEN_TRANSFER"
      pattern: "engine\\.evaluate.*TOKEN_TRANSFER"
    - from: "contract-whitelist-attacks.security.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluatePolicy/evaluate with type CONTRACT_CALL"
      pattern: "engine\\.evaluate.*CONTRACT_CALL"
    - from: "approve-attacks.security.test.ts"
      to: "DatabasePolicyEngine"
      via: "evaluatePolicy/evaluate with type APPROVE"
      pattern: "engine\\.evaluate.*APPROVE"
---

<objective>
토큰 정책(SEC-06, 32건) + 컨트랙트 화이트리스트(SEC-07, 28건) + Approve 관리(SEC-08, 24건) 보안 공격 시나리오 84건을 테스트로 검증한다.

Purpose: 확장 정책 타입(ALLOWED_TOKENS, CONTRACT_WHITELIST, METHOD_WHITELIST, APPROVED_SPENDERS, APPROVE_AMOUNT_LIMIT, APPROVE_TIER_OVERRIDE)의 우회 공격 벡터를 방어함을 증명한다.
Output: 3개 보안 테스트 파일 (extension/ 디렉토리)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/155-security-test-p1/155-01-SUMMARY.md

# 핵심 구현 파일
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/__tests__/security/helpers/security-test-helpers.ts

# 기존 보안 테스트 패턴 참조
@packages/daemon/src/__tests__/security/layer2-policy/policy-bypass-attacks.security.test.ts

# 보안 시나리오 정의 (doc 64, 섹션 7)
@docs/64-extension-test-strategy.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SEC-06 토큰 정책 보안 32건 + SEC-07 컨트랙트 화이트리스트 보안 28건</name>
  <files>
    packages/daemon/src/__tests__/security/extension/token-policy-attacks.security.test.ts
    packages/daemon/src/__tests__/security/extension/contract-whitelist-attacks.security.test.ts
  </files>
  <action>
155-01 패턴(DatabasePolicyEngine + createInMemoryDb + insertPolicy)을 따라 두 테스트 파일을 생성한다.

**token-policy-attacks.security.test.ts (SEC-06, 32건):**

Setup: createInMemoryDb() -> insertTestWallet() -> new DatabasePolicyEngine(conn.db)
트랜잭션 헬퍼: `tokenTx(tokenAddress, amount)` -> `{ type: 'TOKEN_TRANSFER', tokenAddress, amount, toAddress, chain }`

시나리오 구성 (~32건):
1. SEC-06-01: ALLOWED_TOKENS 미설정 -> TOKEN_TRANSFER 기본 거부 (allowed=false)
2. SEC-06-02: ALLOWED_TOKENS에 없는 토큰 전송 -> 거부
3. SEC-06-03: ALLOWED_TOKENS에 있는 토큰 -> 허용 (SPENDING_LIMIT 평가로 진행)
4. SEC-06-04: 대소문자 다른 토큰 주소 (0xAbCd vs 0xabcd) -> case-insensitive 매칭 확인
5. SEC-06-05: 빈 tokens 배열 -> 모든 TOKEN_TRANSFER 거부
6. SEC-06-06: 비활성(enabled=false) ALLOWED_TOKENS 정책 -> 기본 거부 동작
7. SEC-06-07: 글로벌 정책 vs 월렛 정책 오버라이드 (4-level priority 검증)
8. SEC-06-08: EVM 체크섬 주소 vs 소문자 주소 매칭
9. SEC-06-09: Solana 토큰 민트 주소 매칭 (base58)
10. SEC-06-10: 네트워크 스코핑 (mainnet ALLOWED_TOKENS이 devnet에서 적용 안됨)
11. SEC-06-11: uint256 max 토큰 금액 -> bigint 범위 검증 (SEC-TOKEN-07)
12. SEC-06-12: 토큰 주소에 공백/특수문자 삽입 시도 -> 매칭 실패
13. SEC-06-13: TRANSFER 타입에 ALLOWED_TOKENS 비적용 (네이티브 전송은 무관)
14. SEC-06-14: 한 토큰 허용, 다른 토큰 거부 (동일 월렛)
15. SEC-06-15: 다중 정책 중 가장 높은 priority의 ALLOWED_TOKENS 적용
16. SEC-06-16~32: 경계값 변형 (주소 길이 0/최대, 금액 0/최소/최대, 복수 토큰 등록 등 ~17건)

**contract-whitelist-attacks.security.test.ts (SEC-07, 28건):**

Setup: 동일 패턴
트랜잭션 헬퍼: `contractTx(contractAddress, method?)` -> `{ type: 'CONTRACT_CALL', contractAddress, methodSelector, chain }`

시나리오 구성 (~28건):
1. SEC-07-01: CONTRACT_WHITELIST 미설정 -> CONTRACT_CALL 기본 거부 (SEC-CTR-01)
2. SEC-07-02: 비화이트리스트 컨트랙트 -> 거부
3. SEC-07-03: 화이트리스트 컨트랙트 -> 허용
4. SEC-07-04: METHOD_WHITELIST 설정 + 비허용 메서드 호출 -> 거부 (SEC-CTR-02)
5. SEC-07-05: METHOD_WHITELIST 설정 + 허용 메서드 호출 -> 허용
6. SEC-07-06: METHOD_WHITELIST 미설정 (CONTRACT_WHITELIST만) -> 모든 메서드 허용
7. SEC-07-07: 대소문자 다른 컨트랙트 주소 -> case-insensitive 매칭
8. SEC-07-08: 빈 contracts 배열 -> 모든 CONTRACT_CALL 거부
9. SEC-07-09: 비활성 CONTRACT_WHITELIST -> 기본 거부
10. SEC-07-10: 글로벌 vs 월렛 오버라이드 우선순위
11. SEC-07-11: 네트워크 스코핑 (mainnet 화이트리스트가 devnet에 무효)
12. SEC-07-12: 주소에 악의적 문자 삽입 우회 시도
13. SEC-07-13: TOKEN_TRANSFER 타입에 CONTRACT_WHITELIST 비적용
14. SEC-07-14: METHOD_WHITELIST의 selectors 형식 (4바이트 hex)
15. SEC-07-15: 동일 컨트랙트에 대해 복수 METHOD_WHITELIST 정책
16. SEC-07-16~28: 경계값 변형 (selectors 배열 비어있음, 다중 컨트랙트, value 첨부 CONTRACT_CALL 등 ~13건)

DatabasePolicyEngine의 evaluate() 메서드를 호출하고, 반환된 PolicyEvaluation의 allowed, tier, reason을 검증한다. 155-01 패턴처럼 BigInt 리터럴, case-insensitive 검증, 대소문자 우회 벡터를 포함한다.

참고: WHITELIST은 EVM/Solana 모두 case-insensitive (155-01 결정사항). insertPolicy 헬퍼를 사용하여 정책 삽입.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/extension/token-policy-attacks.security.test.ts packages/daemon/src/__tests__/security/extension/contract-whitelist-attacks.security.test.ts --reporter=verbose` 실행하여 전체 60건 통과 확인.
  </verify>
  <done>
SEC-06 토큰 정책 보안 32건 + SEC-07 컨트랙트 화이트리스트 보안 28건 = 60건 보안 시나리오 테스트가 모두 통과한다. ALLOWED_TOKENS/CONTRACT_WHITELIST/METHOD_WHITELIST 기본 거부, 대소문자 우회, 네트워크 스코핑, 비활성 정책 등 우회 벡터가 모두 방어됨이 증명된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: SEC-08 Approve 관리 보안 24건</name>
  <files>
    packages/daemon/src/__tests__/security/extension/approve-attacks.security.test.ts
  </files>
  <action>
동일한 155-01 패턴으로 Approve 보안 테스트를 생성한다.

**approve-attacks.security.test.ts (SEC-08, 24건):**

Setup: createInMemoryDb() -> insertTestWallet() -> new DatabasePolicyEngine(conn.db)
트랜잭션 헬퍼: `approveTx(spender, amount)` -> `{ type: 'APPROVE', spenderAddress, amount, tokenAddress, chain }`

시나리오 구성 (~24건):
1. SEC-08-01: APPROVED_SPENDERS 미설정 -> APPROVE 기본 거부 (SEC-APR-03)
2. SEC-08-02: 비허가 spender -> 거부
3. SEC-08-03: 허가된 spender -> 허용
4. SEC-08-04: uint256.max approve + blockUnlimited=true -> 무제한 차단 (SEC-APR-01, EVM)
5. SEC-08-05: u64.max approve + blockUnlimited=true -> 무제한 차단 (SEC-APR-02, Solana)
6. SEC-08-06: blockUnlimited=false -> 무제한 approve 허용
7. SEC-08-07: APPROVE_AMOUNT_LIMIT maxAmount 초과 -> 거부
8. SEC-08-08: APPROVE_AMOUNT_LIMIT maxAmount 이하 -> 허용
9. SEC-08-09: APPROVE_TIER_OVERRIDE tier='APPROVAL' -> APPROVE에 강제 적용
10. SEC-08-10: APPROVE_TIER_OVERRIDE tier='DELAY' -> DELAY 티어 강제
11. SEC-08-11: APPROVE_TIER_OVERRIDE 미설정 -> 기본 APPROVAL 티어 사용
12. SEC-08-12: 비활성 APPROVED_SPENDERS -> 기본 거부
13. SEC-08-13: 대소문자 다른 spender 주소 -> case-insensitive 매칭
14. SEC-08-14: 글로벌 vs 월렛 오버라이드 우선순위
15. SEC-08-15: 네트워크 스코핑 (mainnet APPROVED_SPENDERS가 devnet에 무효)
16. SEC-08-16: maxAmount가 있는 spender -> 해당 금액 초과 거부
17. SEC-08-17: maxAmount가 없는 spender -> 금액 제한 없음 (blockUnlimited만 적용)
18. SEC-08-18: UNLIMITED_THRESHOLD 경계값 (uint256.max/2 - 1, 정확히, +1)
19. SEC-08-19: TRANSFER 타입에 APPROVED_SPENDERS 비적용
20. SEC-08-20: 빈 spenders 배열 -> 모든 APPROVE 거부
21. SEC-08-21: 동일 spender에 복수 APPROVED_SPENDERS 정책 (priority 우선)
22. SEC-08-22~24: APPROVE_DISABLED 전면 거부 (SEC-APR-06), approve 0 리셋 허용, 경계값 변형 3건

UNLIMITED_THRESHOLD = (2n ** 256n - 1n) / 2n 을 database-policy-engine.ts에서 확인. 이 값 기준으로 blockUnlimited 판별 테스트를 작성한다.

참고: APPROVED_SPENDERS의 rules JSON은 `{ spenders: [{ address, name?, maxAmount? }] }` 형식. APPROVE_AMOUNT_LIMIT의 rules JSON은 `{ maxAmount?, blockUnlimited }` 형식. APPROVE_TIER_OVERRIDE의 rules JSON은 `{ tier: 'APPROVAL' }` 형식.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/security/extension/approve-attacks.security.test.ts --reporter=verbose` 실행하여 24건 통과 확인. 이어서 `pnpm vitest run packages/daemon/src/__tests__/security/extension/ --reporter=verbose` 실행하여 전체 84건 통과 확인.
  </verify>
  <done>
SEC-08 Approve 관리 보안 24건이 모두 통과하며, 156-01 전체 84건(SEC-06 32건 + SEC-07 28건 + SEC-08 24건)이 통과한다. 무제한 approve 차단, APPROVED_SPENDERS 기본 거부, APPROVE_TIER_OVERRIDE 강제 적용 등 Approve 우회 공격이 모두 방어됨이 증명된다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/daemon/src/__tests__/security/extension/ --reporter=verbose` -> 84건 전체 통과
2. `pnpm test:security` -> Phase 155 기존 131건 + Phase 156-01 84건 = 215건+ 통과 (기존 테스트 깨지지 않음)
</verification>

<success_criteria>
1. SEC-06 토큰 정책 보안 32건이 모두 통과한다 (ALLOWED_TOKENS 기본 거부, 대소문자 우회, 네트워크 스코핑)
2. SEC-07 컨트랙트 화이트리스트 보안 28건이 모두 통과한다 (CONTRACT_WHITELIST/METHOD_WHITELIST 기본 거부)
3. SEC-08 Approve 관리 보안 24건이 모두 통과한다 (무제한 approve 차단, APPROVED_SPENDERS 기본 거부)
4. 기존 보안 테스트(Phase 155)가 깨지지 않는다
</success_criteria>

<output>
After completion, create `.planning/phases/156-security-test-p2/156-01-SUMMARY.md`
</output>
