---
phase: 154-blockchain-3level
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/adapters/solana/src/__tests__/chain/mock-rpc.chain.test.ts
  - packages/adapters/solana/src/__tests__/chain/solana-local-validator.chain.test.ts
  - packages/adapters/solana/src/__tests__/chain/helpers/mock-rpc-transport.ts
  - packages/adapters/solana/src/__tests__/chain/helpers/validator-setup.ts
autonomous: true
must_haves:
  truths:
    - "Level 1 Mock RPC 13개 시나리오가 외부 의존 없이 <2초 안에 모두 통과한다"
    - "Level 2 solana-test-validator E2E 5개 흐름이 SOL 전송/잔액/주소/연결/에러 복구를 실제 온체인에서 검증한다"
    - "pnpm test:chain --filter @waiaas/adapter-solana 실행으로 두 레벨 테스트가 모두 실행된다"
  artifacts:
    - path: "packages/adapters/solana/src/__tests__/chain/mock-rpc.chain.test.ts"
      provides: "Level 1 Mock RPC 13개 시나리오 테스트"
      contains: "13 test cases covering all SolanaAdapter error paths"
    - path: "packages/adapters/solana/src/__tests__/chain/solana-local-validator.chain.test.ts"
      provides: "Level 2 Local Validator E2E 5개 흐름"
      contains: "E2E-1~5 given-when-then flows"
    - path: "packages/adapters/solana/src/__tests__/chain/helpers/mock-rpc-transport.ts"
      provides: "createMockRpcTransport factory (stateless/stateful)"
      exports: ["createMockRpcTransport"]
    - path: "packages/adapters/solana/src/__tests__/chain/helpers/validator-setup.ts"
      provides: "solana-test-validator health check + airdrop helpers"
      exports: ["waitForValidator", "airdropSol"]
  key_links:
    - from: "mock-rpc.chain.test.ts"
      to: "SolanaAdapter"
      via: "vi.mock(@solana/kit) with canned RPC responses"
      pattern: "vi\\.mock.*@solana/kit"
    - from: "solana-local-validator.chain.test.ts"
      to: "SolanaAdapter"
      via: "real connect('http://127.0.0.1:8899')"
      pattern: "adapter\\.connect.*127\\.0\\.0\\.1"
---

<objective>
Level 1 Mock RPC 13개 시나리오 + Level 2 Solana Local Validator E2E 5개 흐름 테스트 구현

Purpose: 설계 문서 48의 CHAIN-01, CHAIN-02 요구사항을 충족하여 SolanaAdapter의 모든 에러 경로와 실제 온체인 동작을 계층적으로 검증한다.
Output: 2개 테스트 파일 (mock-rpc 13건 + local-validator 5 E2E) + 2개 헬퍼 모듈
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.7-quality-cicd.md
@docs/v0.4/48-blockchain-test-environment-strategy.md
@packages/adapters/solana/src/adapter.ts
@packages/adapters/solana/src/__tests__/solana-adapter.test.ts
@packages/core/src/errors/chain-error.ts
@packages/core/src/interfaces/IChainAdapter.ts
@packages/core/src/interfaces/chain-adapter.types.ts
@.planning/phases/151-coverage-mock-infra/151-01-SUMMARY.md
@.planning/phases/153-contract-test/153-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mock RPC Transport 헬퍼 + Level 1 Mock RPC 13개 시나리오</name>
  <files>
    packages/adapters/solana/src/__tests__/chain/helpers/mock-rpc-transport.ts
    packages/adapters/solana/src/__tests__/chain/mock-rpc.chain.test.ts
  </files>
  <action>
    **1) createMockRpcTransport 헬퍼 생성** (`helpers/mock-rpc-transport.ts`)

    설계 문서 48 섹션 2.3의 팩토리 함수를 구현한다. 기존 solana-adapter.test.ts의 vi.mock 패턴과 달리, 이 헬퍼는 RPC Transport 레벨에서 canned response를 주입하는 패턴이다.

    **단, SolanaAdapter는 생성자에서 network만 받고 connect(rpcUrl)에서 createSolanaRpc를 호출하는 구조이므로**, 실제 Mock 주입은 기존 테스트와 동일하게 `vi.mock('@solana/kit')` + `vi.hoisted()` 패턴을 사용한다. mock-rpc-transport.ts는 13개 시나리오의 canned response 세트를 제공하는 팩토리로 구현한다.

    ```typescript
    // 타입 정의
    type CannedResponse = {
      method: string;
      result?: unknown;       // 정상 응답
      error?: { code: number; message: string }; // 에러 응답
      delay?: number;          // ms
    };

    interface MockRpcConfig {
      mode: 'stateless' | 'stateful';
      responses: CannedResponse[];
    }

    // calls 배열로 호출 검증 지원
    interface MockRpcResult {
      mockRpc: Record<string, ReturnType<typeof vi.fn>>;
      calls: Array<{ method: string; params: unknown }>;
      resetCalls(): void;
    }

    export function createMockRpcConfig(config: MockRpcConfig): MockRpcResult;
    ```

    - stateless 모드: method 이름으로 매칭, 동일 메서드 반복 호출 시 같은 응답
    - stateful 모드: 큐에서 순차 소비 (시나리오 1의 6단계 흐름 등)
    - calls 배열에 모든 호출 기록 (method + params)
    - delay 지원: setTimeout으로 지연 시뮬레이션 (시나리오 10 RPC 타임아웃)

    **2) Level 1 Mock RPC 13개 시나리오 테스트** (`mock-rpc.chain.test.ts`)

    기존 solana-adapter.test.ts의 vi.mock 패턴을 따르되, 설계 문서 48 섹션 2.2의 13개 시나리오를 정확히 구현한다. 기존 테스트와 중복되는 부분이 있지만 이 테스트의 목적은 "ChainError 에러 코드 정확성 + 3-category 매핑"이다.

    **중요한 차이점:** 기존 테스트는 WAIaaSError를 검증하지만, 이 테스트는 ChainError (Stage 5 변환 전)를 검증한다. 단, SolanaAdapter가 내부에서 이미 WAIaaSError로 래핑하는 경우 해당 에러의 code를 확인한다. 실제 adapter.ts 코드를 읽고 에러 래핑 방식에 맞춰 assertion을 작성한다.

    **13개 시나리오 명세** (설계 문서 48 섹션 2.2 준수):

    ```
    #1  SOL 전송 전체 흐름 (성공) — stateful, 6단계 RPC 호출 순차 소비
        connect -> buildTransaction -> simulateTransaction -> signTransaction -> submitTransaction -> waitForConfirmation
        검증: 각 단계 반환 타입/값, calls 배열 순서 확인

    #2  잔액 조회 (성공) — stateless
        getBalance -> BalanceInfo { balance: 5_000_000_000n, decimals: 9, symbol: 'SOL' }

    #3  수수료 추정 (성공) — stateless
        estimateFee -> fee >= 5000n (base fee), typeof fee === 'bigint'

    #4  RPC 연결 실패 — stateful (getHealth 3회 실패)
        connect -> throw (에러 코드 확인, adapter.isConnected() === false)
        NOTE: SolanaAdapter.connect()의 실제 동작 확인 필요 — connect는 단순히 rpcUrl 저장 후 isConnected=true 설정일 수 있음. 실제 코드 동작에 맞춰 테스트 조정.

    #5  잔액 부족 (InsufficientFundsForFee) — stateful
        buildTransaction 성공 후 simulateTransaction에서 err: 'InsufficientFundsForFee'
        검증: INSUFFICIENT_BALANCE 또는 대응 에러 코드

    #6  Blockhash 만료 (BlockhashNotFound) — stateful
        sendTransaction에서 error: { code: -32002, message: "Blockhash not found" }
        검증: BLOCKHASH_EXPIRED 또는 대응 에러 코드, retryable === true

    #7  유효하지 않은 주소 — stateless (RPC 호출 없음)
        isValidAddress("not-a-valid-address") === false
        isValidAddress("") === false
        isValidAddress("0x742d35Cc") === false
        buildTransaction({ from: "invalid", ... }) -> throw INVALID_ADDRESS

    #8  시뮬레이션 실패 (프로그램 에러) — stateful
        simulateTransaction에서 err: { InstructionError: [0, { Custom: 1 }] }
        검증: success === false 또는 에러 throw

    #9  트랜잭션 실행 실패 — stateful
        getSignatureStatuses에서 err: { InstructionError: [0, "InvalidAccountData"] }
        검증: TRANSACTION_FAILED 또는 대응 에러 코드

    #10 RPC 타임아웃 — stateless
        getBalance에서 5초 delay 후 에러 throw
        검증: RPC_ERROR 또는 CHAIN_ERROR, retryable === true
        NOTE: vitest의 vi.useFakeTimers() 사용하여 실제 5초 대기 회피

    #11 Priority Fee 조회 실패 시 기본값 — stateless
        getRecentPrioritizationFees 에러 -> fee === 5000n (base fee만)
        NOTE: estimateFee 또는 buildTransaction 내부에서 fallback 동작 확인

    #12 확인 대기 타임아웃 — stateful (getSignatureStatuses 반복 null)
        waitForConfirmation(txHash, 100) — 짧은 타임아웃
        검증: status === 'submitted' (기존 테스트에서 이미 확인된 동작) 또는 timeout 에러

    #13 이미 처리된 트랜잭션 (중복 제출) — stateless
        sendTransaction에서 error: "Transaction already processed"
        검증: TRANSACTION_FAILED 또는 DUPLICATE_TRANSACTION
    ```

    **테스트 파일 구조:**
    - `describe('Level 1: Mock RPC 시나리오')` 최상위
    - 각 시나리오별 `describe('#N: 시나리오명')`
    - vi.mock('@solana/kit') 패턴으로 mockRpc 제어 (기존 solana-adapter.test.ts 패턴 참조)
    - Ed25519 키페어는 beforeAll에서 1회 생성 (기존 generateTestFixtures 패턴 재사용)
    - 각 시나리오에서 ChainError 코드, category, retryable 속성 검증

    **주의사항:**
    - SolanaAdapter는 connect()에서 실제 RPC 호출을 하지 않음 (rpcUrl 저장만). getHealth()가 실제 RPC 호출. 시나리오 4는 getHealth() 실패로 조정 필요.
    - 실제 adapter.ts 코드의 에러 래핑 방식을 확인하고 assertion 타입을 맞춘다 (ChainError vs WAIaaSError).
    - 기존 solana-adapter.test.ts와 같은 vi.hoisted() + vi.mock() 패턴 사용.
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/adapters/solana/src/__tests__/chain/mock-rpc.chain.test.ts` -- 13개 시나리오 전체 통과, 외부 RPC 호출 없음 (모두 Mock), 실행 시간 <5초
  </verify>
  <done>
    Level 1 Mock RPC 13개 시나리오가 SOL 전송 성공/잔액 조회/수수료 추정/RPC 실패/잔액 부족/Blockhash 만료/무효 주소/시뮬레이션 실패/실행 실패/RPC 타임아웃/Priority Fee 폴백/확인 대기 타임아웃/중복 제출 모든 에러 경로를 검증하며 외부 의존 없이 통과한다
  </done>
</task>

<task type="auto">
  <name>Task 2: Level 2 Solana Local Validator E2E 5개 흐름</name>
  <files>
    packages/adapters/solana/src/__tests__/chain/helpers/validator-setup.ts
    packages/adapters/solana/src/__tests__/chain/solana-local-validator.chain.test.ts
  </files>
  <action>
    **1) Validator 셋업 헬퍼** (`helpers/validator-setup.ts`)

    solana-test-validator가 실행 중인지 확인하고, airdrop 요청을 수행하는 헬퍼:

    ```typescript
    import { createSolanaRpc } from '@solana/kit';

    const LOCAL_RPC_URL = 'http://127.0.0.1:8899';

    /**
     * solana-test-validator health check 폴링 (최대 30초).
     * validator가 실행 중이 아니면 test.skip 처리를 위해 false 반환.
     */
    export async function isValidatorRunning(
      rpcUrl = LOCAL_RPC_URL,
      maxWaitMs = 5000
    ): Promise<boolean>;

    /**
     * 테스트 계정에 SOL airdrop.
     * Local validator에서는 즉시 처리되므로 confirm 불필요.
     */
    export async function airdropSol(
      address: string,
      lamports: bigint,
      rpcUrl = LOCAL_RPC_URL
    ): Promise<void>;
    ```

    - `isValidatorRunning()`: fetch로 getHealth RPC 호출, "ok" 응답 확인. 실패 시 false 반환 (test.skip에 활용).
    - `airdropSol()`: createSolanaRpc -> requestAirdrop -> send. 짧은 waitForConfirmation 추가 (local validator도 약간의 시간 필요).

    **2) Level 2 E2E 5개 흐름** (`solana-local-validator.chain.test.ts`)

    설계 문서 48 섹션 3.2의 5개 E2E 흐름을 구현한다.

    **전제 조건 처리:**
    - `beforeAll`에서 `isValidatorRunning()` 호출, false면 전체 describe.skip 처리
    - 실행 중이면 SolanaAdapter 인스턴스 생성 + connect + airdrop 10 SOL
    - `--testTimeout=60000` 설정 (vitest.config에서 또는 테스트 내)
    - `--pool=forks --poolOptions.forks.singleFork=true` 또는 테스트 내 sequential 보장

    **describe.skipIf(!validatorRunning) 패턴 사용.**

    ```
    E2E-1: SOL 전송 전체 흐름 (~10초)
      - connect -> buildTransaction(0.001 SOL) -> simulateTransaction -> signTransaction -> submitTransaction -> waitForConfirmation
      - 검증: isConnected===true, tx.chain==='solana', simResult.success===true, signedTx instanceof Uint8Array, txHash Base58 문자열, status==='confirmed'||'finalized'

    E2E-2: 잔액 조회 + 수수료 추정 (~3초)
      - getBalance(airdrop된 계정) -> balance === ~10 SOL (airdrop 금액, 이전 테스트에서 소량 소비 가능)
      - estimateFee({ from, to, amount }) -> fee >= 5000n, typeof fee === 'bigint'
      - 검증: decimals===9, symbol==='SOL'

    E2E-3: 주소 검증 (<1초)
      - isValidAddress(실제 생성된 주소) === true
      - isValidAddress("11111111111111111111111111111111") === true (System Program)
      - isValidAddress("not-valid") === false
      - isValidAddress("") === false
      - isValidAddress("0x742d35Cc...") === false

    E2E-4: 연결 관리 (~2초)
      - 초기 isConnected() === false
      - connect -> isConnected() === true
      - getHealth() -> { healthy: true, latencyMs: number } (latencyMs > 0, < 5000)
      - disconnect -> isConnected() === false

    E2E-5: 에러 복구 — 잔액 부족 시뮬레이션 (~5초)
      - 새 계정 C (airdrop 없음, 잔액 0)
      - buildTransaction({ from: C, to: B, amount: 1_000_000n }) -> 정상 생성 (buildTransaction은 잔액 미확인)
      - simulateTransaction(tx) -> 에러 throw 또는 SimulationResult { success: false }
      - 에러 발생 시 INSUFFICIENT_BALANCE 또는 관련 에러 코드 확인
    ```

    **키페어 생성:** Ed25519 키페어를 @solana/kit의 함수로 생성. beforeAll에서 계정 A, B, C를 생성하고 A에만 airdrop.

    **주의사항:**
    - E2E-1은 이전 테스트의 계정 상태에 의존하지 않도록 별도 airdrop 또는 충분한 초기 잔액 확보
    - E2E-5에서 "잔액 0" 계정은 airdrop 없이 새로 생성한 키페어 사용
    - solana-test-validator가 없으면 전체 skip (CI에서 수동 실행 또는 nightly)
    - 테스트 간 순차 실행 (vitest의 `test.sequential` 또는 `--pool forks --poolOptions.forks.singleFork`)
    - afterAll에서 disconnect 호출
    - 각 E2E 흐름의 테스트 타임아웃은 개별 30초 설정 (`{ timeout: 30_000 }`)
  </action>
  <verify>
    1. `solana-test-validator --reset --quiet --rpc-port 8899 &` 실행 후 `cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/adapters/solana/src/__tests__/chain/solana-local-validator.chain.test.ts` -- 5개 E2E 흐름 전체 통과 (validator 실행 중일 때)
    2. validator 미실행 시 전체 skip (0 tests failed)
    3. `pnpm test:chain --filter @waiaas/adapter-solana` -- Level 1 + Level 2 모두 포함하여 실행 확인
  </verify>
  <done>
    Level 2 solana-test-validator E2E 5개 흐름(SOL 전송/잔액+수수료/주소 검증/연결 관리/에러 복구)이 실제 온체인에서 통과하고, validator 미실행 시 graceful skip된다
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/adapters/solana/src/__tests__/chain/` -- chain/ 디렉토리 전체 테스트 실행
2. Level 1 Mock RPC: 13개 시나리오 전부 PASS, 외부 네트워크 호출 0건
3. Level 2 Local Validator: validator 실행 시 5개 E2E PASS, 미실행 시 5개 SKIP
4. `pnpm test:chain --filter @waiaas/adapter-solana` -- Turborepo 태스크로 실행 가능
</verification>

<success_criteria>
- Level 1 Mock RPC 13개 시나리오가 ChainError 에러 코드/카테고리/retryable 속성을 정확히 검증하며 외부 의존 없이 통과
- Level 2 Local Validator E2E 5개 흐름이 솔라나 4단계 파이프라인(build->simulate->sign->submit->confirm)을 실제 온체인에서 검증
- validator 미실행 시 graceful skip으로 CI 빌드 실패 없음
- test:chain Turborepo 태스크로 통합 실행 가능
</success_criteria>

<output>
After completion, create `.planning/phases/154-blockchain-3level/154-01-SUMMARY.md`
</output>
