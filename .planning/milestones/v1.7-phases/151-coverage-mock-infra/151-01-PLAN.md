---
phase: 151-coverage-mock-infra
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.workspace.ts
  - package.json
  - turbo.json
  - packages/core/vitest.config.ts
  - packages/daemon/vitest.config.ts
  - packages/cli/vitest.config.ts
  - packages/sdk/vitest.config.ts
  - packages/mcp/vitest.config.ts
  - packages/admin/vitest.config.ts
  - packages/adapters/solana/vitest.config.ts
  - packages/adapters/evm/vitest.config.ts
  - packages/core/package.json
  - packages/daemon/package.json
  - packages/cli/package.json
  - packages/sdk/package.json
  - packages/mcp/package.json
  - packages/admin/package.json
  - packages/adapters/solana/package.json
  - packages/adapters/evm/package.json
autonomous: true

must_haves:
  truths:
    - "pnpm test:unit 명령으로 전 패키지 유닛 테스트가 vitest workspace 기반으로 한 번에 실행된다"
    - "각 패키지의 커버리지 리포트가 v8 프로바이더로 생성되며, 패키지별 Hard 임계값이 설정되어 있다"
    - "test:unit, test:integration, test:security, test:chain, test:platform 5개 Turborepo 태스크가 분리 실행된다"
  artifacts:
    - path: "vitest.workspace.ts"
      provides: "Vitest workspace root config with all packages"
      contains: "defineWorkspace"
    - path: "turbo.json"
      provides: "5 test task definitions"
      contains: "test:unit"
    - path: "package.json"
      provides: "Root test:unit script"
      contains: "test:unit"
    - path: "packages/core/vitest.config.ts"
      provides: "Core coverage thresholds (90%+)"
      contains: "thresholds"
  key_links:
    - from: "package.json"
      to: "turbo.json"
      via: "pnpm test:unit -> turbo run test:unit"
      pattern: "turbo run test:unit"
    - from: "turbo.json"
      to: "packages/*/package.json"
      via: "turbo task -> package scripts"
      pattern: "test:unit.*vitest"
    - from: "packages/*/vitest.config.ts"
      to: "@vitest/coverage-v8"
      via: "coverage provider config"
      pattern: "provider.*v8"
---

<objective>
Vitest workspace 커버리지 인프라 구축 + Turborepo 5개 테스트 태스크 분리

Purpose: 전체 테스트 스위트를 단일 명령으로 실행하고, 패키지별 커버리지 임계값으로 품질을 보장하며, 테스트 유형별로 독립 실행할 수 있는 기반을 만든다.
Output: 업데이트된 vitest.workspace.ts, 8개 패키지 vitest.config.ts (커버리지 설정), turbo.json (5개 태스크), 8개 패키지 package.json (5개 스크립트)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@objectives/v1.7-quality-cicd.md

# Existing configs to modify
@vitest.workspace.ts
@turbo.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vitest workspace 커버리지 설정 + 패키지별 임계값</name>
  <files>
    vitest.workspace.ts
    packages/core/vitest.config.ts
    packages/daemon/vitest.config.ts
    packages/cli/vitest.config.ts
    packages/sdk/vitest.config.ts
    packages/mcp/vitest.config.ts
    packages/admin/vitest.config.ts
    packages/adapters/solana/vitest.config.ts
    packages/adapters/evm/vitest.config.ts
  </files>
  <action>
    1. vitest.workspace.ts는 현재 이미 올바르게 설정되어 있다 (packages/*/vitest.config.ts + packages/adapters/*/vitest.config.ts). 변경 불필요하면 유지.

    2. 각 패키지의 vitest.config.ts에 v8 커버리지 설정을 추가한다. 기존 설정(globals, passWithNoTests, pool, environment 등)은 반드시 보존.

    커버리지 설정 패턴 (각 패키지의 test 블록 내):
    ```ts
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json-summary', 'json'],
      reportsDirectory: './coverage',
      include: ['src/**/*.ts'],
      exclude: ['src/**/__tests__/**', 'src/**/*.test.ts', 'src/**/index.ts'],
      thresholds: {
        branches: XX,
        functions: YY,
        lines: ZZ,
        statements: ZZ,
      },
    },
    ```

    패키지별 임계값 (objectives/v1.7-quality-cicd.md 기준):
    - @waiaas/core: branches=85, functions=90, lines=90, statements=90 (Critical 90%+)
    - @waiaas/daemon: branches=80, functions=85, lines=85, statements=85 (High 85%+). 주의: pool:'forks', poolOptions 유지 필수.
    - @waiaas/adapter-solana: branches=75, functions=80, lines=80, statements=80 (High 80%+)
    - @waiaas/adapter-evm: branches=45, functions=50, lines=50, statements=50 (Low 50%+)
    - @waiaas/sdk: branches=75, functions=80, lines=80, statements=80 (High 80%+)
    - @waiaas/cli: branches=65, functions=70, lines=70, statements=70 (Normal 70%+). 주의: pool:'forks', poolOptions, testTimeout 유지 필수.
    - @waiaas/mcp: branches=65, functions=70, lines=70, statements=70 (Normal 70%+)
    - @waiaas/admin: branches=65, functions=70, lines=70, statements=70 (Normal 70%+). 주의: plugins, environment:'jsdom', setupFiles 유지 필수.

    주의: 현재 커버리지가 임계값에 미달할 수 있으므로, 지금은 임계값 설정만 하고 `--coverage` 플래그로 실행할 때만 체크되도록 한다. vitest.config.ts에 thresholds를 넣되, 기본 `vitest run`에서는 커버리지가 활성화되지 않으므로 기존 테스트 실행에 영향 없다.

    3. 커버리지 디렉토리 .gitignore 확인: 루트 .gitignore에 `coverage/` 패턴이 없으면 추가한다.
  </action>
  <verify>
    1. `pnpm -r exec -- node -e "const c = require('./vitest.config.ts'); console.log('ok')"` 대신, 각 패키지의 vitest.config.ts 파일이 문법 오류 없이 존재하는지 확인: `pnpm vitest --version` (vitest CLI 동작 확인)
    2. `pnpm --filter @waiaas/core exec -- npx vitest run --coverage 2>&1 | head -5` 로 v8 커버리지가 생성되는지 확인 (출력에 "Coverage report" 또는 커버리지 테이블 포함)
    3. `grep -r "thresholds" packages/*/vitest.config.ts packages/adapters/*/vitest.config.ts | wc -l` 결과가 8 (모든 패키지에 thresholds 존재)
  </verify>
  <done>
    8개 패키지 모두 vitest.config.ts에 v8 커버리지 provider, reporter, include/exclude, thresholds가 설정되어 있다. `--coverage` 플래그로 실행 시 커버리지 리포트가 생성되며 임계값 미달 시 실패한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: Turborepo 5개 테스트 태스크 분리 + 패키지 스크립트</name>
  <files>
    turbo.json
    package.json
    packages/core/package.json
    packages/daemon/package.json
    packages/cli/package.json
    packages/sdk/package.json
    packages/mcp/package.json
    packages/admin/package.json
    packages/adapters/solana/package.json
    packages/adapters/evm/package.json
  </files>
  <action>
    1. turbo.json에 5개 테스트 태스크를 추가한다. 기존 `test`, `build`, `lint`, `typecheck`, `clean` 태스크는 유지.

    ```json
    "test:unit": {
      "dependsOn": ["build"],
      "outputs": ["coverage/**"]
    },
    "test:integration": {
      "dependsOn": ["build"],
      "outputs": []
    },
    "test:security": {
      "dependsOn": ["build"],
      "outputs": []
    },
    "test:chain": {
      "dependsOn": ["build"],
      "outputs": []
    },
    "test:platform": {
      "dependsOn": ["build"],
      "outputs": []
    }
    ```

    2. 루트 package.json scripts에 5개 태스크 명령을 추가:
    ```json
    "test:unit": "turbo run test:unit",
    "test:integration": "turbo run test:integration",
    "test:security": "turbo run test:security",
    "test:chain": "turbo run test:chain",
    "test:platform": "turbo run test:platform"
    ```
    기존 `"test": "turbo test"` 스크립트는 유지한다 (backward compat).

    3. 각 패키지의 package.json scripts에 5개 스크립트를 추가한다. 파일 패턴으로 분리:
    - `test:unit`: `vitest run` (기존 `test`와 동일, 기본 테스트 파일)
    - `test:integration`: `vitest run --dir src/__tests__/integration 2>/dev/null || true` (디렉토리 없으면 성공)
    - `test:security`: `vitest run --dir src/__tests__/security 2>/dev/null || true`
    - `test:chain`: `vitest run --dir src/__tests__/chain 2>/dev/null || true`
    - `test:platform`: `vitest run --dir src/__tests__/platform 2>/dev/null || true`

    주의사항:
    - 현재 security/, chain/, platform/, integration/ 디렉토리는 아직 존재하지 않는다 (후속 Phase 153~158에서 생성). 따라서 디렉토리가 없을 때 graceful하게 성공해야 한다.
    - `|| true` 대신 vitest의 `passWithNoTests: true`가 이미 설정되어 있으므로, `--dir`에 존재하지 않는 디렉토리를 넘기면 에러가 발생할 수 있다. 이 경우 각 패키지에서 `vitest run --passWithNoTests` 형태로 쉘에서 디렉토리 존재 확인 후 실행하는 패턴을 사용:
      ```
      "test:security": "[ -d src/__tests__/security ] && vitest run --dir src/__tests__/security || true"
      ```
    - 기존 `"test": "vitest run"` 스크립트는 유지한다.
    - admin 패키지는 lint 스크립트가 없으므로 다른 패키지와 동일 패턴 유지.
  </action>
  <verify>
    1. `pnpm test:unit 2>&1 | tail -5` 실행하여 전 패키지 테스트가 turbo 기반으로 실행되는지 확인 (Tasks: N successful 출력)
    2. `pnpm test:security 2>&1 | tail -5` 실행하여 에러 없이 완료되는지 확인 (디렉토리 미존재 시에도 성공)
    3. `pnpm test:chain 2>&1 | tail -5` 실행하여 에러 없이 완료되는지 확인
    4. `cat turbo.json | grep -c "test:"` 결과가 5 이상 (5개 테스트 태스크 존재)
  </verify>
  <done>
    turbo.json에 test:unit/test:integration/test:security/test:chain/test:platform 5개 태스크가 정의되고, 루트 package.json과 8개 패키지 package.json에 대응 스크립트가 존재한다. `pnpm test:unit`으로 전 패키지 유닛 테스트가 실행되고, 미래 디렉토리(security/chain/platform)가 없어도 graceful 성공한다.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test:unit 2>&1 | tail -10` -- 전 패키지 유닛 테스트 실행, Tasks: N successful 출력 확인
2. `pnpm test:security` + `pnpm test:chain` + `pnpm test:platform` -- 모두 에러 없이 완료
3. `grep -r "provider.*v8" packages/*/vitest.config.ts packages/adapters/*/vitest.config.ts | wc -l` -- 8개 패키지 모두 v8 커버리지 설정
4. `cat turbo.json | python3 -c "import json,sys; d=json.load(sys.stdin); tasks=[k for k in d['tasks'] if k.startswith('test:')]; print(len(tasks), tasks)"` -- 5개 test: 태스크 확인
</verification>

<success_criteria>
- pnpm test:unit 명령으로 전 패키지 유닛 테스트가 한 번에 실행된다
- 8개 패키지 모두 v8 커버리지 프로바이더 + Hard 임계값이 vitest.config.ts에 설정되어 있다
- 5개 Turborepo 테스트 태스크(test:unit/integration/security/chain/platform)가 독립 실행 가능하다
- 아직 존재하지 않는 테스트 디렉토리(security/chain/platform)를 대상으로 실행해도 에러 없이 성공한다
</success_criteria>

<output>
After completion, create `.planning/phases/151-coverage-mock-infra/151-01-SUMMARY.md`
</output>
