# Requirements Archive: v2.6.1 WAIaaS Wallet Signing SDK

**Archived:** 2026-02-20
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: WAIaaS v2.6.1 Wallet Signing SDK

**Defined:** 2026-02-20
**Core Value:** AI 에이전트가 안전하고 자율적으로 온체인 거래를 수행할 수 있어야 한다 — 동시에 에이전트 주인(사람)이 자금 통제권을 유지하면서.

## v1 Requirements

m26-01 objective + 설계 문서 73-75 기반. v2.6 설계를 코드로 실현.

### Signing Protocol (PROTO)

- [x] **PROTO-01**: PENDING_APPROVAL 트랜잭션에서 SignRequest를 생성하여 유니버셜 링크 URL로 인코딩할 수 있다
- [x] **PROTO-02**: SignRequest를 Zod 스키마로 검증하고 base64url로 인코딩/디코딩할 수 있다
- [x] **PROTO-03**: SignResponse를 수신하여 requestId 매칭, 만료 체크, 서명 검증(ownerAuth 재사용) 후 트랜잭션을 승인/거부할 수 있다
- [x] **PROTO-04**: 만료된 요청(expiresAt 초과)에 대해 SIGN_REQUEST_EXPIRED 에러를 반환한다
- [x] **PROTO-05**: 잘못된 서명값에 대해 INVALID_SIGNATURE 에러를 반환한다

### Signing Channels (CHAN)

- [x] **CHAN-01**: NtfySigningChannel이 ntfy 요청 토픽에 SignRequest를 publish하고 응답 토픽을 subscribe하여 SignResponse를 수신할 수 있다
- [x] **CHAN-02**: NtfySigningChannel이 reject 응답 수신 시 트랜잭션을 CANCELLED 상태로 변경한다
- [x] **CHAN-03**: TelegramSigningChannel이 유니버셜 링크 인라인 버튼이 포함된 메시지를 전송한다
- [x] **CHAN-04**: TelegramSigningChannel이 /sign_response 명령어로 SignResponse를 수신하여 처리한다
- [x] **CHAN-05**: ApprovalChannelRouter가 지갑별 owner_approval_method에 따라 올바른 채널로 라우팅한다
- [x] **CHAN-06**: ApprovalChannelRouter가 owner_approval_method 미설정 시 글로벌 우선순위(SDK ntfy > SDK Telegram > WC > Telegram Bot > REST) fallback한다
- [x] **CHAN-07**: SDK 채널 비활성(signing_sdk.enabled=false) 시 WalletConnect 또는 Telegram Bot으로 fallback한다

### Wallet SDK (SDK)

- [x] **SDK-01**: @waiaas/wallet-sdk 패키지의 parseSignRequest(url)가 유니버셜 링크 URL에서 SignRequest를 추출하고 Zod 검증을 통과한다
- [x] **SDK-02**: buildSignResponse(requestId, action, signature?, address)가 유효한 SignResponse 객체를 생성한다
- [x] **SDK-03**: formatDisplayMessage(request)가 사람이 읽을 수 있는 트랜잭션 요약을 반환한다
- [x] **SDK-04**: sendViaNtfy(response, topic, serverUrl?)가 ntfy 응답 토픽에 HTTP POST로 publish한다
- [x] **SDK-05**: sendViaTelegram(response, botUsername)이 Telegram 딥링크 또는 공유 인텐트 URL을 생성한다
- [x] **SDK-06**: subscribeToRequests(topic, serverUrl?, callback)가 ntfy SSE로 새 서명 요청 수신 시 콜백을 호출한다

### Wallet Settings (WALLET)

- [x] **WALLET-01**: WalletLinkRegistry에 지갑 메타데이터(유니버셜 링크 base URL, 딥링크 스키마)를 등록하고 조회할 수 있다
- [x] **WALLET-02**: 미등록 지갑 조회 시 WALLET_NOT_REGISTERED 에러를 반환한다
- [x] **WALLET-03**: wallets 테이블에 owner_approval_method 컬럼이 추가되고 DB 마이그레이션이 정상 동작한다
- [x] **WALLET-04**: PUT /v1/wallets/:id/owner 요청에 approval_method 필드를 포함하여 승인 방법을 설정할 수 있다
- [x] **WALLET-05**: 유효하지 않은 approval_method 값에 대해 400 에러를 반환한다
- [x] **WALLET-06**: Admin UI 지갑 상세 페이지에서 Owner 승인 방법을 라디오 선택으로 변경할 수 있다
- [x] **WALLET-07**: 미구성 인프라 선택 시(예: ntfy 미설정 + sdk_ntfy) 경고 메시지를 표시한다

### Configuration (CONF)

- [x] **CONF-01**: SettingsService에 signing_sdk.enabled, request_expiry_min, preferred_channel, preferred_wallet, ntfy_request_topic_prefix, ntfy_response_topic_prefix 6개 키가 등록되어 런타임 변경 가능하다
- [x] **CONF-02**: signing_sdk.wallets 키에 JSON 배열로 지갑별 유니버셜 링크 설정을 저장하고 런타임에 CRUD 관리할 수 있다 (Admin UI CRUD는 Phase 203 WALLET-06 범위)

## v2 Requirements

### 후속 확장

- **CHAN-EXT-01**: Slack Socket Mode 양방향 서명 채널
- **CHAN-EXT-02**: Discord Gateway Bot 양방향 서명 채널
- **SEC-01**: ntfy 토픽 Authorization 헤더 기반 접근 제어
- **PARTNER-01**: D'CENT 외 추가 지갑 파트너 SDK 채택

## Out of Scope

| Feature | Reason |
|---------|--------|
| Slack/Discord 양방향 서명 | 기존 인프라에서 양방향 미구현. 별도 마일스톤으로 분리 |
| ntfy 토픽 인증 | 보안 강화 옵션. 초기 구현에서는 requestId UUID v7 + ownerAuth 서명 검증으로 충분 |
| Push Relay Server 구현 | 설계 문서 75에 정의되어 있으나, 데몬↔ntfy 직접 통신으로 우선 구현. Relay는 후속 |
| ERC20 approve + swap 연쇄 서명 | 단일 ContractCallRequest 반환 제약. 후속 배치 서명 프로토콜로 해결 |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| PROTO-01 | Phase 204 | Complete |
| PROTO-02 | Phase 202 | Complete |
| PROTO-03 | Phase 204 | Complete |
| PROTO-04 | Phase 202 | Complete |
| PROTO-05 | Phase 202 | Complete |
| CHAN-01 | Phase 204 | Complete |
| CHAN-02 | Phase 204 | Complete |
| CHAN-03 | Phase 204 | Complete |
| CHAN-04 | Phase 204 | Complete |
| CHAN-05 | Phase 204 | Complete |
| CHAN-06 | Phase 204 | Complete |
| CHAN-07 | Phase 204 | Complete |
| SDK-01 | Phase 202 | Complete |
| SDK-02 | Phase 202 | Complete |
| SDK-03 | Phase 202 | Complete |
| SDK-04 | Phase 202 | Complete |
| SDK-05 | Phase 202 | Complete |
| SDK-06 | Phase 202 | Complete |
| WALLET-01 | Phase 204 | Complete |
| WALLET-02 | Phase 202 | Complete |
| WALLET-03 | Phase 202 | Complete |
| WALLET-04 | Phase 203 | Complete |
| WALLET-05 | Phase 203 | Complete |
| WALLET-06 | Phase 203 | Complete |
| WALLET-07 | Phase 205 | Complete |
| CONF-01 | Phase 205 | Complete |
| CONF-02 | Phase 202 | Complete |

**Coverage:**
- v1 requirements: 27 total
- Mapped to phases: 27
- Satisfied: 15
- Pending (gap closure): 12 (Phase 204: 11, Phase 205: 2)
- Unmapped: 0

---
*Requirements defined: 2026-02-20*
*Last updated: 2026-02-20 after roadmap creation*
