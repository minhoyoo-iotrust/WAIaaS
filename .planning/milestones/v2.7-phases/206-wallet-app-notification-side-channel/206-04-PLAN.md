---
phase: 206-wallet-app-notification-side-channel
plan: 04
type: execute
wave: 3
depends_on: ["206-01", "206-02", "206-03"]
files_modified:
  - packages/admin/src/pages/settings.tsx
  - packages/admin/src/__tests__/settings.test.tsx
  - skills/wallet.skill.md
autonomous: true
requirements:
  - ADMIN-01
  - SYNC-01

must_haves:
  truths:
    - "Admin Settings page shows a 'Wallet App Notifications' section under Signing SDK with notifications_enabled toggle and notify_categories multi-select checkboxes"
    - "6 category checkboxes (transaction, policy, security_alert, session, owner, system) exist with human-readable labels"
    - "Checking/unchecking categories saves as JSON array to signing_sdk.notify_categories"
    - "Empty selection means 'all categories' (UI shows 'All categories' hint)"
    - "wallet.skill.md documents subscribeToNotifications, parseNotification, and NotificationMessage type"
  artifacts:
    - path: "packages/admin/src/pages/settings.tsx"
      provides: "Wallet App Notifications subgroup in SigningSDKSettings"
      contains: "notify_categories"
    - path: "skills/wallet.skill.md"
      provides: "SDK API documentation for notification functions"
      contains: "subscribeToNotifications"
  key_links:
    - from: "packages/admin/src/pages/settings.tsx"
      to: "signing_sdk.notify_categories"
      via: "handleFieldChange('signing_sdk.notify_categories', ...)"
      pattern: "notify_categories"
---

<objective>
Add Wallet App Notification controls to the Admin Settings page and sync the wallet skill file.

Purpose: Enable administrators to control which notification categories reach wallet apps, and document the new SDK functions for AI agents.
Output: Admin UI section with toggle + category checkboxes, updated skill file.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/206-wallet-app-notification-side-channel/206-01-SUMMARY.md
@.planning/phases/206-wallet-app-notification-side-channel/206-02-SUMMARY.md
@.planning/phases/206-wallet-app-notification-side-channel/206-03-SUMMARY.md
@packages/admin/src/pages/settings.tsx
@skills/wallet.skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Wallet App Notifications section to Admin Settings page</name>
  <files>
    packages/admin/src/pages/settings.tsx
    packages/admin/src/__tests__/settings.test.tsx
  </files>
  <action>
1. In `packages/admin/src/pages/settings.tsx`, modify the `SigningSDKSettings()` function to add a "Wallet App Notifications" subgroup AFTER the existing settings-info-box. Add it inside the same `settings-category-body` div:

   a) Define the 6 categories with human-readable labels as a local const:
   ```ts
   const NOTIFY_CATEGORY_OPTIONS = [
     { value: 'transaction', label: 'Transaction Events' },
     { value: 'policy', label: 'Policy Violations' },
     { value: 'security_alert', label: 'Security Alerts' },
     { value: 'session', label: 'Session Events' },
     { value: 'owner', label: 'Owner Events' },
     { value: 'system', label: 'System Notifications' },
   ];
   ```

   b) Add helper to parse the current notify_categories value and handle the checkbox toggle:
   ```tsx
   // Parse current notify_categories JSON array
   const currentCategoriesJson = getEffectiveValue('signing_sdk', 'notify_categories') || '[]';
   let currentCategories: string[] = [];
   try {
     const parsed = JSON.parse(currentCategoriesJson);
     if (Array.isArray(parsed)) currentCategories = parsed;
   } catch { /* use empty */ }

   const handleCategoryToggle = (categoryValue: string, checked: boolean) => {
     let updated: string[];
     if (checked) {
       updated = [...currentCategories, categoryValue];
     } else {
       updated = currentCategories.filter((c) => c !== categoryValue);
     }
     handleFieldChange('signing_sdk.notify_categories', JSON.stringify(updated));
   };
   ```

   c) Add the subgroup UI inside the SigningSDKSettings settings-category-body, after the settings-info-box:
   ```tsx
   <div class="settings-subgroup" style={{ marginTop: '1rem', borderTop: '1px solid var(--border)', paddingTop: '1rem' }}>
     <div class="settings-subgroup-title">Wallet App Notifications</div>
     <p class="settings-description" style={{ marginBottom: '0.75rem' }}>
       Push notifications to wallet apps via ntfy side channel. Only applies to wallets with sdk_ntfy approval method.
     </p>
     <div class="settings-fields-grid">
       <div class="settings-field-full">
         <FormField
           label="Notifications Enabled"
           name="signing_sdk.notifications_enabled"
           type="checkbox"
           value={getEffectiveBoolValue('signing_sdk', 'notifications_enabled')}
           onChange={(v) => handleFieldChange('signing_sdk.notifications_enabled', v)}
         />
       </div>
     </div>
     <div style={{ marginTop: '0.75rem' }}>
       <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: 'var(--font-size-sm)', fontWeight: 600, color: 'var(--text-secondary)' }}>
         Notify Categories {currentCategories.length === 0 && <span style={{ fontWeight: 400, color: 'var(--text-tertiary)' }}>(all categories)</span>}
       </label>
       <div class="settings-fields-grid">
         {NOTIFY_CATEGORY_OPTIONS.map((opt) => (
           <FormField
             key={opt.value}
             label={opt.label}
             name={`notify_cat_${opt.value}`}
             type="checkbox"
             value={currentCategories.includes(opt.value)}
             onChange={(v) => handleCategoryToggle(opt.value, Boolean(v))}
           />
         ))}
       </div>
       <div class="settings-info-box" style={{ marginTop: '0.5rem' }}>
         Select specific categories to receive, or leave all unchecked to receive all notification types.
         Security Alerts are delivered with high priority (ntfy priority 5).
       </div>
     </div>
   </div>
   ```

2. In `packages/admin/src/__tests__/settings.test.tsx` (if it exists), add a test that verifies the "Wallet App Notifications" text appears in the rendered settings page. If the test file uses standard patterns:
   ```ts
   it('renders Wallet App Notifications subgroup in Signing SDK section', () => {
     // After rendering SettingsPage with mock data...
     expect(screen.getByText('Wallet App Notifications')).toBeTruthy();
     expect(screen.getByText('Notifications Enabled')).toBeTruthy();
     expect(screen.getByText('Transaction Events')).toBeTruthy();
     expect(screen.getByText('Security Alerts')).toBeTruthy();
   });
   ```
   Adapt to the existing test patterns in the file.
  </action>
  <verify>
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin run build` -- compiles without errors.
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/admin run test -- --run settings` -- tests pass.
  </verify>
  <done>
    Admin Settings page shows a "Wallet App Notifications" subgroup under Signing SDK with:
    - notifications_enabled checkbox toggle
    - 6 category multi-select checkboxes (transaction, policy, security_alert, session, owner, system)
    - Empty selection = all categories (displayed as hint)
    - Category selections saved as JSON array to signing_sdk.notify_categories
  </done>
</task>

<task type="auto">
  <name>Task 2: Update wallet.skill.md with new SDK functions and notification types</name>
  <files>
    skills/wallet.skill.md
  </files>
  <action>
1. Read the current `skills/wallet.skill.md` and find the appropriate location for SDK documentation.

2. Add a new section at the end (before any "---" footer) documenting the wallet-sdk notification functions:

   ```markdown
   ## Wallet SDK: Notification Functions

   The `@waiaas/wallet-sdk` package provides functions for wallet apps to receive real-time notification events from the WAIaaS daemon.

   ### subscribeToNotifications(topic, callback, serverUrl?)

   Subscribe to notification events via ntfy SSE stream. The daemon pushes notification events (transaction confirmations, policy violations, security alerts, etc.) to `waiaas-notify-{walletName}` ntfy topics.

   ```typescript
   import { subscribeToNotifications } from '@waiaas/wallet-sdk';

   const subscription = subscribeToNotifications(
     'waiaas-notify-trading-bot',   // ntfy topic
     (notification) => {
       console.log(notification.eventType);  // e.g. 'TX_CONFIRMED'
       console.log(notification.category);   // e.g. 'transaction'
       console.log(notification.title);      // Human-readable title
       console.log(notification.body);       // Human-readable body
     },
     'https://ntfy.sh',  // optional, defaults to https://ntfy.sh
   );

   // Later: unsubscribe
   subscription.unsubscribe();
   ```

   ### parseNotification(data)

   Decode and validate a base64url-encoded NotificationMessage. Used internally by `subscribeToNotifications`, but also available for manual parsing.

   ```typescript
   import { parseNotification } from '@waiaas/wallet-sdk';

   const notification = parseNotification(base64urlEncodedString);
   // notification: { version, eventType, walletId, walletName, category, title, body, details?, timestamp }
   ```

   ### NotificationMessage Type

   ```typescript
   interface NotificationMessage {
     version: '1';
     eventType: string;        // One of 26 NotificationEventType values
     walletId: string;         // UUID of the wallet
     walletName: string;       // Human-readable wallet name
     category: 'transaction' | 'policy' | 'security_alert' | 'session' | 'owner' | 'system';
     title: string;            // Notification title
     body: string;             // Notification body
     details?: Record<string, unknown>;  // Optional event-specific details
     timestamp: number;        // Unix epoch seconds
   }
   ```

   ### Notification Categories

   | Category | Events | ntfy Priority |
   |----------|--------|---------------|
   | transaction | TX_REQUESTED, TX_QUEUED, TX_SUBMITTED, TX_CONFIRMED, TX_FAILED, TX_CANCELLED, TX_DOWNGRADED_DELAY, TX_APPROVAL_REQUIRED, TX_APPROVAL_EXPIRED | 3 (default) |
   | policy | POLICY_VIOLATION, CUMULATIVE_LIMIT_WARNING | 3 (default) |
   | security_alert | WALLET_SUSPENDED, KILL_SWITCH_ACTIVATED, KILL_SWITCH_RECOVERED, KILL_SWITCH_ESCALATED, AUTO_STOP_TRIGGERED | **5 (urgent)** |
   | session | SESSION_EXPIRING_SOON, SESSION_EXPIRED, SESSION_CREATED | 3 (default) |
   | owner | OWNER_SET, OWNER_REMOVED, OWNER_VERIFIED | 3 (default) |
   | system | DAILY_SUMMARY, LOW_BALANCE, APPROVAL_CHANNEL_SWITCHED, UPDATE_AVAILABLE | 3 (default) |
   ```

3. Update the skill file `version` in the frontmatter to match the new version (e.g., `"2.7.0-rc.1"` or increment from current).
  </action>
  <verify>
    Visually check that `skills/wallet.skill.md` contains the new section headers:
    - "Wallet SDK: Notification Functions"
    - "subscribeToNotifications"
    - "parseNotification"
    - "NotificationMessage Type"
    - "Notification Categories"
  </verify>
  <done>
    wallet.skill.md documents subscribeToNotifications, parseNotification, NotificationMessage type, and the 6 notification categories with priority information.
    Skill file version updated.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/admin run build` -- compiles
2. `pnpm --filter @waiaas/admin run test` -- all tests pass
3. `skills/wallet.skill.md` contains documentation for subscribeToNotifications, parseNotification, NotificationMessage
</verification>

<success_criteria>
- Admin Settings shows notifications_enabled toggle and 6 category checkboxes under Signing SDK
- Category checkboxes save as JSON array to signing_sdk.notify_categories
- Empty category selection shows "all categories" hint
- wallet.skill.md has complete documentation of new SDK notification functions
</success_criteria>

<output>
After completion, create `.planning/phases/206-wallet-app-notification-side-channel/206-04-SUMMARY.md`
</output>
