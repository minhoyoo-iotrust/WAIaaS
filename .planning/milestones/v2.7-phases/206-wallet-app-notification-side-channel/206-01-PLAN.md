---
phase: 206-wallet-app-notification-side-channel
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/schemas/signing-protocol.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/signing-protocol.test.ts
  - packages/wallet-sdk/src/index.ts
  - packages/daemon/src/infrastructure/settings/setting-keys.ts
  - packages/daemon/src/__tests__/settings-service.test.ts
autonomous: true
requirements:
  - SCHEMA-01
  - SCHEMA-02
  - SCHEMA-03
  - SETTINGS-01
  - SETTINGS-02
  - SETTINGS-03

must_haves:
  truths:
    - "NotificationMessageSchema exists in core signing-protocol.ts with version, eventType, walletId, walletName, category, title, body, timestamp fields"
    - "EVENT_CATEGORY_MAP covers all 26 NotificationEventType values (verified by test)"
    - "NotificationMessage type is re-exported from @waiaas/wallet-sdk"
    - "signing_sdk.notifications_enabled, signing_sdk.notify_categories setting keys exist in SETTING_DEFINITIONS"
    - "notifications_enabled defaults to 'true', notify_categories defaults to '[]'"
  artifacts:
    - path: "packages/core/src/schemas/signing-protocol.ts"
      provides: "NotificationMessageSchema, EVENT_CATEGORY_MAP, NOTIFICATION_CATEGORIES"
      contains: "NotificationMessageSchema"
    - path: "packages/core/src/__tests__/signing-protocol.test.ts"
      provides: "Tests verifying EVENT_CATEGORY_MAP covers all 26 events"
    - path: "packages/wallet-sdk/src/index.ts"
      provides: "Re-export of NotificationMessage type"
    - path: "packages/daemon/src/infrastructure/settings/setting-keys.ts"
      provides: "notifications_enabled and notify_categories setting definitions"
  key_links:
    - from: "packages/core/src/schemas/signing-protocol.ts"
      to: "packages/core/src/enums/notification.ts"
      via: "import NOTIFICATION_EVENT_TYPES"
      pattern: "NOTIFICATION_EVENT_TYPES"
    - from: "packages/wallet-sdk/src/index.ts"
      to: "packages/core/src/schemas/signing-protocol.ts"
      via: "re-export type NotificationMessage"
      pattern: "NotificationMessage"
---

<objective>
Define the NotificationMessage schema, EVENT_CATEGORY_MAP, and notification settings keys.

Purpose: Establish the data model and configuration foundation that both daemon (WalletNotificationChannel) and SDK (subscribeToNotifications/parseNotification) will consume.
Output: Zod schema for notification messages, complete event-to-category mapping, SDK re-export, and 3 new setting key definitions.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/core/src/schemas/signing-protocol.ts
@packages/core/src/enums/notification.ts
@packages/core/src/index.ts
@packages/wallet-sdk/src/index.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define NotificationMessage schema, EVENT_CATEGORY_MAP, and TDD tests</name>
  <files>
    packages/core/src/schemas/signing-protocol.ts
    packages/core/src/index.ts
    packages/core/src/__tests__/signing-protocol.test.ts
  </files>
  <action>
1. In `packages/core/src/schemas/signing-protocol.ts`, add at the end (after existing code):

   a) Define NOTIFICATION_CATEGORIES as a const array:
   ```ts
   export const NOTIFICATION_CATEGORIES = [
     'transaction',
     'policy',
     'security_alert',
     'session',
     'owner',
     'system',
   ] as const;
   export type NotificationCategory = (typeof NOTIFICATION_CATEGORIES)[number];
   ```

   b) Define EVENT_CATEGORY_MAP as a Record mapping all 26 NotificationEventType to NotificationCategory:
   ```ts
   import { NOTIFICATION_EVENT_TYPES, type NotificationEventType } from '../enums/notification.js';

   export const EVENT_CATEGORY_MAP: Record<NotificationEventType, NotificationCategory> = {
     TX_REQUESTED: 'transaction',
     TX_QUEUED: 'transaction',
     TX_SUBMITTED: 'transaction',
     TX_CONFIRMED: 'transaction',
     TX_FAILED: 'transaction',
     TX_CANCELLED: 'transaction',
     TX_DOWNGRADED_DELAY: 'transaction',
     TX_APPROVAL_REQUIRED: 'transaction',
     TX_APPROVAL_EXPIRED: 'transaction',
     POLICY_VIOLATION: 'policy',
     WALLET_SUSPENDED: 'security_alert',
     KILL_SWITCH_ACTIVATED: 'security_alert',
     KILL_SWITCH_RECOVERED: 'security_alert',
     KILL_SWITCH_ESCALATED: 'security_alert',
     AUTO_STOP_TRIGGERED: 'security_alert',
     SESSION_EXPIRING_SOON: 'session',
     SESSION_EXPIRED: 'session',
     SESSION_CREATED: 'session',
     OWNER_SET: 'owner',
     OWNER_REMOVED: 'owner',
     OWNER_VERIFIED: 'owner',
     DAILY_SUMMARY: 'system',
     CUMULATIVE_LIMIT_WARNING: 'policy',
     LOW_BALANCE: 'system',
     APPROVAL_CHANNEL_SWITCHED: 'system',
     UPDATE_AVAILABLE: 'system',
   };
   ```

   c) Define NotificationMessageSchema (Zod):
   ```ts
   export const NotificationMessageSchema = z.object({
     version: z.literal('1'),
     eventType: z.string(),
     walletId: z.string(),
     walletName: z.string(),
     category: z.enum(NOTIFICATION_CATEGORIES),
     title: z.string(),
     body: z.string(),
     details: z.record(z.unknown()).optional(),
     timestamp: z.number(),
   });
   export type NotificationMessage = z.infer<typeof NotificationMessageSchema>;
   ```

2. In `packages/core/src/index.ts`, add re-exports for the new types:
   - Add to the existing signing-protocol import block: `NOTIFICATION_CATEGORIES, type NotificationCategory, EVENT_CATEGORY_MAP, NotificationMessageSchema, type NotificationMessage`

3. RED phase: In `packages/core/src/__tests__/signing-protocol.test.ts`, add a new describe block:

   a) Test that EVENT_CATEGORY_MAP covers all 26 NOTIFICATION_EVENT_TYPES:
   ```ts
   import { NOTIFICATION_EVENT_TYPES } from '../enums/notification.js';
   import { EVENT_CATEGORY_MAP, NOTIFICATION_CATEGORIES, NotificationMessageSchema } from '../schemas/signing-protocol.js';

   describe('EVENT_CATEGORY_MAP', () => {
     it('covers all 26 NotificationEventType values', () => {
       for (const eventType of NOTIFICATION_EVENT_TYPES) {
         expect(EVENT_CATEGORY_MAP[eventType]).toBeDefined();
         expect(NOTIFICATION_CATEGORIES).toContain(EVENT_CATEGORY_MAP[eventType]);
       }
       expect(Object.keys(EVENT_CATEGORY_MAP)).toHaveLength(NOTIFICATION_EVENT_TYPES.length);
     });

     it('has no extra keys beyond NOTIFICATION_EVENT_TYPES', () => {
       const mapKeys = new Set(Object.keys(EVENT_CATEGORY_MAP));
       const enumKeys = new Set(NOTIFICATION_EVENT_TYPES as readonly string[]);
       for (const key of mapKeys) {
         expect(enumKeys.has(key)).toBe(true);
       }
     });
   });

   describe('NotificationMessageSchema', () => {
     it('validates a correct NotificationMessage', () => {
       const msg = {
         version: '1',
         eventType: 'TX_CONFIRMED',
         walletId: '01958f3a-1234-7000-8000-abcdef123456',
         walletName: 'trading-bot',
         category: 'transaction',
         title: 'Transaction Confirmed',
         body: 'Your transaction has been confirmed',
         timestamp: 1707000000,
       };
       const result = NotificationMessageSchema.safeParse(msg);
       expect(result.success).toBe(true);
     });

     it('rejects invalid category', () => {
       const msg = {
         version: '1',
         eventType: 'TX_CONFIRMED',
         walletId: 'id',
         walletName: 'w',
         category: 'invalid_category',
         title: 'T',
         body: 'B',
         timestamp: 1707000000,
       };
       const result = NotificationMessageSchema.safeParse(msg);
       expect(result.success).toBe(false);
     });
   });
   ```

4. GREEN phase: Run tests, confirm they pass.
  </action>
  <verify>
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core run test -- --run signing-protocol`
    All tests pass including EVENT_CATEGORY_MAP coverage and NotificationMessageSchema validation tests.
  </verify>
  <done>
    NotificationMessageSchema with version/eventType/walletId/walletName/category/title/body/details/timestamp fields is defined.
    EVENT_CATEGORY_MAP maps all 26 events to 6 categories. Test confirms complete coverage.
    Types are exported from @waiaas/core.
  </done>
</task>

<task type="auto">
  <name>Task 2: Re-export NotificationMessage in wallet-sdk + add notification settings keys</name>
  <files>
    packages/wallet-sdk/src/index.ts
    packages/daemon/src/infrastructure/settings/setting-keys.ts
    packages/daemon/src/__tests__/settings-service.test.ts
  </files>
  <action>
1. In `packages/wallet-sdk/src/index.ts`, add to the existing `export type` block from `@waiaas/core`:
   ```ts
   export type {
     SignRequest,
     SignResponse,
     WalletLinkConfig,
     NotificationMessage,
   } from '@waiaas/core';
   ```

2. In `packages/daemon/src/infrastructure/settings/setting-keys.ts`:

   a) Add 2 new settings to the signing_sdk category section (after the existing `signing_sdk.wallets` entry):
   ```ts
   { key: 'signing_sdk.notifications_enabled', category: 'signing_sdk', configPath: 'signing_sdk.notifications_enabled', defaultValue: 'true', isCredential: false },
   { key: 'signing_sdk.notify_categories', category: 'signing_sdk', configPath: 'signing_sdk.notify_categories', defaultValue: '[]', isCredential: false },
   ```

   Note: `notifications_enabled` defaults to 'true' (active by default when SDK is enabled -- SETTINGS-01). `notify_categories` defaults to '[]' (empty array = all categories -- SETTINGS-03).

3. In `packages/daemon/src/__tests__/settings-service.test.ts`, update the total settings count assertion.
   The current count is 63 (per comment: 9+14+13+1+2+2+1+6+5+3+7 = 63). Adding 2 new keys makes it 65.
   Search for the assertion `// 9 notifications + 14 rpc + 13 security + 1 daemon + 2 walletconnect + 2 oracle + 1 display + 6 autostop + 5 monitoring + 3 telegram + 7 signing_sdk = 63` and update the comment and assertion to `... + 9 signing_sdk = 65`. Update the `.toHaveLength(63)` to `.toHaveLength(65)`.

4. Run `pnpm --filter @waiaas/core run build` to generate updated dist/ for wallet-sdk imports.
  </action>
  <verify>
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon run test -- --run settings-service`
    Settings count test passes with 65 total definitions.
    Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/wallet-sdk run build` -- builds without errors.
  </verify>
  <done>
    NotificationMessage type is re-exported from @waiaas/wallet-sdk.
    signing_sdk.notifications_enabled and signing_sdk.notify_categories exist in SETTING_DEFINITIONS with correct defaults.
    Total setting definitions count is 65.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @waiaas/core run test -- --run signing-protocol` -- all tests pass
2. `pnpm --filter @waiaas/daemon run test -- --run settings-service` -- total count updated to 65
3. `pnpm --filter @waiaas/wallet-sdk run build` -- compiles without errors
4. `pnpm --filter @waiaas/core run build` -- compiles without errors
</verification>

<success_criteria>
- NotificationMessageSchema is defined in core with all required fields
- EVENT_CATEGORY_MAP covers 26/26 events across 6 categories (test-verified)
- NotificationMessage type is accessible from @waiaas/wallet-sdk
- signing_sdk.notifications_enabled defaults to 'true'
- signing_sdk.notify_categories defaults to '[]' (empty = all categories)
</success_criteria>

<output>
After completion, create `.planning/phases/206-wallet-app-notification-side-channel/206-01-SUMMARY.md`
</output>
