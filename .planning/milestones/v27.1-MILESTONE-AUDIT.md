---
milestone: v27.1
audited: 2026-02-22T09:00:00Z
status: gaps_found
scores:
  requirements: 29/30
  phases: 3/7 verified (4 missing VERIFICATION.md)
  integration: 29/30
  flows: 7/8
gaps:
  requirements:
    - id: "STO-03"
      status: "unsatisfied"
      phase: "Phase 226/230"
      claimed_by_plans: ["226-03-PLAN.md", "230-01-PLAN.md"]
      completed_by_plans: ["226-03-SUMMARY.md", "230-01-SUMMARY.md"]
      verification_status: "passed (worker registration) — missed (RPC callback injection)"
      evidence: "createConfirmationWorkerHandler requires getBlockNumber (EVM) and checkSolanaFinalized (Solana) callbacks. IncomingTxMonitorService.registerWorkers() passes only {sqlite: this.sqlite} — both callbacks are undefined. Guard clauses `if (!checkSolanaFinalized) continue` and `if (!getBlockNumber) continue` silently skip all DETECTED records. No transaction ever transitions to CONFIRMED. Phase 230 VERIFICATION confirmed worker registration (BUG-1 fix) but did not verify handler deps injection."
  integration:
    - from: "IncomingTxMonitorService.registerWorkers() workers 3+4"
      to: "createConfirmationWorkerHandler RPC deps"
      issue: "Confirmation workers registered with {sqlite} only — getBlockNumber (EVM) and checkSolanaFinalized (Solana) callbacks not injected from adapter layer"
      affected_requirements: ["STO-03"]
  flows:
    - flow: "DETECTED → CONFIRMED confirmation upgrade"
      breaks_at: "incoming-tx-monitor-service.ts registerWorkers() — confirmation workers missing RPC callback deps"
      affected_requirements: ["STO-03"]
tech_debt:
  - phase: 226-229
    items:
      - "4 phases missing VERIFICATION.md (226, 227, 228, 229) — integration checker independently verified wiring"
  - phase: 230
    items:
      - "daemon.ts line 797: `this.workers ?? new BackgroundWorkers()` fallback is dead code (Info severity)"
  - phase: REQUIREMENTS.md
    items:
      - "Coverage summary text stale: says 'Satisfied: 22, Pending: 8' — should be 'Satisfied: 30' (all checkboxes are [x])"
---

# Milestone v27.1 Audit Report: 수신 트랜잭션 모니터링 구현

**Audited:** 2026-02-22T09:00:00Z
**Status:** gaps_found
**Phases:** 224-230 (7 phases, 18 plans)
**Requirements:** 30 total, 29 satisfied, 1 unsatisfied (STO-03)

---

## Executive Summary

v27.1의 거의 모든 컴포넌트가 구현, 테스트, 배선 완료 상태입니다. Phase 230에서 이전 감사의 3대 버그(BUG-1 BackgroundWorkers 분리, BUG-2 폴링 워커 빈 핸들러, BUG-3 Gap Recovery 스텁)가 모두 수정되었습니다.

**잔여 문제 1건:** STO-03 — Confirmation 워커의 RPC 콜백(getBlockNumber, checkSolanaFinalized)이 IncomingTxMonitorService에서 주입되지 않아, DETECTED→CONFIRMED 상태 전환이 발생하지 않습니다. GET /v1/wallet/incoming의 기본 필터가 status=CONFIRMED이므로, 기본 쿼리 시 빈 결과가 반환됩니다.

---

## Critical Gap

### STO-03: Confirmation Worker RPC 콜백 미주입

**위치:** `packages/daemon/src/services/incoming/incoming-tx-monitor-service.ts` registerWorkers()

```
Workers 3+4 ('incoming-tx-confirm-solana', 'incoming-tx-confirm-evm') 등록 시:
  createConfirmationWorkerHandler({ sqlite: this.sqlite })

누락: getBlockNumber (EVM), checkSolanaFinalized (Solana)
```

- `incoming-tx-workers.ts`의 guard clauses가 모든 DETECTED 레코드를 건너뜀:
  - Solana: `if (!checkSolanaFinalized) continue` (line 106)
  - EVM: `if (!getBlockNumber || row.block_number == null) continue` (line 114)
- `IncomingTxMonitorDeps`에 `adapterPool` 또는 RPC 접근자가 없음
- Phase 230 VERIFICATION은 워커 등록을 확인했으나 (BUG-1 수정), 핸들러 내부 deps 주입 검증을 누락

**사용자 영향:** `GET /v1/wallet/incoming` 기본값 `status=CONFIRMED` → 항상 빈 결과. `?status=DETECTED`로 명시 쿼리 시에만 데이터 확인 가능.

**권장 수정:**
- Option A: `IncomingTxMonitorDeps`에 `adapterPool` 추가 → registerWorkers()에서 getBlockNumber/checkSolanaFinalized 파생
- Option B: daemon.ts Step 4c-9에서 resolveRpcUrl 헬퍼로 콜백 생성 → deps에 직접 전달

---

## Phase 230 Bug Fixes Confirmed

이전 감사에서 발견된 3대 버그는 Phase 230에서 모두 수정 완료:

| Bug | Issue | Fix | Verification |
|-----|-------|-----|-------------|
| BUG-1 | BackgroundWorkers 인스턴스 분리 | daemon.ts에서 Step 4c-9 전에 this.workers 사전 생성 | 230-VERIFICATION passed (7/7) |
| BUG-2 | 폴링 워커 빈 핸들러 | Worker 5/6이 multiplexer.getSubscribersForChain()을 통해 subscriber.pollAll() 호출 | 230-VERIFICATION passed |
| BUG-3 | Gap Recovery 스텁 | onGapRecovery가 createGapRecoveryHandler + multiplexer.getSubscriberEntries()로 배선 | 230-VERIFICATION passed |

---

## Requirements Coverage (3-Source Cross-Reference)

### Subscription Infrastructure

| Requirement | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration Check | Final Status |
|-------------|----------------|---------------------|-----------------|-------------------|--------------|
| SUB-01 | passed (224) | 224-01 | [x] | WIRED | **satisfied** |
| SUB-02 | passed (225, 230) | 225-01, 230-01/02 | [x] | WIRED | **satisfied** |
| SUB-03 | passed (225, 230) | 225-02, 230-01/02 | [x] | WIRED | **satisfied** |
| SUB-04 | passed (225, 230) | 225-03, 230-01/02 | [x] | WIRED | **satisfied** |
| SUB-05 | passed (230) | 226-02, 230-01/02 | [x] | WIRED | **satisfied** |
| SUB-06 | — (226 no verif) | 226-02 | [x] | WIRED | **satisfied** |
| SUB-07 | passed (225) | 225-01 | [x] | WIRED | **satisfied** |

### Data Storage

| Requirement | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration Check | Final Status |
|-------------|----------------|---------------------|-----------------|-------------------|--------------|
| STO-01 | passed (224) | 224-02 | [x] | WIRED | **satisfied** |
| STO-02 | passed (230) | 226-01, 230-01/02 | [x] | WIRED | **satisfied** |
| STO-03 | passed (230) ⚠ | 226-03, 230-01/02 | [x] | **PARTIAL** | **unsatisfied** |
| STO-04 | — (226 no verif) | 226-01 | [x] | WIRED | **satisfied** |
| STO-05 | passed (230) | 226-03, 230-01/02 | [x] | WIRED | **satisfied** |

⚠ STO-03: Phase 230 VERIFICATION confirmed worker registration but missed RPC callback injection gap.

### Query API

| Requirement | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration Check | Final Status |
|-------------|----------------|---------------------|-----------------|-------------------|--------------|
| API-01 | — (228 no verif) | 228-01 | [x] | WIRED | **satisfied** |
| API-02 | — (228 no verif) | 228-01 | [x] | WIRED | **satisfied** |
| API-03 | — (228 no verif) | 228-01 | [x] | WIRED | **satisfied** |
| API-04 | — (228 no verif) | 228-02 | [x] | WIRED | **satisfied** |
| API-05 | — (228 no verif) | 228-02 | [x] | WIRED | **satisfied** |
| API-06 | — (228 no verif) | 228-03 | [x] | WIRED | **satisfied** |
| API-07 | — (228 no verif) | 228-03 | [x] | WIRED | **satisfied** |

### Events and Notifications

| Requirement | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration Check | Final Status |
|-------------|----------------|---------------------|-----------------|-------------------|--------------|
| EVT-01 | — (226 no verif) | 226-04 | [x] | WIRED | **satisfied** |
| EVT-02 | — (227 no verif) | 227-02 | [x] | WIRED | **satisfied** |
| EVT-03 | — (226 no verif) | 226-04 | [x] | WIRED | **satisfied** |
| EVT-04 | — (226 no verif) | 226-04 | [x] | WIRED | **satisfied** |
| EVT-05 | — (226 no verif) | 226-04 | [x] | WIRED | **satisfied** |
| EVT-06 | — (227 no verif) | 227-02 | [x] | WIRED | **satisfied** |

### Configuration

| Requirement | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration Check | Final Status |
|-------------|----------------|---------------------|-----------------|-------------------|--------------|
| CFG-01 | — (227 no verif) | 227-01 | [x] | WIRED | **satisfied** |
| CFG-02 | — (227 no verif) | 227-01 | [x] | WIRED | **satisfied** |
| CFG-03 | — (227 no verif) | 227-01 | [x] | WIRED | **satisfied** |
| CFG-04 | passed (230) | 226-04, 230-01/02 | [x] | WIRED | **satisfied** |
| CFG-05 | — (227 no verif) | 227-01 | [x] | WIRED | **satisfied** |

**Summary:** 29/30 satisfied, 1/30 unsatisfied (STO-03)
**Orphaned requirements:** 0

---

## Phase Verification Status

| Phase | VERIFICATION.md | Status | Requirements Covered |
|-------|----------------|--------|---------------------|
| 224: Core Types + DB | exists | passed (4/4) | SUB-01, STO-01 |
| 225: Chain Subscribers | exists | passed (18/18) | SUB-02, SUB-03, SUB-04, SUB-07 |
| 226: Monitor Service | **missing** | unverified | SUB-05, SUB-06, STO-02~05, EVT-01,03-05, CFG-04 |
| 227: Config + Notifications | **missing** | unverified | CFG-01~03, CFG-05, EVT-02, EVT-06 |
| 228: REST API + SDK + MCP | **missing** | unverified | API-01~07 |
| 229: Integration Testing | **missing** | unverified | (cross-cutting validation) |
| 230: Integration Wiring Fixes | exists | passed (7/7) | SUB-02~05, STO-02,03,05, CFG-04 |

**Note:** Phases 226-229 have complete SUMMARY.md files for all plans. The integration checker independently verified all cross-phase wiring for these phases. Missing VERIFICATION.md is a process gap, not a functional gap.

---

## Integration Wiring (30 connections checked)

| Connection | Status |
|-----------|--------|
| Phase 224 → 225: IChainSubscriber interface import | WIRED |
| Phase 224 → 225: IncomingTransaction type | WIRED |
| Phase 224 → 226: IncomingTransaction in queue/multiplexer | WIRED |
| Phase 225 → 226: reconnectLoop in multiplexer | WIRED |
| Phase 225 → 226: IChainSubscriber in multiplexer | WIRED |
| Phase 226 → daemon: BackgroundWorkers shared instance (BUG-1 fixed) | WIRED |
| Phase 226: Polling worker 5 Solana pollAll (BUG-2 fixed) | WIRED |
| Phase 226: Polling worker 6 EVM pollAll (BUG-2 fixed) | WIRED |
| Phase 226: onGapRecovery → createGapRecoveryHandler (BUG-3 fixed) | WIRED |
| Phase 226 → 227: 7 incoming.* setting keys | WIRED |
| Phase 226 → 227: HotReloadOrchestrator INCOMING_KEYS_PREFIX | WIRED |
| Phase 227 → 226: reloadIncomingMonitor() → updateConfig() | WIRED |
| Phase 227: TX_INCOMING/TX_INCOMING_SUSPICIOUS NotificationEventType | WIRED |
| Phase 227: i18n en/ko templates | WIRED |
| Phase 227: BROADCAST_EVENTS includes TX_INCOMING_SUSPICIOUS | WIRED |
| Phase 227: IncomingSettings Admin UI component | WIRED |
| Phase 226 → 228: PATCH /v1/wallets/:id → syncSubscriptions() | WIRED |
| Phase 228: GET /incoming queries incomingTransactions table | WIRED |
| Phase 228: incomingRoutes mounted in server.ts | WIRED |
| Phase 228: TS SDK listIncomingTransactions/getIncomingTransactionSummary | WIRED |
| Phase 228: Python SDK list_incoming_transactions/get_incoming_transaction_summary | WIRED |
| Phase 228: MCP 2 tools registered (23 total) | WIRED |
| Phase 228: Auth protection (sessionAuth + masterAuth) | WIRED |
| Phase 226: 3 safety rules in monitor constructor | WIRED |
| Phase 226: KillSwitch notification suppression | WIRED |
| Phase 226: Per-wallet notification cooldown | WIRED |
| Phase 226: EventBus transaction:incoming events | WIRED |
| Phase 226: Monitor service notify() type-safe | WIRED |
| Phase 229: Integration tests import real production classes | WIRED |
| **Phase 226: Confirmation workers RPC callbacks** | **BROKEN** |

**Score:** 29/30 wired, 1 broken (STO-03 confirmation RPC deps)

---

## E2E Flows

| Flow | Status | Break Point |
|------|--------|-------------|
| Solana WebSocket incoming detection → queue → DB | COMPLETE | — |
| EVM polling detection → queue → DB (BUG-2 fixed) | COMPLETE | — |
| Gap recovery after WebSocket reconnect (BUG-3 fixed) | COMPLETE | — |
| Notification delivery (incoming TX → EventBus → channels) | COMPLETE | — |
| KillSwitch suppression (DB write + suppress notification) | COMPLETE | — |
| REST API query (GET /v1/wallet/incoming → DB) | COMPLETE | — |
| SDK/MCP tool → REST API → response | COMPLETE | — |
| **DETECTED → CONFIRMED confirmation upgrade** | **BROKEN** | Confirmation workers missing RPC callback deps |

**Score:** 7/8 complete, 1 broken

---

## Tech Debt

### Process Debt

| Item | Phase | Severity |
|------|-------|----------|
| Missing VERIFICATION.md | 226, 227, 228, 229 | Low (integration checker verified wiring independently) |
| REQUIREMENTS.md coverage summary stale | REQUIREMENTS.md lines 119-121 | Info (says "Satisfied: 22, Pending: 8" but all 30 are [x]) |

### Code Debt

| Item | Phase | File | Severity |
|------|-------|------|----------|
| Dead code fallback `this.workers ?? new BackgroundWorkers()` | 230 | daemon.ts:797 | Info |

---

_Audited: 2026-02-22T09:00:00Z_
_Auditor: Claude (gsd-audit-milestone)_
_Integration Checker: Claude (gsd-integration-checker)_
