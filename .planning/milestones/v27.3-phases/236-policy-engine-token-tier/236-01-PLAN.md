---
phase: 236-policy-engine-token-tier
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/pipeline/database-policy-engine.ts
  - packages/daemon/src/pipeline/stages.ts
  - packages/daemon/src/pipeline/sign-only.ts
autonomous: true
requirements: [ENGN-01, ENGN-02]

must_haves:
  truths:
    - "TransactionParam interface includes tokenDecimals field in all 3 locations"
    - "buildTransactionParam passes tokenDecimals for TOKEN_TRANSFER and APPROVE types"
    - "mapOperationToParam does not break for sign-only pipeline (no decimals available in ParsedOperation)"
  artifacts:
    - path: "packages/daemon/src/pipeline/database-policy-engine.ts"
      provides: "TransactionParam with tokenDecimals field"
      contains: "tokenDecimals?: number"
    - path: "packages/daemon/src/pipeline/stages.ts"
      provides: "TransactionParam with tokenDecimals + buildTransactionParam passing decimals"
      contains: "tokenDecimals?: number"
    - path: "packages/daemon/src/pipeline/sign-only.ts"
      provides: "TransactionParam with tokenDecimals field"
      contains: "tokenDecimals?: number"
  key_links:
    - from: "packages/daemon/src/pipeline/stages.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "TransactionParam interface sync"
      pattern: "tokenDecimals"
    - from: "packages/daemon/src/pipeline/sign-only.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "TransactionParam interface sync"
      pattern: "tokenDecimals"
---

<objective>
Add `tokenDecimals?: number` to the TransactionParam interface at all 3 duplicate locations and wire token decimal information through buildTransactionParam() and mapOperationToParam().

Purpose: Enable the policy engine to perform human-readable token limit comparisons by carrying decimal information from the transaction request into the policy evaluation pipeline.
Output: Synchronized TransactionParam interfaces and decimal-passing builder functions ready for evaluateTokenTier consumption in plan 236-02.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/235-schema-zod-ssot/235-01-SUMMARY.md
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/pipeline/stages.ts
@packages/daemon/src/pipeline/sign-only.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tokenDecimals to TransactionParam (3 locations) + buildTransactionParam</name>
  <files>
    packages/daemon/src/pipeline/database-policy-engine.ts
    packages/daemon/src/pipeline/stages.ts
    packages/daemon/src/pipeline/sign-only.ts
  </files>
  <action>
1. **database-policy-engine.ts (~line 113-133):** Add `tokenDecimals?: number` field to the TransactionParam interface, with JSDoc: `/** Token decimals for token_limits human-readable conversion (TOKEN_TRANSFER/APPROVE only). */`

2. **stages.ts (~line 177-189):** Add the same `tokenDecimals?: number` field with same JSDoc to the TransactionParam interface.

3. **stages.ts buildTransactionParam() (~line 191+):**
   - In the `TOKEN_TRANSFER` case (~line 197): Cast includes `token: { address: string; assetId?: string; decimals: number }` and add `tokenDecimals: r.token.decimals` to the return object.
   - In the `APPROVE` case (~line 219): Cast includes `token: { address: string; assetId?: string; decimals: number }` and add `tokenDecimals: r.token.decimals` to the return object.
   - Leave `TRANSFER`, `CONTRACT_CALL`, and default cases untouched (no tokenDecimals for those).

4. **sign-only.ts (~line 84-95):** Add the same `tokenDecimals?: number` field with same JSDoc to the TransactionParam interface.

5. **sign-only.ts mapOperationToParam() (~line 112+):**
   - Note: `ParsedOperation` does NOT have a `decimals` field (confirmed in chain-adapter.types.ts). It only has `token?: string` (address).
   - Therefore, do NOT add `tokenDecimals` to the mapOperationToParam return values. When sign-only pipeline evaluates token_limits, it will rely on CAIP-19 key matching only (without decimal conversion). This is acceptable because sign-only operations already have raw amounts that can fall back to the raw field comparison.
   - No changes needed to mapOperationToParam function body.

**Important:** Ensure all 3 TransactionParam interfaces have identical field sets after this change. The sign-only.ts version currently lacks `assetId` -- add `assetId?: string` as well for consistency (it was added to stages.ts and database-policy-engine.ts in prior milestones but missed in sign-only.ts). Then in mapOperationToParam, for `TOKEN_TRANSFER` case, add `assetId: undefined` (ParsedOperation doesn't have it).
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=@waiaas/daemon` and confirm no type errors. Grep all 3 files for `tokenDecimals` to verify presence:
```bash
grep -n 'tokenDecimals' packages/daemon/src/pipeline/database-policy-engine.ts packages/daemon/src/pipeline/stages.ts packages/daemon/src/pipeline/sign-only.ts
```
  </verify>
  <done>
- tokenDecimals field present in all 3 TransactionParam interfaces
- buildTransactionParam passes req.token.decimals for TOKEN_TRANSFER and APPROVE
- sign-only.ts TransactionParam synced (including assetId field)
- typecheck passes with no errors
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` passes
2. `grep -c 'tokenDecimals' packages/daemon/src/pipeline/database-policy-engine.ts packages/daemon/src/pipeline/stages.ts packages/daemon/src/pipeline/sign-only.ts` shows hits in all 3 files
3. All 3 TransactionParam interfaces have identical field sets
</verification>

<success_criteria>
- TransactionParam interface includes tokenDecimals in all 3 locations (database-policy-engine.ts, stages.ts, sign-only.ts)
- buildTransactionParam() passes tokenDecimals for TOKEN_TRANSFER and APPROVE request types
- sign-only.ts TransactionParam is fully synced with the other 2 copies
- No type errors in daemon package
</success_criteria>

<output>
After completion, create `.planning/phases/236-policy-engine-token-tier/236-01-SUMMARY.md`
</output>
