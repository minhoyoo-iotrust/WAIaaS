---
phase: 237-admin-ui-token-limits
plan: 02
type: execute
wave: 2
depends_on: ["237-01"]
files_modified:
  - packages/admin/src/components/policy-forms/spending-limit-form.tsx
  - packages/admin/src/api/endpoints.ts
  - packages/admin/src/pages/policies.tsx
autonomous: true
requirements: [ADMN-03, ADMN-05, ADMN-07]

must_haves:
  truths:
    - "+ Add Token Limit button adds a new CAIP-19 token limit row"
    - "Selecting a token from the registry auto-populates the CAIP-19 asset ID"
    - "Token limit rows can be removed with a delete button"
    - "Legacy Raw Tiers section has a visible deprecated warning paragraph"
    - "Token registry is fetched from GET /v1/tokens?network= when network is set"
  artifacts:
    - path: "packages/admin/src/components/policy-forms/spending-limit-form.tsx"
      provides: "CAIP-19 token limit dynamic rows with registry integration"
      min_lines: 180
    - path: "packages/admin/src/api/endpoints.ts"
      provides: "TOKENS endpoint for token registry API"
      contains: "TOKENS"
    - path: "packages/admin/src/pages/policies.tsx"
      provides: "token_limits validation in validateRules for CAIP-19 entries"
      contains: "token_limits"
  key_links:
    - from: "packages/admin/src/components/policy-forms/spending-limit-form.tsx"
      to: "/v1/tokens"
      via: "apiGet fetch for token registry"
      pattern: "apiGet.*TOKENS|tokens.*network"
    - from: "packages/admin/src/components/policy-forms/spending-limit-form.tsx"
      to: "rules.token_limits"
      via: "CAIP-19 key construction from selected token"
      pattern: "token_limits.*caip|assetId"
---

<objective>
Add CAIP-19 token limit dynamic rows with token registry integration, auto-generate CAIP-19 IDs from registry selection, and finalize legacy deprecated display.

Purpose: ADMN-03 (add/remove CAIP-19 token rows), ADMN-05 (legacy deprecated), ADMN-07 (registry CAIP-19 auto-gen)
Output: Dynamic token limit rows in spending-limit-form.tsx, TOKENS endpoint, token_limits validation
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/237-admin-ui-token-limits/237-01-SUMMARY.md
@packages/admin/src/components/policy-forms/spending-limit-form.tsx
@packages/admin/src/components/policy-forms/index.tsx
@packages/admin/src/api/endpoints.ts
@packages/admin/src/api/client.ts
@packages/admin/src/pages/policies.tsx
@packages/admin/src/components/form.tsx
@packages/admin/src/components/dynamic-row-list.tsx
@packages/admin/src/components/policy-forms/allowed-tokens-form.tsx
@packages/daemon/src/api/routes/tokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TOKENS endpoint + CAIP-19 token limit rows in spending-limit-form.tsx</name>
  <files>
    packages/admin/src/api/endpoints.ts
    packages/admin/src/components/policy-forms/spending-limit-form.tsx
  </files>
  <action>
1. In `packages/admin/src/api/endpoints.ts`:
   - Add `TOKENS: '/v1/tokens'` to the API object (after POLICIES or wherever alphabetically appropriate)

2. In `spending-limit-form.tsx`, add imports at the top:
   - `import { useSignal } from '@preact/signals'`
   - `import { useEffect } from 'preact/hooks'`
   - `import { apiGet } from '../../api/client'`
   - `import { API } from '../../api/endpoints'`

3. Define a `TokenRegistryEntry` interface inside the file:
   ```typescript
   interface TokenRegistryEntry {
     address: string;
     symbol: string;
     name: string;
     decimals: number;
     source: string;
     assetId: string | null;
   }
   ```

4. Define a `TokenLimitRow` interface for UI state tracking of CAIP-19 rows:
   ```typescript
   interface TokenLimitRow {
     assetId: string;  // CAIP-19 key or user-entered key
     symbol: string;   // display label
     instant_max: string;
     notify_max: string;
     delay_max: string;
   }
   ```

5. Inside the SpendingLimitForm component, add state and effects:
   ```typescript
   const registryTokens = useSignal<TokenRegistryEntry[]>([]);
   const registryLoading = useSignal(false);

   // Fetch token registry when network changes (EVM networks only)
   useEffect(() => {
     if (!network) { registryTokens.value = []; return; }
     // Only EVM networks have token registry; Solana networks skip
     const evmNetworks = [
       'ethereum-mainnet', 'ethereum-sepolia', 'polygon-mainnet', 'polygon-amoy',
       'arbitrum-mainnet', 'arbitrum-sepolia', 'optimism-mainnet', 'optimism-sepolia',
       'base-mainnet', 'base-sepolia',
     ];
     if (!evmNetworks.includes(network)) { registryTokens.value = []; return; }
     registryLoading.value = true;
     apiGet<{ network: string; tokens: TokenRegistryEntry[] }>(`${API.TOKENS}?network=${network}`)
       .then((res) => { registryTokens.value = res.tokens; })
       .catch(() => { registryTokens.value = []; })
       .finally(() => { registryLoading.value = false; });
   }, [network]);
   ```

6. Derive `caipTokenRows` from `tokenLimits` for rendering CAIP-19 rows (exclude 'native' key):
   ```typescript
   const caipTokenRows: TokenLimitRow[] = Object.entries(tokenLimits)
     .filter(([key]) => key !== 'native')
     .map(([key, val]) => ({
       assetId: key,
       symbol: registryTokens.value.find(t => t.assetId === key)?.symbol || key.split('/').pop()?.split(':').pop() || key,
       instant_max: val.instant_max,
       notify_max: val.notify_max,
       delay_max: val.delay_max,
     }));
   ```

7. In the Token-Specific Limits section (replacing the placeholder from plan 01), add CAIP-19 token rows after the native token fields:

   **Sub-section header:** `<h5 style={{ marginTop: '1rem' }}>Custom Token Limits</h5>`

   **For each caipTokenRow, render a row with:**
   - A display label showing the symbol and truncated asset ID
   - 3 FormFields for instant_max/notify_max/delay_max (text type, decimal input)
   - A remove button (x) that deletes the key from token_limits
   - onChange updates the corresponding key in token_limits record

   ```tsx
   {caipTokenRows.map((row, i) => (
     <div key={row.assetId} class="token-limit-row" style={{ border: '1px solid var(--border)', borderRadius: '0.5rem', padding: '0.75rem', marginBottom: '0.5rem' }}>
       <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
         <strong>{row.symbol}</strong>
         <span style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>{row.assetId}</span>
         <button class="btn btn-ghost btn-sm" onClick={() => handleRemoveCaipToken(row.assetId)} title="Remove">x</button>
       </div>
       <div class="policy-form-grid">
         <FormField label="Instant Max" name={`token-${i}-instant`} value={row.instant_max} onChange={(v) => handleCaipTokenChange(row.assetId, 'instant_max', String(v))} placeholder="e.g. 100" />
         <FormField label="Notify Max" name={`token-${i}-notify`} value={row.notify_max} onChange={(v) => handleCaipTokenChange(row.assetId, 'notify_max', String(v))} placeholder="e.g. 500" />
         <FormField label="Delay Max" name={`token-${i}-delay`} value={row.delay_max} onChange={(v) => handleCaipTokenChange(row.assetId, 'delay_max', String(v))} placeholder="e.g. 1000" />
       </div>
     </div>
   ))}
   ```

8. **"+ Add Token Limit" button** (ADMN-03):
   - If registryTokens has entries and network is set, show a select dropdown + add button:
     ```tsx
     <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'flex-end', marginTop: '0.5rem' }}>
       <FormField
         label="Select Token"
         name="add-token-select"
         type="select"
         value=""
         onChange={(v) => handleAddTokenFromRegistry(v as string)}
         options={[
           { label: '-- Select a token --', value: '' },
           ...registryTokens.value
             .filter(t => t.assetId && !tokenLimits[t.assetId])
             .map(t => ({ label: `${t.symbol} (${t.name})`, value: t.assetId! })),
         ]}
       />
     </div>
     ```
   - Also provide a manual CAIP-19 entry option:
     ```tsx
     <button class="btn btn-secondary btn-sm" style={{ marginTop: '0.5rem' }} onClick={handleAddManualToken}>
       + Add Token Limit (manual CAIP-19)
     </button>
     ```

9. **Handler functions for CAIP-19 token rows:**

   ```typescript
   const handleCaipTokenChange = (assetId: string, field: string, value: string) => {
     const current = tokenLimits[assetId] || { instant_max: '0', notify_max: '0', delay_max: '0' };
     const updated = { ...current, [field]: value };
     onChange({ ...rules, token_limits: { ...tokenLimits, [assetId]: updated } });
   };

   const handleRemoveCaipToken = (assetId: string) => {
     const next = { ...tokenLimits };
     delete next[assetId];
     onChange({ ...rules, token_limits: Object.keys(next).length > 0 ? next : undefined });
   };

   const handleAddTokenFromRegistry = (assetId: string) => {
     if (!assetId || tokenLimits[assetId]) return;
     const newEntry = { instant_max: '0', notify_max: '0', delay_max: '0' };
     onChange({ ...rules, token_limits: { ...tokenLimits, [assetId]: newEntry } });
   };

   const handleAddManualToken = () => {
     const key = prompt('Enter CAIP-19 asset ID (e.g., eip155:1/erc20:0xa0b8...)');
     if (!key || tokenLimits[key]) return;
     const newEntry = { instant_max: '0', notify_max: '0', delay_max: '0' };
     onChange({ ...rules, token_limits: { ...tokenLimits, [key]: newEntry } });
   };
   ```

10. **ADMN-07:** The `handleAddTokenFromRegistry` function uses the `assetId` field directly from the token registry API response, which already contains the properly formatted CAIP-19 ID (e.g., `eip155:1/erc20:0xa0b8...`). No manual construction needed -- the daemon API provides it.
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=admin`. Test manually:
1. Create a SPENDING_LIMIT policy with network="ethereum-mainnet"
2. Token registry loads and shows available tokens in the select dropdown
3. Select a token -- it appears as a new row with CAIP-19 ID auto-filled
4. Fill in amounts and save -- rules.token_limits contains the CAIP-19 key
5. Remove a token row -- it disappears and key is removed from token_limits
6. Click "+ Add Token Limit (manual CAIP-19)" -- prompt appears for manual entry
  </verify>
  <done>
CAIP-19 token limit rows can be added from registry (with auto-generated CAIP-19 ID) or manually. Rows display symbol + asset ID, have 3 tier fields, and can be removed. Token registry is fetched for EVM networks. TOKENS endpoint added to admin API endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Finalize legacy deprecated display + token_limits validation in policies.tsx</name>
  <files>
    packages/admin/src/pages/policies.tsx
  </files>
  <action>
1. **Verify ADMN-05 legacy deprecated display** in spending-limit-form.tsx (done in plan 01, Task 2):
   - The h4 for "Legacy Raw Tiers" should already contain the deprecated badge from plan 01
   - If not already present, ensure the section has: `<p style={{ color: 'var(--text-secondary)', fontSize: '0.875rem', marginBottom: '0.75rem' }}>Raw tiers use lamports/wei units and apply uniformly to all tokens. Use USD Tiers or Token-Specific Limits instead. These fields will be removed in a future version.</p>`

2. **Update validateRules in policies.tsx** to validate token_limits entries:

   In the SPENDING_LIMIT section of validateRules, after the existing raw/USD/delay validation, add token_limits validation:

   ```typescript
   // Validate token_limits entries if present
   const tl = rules.token_limits as Record<string, { instant_max?: string; notify_max?: string; delay_max?: string }> | undefined;
   if (tl && typeof tl === 'object') {
     const DECIMAL_RE = /^\d+(\.\d+)?$/;
     for (const [key, entry] of Object.entries(tl)) {
       if (!entry || typeof entry !== 'object') continue;
       if (entry.instant_max && !DECIMAL_RE.test(entry.instant_max)) {
         errors[`token_limits.${key}.instant_max`] = 'Must be a non-negative decimal';
       }
       if (entry.notify_max && !DECIMAL_RE.test(entry.notify_max)) {
         errors[`token_limits.${key}.notify_max`] = 'Must be a non-negative decimal';
       }
       if (entry.delay_max && !DECIMAL_RE.test(entry.delay_max)) {
         errors[`token_limits.${key}.delay_max`] = 'Must be a non-negative decimal';
       }
       // Ordering: instant <= notify <= delay
       const im = parseFloat(entry.instant_max || '0');
       const nm = parseFloat(entry.notify_max || '0');
       const dm = parseFloat(entry.delay_max || '0');
       if (im > nm) {
         errors[`token_limits.${key}.instant_max`] = 'Must be <= Notify Max';
       }
       if (nm > dm) {
         errors[`token_limits.${key}.notify_max`] = 'Must be <= Delay Max';
       }
     }
   }
   ```

3. **Ensure the "at least one source" check** (from plan 01) correctly detects token_limits:
   ```typescript
   const hasTokenLimits = tl !== undefined && typeof tl === 'object' && Object.keys(tl).length > 0;
   ```
   This should already be set up by plan 01. If not, add it.

4. **Verify DEFAULT_RULES.SPENDING_LIMIT** no longer has raw fields (set in plan 01):
   ```typescript
   SPENDING_LIMIT: { delay_seconds: 300, approval_timeout: 3600 },
   ```
   If plan 01 already did this, no change needed. Just verify.
  </action>
  <verify>
Run `pnpm turbo run typecheck --filter=admin` and `pnpm turbo run lint --filter=admin`.
Test:
1. Create policy with only USD fields -- saves successfully (no raw field errors)
2. Create policy with token_limits only -- saves successfully
3. Enter invalid decimal in token_limits field -- validation error appears
4. Enter instant > notify -- ordering error appears
5. Legacy section shows deprecated warning text
  </verify>
  <done>
token_limits entries are validated (decimal format + ordering). Legacy deprecated warning is visible. New policies can be created with USD-only or token_limits-only (no raw fields required). Validation covers both format and tier ordering for all token_limits entries.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=admin` passes
2. `pnpm turbo run lint --filter=admin` passes
3. Token registry dropdown shows available tokens for EVM networks (ADMN-07)
4. Selecting a token from registry adds a row with CAIP-19 ID auto-filled (ADMN-03, ADMN-07)
5. Token limit rows can be removed (ADMN-03)
6. Legacy section has deprecated warning text (ADMN-05)
7. token_limits validation catches invalid decimals and ordering violations
</verification>

<success_criteria>
- TOKENS endpoint exists in admin endpoints.ts
- "+ Add Token Limit" adds CAIP-19 rows from registry or manually
- Token registry selection auto-generates CAIP-19 asset ID in token_limits key
- Token limit rows display symbol, CAIP-19 ID, and 3 tier fields
- Token limit rows can be removed
- Legacy Raw Tiers section clearly shows deprecated warning
- token_limits entries are validated for format and ordering in validateRules
</success_criteria>

<output>
After completion, create `.planning/phases/237-admin-ui-token-limits/237-02-SUMMARY.md`
</output>
