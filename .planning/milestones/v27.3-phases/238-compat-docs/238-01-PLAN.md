---
phase: 238-compat-docs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/database-policy-engine.test.ts
  - skills/policies.skill.md
autonomous: true
requirements: [CMPT-01, CMPT-02, CMPT-03, CMPT-04]

must_haves:
  truths:
    - "Raw-only policy (no token_limits, no USD) returns the same tier as before v27.3 changes"
    - "USD-only policy (no raw, no token_limits) returns correct tier based on USD thresholds"
    - "Raw + token_limits coexistence: token_limits takes priority for matching tokens, raw for non-matching"
    - "daily_limit_usd and monthly_limit_usd evaluation is completely independent of token_limits"
    - "BATCH evaluation is unaffected (tokenContext is undefined for batch, raw/USD only)"
    - "policies.skill.md documents token_limits field with CAIP-19 key format, matching priority, and examples"
  artifacts:
    - path: "packages/daemon/src/__tests__/database-policy-engine.test.ts"
      provides: "Backward compatibility test suite for token_limits"
      contains: "Backward Compatibility"
    - path: "skills/policies.skill.md"
      provides: "token_limits documentation for AI agents"
      contains: "token_limits"
  key_links:
    - from: "packages/daemon/src/__tests__/database-policy-engine.test.ts"
      to: "packages/daemon/src/pipeline/database-policy-engine.ts"
      via: "DatabasePolicyEngine evaluate/evaluateAndReserve/evaluateBatch"
      pattern: "engine\\.evaluate"
---

<objective>
Verify backward compatibility of the token_limits feature and document it for AI agents.

Purpose: Ensure existing policies (raw-only, USD-only) behave identically to pre-v27.3, that token_limits correctly takes priority when present, that cumulative USD limits are unaffected, and that the policies.skill.md file is updated so AI agents can leverage token_limits.

Output: ~10 new backward compatibility tests in database-policy-engine.test.ts + updated policies.skill.md with token_limits documentation.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/daemon/src/pipeline/database-policy-engine.ts
@packages/daemon/src/__tests__/database-policy-engine.test.ts
@skills/policies.skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backward compatibility tests for token_limits</name>
  <files>packages/daemon/src/__tests__/database-policy-engine.test.ts</files>
  <action>
Add a new `describe('DatabasePolicyEngine - Backward Compatibility (CMPT-01/02/03)', ...)` block after the existing `evaluateSpendingLimit with token_limits` describe block (after line 2482). Add the following tests:

**CMPT-01: Raw-only policies unchanged**

1. "CMPT-01a: raw-only policy (no token_limits, no USD) returns INSTANT for small amount" -- Insert SPENDING_LIMIT policy with raw fields only (instant_max: '1000000000', notify_max: '10000000000', delay_max: '50000000000', delay_seconds: 300). Evaluate with TRANSFER amount '500000000' (0.5 SOL). Expect INSTANT. This matches pre-v27.3 test "should classify amount below instant_max as INSTANT".

2. "CMPT-01b: raw-only policy returns NOTIFY for medium amount" -- Same policy as above. Evaluate TRANSFER '5000000000' (5 SOL). Expect NOTIFY.

3. "CMPT-01c: raw-only policy returns DELAY for large amount" -- Same policy. Evaluate TRANSFER '30000000000' (30 SOL). Expect DELAY with delaySeconds: 300.

4. "CMPT-01d: raw-only policy returns APPROVAL for amount exceeding delay_max" -- Same policy. Evaluate TRANSFER '60000000000' (60 SOL). Expect APPROVAL.

**CMPT-02: token_limits priority over raw**

5. "CMPT-02a: token_limits takes priority over raw for matching TOKEN_TRANSFER" -- Insert policy with both raw fields (instant_max: '1000000000', notify_max: '10000000000', delay_max: '50000000000') AND token_limits: { 'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v': { instant_max: '100', notify_max: '1000', delay_max: '10000' } }. Evaluate TOKEN_TRANSFER with amount '500000000' (500 USDC raw units with 6 decimals = 500 USDC), tokenAddress: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', assetId: 'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', tokenDecimals: 6. In token_limits, 500 > instant_max(100), 500 <= notify_max(1000) -> token tier = NOTIFY. Via raw, 500000000 would be <= instant_max(1B) -> INSTANT. But token_limits takes priority. Expect NOTIFY.

6. "CMPT-02b: non-matching token falls back to raw fields" -- Same policy with token_limits for USDC. Evaluate TOKEN_TRANSFER with amount '5000000000' (different token), tokenAddress: 'DiffTokenAddress', no assetId match. No token_limits match -> falls back to raw: 5B > instant_max(1B), <= notify_max(10B) -> NOTIFY. Expect NOTIFY.

7. "CMPT-02c: TRANSFER (native) with raw + token_limits uses raw when no native key match" -- Same policy (token_limits has only CAIP-19 USDC key, no native key). TRANSFER '500000000' on solana. No native key match -> falls back to raw: 500M <= instant_max(1B) -> INSTANT. Expect INSTANT.

**CMPT-03: Cumulative USD limits unaffected by token_limits**

8. "CMPT-03a: daily_limit_usd works independently of token_limits (via evaluateAndReserve)" -- Insert policy with raw fields + token_limits + daily_limit_usd: 100. Use `engineWithSqlite.evaluateAndReserve()`. First insert a CONFIRMED transaction with amount_usd = 90 into DB (via raw SQL: `INSERT INTO transactions (id, wallet_id, chain, type, amount, to_address, status, amount_usd, created_at) VALUES (?, ?, 'solana', 'TRANSFER', '0', 'addr', 'CONFIRMED', 90, ?)`  with created_at = now). Then evaluateAndReserve a new TRANSFER with usdAmount=20 (total 110 > 100). Expect tier: 'APPROVAL', approvalReason: 'cumulative_daily'. This proves daily_limit_usd works independently.

9. "CMPT-03b: BATCH evaluation ignores token_limits (tokenContext undefined)" -- Insert SPENDING_LIMIT with raw + token_limits. Use engine.evaluateBatch with two TRANSFER instructions summing to 5 SOL. Expect NOTIFY (via raw: 5B > instant_max 1B, <= notify_max 10B). Token_limits should not interfere since BATCH has no tokenContext.

Use the existing helper functions: `tx()`, `tokenTx()`, `insertPolicy()`, `insertTestAgent()`, `insertTransaction()`. For tests requiring evaluateAndReserve, use `engineWithSqlite` which was set up in beforeEach.

For test 8, insert the CONFIRMED transaction directly via `conn.sqlite.prepare(...).run(...)` as is done in other TOCTOU tests.
  </action>
  <verify>Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/database-policy-engine.test.ts` -- all tests pass including new backward compat tests.</verify>
  <done>9 new backward compatibility tests pass, covering CMPT-01 (raw-only unchanged), CMPT-02 (token_limits priority), and CMPT-03 (cumulative limits unaffected).</done>
</task>

<task type="auto">
  <name>Task 2: Document token_limits in policies.skill.md</name>
  <files>skills/policies.skill.md</files>
  <action>
Update the SPENDING_LIMIT section (Section 2a) in `skills/policies.skill.md` to document the token_limits field. Make the following changes:

1. **Update the Rules schema JSON example** in Section 2a to include token_limits:
```json
{
  "instant_max": "100000000",
  "notify_max": "500000000",
  "delay_max": "1000000000",
  "delay_seconds": 300,
  "instant_max_usd": 10,
  "notify_max_usd": 100,
  "delay_max_usd": 1000,
  "daily_limit_usd": 500,
  "monthly_limit_usd": 5000,
  "token_limits": {
    "native:solana": {"instant_max": "1", "notify_max": "10", "delay_max": "50"},
    "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v": {"instant_max": "100", "notify_max": "1000", "delay_max": "10000"}
  }
}
```

2. **Update the field table** to mark `instant_max`, `notify_max`, `delay_max` as "No" (optional, was "Yes") and add `token_limits`:

| Field | Type | Required | Description |
| `instant_max` | string | No | Max amount for INSTANT tier (digit string, raw units). Optional when token_limits or USD thresholds are set. |
| `notify_max` | string | No | Max amount for NOTIFY tier (digit string, raw units). Optional when token_limits or USD thresholds are set. |
| `delay_max` | string | No | Max amount for DELAY tier (digit string, raw units). Optional when token_limits or USD thresholds are set. |
| `token_limits` | object | No | Token-specific spending limits in human-readable units, keyed by CAIP-19 asset identifier. See Token-Specific Limits below. |

3. **Add a new subsection** after the existing "Cumulative limit evaluation" paragraph, titled "**Token-specific limits (token_limits):**". Content:

"When `token_limits` is set, the policy engine evaluates transaction amounts against per-token thresholds in human-readable units (e.g., SOL, USDC) instead of raw smallest-unit amounts. Each key is a CAIP-19 asset identifier or native token shorthand."

"**Key format:**"
- `"native"` -- native token of the policy's network (only valid when policy has `network` set)
- `"native:{chain}"` -- native token of a specific chain (e.g., `"native:solana"` for SOL, `"native:ethereum"` for ETH)
- `"{caip19}"` -- CAIP-19 asset ID for a specific token (e.g., `"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"` for USDC on Solana)

"**Matching priority:** exact CAIP-19 asset ID > `native:{chain}` > `native` shorthand > raw field fallback."

"**Value format:** Each value is an object with `instant_max`, `notify_max`, `delay_max` as human-readable decimal strings (e.g., `"1.5"` for 1.5 SOL, `"1000"` for 1000 USDC)."

"**Fallback behavior:** When a transaction's token does not match any `token_limits` key, the engine falls back to raw fields (`instant_max`/`notify_max`/`delay_max`). When raw fields are also absent, the native tier defaults to INSTANT (most permissive), and USD thresholds alone determine the tier."

"**Scope:** `token_limits` applies to TRANSFER, TOKEN_TRANSFER, and APPROVE transactions. CONTRACT_CALL and BATCH use raw/USD evaluation only."

"**Interaction with USD and cumulative limits:** Per-transaction tier = `max(USD tier, token/native tier)`. Cumulative limits (`daily_limit_usd`, `monthly_limit_usd`) are evaluated independently after per-transaction tier assignment and are unaffected by `token_limits`."

4. **Add a new workflow example** in Section 4 titled "### Set token-specific spending limits":

```bash
# Set per-token limits: 1 SOL instant, 10 SOL notify, 50 SOL delay for native Solana
# Plus 100 USDC instant, 1000 USDC notify, 10000 USDC delay for USDC
curl -s -X POST http://localhost:3100/v1/policies \
  -H 'Content-Type: application/json' \
  -H 'X-Master-Password: <password>' \
  -d '{"walletId":"<uuid>","type":"SPENDING_LIMIT","rules":{"token_limits":{"native:solana":{"instant_max":"1","notify_max":"10","delay_max":"50"},"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v":{"instant_max":"100","notify_max":"1000","delay_max":"10000"}},"daily_limit_usd":500}}'
```

"Native SOL transfers of <= 1 SOL are INSTANT. USDC transfers of <= 100 USDC are INSTANT. Both respect the $500/day cumulative limit."

5. **Update version** in frontmatter from `"2.5.0-rc"` to `"2.6.0-rc"` (or appropriate next version indicating token_limits addition).

Do NOT change any other sections. Keep all existing content intact.
  </action>
  <verify>Read `skills/policies.skill.md` and confirm: (1) token_limits appears in the SPENDING_LIMIT rules schema example, (2) field table includes token_limits row with description, (3) "Token-specific limits" subsection exists with key format, matching priority, fallback behavior, (4) workflow example for token-specific limits exists.</verify>
  <done>policies.skill.md documents token_limits field with CAIP-19 key format, matching priority, fallback behavior, scope, interaction with USD/cumulative limits, and a curl example.</done>
</task>

</tasks>

<verification>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/database-policy-engine.test.ts` -- all tests pass (existing 88 + ~9 new)
2. Grep skills/policies.skill.md for "token_limits" -- appears in schema, table, subsection, and example
3. Grep for "CAIP-19" in policies.skill.md -- appears in token_limits documentation
4. No changes to database-policy-engine.ts (read-only verification, no production code changes)
</verification>

<success_criteria>
1. All existing 88 tests in database-policy-engine.test.ts continue to pass (no regressions)
2. 9 new backward compatibility tests pass covering CMPT-01 (raw-only), CMPT-02 (priority), CMPT-03 (cumulative unaffected)
3. policies.skill.md includes token_limits documentation with CAIP-19 key format, matching priority, examples
4. No changes to production code files
</success_criteria>

<output>
After completion, create `.planning/phases/238-compat-docs/238-01-SUMMARY.md`
</output>
