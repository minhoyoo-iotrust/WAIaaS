---
phase: 178-adapter-solana-branch-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/adapters/solana/src/__tests__/solana-tx-parser-branches.test.ts
  - packages/adapters/solana/src/__tests__/solana-misc-branches.test.ts
autonomous: true
requirements:
  - SOL-03
  - SOL-04

must_haves:
  truths:
    - "tx-parser parseSystemInstruction with data < 12 bytes returns CONTRACT_CALL fallback"
    - "tx-parser parseSystemInstruction with non-transfer index returns CONTRACT_CALL with method hex"
    - "tx-parser parseTokenInstruction with empty data returns UNKNOWN"
    - "tx-parser parseTokenInstruction with SPL_APPROVE (type 4) returns APPROVE without token field"
    - "tx-parser identifyOperation with Token-2022 program address dispatches to parseTokenInstruction"
    - "tx-parser CONTRACT_CALL method field: data >= 8 bytes uses first 8, 0 < data < 8 bytes uses all, empty data is undefined"
    - "getAssets sort comparator returns 0 when two non-native tokens have equal balance"
    - "getAssets re-throws WAIaaSError without wrapping"
    - "estimateFee throws ChainError TOKEN_ACCOUNT_NOT_FOUND for missing mint"
    - "estimateFee re-throws ChainError and WAIaaSError without wrapping"
    - "Error instanceof branches in catch blocks distinguish Error from non-Error values"
    - "adapter-solana branch coverage report shows >= 75% branches covered (threshold update deferred to Phase 181)"
  artifacts:
    - path: "packages/adapters/solana/src/__tests__/solana-tx-parser-branches.test.ts"
      provides: "Branch-focused tests for tx-parser.ts edge cases"
    - path: "packages/adapters/solana/src/__tests__/solana-misc-branches.test.ts"
      provides: "Tests for Error instanceof branches, getAssets sort edge cases, estimateFee error paths"
  key_links:
    - from: "packages/adapters/solana/src/__tests__/solana-tx-parser-branches.test.ts"
      to: "packages/adapters/solana/src/tx-parser.ts"
      via: "parseSolanaTransaction public function"
      pattern: "parseSolanaTransaction"
    - from: "packages/adapters/solana/src/__tests__/solana-misc-branches.test.ts"
      to: "packages/adapters/solana/src/adapter.ts"
      via: "getAssets, estimateFee, error handling branches"
      pattern: "adapter\\.(getAssets|estimateFee)"
---

<objective>
Add branch-coverage tests for tx-parser.ts edge cases and adapter.ts miscellaneous uncovered branches (Error instanceof checks, getAssets sort logic, estimateFee error paths) to close ~58 remaining uncovered branches and reach 75% branch coverage.

Purpose: SOL-03 requires tx-parser.ts parsing failure, unknown instruction, and null coalescing fallback branches to be tested. SOL-04 requires Error instanceof branches, getAssets sort logic, and estimateFee token/native branching to be tested. Combined with Plan 01, this should push branch coverage above 75%.

Output: Two new test files covering tx-parser edge cases and miscellaneous adapter branches.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/adapters/solana/src/tx-parser.ts
@packages/adapters/solana/src/adapter.ts
@packages/adapters/solana/src/__tests__/solana-sign-only.test.ts
@packages/adapters/solana/src/__tests__/solana-token-transfer.test.ts
@packages/adapters/solana/src/__tests__/solana-adapter.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: tx-parser.ts branch-coverage tests</name>
  <files>packages/adapters/solana/src/__tests__/solana-tx-parser-branches.test.ts</files>
  <action>
Create a new test file `solana-tx-parser-branches.test.ts` that targets uncovered branches in `tx-parser.ts`. This is an offline parser, so no RPC mocking is needed. Use the same approach as `solana-sign-only.test.ts` -- build real Solana transactions with specific instruction patterns to trigger the uncovered branches.

The file must cover these SPECIFIC uncovered branches:

**parseSystemInstruction branches:**
1. Short data (< 12 bytes) -- SystemProgram instruction with fewer than 12 bytes of data should return `{ type: 'CONTRACT_CALL', programId: SYSTEM_PROGRAM_ADDRESS, method: toHex(data.slice(0,4)) }`. Build a transaction with a raw SystemProgram instruction that has only 4 bytes of data (not a transfer).
2. Non-transfer index -- SystemProgram instruction with >= 12 bytes but instrIndex != 2 (SYSTEM_TRANSFER_INDEX). Build a transaction with SystemProgram.createAccount (index 0) or SystemProgram.assign (index 1). This should return CONTRACT_CALL with the method hex.
3. Short data for method (< 4 bytes) -- SystemProgram instruction with 1-3 bytes. The `data.length >= 4 ? toHex(data.slice(0, 4)) : undefined` branch. Should return CONTRACT_CALL with method undefined.

**parseTokenInstruction branches:**
4. Empty data (data.length === 0) -- should return `{ type: 'UNKNOWN' }`. Build a transaction with the Token Program address but zero-length instruction data.
5. SPL_APPROVE (type 4, not ApproveChecked type 13) -- The existing test only covers ApproveChecked (type 13). Type 4 should return APPROVE with `token: undefined` and `to: accounts[1]` (delegate). Build a raw instruction with data[0] = 4.
6. TransferChecked with short data (data.length < 10) -- instrType === SPL_TRANSFER_CHECKED but data is too short. Should fall through to "other token instructions" and return CONTRACT_CALL.
7. Other token instruction type (not 4, 12, or 13) -- e.g., type 7 (MintTo). Should return CONTRACT_CALL with programId = TOKEN_PROGRAM_ADDRESS and method hex.

**identifyOperation branches:**
8. Token-2022 program address (TOKEN_2022_ADDRESS) -- should dispatch to parseTokenInstruction. Build a transaction with Token-2022 program ID. The existing sign-only tests only use TOKEN_PROGRAM_ADDRESS.

**CONTRACT_CALL method field branches (in identifyOperation):**
9. Unknown program with data >= 8 bytes -- method = toHex(data.slice(0, 8)). Already tested in existing tests.
10. Unknown program with 0 < data < 8 bytes -- method = toHex(data). Build a tx with a custom program and 3 bytes of data.
11. Unknown program with empty data (0 bytes) -- method = undefined. Build a tx with a custom program and no instruction data.

**Null coalescing fallbacks in parseSolanaTransaction:**
12. `compiledMessage.staticAccounts ?? []` -- compiledMessage with no staticAccounts field. Hard to trigger with real transactions (decoder always provides it). Document as defensive fallback.
13. `compiledMessage.instructions ?? []` -- Same defensive fallback. Document.
14. `instruction.accountIndices ?? []` -- Instructions with no accountIndices. Build a transaction with an instruction that has no accounts.
15. `instruction.data ?? new Uint8Array(0)` -- Instructions with no data field. This maps to the empty data test above.

**Approach for building raw instructions:**
Use the same @solana/kit pipe pattern. For raw SystemProgram/Token instructions with specific binary data, build the instruction directly as `{ programAddress: address(...), accounts: [...], data: new Uint8Array([...]) }` and append it to a transaction message. Compile and encode to base64, then parse with `parseSolanaTransaction()`.

NOTE: Import `parseSolanaTransaction` directly from `../tx-parser.js` for unit testing the parser function. Also test via `adapter.parseTransaction()` to ensure integration.
  </action>
  <verify>
Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/adapter-solana test -- --run src/__tests__/solana-tx-parser-branches.test.ts`
All tests must pass with 0 failures.
  </verify>
  <done>
At least 10 new test cases pass, covering parseSystemInstruction short data + non-transfer index, parseTokenInstruction empty data + SPL_APPROVE + short TransferChecked + other types, Token-2022 dispatch, unknown program method field variants, and documented null coalescing defensive branches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Error instanceof + getAssets sort + estimateFee error branch tests</name>
  <files>packages/adapters/solana/src/__tests__/solana-misc-branches.test.ts</files>
  <action>
Create a new test file `solana-misc-branches.test.ts` that targets remaining uncovered branches in `adapter.ts`. Uses the vi.hoisted + vi.mock pattern (same as `solana-adapter.test.ts`).

The file must cover these SPECIFIC uncovered branches:

**getAssets sort comparator edge cases (lines 240-246):**
1. Two non-native tokens with exactly equal balance -- the comparator should return 0 (fallthrough to default). Mock getTokenAccountsByOwner to return two tokens with the same balance value. Verify the sort result includes both tokens (order may vary since sort is not stable for equal elements, but both must be present).

**getAssets WAIaaSError re-throw (line 250):**
2. When the error in the catch block is an instance of WAIaaSError, it should re-throw without wrapping. Mock getBalance to throw a WAIaaSError directly. Verify that getAssets throws the exact same WAIaaSError instance (not wrapped in another WAIaaSError).

**estimateFee ChainError token paths (lines 456-507):**
3. estimateFee for token transfer where mint is not found (`mintAccountInfo.value` is null) -- should throw `ChainError('TOKEN_ACCOUNT_NOT_FOUND')`. Note: existing tests cover the native path and the ATA exists/not-exists path, but not the mint-not-found error path inside estimateFee specifically.
4. estimateFee ChainError re-throw (line 501) -- when the inner code throws a ChainError, it should re-throw without wrapping. The mint-not-found test from #3 exercises this path.
5. estimateFee WAIaaSError re-throw (line 502) -- when the inner code throws a WAIaaSError, it should re-throw. Mock to throw WAIaaSError from inside the token path.

**Error instanceof branches in catch blocks:**
These are the `error instanceof Error ? error.message : String(error)` ternaries that appear in nearly every catch block. The `String(error)` branch is for when a non-Error value is thrown.

6. getBalance with non-Error thrown (e.g., string) -- mock getBalance RPC to reject with a string value `'rpc-down'`. Verify WAIaaSError is thrown and the message includes `'rpc-down'`.
7. buildTransaction with non-Error thrown -- mock getLatestBlockhash to reject with a number. Verify WAIaaSError wraps it.
8. simulateTransaction with non-Error thrown -- mock simulateTransaction to reject with null. Verify WAIaaSError wraps with String(null).
9. submitTransaction with non-Error thrown -- mock sendTransaction to reject with undefined.
10. signTransaction with non-Error thrown -- mock createKeyPairFromBytes to throw a non-Error (harder to mock since it's imported from @solana/kit which is partially mocked). Instead, provide an invalid private key that causes an internal error.

**buildTransaction WAIaaSError re-throw (line 314):**
11. When buildTransaction inner code throws a WAIaaSError (e.g., from ensureConnected), it should re-throw without wrapping. This is already tested by the "not connected" tests in solana-adapter.test.ts. Document that this branch is covered.

**signTransaction 32-byte key branch (line 357):**
12. Call signTransaction with a 32-byte private key (not 64-byte). Verify it works (uses createKeyPairFromPrivateKeyBytes path). Build a real unsigned transaction and sign with the 32-byte seed.

**getTokenInfo raw data handling branches (lines 666-673):**
13. getTokenInfo with raw data array shorter than 2 elements -- mock getAccountInfo to return data that is not an array or has length < 2. The `Array.isArray(rawData) && rawData.length >= 2` check should fail, resulting in decimals = 0.
14. getTokenInfo with decoded buffer shorter than 45 bytes -- the `decoded.length >= 45` check should fail, resulting in decimals = 0.

**Mock setup:** Use vi.hoisted + vi.mock for @solana/kit (same pattern as solana-adapter.test.ts). Also mock @solana-program/token since adapter.ts imports from it.
  </action>
  <verify>
Run: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/adapter-solana test -- --run src/__tests__/solana-misc-branches.test.ts`
All tests must pass with 0 failures.
  </verify>
  <done>
At least 12 new test cases pass, covering getAssets sort equal-balance edge case, WAIaaSError re-throw paths, estimateFee mint-not-found + error re-throw paths, non-Error throw handling in multiple methods, signTransaction 32-byte key, and getTokenInfo short data handling.
  </done>
</task>

</tasks>

<verification>
1. Run all adapter-solana tests: `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/adapter-solana test -- --run`
2. All existing + new tests pass with 0 failures
3. Run coverage: `pnpm --filter @waiaas/adapter-solana test -- --run --coverage` and verify branch coverage >= 75%
4. The branches threshold of 65 in vitest.config.ts still passes (it will -- we're adding coverage, not removing it)
</verification>

<success_criteria>
- 22+ new test cases across 2 files pass
- All existing tests continue to pass (no regressions)
- tx-parser.ts branch coverage significantly improved (all instruction type branches exercised)
- adapter.ts Error instanceof branches exercised with non-Error values
- getAssets sort comparator equal-balance edge case covered
- estimateFee token error paths covered
- Overall branch coverage for @waiaas/adapter-solana reaches >= 75%
</success_criteria>

<output>
After completion, create `.planning/phases/178-adapter-solana-branch-coverage/178-02-SUMMARY.md`
</output>
