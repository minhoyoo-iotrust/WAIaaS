---
phase: 179-admin-functions-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/__tests__/settings-coverage.test.tsx
  - packages/admin/src/__tests__/wallets-coverage.test.tsx
  - packages/admin/src/__tests__/dashboard-coverage.test.tsx
autonomous: true
requirements:
  - ADM-01
  - ADM-02

must_haves:
  truths:
    - "settings.tsx uncovered functions (handleRpcTest, handleNotifTest, handleSaveApiKey, handleDeleteApiKey, handleKillSwitchActivate/Escalate/Recover, handleRotate, handleShutdown, getEffectiveValue, getEffectiveBoolValue, isCredentialConfigured, handleFieldChange) are exercised by tests"
    - "wallets.tsx WalletDetailView functions (fetchWallet, handleSaveName, handleDelete, startEdit, cancelEdit, handleMcpSetup, fetchNetworks, fetchBalance, fetchTransactions, fetchWcSession, handleWcConnect, handleWcDisconnect, startEditOwner, cancelEditOwner, handleSaveOwner, handleChangeDefaultNetwork) are exercised by tests"
    - "dashboard.tsx StatCard and buildTxColumns functions are exercised by tests covering badge variants, href links, and amount formatting"
  artifacts:
    - path: "packages/admin/src/__tests__/settings-coverage.test.tsx"
      provides: "Settings page function coverage tests"
      min_lines: 200
    - path: "packages/admin/src/__tests__/wallets-coverage.test.tsx"
      provides: "Wallets detail view function coverage tests"
      min_lines: 200
    - path: "packages/admin/src/__tests__/dashboard-coverage.test.tsx"
      provides: "Dashboard StatCard and buildTxColumns coverage tests"
      min_lines: 80
  key_links:
    - from: "packages/admin/src/__tests__/settings-coverage.test.tsx"
      to: "packages/admin/src/pages/settings.tsx"
      via: "import and render SettingsPage"
      pattern: "import.*SettingsPage.*from.*settings"
    - from: "packages/admin/src/__tests__/wallets-coverage.test.tsx"
      to: "packages/admin/src/pages/wallets.tsx"
      via: "import and render WalletsPage with detail path"
      pattern: "import.*WalletsPage.*from.*wallets"
---

<objective>
Add function coverage tests for settings.tsx, wallets.tsx (detail view), and dashboard.tsx to exercise their uncovered handler functions.

Purpose: These three page components collectively have ~27 uncovered functions (settings 50.79%, wallets 50%, dashboard 50% function coverage). Testing their event handlers, API call sequences, and render helpers raises overall admin function coverage significantly toward the 70% target.

Output: Three new test files exercising the uncovered functions via render + fireEvent + waitFor patterns.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/admin/src/pages/settings.tsx
@packages/admin/src/pages/wallets.tsx
@packages/admin/src/pages/dashboard.tsx
@packages/admin/src/__tests__/settings.test.tsx
@packages/admin/src/__tests__/wallets.test.tsx
@packages/admin/src/__tests__/dashboard.test.tsx
@packages/admin/src/__tests__/setup.ts
@packages/admin/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings.tsx uncovered function tests</name>
  <files>packages/admin/src/__tests__/settings-coverage.test.tsx</files>
  <action>
Create a NEW test file `settings-coverage.test.tsx` (separate from existing `settings.test.tsx` to avoid conflicts and keep context manageable).

Use the same mock pattern as existing `settings.test.tsx`:
- vi.mock('../api/client') with apiGet, apiPost, apiPut, apiDelete, ApiError
- vi.mock('../components/toast') with showToast
- vi.mock('../auth/store') with masterPassword signal
- vi.mock('../utils/error-messages') with getErrorMessage

Mock data: Provide a full `mockSettingsResponse` covering rpc, notifications, security, session, policy, walletconnect, autostop, monitoring, telegram, display categories. Provide mockKillSwitchActive/Suspended/Locked, mockApiKeys.

Write tests covering these specific uncovered functions:

1. **handleRpcTest**: Render SettingsPage, wait for load, find an RPC URL input field (e.g. `rpc.solana_devnet`), enter a URL value, click the "Test" button next to it. Assert apiPost was called with API.ADMIN_SETTINGS_TEST_RPC and { url, chain: 'solana' }. Also test the EVM variant (chain detection via key prefix). Test error branch where apiPost throws.

2. **handleNotifTest**: After render, find the "Test Notifications" button in the Notifications section, click it. Assert apiPost called with API.ADMIN_NOTIFICATIONS_TEST. Test success (all results.success=true → showToast('success')), partial failure (some fail → showToast('warning')), empty results (→ showToast('info')), and error throw.

3. **handleSaveApiKey / handleDeleteApiKey**: Mock apiGet for API.ADMIN_API_KEYS to return a list of keys. Click "Edit" on a key, enter value, click "Save". Assert apiPut called. Click "Delete" on a key. Assert apiDelete called.

4. **handleKillSwitchActivate / Escalate / Recover**: Render with killswitch in ACTIVE state → click "Activate Kill Switch" → assert apiPost(API.ADMIN_KILL_SWITCH). Render with SUSPENDED → click "Escalate" → assert apiPost(API.ADMIN_KILL_SWITCH_ESCALATE). Render with SUSPENDED → click "Recover" → assert apiPost(API.ADMIN_RECOVER).

5. **handleRotate**: Click "Rotate JWT Secret" → confirm in modal → assert apiPost(API.ADMIN_ROTATE_SECRET).

6. **handleShutdown**: Click "Shutdown Daemon" → type "SHUTDOWN" confirmation → click confirm → assert apiPost(API.ADMIN_SHUTDOWN).

7. **getEffectiveValue / getEffectiveBoolValue / isCredentialConfigured / handleFieldChange**: These are exercised implicitly when fields render and when fields are changed. Test: verify a credential field shows placeholder when configured (boolean true from GET), verify changing a field adds it to dirty state, verify boolean toggle fields work.

Each test should use render(<SettingsPage />), waitFor to settle initial loads, then fireEvent.click/change to trigger handlers.
  </action>
  <verify>
Run `pnpm --filter @waiaas/admin test -- --run src/__tests__/settings-coverage.test.tsx` and confirm all tests pass.
Run `pnpm --filter @waiaas/admin test -- --coverage` and verify settings.tsx function coverage has increased from 50.79% toward 80%+.
  </verify>
  <done>settings.tsx function coverage reaches 75%+ with all uncovered handler functions (RPC test, notification test, API key management, kill switch operations, rotate, shutdown) exercised by tests.</done>
</task>

<task type="auto">
  <name>Task 2: Add wallets.tsx detail view + dashboard.tsx function tests</name>
  <files>packages/admin/src/__tests__/wallets-coverage.test.tsx, packages/admin/src/__tests__/dashboard-coverage.test.tsx</files>
  <action>
**wallets-coverage.test.tsx**: Create a NEW test file (separate from existing `wallets.test.tsx`).

Use the same mock pattern. Additionally mock `../components/layout` with `currentPath` signal set to `/wallets/test-wallet-1` to trigger WalletDetailView rendering.

Mock apiGet to return wallet detail data for API.WALLET('test-wallet-1'), networks for API.WALLET_NETWORKS, balance for API.ADMIN_WALLET_BALANCE, transactions for API.ADMIN_WALLET_TRANSACTIONS, and WC session for API.WALLET_WC_SESSION.

Test these uncovered functions:

1. **WalletDetailView rendering**: Render WalletsPage with currentPath='/wallets/test-wallet-1'. Wait for detail to load. Assert wallet name, chain, publicKey, etc. are displayed.

2. **handleSaveName**: Click edit button (pencil icon), change name input, click Save. Assert apiPut called with { name: newName }. Assert success toast.

3. **handleDelete**: Click "Terminate Wallet" button → modal opens → click confirm → assert apiDelete called. Assert redirect to '#/wallets'.

4. **handleMcpSetup**: Click "Setup MCP" button → assert apiPost(API.MCP_TOKENS, { walletId }). Assert MCP result displays (token path, claude desktop config).

5. **handleChangeDefaultNetwork**: Find a non-default network in the networks list, click "Set Default". Assert apiPut(API.WALLET_DEFAULT_NETWORK).

6. **startEditOwner / cancelEditOwner / handleSaveOwner**: Click "Set Owner Address" → enter address → click Save → assert apiPut(API.WALLET_OWNER). Also test cancel, and test empty address validation (showToast error).

7. **handleWcConnect / handleWcDisconnect**: Click "Connect Wallet" when ownerAddress is set → assert apiPost(API.WALLET_WC_PAIR). For disconnect, render with WC session, click Disconnect → assert apiDelete(API.WALLET_WC_SESSION).

8. **Error handling**: Test that when apiGet/apiPost/apiPut/apiDelete throws ApiError, showToast('error') is called with the correct message.

**dashboard-coverage.test.tsx**: Create NEW test file.

Test these uncovered functions:

1. **StatCard with badge**: Render DashboardPage with killSwitchState='ACTIVATED'. Assert badge variant 'danger' is rendered. Test with 'NORMAL' for 'success' badge.

2. **StatCard with href**: Assert links to #/wallets, #/sessions, #/policies are rendered as `<a>` tags.

3. **buildTxColumns amount rendering**: Mock status with recentTransactions including: (a) tx with amountUsd=100 + displayCurrency=USD → shows "$100.00", (b) tx with amount=null → shows dash, (c) tx with CONFIRMED/FAILED/PENDING statuses → correct badge variants.

4. **fetchDisplayCurrency integration**: Mock apiGet to return display settings with non-USD currency. Assert the currency display loads correctly. Test USD fallback on error.
  </action>
  <verify>
Run `pnpm --filter @waiaas/admin test -- --run src/__tests__/wallets-coverage.test.tsx src/__tests__/dashboard-coverage.test.tsx` and confirm all tests pass.
Run `pnpm --filter @waiaas/admin test -- --coverage` and verify wallets.tsx function coverage increased from 50% toward 75%+ and dashboard.tsx from 50% toward 80%+.
  </verify>
  <done>wallets.tsx WalletDetailView functions are tested (function coverage 70%+), dashboard.tsx StatCard/buildTxColumns/fetchDisplayCurrency are tested (function coverage 80%+).</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `pnpm --filter @waiaas/admin test -- --coverage` should show:
   - settings.tsx functions >= 75%
   - wallets.tsx functions >= 70%
   - dashboard.tsx functions >= 80%
   - Overall admin functions should be noticeably higher than 57.95%
2. All existing tests continue to pass (no regressions).
</verification>

<success_criteria>
- All new test files pass without errors
- No regressions in existing admin tests (98 tests still passing)
- settings.tsx, wallets.tsx, and dashboard.tsx function coverage each improved by 20%+ points
- Overall admin function coverage is closer to 70% target (should reach ~63-65% after this plan)
</success_criteria>

<output>
After completion, create `.planning/phases/179-admin-functions-coverage/179-01-SUMMARY.md`
</output>
