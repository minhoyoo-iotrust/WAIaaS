# Milestone v1.5.3: USD 정책 확장 (누적 지출 한도 + 표시 통화)

**Status:** SHIPPED 2026-02-16
**Phases:** 136-139
**Total Plans:** 8
**Requirements:** 19 (CUMUL-01~10, DISP-01~09)

## Overview

월렛 단위 기간별 누적 USD 지출 한도로 분할 전송 우회를 방지하고, USD 외 사용자 선호 법정 통화로 금액을 환산 표시하여 다국어 DX를 개선한다.

## Phases

### Phase 136: 누적 지출 한도 엔진
**Goal**: 월렛별 기간 내 누적 USD 지출이 추적되고, 한도 초과 시 APPROVAL로 격상되며, Owner에게 경고 알림이 발송되는 상태
**Depends on**: v1.5.2 (Phase 135) 완료
**Requirements**: CUMUL-01, CUMUL-02, CUMUL-03, CUMUL-04, CUMUL-05, CUMUL-06, CUMUL-07
**Plans**: 2 plans

Plans:
- [x] 136-01-PLAN.md -- DB v13 마이그레이션 + Drizzle/Zod 스키마 확장 + evaluateAndReserve USD 기록
- [x] 136-02-PLAN.md -- 누적 USD 집계 + APPROVAL 격상 + CUMULATIVE_LIMIT_WARNING 알림 + reason 필드

### Phase 137: 누적 한도 Admin UI + SDK/MCP
**Goal**: Admin UI에서 누적 한도를 설정/확인하고, SDK/MCP로 누적 한도 포함 정책을 프로그래밍 방식으로 관리할 수 있는 상태
**Depends on**: Phase 136
**Requirements**: CUMUL-08, CUMUL-09, CUMUL-10
**Plans**: 2 plans

Plans:
- [x] 137-01-PLAN.md -- SpendingLimitForm 누적 필드 + PolicyRulesSummary 누적 시각화
- [x] 137-02-PLAN.md -- SDK/MCP 누적 한도 필드 확장 + 스킬 파일 동기화

### Phase 138: ForexRateService + 표시 통화 설정
**Goal**: USD에서 43개 법정 통화로의 환율 조회가 동작하고, Admin Settings에서 표시 통화를 선택하면 즉시 반영되며, Intl.NumberFormat 기반 통화 포매팅이 적용되는 상태
**Depends on**: Phase 136 (DB 마이그레이션 완료)
**Requirements**: DISP-01, DISP-02, DISP-03, DISP-04, DISP-09
**Plans**: 2 plans

Plans:
- [x] 138-01-PLAN.md -- IForexRateService 인터페이스 + CoinGeckoForexProvider + ForexRateService + formatDisplayCurrency 유틸 + 테스트
- [x] 138-02-PLAN.md -- config.toml display 섹션 + SettingsService display 카테고리 + Admin CurrencySelect 드롭다운 + daemon 부트스트랩

### Phase 139: 표시 통화 통합
**Goal**: Admin UI 전체, 알림 메시지, REST API, MCP 도구에서 선택한 통화로 환산된 금액이 표시되는 상태
**Depends on**: Phase 138
**Requirements**: DISP-05, DISP-06, DISP-07, DISP-08
**Plans**: 2 plans

Plans:
- [x] 139-01-PLAN.md -- Admin UI 환산 표시 + 알림 메시지 환산
- [x] 139-02-PLAN.md -- REST API display_currency 쿼리 + MCP 환산 응답 + 스킬 파일 동기화

---

## Milestone Summary

**Key Decisions:**
- amount_usd 기록은 Stage 3에서 UPDATE (비동기 오라클 -> 동기 DB 분리)
- reserved_amount_usd 컬럼으로 이중 지출 방지 (실시간 재환산 대신 기록 시점 고정)
- IForexRateService를 IPriceOracle과 분리 (crypto/forex 관심사 분리)
- CoinGecko tether vs_currencies 방식으로 USD→법정통화 환율 조회
- InMemoryPriceCache 별도 인스턴스 (30분 TTL -- crypto 캐시와 분리)
- SIGNED 중복 방지 -- CONFIRMED/SIGNED는 amount_usd, PENDING/QUEUED는 reserved_amount_usd로 분리 집계
- daily 초과 감지 시 monthly 평가 스킵 (중복 알림 방지)
- Admin CSP 환경으로 formatDisplayCurrency 로직 인라인 복제

**Issues Deferred:**
- 과거 트랜잭션 amount_usd 백필 (DISP-F01)
- 누적 사용량 리셋 API (CUMUL-F01)
- 주별 누적 한도 (CUMUL-F02)

**Technical Debt:**
- Admin display-currency.ts에 core의 formatDisplayCurrency 로직 복제 (CSP 제약)
- Pre-existing flaky lifecycle.test.ts + 3 CLI E2E failures (E-07~09)

---
_For current project status, see .planning/ROADMAP.md_
