---
phase: 163-release-please
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
autonomous: true
requirements: [RLSE-04, RLSE-05, RLSE-06]

must_haves:
  truths:
    - "GitHub Release published 이벤트로 release.yml이 자동 트리거된다"
    - "품질 게이트(test, chain-integration, platform, publish-check) 통과 후 deploy job이 environment: production으로 대기한다"
    - "배포 승인 후 npm publish dry-run + Docker push가 실행된다 (v2.0 전까지 dry-run)"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "릴리스 품질 게이트 + 2-게이트 deploy job"
      contains: "environment: production"
  key_links:
    - from: ".github/workflows/release.yml (deploy job)"
      to: "test + chain-integration + platform + publish-check jobs"
      via: "needs dependency"
      pattern: "needs:.*test.*platform.*chain-integration.*publish-check"
    - from: ".github/workflows/release-please.yml"
      to: ".github/workflows/release.yml"
      via: "GitHub Release published event chain"
      pattern: "on:\\s+release:\\s+types:\\s+\\[published\\]"
---

<objective>
기존 release.yml에 deploy job을 추가하여, 품질 게이트 통과 후 `environment: production`으로 수동 승인 대기 → 승인 후 npm publish + Docker push를 실행하는 2-게이트 모델의 게이트 2를 구현한다.

Purpose: Release PR 머지(게이트 1) 후 자동 트리거되는 품질 게이트 + 수동 승인 배포(게이트 2)로 릴리스 안전성을 확보한다
Output: `release.yml` 확장 (deploy job 추가)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/release.yml (현재 상태: test, chain-integration, platform, publish-check, docker-publish jobs)
@objectives/v1.8-upgrade-distribution.md (섹션 7: 2-게이트 모델, 게이트 2 배포 승인)
</context>

<tasks>

<task type="auto">
  <name>Task 1: release.yml에 deploy job 추가 (게이트 2)</name>
  <files>.github/workflows/release.yml</files>
  <action>
기존 release.yml을 수정하여 deploy job을 추가한다. 현재 구조를 유지하면서 마지막에 deploy job을 추가한다.

**현재 release.yml 구조:**
- `on: release: types: [published]` + `workflow_dispatch` (이미 존재, RLSE-04 충족)
- `test` job: full test suite + coverage hard gate
- `chain-integration` job: Solana + Anvil chain tests
- `platform` job: platform tests + Docker build + health check (needs: test)
- `publish-check` job: npm publish dry-run 4 packages (needs: test)
- `docker-publish` job: GHCR push with 3-tier tags (needs: [test, platform, chain-integration], if: release event)

**추가할 deploy job:**

```yaml
  # Gate 2: Manual approval deploy (dry-run until v2.0)
  deploy:
    runs-on: ubuntu-latest
    needs: [test, chain-integration, platform, publish-check, docker-publish]
    if: github.event_name == 'release'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build
        run: pnpm turbo run build

      - name: npm publish (dry-run)
        run: |
          for pkg in core sdk cli mcp; do
            echo "--- Publishing packages/$pkg (dry-run) ---"
            cd packages/$pkg
            npm publish --dry-run 2>&1
            cd ../..
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Deploy summary
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **npm:** dry-run (activate in v2.0)" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker:** pushed by docker-publish job" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> To enable real npm publish, remove \`--dry-run\` flag from npm publish step." >> $GITHUB_STEP_SUMMARY
```

**핵심 설정:**
- `needs: [test, chain-integration, platform, publish-check, docker-publish]` → 모든 품질 게이트 + Docker push 완료 후 실행 (RLSE-05)
- `if: github.event_name == 'release'` → release 이벤트에서만 deploy 실행 (workflow_dispatch 제외)
- `environment: production` → GitHub Environment Protection Rules로 수동 승인 필요 (RLSE-05 게이트 2)
- npm publish `--dry-run` → v2.0 전까지 실제 배포하지 않음 (RLSE-06)
- Docker push는 `docker-publish` job에서 이미 처리됨 → deploy job에서 중복 안 함
- Deploy summary → GitHub Actions UI에서 배포 상태 확인 가능

**permissions 확인:** 기존 permissions에 `packages: write`가 이미 있으므로 Docker push에 충분. npm publish를 활성화할 때 `NPM_TOKEN` secret이 필요하지만 dry-run에서는 불필요.
  </action>
  <verify>
- release.yml에 `deploy` job이 존재하는지 확인
- `deploy` job에 `environment: production` 설정이 있는지 확인
- `deploy` job의 `needs`에 test, chain-integration, platform, publish-check, docker-publish가 모두 포함되어 있는지 확인
- `deploy` job에 `if: github.event_name == 'release'` 조건이 있는지 확인
- npm publish 명령에 `--dry-run` 플래그가 포함되어 있는지 확인
- YAML 문법 검증: `node -e "const yaml=require('yaml'); yaml.parse(require('fs').readFileSync('.github/workflows/release.yml','utf8'))"` (yaml 패키지가 없으면 수동 확인)
  </verify>
  <done>
- release.yml의 `on: release: types: [published]` 트리거가 유지되어 GitHub Release published 시 자동 실행된다 (RLSE-04)
- deploy job이 `environment: production`으로 설정되어 수동 승인 대기한다 (RLSE-05)
- deploy job이 모든 품질 게이트(test, chain-integration, platform, publish-check, docker-publish)에 의존한다
- npm publish가 `--dry-run`으로 실행된다 (v2.0 전까지, RLSE-06)
  </done>
</task>

</tasks>

<verification>
1. release.yml이 유효한 YAML이고 기존 jobs(test, chain-integration, platform, publish-check, docker-publish)가 그대로 유지된다
2. deploy job이 `needs: [test, chain-integration, platform, publish-check, docker-publish]`로 모든 품질 게이트에 의존한다
3. deploy job에 `environment: production` + `if: github.event_name == 'release'` 조건이 있다
4. npm publish에 `--dry-run` 플래그가 있어 실제 배포하지 않는다
5. GitHub Release published → release.yml 트리거 → 품질 게이트 → deploy 대기 흐름이 완성된다
</verification>

<success_criteria>
- release.yml에 deploy job이 추가되어 2-게이트 모델이 완성된다
- 품질 게이트(5개 job) 통과 후에만 deploy job에 도달한다
- deploy job이 environment: production으로 수동 승인을 요구한다
- v2.0 전까지 npm publish는 dry-run으로 실행된다
</success_criteria>

<output>
After completion, create `.planning/phases/163-release-please/163-02-SUMMARY.md`
</output>
