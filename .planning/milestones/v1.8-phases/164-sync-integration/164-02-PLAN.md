---
phase: 164-sync-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/__tests__/upgrade-flow-e2e.test.ts
autonomous: true
requirements: [SYNC-01]

must_haves:
  truths:
    - "버전 체크 -> Health endpoint -> CLI 알림 -> upgrade 명령 -> 호환성 검증 전체 흐름이 테스트로 검증된다"
    - "VersionCheckService가 최신 버전을 조회하면 /health 응답의 updateAvailable이 true가 된다"
    - "스키마 호환성 3시나리오(migrate/ok/reject)가 올바르게 판별된다"
    - "CLI 알림이 /health 응답의 updateAvailable에 따라 출력/미출력된다"
  artifacts:
    - path: "packages/daemon/src/__tests__/upgrade-flow-e2e.test.ts"
      provides: "E2E upgrade flow integration tests"
      contains: "upgrade flow"
  key_links:
    - from: "packages/daemon/src/__tests__/upgrade-flow-e2e.test.ts"
      to: "packages/daemon/src/api/routes/health.ts"
      via: "app.request(/health) response validation"
      pattern: "latestVersion.*updateAvailable"
    - from: "packages/daemon/src/__tests__/upgrade-flow-e2e.test.ts"
      to: "packages/daemon/src/infrastructure/database/compatibility.ts"
      via: "checkSchemaCompatibility integration"
      pattern: "checkSchemaCompatibility"
---

<objective>
업그레이드 흐름 E2E 통합 테스트 작성

Purpose: v1.8 마일스톤의 핵심 흐름(버전 체크 -> health 노출 -> CLI 알림 -> upgrade 명령 -> 스키마 호환성)이 연결되어 동작하는지 통합 수준에서 검증한다. 각 단위 테스트는 이미 존재하나, 전체 흐름을 아우르는 통합 테스트가 없다.
Output: upgrade-flow-e2e.test.ts (통합 테스트 파일)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source modules under test
@packages/daemon/src/api/routes/health.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/infrastructure/version/version-check-service.ts
@packages/daemon/src/infrastructure/database/compatibility.ts
@packages/daemon/src/infrastructure/backup/backup-service.ts

# Existing test patterns
@packages/daemon/src/__tests__/api-server.test.ts
@packages/daemon/src/__tests__/schema-compatibility.test.ts
@packages/daemon/src/__tests__/version-check-service.test.ts
@packages/cli/src/__tests__/upgrade.test.ts
@packages/cli/src/__tests__/update-notify.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 업그레이드 흐름 E2E 통합 테스트 작성</name>
  <files>
    packages/daemon/src/__tests__/upgrade-flow-e2e.test.ts
  </files>
  <action>
다음 테스트 시나리오를 하나의 통합 테스트 파일에 구현한다. Vitest를 사용하며, 기존 테스트 패턴(api-server.test.ts, schema-compatibility.test.ts)을 따른다.

**테스트 구조:**

```
describe('upgrade flow E2E')
  describe('1. Version check -> Health endpoint')
    - VersionCheckService.getLatest()가 null일 때 /health에서 latestVersion=null, updateAvailable=false
    - VersionCheckService.getLatest()가 현재 버전보다 높으면 /health에서 updateAvailable=true
    - VersionCheckService.getLatest()가 현재 버전과 같으면 updateAvailable=false
    - /health 응답에 schemaVersion 필드가 LATEST_SCHEMA_VERSION과 일치
    - /health 응답의 모든 7개 필드가 올바른 타입

  describe('2. Health -> CLI notification flow')
    - /health updateAvailable=true인 응답을 받으면 CLI 알림 출력 (mock fetch)
    - /health updateAvailable=false이면 CLI 알림 미출력
    - /health fetch 실패 시 조용히 무시

  describe('3. Schema compatibility -> daemon start')
    - 코드 schema > DB schema: { action: 'migrate' }
    - 코드 schema == DB schema: { action: 'ok' }
    - 코드 schema < DB schema: { action: 'reject', reason: 'code_too_old' }
    - DB schema < MIN_COMPATIBLE: { action: 'reject', reason: 'schema_too_old' }
    - 빈 DB (fresh): { action: 'ok' }

  describe('4. Full upgrade sequence')
    - 전체 흐름 시뮬레이션: VersionCheckService 설정 -> health 확인 -> BackupService.createBackup 호출 -> schema compatibility 확인
    - BackupService 백업/복원 라운드트립
    - upgrade --check가 health 정보와 일관성 유지
```

**구현 방법:**

1. **시나리오 1** (Version check -> Health):
   - `createHealthRoute({ versionCheckService })` 팩토리를 사용하여 Hono app 생성.
   - VersionCheckService를 mock (getLatest/getCheckedAt).
   - `app.request('/health')` 호출 후 JSON 응답 검증.
   - semver 비교 로직이 createHealthRoute 내부에 있으므로, mock VersionCheckService의 getLatest() 반환값만 변경하면 된다.

2. **시나리오 2** (Health -> CLI notification):
   - `checkAndNotifyUpdate` 함수를 직접 import (packages/cli/src/utils/update-notify.ts).
   - 단, 이 파일은 @waiaas/cli 패키지에 있으므로 daemon 테스트에서 import하기 어렵다.
   - 대안: mock fetch로 /health 응답을 시뮬레이션하고, updateAvailable 필드에 따라 stderr 출력 여부를 검증하는 "계약 테스트"로 구현.
   - CLI의 checkAndNotifyUpdate가 /health의 updateAvailable 필드를 읽는 계약을 검증한다.

3. **시나리오 3** (Schema compatibility):
   - 기존 schema-compatibility.test.ts와 동일 패턴 사용.
   - createDatabase(':memory:') + pushSchema로 DB 준비.
   - schema_version 테이블 직접 조작하여 시나리오 설정.

4. **시나리오 4** (Full sequence):
   - mock VersionCheckService + real health route + in-memory DB + BackupService 조합.
   - BackupService는 tmpdir 기반 실제 파일 시스템 테스트.
   - 단, npm install/execSync는 mock (실제 설치하지 않음).

**중요:**
- 각 시나리오는 독립적으로 실행 가능해야 한다 (beforeEach에서 초기화).
- 총 테스트 케이스 수는 16-20건 (로드맵의 "24건"은 가이드라인이며, 의미 있는 시나리오만 구현).
- Vitest `describe.sequential()` 사용 불필요 (각 테스트 독립적).
  </action>
  <verify>
- `npx vitest run packages/daemon/src/__tests__/upgrade-flow-e2e.test.ts` 전체 통과
- 테스트 파일에 describe 블록이 4개 이상
- 테스트 케이스가 15건 이상
  </verify>
  <done>
upgrade-flow-e2e.test.ts가 16건 이상의 테스트를 포함하고, 버전 체크 -> health -> CLI 알림 -> schema 호환성 -> backup 전체 흐름이 통합 검증되며, 모든 테스트가 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon/src/__tests__/upgrade-flow-e2e.test.ts` 전체 통과
2. 기존 테스트에 영향 없음: `npx vitest run packages/daemon` 전체 통과
3. 통합 테스트가 실제 모듈(createHealthRoute, checkSchemaCompatibility, BackupService)을 사용하여 연결 무결성 검증
</verification>

<success_criteria>
- upgrade-flow-e2e.test.ts에 16건 이상의 통합 테스트가 존재하고 전체 통과
- 4개 영역(version-check->health, health->CLI, schema-compatibility, full-sequence) 모두 검증
- 기존 테스트 스위트에 회귀 없음
</success_criteria>

<output>
After completion, create `.planning/phases/164-sync-integration/164-02-SUMMARY.md`
</output>
