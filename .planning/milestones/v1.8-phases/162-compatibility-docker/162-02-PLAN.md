---
phase: 162-compatibility-docker
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - .github/workflows/release.yml
autonomous: true
requirements: [DOCK-01, DOCK-02]

must_haves:
  truths:
    - "Dockerfile에 Watchtower 호환 라벨이 포함되어 Watchtower가 자동 업데이트를 인식한다"
    - "release.yml에서 Docker 이미지가 latest + semver + major 3-tier 태그로 빌드/푸시된다"
    - "기존 Docker 빌드(docker-compose, CI platform job)가 정상 동작한다"
  artifacts:
    - path: "Dockerfile"
      provides: "Watchtower LABEL + OCI standard labels"
      contains: "com.centurylinklabs.watchtower"
    - path: ".github/workflows/release.yml"
      provides: "Docker build-push with 3-tier tagging"
      contains: "docker/metadata-action"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "Dockerfile"
      via: "docker/build-push-action uses Dockerfile as build context"
      pattern: "build-push-action"
---

<objective>
Docker 이미지에 Watchtower 호환 라벨을 추가하고, CI에서 latest/semver/major 3-tier 태깅을 적용한다.

Purpose: Docker 사용자가 Watchtower로 자동 업데이트를 설정할 수 있게 하고, latest/v1.8.0/v1 같은 3-tier 태그로 유연한 버전 고정 전략을 지원한다. 이를 통해 Docker 배포 채널의 업데이트 인프라가 완성된다.

Output: Watchtower 라벨이 추가된 Dockerfile + 3-tier 태깅이 적용된 release.yml Docker push job
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@Dockerfile
@.github/workflows/release.yml
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dockerfile Watchtower 라벨 + OCI 표준 라벨 추가</name>
  <files>Dockerfile</files>
  <action>
Dockerfile의 runner stage에 OCI 표준 라벨 + Watchtower 호환 라벨을 추가한다.

runner stage의 `WORKDIR /app` 직전 (또는 직후, RUN 명령어 전)에 LABEL 블록을 추가:

```dockerfile
# OCI standard labels (populated by docker/build-push-action --build-arg)
LABEL org.opencontainers.image.title="WAIaaS" \
      org.opencontainers.image.description="AI Agent Wallet-as-a-Service daemon" \
      org.opencontainers.image.url="https://github.com/minho-yoo/waiaas" \
      org.opencontainers.image.source="https://github.com/minho-yoo/waiaas" \
      org.opencontainers.image.vendor="WAIaaS" \
      org.opencontainers.image.licenses="MIT"

# Watchtower auto-update support
# Watchtower monitors containers with this label and auto-pulls new images.
# Users opt-in per container: docker run --label com.centurylinklabs.watchtower.enable=true
LABEL com.centurylinklabs.watchtower.enable="true"
```

위치: runner stage의 `FROM node:22-slim AS runner` 직후, `RUN apt-get` 전.
이유: LABEL은 레이어를 추가하지 않으므로 어디든 가능하지만, 관례상 FROM 직후에 메타데이터를 배치.

**주의:** 기존 Dockerfile의 모든 내용을 보존한다. 기존 HEALTHCHECK, USER, ENTRYPOINT 등을 변경하지 않는다.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && docker build --no-cache -t waiaas-test:label-check . 2>&1 | tail -5` -- 빌드 성공 확인 (실패 시 Dockerfile 구문 오류)
또는 Dockerfile 구문 검증: `grep 'com.centurylinklabs.watchtower' Dockerfile` -- 매칭 확인
  </verify>
  <done>
Dockerfile runner stage에 OCI 표준 라벨 6개 + Watchtower enable 라벨 1개가 추가되어 있다. 기존 Dockerfile 기능(multi-stage build, HEALTHCHECK, non-root user, entrypoint)에 변경이 없다.
  </done>
</task>

<task type="auto">
  <name>Task 2: release.yml Docker push job + 3-tier 태깅</name>
  <files>.github/workflows/release.yml</files>
  <action>
`.github/workflows/release.yml`에 새로운 `docker-publish` job을 추가한다. 기존 `platform` job의 Docker 빌드는 테스트용(push: false)이므로 유지하고, 새 job은 실제 GHCR 푸시용이다.

기존 jobs 뒤에 추가:

```yaml
  # Docker image build + push to GHCR with 3-tier tagging
  docker-publish:
    runs-on: ubuntu-latest
    needs: [test, platform, chain-integration]
    if: github.event_name == 'release'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            # latest tag for default branch releases
            type=raw,value=latest,enable={{is_default_branch}}
            # Full semver: v1.8.0
            type=semver,pattern=v{{version}}
            # Major version: v1
            type=semver,pattern=v{{major}}
            # Major.Minor: v1.8
            type=semver,pattern=v{{major}}.{{minor}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

**핵심 설계 결정:**
1. `docker/metadata-action@v5`를 사용하여 GitHub Release 태그에서 자동으로 3-tier 태그를 생성한다.
2. `needs: [test, platform, chain-integration]` -- 모든 품질 게이트를 통과한 후에만 Docker 푸시.
3. `if: github.event_name == 'release'` -- workflow_dispatch에서는 Docker 푸시를 건너뛴다 (테스트 목적).
4. GHCR(GitHub Container Registry) 사용 -- github.repository 기반 이미지 이름 (ghcr.io/minho-yoo/waiaas).
5. `labels: ${{ steps.meta.outputs.labels }}` -- metadata-action이 OCI 라벨을 빌드 시점에 주입.
6. 3-tier 태깅: `latest` (default branch만), `v1.8.0` (full semver), `v1` (major), `v1.8` (major.minor).

**주의:** 기존 `platform` job의 Docker 빌드(push: false, load: true)는 테스트 전용이므로 변경하지 않는다.
  </action>
  <verify>
1. `grep -c 'docker-publish' .github/workflows/release.yml` -> 1 이상
2. `grep 'docker/metadata-action' .github/workflows/release.yml` -> 매칭
3. `grep 'semver,pattern' .github/workflows/release.yml` -> 3개 매칭 (v{{version}}, v{{major}}, v{{major}}.{{minor}})
4. `grep 'ghcr.io' .github/workflows/release.yml` -> 매칭
5. YAML 구문 검증: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"` 또는 yamllint
  </verify>
  <done>
release.yml에 docker-publish job이 추가되어 GitHub Release 이벤트 시 GHCR에 3-tier(latest/semver/major) 태그로 Docker 이미지가 빌드+푸시된다. 기존 platform job의 테스트용 Docker 빌드에 변경이 없다.
  </done>
</task>

</tasks>

<verification>
1. `grep 'com.centurylinklabs.watchtower' Dockerfile` -- Watchtower 라벨 존재
2. `grep 'org.opencontainers.image' Dockerfile` -- OCI 라벨 존재
3. `grep 'docker-publish' .github/workflows/release.yml` -- 새 job 존재
4. `grep 'semver,pattern=v{{version}}' .github/workflows/release.yml` -- full semver 태깅
5. `grep 'semver,pattern=v{{major}}' .github/workflows/release.yml` -- major 태깅
6. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"` -- YAML 구문 유효
7. 기존 platform job이 변경되지 않음 확인
</verification>

<success_criteria>
- Dockerfile에 Watchtower 호환 라벨(com.centurylinklabs.watchtower.enable=true)이 존재한다
- Dockerfile에 OCI 표준 라벨(org.opencontainers.image.*)이 존재한다
- release.yml에 docker-publish job이 추가되어 3-tier 태깅(latest, semver, major, major.minor)이 적용된다
- docker-publish job은 모든 품질 게이트(test, platform, chain-integration) 통과 후에만 실행된다
- docker-publish job은 release 이벤트에서만 push한다
- 기존 CI/CD 기능(test, chain-integration, platform, publish-check)에 회귀가 없다
</success_criteria>

<output>
After completion, create `.planning/phases/162-compatibility-docker/162-02-SUMMARY.md`
</output>
