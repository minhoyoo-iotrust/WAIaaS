---
phase: 160-version-check-infra
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/lifecycle/workers.ts
  - packages/daemon/src/infrastructure/version/version-check-service.ts
  - packages/daemon/src/infrastructure/version/index.ts
  - packages/daemon/src/infrastructure/config/loader.ts
  - packages/daemon/src/lifecycle/daemon.ts
  - packages/daemon/src/__tests__/version-check-service.test.ts
  - packages/daemon/src/__tests__/lifecycle.test.ts
autonomous: true
requirements:
  - VCHK-01
  - VCHK-02
  - VCHK-03
  - VCHK-04

must_haves:
  truths:
    - "BackgroundWorkers.register() accepts runImmediately option that executes handler once before starting interval"
    - "VersionCheckService fetches latest version from npm registry and stores in key_value_store"
    - "Registry fetch failure does not throw or block daemon startup (fail-soft)"
    - "update_check = false config setting prevents version check worker from registering"
  artifacts:
    - path: "packages/daemon/src/lifecycle/workers.ts"
      provides: "BackgroundWorkers with runImmediately support"
      contains: "runImmediately"
    - path: "packages/daemon/src/infrastructure/version/version-check-service.ts"
      provides: "VersionCheckService class"
      exports: ["VersionCheckService"]
    - path: "packages/daemon/src/infrastructure/version/index.ts"
      provides: "Barrel export for version module"
      exports: ["VersionCheckService"]
    - path: "packages/daemon/src/__tests__/version-check-service.test.ts"
      provides: "Tests for VersionCheckService"
      min_lines: 80
  key_links:
    - from: "packages/daemon/src/infrastructure/version/version-check-service.ts"
      to: "key_value_store table"
      via: "better-sqlite3 prepare/run"
      pattern: "version_check_latest|version_check_checked_at"
    - from: "packages/daemon/src/lifecycle/daemon.ts"
      to: "packages/daemon/src/infrastructure/version/version-check-service.ts"
      via: "worker registration in Step 6"
      pattern: "version-check"
    - from: "packages/daemon/src/lifecycle/workers.ts"
      to: "handler execution"
      via: "runImmediately flag triggers immediate call before setInterval"
      pattern: "runImmediately"
---

<objective>
BackgroundWorkers에 runImmediately 옵션을 추가하고, npm registry에서 최신 버전을 조회하여 key_value_store에 저장하는 VersionCheckService를 구현한다.

Purpose: 데몬이 시작 즉시 + 24시간 주기로 최신 버전 정보를 확보하여, CLI 알림과 Health API에서 활용할 수 있는 기반을 구축한다.
Output: BackgroundWorkers runImmediately 확장 + VersionCheckService + config.toml update_check 설정 + 데몬 Step 6 워커 등록
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/lifecycle/workers.ts
@packages/daemon/src/lifecycle/daemon.ts
@packages/daemon/src/infrastructure/config/loader.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/__tests__/lifecycle.test.ts
@objectives/v1.8-upgrade-distribution.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: BackgroundWorkers runImmediately + VersionCheckService + config + daemon registration</name>
  <files>
    packages/daemon/src/lifecycle/workers.ts
    packages/daemon/src/infrastructure/version/version-check-service.ts
    packages/daemon/src/infrastructure/version/index.ts
    packages/daemon/src/infrastructure/config/loader.ts
    packages/daemon/src/lifecycle/daemon.ts
    packages/daemon/src/__tests__/version-check-service.test.ts
    packages/daemon/src/__tests__/lifecycle.test.ts
  </files>
  <action>
    **1. BackgroundWorkers runImmediately 확장** (`packages/daemon/src/lifecycle/workers.ts`):

    - `WorkerRegistration` 인터페이스에 `runImmediately?: boolean` 옵션 필드 추가.
    - `register()` 메서드의 opts 파라미터에 `runImmediately?: boolean` 추가. 등록 시 `WorkerRegistration`에 저장.
    - `startAll()` 메서드 변경: `runImmediately: true`인 워커는 setInterval 등록 전에 핸들러를 즉시 1회 실행(fire-and-forget, try-catch로 에러 흡수). 그 후 기존처럼 setInterval로 주기 실행.
    - 즉시 실행은 `void (async () => { ... })()` 패턴으로 비동기 실행. 즉시 실행 중에도 `running` 플래그 설정하여 interval과 겹치지 않도록.

    **2. VersionCheckService 구현** (`packages/daemon/src/infrastructure/version/version-check-service.ts`):

    ```typescript
    export class VersionCheckService {
      constructor(private readonly sqlite: Database) {}

      async check(): Promise<{ latest: string | null; current: string }> {
        // 1. Node.js native fetch로 https://registry.npmjs.org/@waiaas/cli 조회
        //    - AbortSignal.timeout(5000) 타임아웃
        //    - User-Agent: `waiaas/${currentVersion}`
        // 2. 응답 JSON에서 dist-tags.latest 파싱
        // 3. semver.gt(latest, current)로 비교
        // 4. key_value_store에 저장:
        //    - version_check_latest: latest version string
        //    - version_check_checked_at: Unix seconds (Math.floor(Date.now() / 1000))
        //    key는 INSERT OR REPLACE INTO key_value_store (key, value, updated_at) VALUES (?, ?, ?)
        // 5. 반환: { latest, current }
        // 모든 에러(네트워크, 파싱, DB)는 catch하여 console.warn 출력 후 { latest: null, current } 반환
      }

      getLatest(): string | null {
        // key_value_store에서 version_check_latest 조회. 없으면 null.
      }

      getCheckedAt(): number | null {
        // key_value_store에서 version_check_checked_at 조회. 없으면 null.
      }
    }
    ```

    - `semver` 패키지 import: `import semver from 'semver'` (이미 devDependencies에 있을 수 있으나, 없으면 추가 필요. `pnpm add semver` + `pnpm add -D @types/semver` in daemon 패키지).
    - 현재 버전은 `createRequire(import.meta.url)('../../../package.json').version`으로 가져옴 (health.ts 패턴 동일).
    - npm registry URL: `https://registry.npmjs.org/@waiaas/cli` (objectives 문서 참조).
    - 타임아웃: `AbortSignal.timeout(5000)` (5초).
    - 프라이버시: User-Agent에 현재 버전만 포함, 다른 식별 정보 없음.

    **3. Barrel export** (`packages/daemon/src/infrastructure/version/index.ts`):
    ```typescript
    export { VersionCheckService } from './version-check-service.js';
    ```

    **4. Config 확장** (`packages/daemon/src/infrastructure/config/loader.ts`):

    - `daemon` 섹션에 2개 필드 추가:
      - `update_check: z.boolean().default(true)` — 버전 체크 활성화 여부
      - `update_check_interval: z.number().int().min(3600).max(604800).default(86400)` — 체크 주기 초 (기본 24시간)

    **5. 데몬 Step 6 워커 등록** (`packages/daemon/src/lifecycle/daemon.ts`):

    - Step 6에서 기존 워커 등록 이후, `this._config!.daemon.update_check`가 `true`일 때만:
      - `VersionCheckService` 인스턴스 생성 (`this.sqlite!` 전달)
      - `this.workers.register('version-check', { interval: this._config!.daemon.update_check_interval * 1000, runImmediately: true, handler: () => versionCheckService.check() })`
      - console.log로 Step 6 로그에 version-check 워커 등록 사실 출력
    - `update_check = false`이면 워커 미등록 + console.log('Step 6: Version check disabled')
    - VersionCheckService 인스턴스를 클래스 필드에 저장하여 Health 엔드포인트에서 접근 가능하게 함 (private versionCheckService: VersionCheckService | null = null). createApp deps에 versionCheckService를 전달할 수 있도록 준비.

    **6. 테스트 작성** (`packages/daemon/src/__tests__/version-check-service.test.ts`):

    TDD RED-GREEN 방식:

    **RED 테스트 (먼저 작성):**
    - `VersionCheckService.check()` — msw 또는 vi.fn으로 global fetch mock:
      - 성공 시: key_value_store에 version_check_latest, version_check_checked_at 저장 확인
      - 실패 시 (fetch 에러): 에러 throw 없이 null 반환 (fail-soft)
      - 타임아웃 시: 에러 throw 없이 null 반환 (fail-soft)
    - `VersionCheckService.getLatest()` — DB에 값이 있을 때/없을 때
    - `VersionCheckService.getCheckedAt()` — DB에 값이 있을 때/없을 때

    fetch mock은 `vi.stubGlobal('fetch', vi.fn())` 패턴 사용. msw 불필요 (단위 테스트).

    테스트용 SQLite는 better-sqlite3로 in-memory DB 생성 → key_value_store 테이블 CREATE.

    **GREEN 구현:** VersionCheckService 코드 작성.

    **7. BackgroundWorkers 테스트 추가** (`packages/daemon/src/__tests__/lifecycle.test.ts`):

    기존 BackgroundWorkers 테스트 섹션에 추가:
    - `runImmediately: true` 옵션 시 startAll() 호출 즉시 핸들러 1회 실행 확인
    - `runImmediately: false` (기본값) 시 startAll() 즉시 핸들러 미실행 확인
    - `runImmediately: true`에서 핸들러 에러 시 다른 워커에 영향 없음 확인
  </action>
  <verify>
    1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/version-check-service.test.ts` 통과
    2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec vitest run src/__tests__/lifecycle.test.ts` 통과 (기존 + 신규 테스트)
    3. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/daemon exec tsc --noEmit` 타입 검사 통과
  </verify>
  <done>
    - BackgroundWorkers.register()에 runImmediately 옵션이 동작하여 startAll() 즉시 핸들러 1회 실행
    - VersionCheckService.check()가 npm registry에서 latest version을 조회하여 key_value_store에 저장
    - fetch 실패/타임아웃 시 에러 throw 없이 null 반환 (fail-soft)
    - config.toml의 update_check = false 시 version-check 워커 미등록
    - daemon Step 6에서 version-check 워커가 runImmediately: true로 등록
    - 모든 테스트 통과
  </done>
</task>

</tasks>

<verification>
1. BackgroundWorkers runImmediately 동작: startAll() 호출 시 즉시 핸들러 1회 실행 후 interval 반복
2. VersionCheckService: npm registry 조회 → key_value_store 저장 → getLatest()/getCheckedAt() 조회
3. fail-soft: 네트워크 에러, 타임아웃 시 데몬 정상 동작
4. config: update_check = false 시 워커 미등록
5. 데몬 통합: Step 6에서 version-check 워커 등록 + VersionCheckService 인스턴스 저장
</verification>

<success_criteria>
- BackgroundWorkers에 runImmediately 옵션이 동작한다
- VersionCheckService가 npm registry에서 최신 버전을 조회하여 key_value_store에 저장한다
- 네트워크 에러/타임아웃 시 데몬이 정상 시작된다 (fail-soft)
- update_check = false 설정 시 버전 조회가 수행되지 않는다
- 데몬 Step 6에서 version-check 워커가 등록된다
- 신규 + 기존 테스트 모두 통과한다
</success_criteria>

<output>
After completion, create `.planning/phases/160-version-check-infra/160-01-SUMMARY.md`
</output>
