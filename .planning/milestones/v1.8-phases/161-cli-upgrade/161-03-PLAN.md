---
phase: 161-cli-upgrade
plan: 03
type: execute
wave: 2
depends_on: [161-02]
files_modified:
  - packages/cli/src/commands/upgrade.ts
  - packages/cli/src/index.ts
  - packages/cli/src/__tests__/upgrade.test.ts
autonomous: true
requirements: [UPGR-01, UPGR-02, UPGR-05, UPGR-07]

must_haves:
  truths:
    - "waiaas upgrade --check로 업그레이드 가능 여부를 확인할 수 있다"
    - "waiaas upgrade로 7단계 시퀀스가 순서대로 실행된다"
    - "이미 최신 버전이면 'Already up to date' 메시지를 출력하고 npm을 호출하지 않는다"
    - "waiaas upgrade --to {version}으로 특정 버전을 지정할 수 있다"
    - "waiaas upgrade --rollback으로 직전 백업에서 복원할 수 있다"
    - "waiaas upgrade --no-start로 업그레이드 후 데몬 재시작을 생략할 수 있다"
  artifacts:
    - path: "packages/cli/src/commands/upgrade.ts"
      provides: "upgrade 명령 구현"
      exports: ["upgradeCommand"]
    - path: "packages/cli/src/__tests__/upgrade.test.ts"
      provides: "upgrade 명령 단위 테스트"
      min_lines: 120
  key_links:
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/upgrade.ts"
      via: "commander .command('upgrade') 등록"
      pattern: "upgradeCommand"
    - from: "packages/cli/src/commands/upgrade.ts"
      to: "packages/daemon/src/infrastructure/backup/backup-service.ts"
      via: "BackupService.createBackup/restoreLatest 호출"
      pattern: "BackupService"
    - from: "packages/cli/src/commands/upgrade.ts"
      to: "npm i -g @waiaas/cli"
      via: "child_process.execSync로 npm 설치 실행"
      pattern: "execSync.*npm"
---

<objective>
`waiaas upgrade` 명령을 구현한다. 7단계 시퀀스(확인-중지-백업-업데이트-마이그레이션-검증-재시작)를 순서대로 실행하며, --check, --to, --rollback, --no-start 옵션을 지원한다.

Purpose: 사용자가 단일 명령으로 WAIaaS를 안전하게 업그레이드하고, 문제 발생 시 즉시 롤백할 수 있도록 한다.
Output: upgrade.ts 명령 모듈 + CLI 엔트리포인트 등록 + 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/161-cli-upgrade/161-02-SUMMARY.md

# Key source files
@packages/cli/src/index.ts
@packages/cli/src/commands/stop.ts
@packages/cli/src/commands/start.ts
@packages/cli/src/commands/status.ts
@packages/cli/src/utils/data-dir.ts
@packages/daemon/src/infrastructure/backup/backup-service.ts
@packages/daemon/src/infrastructure/version/version-check-service.ts
@objectives/v1.8-upgrade-distribution.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: upgrade 명령 구현</name>
  <files>
    packages/cli/src/commands/upgrade.ts
    packages/cli/src/index.ts
  </files>
  <action>
**1. `packages/cli/src/commands/upgrade.ts` 생성:**

```ts
export interface UpgradeOptions {
  dataDir: string;
  check?: boolean;
  to?: string;
  rollback?: boolean;
  noStart?: boolean;
}

export async function upgradeCommand(opts: UpgradeOptions): Promise<void> { ... }
```

**--check 모드 (UPGR-01):**
1. npm registry에서 최신 버전 조회: `fetch('https://registry.npmjs.org/@waiaas/cli', { signal: AbortSignal.timeout(5000) })`
2. `dist-tags.latest` 파싱
3. 현재 버전은 package.json에서 읽기: `createRequire(import.meta.url)('../../package.json').version`
4. semver.gt(latest, current) 비교:
   - true → stdout에 `Update available: ${current} → ${latest}` + `Run: waiaas upgrade` 출력
   - false → stdout에 `Already up to date (${current})` 출력 (UPGR-05)
5. return (npm 호출 없음)

**--rollback 모드 (UPGR-04 — 161-02에서 구현한 BackupService 사용):**
1. `new BackupService(dataDir)` 생성
2. `backupService.restoreLatest()` 호출
3. 성공 시 stdout에 `Restored from backup: {backupDir}` 출력
4. 실패 시 에러 메시지 출력 + process.exit(1)
5. return

**기본 모드 — 7단계 시퀀스 (UPGR-02):**

각 단계마다 `console.log(`[${stepN}/7] ${description}`)` 형식으로 진행 표시.

**Step 1: 버전 확인**
- `--to` 옵션이 있으면 targetVersion = opts.to (semver.valid 검증, 유효하지 않으면 에러)
- 없으면 npm registry에서 latest 조회 (--check와 동일 로직)
- targetVersion === currentVersion이면 "Already up to date" 출력 + return (UPGR-05)
- `console.log(`[1/7] Version check: ${currentVersion} → ${targetVersion}`)`

**Step 2: 데몬 중지**
- `console.log('[2/7] Stopping daemon...')`
- status.ts의 resolvePort 패턴으로 port 해결
- pid 파일 확인 → 실행 중이면 SIGTERM 전송 (stop.ts 로직 인라인, 또는 stopCommand 재사용 고려 — 단, stopCommand는 console.log를 직접 호출하므로 로직만 추출하여 사용하는 게 나음)
- 실행 중이 아니면 skip

**Step 3: 백업**
- `console.log('[3/7] Creating backup...')`
- `const backupService = new BackupService(dataDir)`
- `const backupDir = backupService.createBackup(currentVersion)`
- `console.log(`  Backup created: ${backupDir}`)`

**Step 4: 패키지 업데이트**
- `console.log(`[4/7] Updating to ${targetVersion}...`)`
- `import { execSync } from 'node:child_process'`
- `execSync(`npm install -g @waiaas/cli@${targetVersion}`, { stdio: 'inherit' })` — 기술 결정 #15에 따라 execSync 사용
- 실패 시 에러 메시지 + "Run: waiaas upgrade --rollback" 안내 + process.exit(1)

**Step 5: DB 마이그레이션**
- `console.log('[5/7] Running database migrations...')`
- 새 버전의 코드가 설치되었으므로 마이그레이션은 다음 데몬 시작 시 자동 실행됨 (daemon.ts Step 2)
- 여기서는 "Migrations will run on next daemon start" 메시지 출력
- 참고: npm i -g 후 현재 프로세스의 코드는 구버전이므로, 직접 마이그레이션 실행은 위험. 데몬 시작 시 자동 마이그레이션에 위임한다.

**Step 6: 검증**
- `console.log('[6/7] Verifying installation...')`
- `execSync('waiaas --version', { stdio: 'pipe' })` 실행하여 새 버전이 설치되었는지 확인
- 출력에서 버전 파싱하여 targetVersion과 비교
- 불일치 시 경고 출력 (에러 아닌 경고 — 설치 경로 문제일 수 있음)

**Step 7: 데몬 재시작**
- `--no-start` 옵션이면 `console.log('[7/7] Skipping daemon restart (--no-start)')` + return
- 그렇지 않으면 `console.log('[7/7] Restarting daemon...')`
- `execSync('waiaas start', { stdio: 'inherit' })` — 새 버전의 바이너리로 시작
- 참고: 현재 프로세스가 아닌 새로 설치된 waiaas 바이너리를 exec하므로 새 버전 코드가 실행됨

완료 메시지: `console.log(`\nUpgrade complete: ${currentVersion} → ${targetVersion}`)`

**2. `packages/cli/src/index.ts` 수정:**

- `import { upgradeCommand } from './commands/upgrade.js'` 추가
- upgrade 명령 등록:

```ts
program
  .command('upgrade')
  .description('Upgrade WAIaaS to the latest version')
  .option('--data-dir <path>', 'Data directory path')
  .option('--check', 'Check for updates without upgrading')
  .option('--to <version>', 'Upgrade to a specific version')
  .option('--rollback', 'Restore from the latest backup')
  .option('--no-start', 'Skip daemon restart after upgrade')
  .action(async (opts: {
    dataDir?: string;
    check?: boolean;
    to?: string;
    rollback?: boolean;
    start?: boolean; // commander inverts --no-start to start=false
  }) => {
    const dataDir = resolveDataDir(opts);
    await upgradeCommand({
      dataDir,
      check: opts.check,
      to: opts.to,
      rollback: opts.rollback,
      noStart: opts.start === false, // commander: --no-start → start=false
    });
  });
```

commander의 `--no-start` 처리 주의: commander는 `--no-X`를 `X: false`로 파싱한다. 따라서 `opts.start === false`를 `noStart: true`로 변환해야 한다.

**CLI 문서 헤더 (index.ts 상단 주석):**
- `upgrade` 관련 설명 추가:
  ```
  *   upgrade                           -- Upgrade WAIaaS to the latest version
  *   upgrade --check                   -- Check for available updates
  *   upgrade --to <version>            -- Upgrade to a specific version
  *   upgrade --rollback                -- Restore from the latest backup
  ```
  </action>
  <verify>
`ls packages/cli/src/commands/upgrade.ts` — 파일 존재

`cd /Users/minho.yoo/dev/wallet/WAIaaS && npx tsc -p packages/cli/tsconfig.json --noEmit 2>&1 | grep -v 'security-test-helpers'` — 새 에러 없음

`grep 'upgradeCommand' packages/cli/src/index.ts` — import + 사용 확인
  </verify>
  <done>
- upgrade.ts가 존재하고 upgradeCommand 함수를 export한다
- index.ts에 upgrade 명령이 commander로 등록되어 있다
- --check, --to, --rollback, --no-start 4개 옵션이 모두 등록되어 있다
- 타입 체크가 통과한다
  </done>
</task>

<task type="auto">
  <name>Task 2: upgrade 명령 단위 테스트</name>
  <files>
    packages/cli/src/__tests__/upgrade.test.ts
  </files>
  <action>
**`packages/cli/src/__tests__/upgrade.test.ts` 생성:**

vitest로 테스트. execSync, fetch, BackupService를 mock하여 각 시나리오 검증.

**Mock 전략:**
- `child_process.execSync`를 vi.mock('node:child_process')으로 mock
- `global.fetch`를 vi.fn()으로 mock (npm registry 응답)
- `BackupService`를 vi.mock('@waiaas/daemon')으로 mock (createBackup, restoreLatest)
  - 또는 BackupService import 경로에 따라 직접 mock
- `process.exit`를 vi.spyOn + mockImplementation으로 가로채기 (throw로 변환)

**npm registry mock 응답:**
```ts
const mockRegistryResponse = (latest: string) => ({
  ok: true,
  json: async () => ({ 'dist-tags': { latest } }),
});
```

**테스트 케이스 (최소 10개):**

describe('upgrade --check'):
1. 새 버전 있음 → "Update available: {current} → {latest}" 출력 + npm 미호출
2. 이미 최신 → "Already up to date" 출력 + npm 미호출 (UPGR-05)
3. registry 접근 실패 → 에러 메시지 출력

describe('upgrade (7-step)'):
4. 전체 7단계 순서대로 실행 (console.log spy로 [1/7]~[7/7] 순서 확인)
5. npm install -g @waiaas/cli@{version} 호출 확인
6. BackupService.createBackup 호출 확인
7. 이미 최신 버전 → "Already up to date" + npm 미호출 (UPGR-05)

describe('upgrade --to'):
8. --to 옵션으로 특정 버전 지정 시 해당 버전으로 npm install 호출 (UPGR-07)
9. --to에 유효하지 않은 semver → 에러

describe('upgrade --rollback'):
10. BackupService.restoreLatest 호출 확인

describe('upgrade --no-start'):
11. Step 7에서 데몬 재시작이 생략됨 (execSync에 'waiaas start' 미포함)

describe('upgrade failure'):
12. Step 4(npm install) 실패 시 롤백 안내 메시지 출력

**각 테스트 공통:**
- tmpdir로 가짜 dataDir 생성 (config.toml, daemon.pid 등)
- console.log를 vi.spyOn으로 감시하여 출력 검증
- afterEach에서 tmpdir 정리 + mock 복원
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/cli/src/__tests__/upgrade.test.ts` — 10개 이상 테스트 통과
  </verify>
  <done>
- 12개 이상 테스트가 모두 통과한다
- --check, --to, --rollback, --no-start 모든 옵션이 테스트된다
- 7단계 시퀀스 순서가 검증된다
- 에러 시나리오(registry 실패, npm 실패, 유효하지 않은 버전)가 검증된다
- 이미 최신 버전일 때 npm 미호출이 검증된다
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/cli/src/__tests__/upgrade.test.ts` — 전체 통과
2. `npx tsc -p packages/cli/tsconfig.json --noEmit` — 새 에러 없음
3. `grep -n 'upgrade' packages/cli/src/index.ts` — commander 등록 확인
4. upgrade.ts에서 BackupService import 확인
5. execSync로 npm install -g 호출 패턴 확인
6. --no-start 옵션이 Step 7을 올바르게 건너뛰는지 테스트에서 확인
</verification>

<success_criteria>
- UPGR-01: waiaas upgrade --check로 업그레이드 가능 여부를 확인할 수 있다
- UPGR-02: waiaas upgrade로 7단계 시퀀스가 순서대로 실행된다
- UPGR-05: 이미 최신 버전이면 "Already up to date" 메시지를 출력하고 npm을 호출하지 않는다
- UPGR-07: waiaas upgrade --to {version}으로 특정 버전을 지정하여 업그레이드할 수 있다
</success_criteria>

<output>
After completion, create `.planning/phases/161-cli-upgrade/161-03-SUMMARY.md`
</output>
