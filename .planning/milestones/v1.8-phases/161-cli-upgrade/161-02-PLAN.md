---
phase: 161-cli-upgrade
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/infrastructure/backup/backup-service.ts
  - packages/daemon/src/infrastructure/backup/index.ts
  - packages/daemon/src/__tests__/backup-service.test.ts
autonomous: true
requirements: [UPGR-03, UPGR-04, UPGR-06]

must_haves:
  truths:
    - "DB + config.toml이 {dataDir}/backups/pre-upgrade-{version}-{timestamp}/ 디렉토리에 복사된다"
    - "복원(restore) 시 백업 디렉토리의 DB + config.toml이 원래 위치로 복사된다"
    - "백업 디렉토리가 5개를 초과하면 가장 오래된 것부터 자동 삭제된다"
    - "백업 대상 파일이 없어도 에러 없이 진행된다 (config.toml이 없을 수 있음)"
  artifacts:
    - path: "packages/daemon/src/infrastructure/backup/backup-service.ts"
      provides: "BackupService 클래스"
      exports: ["BackupService"]
    - path: "packages/daemon/src/infrastructure/backup/index.ts"
      provides: "Barrel export"
      exports: ["BackupService"]
    - path: "packages/daemon/src/__tests__/backup-service.test.ts"
      provides: "BackupService 단위 테스트"
      min_lines: 100
  key_links:
    - from: "packages/daemon/src/infrastructure/backup/backup-service.ts"
      to: "{dataDir}/backups/"
      via: "fs.cpSync/mkdirSync로 DB + config.toml 파일 복사"
      pattern: "cpSync|copyFileSync"
    - from: "packages/daemon/src/infrastructure/backup/backup-service.ts"
      to: "{dataDir}/backups/"
      via: "readdirSync + rmSync로 5개 초과 백업 삭제"
      pattern: "readdirSync.*rmSync"
---

<objective>
업그레이드 전 DB + config.toml을 자동 백업하고 복원할 수 있는 BackupService를 구현한다. 백업 디렉토리를 최근 5개까지만 보존하는 정책도 포함한다.

Purpose: 업그레이드 실패 시 안전하게 롤백할 수 있는 기반 인프라를 제공한다.
Output: BackupService 클래스 + barrel export + 단위 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@packages/daemon/src/infrastructure/database/connection.ts
@packages/daemon/src/infrastructure/config/loader.ts
@objectives/v1.8-upgrade-distribution.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: BackupService 구현 + barrel export</name>
  <files>
    packages/daemon/src/infrastructure/backup/backup-service.ts
    packages/daemon/src/infrastructure/backup/index.ts
  </files>
  <action>
**1. `packages/daemon/src/infrastructure/backup/backup-service.ts` 생성:**

```ts
export class BackupService {
  constructor(private readonly dataDir: string) {}

  // 백업 생성
  createBackup(version: string): string { ... }
  // 최신 백업에서 복원
  restoreLatest(): string { ... }
  // 특정 백업에서 복원
  restore(backupDir: string): void { ... }
  // 백업 목록 조회 (최신순)
  listBackups(): string[] { ... }
  // 보존 정책 적용 (5개 초과 삭제)
  pruneBackups(keep?: number): number { ... }
}
```

**createBackup(version: string) 상세:**
1. 백업 디렉토리 경로: `{dataDir}/backups/pre-upgrade-{version}-{timestamp}/`
   - timestamp 형식: `YYYYMMDDHHmmss` (Date를 로컬 시간 기반으로 포맷, 예: `20260217143022`)
2. `mkdirSync(backupDir, { recursive: true })`
3. DB 파일 복사: `{dataDir}/data/waiaas.db` → `{backupDir}/waiaas.db`
   - DB WAL 파일도 복사: `waiaas.db-wal`, `waiaas.db-shm` (존재하면)
   - `copyFileSync` 사용
4. config.toml 복사: `{dataDir}/config.toml` → `{backupDir}/config.toml`
   - 파일이 존재하지 않으면 건너뛴다 (existsSync 체크)
5. 보존 정책 적용: `this.pruneBackups(5)` 호출
6. 백업 디렉토리 경로를 반환한다

**restoreLatest() 상세:**
1. `listBackups()`로 백업 목록 조회
2. 목록이 비어있으면 에러 throw: "No backups found"
3. 가장 최신 백업(인덱스 0)으로 `restore()` 호출
4. 복원된 백업 디렉토리 경로를 반환한다

**restore(backupDir: string) 상세:**
1. `backupDir` 존재 확인 (없으면 에러 throw)
2. `{backupDir}/waiaas.db` → `{dataDir}/data/waiaas.db` 복사
   - WAL/SHM 파일도 복원 (존재하면)
3. `{backupDir}/config.toml` → `{dataDir}/config.toml` 복사 (존재하면)

**listBackups() 상세:**
1. `{dataDir}/backups/` 디렉토리 읽기 (없으면 빈 배열)
2. `pre-upgrade-` 접두사로 필터링
3. 디렉토리만 필터링 (statSync.isDirectory)
4. 이름 기준 내림차순 정렬 (최신이 먼저 — timestamp 포함이므로 사전순 = 시간순)

**pruneBackups(keep = 5) 상세:**
1. `listBackups()`로 전체 목록 조회
2. `keep`개 초과 항목을 `rmSync({ recursive: true, force: true })`로 삭제
3. 삭제된 개수를 반환

**2. `packages/daemon/src/infrastructure/backup/index.ts` 생성:**

```ts
export { BackupService } from './backup-service.js';
```
  </action>
  <verify>
`ls packages/daemon/src/infrastructure/backup/backup-service.ts packages/daemon/src/infrastructure/backup/index.ts` — 두 파일 존재

`cd /Users/minho.yoo/dev/wallet/WAIaaS && npx tsc -p packages/daemon/tsconfig.json --noEmit 2>&1 | grep -v 'security-test-helpers'` — 새 에러 없음 (pre-existing 제외)
  </verify>
  <done>
- BackupService 클래스가 createBackup, restoreLatest, restore, listBackups, pruneBackups 메서드를 포함한다
- barrel export가 설정되어 있다
- 타입 체크가 통과한다
  </done>
</task>

<task type="auto">
  <name>Task 2: BackupService 단위 테스트</name>
  <files>
    packages/daemon/src/__tests__/backup-service.test.ts
  </files>
  <action>
**`packages/daemon/src/__tests__/backup-service.test.ts` 생성:**

vitest로 테스트. 실제 파일 시스템(tmpdir)을 사용한 통합 스타일 단위 테스트.

**테스트 셋업:**
- 각 테스트마다 tmpdir에 가짜 dataDir 구조 생성:
  - `{tmpDir}/data/waiaas.db` (더미 내용 write)
  - `{tmpDir}/config.toml` (더미 TOML 내용 write)
- afterEach에서 tmpdir 정리

**테스트 케이스 (최소 10개):**

describe('createBackup'):
1. DB + config.toml이 백업 디렉토리에 복사된다
2. 백업 디렉토리 이름이 `pre-upgrade-{version}-{timestamp}` 형식이다
3. WAL/SHM 파일이 있으면 함께 복사된다
4. config.toml이 없어도 에러 없이 DB만 백업된다
5. DB 파일이 없으면 에러를 throw한다

describe('restoreLatest'):
6. 최신 백업에서 DB + config.toml이 복원된다
7. 백업이 없으면 에러를 throw한다

describe('restore'):
8. 지정된 백업 디렉토리에서 파일이 복원된다

describe('listBackups'):
9. 백업 목록이 최신순으로 정렬된다

describe('pruneBackups'):
10. 5개 초과 백업이 삭제되고 최신 5개가 보존된다
11. 5개 이하이면 삭제되지 않는다
12. 삭제된 개수를 반환한다

**검증 패턴:**
- existsSync로 파일 존재 확인
- readFileSync로 내용 일치 확인
- readdirSync로 디렉토리 개수 확인
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && npx vitest run packages/daemon/src/__tests__/backup-service.test.ts` — 10개 이상 테스트 통과
  </verify>
  <done>
- 12개 테스트가 모두 통과한다
- 백업 생성/복원/정리 모든 시나리오가 검증된다
- 엣지 케이스(파일 없음, 빈 백업 목록)가 처리된다
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run packages/daemon/src/__tests__/backup-service.test.ts` — 전체 통과
2. `npx tsc -p packages/daemon/tsconfig.json --noEmit` — 새 에러 없음
3. BackupService가 `packages/daemon/src/infrastructure/backup/index.ts`에서 export 확인
4. createBackup이 `{dataDir}/backups/pre-upgrade-{version}-{timestamp}/` 구조로 생성 확인
5. pruneBackups(5)가 오래된 백업을 삭제하는지 테스트에서 확인
</verification>

<success_criteria>
- UPGR-03: 업그레이드 전 DB + config.toml을 {dataDir}/backups/pre-upgrade-{version}-{timestamp}/에 자동 백업한다
- UPGR-04: waiaas upgrade --rollback으로 직전 백업에서 복원할 수 있다 (restoreLatest 메서드 제공)
- UPGR-06: 백업 디렉토리를 최근 5개까지만 보존하고 초과분을 자동 삭제한다
</success_criteria>

<output>
After completion, create `.planning/phases/161-cli-upgrade/161-02-SUMMARY.md`
</output>
