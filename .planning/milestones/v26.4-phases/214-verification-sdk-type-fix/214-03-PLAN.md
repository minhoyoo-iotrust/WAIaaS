---
phase: 214-verification-sdk-type-fix
plan: 03
type: execute
wave: 2
depends_on: [214-01, 214-02]
files_modified:
  - packages/sdk/src/types.ts
  - packages/sdk/src/index.ts
  - python-sdk/waiaas/models.py
autonomous: true
gap_closure: true
requirements: [DISC-01, DISC-02, DISC-03, DISC-04, INTG-01, INTG-02, INTG-03, INTG-04, INTG-05, INTG-06, INTG-07, INTG-08, INTG-09, INTG-10]

must_haves:
  truths:
    - "SDK ConnectInfoResponse has top-level policies Record<string, PolicyEntry[]> matching daemon schema"
    - "SDK ConnectInfoWallet no longer has embedded policies field"
    - "Python SDK ConnectInfo has top-level policies dict matching daemon schema"
    - "Python SDK ConnectInfoWallet no longer has embedded policies field"
    - "All existing SDK and Python SDK tests pass"
    - "TypeScript typecheck passes"
  artifacts:
    - path: "packages/sdk/src/types.ts"
      provides: "ConnectInfoResponse with top-level policies"
      contains: "policies: Record<string"
    - path: "python-sdk/waiaas/models.py"
      provides: "ConnectInfo with top-level policies"
      contains: "policies: dict"
  key_links:
    - from: "packages/sdk/src/types.ts ConnectInfoResponse"
      to: "packages/daemon/src/api/routes/openapi-schemas.ts ConnectInfoResponseSchema"
      via: "matching shape: top-level policies Record"
      pattern: "policies.*Record"
---

<objective>
Fix SDK ConnectInfoResponse type to match daemon's connect-info response shape (top-level policies Record instead of embedded in wallet objects).

Purpose: Resolve the type mismatch identified in v26.4-MILESTONE-AUDIT.md (INTG-01 integration finding). Daemon returns `policies` as a top-level `Record<walletId, PolicyEntry[]>` but SDK has policies embedded inside ConnectInfoWallet.
Output: Updated `packages/sdk/src/types.ts` and `python-sdk/waiaas/models.py` with correct type shapes.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/v26.4-MILESTONE-AUDIT.md (integration finding: SDK type mismatch)
@packages/daemon/src/api/routes/openapi-schemas.ts (ConnectInfoResponseSchema — lines 990-1017, source of truth)
@packages/sdk/src/types.ts (ConnectInfoWallet, ConnectInfoResponse — lines 215-243, current incorrect types)
@packages/sdk/src/index.ts (type exports — lines 42-49)
@python-sdk/waiaas/models.py (ConnectInfoWallet, ConnectInfo — lines 374-417, current incorrect types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TypeScript SDK ConnectInfoResponse type</name>
  <files>packages/sdk/src/types.ts, packages/sdk/src/index.ts</files>
  <action>
Modify `packages/sdk/src/types.ts` to match daemon's ConnectInfoResponseSchema shape:

1. **Create ConnectInfoPolicyEntry interface:**
   ```typescript
   export interface ConnectInfoPolicyEntry {
     type: string;
     rules: Record<string, unknown>;
     priority: number;
     network: string | null;
   }
   ```

2. **Remove policies from ConnectInfoWallet:**
   Remove the `policies` field from the `ConnectInfoWallet` interface. The daemon schema (openapi-schemas.ts L996-1004) does NOT include policies in wallet objects.

3. **Add top-level policies to ConnectInfoResponse:**
   Add `policies: Record<string, ConnectInfoPolicyEntry[]>` to match daemon schema (openapi-schemas.ts L1005-1010). Place it after `wallets` field.

   Final ConnectInfoResponse should be:
   ```typescript
   export interface ConnectInfoResponse {
     session: ConnectInfoSession;
     wallets: ConnectInfoWallet[];
     policies: Record<string, ConnectInfoPolicyEntry[]>;
     capabilities: string[];
     daemon: ConnectInfoDaemon;
     prompt: string;
   }
   ```

4. **Update exports in index.ts:**
   Add `ConnectInfoPolicyEntry` to the type exports if not already present.

5. **Verify:** Run `pnpm turbo run typecheck --filter=@waiaas/sdk` and `pnpm turbo run test --filter=@waiaas/sdk` to ensure no regressions.
  </action>
  <verify>
1. `grep 'policies: Record<string, ConnectInfoPolicyEntry' packages/sdk/src/types.ts` — should match in ConnectInfoResponse
2. `grep -c 'policies' packages/sdk/src/types.ts` — ConnectInfoWallet should NOT have policies
3. `pnpm turbo run typecheck --filter=@waiaas/sdk` passes
4. `pnpm turbo run test --filter=@waiaas/sdk` passes
  </verify>
  <done>SDK ConnectInfoResponse has top-level policies Record matching daemon schema, ConnectInfoWallet has no embedded policies, all SDK tests and typecheck pass</done>
</task>

<task type="auto">
  <name>Task 2: Fix Python SDK ConnectInfo type</name>
  <files>python-sdk/waiaas/models.py</files>
  <action>
Modify `python-sdk/waiaas/models.py` to match the same daemon response shape:

1. **Remove policies from ConnectInfoWallet class** (line ~384):
   Delete the `policies: list[dict[str, Any]]` field.

2. **Add top-level policies to ConnectInfo class** (line ~408):
   Add `policies: dict[str, list[dict[str, Any]]]` field after `wallets`. This mirrors the daemon's `Record<walletId, PolicyEntry[]>` shape.

   Final ConnectInfo class should have fields:
   - session: ConnectInfoSession
   - wallets: list[ConnectInfoWallet]
   - policies: dict[str, list[dict[str, Any]]]
   - capabilities: list[str]
   - daemon: ConnectInfoDaemon
   - prompt: str

3. **Verify:** The Python SDK has no automated tests for ConnectInfo model, but verify the module imports cleanly: `python3 -c "from waiaas.models import ConnectInfo; print('OK')"`
  </action>
  <verify>
1. `grep 'policies: dict' python-sdk/waiaas/models.py` — should match in ConnectInfo class
2. `python3 -c "from waiaas.models import ConnectInfo; print('OK')"` runs without error (from python-sdk directory)
3. ConnectInfoWallet should NOT have policies field: `grep -A 10 'class ConnectInfoWallet' python-sdk/waiaas/models.py | grep -c 'policies'` returns 0
  </verify>
  <done>Python SDK ConnectInfo has top-level policies dict matching daemon schema, ConnectInfoWallet has no embedded policies, module imports cleanly</done>
</task>

</tasks>

<verification>
- `packages/sdk/src/types.ts` ConnectInfoResponse has `policies: Record<string, ConnectInfoPolicyEntry[]>` matching daemon schema
- `packages/sdk/src/types.ts` ConnectInfoWallet does NOT have `policies` field
- `packages/sdk/src/types.ts` ConnectInfoPolicyEntry has `type`, `rules`, `priority`, `network` fields
- `python-sdk/waiaas/models.py` ConnectInfo has `policies: dict[str, list[dict[str, Any]]]` matching daemon schema
- `python-sdk/waiaas/models.py` ConnectInfoWallet does NOT have `policies` field
- `pnpm turbo run typecheck --filter=@waiaas/sdk` passes
- `pnpm turbo run test --filter=@waiaas/sdk` passes
- `pnpm turbo run lint --filter=@waiaas/sdk` passes
</verification>

<success_criteria>
SDK and Python SDK ConnectInfoResponse/ConnectInfo types match daemon's connect-info response shape with top-level policies Record, all tests pass, and the INTG-01 type mismatch from the audit is resolved.
</success_criteria>

<output>
After completion, create `.planning/phases/214-verification-sdk-type-fix/214-03-SUMMARY.md`
</output>
