---
phase: 212-connect-info-endpoint
plan: 02
type: execute
wave: 2
depends_on: ["212-01"]
files_modified:
  - packages/daemon/src/api/routes/admin.ts
  - packages/daemon/src/__tests__/connect-info.test.ts
autonomous: true
requirements: [DISC-04]

must_haves:
  truths:
    - "POST /admin/agent-prompt creates a single multi-wallet session (one sessionId, one token) instead of per-wallet sessions"
    - "POST /admin/agent-prompt prompt output uses buildConnectInfoPrompt (shared with connect-info)"
    - "GET /v1/connect-info returns correct wallet list, policies, capabilities, and prompt for a multi-wallet session"
    - "connect-info filters to only session-linked wallets (other wallets not exposed)"
    - "capabilities dynamically reflect daemon config -- x402 absent when disabled, actions absent when no API keys"
  artifacts:
    - path: "packages/daemon/src/api/routes/admin.ts"
      provides: "Refactored agent-prompt handler using single multi-wallet session + buildConnectInfoPrompt"
      contains: "buildConnectInfoPrompt"
    - path: "packages/daemon/src/__tests__/connect-info.test.ts"
      provides: "Integration tests for connect-info endpoint and agent-prompt refactor"
      min_lines: 80
  key_links:
    - from: "packages/daemon/src/api/routes/admin.ts"
      to: "packages/daemon/src/api/routes/connect-info.ts"
      via: "import { buildConnectInfoPrompt }"
      pattern: "buildConnectInfoPrompt"
    - from: "packages/daemon/src/__tests__/connect-info.test.ts"
      to: "/v1/connect-info"
      via: "HTTP GET requests in test"
      pattern: "GET.*connect-info"
---

<objective>
POST /admin/agent-prompt를 단일 멀티 지갑 세션으로 변경하고, buildConnectInfoPrompt를 공유하며, connect-info + agent-prompt 통합 테스트를 작성한다.

Purpose: agent-prompt가 지갑당 개별 세션 대신 단일 멀티 지갑 세션을 생성하고, connect-info와 동일한 프롬프트 빌더를 사용하여 일관된 에이전트 경험을 제공한다.
Output: Refactored admin.ts agent-prompt handler + connect-info.test.ts integration tests
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/212-connect-info-endpoint/212-01-SUMMARY.md
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/connect-info.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/__tests__/wallet-id-selection.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor POST /admin/agent-prompt to single multi-wallet session + shared prompt builder</name>
  <files>packages/daemon/src/api/routes/admin.ts</files>
  <action>
Refactor the `POST /admin/agent-prompt` handler (admin.ts lines ~1897-1991) to:

1. Import `buildConnectInfoPrompt` from `'./connect-info.js'`.

2. Replace the per-wallet session creation loop with a single multi-wallet session:
   - Instead of creating N sessions (one per wallet), create ONE session.
   - Insert ONE row into `sessions` table.
   - Insert N rows into `session_wallets` table (first wallet is `isDefault: true`, rest `isDefault: false`).
   - Generate ONE JWT token with `wlt` claim set to the default wallet's ID.

3. Replace the hand-built prompt generation (lines array) with `buildConnectInfoPrompt()`:
   - Query policies for each target wallet (same as connect-info does).
   - Compute capabilities dynamically (same logic as connect-info: always transfer/token_transfer/balance/assets, conditionally sign/actions/x402).
   - Call `buildConnectInfoPrompt({ wallets, policies, capabilities, baseUrl, version: deps.version })`.

4. Update the response to include `sessionId` and `token` (single values, not per-wallet):
   - The AgentPromptResponseSchema already has `prompt`, `walletCount`, `sessionsCreated`, `expiresAt`.
   - `sessionsCreated` should now be `1` (single session) instead of N.
   - The `prompt` should include the session token so the agent can start using it immediately.
   - After the buildConnectInfoPrompt output, append:
     ```
     \n\nSession Token: {token}\nSession ID: {sessionId}
     ```

5. Ensure the deps interface `AdminRouteDeps` gains access to capabilities detection:
   - `deps.apiKeyStore` already exists.
   - `deps.settingsService` already exists.
   - `deps.daemonConfig` already exists (has x402.enabled, signing_sdk.enabled).
   - No new deps needed.

The response schema (AgentPromptResponseSchema) does NOT need changes -- it already has `prompt: string`, `walletCount: number`, `sessionsCreated: number`, `expiresAt: number`.
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/daemon` passes.
  </verify>
  <done>
POST /admin/agent-prompt creates exactly 1 session with N wallet links (via session_wallets). Prompt is generated by buildConnectInfoPrompt (shared with connect-info). sessionsCreated = 1 in response.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for connect-info and agent-prompt</name>
  <files>packages/daemon/src/__tests__/connect-info.test.ts</files>
  <action>
Create `packages/daemon/src/__tests__/connect-info.test.ts` with integration tests. Follow the existing test pattern from `wallet-id-selection.test.ts` (uses createApp, in-memory SQLite, JWT setup).

Test setup: Create 2-3 wallets, create a multi-wallet session (via POST /v1/sessions with walletIds), add policies to wallets.

Test cases (minimum 8):

1. **connect-info returns session info** -- GET /v1/connect-info with valid session token returns 200 with session.id, session.expiresAt, session.source.

2. **connect-info returns linked wallets only** -- Create 3 wallets, link 2 to session. connect-info should return exactly 2 wallets with correct id/name/chain/environment/address/isDefault fields.

3. **connect-info returns per-wallet policies** -- Add TRANSFER_LIMIT policy to wallet-1, ALLOWED_TOKENS to wallet-2. connect-info.policies should have entries keyed by walletId.

4. **connect-info capabilities includes base capabilities** -- Response always has transfer, token_transfer, balance, assets.

5. **connect-info capabilities reflects x402 config** -- When config.x402.enabled=true, capabilities includes 'x402'. When false, it does not.

6. **connect-info prompt contains wallet info** -- prompt string includes wallet names and addresses.

7. **connect-info rejects without session token** -- GET /v1/connect-info without Authorization header returns 401.

8. **agent-prompt creates single session** -- POST /admin/agent-prompt with walletIds=[w1, w2] creates exactly 1 session (check sessions table count), 2 session_wallets rows, and returns sessionsCreated=1.

9. **agent-prompt prompt uses buildConnectInfoPrompt** -- POST /admin/agent-prompt prompt includes wallet names and capabilities (same format as connect-info).

10. **connect-info after agent-prompt** -- POST /admin/agent-prompt, then GET /v1/connect-info with returned token -> wallets match, policies present, prompt non-empty.

Use test helpers from existing patterns:
- `createApp(deps)` for server setup
- In-memory better-sqlite3 for DB
- `JwtSecretManager` mock or real instance for token signing
- `masterAuth` header for admin endpoints
- Session token (`wai_sess_` prefix) for connect-info endpoint

Run with `pnpm vitest run packages/daemon/src/__tests__/connect-info.test.ts`.
  </action>
  <verify>
`pnpm vitest run packages/daemon/src/__tests__/connect-info.test.ts` -- all tests pass.
`pnpm turbo run typecheck --filter=@waiaas/daemon` -- no type errors.
  </verify>
  <done>
10 integration tests covering connect-info wallets/policies/capabilities/prompt, sessionAuth enforcement, agent-prompt single session creation, and end-to-end agent-prompt -> connect-info flow. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` -- zero type errors
2. `pnpm turbo run lint --filter=@waiaas/daemon` -- zero lint errors
3. `pnpm vitest run packages/daemon/src/__tests__/connect-info.test.ts` -- all 10+ tests pass
4. `pnpm vitest run packages/daemon/src/__tests__/session-lifecycle.test.ts` -- no regression in existing session tests
5. Verify agent-prompt handler imports and calls buildConnectInfoPrompt
6. Verify agent-prompt creates exactly 1 session row + N session_wallets rows
</verification>

<success_criteria>
- POST /admin/agent-prompt creates a single multi-wallet session (1 session, N session_wallets)
- agent-prompt uses buildConnectInfoPrompt from connect-info.ts (shared logic)
- 10+ integration tests pass covering connect-info response structure, session scoping, capabilities, auth, and agent-prompt integration
- No regression in existing session lifecycle or wallet-id-selection tests
</success_criteria>

<output>
After completion, create `.planning/phases/212-connect-info-endpoint/212-02-SUMMARY.md`
</output>
