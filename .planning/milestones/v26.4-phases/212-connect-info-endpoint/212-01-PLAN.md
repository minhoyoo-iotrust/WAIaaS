---
phase: 212-connect-info-endpoint
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/routes/connect-info.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/api/routes/index.ts
  - packages/daemon/src/api/server.ts
autonomous: true
requirements: [DISC-01, DISC-02, DISC-03]

must_haves:
  truths:
    - "GET /v1/connect-info (sessionAuth) returns session info, wallets array, per-wallet policies, capabilities, daemon info, and prompt"
    - "capabilities array is dynamically computed from daemon config (x402.enabled, apiKeyStore has keys, signing_sdk.enabled)"
    - "connect-info prompt string includes wallet names, addresses, networks, and available capabilities"
    - "Only wallets linked to the session via session_wallets are returned (not all wallets)"
  artifacts:
    - path: "packages/daemon/src/api/routes/connect-info.ts"
      provides: "GET /v1/connect-info route handler + buildConnectInfoPrompt helper"
      exports: ["connectInfoRoutes", "ConnectInfoRouteDeps", "buildConnectInfoPrompt"]
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "ConnectInfoResponseSchema Zod schema"
      contains: "ConnectInfoResponseSchema"
    - path: "packages/daemon/src/api/server.ts"
      provides: "connect-info route mounted with sessionAuth"
      contains: "connectInfoRoutes"
  key_links:
    - from: "packages/daemon/src/api/routes/connect-info.ts"
      to: "session_wallets + wallets + policies tables"
      via: "drizzle joins for session-scoped data"
      pattern: "sessionWallets.*wallets.*policies"
    - from: "packages/daemon/src/api/server.ts"
      to: "packages/daemon/src/api/routes/connect-info.ts"
      via: "app.route('/v1', connectInfoRoutes(deps))"
      pattern: "connectInfoRoutes"
---

<objective>
GET /v1/connect-info 엔드포인트 구현 -- 세션 토큰으로 접근 가능한 지갑/정책/capabilities/프롬프트를 반환하는 자기 발견 라우트.

Purpose: 에이전트가 마스터 패스워드 없이 세션 토큰만으로 자기 상황(지갑, 정책, API 사용법)을 파악할 수 있게 한다.
Output: connect-info.ts 라우트 파일, OpenAPI 스키마, 서버 라우팅 연결
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/211-api-wallet-selection/211-01-SUMMARY.md
@.planning/phases/211-api-wallet-selection/211-02-SUMMARY.md
@packages/daemon/src/api/routes/admin.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
@packages/daemon/src/api/routes/index.ts
@packages/daemon/src/api/server.ts
@packages/daemon/src/api/middleware/session-auth.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/daemon/src/infrastructure/settings/setting-keys.ts
@packages/daemon/src/infrastructure/config/loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ConnectInfoResponseSchema + GET /v1/connect-info route handler</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/connect-info.ts
  </files>
  <action>
1. In `openapi-schemas.ts`, add `ConnectInfoResponseSchema`:

```typescript
export const ConnectInfoResponseSchema = z.object({
  session: z.object({
    id: z.string().uuid(),
    expiresAt: z.number().int(),
    source: z.enum(['api', 'mcp']),
  }),
  wallets: z.array(z.object({
    id: z.string().uuid(),
    name: z.string(),
    chain: z.string(),
    environment: z.string(),
    defaultNetwork: z.string().nullable(),
    address: z.string(),
    isDefault: z.boolean(),
  })),
  policies: z.record(z.string(), z.array(z.object({
    type: z.string(),
    rules: z.record(z.unknown()),
    priority: z.number().int(),
    network: z.string().nullable(),
  }))),
  capabilities: z.array(z.string()),
  daemon: z.object({
    version: z.string(),
    baseUrl: z.string(),
  }),
  prompt: z.string(),
}).openapi('ConnectInfoResponse');
```

2. Create `packages/daemon/src/api/routes/connect-info.ts`:

- Export `ConnectInfoRouteDeps` interface with: `db`, `config` (DaemonConfig), `settingsService?` (SettingsService), `apiKeyStore?` (ApiKeyStore), `version` (string).
- Export `buildConnectInfoPrompt(params)` as a separate named function (will be reused by agent-prompt in Plan 02). Parameters: `{ wallets, policies, capabilities, baseUrl, version }`. Returns prompt string. Template:
  ```
  You are connected to WAIaaS daemon v{version}.
  Base URL: {baseUrl}

  You have access to {N} wallet(s):

  1. {name} ({chain}/{environment})
     Address: {address}
     Network: {defaultNetwork}
     Policies: {policy summary or "No restrictions"}

  Available capabilities: {capabilities.join(', ')}

  Use GET /v1/wallet/balance to check balances.
  Use POST /v1/transactions/send to transfer funds.
  Specify walletId parameter to target a specific wallet.
  When session expires (401), renew with PUT /v1/sessions/{sessionId}/renew.
  ```
- Export `connectInfoRoutes(deps)` factory function returning OpenAPIHono router.
- Single route: GET /connect-info with OpenAPI createRoute, tags: ['Discovery'], sessionAuth (applied at server.ts level).
- Handler logic:
  a. Read `sessionId` and `defaultWalletId` from Hono context (`c.get()`).
  b. Query session row from `sessions` table for `expiresAt` and `source`.
  c. Query `session_wallets` JOIN `wallets` WHERE `sessionWallets.sessionId = sessionId` to get all linked wallets. Map to response format with `isDefault` from junction table.
  d. For each wallet, query `policies` WHERE `walletId = wallet.id AND enabled = true`. Group as `Record<walletId, policy[]>`.
  e. Compute `capabilities` array dynamically:
     - Always include: `'transfer'`, `'token_transfer'`, `'balance'`, `'assets'`
     - Include `'sign'` if `deps.config.signing_sdk?.enabled === true` OR `deps.settingsService?.get('signing_sdk.enabled') === 'true'`
     - Include `'actions'` if `deps.apiKeyStore` has any keys (check `deps.apiKeyStore?.listAll().some(k => k.hasKey)`)
     - Include `'x402'` if `deps.config.x402?.enabled === true`
  f. Build `daemon` object: `{ version: deps.version, baseUrl }` where baseUrl is derived from `c.req.header('Host')` + protocol (same pattern as agent-prompt in admin.ts:1935-1937).
  g. Call `buildConnectInfoPrompt(...)` to generate the prompt string.
  h. Return 200 JSON matching ConnectInfoResponseSchema.

Ensure all imports use the project's existing patterns (drizzle-orm operators, WAIaaSError from @waiaas/core, etc.). Use `eq`, `and` from drizzle-orm for queries. Follow the existing route file patterns in the codebase (OpenAPIHono, createRoute, factory function with deps).
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/daemon` passes with no errors.
  </verify>
  <done>
ConnectInfoResponseSchema exists in openapi-schemas.ts. connect-info.ts exports connectInfoRoutes, ConnectInfoRouteDeps, and buildConnectInfoPrompt. Capabilities are dynamically computed from config/settings/apiKeyStore. Prompt builder is a standalone reusable function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Server integration + sessionAuth + route barrel export</name>
  <files>
    packages/daemon/src/api/routes/index.ts
    packages/daemon/src/api/server.ts
  </files>
  <action>
1. In `packages/daemon/src/api/routes/index.ts`, add export:
   ```typescript
   export { connectInfoRoutes, type ConnectInfoRouteDeps } from './connect-info.js';
   ```

2. In `packages/daemon/src/api/server.ts`:
   a. Import `connectInfoRoutes` from `'./routes/connect-info.js'`.
   b. Add sessionAuth middleware for `/v1/connect-info`:
      In the sessionAuth block (around line 192-203), add:
      ```typescript
      app.use('/v1/connect-info', sessionAuth);
      ```
   c. Register the route after the existing route registrations (e.g., after the utils routes block). The route should be registered when `deps.db` is available:
      ```typescript
      if (deps.db) {
        app.route('/v1', connectInfoRoutes({
          db: deps.db,
          config: deps.config ?? {} as DaemonConfig,
          settingsService: deps.settingsService,
          apiKeyStore: deps.apiKeyStore,
          version: DAEMON_VERSION,
        }));
      }
      ```

IMPORTANT: Do NOT add masterAuth to `/v1/connect-info`. It uses sessionAuth only (per design -- agents access with session token, no master password).
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/daemon` passes. Verify the route is accessible by checking the OpenAPI doc generation still works (the app should start without errors if all deps are provided).
  </verify>
  <done>
GET /v1/connect-info is mounted with sessionAuth middleware. Route is registered in server.ts and exported from routes/index.ts. No masterAuth required for this endpoint.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/daemon` -- zero type errors
2. `pnpm turbo run lint --filter=@waiaas/daemon` -- zero lint errors
3. Verify `ConnectInfoResponseSchema` is exported from openapi-schemas.ts
4. Verify `buildConnectInfoPrompt` is exported from connect-info.ts (reusable by Plan 02)
5. Verify `/v1/connect-info` appears in sessionAuth middleware registrations in server.ts
6. Verify `/v1/connect-info` does NOT appear in masterAuth registrations
</verification>

<success_criteria>
- GET /v1/connect-info route exists with sessionAuth protection
- Response includes session info, wallets array (from session_wallets join), per-wallet policies, dynamic capabilities, daemon info, and prompt string
- capabilities dynamically reflect daemon config (x402.enabled, signing_sdk.enabled, apiKeyStore keys)
- buildConnectInfoPrompt is a standalone exported function for reuse in Plan 02
- All type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/212-connect-info-endpoint/212-01-SUMMARY.md`
</output>
