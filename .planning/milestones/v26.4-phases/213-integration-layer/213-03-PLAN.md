---
phase: 213-integration-layer
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/pages/sessions.tsx
  - packages/admin/src/api/endpoints.ts
  - packages/cli/src/commands/quickstart.ts
autonomous: true
requirements: [INTG-05, INTG-06, INTG-07]

must_haves:
  truths:
    - "Admin UI 세션 생성 폼에서 다중 지갑 선택과 기본 지갑 지정이 가능하다"
    - "Admin UI 세션 상세(목록)에서 연결된 지갑 목록과 기본 지갑 배지가 표시된다"
    - "CLI quickset이 단일 멀티 지갑 세션을 생성하고 단일 토큰 파일을 쓴다"
    - "CLI quickset MCP config snippet이 단일 entry를 생성한다 (WAIAAS_WALLET_ID 미설정)"
  artifacts:
    - path: "packages/admin/src/pages/sessions.tsx"
      provides: "Multi-wallet session creation form + wallet list display"
      contains: "walletIds"
    - path: "packages/cli/src/commands/quickstart.ts"
      provides: "Single multi-wallet session creation + single MCP config"
      contains: "walletIds"
  key_links:
    - from: "packages/admin/src/pages/sessions.tsx"
      to: "POST /v1/sessions"
      via: "apiPost with walletIds array"
      pattern: "walletIds"
    - from: "packages/cli/src/commands/quickstart.ts"
      to: "POST /v1/sessions"
      via: "fetch POST with walletIds"
      pattern: "walletIds"
---

<objective>
Admin UI 세션 생성/목록에 멀티 지갑 지원을 추가하고, CLI quickset을 단일 멀티 지갑 세션 + 단일 MCP config entry로 전환한다.

Purpose: 관리자가 Admin UI에서 멀티 지갑 세션을 생성/관리하고, CLI로 원커맨드 멀티 지갑 환경을 셋업할 수 있게 한다.
Output: Admin UI 세션 페이지 개선, CLI quickset 멀티 지갑 전환
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/212-connect-info-endpoint/212-02-SUMMARY.md

@packages/admin/src/pages/sessions.tsx
@packages/admin/src/api/endpoints.ts
@packages/cli/src/commands/quickstart.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin UI 세션 생성 폼 멀티 지갑 + 세션 목록 지갑 표시</name>
  <files>
    packages/admin/src/pages/sessions.tsx
  </files>
  <action>
**세션 생성 폼 변경 (handleCreate 함수 영역):**

현재 단일 지갑 선택(selectedWalletId 하나) + "Create Session" 버튼 구조를 멀티 지갑 선택으로 전환:

1. 기존 `selectedWalletId` signal 유지 (기본 지갑 지정용)
2. 새 signal 추가: `selectedWalletIds = useSignal<Set<string>>(new Set())` -- 선택된 지갑 ID 집합
3. 새 signal 추가: `defaultWalletId = useSignal('')` -- 기본 지갑 ID

**Create Session 모달로 전환** (기존 인라인 버튼 → 모달):
- "Create Session" 버튼 클릭 → 모달 오픈
- 모달 내용:
  - 지갑 목록 체크박스 (wallets.value 순회, 각 지갑에 체크박스)
  - 체크된 지갑 중 기본 지갑 선택 라디오 버튼 (첫 번째 선택 시 자동 기본 설정)
  - 확인 버튼: "Create Session (N wallets)"

4. handleCreate 변경:
```typescript
const handleCreate = async () => {
  createLoading.value = true;
  try {
    const ids = Array.from(selectedWalletIds.value);
    const body: Record<string, unknown> = ids.length === 1
      ? { walletId: ids[0] }  // 하위 호환: 단일 지갑
      : { walletIds: ids, defaultWalletId: defaultWalletId.value || ids[0] };
    const result = await apiPost<CreatedSession>(API.SESSIONS, body);
    createdToken.value = result.token;
    tokenModal.value = true;
    createModal.value = false;
    await fetchSessions();
  } catch (err) { ... }
};
```

**세션 목록 테이블 변경:**

1. Session 인터페이스에 `wallets?: Array<{ id: string; name: string; isDefault: boolean }>` 추가
2. sessionColumns의 'Wallet' 컬럼 변경:
   - 기존: `s.walletName ?? s.walletId.slice(0, 8)`
   - 변경: wallets 배열이 있으면 지갑 목록 표시 + 기본 지갑에 `(default)` 배지
   ```tsx
   render: (s) => {
     if (s.wallets && s.wallets.length > 0) {
       return (
         <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
           {s.wallets.map((w) => (
             <span key={w.id}>
               {w.name ?? w.id.slice(0, 8)}
               {w.isDefault && <Badge variant="info" style={{ marginLeft: '4px' }}>default</Badge>}
             </span>
           ))}
         </div>
       );
     }
     return s.walletName ?? s.walletId.slice(0, 8) + '...';  // 하위 호환
   }
   ```

3. 지갑 수 표시 컬럼 추가 (선택): 'Wallet' 컬럼에서 wallets.length를 괄호로 표시

**주의사항:**
- 기존 Bulk Create 기능은 유지 (별도 모달, 기존 로직 그대로)
- 새 Create Session 모달은 bulkModal과 별도의 `createModal` signal 사용
- 단일 지갑 선택 시 walletId 단수로 전송 (하위 호환)
- CreatedSession 인터페이스에 `wallets?: Array<{ id: string; name: string; isDefault: boolean }>` 추가
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=admin` 성공
  </verify>
  <done>
    Admin UI 세션 생성 폼에서 다중 지갑 체크박스 + 기본 지갑 라디오 선택이 가능하고, 세션 목록에서 연결된 지갑 목록과 default 배지가 표시된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI quickset 단일 멀티 지갑 세션 + 단일 MCP config entry 전환</name>
  <files>
    packages/cli/src/commands/quickstart.ts
  </files>
  <action>
**quickstartCommand 함수 전체 재구성:**

기존 플로우 (지갑별 개별 세션):
1. 지갑 N개 생성
2. 지갑별 세션 N개 생성 + 토큰 파일 N개 (mcp-tokens/<walletId>)
3. MCP config entry N개 (각각 WAIAAS_WALLET_ID 설정)

**새 플로우 (단일 멀티 지갑 세션):**
1. 지갑 N개 생성 (기존과 동일)
2. **단일 세션 1개 생성**: `POST /v1/sessions { walletIds: [w1.id, w2.id, ...] }`
3. **단일 토큰 파일 1개**: `DATA_DIR/mcp-token` (기존 `mcp-tokens/<walletId>` 대신)
4. **MCP config entry 1개**: WAIAAS_WALLET_ID 미설정

**Step 4 변경 (세션 생성):**

지갑 생성 후 모든 walletId를 수집하여 단일 세션 생성:

```typescript
// Collect all wallet IDs
const walletIds = createdWallets.map(w => w.id);

// Create single multi-wallet session
const sessionRes = await fetch(`${baseUrl}/v1/sessions`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Master-Password': password,
  },
  body: JSON.stringify({
    walletIds,
    expiresIn,
  }),
});

if (!sessionRes.ok) {
  const body = await sessionRes.json().catch(() => null) as Record<string, unknown> | null;
  const msg = body?.['message'] ?? sessionRes.statusText;
  console.error(`Error: Failed to create multi-wallet session (${sessionRes.status}): ${msg}`);
  process.exit(1);
}

const sessionData = await sessionRes.json() as { id: string; token: string; expiresAt: number };

// Write single token file: DATA_DIR/mcp-token (not mcp-tokens/<walletId>)
const tokenPath = join(opts.dataDir, 'mcp-token');
const tmpPath = `${tokenPath}.tmp`;
await mkdir(dirname(tokenPath), { recursive: true });
await writeFile(tmpPath, sessionData.token, 'utf-8');
await rename(tmpPath, tokenPath);
```

**Step 5 변경 (MCP config):**

단일 entry 생성 (WAIAAS_WALLET_ID 미설정):

```typescript
const mcpServers: Record<string, Record<string, unknown>> = {
  'waiaas': {
    command: 'npx',
    args: ['@waiaas/mcp'],
    env: {
      WAIAAS_DATA_DIR: opts.dataDir,
      WAIAAS_BASE_URL: baseUrl,
    },
  },
};
```

**Step 6 변경 (출력):**

```
WAIaaS Quickset Complete!

Mode: mainnet

Solana Wallet:
  Name: solana-mainnet
  Address: ABC...xyz
  ...

EVM Wallet:
  Name: evm-mainnet
  Address: 0x123...abc
  ...

Multi-Wallet Session:
  Session ID: sess_abc123
  Connected Wallets: 2 (solana-mainnet, evm-mainnet)
  Default Wallet: solana-mainnet
  Expires at: 2026-02-22 12:00

MCP Configuration:
(Add to your claude_desktop_config.json)
{
  "mcpServers": {
    "waiaas": {
      "command": "npx",
      "args": ["@waiaas/mcp"],
      "env": {
        "WAIAAS_DATA_DIR": "/path/to/data",
        "WAIAAS_BASE_URL": "http://127.0.0.1:3100"
      }
    }
  }
}
```

**Step 7 변경 (Agent Connection Prompt):**

```
AI Agent Connection Prompt:
(Copy and paste the block below to your AI agent)
────────────────────────────────────
[WAIaaS Connection]
- URL: http://127.0.0.1:3100
- Session Token: wai_sess_xxx

Connected Wallets:
1. solana-mainnet (sol-abc) — mainnet-beta
2. evm-mainnet (evm-xyz) — ethereum-mainnet

Use GET /v1/connect-info with this session token to discover
your wallets, policies, capabilities, and available operations.
────────────────────────────────────
```

**createSessionAndWriteToken 함수 제거** (더 이상 개별 세션 생성 불필요). buildConfigEntry 함수도 제거 또는 단순화.

**기존 토큰 파일 처리:** quickset 재실행 시 기존 `mcp-tokens/<walletId>` 파일은 삭제하지 않음. SessionManager fallback으로 기존 환경 계속 동작.
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/cli && pnpm turbo run lint --filter=@waiaas/cli` 성공
  </verify>
  <done>
    CLI quickset이 단일 멀티 지갑 세션 + 단일 mcp-token 파일 + 단일 MCP config entry를 생성하고, typecheck + lint 통과.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=admin` 통과
2. `pnpm turbo run typecheck --filter=@waiaas/cli` 통과
3. `pnpm turbo run lint --filter=admin` 통과
4. `pnpm turbo run lint --filter=@waiaas/cli` 통과
5. Admin UI 세션 페이지에 walletIds 관련 코드 존재
6. CLI quickstart.ts에 walletIds 배열 전송 코드 존재
</verification>

<success_criteria>
- Admin UI: 세션 생성 모달에서 다중 지갑 체크박스 + 기본 지갑 라디오 선택 가능
- Admin UI: 세션 목록에서 wallets 배열 표시 + default 배지
- CLI: quickset이 단일 POST /v1/sessions { walletIds: [...] } 호출
- CLI: 단일 mcp-token 파일 + 단일 MCP config entry (WAIAAS_WALLET_ID 없음)
</success_criteria>

<output>
After completion, create `.planning/phases/213-integration-layer/213-03-SUMMARY.md`
</output>
