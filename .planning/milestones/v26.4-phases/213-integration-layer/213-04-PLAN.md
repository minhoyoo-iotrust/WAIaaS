---
phase: 213-integration-layer
plan: 04
type: execute
wave: 2
depends_on: [213-01, 213-02, 213-03]
files_modified:
  - skills/quickstart.skill.md
  - skills/wallet.skill.md
  - skills/admin.skill.md
  - docs/guides/openclaw-integration.md
  - docs/guides/claude-code-integration.md
  - docs/guides/agent-skills-integration.md
  - packages/core/src/enums/notification.ts
  - packages/core/src/i18n/en.ts
  - packages/core/src/i18n/ko.ts
  - packages/core/src/schemas/signing-protocol.ts
  - packages/core/src/__tests__/enums.test.ts
  - packages/daemon/src/api/routes/sessions.ts
  - packages/daemon/src/notifications/templates/message-templates.ts
autonomous: true
requirements: [INTG-08, INTG-09, INTG-10]

must_haves:
  truths:
    - "스킬 파일에 connect-info 사용법과 walletId 파라미터가 문서화되어 있다"
    - "가이드 문서에서 마스터 패스워드 의존이 제거되고 세션 토큰 단독 설정으로 변경되었다"
    - "SESSION_WALLET_ADDED/SESSION_WALLET_REMOVED 알림 이벤트가 지갑 동적 추가/제거 시 발송된다"
  artifacts:
    - path: "skills/quickstart.skill.md"
      provides: "connect-info 사용법 안내"
      contains: "connect-info"
    - path: "skills/wallet.skill.md"
      provides: "walletId 파라미터 사용법"
      contains: "walletId"
    - path: "packages/core/src/enums/notification.ts"
      provides: "SESSION_WALLET_ADDED, SESSION_WALLET_REMOVED event types"
      contains: "SESSION_WALLET_ADDED"
    - path: "packages/daemon/src/api/routes/sessions.ts"
      provides: "notify calls for wallet add/remove"
      contains: "SESSION_WALLET_ADDED"
  key_links:
    - from: "packages/daemon/src/api/routes/sessions.ts"
      to: "packages/daemon/src/notifications/notification-service.ts"
      via: "deps.notificationService.notify()"
      pattern: "notify.*SESSION_WALLET"
    - from: "packages/core/src/enums/notification.ts"
      to: "packages/core/src/schemas/signing-protocol.ts"
      via: "EVENT_CATEGORY_MAP entry"
      pattern: "SESSION_WALLET_ADDED.*session"
---

<objective>
스킬 파일과 가이드 문서를 멀티 지갑 세션 + 자기 발견에 맞게 업데이트하고, 지갑 동적 추가/제거 알림 이벤트를 추가한다.

Purpose: 에이전트와 사람이 새 기능을 올바르게 사용할 수 있도록 문서를 갱신하고, 지갑 변경 알림으로 운영 가시성을 확보한다.
Output: 스킬 파일 3개 + 가이드 3개 업데이트, 알림 이벤트 2개 추가
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/212-connect-info-endpoint/212-01-SUMMARY.md
@.planning/phases/212-connect-info-endpoint/212-02-SUMMARY.md

@skills/quickstart.skill.md
@skills/wallet.skill.md
@skills/admin.skill.md
@docs/guides/openclaw-integration.md
@docs/guides/claude-code-integration.md
@docs/guides/agent-skills-integration.md
@packages/core/src/enums/notification.ts
@packages/core/src/i18n/en.ts
@packages/core/src/i18n/ko.ts
@packages/core/src/schemas/signing-protocol.ts
@packages/daemon/src/api/routes/sessions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 알림 이벤트 SESSION_WALLET_ADDED / SESSION_WALLET_REMOVED 추가</name>
  <files>
    packages/core/src/enums/notification.ts
    packages/core/src/i18n/en.ts
    packages/core/src/i18n/ko.ts
    packages/core/src/schemas/signing-protocol.ts
    packages/core/src/__tests__/enums.test.ts
    packages/daemon/src/api/routes/sessions.ts
    packages/daemon/src/notifications/templates/message-templates.ts
  </files>
  <action>
**1. packages/core/src/enums/notification.ts:**

NOTIFICATION_EVENT_TYPES 배열에 2개 이벤트 추가 (SESSION_CREATED 뒤에):
```typescript
'SESSION_WALLET_ADDED',
'SESSION_WALLET_REMOVED',
```

총 이벤트 수: 26 -> 28개. 주석 업데이트: "28 total"

**2. packages/core/src/i18n/en.ts:**

notifications 객체에 추가:
```typescript
SESSION_WALLET_ADDED: { title: 'Wallet Added to Session', body: 'Wallet {walletId} has been added to session {sessionId}' },
SESSION_WALLET_REMOVED: { title: 'Wallet Removed from Session', body: 'Wallet {walletId} has been removed from session {sessionId}' },
```

summaryItems에도 추가:
```typescript
SESSION_WALLET_ADDED: 'Wallet added to session',
SESSION_WALLET_REMOVED: 'Wallet removed from session',
```

**3. packages/core/src/i18n/ko.ts:**

notifications 객체에 추가:
```typescript
SESSION_WALLET_ADDED: { title: '세션에 지갑 추가', body: '지갑 {walletId}이(가) 세션 {sessionId}에 추가되었습니다' },
SESSION_WALLET_REMOVED: { title: '세션에서 지갑 제거', body: '지갑 {walletId}이(가) 세션 {sessionId}에서 제거되었습니다' },
```

summaryItems에도 추가:
```typescript
SESSION_WALLET_ADDED: '세션에 지갑 추가됨',
SESSION_WALLET_REMOVED: '세션에서 지갑 제거됨',
```

**4. packages/core/src/schemas/signing-protocol.ts:**

EVENT_CATEGORY_MAP에 추가:
```typescript
SESSION_WALLET_ADDED: 'session',
SESSION_WALLET_REMOVED: 'session',
```

**5. packages/core/src/__tests__/enums.test.ts:**

NotificationEventType 테스트의 값 수 검증 변경: 26 -> 28

**6. packages/daemon/src/api/routes/sessions.ts:**

POST /sessions/:id/wallets (addWallet) 핸들러의 insert 성공 후, return 전에:
```typescript
// Fire-and-forget: notify wallet addition
void deps.notificationService?.notify('SESSION_WALLET_ADDED', walletId, {
  sessionId,
  walletId,
});
```

DELETE /sessions/:id/wallets/:walletId (removeWallet) 핸들러의 delete 성공 후, return 전에:
```typescript
// Fire-and-forget: notify wallet removal
void deps.notificationService?.notify('SESSION_WALLET_REMOVED', walletId, {
  sessionId,
  walletId,
});
```

**7. message-templates.ts는 변경 불필요** -- getNotificationMessage 함수가 i18n에서 자동으로 메시지를 가져옴.

**주의사항:**
- NotificationEventType 타입이 union literal이므로 core 패키지 재빌드 필요
- EVENT_CATEGORY_MAP은 Record<NotificationEventType, ...>이므로 새 이벤트 추가 필수
- daemon의 sessions.ts에서 deps.notificationService는 optional chaining 사용 (이미 패턴 확립)
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/core && pnpm turbo run typecheck --filter=@waiaas/daemon && pnpm turbo run test --filter=@waiaas/core -- --run -t "NotificationEventType"` 성공
  </verify>
  <done>
    SESSION_WALLET_ADDED/SESSION_WALLET_REMOVED 이벤트가 core에 정의되고, en/ko i18n 메시지가 존재하며, sessions.ts에서 지갑 추가/제거 시 notify 호출이 추가됨.
  </done>
</task>

<task type="auto">
  <name>Task 2: 스킬 파일 + 가이드 문서 업데이트</name>
  <files>
    skills/quickstart.skill.md
    skills/wallet.skill.md
    skills/admin.skill.md
    docs/guides/openclaw-integration.md
    docs/guides/claude-code-integration.md
    docs/guides/agent-skills-integration.md
  </files>
  <action>
**1. skills/quickstart.skill.md 변경:**

에이전트 시작 워크플로우에 자기 발견 단계 추가:
- "Step 1: Self-Discovery" 섹션 추가:
  ```
  ## Self-Discovery (Recommended First Step)

  Call GET /v1/connect-info with your session token to discover:
  - Which wallets you can access
  - What policies apply to each wallet
  - Available capabilities (transfer, sign, x402, actions)
  - AI-ready prompt with usage instructions

  If using MCP, call the `connect_info` tool instead.
  ```
- 기존 "Use MCP tools" 안내에서 마스터 패스워드 관련 내용 제거
- walletId 파라미터 설명 추가: "For multi-wallet sessions, specify `wallet_id` parameter to target a specific wallet. Omit to use the default wallet."

**2. skills/wallet.skill.md 변경:**

- walletId 쿼리 파라미터 사용법 섹션 추가:
  ```
  ## Multi-Wallet Operations

  When your session has multiple wallets, you can target a specific wallet:
  - GET requests: add `?walletId=<id>` query parameter
  - POST requests: add `walletId` field in request body
  - Omitting walletId uses the session's default wallet

  Example:
    GET /v1/wallet/balance?walletId=wallet-abc
    POST /v1/transactions/send { "walletId": "wallet-abc", "to": "...", "amount": "..." }
  ```
- 기존 단일 지갑 예제를 유지하되 멀티 지갑 예제 추가

**3. skills/admin.skill.md 변경:**

- 세션 생성 API에 walletIds 파라미터 문서화:
  ```
  ## Session Creation (Multi-Wallet)

  POST /v1/sessions
  Body:
    - walletIds: string[] -- Connect multiple wallets (new)
    - walletId: string -- Connect single wallet (backward compatible)
    - defaultWalletId?: string -- Specify default wallet (optional, defaults to first)
    - expiresIn?: number -- TTL in seconds
  ```
- 세션-지갑 동적 관리 API 추가:
  ```
  ## Session-Wallet Management (masterAuth required)

  POST /v1/sessions/:id/wallets { walletId } -- Add wallet
  DELETE /v1/sessions/:id/wallets/:walletId -- Remove wallet
  PATCH /v1/sessions/:id/wallets/:walletId/default -- Set default
  GET /v1/sessions/:id/wallets -- List connected wallets
  ```
- connect-info 엔드포인트 안내:
  ```
  ## Agent Self-Discovery

  GET /v1/connect-info (sessionAuth)
  Returns wallets, policies, capabilities, and AI prompt.
  POST /admin/agent-prompt (masterAuth)
  Creates multi-wallet session and returns connection prompt.
  ```

**4. docs/guides/openclaw-integration.md 변경:**

- `WAIAAS_MASTER_PASSWORD` 환경변수 설정 항목 제거
- 대신 `WAIAAS_SESSION_TOKEN` 설정으로 변경
- 에이전트 초기화 시 `GET /v1/connect-info`로 자기 발견 안내 추가
- "The agent no longer needs the master password. Provide only the session token." 명시

**5. docs/guides/claude-code-integration.md 변경:**

- 마스터 패스워드 의존 제거: 환경변수에서 `WAIAAS_MASTER_PASSWORD` 삭제
- MCP 설정에서 `WAIAAS_WALLET_ID` 제거 (단일 인스턴스 모델)
- connect-info 기반 자기 발견 안내 추가:
  ```
  The MCP server includes a `connect_info` tool that returns all accessible
  wallets, policies, and capabilities. Call it first to understand your environment.
  ```
- MCP config snippet 단일 entry로 변경 (WAIAAS_WALLET_ID 없음)

**6. docs/guides/agent-skills-integration.md 변경:**

- 에이전트 환경 변수에서 `WAIAAS_MASTER_PASSWORD` 제거
- `WAIAAS_SESSION_TOKEN` 단독 설정으로 변경
- "환경 자동 파악" 섹션 추가: connect-info로 지갑/정책/capabilities 자동 파악 안내
- 스킬 파일 로딩 불필요 설명: "With connect-info, the agent can discover capabilities without loading skill files."

**주의사항:**
- 가이드 문서는 한국어/영어 혼용 가능 (기존 패턴 따름)
- 마스터 패스워드 관련 내용은 "관리자가 세팅" 부분에서만 유지, 에이전트 부분에서는 완전 제거
- 기존 내용을 삭제하기보다 섹션 추가/수정으로 보완
  </action>
  <verify>
    1. `grep -l "connect-info" skills/*.skill.md` -- quickstart, wallet, admin 3개 파일 매칭
    2. `grep -l "walletId" skills/wallet.skill.md` -- walletId 파라미터 문서화 확인
    3. `grep -rL "MASTER_PASSWORD" docs/guides/` -- 가이드에서 마스터 패스워드 제거 확인 (에이전트 섹션)
  </verify>
  <done>
    스킬 파일 3개에 connect-info/walletId 사용법이 문서화되고, 가이드 3개에서 마스터 패스워드 의존이 제거되며 세션 토큰 단독 설정으로 변경됨.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/core` 통과
2. `pnpm turbo run typecheck --filter=@waiaas/daemon` 통과
3. `pnpm turbo run test --filter=@waiaas/core -- --run -t "NotificationEventType"` 통과
4. 스킬 파일에 connect-info 관련 내용 존재
5. 가이드에서 에이전트 부분의 마스터 패스워드 제거 확인
6. notification.ts에 SESSION_WALLET_ADDED, SESSION_WALLET_REMOVED 존재
7. sessions.ts에 notify('SESSION_WALLET_ADDED', ...) 호출 존재
</verification>

<success_criteria>
- SESSION_WALLET_ADDED/SESSION_WALLET_REMOVED 이벤트가 core 패키지에 정의됨 (28개)
- en/ko i18n 메시지가 존재함
- sessions.ts에서 지갑 추가/제거 시 해당 이벤트로 notify 호출
- quickstart/wallet/admin 스킬 파일에 connect-info + walletId 문서화
- 3개 가이드에서 에이전트 부분의 마스터 패스워드 의존 제거
</success_criteria>

<output>
After completion, create `.planning/phases/213-integration-layer/213-04-SUMMARY.md`
</output>
