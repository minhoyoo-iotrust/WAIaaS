---
phase: 213-integration-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp/src/index.ts
  - packages/mcp/src/session-manager.ts
  - packages/mcp/src/server.ts
  - packages/mcp/src/api-client.ts
  - packages/mcp/src/tools/connect-info.ts
  - packages/mcp/src/tools/get-balance.ts
  - packages/mcp/src/tools/get-assets.ts
  - packages/mcp/src/tools/get-address.ts
  - packages/mcp/src/tools/send-token.ts
  - packages/mcp/src/tools/list-transactions.ts
  - packages/mcp/src/tools/get-transaction.ts
  - packages/mcp/src/tools/call-contract.ts
  - packages/mcp/src/tools/approve-token.ts
  - packages/mcp/src/tools/send-batch.ts
  - packages/mcp/src/tools/sign-transaction.ts
  - packages/mcp/src/tools/x402-fetch.ts
  - packages/mcp/src/tools/get-wallet-info.ts
  - packages/mcp/src/tools/set-default-network.ts
  - packages/mcp/src/tools/get-nonce.ts
  - packages/mcp/src/tools/encode-calldata.ts
  - packages/mcp/src/tools/wc-connect.ts
  - packages/mcp/src/tools/wc-status.ts
  - packages/mcp/src/tools/wc-disconnect.ts
autonomous: true
requirements: [INTG-02, INTG-03, INTG-04]

must_haves:
  truths:
    - "MCP connect_info 도구가 자기 발견 정보를 반환한다"
    - "MCP 기존 도구에 선택적 walletId 파라미터가 추가되어 특정 지갑을 지정할 수 있다"
    - "WAIAAS_WALLET_ID가 선택적이 되어 미지정 시 기본 지갑으로 동작한다"
    - "MCP가 단일 인스턴스로 동작하며 단일 토큰 파일을 사용한다"
    - "기존 MCP 도구가 walletId 미지정 시 기본 지갑으로 무변경 동작한다"
  artifacts:
    - path: "packages/mcp/src/tools/connect-info.ts"
      provides: "connect_info MCP tool"
      exports: ["registerConnectInfo"]
    - path: "packages/mcp/src/server.ts"
      provides: "Updated tool registrations with 19 tools"
      contains: "registerConnectInfo"
    - path: "packages/mcp/src/index.ts"
      provides: "Updated entrypoint with optional WAIAAS_WALLET_ID"
      contains: "WALLET_ID"
  key_links:
    - from: "packages/mcp/src/tools/connect-info.ts"
      to: "/v1/connect-info"
      via: "apiClient.get"
      pattern: "apiClient.get.*connect-info"
    - from: "packages/mcp/src/tools/get-balance.ts"
      to: "/v1/wallet/balance"
      via: "apiClient.get with optional walletId query param"
      pattern: "walletId|wallet_id"
---

<objective>
MCP를 단일 인스턴스 모델로 전환하고, connect-info 도구를 추가하며, 기존 18개 도구에 선택적 walletId 파라미터를 추가한다.

Purpose: AI 에이전트가 하나의 MCP 인스턴스로 여러 지갑에 접근하고, 자기 발견으로 상황을 파악할 수 있게 한다.
Output: connect-info 도구 1개 신규, 기존 18개 도구에 walletId 파라미터 추가, 단일 인스턴스 모델 전환
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/212-connect-info-endpoint/212-01-SUMMARY.md

@packages/mcp/src/index.ts
@packages/mcp/src/server.ts
@packages/mcp/src/api-client.ts
@packages/mcp/src/session-manager.ts
@packages/mcp/src/tools/get-balance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: connect-info 도구 + 기존 도구 walletId 파라미터 추가</name>
  <files>
    packages/mcp/src/tools/connect-info.ts
    packages/mcp/src/server.ts
    packages/mcp/src/api-client.ts
    packages/mcp/src/tools/get-balance.ts
    packages/mcp/src/tools/get-assets.ts
    packages/mcp/src/tools/get-address.ts
    packages/mcp/src/tools/send-token.ts
    packages/mcp/src/tools/list-transactions.ts
    packages/mcp/src/tools/get-transaction.ts
    packages/mcp/src/tools/call-contract.ts
    packages/mcp/src/tools/approve-token.ts
    packages/mcp/src/tools/send-batch.ts
    packages/mcp/src/tools/sign-transaction.ts
    packages/mcp/src/tools/x402-fetch.ts
    packages/mcp/src/tools/get-wallet-info.ts
    packages/mcp/src/tools/set-default-network.ts
    packages/mcp/src/tools/get-nonce.ts
    packages/mcp/src/tools/encode-calldata.ts
    packages/mcp/src/tools/wc-connect.ts
    packages/mcp/src/tools/wc-status.ts
    packages/mcp/src/tools/wc-disconnect.ts
  </files>
  <action>
**1. connect-info.ts 신규 생성:**

```typescript
import { z } from 'zod';
import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { type ApiClient, toToolResult } from '../api-client.js';

export function registerConnectInfo(server: McpServer, apiClient: ApiClient): void {
  server.tool(
    'connect_info',
    'Get self-discovery info: accessible wallets, policies, capabilities, and AI-ready prompt. Call this first to understand your environment.',
    {},
    async () => {
      const result = await apiClient.get('/v1/connect-info');
      return toToolResult(result);
    },
  );
}
```

connect-info 도구는 walletContext 파라미터가 불필요 (멀티 지갑이므로 단일 지갑 접두사 의미 없음). 파라미터 없이 세션 토큰만으로 조회.

**2. 기존 18개 도구에 선택적 `wallet_id` 파라미터 추가:**

다음 도구들의 스키마에 `wallet_id: z.string().optional().describe('Target wallet ID. Omit to use the default wallet.')` 추가:

GET 요청 도구 (쿼리 파라미터로 전달):
- get-balance.ts: `params.set('walletId', args.wallet_id)` 추가
- get-assets.ts: 동일 패턴
- get-address.ts: 동일 패턴
- list-transactions.ts: 동일 패턴
- get-transaction.ts: 동일 패턴 (path 뒤에 ?walletId= 추가)
- get-nonce.ts: 동일 패턴
- get-wallet-info.ts: 동일 패턴 (address 조회 시 ?walletId= 추가)
- wc-status.ts: 동일 패턴
- set-default-network.ts: body에 walletId 추가 (PUT 요청)

POST 요청 도구 (body에 walletId 추가):
- send-token.ts: body에 `walletId: args.wallet_id` 추가
- call-contract.ts: 동일 패턴
- approve-token.ts: 동일 패턴
- send-batch.ts: 동일 패턴
- sign-transaction.ts: 동일 패턴
- x402-fetch.ts: 동일 패턴
- encode-calldata.ts: 동일 패턴
- wc-connect.ts: body에 walletId 추가 (POST 요청)
- wc-disconnect.ts: path에 ?walletId= 추가 (DELETE 요청)

**패턴 예시 (get-balance.ts 수정):**
```typescript
export function registerGetBalance(server: McpServer, apiClient: ApiClient, walletContext?: WalletContext): void {
  server.tool(
    'get_balance',
    withWalletPrefix('Get the current balance of the wallet.', walletContext?.walletName),
    {
      network: z.string().optional().describe("Query balance for specific network..."),
      display_currency: z.string().optional().describe('Display currency...'),
      wallet_id: z.string().optional().describe('Target wallet ID. Omit to use the default wallet.'),
    },
    async (args) => {
      const params = new URLSearchParams();
      if (args.network) params.set('network', args.network);
      if (args.display_currency) params.set('display_currency', args.display_currency);
      if (args.wallet_id) params.set('walletId', args.wallet_id);
      const qs = params.toString();
      const result = await apiClient.get('/v1/wallet/balance' + (qs ? '?' + qs : ''));
      return toToolResult(result);
    },
  );
}
```

**패턴 예시 (send-token.ts 수정):**
POST body에 `walletId` 필드를 조건부 추가:
```typescript
const body: Record<string, unknown> = { to: args.to, amount: args.amount, ... };
if (args.wallet_id) body.walletId = args.wallet_id;
```

**3. server.ts 수정:**
- `import { registerConnectInfo } from './tools/connect-info.js';` 추가
- `registerConnectInfo(server, apiClient);` 호출 추가 (walletContext 불필요)
- 주석 업데이트: "Register 19 tools"

**주의사항:**
- 도구 파라미터명은 `wallet_id` (snake_case) -- MCP 도구 파라미터 컨벤션
- API 쿼리/바디에는 `walletId` (camelCase) -- REST API 컨벤션
- 미지정 시 서버 측에서 기본 지갑 자동 선택 (클라이언트 처리 불필요)
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/mcp` 성공
  </verify>
  <done>
    connect_info 도구가 등록되고, 기존 18개 도구에 wallet_id 선택적 파라미터가 추가되며, typecheck 통과.
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP 단일 인스턴스 모델 전환 -- WAIAAS_WALLET_ID 선택적</name>
  <files>
    packages/mcp/src/index.ts
    packages/mcp/src/session-manager.ts
  </files>
  <action>
**index.ts 변경:**

1. `WALLET_ID` 환경변수 사용 부분 수정:
   - 기존: `const WALLET_ID = process.env['WAIAAS_WALLET_ID'];` (이미 선택적)
   - 변경 불필요 -- 이미 optional

2. 로그 메시지 개선:
   - WALLET_ID 없을 때: `console.error('[waiaas-mcp] Multi-wallet mode (no WAIAAS_WALLET_ID set)');`
   - WALLET_ID 있을 때: 기존 로그 유지

3. WalletContext에 walletName 미설정 시에도 서버가 정상 동작하는지 확인 (이미 optional).

**session-manager.ts 변경:**

현재 SessionManager.resolveTokenPath()는:
- walletId 있으면: `DATA_DIR/mcp-tokens/<walletId>`
- walletId 없으면: `DATA_DIR/mcp-token`

이 로직은 이미 올바른 형태. **변경 불필요.**

다만, fallback 로직 개선:
- 현재: walletId 설정 시 `mcp-tokens/<walletId>` 먼저, ENOENT면 `mcp-token`으로 fallback
- 추가: walletId 미설정 시에도 `mcp-token` 경로 사용 (이미 현재 동작)

**실제 코드 변경은 최소:**
- index.ts의 로그 메시지 1줄 추가 (WALLET_ID 미설정 시 안내)
- session-manager.ts는 변경 없음 (이미 올바른 fallback 로직)

**핵심:** MCP 단일 인스턴스 전환은 주로 CLI quickset (Plan 03)에서 단일 세션+단일 토큰 파일을 생성하는 것으로 완성된다. MCP 자체는 이미 WAIAAS_WALLET_ID 없이 동작 가능한 구조.
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/mcp && pnpm turbo run lint --filter=@waiaas/mcp` 성공
  </verify>
  <done>
    WAIAAS_WALLET_ID가 선택적으로 동작하고, 미설정 시 로그가 멀티 지갑 모드를 안내하며, typecheck + lint 통과.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/mcp` 통과
2. `pnpm turbo run lint --filter=@waiaas/mcp` 통과
3. 기존 MCP 테스트 통과: `pnpm turbo run test --filter=@waiaas/mcp`
4. connect-info.ts 파일 존재 확인
5. 각 도구 파일에 wallet_id 파라미터가 스키마에 포함됨
</verification>

<success_criteria>
- connect_info MCP 도구가 /v1/connect-info를 호출하여 자기 발견 정보를 반환
- 기존 18개 MCP 도구에 wallet_id 선택적 파라미터 추가 (GET: 쿼리, POST: body)
- WAIAAS_WALLET_ID 미설정 시 멀티 지갑 모드 로그 출력
- 단일 토큰 파일(mcp-token)로 단일 인스턴스 동작
</success_criteria>

<output>
After completion, create `.planning/phases/213-integration-layer/213-02-SUMMARY.md`
</output>
