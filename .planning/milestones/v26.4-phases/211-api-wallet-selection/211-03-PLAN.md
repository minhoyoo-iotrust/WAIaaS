---
phase: 211-api-wallet-selection
plan: 03
type: execute
wave: 2
depends_on: ["211-01"]
files_modified:
  - packages/daemon/src/api/routes/sessions.ts
  - packages/daemon/src/api/routes/openapi-schemas.ts
  - packages/daemon/src/__tests__/session-response-compat.test.ts
autonomous: true
requirements: [API-05, API-06]

must_haves:
  truths:
    - "세션 목록 응답에 wallets 배열이 포함되면서 하위 호환 walletId/walletName 필드도 유지된다"
    - "세션 상세 응답에 wallets 배열이 포함되면서 하위 호환 walletId/walletName 필드도 유지된다"
    - "세션 갱신(renew) 시 현재 기본 지갑(session_wallets is_default=true) 기준으로 JWT가 발급된다"
    - "기존 API 클라이언트가 walletId/walletName 필드를 사용해도 정상 동작한다"
  artifacts:
    - path: "packages/daemon/src/api/routes/sessions.ts"
      provides: "세션 목록/갱신 라우트 (wallets 배열 + backward compat)"
    - path: "packages/daemon/src/api/routes/openapi-schemas.ts"
      provides: "SessionListItemSchema에 wallets 배열 포함"
    - path: "packages/daemon/src/__tests__/session-response-compat.test.ts"
      provides: "세션 응답 하위 호환 테스트"
  key_links:
    - from: "packages/daemon/src/api/routes/sessions.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "session_wallets JOIN wallets"
      pattern: "sessionWallets.*wallets"
    - from: "packages/daemon/src/api/routes/sessions.ts"
      to: "packages/daemon/src/infrastructure/jwt/index.ts"
      via: "JWT wlt 클레임에 기본 지갑 설정"
      pattern: "wlt.*defaultWallet"
---

<objective>
세션 목록/상세 응답에 wallets 배열을 포함하면서 하위 호환 walletId/walletName 필드를 유지하고, 세션 갱신 시 session_wallets의 기본 지갑 기준으로 JWT를 발급하는 것이 이미 Phase 210에서 완료되었는지 확인하고, 하위 호환 테스트를 추가한다.

Purpose: Phase 210-02에서 세션 목록에 wallets 배열과 walletId/walletName을 이미 추가했고, 세션 갱신도 session_wallets 기반으로 변경되었다. 이 Plan에서는 OpenAPI 스키마 정합성과 하위 호환 테스트를 보강한다.
Output: OpenAPI 스키마 업데이트, 하위 호환 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/210-session-model-restructure/210-02-SUMMARY.md
@.planning/phases/211-api-wallet-selection/211-01-SUMMARY.md
@packages/daemon/src/api/routes/sessions.ts
@packages/daemon/src/api/routes/openapi-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SessionListItemSchema에 wallets 배열 + walletId/walletName 하위 호환 필드 검증 및 OpenAPI 스키마 정합</name>
  <files>
    packages/daemon/src/api/routes/openapi-schemas.ts
    packages/daemon/src/api/routes/sessions.ts
  </files>
  <action>
Phase 210-02에서 세션 목록(GET /sessions) 응답에 이미 wallets 배열과 walletId/walletName 필드를 추가했다. 이 task에서는:

1. **openapi-schemas.ts 확인 및 보강**:
   - `SessionListItemSchema`에 wallets 배열 필드가 있는지 확인. 없으면 추가:
     ```typescript
     wallets: z.array(z.object({
       id: z.string().uuid(),
       name: z.string(),
       isDefault: z.boolean(),
     })).optional(), // optional for backward compat with clients not expecting it
     ```
   - `SessionCreateResponseSchema`에 wallets 배열 필드가 있는지 확인. 있으면 OK.
   - walletId, walletName 필드가 SessionListItemSchema에 있는지 확인. 210-02에서 이미 추가한 walletId/walletName 필드 유지.

2. **sessions.ts의 세션 갱신(renew) 응답에 walletId 추가 검증**:
   - PUT /sessions/:id/renew 응답에 현재 `{ id, token, expiresAt, renewalCount }`를 반환한다.
   - 하위 호환을 위해 `walletId: defaultWallet!.walletId` 추가가 필요한지 검토.
   - 설계 결정: renew 응답은 토큰 갱신 정보만 반환하므로 walletId 추가 불필요. JWT 내부의 wlt 클레임이 기본 지갑을 반영하므로 클라이언트는 JWT 디코드로 확인 가능.
   - **renew가 session_wallets의 is_default=true 지갑을 JWT wlt 클레임에 설정하는지 확인**. 210-02에서 이미 구현됨 (sessions.ts:543-552). 확인만 하고 변경 불필요하면 넘어감.

3. **세션 생성(POST /sessions) 응답의 wallets 배열 검증**:
   - 210-02에서 이미 wallets 배열을 응답에 포함시킴 (sessions.ts:349). 확인.

4. **필요하면 OpenAPI 스키마와 실제 응답 간 불일치 수정**:
   - SessionListItemSchema에 wallets, walletId, walletName이 있는지 확인하고, 실제 list 핸들러 응답과 일치시킴.
   - SessionCreateResponseSchema에 wallets가 있는지 확인하고, create 핸들러 응답과 일치시킴.
   - SessionRenewResponseSchema에 walletId가 없는 것이 의도적인지 확인.
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/daemon` -- 타입체크 통과
  </verify>
  <done>
    OpenAPI 스키마(SessionListItemSchema, SessionCreateResponseSchema)와 실제 핸들러 응답이 일치하며, wallets 배열 + walletId/walletName 하위 호환 필드가 모두 포함된다. 세션 갱신이 session_wallets 기반으로 JWT를 발급한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 세션 응답 하위 호환 + 세션 갱신 기본 지갑 테스트</name>
  <files>
    packages/daemon/src/__tests__/session-response-compat.test.ts
  </files>
  <action>
`packages/daemon/src/__tests__/session-response-compat.test.ts` 신규 생성.

테스트 환경:
- pushSchema()로 in-memory DB, 2개 지갑(walletA, walletB) 생성
- 전체 앱 생성 (createApp 또는 직접 라우터 생성)
- 마스터 패스워드 인증 헤더 포함

테스트 케이스:

1. **세션 생성 응답에 wallets 배열 + walletId 포함**:
   - POST /v1/sessions { walletIds: [walletA, walletB] }
   - 응답에 `wallets` 배열 (2개 요소, walletA.isDefault=true), `walletId` (walletA.id) 확인

2. **세션 목록 응답에 wallets 배열 + walletId/walletName 포함**:
   - GET /v1/sessions
   - 응답 항목에 `wallets`, `walletId`, `walletName` 필드 존재 확인
   - walletId가 기본 지갑(walletA)의 ID인지 확인

3. **세션 갱신 시 기본 지갑으로 JWT 발급**:
   - 세션 생성 → 기본 지갑을 walletB로 변경 (PATCH) → PUT /sessions/:id/renew
   - 새 JWT의 wlt 클레임이 walletB인지 확인 (JWT 디코드)
   - 갱신을 위해 50% TTL 경과 시뮬레이션 필요 (짧은 TTL 사용)

4. **하위 호환: walletId만 사용하는 클라이언트가 정상 동작**:
   - 세션 목록 응답에서 walletId 필드가 string UUID 형식인지 확인
   - walletName 필드가 string | null 형식인지 확인
   - wallets 필드가 없어도 walletId로 기본 지갑 식별 가능한지 확인

5. **세션 생성 후 GET /sessions 응답에 동일 wallets 배열**:
   - 생성 시 반환된 wallets와 목록 응답의 wallets가 동일한 지갑 구성인지 확인

기존 테스트 패턴 참고: `packages/daemon/src/__tests__/session-lifecycle-e2e.test.ts`
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/session-response-compat.test.ts --reporter=verbose` -- 전체 통과
  </verify>
  <done>
    5+ 테스트가 세션 응답의 wallets 배열 포함, walletId/walletName 하위 호환, 세션 갱신 시 기본 지갑 JWT 발급을 검증한다.
  </done>
</task>

</tasks>

<verification>
- GET /sessions 응답에 wallets 배열 + walletId/walletName 포함
- POST /sessions 응답에 wallets 배열 포함
- PUT /sessions/:id/renew가 session_wallets 기본 지갑으로 JWT 발급
- 기존 클라이언트가 walletId 필드로 정상 동작
- OpenAPI 스키마와 실제 응답 일치
</verification>

<success_criteria>
- SessionListItemSchema에 wallets + walletId + walletName 필드 포함
- SessionCreateResponseSchema에 wallets 필드 포함
- 세션 갱신이 session_wallets is_default=true 기반으로 JWT 발급
- 5+ 하위 호환 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/211-api-wallet-selection/211-03-SUMMARY.md`
</output>
