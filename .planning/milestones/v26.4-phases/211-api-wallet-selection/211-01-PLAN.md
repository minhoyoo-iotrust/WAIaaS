---
phase: 211-api-wallet-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/daemon/src/api/helpers/resolve-wallet-id.ts
  - packages/daemon/src/api/middleware/session-auth.ts
  - packages/daemon/src/api/middleware/owner-auth.ts
  - packages/daemon/src/__tests__/resolve-wallet-id.test.ts
  - packages/daemon/src/__tests__/session-auth.test.ts
autonomous: true
requirements: [API-01, API-04]

must_haves:
  truths:
    - "resolveWalletId 헬퍼가 body walletId > query walletId > defaultWalletId 우선순위로 지갑을 결정한다"
    - "세션에 연결되지 않은 지갑 접근 시 WALLET_ACCESS_DENIED 에러가 반환된다"
    - "session-auth 미들웨어가 defaultWalletId만 설정하고 walletId는 설정하지 않는다"
    - "owner-auth 미들웨어가 defaultWalletId를 사용하고 명시적 walletId 파라미터를 우선한다"
  artifacts:
    - path: "packages/daemon/src/api/helpers/resolve-wallet-id.ts"
      provides: "resolveWalletId 헬퍼 함수"
      exports: ["resolveWalletId"]
    - path: "packages/daemon/src/api/middleware/session-auth.ts"
      provides: "session-auth 미들웨어 (defaultWalletId only)"
    - path: "packages/daemon/src/api/middleware/owner-auth.ts"
      provides: "owner-auth 미들웨어 (defaultWalletId 기반)"
    - path: "packages/daemon/src/__tests__/resolve-wallet-id.test.ts"
      provides: "resolveWalletId 헬퍼 단위 테스트"
  key_links:
    - from: "packages/daemon/src/api/helpers/resolve-wallet-id.ts"
      to: "packages/daemon/src/infrastructure/database/schema.ts"
      via: "sessionWallets 테이블 조회"
      pattern: "sessionWallets"
    - from: "packages/daemon/src/api/middleware/session-auth.ts"
      to: "packages/daemon/src/api/helpers/resolve-wallet-id.ts"
      via: "defaultWalletId context 설정 (resolve-wallet-id가 이를 읽음)"
      pattern: "defaultWalletId"
---

<objective>
resolveWalletId 헬퍼 함수를 생성하고 session-auth/owner-auth 미들웨어를 변경하여 Phase 211의 기반을 구축한다.

Purpose: 모든 엔드포인트가 walletId 선택적 파라미터를 사용할 수 있도록 공통 헬퍼를 제공하고, 미들웨어에서 backward compat용 walletId 설정을 제거한다.
Output: resolveWalletId 헬퍼, 변경된 미들웨어, 테스트
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/210-session-model-restructure/210-02-SUMMARY.md
@packages/daemon/src/api/middleware/session-auth.ts
@packages/daemon/src/api/middleware/owner-auth.ts
@packages/daemon/src/infrastructure/database/schema.ts
@packages/core/src/errors/error-codes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: resolveWalletId 헬퍼 함수 생성 + session-auth/owner-auth 미들웨어 변경</name>
  <files>
    packages/daemon/src/api/helpers/resolve-wallet-id.ts
    packages/daemon/src/api/middleware/session-auth.ts
    packages/daemon/src/api/middleware/owner-auth.ts
  </files>
  <action>
1. `packages/daemon/src/api/helpers/resolve-wallet-id.ts` 생성:
   - `resolveWalletId(c: Context, db: BetterSQLite3Database, bodyWalletId?: string): string` 함수 export
   - 우선순위: (1) bodyWalletId 인자 (POST/PUT body에서 호출자가 전달) → (2) c.req.query('walletId') (GET/DELETE 쿼리 파라미터) → (3) c.get('defaultWalletId') (session-auth가 설정한 기본 지갑)
   - 결정된 walletId로 session_wallets 테이블 조회: sessionId + walletId 조합이 존재하는지 확인
   - 존재하지 않으면 `throw new WAIaaSError('WALLET_ACCESS_DENIED')` (이미 정의된 에러 코드 사용)
   - sessionId는 `c.get('sessionId')` 로 가져옴
   - Hono Context 타입: `import type { Context } from 'hono'` 사용, `c.get('sessionId' as never)` 및 `c.get('defaultWalletId' as never)` 패턴 사용 (기존 코드 패턴 따름)
   - import: `{ eq, and } from 'drizzle-orm'`, `{ sessionWallets } from '../../infrastructure/database/schema.js'`, `{ WAIaaSError } from '@waiaas/core'`

2. `packages/daemon/src/api/middleware/session-auth.ts` 변경:
   - 71행 `c.set('walletId', payload.wlt);` 라인을 **삭제** (backward compat 제거)
   - `c.set('defaultWalletId', payload.wlt);` 만 남김
   - JSDoc 주석에서 "v26.4: Dual context setting" 관련 주석을 "v26.4: defaultWalletId만 설정. walletId는 resolveWalletId()로 결정." 으로 변경

3. `packages/daemon/src/api/middleware/owner-auth.ts` 변경:
   - 71행 `const walletId = (c.get('walletId' as never) as string | undefined) || c.req.param('id');` 를
     `const walletId = (c.get('defaultWalletId' as never) as string | undefined) || c.req.param('id');` 로 변경
   - 주석 업데이트: "Prefer defaultWalletId from sessionAuth context"
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/daemon` -- 타입체크 통과 확인 (walletId 참조가 많아 에러 다수 발생 예상 -- Plan 02에서 수정할 것이므로 여기서는 resolve-wallet-id.ts 자체의 타입 정합만 확인. 다른 파일 에러는 expected.)
  </verify>
  <done>
    resolveWalletId 헬퍼가 3단계 우선순위로 walletId를 결정하고, session_wallets 조회로 접근 검증을 수행한다. session-auth가 defaultWalletId만 설정한다. owner-auth가 defaultWalletId를 사용한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: resolveWalletId 헬퍼 단위 테스트 + session-auth 테스트 업데이트</name>
  <files>
    packages/daemon/src/__tests__/resolve-wallet-id.test.ts
    packages/daemon/src/__tests__/session-auth.test.ts
  </files>
  <action>
1. `packages/daemon/src/__tests__/resolve-wallet-id.test.ts` 신규 생성:
   - 테스트 환경: pushSchema()로 in-memory DB 생성, 지갑 + 세션 + session_wallets 행 삽입
   - 테스트 케이스:
     a. body walletId가 있으면 이를 사용 (우선순위 1)
     b. query walletId가 있으면 이를 사용 (우선순위 2)
     c. 둘 다 없으면 defaultWalletId 사용 (우선순위 3)
     d. body + query 동시 존재 시 body 우선
     e. 세션에 연결되지 않은 walletId → WALLET_ACCESS_DENIED
     f. defaultWalletId가 세션에 연결되어 있으면 정상 반환
   - Hono Context 모킹: `new Hono()` app에서 미들웨어로 sessionId/defaultWalletId를 설정한 뒤 라우트 핸들러에서 resolveWalletId 호출하여 결과 확인
   - 기존 테스트 패턴 참고: `packages/daemon/src/__tests__/session-auth.test.ts` (pushSchema, in-memory DB)

2. `packages/daemon/src/__tests__/session-auth.test.ts` 변경:
   - 50행 `const walletId = c.get('walletId' as never) as string | undefined;` 제거
   - defaultWalletId 검증만 남김 (walletId가 더 이상 설정되지 않으므로)
   - "dual context" 테스트를 "defaultWalletId only" 테스트로 변경
  </action>
  <verify>
    `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run packages/daemon/src/__tests__/resolve-wallet-id.test.ts packages/daemon/src/__tests__/session-auth.test.ts --reporter=verbose` -- 전체 통과
  </verify>
  <done>
    resolveWalletId 헬퍼의 우선순위 로직과 접근 검증이 6개 이상의 테스트 케이스로 검증된다. session-auth 테스트가 defaultWalletId만 확인한다.
  </done>
</task>

</tasks>

<verification>
- resolveWalletId가 body > query > default 우선순위로 동작
- 미연결 지갑 접근 시 WALLET_ACCESS_DENIED
- session-auth가 walletId를 더 이상 설정하지 않음
- owner-auth가 defaultWalletId를 사용
- 테스트 전체 통과
</verification>

<success_criteria>
- resolveWalletId 헬퍼가 생성되어 3단계 우선순위 + session_wallets 접근 검증을 수행
- session-auth 미들웨어가 defaultWalletId만 설정 (walletId 제거)
- owner-auth 미들웨어가 defaultWalletId를 사용
- 6+ 테스트 케이스 통과
</success_criteria>

<output>
After completion, create `.planning/phases/211-api-wallet-selection/211-01-SUMMARY.md`
</output>
