---
phase: 190-verify-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [".github/workflows/release.yml"]
autonomous: false
requirements: [VERIFY-01, VERIFY-02, VERIFY-03, VERIFY-04]

must_haves:
  truths:
    - "Deploy summary includes provenance section with source repository, commit SHA, workflow run link, and Sigstore reference"
    - "8 packages published successfully via OIDC authentication (confirmed via release workflow logs)"
    - "npmjs.com package pages display provenance badge ('Built and signed on GitHub Actions')"
    - "NPM_TOKEN secret is deleted from GitHub repository secrets"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Enhanced deploy summary with provenance metadata"
      contains: "### Provenance"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "GitHub Actions step summary"
      via: "GITHUB_STEP_SUMMARY with provenance metadata"
      pattern: "Sigstore"
---

<objective>
Deploy summary에 provenance 메타데이터를 추가하고, 실제 릴리스로 OIDC 발행을 E2E 검증한 뒤, 레거시 NPM_TOKEN 시크릿을 완전 제거하여 v2.4 npm Trusted Publishing 전환을 마무리한다.

Purpose: supply chain 보안 강화의 최종 단계 -- 코드 변경(deploy summary), 운영 검증(E2E release), 시크릿 정리(NPM_TOKEN 제거)를 순차적으로 완료
Output: provenance-enriched deploy summary가 반영된 release.yml, OIDC 발행 성공 확인, NPM_TOKEN 제거 완료
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/190-verify-cleanup/190-RESEARCH.md
@.planning/phases/189-oidc-conversion/189-02-SUMMARY.md
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance deploy summary with provenance metadata (VERIFY-04)</name>
  <files>.github/workflows/release.yml</files>
  <action>
Modify the "Deploy summary" step in `release.yml` (currently at lines 276-283) to add a "### Provenance" subsection after the existing summary items.

**Current state (lines 276-283):**
```yaml
- name: Deploy summary
  run: |
    echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    echo "- **Version:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
    echo "- **npm:** 8 packages published with OIDC provenance" >> $GITHUB_STEP_SUMMARY
    echo "- **Docker (GHCR):** ghcr.io/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
    echo "- **Docker (Hub):** waiaas/daemon" >> $GITHUB_STEP_SUMMARY
```

**Target state -- append these lines after the Docker Hub line:**
```yaml
    echo "" >> $GITHUB_STEP_SUMMARY
    echo "### Provenance" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    echo "- **Source:** [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
    echo "- **Commit:** [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
    echo "- **Workflow:** [release.yml#deploy](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
    echo "- **Sigstore:** Attestations logged in [Rekor transparency log](https://search.sigstore.dev/)" >> $GITHUB_STEP_SUMMARY
```

**Notes:**
- Use `${{ github.server_url }}`, `${{ github.repository }}`, `${{ github.sha }}`, `${{ github.run_id }}` GitHub Actions context variables for dynamic URLs
- Use `${GITHUB_SHA::7}` (shell substring) for short commit SHA display -- this works because `${{ }}` is evaluated by GHA before the shell, while `${GITHUB_SHA::7}` is evaluated by the shell at runtime
- Both approaches are consistent with existing patterns in the workflow
- Do NOT change any other part of the deploy summary or any other step
  </action>
  <verify>
1. Read the modified release.yml and confirm the Deploy summary step contains the "### Provenance" subsection
2. Verify the 4 provenance lines are present: Source, Commit, Workflow, Sigstore
3. Verify no YAML syntax issues: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"`
4. Verify no other steps were modified (only the Deploy summary step changed)
  </verify>
  <done>Deploy summary step in release.yml contains a "### Provenance" subsection with dynamic links for source repository, commit SHA (short display + full link), workflow run, and Sigstore transparency log. YAML is valid. No other steps modified.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Trigger release and verify OIDC publish + provenance badges (VERIFY-01, VERIFY-02)</name>
  <files>N/A (human-action checkpoint -- no files modified by Claude)</files>
  <action>
Phase 188-190 converted npm publish from NPM_TOKEN to OIDC Trusted Publishing with --provenance signing. Task 1 added provenance metadata to the deploy summary. The release pipeline is ready for E2E verification.

**Human performs the following steps:**

**Step A: Commit and merge to main**
1. Commit the deploy summary enhancement from Task 1 (already done by executor)
2. Merge `milestone/v2.4` branch to `main` via PR
3. Wait for release-please to create a Release PR (may take 1-2 minutes)

**Step B: Trigger the release**
4. Review and merge the release-please Release PR (Gate 1)
5. Wait for `release.yml` to trigger on the `release: published` event
6. Approve the deploy job when prompted (Gate 2: environment: production)

**Step C: Verify OIDC publish success (VERIFY-01)**
7. Monitor the deploy job logs in GitHub Actions
8. Confirm all 8 packages published successfully (no 404 or OIDC errors)
9. Check that `npm publish --provenance` output shows "Provenance statement published to transparency log" for each package

**Step D: Verify provenance badges (VERIFY-02)**
10. Visit https://www.npmjs.com/package/@waiaas/core and check for:
    - Green checkmark badge next to the version number
    - "Built and signed on GitHub Actions" text
    - Provenance section at bottom with Source Commit, Build Summary, Build File links
11. Spot-check 2-3 more packages (e.g., @waiaas/sdk, @waiaas/cli) for the same badges

**Step E: Verify deploy summary**
12. In the completed deploy job, click "Deploy summary" and confirm the Provenance section appears with correct Source, Commit, Workflow, and Sigstore links

**Optional CLI verification:**
```bash
npm audit signatures
npm view @waiaas/core --json | jq '.dist.attestations.url'
```
  </action>
  <verify>Human confirms: (1) all 8 packages published successfully in deploy job logs, (2) provenance badges visible on npmjs.com package pages, (3) deploy summary shows Provenance section</verify>
  <done>All 8 packages published via OIDC authentication with provenance signing. npmjs.com shows "Built and signed on GitHub Actions" badge. Deploy summary displays provenance metadata.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Delete NPM_TOKEN secret from GitHub (VERIFY-03)</name>
  <files>N/A (human-action checkpoint -- GitHub Secrets management, no code files)</files>
  <action>
OIDC publish has been verified via an actual release (Task 2). NPM_TOKEN is no longer referenced by any workflow and can be safely deleted. This is the final cleanup step of the v2.4 Trusted Publishing migration.

**Human performs the following steps:**

**Delete the secret (choose one):**

Option A (CLI):
```bash
gh secret delete NPM_TOKEN
```

Option B (Web UI):
1. Go to GitHub repository Settings > Secrets and variables > Actions
2. Find NPM_TOKEN and click Delete

**Verify deletion:**
```bash
gh secret list
# Expected: NPM_TOKEN is NOT in the list
# Expected remaining secrets: DOCKERHUB_TOKEN, DOCKERHUB_USERNAME, RELEASE_PAT
```

**Why this is safe:**
- Phase 189 removed all NPM_TOKEN references from release.yml
- OIDC publish success was just confirmed in Task 2
- If needed in the future, a new npm token can be generated
  </action>
  <verify>Run `gh secret list` and confirm NPM_TOKEN is NOT in the output. Expected remaining secrets: DOCKERHUB_TOKEN, DOCKERHUB_USERNAME, RELEASE_PAT.</verify>
  <done>NPM_TOKEN secret deleted from GitHub repository secrets. Only DOCKERHUB_TOKEN, DOCKERHUB_USERNAME, and RELEASE_PAT remain. v2.4 Trusted Publishing migration is complete.</done>
</task>

</tasks>

<verification>
1. release.yml Deploy summary step contains "### Provenance" subsection with Source, Commit, Workflow, Sigstore links
2. YAML validation passes for release.yml
3. E2E release published 8 packages via OIDC authentication (no NPM_TOKEN used)
4. npmjs.com package pages show provenance badges ("Built and signed on GitHub Actions")
5. Deploy summary in GitHub Actions shows provenance metadata with correct links
6. NPM_TOKEN secret deleted from GitHub repository secrets
7. `gh secret list` shows only DOCKERHUB_TOKEN, DOCKERHUB_USERNAME, RELEASE_PAT
</verification>

<success_criteria>
- Deploy summary in release.yml includes provenance section with dynamic links (VERIFY-04)
- 8 npm packages published successfully via OIDC + provenance (VERIFY-01)
- Provenance badges visible on npmjs.com package pages (VERIFY-02)
- NPM_TOKEN removed from GitHub Secrets (VERIFY-03)
- v2.4 npm Trusted Publishing migration is complete
</success_criteria>

<output>
After completion, create `.planning/phases/190-verify-cleanup/190-01-SUMMARY.md`
</output>
