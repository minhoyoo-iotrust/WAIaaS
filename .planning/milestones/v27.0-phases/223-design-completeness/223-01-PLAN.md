---
phase: 223-design-completeness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/design/76-incoming-transaction-monitoring.md
autonomous: true
requirements:
  - EVT-02
  - EVT-05
gap_closure: true

must_haves:
  truths:
    - "INCOMING_TX_SUSPICIOUS 이벤트가 NtfyChannel에서 priority 4(high)로 발송되는 메커니즘이 §6.4에 명세됨"
    - "WalletNotificationChannel에서 INCOMING_TX_SUSPICIOUS eventType이 높은 priority로 처리되는 분기가 §6.4에 명세됨"
    - "SafetyRuleContext에 decimals: number 필드가 §6.5에 추가됨"
    - "getDecimals() 헬퍼 함수가 chain + tokenAddress 기반으로 decimals를 결정하는 로직과 함께 정의됨"
    - "DustAttackRule/LargeAmountRule의 getDecimals(tx) 호출이 ctx.decimals로 교체됨"
  artifacts:
    - path: "docs/design/76-incoming-transaction-monitoring.md"
      provides: "NOTIFY-1 + getDecimals 보완된 설계 문서"
      contains: "mapPriority.*SUSPICIOUS"
  key_links:
    - from: "§6.4 NtfyChannel.mapPriority()"
      to: "§6.3 INCOMING_TX_SUSPICIOUS 알림 우선순위"
      via: "eventType.includes('SUSPICIOUS') 패턴 매칭"
      pattern: "SUSPICIOUS.*priority.*4"
    - from: "§6.5 SafetyRuleContext.decimals"
      to: "§6.6 DustAttackRule/LargeAmountRule"
      via: "ctx.decimals 참조"
      pattern: "ctx\\.decimals"
---

<objective>
INCOMING_TX_SUSPICIOUS 이벤트의 priority:high 라우팅 메커니즘을 채널별로 명세하고, DustAttackRule/LargeAmountRule에서 사용하는 getDecimals() 헬퍼를 SafetyRuleContext 확장과 함께 정의한다.

Purpose: Phase 222에서 Critical/High 갭이 해결된 후, Medium 등급 설계 미비 2건(NOTIFY-1, getDecimals)을 보완하여 구현 시 모호함 제거.
Output: doc 76의 §6.3-§6.6이 보완된 설계 문서.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/223-design-completeness/223-RESEARCH.md
@docs/design/76-incoming-transaction-monitoring.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SUSPICIOUS priority 라우팅 메커니즘 명세 (§6.3-§6.4)</name>
  <files>docs/design/76-incoming-transaction-monitoring.md</files>
  <action>
§6.3 (알림 우선순위 설명) 수정:
- 현재 "알림 우선순위: `high` (즉시 알림)" 코멘트를 구체적 메커니즘 설명으로 교체
- "채널 구현 내부에서 eventType/category 기반으로 priority를 결정하는 기존 패턴을 따른다" 원칙 명시
- NotificationService.notify() 시그니처는 변경하지 않음 (priority 파라미터 추가 불필요)을 명시

§6.4 (채널별 연동 명세) 수정:
1. NtfyChannel.mapPriority() 확장 명세 추가:
   ```typescript
   private mapPriority(eventType: string): number {
     if (eventType.includes('KILL_SWITCH') || eventType.includes('AUTO_STOP')) return 5;
     if (eventType.includes('SUSPICIOUS') || eventType.includes('SUSPENDED')
       || eventType.includes('FAILED') || eventType.includes('VIOLATION')) return 4;
     if (eventType.includes('APPROVAL') || eventType.includes('EXPIR')) return 3;
     if (eventType.includes('INCOMING_TX_DETECTED')) return 3;
     return 2;
   }
   ```
   - SUSPICIOUS 패턴 매칭이 priority 4 (high)로 반환됨을 명시

2. WalletNotificationChannel priority 분기 확장 명세 추가:
   ```typescript
   const isHighPriority = category === 'security_alert'
     || eventType === 'INCOMING_TX_SUSPICIOUS';
   const priority = isHighPriority ? 5 : 3;
   ```
   - INCOMING_TX_SUSPICIOUS가 카테고리('incoming')와 무관하게 개별 eventType 특별 처리됨을 명시

3. NOTIFICATION_CATEGORIES incoming 카테고리의 "SUSPICIOUS는 개별 high" 코멘트를 위의 구체적 메커니즘 참조로 교체

**중요:** NotificationPayload 인터페이스나 INotificationChannel.send() 시그니처는 변경하지 않는다. 기존 패턴(채널 구현 내부 priority 결정)을 유지한다.
  </action>
  <verify>
doc 76에서 다음을 grep으로 확인:
- "mapPriority" 키워드가 §6.4에 존재
- "SUSPICIOUS" 키워드가 mapPriority 코드 블록 내에 존재
- "isHighPriority" 또는 유사 패턴이 WalletNotificationChannel 명세에 존재
- NotificationPayload 변경이 없음 (§6.4에서 NotificationPayload 수정 언급 0건)
  </verify>
  <done>
INCOMING_TX_SUSPICIOUS 이벤트가 NtfyChannel에서 priority 4, WalletNotificationChannel에서 high priority로 라우팅되는 메커니즘이 §6.3-§6.4에 코드 블록과 함께 명세됨. NotificationService 인터페이스 변경 없음.
  </done>
</task>

<task type="auto">
  <name>Task 2: getDecimals() 헬퍼 + SafetyRuleContext decimals 필드 명세 (§6.5-§6.6)</name>
  <files>docs/design/76-incoming-transaction-monitoring.md</files>
  <action>
§6.5 (SafetyRuleContext 인터페이스) 수정:
- `decimals: number` 필드를 SafetyRuleContext에 추가
- JSDoc 코멘트: "토큰 소수점 자릿수 (네이티브: SOL=9, ETH=18 / 토큰: token_registry 조회)"
- 수정 후 SafetyRuleContext:
  ```typescript
  export interface SafetyRuleContext {
    dustThresholdUsd: number;
    amountMultiplier: number;
    isRegisteredToken: boolean;
    usdPrice: number | null;
    avgIncomingUsd: number | null;
    /** 토큰 소수점 자릿수 (네이티브: SOL=9, ETH=18 / 토큰: token_registry 조회) */
    decimals: number;
  }
  ```

§6.5 아래 또는 §6.6 위에 getDecimals() 헬퍼 함수 정의 추가:
```typescript
// packages/daemon/src/services/incoming/utils.ts

const NATIVE_DECIMALS: Record<string, number> = { solana: 9, ethereum: 18 };

/**
 * IncomingTransaction의 chain + tokenAddress로 decimals를 결정.
 * - 네이티브 토큰 (tokenAddress === null): 체인별 상수 (SOL=9, ETH=18)
 * - 토큰 (tokenAddress !== null): token_registry에서 조회 (실패 시 fallback 18)
 * IncomingTxMonitorService가 SafetyRuleContext.decimals 구성 시 사용.
 */
export function getDecimals(
  chain: string,
  tokenAddress: string | null,
  tokenRegistryLookup?: (address: string) => number | null,
): number {
  if (tokenAddress === null) return NATIVE_DECIMALS[chain] ?? 18;
  return tokenRegistryLookup?.(tokenAddress) ?? 18;
}
```
- NATIVE_DECIMALS는 기존 `resolve-effective-amount-usd.ts`의 패턴과 동일
- fallback 18의 근거: EVM 표준, Solana 미등록 토큰은 unknownToken 규칙에 걸리므로 decimals 무관

§6.6 (감지 규칙 3종) 수정:
- DustAttackRule의 `getDecimals(tx)` → `ctx.decimals`로 교체:
  ```typescript
  check(tx: IncomingTransaction, ctx: SafetyRuleContext): boolean {
    if (ctx.usdPrice === null) return false;
    const amountUsd = Number(tx.amount) * ctx.usdPrice / Math.pow(10, ctx.decimals);
    return amountUsd < ctx.dustThresholdUsd;
  }
  ```
- LargeAmountRule의 `getDecimals(tx)` → `ctx.decimals`로 동일하게 교체

**중요:** IncomingTransaction 타입이나 incoming_transactions DDL은 변경하지 않는다. decimals는 SafetyRuleContext를 통해 전달한다.
  </action>
  <verify>
doc 76에서 다음을 grep으로 확인:
- SafetyRuleContext에 "decimals: number" 필드가 존재
- "getDecimals" 함수 정의가 존재 (function getDecimals)
- §6.6에서 `getDecimals(tx)` 호출이 0건 (모두 ctx.decimals로 교체됨)
- `ctx.decimals`가 DustAttackRule, LargeAmountRule 양쪽에 존재
- IncomingTransaction 타입(§1.2)에 decimals 필드가 없음 (변경하지 않음 확인)
  </verify>
  <done>
SafetyRuleContext에 decimals: number 필드가 추가되고, getDecimals() 헬퍼 함수가 chain+tokenAddress 기반 로직과 함께 정의됨. DustAttackRule/LargeAmountRule의 getDecimals(tx) 호출이 ctx.decimals로 교체됨. IncomingTransaction 타입/DDL 변경 없음.
  </done>
</task>

</tasks>

<verification>
1. §6.3에 SUSPICIOUS priority 메커니즘 설명이 구체적으로 기재됨 (코멘트 수준이 아닌 설명)
2. §6.4에 NtfyChannel.mapPriority() 확장 코드 블록이 SUSPICIOUS → priority 4를 포함
3. §6.4에 WalletNotificationChannel priority 분기 확장 코드 블록이 INCOMING_TX_SUSPICIOUS 특별 처리를 포함
4. §6.5 SafetyRuleContext에 `decimals: number` 필드 존재
5. getDecimals() 헬퍼 함수 정의가 NATIVE_DECIMALS + tokenRegistryLookup + fallback 18과 함께 존재
6. §6.6 DustAttackRule/LargeAmountRule에서 `getDecimals(tx)` 호출 0건, `ctx.decimals` 사용
7. NotificationPayload/INotificationChannel 인터페이스 변경 없음
8. IncomingTransaction 타입(§1.2) 변경 없음
</verification>

<success_criteria>
- NOTIFY-1 해결: SUSPICIOUS 이벤트가 채널별로 high priority로 라우팅되는 메커니즘이 코드 블록과 함께 §6.3-§6.4에 명세됨
- getDecimals 해결: SafetyRuleContext.decimals + getDecimals() 헬퍼 + DustAttackRule/LargeAmountRule ctx.decimals 사용이 §6.5-§6.6에 명세됨
- 기존 인터페이스(NotificationPayload, IncomingTransaction) 변경 없음
</success_criteria>

<output>
After completion, create `.planning/phases/223-design-completeness/223-01-SUMMARY.md`
</output>
