---
phase: 183-menu-page-restructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/components/layout.tsx
  - packages/admin/src/utils/settings-helpers.ts
autonomous: true
requirements: [MENU-01, MENU-02, MENU-03]

must_haves:
  truths:
    - "Sidebar displays exactly 7 menu items: Dashboard, Wallets, Sessions, Policies, Notifications, Security, System"
    - "Settings and WalletConnect are not in sidebar"
    - "Navigating to #/settings redirects to #/dashboard"
    - "Navigating to #/walletconnect redirects to #/wallets"
    - "Shared settings helpers are importable from utils/settings-helpers.ts"
  artifacts:
    - path: "packages/admin/src/components/layout.tsx"
      provides: "7-menu sidebar, route redirects, Security/System page routing"
      contains: "SecurityPage"
    - path: "packages/admin/src/utils/settings-helpers.ts"
      provides: "Shared types and helpers for settings pages"
      exports: ["SettingsData", "CREDENTIAL_KEYS", "isCredentialField", "keyToLabel", "getEffectiveValue", "getEffectiveBoolValue", "isCredentialConfigured"]
  key_links:
    - from: "packages/admin/src/components/layout.tsx"
      to: "SecurityPage, SystemPage"
      via: "import and PageRouter routing"
      pattern: "import.*SecurityPage|import.*SystemPage"
    - from: "packages/admin/src/utils/settings-helpers.ts"
      to: "packages/admin/src/pages/settings.tsx"
      via: "extracted shared functions"
      pattern: "export function keyToLabel|export type SettingsData"
---

<objective>
Restructure the sidebar to show 7 menus (removing Settings/WalletConnect, adding Security/System), add route redirects for legacy URLs, and extract shared settings utility functions for reuse by Security and System pages.

Purpose: Foundation for all Phase 183 work. Without the layout changes and shared utilities, Security/System pages cannot be routed or share settings infrastructure.
Output: Updated layout.tsx with 7-menu nav + redirects, new settings-helpers.ts utility module.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/182-ui-shared-components/182-01-SUMMARY.md
@.planning/phases/182-ui-shared-components/182-02-SUMMARY.md
@packages/admin/src/components/layout.tsx
@packages/admin/src/pages/settings.tsx
@packages/admin/src/components/tab-nav.tsx
@packages/admin/src/components/breadcrumb.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared settings helpers to utils/settings-helpers.ts</name>
  <files>packages/admin/src/utils/settings-helpers.ts, packages/admin/src/pages/settings.tsx</files>
  <action>
Create `packages/admin/src/utils/settings-helpers.ts` extracting these from settings.tsx:

1. **Types** (export):
   - `SettingsData = Record<string, Record<string, string | boolean>>`
   - `KillSwitchState` interface (`state: string; activatedAt: number | null; activatedBy: string | null`)
   - `ApiKeyEntry` interface (providerName, hasKey, maskedKey, requiresApiKey, updatedAt)
   - `RpcTestResult` interface (success, latencyMs, blockNumber?, error?)
   - `NotifTestResult` interface (channel, success, error?)

2. **Constants** (export):
   - `CREDENTIAL_KEYS` Set (same 4 entries)

3. **Functions** (export):
   - `isCredentialField(fullKey: string): boolean`
   - `keyToLabel(key: string): string` (full map from settings.tsx lines 62-114)

4. **Settings value helpers** (export): These take settings + dirty signals as parameters for reuse:
   - `getEffectiveValue(settings: SettingsData, dirty: Record<string, string>, category: string, shortKey: string): string`
   - `getEffectiveBoolValue(settings: SettingsData, dirty: Record<string, string>, category: string, shortKey: string): boolean`
   - `isCredentialConfigured(settings: SettingsData, dirty: Record<string, string>, category: string, shortKey: string): boolean`

   NOTE: The original functions in settings.tsx access signals directly. The extracted versions must take the values as plain parameters instead of accessing signals, so they are pure functions usable from any page.

5. **Update settings.tsx** to import from `../utils/settings-helpers` instead of defining inline. Replace the inline type definitions, constants, and helper functions with imports. Keep the signal-based wrapper functions inside SettingsPage that call the extracted pure functions, e.g.:
   ```
   const getEffectiveValue = (cat: string, key: string) =>
     settingsHelpers.getEffectiveValue(settings.value, dirty.value, cat, key);
   ```
   This preserves settings.tsx behavior exactly while deduplicating code.
  </action>
  <verify>
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/admin` passes without errors.
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run test --filter=@waiaas/admin` -- existing settings tests still pass.
  </verify>
  <done>
    settings-helpers.ts exports all shared types and pure helper functions.
    settings.tsx imports from settings-helpers and all existing behavior preserved.
    No type errors, existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update layout.tsx for 7-menu sidebar + route redirects</name>
  <files>packages/admin/src/components/layout.tsx</files>
  <action>
Modify `packages/admin/src/components/layout.tsx`:

1. **Remove imports**: Remove `WalletConnectPage` and `SettingsPage` imports.

2. **Add imports**: Add `SecurityPage` from `../pages/security` and `SystemPage` from `../pages/system`. NOTE: These files don't exist yet -- they will be created in plans 02 and 03. Add them as lazy placeholders for now:
   - Create simple placeholder components inline in layout.tsx (temporary):
     ```tsx
     // Placeholder until security.tsx is created by plan 183-02
     function SecurityPagePlaceholder() { return <div class="page"><p>Loading Security...</p></div>; }
     function SystemPagePlaceholder() { return <div class="page"><p>Loading System...</p></div>; }
     ```
   - These will be replaced with real imports in plans 02/03.

3. **Update NAV_ITEMS**: Replace the 7 items with:
   ```ts
   const NAV_ITEMS = [
     { path: '/dashboard', label: 'Dashboard' },
     { path: '/wallets', label: 'Wallets' },
     { path: '/sessions', label: 'Sessions' },
     { path: '/policies', label: 'Policies' },
     { path: '/notifications', label: 'Notifications' },
     { path: '/security', label: 'Security' },
     { path: '/system', label: 'System' },
   ];
   ```

4. **Update PAGE_TITLES**: Remove `/telegram-users`, `/walletconnect`, `/settings` entries. Add:
   - `'/security': 'Security'`
   - `'/system': 'System'`

5. **Update PAGE_SUBTITLES**: Remove `/walletconnect`, `/settings` entries. Add:
   - `'/security': 'Emergency controls and automatic protection rules'`
   - `'/system': 'API keys, display preferences, and daemon configuration'`

6. **Update PageRouter**:
   - Remove the `if (path === '/walletconnect') return <WalletConnectPage />;` line
   - Remove the `if (path === '/settings') return <SettingsPage />;` line
   - Change the existing `/telegram-users` redirect pattern and add two new redirects:
     ```tsx
     if (path === '/telegram-users') {
       window.location.hash = '#/notifications';
       return <NotificationsPage />;
     }
     if (path === '/settings') {
       window.location.hash = '#/dashboard';
       return <DashboardPage />;
     }
     if (path === '/walletconnect') {
       window.location.hash = '#/wallets';
       return <WalletsPage />;
     }
     if (path === '/security') return <SecurityPagePlaceholder />;
     if (path === '/system') return <SystemPagePlaceholder />;
     ```

7. **Remove unused imports**: Remove `TelegramUsersPage` import since it's only used inside NotificationsPage. Actually, check if TelegramUsersPage is still needed -- it IS imported but the redirect returns `<NotificationsPage />`. However the import might be needed elsewhere. Remove only WalletConnectPage and SettingsPage imports.

IMPORTANT: Keep the `TelegramUsersPage` import if it's referenced. Check actual usage. Actually, looking at the code, TelegramUsersPage is imported but only used in the telegram-users redirect which returns `<NotificationsPage />` -- so the import is unused. Remove it.
  </action>
  <verify>
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/admin` passes.
    Grep for NAV_ITEMS in layout.tsx and confirm exactly 7 entries without 'walletconnect' or 'settings'.
  </verify>
  <done>
    Sidebar shows 7 menus: Dashboard, Wallets, Sessions, Policies, Notifications, Security, System.
    #/settings redirects to #/dashboard, #/walletconnect redirects to #/wallets.
    Security and System have placeholder routing (will be replaced by plans 02/03).
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo run typecheck --filter=@waiaas/admin` passes
- `pnpm turbo run test --filter=@waiaas/admin` -- existing tests still pass
- NAV_ITEMS has exactly 7 entries with paths: /dashboard, /wallets, /sessions, /policies, /notifications, /security, /system
- settings-helpers.ts exports: SettingsData, KillSwitchState, ApiKeyEntry, CREDENTIAL_KEYS, isCredentialField, keyToLabel, getEffectiveValue, getEffectiveBoolValue, isCredentialConfigured
</verification>

<success_criteria>
1. Sidebar displays 7 menu items (no Settings, no WalletConnect)
2. #/settings and #/walletconnect redirect correctly
3. Security and System placeholders render at their routes
4. settings-helpers.ts provides shared utility functions
5. All existing admin tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/183-menu-page-restructure/183-01-SUMMARY.md`
</output>
