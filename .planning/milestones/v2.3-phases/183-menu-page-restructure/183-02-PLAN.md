---
phase: 183-menu-page-restructure
plan: 02
type: execute
wave: 2
depends_on: ["183-01"]
files_modified:
  - packages/admin/src/pages/security.tsx
  - packages/admin/src/components/layout.tsx
autonomous: true
requirements: [SEC-01, SEC-02, SEC-03, SEC-04]

must_haves:
  truths:
    - "Security page renders at #/security with 3 tabs: Kill Switch, AutoStop Rules, JWT Rotation"
    - "Kill Switch tab shows state card (ACTIVE/SUSPENDED/LOCKED), action buttons (activate/recover/escalate), and state descriptions -- identical to Settings"
    - "AutoStop Rules tab shows enabled checkbox and 5 numeric fields with save bar -- identical to Settings"
    - "JWT Rotation tab shows rotate button and confirmation modal -- identical to Settings"
    - "Breadcrumb shows 'Security > [tab name]' and clicking Security navigates to first tab"
  artifacts:
    - path: "packages/admin/src/pages/security.tsx"
      provides: "Security page with 3 functional tabs"
      min_lines: 200
    - path: "packages/admin/src/components/layout.tsx"
      provides: "Updated router with real SecurityPage import"
      contains: "SecurityPage"
  key_links:
    - from: "packages/admin/src/pages/security.tsx"
      to: "packages/admin/src/utils/settings-helpers.ts"
      via: "import shared types and helpers"
      pattern: "import.*settings-helpers"
    - from: "packages/admin/src/pages/security.tsx"
      to: "/v1/admin/kill-switch"
      via: "apiGet/apiPost for kill switch state"
      pattern: "API\\.ADMIN_KILL_SWITCH"
    - from: "packages/admin/src/pages/security.tsx"
      to: "/v1/admin/settings"
      via: "apiGet/apiPut for AutoStop settings"
      pattern: "API\\.ADMIN_SETTINGS"
    - from: "packages/admin/src/components/layout.tsx"
      to: "packages/admin/src/pages/security.tsx"
      via: "import SecurityPage"
      pattern: "import SecurityPage"
---

<objective>
Create the Security page with 3 fully functional tabs (Kill Switch, AutoStop Rules, JWT Rotation) that replicate the exact functionality currently in the Settings page.

Purpose: SEC-01 through SEC-04 require Security page to provide identical functionality to Settings' Kill Switch, AutoStop, and JWT Rotation sections.
Output: New security.tsx page with all 3 tabs working, layout.tsx updated to import real SecurityPage.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/183-menu-page-restructure/183-01-SUMMARY.md
@packages/admin/src/pages/settings.tsx
@packages/admin/src/utils/settings-helpers.ts
@packages/admin/src/components/layout.tsx
@packages/admin/src/components/tab-nav.tsx
@packages/admin/src/components/breadcrumb.tsx
@packages/admin/src/api/endpoints.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Security page with Kill Switch / AutoStop Rules / JWT Rotation tabs</name>
  <files>packages/admin/src/pages/security.tsx</files>
  <action>
Create `packages/admin/src/pages/security.tsx` as a new page component with 3 tabs.

**Imports needed:**
- `useSignal` from `@preact/signals`
- `useEffect` from `preact/hooks`
- `apiGet, apiPost, apiPut, ApiError` from `../api/client`
- `API` from `../api/endpoints`
- `FormField, Button, Badge` from `../components/form`
- `Modal` from `../components/modal`
- `TabNav` from `../components/tab-nav`
- `Breadcrumb` from `../components/breadcrumb`
- `showToast` from `../components/toast`
- `getErrorMessage` from `../utils/error-messages`
- `formatDate` from `../utils/format`
- Types and helpers from `../utils/settings-helpers`: `SettingsData, KillSwitchState, keyToLabel, getEffectiveValue, getEffectiveBoolValue`

**Tab definitions:**
```ts
const SECURITY_TABS = [
  { key: 'killswitch', label: 'Kill Switch' },
  { key: 'autostop', label: 'AutoStop Rules' },
  { key: 'jwt', label: 'JWT Rotation' },
];
```

**Component structure:**
```tsx
export default function SecurityPage() {
  const activeTab = useSignal('killswitch');
  // ... state signals ...

  // Tab label lookup for Breadcrumb:
  const activeTabLabel = SECURITY_TABS.find(t => t.key === activeTab.value)?.label ?? '';

  return (
    <div class="page">
      <Breadcrumb
        pageName="Security"
        tabName={activeTabLabel}
        onPageClick={() => { activeTab.value = 'killswitch'; }}
      />
      <TabNav
        tabs={SECURITY_TABS}
        activeTab={activeTab.value}
        onTabChange={(key) => { activeTab.value = key; }}
      />
      {activeTab.value === 'killswitch' && <KillSwitchTab />}
      {activeTab.value === 'autostop' && <AutoStopTab />}
      {activeTab.value === 'jwt' && <JwtRotationTab />}
    </div>
  );
}
```

**Kill Switch Tab** (inner component or inline):
Copy the Kill Switch functionality from settings.tsx lines 166-176 (fetchKillSwitchState), 350-393 (handlers), 1136-1220 (JSX). Needs:
- State: `killSwitchState`, `ksLoading`, `ksActionLoading` signals
- Functions: `fetchKillSwitchState`, `handleKillSwitchActivate`, `handleKillSwitchEscalate`, `handleKillSwitchRecover`
- useEffect to call `fetchKillSwitchState()` on mount
- Render: State indicator card with Badge (ACTIVE=success, SUSPENDED=warning, LOCKED=danger), action buttons based on state, info boxes for SUSPENDED/LOCKED states
- Reproduce the EXACT JSX structure and classes from settings.tsx (`ks-state-card`, `settings-info-box`, etc.)

**AutoStop Rules Tab** (inner component):
Copy AutoStopSettings from settings.tsx lines 971-1025. Needs:
- State: `settings`, `dirty`, `saving`, `loading` signals (for the autostop category)
- Functions: `fetchSettings`, `handleFieldChange`, `handleSave`, `handleDiscard`
- Uses helpers from settings-helpers.ts: `getEffectiveValue`, `getEffectiveBoolValue`, `keyToLabel`
- Fields array: `enabled` (checkbox), `consecutive_failures_threshold`, `unusual_activity_threshold`, `unusual_activity_window_sec`, `idle_timeout_sec`, `idle_check_interval_sec` (all numbers with same min/max as settings.tsx)
- Save bar (dirty count > 0 shows save/discard bar)
- Info box with AutoStop descriptions
- IMPORTANT: The save bar here only tracks autostop.* dirty entries. Use `handleFieldChange` that writes to `autostop.{key}` format. The `handleSave` should send only autostop-related dirty entries to the settings API.

**JWT Rotation Tab** (inner component):
Copy from settings.tsx lines 395-407 (handleRotate), 1222-1261 (JSX + modal). Needs:
- State: `rotateModal`, `rotateLoading` signals
- Function: `handleRotate` -- calls `apiPost(API.ADMIN_ROTATE_SECRET)`, shows toast
- Render: Section header "JWT Secret Rotation" + description + "Rotate JWT Secret" button
- Modal: confirmation dialog with "Are you sure..." text

**Important implementation notes:**
- The AutoStop tab needs its own settings/dirty/saving/loading signals separate from other tabs. Each tab manages its own state independently.
- The AutoStop tab fetches settings on mount via `useEffect(() => { fetchSettings(); }, [])` and filters to show only autostop fields.
- Use the pure function versions from settings-helpers.ts: `getEffectiveValue(settings.value, dirty.value, 'autostop', key)` etc.
  </action>
  <verify>
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/admin` passes.
  </verify>
  <done>
    security.tsx renders 3 tabs with full functionality.
    Kill Switch tab shows state and action buttons.
    AutoStop tab shows settings fields with save bar.
    JWT tab shows rotate button with confirmation modal.
    Breadcrumb displays "Security > [tab name]".
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SecurityPage into layout.tsx router</name>
  <files>packages/admin/src/components/layout.tsx</files>
  <action>
Update `packages/admin/src/components/layout.tsx`:

1. Add import: `import SecurityPage from '../pages/security';`
2. Remove the `SecurityPagePlaceholder` function created in plan 01.
3. In PageRouter, replace `<SecurityPagePlaceholder />` with `<SecurityPage />`:
   ```tsx
   if (path === '/security') return <SecurityPage />;
   ```

This is a minimal wiring change -- the heavy lifting is in Task 1.
  </action>
  <verify>
    Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/admin` passes.
    Grep layout.tsx for "SecurityPage" to confirm import and usage.
  </verify>
  <done>
    #/security route renders the real SecurityPage component with 3 functional tabs.
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo run typecheck --filter=@waiaas/admin` passes
- security.tsx exports a default SecurityPage component
- SecurityPage renders TabNav with 3 tabs (killswitch, autostop, jwt)
- SecurityPage renders Breadcrumb with pageName="Security"
- Kill Switch tab uses API.ADMIN_KILL_SWITCH, API.ADMIN_KILL_SWITCH_ESCALATE, API.ADMIN_RECOVER
- AutoStop tab uses API.ADMIN_SETTINGS for fetch and save
- JWT tab uses API.ADMIN_ROTATE_SECRET
- layout.tsx imports and routes to SecurityPage at /security
</verification>

<success_criteria>
1. Security page accessible at #/security with 3 tabs
2. Kill Switch tab identical in functionality to Settings (state display, activate, recover, escalate)
3. AutoStop Rules tab identical to Settings (enabled toggle, 5 numeric fields, save bar)
4. JWT Rotation tab identical to Settings (rotate button, confirmation modal)
5. Breadcrumb shows "Security > Kill Switch" (or AutoStop Rules / JWT Rotation)
6. Typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/183-menu-page-restructure/183-02-SUMMARY.md`
</output>
