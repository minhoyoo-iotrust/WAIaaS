---
phase: 185-ux-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/utils/settings-search-index.ts
  - packages/admin/src/components/settings-search.tsx
  - packages/admin/src/components/layout.tsx
  - packages/admin/src/components/form.tsx
  - packages/admin/src/styles/global.css
  - packages/admin/src/pages/wallets.tsx
  - packages/admin/src/pages/sessions.tsx
  - packages/admin/src/pages/policies.tsx
  - packages/admin/src/pages/notifications.tsx
  - packages/admin/src/pages/security.tsx
  - packages/admin/src/pages/system.tsx
autonomous: true
requirements: [SRCH-01, SRCH-02, SRCH-03]

must_haves:
  truths:
    - "Header displays a search icon button next to the Logout button"
    - "Ctrl+K (or Cmd+K on macOS) opens a search popover overlay"
    - "Typing in the search input filters all settings by label and description, showing matching results"
    - "Clicking a search result navigates to the correct page and tab, and the target field briefly highlights"
    - "Pressing Escape or clicking outside the popover closes it"
  artifacts:
    - path: "packages/admin/src/utils/settings-search-index.ts"
      provides: "Static search index array of all setting items with page/tab/label/description/fieldName"
      exports: ["SETTINGS_SEARCH_INDEX", "SearchIndexEntry"]
    - path: "packages/admin/src/components/settings-search.tsx"
      provides: "Search popover component with input, filtered results list, keyboard navigation"
      exports: ["SettingsSearch"]
    - path: "packages/admin/src/components/layout.tsx"
      provides: "Updated header with search icon button and Ctrl+K shortcut binding"
    - path: "packages/admin/src/components/form.tsx"
      provides: "Updated FormField that reads highlightField signal and applies highlight class"
    - path: "packages/admin/src/styles/global.css"
      provides: "CSS for search popover, search results, and field highlight animation"
  key_links:
    - from: "packages/admin/src/components/layout.tsx"
      to: "packages/admin/src/components/settings-search.tsx"
      via: "renders SettingsSearch component, passes open signal"
      pattern: "SettingsSearch"
    - from: "packages/admin/src/components/settings-search.tsx"
      to: "packages/admin/src/utils/settings-search-index.ts"
      via: "imports SETTINGS_SEARCH_INDEX for filtering"
      pattern: "SETTINGS_SEARCH_INDEX"
    - from: "packages/admin/src/components/settings-search.tsx"
      to: "packages/admin/src/components/layout.tsx"
      via: "sets currentPath and highlightField signals on result click"
      pattern: "currentPath|highlightField"
    - from: "packages/admin/src/components/form.tsx"
      to: "highlightField signal"
      via: "reads highlightField signal to apply CSS flash animation"
      pattern: "highlightField"
---

<objective>
Implement settings search: a Ctrl+K-triggered popover that searches all settings by label and description, with click-to-navigate and field highlight.

Purpose: Users can quickly find any setting across all 6 pages and multiple tabs without manually browsing each page.
Output: Search icon in header, keyboard shortcut, search popover with results, field highlight on navigation.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/184-settings-distribution/184-01-SUMMARY.md
@.planning/phases/184-settings-distribution/184-02-SUMMARY.md
@packages/admin/src/components/layout.tsx
@packages/admin/src/utils/settings-helpers.ts
@packages/admin/src/components/form.tsx
@packages/admin/src/components/modal.tsx
@packages/admin/src/styles/global.css
@packages/admin/src/pages/wallets.tsx
@packages/admin/src/pages/sessions.tsx
@packages/admin/src/pages/policies.tsx
@packages/admin/src/pages/notifications.tsx
@packages/admin/src/pages/security.tsx
@packages/admin/src/pages/system.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings search index and search popover component</name>
  <files>
    packages/admin/src/utils/settings-search-index.ts
    packages/admin/src/components/settings-search.tsx
    packages/admin/src/styles/global.css
  </files>
  <action>
**1. Create `packages/admin/src/utils/settings-search-index.ts`**

Export a `SearchIndexEntry` interface and a `SETTINGS_SEARCH_INDEX` array. Each entry represents one searchable setting field:

```typescript
export interface SearchIndexEntry {
  id: string;           // unique: "page.tab.fieldName" e.g. "wallets.rpc.solana_mainnet"
  label: string;        // display label from keyToLabel
  description: string;  // brief help text for the field
  page: string;         // hash path: "/wallets", "/sessions", etc.
  tab: string;          // tab key: "rpc", "settings", etc.
  fieldName: string;    // the form field name attribute e.g. "rpc.solana_mainnet"
  keywords: string[];   // extra search terms
}
```

Build the full index covering ALL settings fields across the 6 pages/tabs. Enumerate every field by reading the actual page components:

**Wallets page:**
- RPC Endpoints tab (`tab: 'rpc'`): solana_mainnet, solana_devnet, solana_testnet, evm_ethereum_mainnet, evm_ethereum_sepolia, evm_polygon_mainnet, evm_polygon_amoy, evm_arbitrum_mainnet, evm_arbitrum_sepolia, evm_optimism_mainnet, evm_optimism_sepolia, evm_base_mainnet, evm_base_sepolia, evm_default_network -- all with prefix `rpc.`
- Balance Monitoring tab (`tab: 'monitoring'`): enabled, check_interval_sec, low_balance_threshold_sol, low_balance_threshold_eth, cooldown_hours -- prefix `monitoring.`
- WalletConnect tab (`tab: 'walletconnect'`): project_id, relay_url -- prefix `walletconnect.`

**Sessions page:**
- Settings tab (`tab: 'settings'`): session_ttl, session_absolute_lifetime, session_max_renewals, max_sessions_per_wallet, max_pending_tx, rate_limit_session_rpm, rate_limit_tx_rpm -- prefix `security.`

**Policies page:**
- Defaults tab (`tab: 'defaults'`): policy_defaults_delay_seconds, policy_defaults_approval_timeout, default_deny_tokens, default_deny_contracts, default_deny_spenders -- mixed prefix (`security.` for reading)

**Notifications page:**
- Settings tab (`tab: 'settings'`): telegram_bot_token, telegram_chat_id, discord_webhook_url, ntfy_server, ntfy_topic, enabled (notifications), rate_limit_rpm, slack_webhook_url, locale, bot_token (telegram.) -- split across `notifications.*` and `telegram.*`

**Security page:**
- AutoStop Rules tab (`tab: 'autostop'`): enabled, consecutive_failures_threshold, unusual_activity_threshold, unusual_activity_window_sec, idle_timeout_sec, idle_check_interval_sec -- prefix `autostop.`

**System page (no tabs, single page):**
- `tab: ''` (empty string): currency, rate_limit_global_ip_rpm, log_level, oracle.cross_validation_threshold -- mixed prefixes (display.*, security.*, daemon.*, oracle.*)

Use `keyToLabel()` from settings-helpers.ts for the label field. Add brief descriptions for each field. Add relevant keywords (e.g. "blockchain", "token", "webhook") to aid fuzzy matching.

Export the array sorted by page then tab for readability.

**2. Create `packages/admin/src/components/settings-search.tsx`**

Create a Preact component `SettingsSearch` that takes props:
```typescript
interface SettingsSearchProps {
  open: Signal<boolean>;
}
```

Implementation:
- When `open.value` is true, render a modal-like overlay with a search input at top and results below
- On mount when open, auto-focus the search input
- Filter `SETTINGS_SEARCH_INDEX` using case-insensitive substring matching against `label`, `description`, and `keywords` (join keywords with space)
- Render max 10 results, each showing: label, description (truncated), and page/tab breadcrumb path
- On result click: (a) set `window.location.hash` to `#${entry.page}`, (b) if entry has a tab, also need to communicate the tab to switch to -- export a `navigateToSettingsField` signal from this module that holds `{ page, tab, fieldName } | null`, (c) set `highlightField` signal exported from layout.tsx to `entry.fieldName`, (d) close the popover
- On Escape key or clicking the overlay backdrop: close the popover
- Keyboard navigation: Up/Down arrows move selection, Enter activates selected result
- Use a local `useSignal<string>('')` for the query

Export:
- `SettingsSearch` component
- `highlightField` signal (type `Signal<string>`) -- a module-level signal that FormField will read
- `targetTab` signal (type `Signal<string>`) -- a module-level signal that page components will read to switch to the correct tab

**3. Append CSS to `packages/admin/src/styles/global.css`**

Add these styles at the end (before the @media query):

```css
/* Settings Search Popover */
.search-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 15vh;
  z-index: 100;
}

.search-popover {
  background: var(--color-bg);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 560px;
  max-height: 60vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.search-input-wrapper {
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--color-border);
}

.search-input {
  width: 100%;
  padding: var(--space-2) var(--space-3);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: var(--font-size-base);
  outline: none;
  background: var(--color-bg);
  color: var(--color-text);
}

.search-input:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 2px var(--color-primary-light);
}

.search-results {
  overflow-y: auto;
  flex: 1;
}

.search-result-item {
  display: block;
  width: 100%;
  padding: var(--space-3) var(--space-4);
  border: none;
  border-bottom: 1px solid var(--color-border);
  background: none;
  text-align: left;
  cursor: pointer;
  font-family: inherit;
  color: var(--color-text);
}

.search-result-item:hover,
.search-result-item.selected {
  background: var(--color-bg-secondary);
}

.search-result-label {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  margin-bottom: 2px;
}

.search-result-desc {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  margin-bottom: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.search-result-path {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
}

.search-empty {
  padding: var(--space-6) var(--space-4);
  text-align: center;
  color: var(--color-text-muted);
  font-size: var(--font-size-sm);
}

.search-hint {
  padding: var(--space-2) var(--space-4);
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
  border-top: 1px solid var(--color-border);
  display: flex;
  gap: var(--space-4);
}

.search-hint kbd {
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  padding: 0 var(--space-1);
  font-size: var(--font-size-xs);
  font-family: inherit;
}

/* Field Highlight Animation */
.form-field--highlight {
  animation: field-highlight 2s ease-out;
  border-radius: var(--radius-md);
}

@keyframes field-highlight {
  0% { background: var(--color-primary-light); box-shadow: 0 0 0 2px var(--color-primary); }
  100% { background: transparent; box-shadow: none; }
}
```
  </action>
  <verify>
1. `ls packages/admin/src/utils/settings-search-index.ts` -- file exists
2. `ls packages/admin/src/components/settings-search.tsx` -- file exists
3. `npx tsc --noEmit --project packages/admin/tsconfig.json 2>&1 | head -20` -- no type errors in new files
4. `grep -c "SearchIndexEntry" packages/admin/src/utils/settings-search-index.ts` -- returns > 0
5. `grep "field-highlight" packages/admin/src/styles/global.css` -- CSS added
  </verify>
  <done>
- settings-search-index.ts exports SETTINGS_SEARCH_INDEX with entries for all settings fields across 6 pages
- settings-search.tsx exports SettingsSearch component with popover UI, filtering, keyboard navigation, and navigation signals
- global.css contains search popover styles and field highlight animation keyframes
- All files pass TypeScript type checking
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire search into header, add Ctrl+K shortcut, and implement field highlight</name>
  <files>
    packages/admin/src/components/layout.tsx
    packages/admin/src/components/form.tsx
  </files>
  <action>
**1. Update `packages/admin/src/components/layout.tsx`**

Add these changes:

a) Import the SettingsSearch component and its signals:
```typescript
import { SettingsSearch, highlightField, targetTab } from './settings-search';
```

b) Add a module-level signal for search open state (or use useSignal in Layout):
```typescript
import { signal } from '@preact/signals';
// ... existing code ...
const searchOpen = signal(false);
```

c) In the `Layout` function, add a global keyboard listener for Ctrl+K / Cmd+K:
```typescript
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      searchOpen.value = !searchOpen.value;
    }
  };
  document.addEventListener('keydown', handleKeyDown);
  return () => document.removeEventListener('keydown', handleKeyDown);
}, []);
```
Import `useEffect` from `preact/hooks`.

d) Add a search icon button in the header, between header-left and btn-logout:
```tsx
<header class="header">
  <div class="header-left">
    <h1 class="header-title">{getPageTitle(currentPath.value)}</h1>
    {getPageSubtitle(currentPath.value) && (
      <p class="header-subtitle">{getPageSubtitle(currentPath.value)}</p>
    )}
  </div>
  <div class="header-actions">
    <button
      class="btn-search"
      onClick={() => { searchOpen.value = true; }}
      title="Search settings (Ctrl+K)"
    >
      &#x1F50D;
    </button>
    <button class="btn-logout" onClick={() => logout()}>Logout</button>
  </div>
</header>
```

Add CSS for `.header-actions` and `.btn-search` in global.css:
```css
.header-actions {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.btn-search {
  padding: var(--space-1) var(--space-2);
  font-size: var(--font-size-base);
  background: none;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  color: var(--color-text-secondary);
  transition: background 0.15s, color 0.15s;
  line-height: 1;
}

.btn-search:hover {
  background: var(--color-bg-tertiary);
  color: var(--color-text);
}
```

e) Render the SettingsSearch component at the end of the Layout, just before closing `</div>` of layout:
```tsx
<SettingsSearch open={searchOpen} />
```

f) Export `highlightField` and `targetTab` from layout.tsx for page components to import (re-export from settings-search):
```typescript
export { highlightField, targetTab } from './settings-search';
```

**2. Update `packages/admin/src/components/form.tsx`**

Import the `highlightField` signal:
```typescript
import { highlightField } from './settings-search';
```

In the `FormField` component, add highlight detection:
- Compare `highlightField.value` with the `name` prop
- If they match, add `.form-field--highlight` class to the outer `.form-field` div
- After a 2-second timeout, clear the `highlightField` signal

```typescript
import { useEffect as useEffectHook } from 'preact/hooks';

// Inside FormField:
const isHighlighted = highlightField.value === name;

useEffectHook(() => {
  if (isHighlighted) {
    // Scroll the field into view
    const el = document.querySelector(`[name="${name}"]`);
    if (el) {
      el.closest('.form-field')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    // Clear highlight after animation completes
    const timer = setTimeout(() => {
      highlightField.value = '';
    }, 2500);
    return () => clearTimeout(timer);
  }
}, [isHighlighted, name]);

// In JSX, change:
// <div class="form-field">
// to:
// <div class={`form-field${isHighlighted ? ' form-field--highlight' : ''}`}>
```

Apply this to BOTH the checkbox branch and the non-checkbox branch of FormField's render.

**3. Handle tab switching from search results**

The search popover sets `targetTab` and `currentPath` signals when a result is clicked. Page components need to read `targetTab` on mount/path change. However, since each page's activeTab is a local useSignal, the simplest approach is:

In `settings-search.tsx`, after setting `window.location.hash`, set a short timeout (50ms) then scroll to the field. The page components already re-render on hash change. For tab switching, use a simpler approach:

Export a `pendingNavigation` signal from settings-search.tsx:
```typescript
export const pendingNavigation = signal<{ tab: string; fieldName: string } | null>(null);
```

On result click in SettingsSearch:
1. Set `window.location.hash = '#' + entry.page`
2. Set `pendingNavigation.value = { tab: entry.tab, fieldName: entry.fieldName }`
3. Close popover

Then in each page component that has tabs (wallets.tsx, sessions.tsx, policies.tsx, notifications.tsx, security.tsx), add a useEffect that watches `pendingNavigation`:

```typescript
import { pendingNavigation, highlightField } from '../components/settings-search';

// Inside the page component:
useEffect(() => {
  const nav = pendingNavigation.value;
  if (nav && nav.tab) {
    activeTab.value = nav.tab;
    // Set highlight after a brief delay so the tab content renders
    setTimeout(() => {
      highlightField.value = nav.fieldName;
    }, 100);
    pendingNavigation.value = null;
  }
}, [pendingNavigation.value]);
```

Add this useEffect to: WalletListWithTabs (wallets.tsx), SessionsPage (sessions.tsx), PoliciesPage (policies.tsx), NotificationsPage (notifications.tsx), SecurityPage (security.tsx).

For SystemPage (system.tsx) which has no tabs, only set the highlight -- no tab switching needed. Add the same pattern but skip the tab logic.

IMPORTANT: Do NOT add `pendingNavigation` import or useEffect to pages that have tabs with no settings (e.g., the Wallets tab itself, Sessions list tab, Policies list tab). The navigation should only switch to settings tabs when a settings field is searched.

**4. Verify typecheck and lint**

Run `pnpm turbo run typecheck --filter=@waiaas/admin` to ensure no type errors.
Run `pnpm turbo run lint --filter=@waiaas/admin` to ensure no lint errors.
  </action>
  <verify>
1. `pnpm turbo run typecheck --filter=@waiaas/admin` -- passes with no errors
2. `pnpm turbo run lint --filter=@waiaas/admin` -- passes with no errors
3. `grep "btn-search" packages/admin/src/components/layout.tsx` -- search button exists in header
4. `grep "Ctrl+K\|ctrlKey.*k\|metaKey.*k" packages/admin/src/components/layout.tsx` -- keyboard shortcut wired
5. `grep "form-field--highlight" packages/admin/src/components/form.tsx` -- highlight class applied
6. `grep "pendingNavigation" packages/admin/src/pages/wallets.tsx` -- page responds to search navigation
7. `grep "pendingNavigation" packages/admin/src/pages/sessions.tsx` -- page responds to search navigation
  </verify>
  <done>
- Header shows a search icon button (magnifying glass) next to Logout
- Ctrl+K / Cmd+K toggles the search popover open/closed
- Search popover renders via SettingsSearch component inside Layout
- FormField applies `.form-field--highlight` animation class when highlightField signal matches its name
- Highlighted field scrolls into view and the highlight clears after 2.5s
- All 6 page components handle pendingNavigation to switch tabs and trigger field highlight
- TypeScript type check and lint both pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `pnpm turbo run typecheck --filter=@waiaas/admin` passes
2. Lint: `pnpm turbo run lint --filter=@waiaas/admin` passes
3. Header search icon visible in layout.tsx JSX output
4. Ctrl+K keyboard shortcut registered in Layout useEffect
5. Search index covers settings from all 6 pages: wallets (3 tabs), sessions, policies, notifications, security (autostop), system
6. Search popover filters results by label, description, and keywords
7. Result click navigates to correct page + tab and triggers field highlight
8. Field highlight animation plays for 2s then clears
</verification>

<success_criteria>
- Search icon in header is visible and clickable
- Ctrl+K / Cmd+K opens the search popover
- Typing filters settings by label+description, showing up to 10 results
- Clicking a result navigates to the correct page and tab, field highlights briefly
- Escape closes the popover
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/185-ux-enhancements/185-01-SUMMARY.md`
</output>
