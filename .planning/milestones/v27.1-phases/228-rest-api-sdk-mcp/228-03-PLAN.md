---
phase: 228-rest-api-sdk-mcp
plan: 03
type: execute
wave: 2
depends_on: ["228-01"]
files_modified:
  - packages/mcp/src/tools/list-incoming-transactions.ts
  - packages/mcp/src/tools/get-incoming-summary.ts
  - packages/mcp/src/server.ts
  - packages/skills/skills/wallet.skill.md
autonomous: true
requirements:
  - API-06
  - API-07

must_haves:
  truths:
    - "MCP tool list_incoming_transactions queries GET /v1/wallet/incoming with all filter params and returns paginated results"
    - "MCP tool get_incoming_summary queries GET /v1/wallet/incoming/summary with period/chain/network/since/until params"
    - "MCP server registers 23 total tools (21 existing + 2 new)"
    - "wallet.skill.md has a new 'Incoming Transactions' section documenting the two new endpoints and MCP tools"
  artifacts:
    - path: "packages/mcp/src/tools/list-incoming-transactions.ts"
      provides: "MCP tool for listing incoming transactions"
      exports: ["registerListIncomingTransactions"]
    - path: "packages/mcp/src/tools/get-incoming-summary.ts"
      provides: "MCP tool for incoming transaction summary"
      exports: ["registerGetIncomingSummary"]
    - path: "packages/mcp/src/server.ts"
      provides: "MCP server with 23 tools registered"
      contains: "registerListIncomingTransactions"
    - path: "packages/skills/skills/wallet.skill.md"
      provides: "Updated skill documentation with incoming TX section"
      contains: "Incoming Transactions"
  key_links:
    - from: "packages/mcp/src/tools/list-incoming-transactions.ts"
      to: "GET /v1/wallet/incoming"
      via: "apiClient.get()"
      pattern: "/v1/wallet/incoming"
    - from: "packages/mcp/src/tools/get-incoming-summary.ts"
      to: "GET /v1/wallet/incoming/summary"
      via: "apiClient.get()"
      pattern: "/v1/wallet/incoming/summary"
    - from: "packages/mcp/src/server.ts"
      to: "packages/mcp/src/tools/list-incoming-transactions.ts"
      via: "registerListIncomingTransactions import and call"
      pattern: "registerListIncomingTransactions"
---

<objective>
Add two MCP tools for incoming transaction queries and update the wallet skill file with incoming transaction documentation.

Purpose: Enable AI agents using MCP to query incoming transactions and summaries, and provide skill documentation for agent discovery.
Output: Two new MCP tool files, updated server.ts registration, updated wallet.skill.md.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/228-rest-api-sdk-mcp/228-RESEARCH.md
@.planning/phases/228-rest-api-sdk-mcp/228-01-SUMMARY.md

# MCP source files to reference
@packages/mcp/src/tools/list-transactions.ts
@packages/mcp/src/tools/get-transaction.ts
@packages/mcp/src/server.ts
@packages/mcp/src/api-client.ts

# Skill file
@packages/skills/skills/wallet.skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create two MCP tool files and register them in server.ts</name>
  <files>
    packages/mcp/src/tools/list-incoming-transactions.ts
    packages/mcp/src/tools/get-incoming-summary.ts
    packages/mcp/src/server.ts
  </files>
  <action>
1. **Create packages/mcp/src/tools/list-incoming-transactions.ts:**

   Follow the exact pattern from `list-transactions.ts`:

   ```typescript
   /**
    * list_incoming_transactions tool: List incoming transaction history with cursor-based pagination.
    */

   import { z } from 'zod';
   import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
   import { type ApiClient, toToolResult } from '../api-client.js';
   import { type WalletContext, withWalletPrefix } from '../server.js';

   export function registerListIncomingTransactions(
     server: McpServer,
     apiClient: ApiClient,
     walletContext?: WalletContext,
   ): void {
     server.tool(
       'list_incoming_transactions',
       withWalletPrefix(
         'List incoming (received) transaction history with cursor-based pagination. Returns confirmed incoming transfers by default.',
         walletContext?.walletName,
       ),
       {
         limit: z.number().optional().describe('Maximum number of transactions to return (1-100, default 20)'),
         cursor: z.string().optional().describe('Pagination cursor from previous response'),
         chain: z.string().optional().describe('Filter by chain (solana or ethereum)'),
         network: z.string().optional().describe('Filter by network'),
         status: z.string().optional().describe('Filter by status: DETECTED or CONFIRMED (default: CONFIRMED)'),
         token: z.string().optional().describe('Filter by token address (null for native transfers)'),
         from_address: z.string().optional().describe('Filter by sender address'),
         since: z.number().optional().describe('Filter: only transactions detected after this epoch (seconds)'),
         until: z.number().optional().describe('Filter: only transactions detected before this epoch (seconds)'),
         wallet_id: z.string().optional().describe('Target wallet ID. Omit to use the default wallet.'),
       },
       async (args) => {
         const params = new URLSearchParams();
         if (args.limit !== undefined) params.set('limit', String(args.limit));
         if (args.cursor !== undefined) params.set('cursor', args.cursor);
         if (args.chain !== undefined) params.set('chain', args.chain);
         if (args.network !== undefined) params.set('network', args.network);
         if (args.status !== undefined) params.set('status', args.status);
         if (args.token !== undefined) params.set('token', args.token);
         if (args.from_address !== undefined) params.set('from_address', args.from_address);
         if (args.since !== undefined) params.set('since', String(args.since));
         if (args.until !== undefined) params.set('until', String(args.until));
         if (args.wallet_id) params.set('wallet_id', args.wallet_id);
         const qs = params.toString();
         const result = await apiClient.get(`/v1/wallet/incoming${qs ? `?${qs}` : ''}`);
         return toToolResult(result);
       },
     );
   }
   ```

2. **Create packages/mcp/src/tools/get-incoming-summary.ts:**

   ```typescript
   /**
    * get_incoming_summary tool: Get period-based incoming transaction summary with totals.
    */

   import { z } from 'zod';
   import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
   import { type ApiClient, toToolResult } from '../api-client.js';
   import { type WalletContext, withWalletPrefix } from '../server.js';

   export function registerGetIncomingSummary(
     server: McpServer,
     apiClient: ApiClient,
     walletContext?: WalletContext,
   ): void {
     server.tool(
       'get_incoming_summary',
       withWalletPrefix(
         'Get a period-based summary of incoming transactions (daily/weekly/monthly totals with USD conversion).',
         walletContext?.walletName,
       ),
       {
         period: z.string().optional().describe('Aggregation period: daily, weekly, or monthly (default: daily)'),
         chain: z.string().optional().describe('Filter by chain (solana or ethereum)'),
         network: z.string().optional().describe('Filter by network'),
         since: z.number().optional().describe('Summary start epoch (seconds)'),
         until: z.number().optional().describe('Summary end epoch (seconds)'),
         wallet_id: z.string().optional().describe('Target wallet ID. Omit to use the default wallet.'),
       },
       async (args) => {
         const params = new URLSearchParams();
         if (args.period !== undefined) params.set('period', args.period);
         if (args.chain !== undefined) params.set('chain', args.chain);
         if (args.network !== undefined) params.set('network', args.network);
         if (args.since !== undefined) params.set('since', String(args.since));
         if (args.until !== undefined) params.set('until', String(args.until));
         if (args.wallet_id) params.set('wallet_id', args.wallet_id);
         const qs = params.toString();
         const result = await apiClient.get(`/v1/wallet/incoming/summary${qs ? `?${qs}` : ''}`);
         return toToolResult(result);
       },
     );
   }
   ```

3. **Update packages/mcp/src/server.ts:**

   a. Add imports at the top, after existing tool imports:
      ```typescript
      import { registerListIncomingTransactions } from './tools/list-incoming-transactions.js';
      import { registerGetIncomingSummary } from './tools/get-incoming-summary.js';
      ```

   b. In `createMcpServer()` function, after the last tool registration (registerWcDisconnect on line 85), add:
      ```typescript
      registerListIncomingTransactions(server, apiClient, walletContext);
      registerGetIncomingSummary(server, apiClient, walletContext);
      ```

   c. Update the JSDoc comment at the top of the file: change "21 tools" to "23 tools" in the description and in the `// Register 21 tools` comment inside createMcpServer().
  </action>
  <verify>
    - `pnpm turbo run typecheck --filter=@waiaas/mcp` passes
    - `pnpm turbo run lint --filter=@waiaas/mcp` passes
    - Both new tool files exist and export register functions
    - server.ts imports and calls both register functions
    - Tool count comment updated to 23
  </verify>
  <done>
    MCP server has 23 tools registered: 21 existing + list_incoming_transactions + get_incoming_summary.
    Both tools follow the established pattern (Zod input schema, URLSearchParams, apiClient.get, toToolResult).
    Both tools accept wallet_id for multi-wallet support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update wallet.skill.md with incoming transactions section</name>
  <files>
    packages/skills/skills/wallet.skill.md
  </files>
  <action>
1. **Read the current wallet.skill.md** to understand the full structure and find the right insertion point.

2. **Add a new section** at the end of the file (before the closing, or after the last existing section). The section should be numbered sequentially after the existing sections.

   Add the following section (title and content):

   ```markdown
   ## N. Incoming Transactions

   Monitor and query incoming (received) transactions to your wallet. Requires **sessionAuth**.

   ### GET /v1/wallet/incoming -- List Incoming Transactions (sessionAuth)

   List incoming transactions with cursor-based pagination and filters. By default, only confirmed transactions are returned.

   ```bash
   curl -s http://localhost:3100/v1/wallet/incoming \
     -H 'Authorization: Bearer wai_sess_xxx'
   ```

   Query Parameters:
   - `limit` (optional): Max results, 1-100 (default: 20)
   - `cursor` (optional): Pagination cursor from previous response
   - `chain` (optional): Filter by chain (`solana` or `ethereum`)
   - `network` (optional): Filter by network (e.g., `devnet`, `ethereum-mainnet`)
   - `status` (optional): `DETECTED` or `CONFIRMED` (default: `CONFIRMED`)
   - `token` (optional): Filter by token address (omit for native transfers)
   - `from_address` (optional): Filter by sender address
   - `since` (optional): Only transactions detected after this epoch (seconds)
   - `until` (optional): Only transactions detected before this epoch (seconds)
   - `wallet_id` (optional): Target wallet ID (for multi-wallet sessions)

   Response (200):
   ```json
   {
     "data": [
       {
         "id": "01958f3a-1234-7000-8000-abcdef123456",
         "txHash": "5VERv8NMvzbJ...",
         "walletId": "01958f3a-0000-7000-8000-abcdef000001",
         "fromAddress": "7xKXtg2CW87d...",
         "amount": "1000000000",
         "tokenAddress": null,
         "chain": "solana",
         "network": "devnet",
         "status": "CONFIRMED",
         "blockNumber": 280000000,
         "detectedAt": 1707000000,
         "confirmedAt": 1707000030,
         "suspicious": false
       }
     ],
     "nextCursor": "eyJkIjoxNzA3MDAwMDAwLCJpIjoiMDE5NThmM2EtMTIzNC03MDAwLTgwMDAtYWJjZGVmMTIzNDU2In0",
     "hasMore": true
   }
   ```

   ### GET /v1/wallet/incoming/summary -- Incoming Transaction Summary (sessionAuth)

   Get period-based aggregated summary of incoming transactions with USD conversion.

   ```bash
   curl -s 'http://localhost:3100/v1/wallet/incoming/summary?period=daily' \
     -H 'Authorization: Bearer wai_sess_xxx'
   ```

   Query Parameters:
   - `period` (optional): `daily`, `weekly`, or `monthly` (default: `daily`)
   - `chain` (optional): Filter by chain
   - `network` (optional): Filter by network
   - `since` (optional): Summary start epoch (seconds)
   - `until` (optional): Summary end epoch (seconds)
   - `wallet_id` (optional): Target wallet ID

   Response (200):
   ```json
   {
     "period": "daily",
     "entries": [
       {
         "date": "2026-02-22",
         "totalCount": 5,
         "totalAmountNative": "5500000000",
         "totalAmountUsd": 825.00,
         "suspiciousCount": 0
       }
     ]
   }
   ```

   ### PATCH /v1/wallets/{id} -- Toggle Incoming Monitoring (masterAuth)

   Enable or disable incoming transaction monitoring for a specific wallet.

   ```bash
   curl -s -X PATCH http://localhost:3100/v1/wallets/WALLET_ID \
     -H 'Content-Type: application/json' \
     -H 'X-Master-Password: your-master-password' \
     -d '{"monitorIncoming": true}'
   ```

   Response (200):
   ```json
   {
     "id": "01958f3a-0000-7000-8000-abcdef000001",
     "monitorIncoming": true
   }
   ```

   ### MCP Tools

   - **list_incoming_transactions**: List incoming transaction history with filters and pagination.
   - **get_incoming_summary**: Get period-based incoming transaction summary (daily/weekly/monthly).

   ### SDK Methods

   **TypeScript:**
   ```typescript
   const incoming = await client.listIncomingTransactions({ limit: 10, status: 'CONFIRMED' });
   const summary = await client.getIncomingTransactionSummary({ period: 'weekly' });
   ```

   **Python:**
   ```python
   incoming = await client.list_incoming_transactions(limit=10, status="CONFIRMED")
   summary = await client.get_incoming_transaction_summary(period="weekly")
   ```
   ```

3. **Update the version** in the frontmatter if appropriate (check existing pattern — if versions are managed separately, leave as-is).

4. **Ensure section numbering** is sequential with the existing sections.
  </action>
  <verify>
    - wallet.skill.md contains an "Incoming Transactions" section
    - The section includes all 3 endpoints (GET incoming, GET summary, PATCH toggle)
    - The section includes MCP tool references and SDK examples
    - The markdown is well-formed (no broken code blocks)
  </verify>
  <done>
    wallet.skill.md has a complete "Incoming Transactions" section documenting:
    - GET /v1/wallet/incoming with all query params and response example
    - GET /v1/wallet/incoming/summary with period params and response example
    - PATCH /v1/wallets/:id for monitoring toggle
    - MCP tool names and SDK method examples for both TS and Python
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/mcp` — zero type errors
2. `pnpm turbo run lint --filter=@waiaas/mcp` — zero lint warnings
3. MCP server.ts has 23 tool registrations
4. Both tool files follow established patterns (Zod input, URLSearchParams, apiClient.get, toToolResult)
5. wallet.skill.md has "Incoming Transactions" section with API, MCP, and SDK documentation
</verification>

<success_criteria>
- MCP has list_incoming_transactions and get_incoming_summary tools registered
- Total MCP tools >= 23 (21 existing + 2 new)
- Both tools support wallet_id param for multi-wallet sessions
- wallet.skill.md documents all 3 incoming TX endpoints + MCP tools + SDK methods
- All files compile and lint without errors
</success_criteria>

<output>
After completion, create `.planning/phases/228-rest-api-sdk-mcp/228-03-SUMMARY.md`
</output>
