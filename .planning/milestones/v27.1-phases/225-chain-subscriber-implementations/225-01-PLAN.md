---
phase: 225-chain-subscriber-implementations
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/adapters/solana/src/solana-incoming-subscriber.ts
  - packages/adapters/solana/src/incoming-tx-parser.ts
  - packages/adapters/solana/src/index.ts
  - packages/adapters/solana/src/__tests__/solana-incoming-subscriber.test.ts
autonomous: true
requirements: [SUB-02, SUB-07]

must_haves:
  truths:
    - "SolanaIncomingSubscriber.subscribe() starts a logsNotifications WebSocket subscription for the given wallet address"
    - "SOL native transfer detection uses preBalances/postBalances delta comparison and identifies the sender"
    - "SPL/Token-2022 transfer detection uses preTokenBalances/postTokenBalances with 0n default for first-time receipt"
    - "SolanaIncomingSubscriber.pollAll() iterates subscribed wallets and calls onTransaction for each detected incoming transfer"
    - "SolanaHeartbeat sends getSlot() RPC ping every 60s with timer.unref()"
    - "subscribe() is idempotent -- re-subscribing same walletId is a no-op"
    - "unsubscribe() aborts the AbortController and removes from subscriptions Map"
  artifacts:
    - path: "packages/adapters/solana/src/solana-incoming-subscriber.ts"
      provides: "SolanaIncomingSubscriber class implementing IChainSubscriber 6-method interface"
      exports: ["SolanaIncomingSubscriber"]
    - path: "packages/adapters/solana/src/incoming-tx-parser.ts"
      provides: "parseSOLTransfer and parseSPLTransfers pure functions"
      exports: ["parseSOLTransfer", "parseSPLTransfers"]
    - path: "packages/adapters/solana/src/__tests__/solana-incoming-subscriber.test.ts"
      provides: "Unit tests with mock RPC for all subscriber methods and parser functions"
      min_lines: 150
  key_links:
    - from: "packages/adapters/solana/src/solana-incoming-subscriber.ts"
      to: "@waiaas/core IChainSubscriber"
      via: "implements IChainSubscriber"
      pattern: "implements IChainSubscriber"
    - from: "packages/adapters/solana/src/solana-incoming-subscriber.ts"
      to: "packages/adapters/solana/src/incoming-tx-parser.ts"
      via: "import parseSOLTransfer, parseSPLTransfers"
      pattern: "import.*incoming-tx-parser"
    - from: "packages/adapters/solana/src/index.ts"
      to: "packages/adapters/solana/src/solana-incoming-subscriber.ts"
      via: "barrel re-export"
      pattern: "export.*SolanaIncomingSubscriber"
---

<objective>
Implement SolanaIncomingSubscriber that detects SOL, SPL, and Token-2022 incoming transfers via WebSocket logsSubscribe with HTTP polling fallback, plus SolanaHeartbeat for 60s keepalive.

Purpose: Enable real-time detection of all incoming transfers to Solana wallets -- native SOL via preBalances/postBalances delta, SPL/Token-2022 via preTokenBalances/postTokenBalances comparison. This is the Solana-side implementation of the IChainSubscriber interface from Phase 224.

Output: SolanaIncomingSubscriber class, parseSOLTransfer/parseSPLTransfers parser functions, SolanaHeartbeat class, barrel re-export, and comprehensive unit tests with mock RPC.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/224-core-types-db-foundation/224-01-SUMMARY.md

# Key source references
@packages/core/src/interfaces/IChainSubscriber.ts
@packages/core/src/interfaces/chain-subscriber.types.ts
@packages/core/src/enums/incoming-tx.ts
@packages/core/src/enums/chain.ts
@packages/adapters/solana/src/adapter.ts
@packages/adapters/solana/src/index.ts
@packages/adapters/solana/src/__tests__/solana-adapter.test.ts

# Design reference
@internal/design/76-incoming-transaction-monitoring.md (sections 3.1-3.7, 5.3)
@.planning/phases/225-chain-subscriber-implementations/225-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create incoming-tx-parser.ts with SOL and SPL/Token-2022 parsing functions</name>
  <files>
    packages/adapters/solana/src/incoming-tx-parser.ts
  </files>
  <action>
Create `packages/adapters/solana/src/incoming-tx-parser.ts` with two pure parsing functions following the design doc 76 sections 3.2.1 and 3.2.2.

**parseSOLTransfer(tx, walletAddress, walletId, network):**
- Takes a transaction result object (the shape returned by getTransaction jsonParsed), walletAddress string, walletId string, and network string.
- Finds the wallet's accountIndex in `transaction.message.accountKeys` by matching pubkey.
- Computes `delta = postBalances[walletIndex] - preBalances[walletIndex]` using BigInt arithmetic.
- If `delta <= 0n`, returns null (not an incoming transfer).
- Finds sender: first account with decreased balance (preBalance > postBalance, excluding wallet).
- Returns an `IncomingTransaction` object with:
  - `id`: generated via a passed-in `generateId` function (dependency injection for testability).
  - `txHash`: `transaction.signatures[0]`
  - `walletId`, `fromAddress`, `amount: delta.toString()`, `tokenAddress: null`, `chain: 'solana'`, `network`, `status: 'DETECTED'`, `blockNumber: slot`, `detectedAt: Math.floor(Date.now() / 1000)`, `confirmedAt: null`.
- The function accepts a `generateId: () => string` parameter to avoid importing UUID v7 directly (testability + Phase 226 will provide it).

**parseSPLTransfers(tx, walletAddress, walletId, network):**
- Takes same shape of transaction result.
- Builds a `preMap: Map<mint, bigint>` from `meta.preTokenBalances` where `owner === walletAddress`.
- Iterates `meta.postTokenBalances` where `owner === walletAddress`.
- For each mint: `delta = postAmount - (preMap.get(mint) ?? 0n)`. The `?? 0n` handles first-time token receipt (pitfall 1 from research).
- If `delta <= 0n`, skip.
- Finds sender: looks for the same mint in preTokenBalances where a different owner has decreased balance.
- Returns an array of `IncomingTransaction` objects (one per token with positive delta).
- Both SPL Token and Token-2022 produce the same preTokenBalances/postTokenBalances structure -- no program-specific logic needed.

**Type definitions at top of file:**
- Define a `SolanaTransactionResult` type for the getTransaction jsonParsed response shape (accountKeys with pubkey, meta with preBalances/postBalances/preTokenBalances/postTokenBalances, transaction with signatures and message, slot).
- Keep the type loose enough (`any` for nested RPC-specific fields) since the actual shapes come from @solana/kit's RPC response types.

**Export both functions.**

Do NOT import from @solana/kit in this file -- it's pure parsing logic on plain objects.
Import `IncomingTransaction` type from `@waiaas/core`.
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/adapter-solana` passes with 0 errors.
  </verify>
  <done>
parseSOLTransfer returns an IncomingTransaction for SOL native incoming transfers (positive balance delta). parseSPLTransfers returns IncomingTransaction[] for SPL/Token-2022 incoming transfers (positive token balance delta, 0n default for first receipt). Both functions are exported and typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SolanaIncomingSubscriber class with SolanaHeartbeat, barrel export, and tests</name>
  <files>
    packages/adapters/solana/src/solana-incoming-subscriber.ts
    packages/adapters/solana/src/index.ts
    packages/adapters/solana/src/__tests__/solana-incoming-subscriber.test.ts
  </files>
  <action>
**File 1: `packages/adapters/solana/src/solana-incoming-subscriber.ts`**

Create the `SolanaIncomingSubscriber` class implementing `IChainSubscriber` from `@waiaas/core`, plus the `SolanaHeartbeat` helper class.

**SolanaHeartbeat class (exported):**
- Private `timer: ReturnType<typeof setInterval> | null = null`.
- Private `INTERVAL_MS = 60_000` constant.
- `start(rpcGetSlot: () => Promise<unknown>)`: Stops any existing timer, starts a new `setInterval` that calls `rpcGetSlot()` and catches errors (heartbeat failure is non-fatal). Calls `timer.unref()` to prevent blocking process exit.
- `stop()`: Clears interval timer if set.
- The `start` method accepts a function rather than the full RPC object -- this allows easy mocking in tests and decouples from @solana/kit types.

**SolanaIncomingSubscriber class:**
- `readonly chain = 'solana' as const` (satisfies ChainType).
- Constructor takes `config: { rpcUrl: string; wsUrl: string; mode?: 'websocket' | 'polling'; generateId?: () => string }`.
  - `mode` defaults to `'websocket'`.
  - `generateId` defaults to a crypto.randomUUID fallback (real UUID v7 injected by Phase 226).
- Private `subscriptions = new Map<string, { address: string; network: string; abortController: AbortController; onTransaction: (tx: IncomingTransaction) => void }>()`.
- Private `rpc` created via `createSolanaRpc(config.rpcUrl)`.
- Private `rpcSubscriptions` created via `createSolanaRpcSubscriptions(config.wsUrl)`.
- Private `heartbeat = new SolanaHeartbeat()`.
- Private `connected = false`, `disconnectResolve: (() => void) | null = null`.

**IChainSubscriber methods:**

`subscribe(walletId, address, network, onTransaction)`:
- If `this.subscriptions.has(walletId)`, return (idempotent).
- Create new AbortController, store in subscriptions Map.
- If `this.mode === 'websocket' && this.connected`, fire-and-forget `this.startWebSocketSubscription(walletId, address, onTransaction, abortController)`.

`unsubscribe(walletId)`:
- Get subscription from Map, if not found return (idempotent).
- Call `sub.abortController.abort()`.
- Delete from subscriptions Map.

`subscribedWallets()`: Return `Array.from(this.subscriptions.keys())`.

`connect()`:
- Set `this.connected = true`.
- Start heartbeat: `this.heartbeat.start(() => this.rpc.getSlot().send())`.
- For each existing subscription in the Map, start WebSocket subscription if mode is 'websocket'.

`waitForDisconnect()`:
- Return a new Promise that stores its resolve function in `this.disconnectResolve`.
- The resolve is called when the WebSocket connection fails or `destroy()` is called.

`destroy()`:
- `this.heartbeat.stop()`.
- Abort all subscription AbortControllers.
- Clear subscriptions Map.
- Set `this.connected = false`.
- Call `this.disconnectResolve?.()`.

**pollAll() public method** (for BackgroundWorkers in Phase 226):
- Iterate all entries in subscriptions Map.
- For each wallet: call `this.rpc.getSignaturesForAddress(address(sub.address), { limit: 100, commitment: 'confirmed' }).send()`.
- For each signature: call `this.rpc.getTransaction(sig, { commitment: 'confirmed', maxSupportedTransactionVersion: 0 }).send()`.
- Parse with `parseSOLTransfer` and `parseSPLTransfers` from `./incoming-tx-parser.js`.
- Call `sub.onTransaction(tx)` for each detected incoming transfer.
- Wrap per-wallet logic in try/catch for error isolation (log warning, continue to next wallet).

**Private startWebSocketSubscription(walletId, address, onTransaction, abortController):**
- `void (async () => { ... })()` pattern (fire-and-forget).
- Subscribe via `this.rpcSubscriptions.logsNotifications({ mentions: [address(addr)] }, { commitment: 'confirmed' }).subscribe({ abortSignal: abortController.signal })`.
- `for await (const notification of logNotifications)`: extract signature, skip if err !== null.
- Call `this.rpc.getTransaction(sig, { commitment: 'confirmed', maxSupportedTransactionVersion: 0 }).send()`.
- Parse and call onTransaction.
- Catch at the outer level -- if abortController was aborted, silently exit. Otherwise, call `this.disconnectResolve?.()`.

**File 2: `packages/adapters/solana/src/index.ts`**

Add export: `export { SolanaIncomingSubscriber, SolanaHeartbeat } from './solana-incoming-subscriber.js';`

**File 3: `packages/adapters/solana/src/__tests__/solana-incoming-subscriber.test.ts`**

Follow the existing `vi.hoisted` + `vi.mock` pattern from `solana-adapter.test.ts`.

Mock setup:
- `vi.hoisted()` to create `mockRpc` with `getSlot`, `getTransaction`, `getSignaturesForAddress` methods and `mockRpcSubscriptions` with `logsNotifications` method.
- `vi.mock('@solana/kit', ...)` returning the mocked `createSolanaRpc` and `createSolanaRpcSubscriptions`.
- Use `mockSend<T>()` helper for chainable `method().send()` pattern.

**Test suites (minimum 15 tests):**

`describe('parseSOLTransfer')`:
- Detects SOL incoming transfer (positive delta) and returns correct IncomingTransaction.
- Returns null for outgoing transfer (negative delta).
- Returns null for zero delta.
- Identifies sender (account with decreased balance).
- Handles missing sender gracefully (fromAddress = 'unknown').

`describe('parseSPLTransfers')`:
- Detects SPL token incoming transfer and returns correct IncomingTransaction with tokenAddress.
- Handles first-time token receipt (no preTokenBalance entry, defaults to 0n).
- Detects multiple tokens in single transaction.
- Returns empty array for failed transaction (meta.err non-null).
- Finds token sender correctly (same mint, different owner, decreased balance).

`describe('SolanaIncomingSubscriber')`:
- subscribe() is idempotent (second call is no-op).
- subscribedWallets() returns subscribed wallet IDs.
- unsubscribe() removes wallet from subscriptions.
- destroy() clears all subscriptions and stops heartbeat.
- pollAll() calls onTransaction for detected incoming transfers.
- pollAll() isolates per-wallet errors (one wallet failure doesn't affect others).

`describe('SolanaHeartbeat')`:
- start() calls getSlot at 60s intervals (use vi.useFakeTimers).
- stop() clears the interval timer.
- start() replaces existing timer (no double intervals).
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm turbo run typecheck --filter=@waiaas/adapter-solana && pnpm vitest run --reporter=verbose packages/adapters/solana/src/__tests__/solana-incoming-subscriber.test.ts`. All tests pass and typecheck has 0 errors.
  </verify>
  <done>
SolanaIncomingSubscriber implements IChainSubscriber with subscribe/unsubscribe/subscribedWallets/connect/waitForDisconnect/destroy + pollAll(). SolanaHeartbeat sends getSlot() pings every 60s with timer.unref(). All 15+ tests pass with mock RPC. Barrel exports both classes from @waiaas/adapter-solana.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/adapter-solana` -- 0 errors
2. `pnpm vitest run --reporter=verbose packages/adapters/solana/src/__tests__/solana-incoming-subscriber.test.ts` -- all tests pass
3. `SolanaIncomingSubscriber` is importable from `@waiaas/adapter-solana`
4. `SolanaHeartbeat` is importable from `@waiaas/adapter-solana`
5. parseSOLTransfer handles positive delta (incoming), negative delta (outgoing), zero delta correctly
6. parseSPLTransfers handles first-time token receipt with 0n default for missing preTokenBalance
</verification>

<success_criteria>
- SolanaIncomingSubscriber class implements all 6 IChainSubscriber methods + pollAll()
- SOL native transfer detection via preBalances/postBalances delta comparison works correctly
- SPL/Token-2022 transfer detection via preTokenBalances/postTokenBalances works correctly (including first-time receipt)
- SolanaHeartbeat sends getSlot() RPC ping every 60s with timer.unref()
- All tests pass with mock RPC (no real network calls)
- Package barrel re-exports both SolanaIncomingSubscriber and SolanaHeartbeat
</success_criteria>

<output>
After completion, create `.planning/phases/225-chain-subscriber-implementations/225-01-SUMMARY.md`
</output>
