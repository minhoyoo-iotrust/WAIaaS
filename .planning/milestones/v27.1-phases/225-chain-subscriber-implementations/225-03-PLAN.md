---
phase: 225-chain-subscriber-implementations
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/interfaces/connection-state.ts
  - packages/core/src/interfaces/index.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/connection-state.test.ts
autonomous: true
requirements: [SUB-04]

must_haves:
  truths:
    - "ConnectionState type defines 3 states: WS_ACTIVE, POLLING_FALLBACK, RECONNECTING"
    - "calculateDelay returns exponential backoff with jitter (1s base, 60s cap, +/-30% jitter)"
    - "calculateDelay never returns less than 100ms (floor clamp)"
    - "reconnectLoop calls connect(), waits for disconnect, transitions to POLLING_FALLBACK after 3 failures"
    - "reconnectLoop resets attempt counter on successful connect"
    - "ReconnectConfig provides initialDelayMs, maxDelayMs, maxAttempts, jitterFactor defaults"
  artifacts:
    - path: "packages/core/src/interfaces/connection-state.ts"
      provides: "ConnectionState type, ReconnectConfig interface, calculateDelay function, DEFAULT_RECONNECT_CONFIG, reconnectLoop function"
      exports: ["ConnectionState", "ReconnectConfig", "calculateDelay", "DEFAULT_RECONNECT_CONFIG", "reconnectLoop"]
    - path: "packages/core/src/__tests__/connection-state.test.ts"
      provides: "Unit tests for calculateDelay and reconnectLoop with mock subscriber"
      min_lines: 80
  key_links:
    - from: "packages/core/src/interfaces/connection-state.ts"
      to: "packages/core/src/interfaces/IChainSubscriber.ts"
      via: "reconnectLoop accepts IChainSubscriber parameter"
      pattern: "subscriber: IChainSubscriber"
    - from: "packages/core/src/interfaces/index.ts"
      to: "packages/core/src/interfaces/connection-state.ts"
      via: "barrel re-export"
      pattern: "export.*connection-state"
---

<objective>
Implement the 3-state connection machine (WS_ACTIVE/POLLING_FALLBACK/RECONNECTING) with exponential backoff reconnection, providing the shared reconnect infrastructure consumed by SubscriptionMultiplexer in Phase 226.

Purpose: Provide the connection state management types and functions that enable automatic WebSocket-to-polling fallback when WebSocket connections fail. The 3-state machine transitions (WS_ACTIVE on successful connect, RECONNECTING on disconnect, POLLING_FALLBACK after 3 consecutive failures) are critical for subscriber resilience. This lives in @waiaas/core since it's consumed by the daemon's SubscriptionMultiplexer.

Output: ConnectionState type, ReconnectConfig interface, calculateDelay function, reconnectLoop function, DEFAULT_RECONNECT_CONFIG constant, barrel re-exports, and unit tests.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/224-core-types-db-foundation/224-01-SUMMARY.md

# Key source references
@packages/core/src/interfaces/IChainSubscriber.ts
@packages/core/src/interfaces/index.ts
@packages/core/src/index.ts

# Design reference
@internal/design/76-incoming-transaction-monitoring.md (sections 5.1-5.2)
@.planning/phases/225-chain-subscriber-implementations/225-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create connection-state.ts with ConnectionState type, calculateDelay, and reconnectLoop</name>
  <files>
    packages/core/src/interfaces/connection-state.ts
    packages/core/src/interfaces/index.ts
    packages/core/src/index.ts
  </files>
  <action>
**File 1: `packages/core/src/interfaces/connection-state.ts`**

Define the 3-state connection machine types and functions per design doc 76 sections 5.1-5.2.

**ConnectionState type:**
```typescript
export type ConnectionState = 'WS_ACTIVE' | 'POLLING_FALLBACK' | 'RECONNECTING';
```

**ReconnectConfig interface:**
```typescript
export interface ReconnectConfig {
  /** Initial delay in ms before first reconnect attempt. Default: 1000 */
  initialDelayMs: number;
  /** Maximum delay in ms (cap for exponential growth). Default: 60000 */
  maxDelayMs: number;
  /** Maximum reconnect attempts before giving up. Default: Infinity */
  maxAttempts: number;
  /** Jitter factor (0-1). Applied as +/- percentage. Default: 0.3 */
  jitterFactor: number;
  /** Number of consecutive failures before switching to POLLING_FALLBACK. Default: 3 */
  pollingFallbackThreshold: number;
}
```

**DEFAULT_RECONNECT_CONFIG constant:**
```typescript
export const DEFAULT_RECONNECT_CONFIG: ReconnectConfig = {
  initialDelayMs: 1000,
  maxDelayMs: 60_000,
  maxAttempts: Infinity,
  jitterFactor: 0.3,
  pollingFallbackThreshold: 3,
};
```

**calculateDelay function:**
```typescript
export function calculateDelay(attempt: number, config: ReconnectConfig): number {
  const baseDelay = Math.min(
    config.initialDelayMs * Math.pow(2, attempt),
    config.maxDelayMs,
  );
  const jitter = baseDelay * config.jitterFactor * (2 * Math.random() - 1);
  return Math.max(100, Math.floor(baseDelay + jitter));
}
```
- Exponential backoff: 1s -> 2s -> 4s -> 8s -> 16s -> 32s -> 60s (cap).
- Jitter: +/-30% random variation prevents thundering herd.
- Floor: never returns less than 100ms.

**sleep helper (not exported, internal only):**
```typescript
function sleep(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}
```

**reconnectLoop function:**
```typescript
export async function reconnectLoop(
  subscriber: { connect(): Promise<void>; waitForDisconnect(): Promise<void> },
  config: ReconnectConfig,
  onStateChange: (state: ConnectionState) => void,
  signal?: AbortSignal,
): Promise<void> {
  let attempt = 0;

  while (!signal?.aborted) {
    try {
      onStateChange('RECONNECTING');
      await subscriber.connect();
      attempt = 0; // Success resets counter
      onStateChange('WS_ACTIVE');
      await subscriber.waitForDisconnect();
      // Disconnected normally -- loop back to reconnect
    } catch {
      attempt++;
      if (attempt >= config.pollingFallbackThreshold) {
        onStateChange('POLLING_FALLBACK');
      }
      if (attempt >= config.maxAttempts) {
        return; // Give up
      }
      const delay = calculateDelay(attempt - 1, config);
      await sleep(delay);
    }
  }
}
```

Key design decisions:
- `subscriber` parameter is a structural type (duck-typed), not `IChainSubscriber` directly -- this avoids circular dependency issues and keeps the function generic. It only needs `connect()` and `waitForDisconnect()`.
- `signal?: AbortSignal` allows graceful shutdown (calling abort stops the loop).
- On first entry, state goes to RECONNECTING before connect attempt.
- On successful connect, state goes to WS_ACTIVE and waits for disconnect.
- After disconnect (from waitForDisconnect resolving), loops back to reconnect.
- On connect failure (throw), increments attempt. After `pollingFallbackThreshold` consecutive failures, transitions to POLLING_FALLBACK.
- Continues trying to reconnect even in POLLING_FALLBACK state (background reconnection).

**File 2: `packages/core/src/interfaces/index.ts`**

Add re-export line:
```typescript
export {
  type ConnectionState,
  type ReconnectConfig,
  calculateDelay,
  DEFAULT_RECONNECT_CONFIG,
  reconnectLoop,
} from './connection-state.js';
```

**File 3: `packages/core/src/index.ts`**

The core barrel already re-exports everything from `./interfaces/index.js`, so no change should be needed. Verify this by checking that `ConnectionState` is accessible via `import { ConnectionState } from '@waiaas/core'`. If the barrel pattern uses selective re-exports, add the new exports.
  </action>
  <verify>
`pnpm turbo run typecheck --filter=@waiaas/core` passes with 0 errors.
  </verify>
  <done>
ConnectionState type, ReconnectConfig interface, calculateDelay function, reconnectLoop function, and DEFAULT_RECONNECT_CONFIG are defined and exported from @waiaas/core. The 3-state machine (WS_ACTIVE/POLLING_FALLBACK/RECONNECTING) supports exponential backoff with jitter and configurable polling fallback threshold.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for calculateDelay and reconnectLoop with mock subscriber</name>
  <files>
    packages/core/src/__tests__/connection-state.test.ts
  </files>
  <action>
Create `packages/core/src/__tests__/connection-state.test.ts` with comprehensive tests.

**Test suites (minimum 12 tests):**

`describe('calculateDelay')`:
- Returns value between (baseDelay - jitter) and (baseDelay + jitter) for attempt 0 (baseDelay = 1000ms). Run multiple times and verify range.
- Exponential growth: attempt 0 ~ 1s, attempt 1 ~ 2s, attempt 2 ~ 4s. Verify base value (without jitter) by using `jitterFactor: 0` config.
- Caps at maxDelayMs (test attempt 10 with config { initialDelayMs: 1000, maxDelayMs: 60000 } -- result should not exceed 60000 * 1.3).
- Floor at 100ms: with very low initialDelayMs (e.g., 1ms) and attempt 0, result should be >= 100.
- Zero jitter: with `jitterFactor: 0`, returns exact exponential values.

`describe('reconnectLoop')`:
- Calls onStateChange('WS_ACTIVE') on successful connect. Create mock subscriber where `connect()` resolves, `waitForDisconnect()` resolves immediately (simulating disconnect). Use AbortController to abort after first cycle.
- Transitions to POLLING_FALLBACK after 3 consecutive connect failures. Mock subscriber where `connect()` always throws. Collect state changes and verify sequence: RECONNECTING x3, then POLLING_FALLBACK.
- Resets attempt counter on successful connect. Mock: first connect fails, second succeeds, third connect fails. Verify state goes RECONNECTING -> RECONNECTING -> WS_ACTIVE -> RECONNECTING (not POLLING_FALLBACK, because counter reset).
- Respects AbortSignal -- aborted signal stops the loop immediately.
- Respects maxAttempts -- returns after N attempts without infinite loop.
- Calls calculateDelay with correct attempt number (verify via timing or mock).

`describe('DEFAULT_RECONNECT_CONFIG')`:
- Has correct defaults: initialDelayMs=1000, maxDelayMs=60000, maxAttempts=Infinity, jitterFactor=0.3, pollingFallbackThreshold=3.

For reconnectLoop tests, use `vi.useFakeTimers()` with `vi.advanceTimersByTimeAsync()` to control sleep delays without waiting real time. Create mock subscribers with `vi.fn()` for connect and waitForDisconnect.

Important: Use `vi.useFakeTimers({ shouldAdvanceTime: true })` or manually advance timers to handle the sleep() calls in reconnectLoop. Alternatively, test with very short delay configs (initialDelayMs: 1, maxDelayMs: 10) to keep tests fast without fake timers.
  </action>
  <verify>
Run `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm vitest run --reporter=verbose packages/core/src/__tests__/connection-state.test.ts`. All tests pass.
  </verify>
  <done>
12+ tests pass covering calculateDelay exponential backoff (range, cap, floor, zero jitter), reconnectLoop state transitions (WS_ACTIVE on success, POLLING_FALLBACK after 3 failures, counter reset on success), AbortSignal support, maxAttempts limit, and DEFAULT_RECONNECT_CONFIG defaults.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo run typecheck --filter=@waiaas/core` -- 0 errors
2. `pnpm vitest run --reporter=verbose packages/core/src/__tests__/connection-state.test.ts` -- all tests pass
3. `ConnectionState`, `ReconnectConfig`, `calculateDelay`, `reconnectLoop`, `DEFAULT_RECONNECT_CONFIG` are importable from `@waiaas/core`
4. calculateDelay produces values in [100, maxDelayMs * 1.3] range
5. reconnectLoop transitions through RECONNECTING -> WS_ACTIVE on success, RECONNECTING -> POLLING_FALLBACK after 3 failures
6. AbortSignal stops reconnectLoop gracefully
</verification>

<success_criteria>
- ConnectionState type defines 3 states: WS_ACTIVE, POLLING_FALLBACK, RECONNECTING
- calculateDelay implements exponential backoff with jitter (1s base, 60s cap, +/-30%, 100ms floor)
- reconnectLoop manages state transitions: WS_ACTIVE on connect success, POLLING_FALLBACK after pollingFallbackThreshold consecutive failures
- reconnectLoop resets attempt counter on successful connect
- reconnectLoop supports AbortSignal for graceful shutdown
- DEFAULT_RECONNECT_CONFIG provides sensible defaults (1s/60s/Infinity/0.3/3)
- All types and functions exported from @waiaas/core barrel
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/225-chain-subscriber-implementations/225-03-SUMMARY.md`
</output>
