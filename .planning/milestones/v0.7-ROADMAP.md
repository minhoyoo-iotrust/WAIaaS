# Milestone v0.7: 구현 장애 요소 해소

**Status:** SHIPPED 2026-02-08
**Phases:** 26-30
**Total Plans:** 11

## Overview

v0.1~v0.6 설계 문서 전수 분석에서 도출된 25건의 구현 장애 요소(CRITICAL 7 + HIGH 10 + MEDIUM 8)를 해소한다. 기존 설계 문서(24~64번)를 직접 수정하여, 코드 작성 첫날부터 차단 없이 구현을 진행할 수 있는 상태를 만든다. 새 문서를 만들지 않고 기존 문서에 `[v0.7 보완]` 태그를 붙여 추적 가능하게 보완한다.

## Phases

### Phase 26: 체인 어댑터 안정화

**Goal**: 블록체인 트랜잭션이 설계대로 구현 시 런타임 장애 없이 동작하는 상태를 만든다
**Depends on**: Nothing (첫 번째 페이즈)
**Plans**: 2 plans

Plans:
- [x] 26-01-PLAN.md -- Solana blockhash freshness guard + EVM nonce 인터페이스 확장 (CHAIN-01, CHAIN-02)
- [x] 26-02-PLAN.md -- Keystore nonce 수학 정정 + Priority fee TTL 근거/bump 전략 (CHAIN-03, CHAIN-04)

**Details:**
- CHAIN-01: Solana blockhash freshness guard — signTransaction() 직전 잔여 수명 < 20초이면 blockhash 갱신
- CHAIN-02: IChainAdapter에 getCurrentNonce/resetNonceTracker 2개 메서드 추가 (17→19개)
- CHAIN-03: Keystore AES-256-GCM nonce 충돌 확률 Birthday Problem 정확한 수학적 근거로 정정
- CHAIN-04: Priority fee 캐시 TTL 30초 근거 명시 (Nyquist 기준) + 1.5배 fee bump 1회 재시도

**Success Criteria:**
1. ✓ Solana 트랜잭션 서명 직전 blockhash 잔여 수명을 검사하는 freshness guard 스펙 추가
2. ✓ IChainAdapter가 getCurrentNonce/resetNonceTracker 포함 19개 메서드로 확장
3. ✓ AES-256-GCM nonce 충돌 확률이 정확한 Birthday Problem 수식으로 정정
4. ✓ Priority fee 캐시 TTL 30초의 Nyquist 기준 근거 명시 + fee bump 전략 추가

### Phase 27: 데몬 보안 기반 확립

**Goal**: 데몬 프로세스의 보안 메커니즘이 구현 시 경쟁 조건이나 보안 수준 불일치 없이 동작하는 상태를 만든다
**Depends on**: Phase 26
**Plans**: 3 plans

Plans:
- [x] 27-01-PLAN.md -- JWT Secret dual-key rotation + flock 기반 인스턴스 잠금 (DAEMON-01, DAEMON-02)
- [x] 27-02-PLAN.md -- Rate Limiter 2단계 분리 + killSwitchGuard 허용 목록 확정 (DAEMON-03, DAEMON-04)
- [x] 27-03-PLAN.md -- Master Password Argon2id 통일 + 단일 인스턴스 SQLite nonce 옵션 (DAEMON-05, DAEMON-06)

**Details:**
- DAEMON-01: JWT Secret dual-key rotation — current/previous 5분 전환 윈도우
- DAEMON-02: flock 기반 인스턴스 잠금 — PID 파일 TOCTOU 제거, Windows 포트 바인딩 fallback
- DAEMON-03: Rate Limiter 2단계 — globalRateLimit(IP 1000/min) + sessionRateLimit(세션 300/min)
- DAEMON-04: killSwitchGuard 허용 4개 + 503 SYSTEM_LOCKED
- DAEMON-05: Master Password Argon2id 통일, SHA-256 폐기
- DAEMON-06: INonceStore Memory/SQLite 2종, nonce_storage config

**Success Criteria:**
1. ✓ JWT Secret이 current/previous dual-key 구조로 5분 전환 윈도우를 가짐
2. ✓ 데몬 인스턴스 잠금이 flock 기반으로 전환, PID 경쟁 조건 제거
3. ✓ Rate Limiter 2단계 분리로 미인증 공격자가 인증 사용자 rate limit 소진 불가
4. ✓ killSwitchGuard 허용 엔드포인트 4개 확정, Master Password Argon2id 통일

### Phase 28: 의존성 빌드 환경 해소

**Goal**: 모노레포 첫 빌드부터 의존성 충돌이나 네이티브 바이너리 문제 없이 빌드가 성공하는 상태를 만든다
**Depends on**: Phase 27
**Plans**: 1 plan

Plans:
- [x] 28-01-PLAN.md -- SIWE viem 전환 + Sidecar 크로스 컴파일 전략 (DEPS-01, DEPS-02)

**Details:**
- DEPS-01: SIWE 검증을 viem v2.x 내장 parseSiweMessage + verifyMessage로 전환, ethers/siwe 제거
- DEPS-02: 5개 타겟 플랫폼 확정, prebuildify 기반 네이티브 바이너리 번들 전략

**Success Criteria:**
1. ✓ SIWE 검증이 viem v2.x 내장으로 전환, ethers/siwe 완전 제거
2. ✓ Sidecar 크로스 컴파일 대상 5개 플랫폼 확정 + prebuildify 번들 전략 정의

### Phase 29: API 통합 프로토콜 완성

**Goal**: REST API, SDK, 플랫폼 통합의 모호한 스펙이 확정되어, 클라이언트 구현자가 추가 질문 없이 코딩할 수 있는 상태를 만든다
**Depends on**: Phase 27, Phase 28
**Plans**: 3 plans

Plans:
- [x] 29-01-PLAN.md -- Tauri 종료 타임아웃 35초 + CORS 3종 Origin + Setup Wizard CLI 위임 (API-01, API-02, API-05)
- [x] 29-02-PLAN.md -- Owner disconnect cascade 5단계 + TransactionType x Tier HTTP 응답 매트릭스 (API-03, API-04)
- [x] 29-03-PLAN.md -- Python SDK snake_case SSoT + Zod 스키마 @waiaas/core export 패턴 (API-06, API-07)

**Details:**
- API-01: Tauri sidecar 종료 타임아웃 5초→35초, SQLite integrity_check 복구
- API-02: CORS Origin Windows용 https://tauri.localhost 추가 (5종)
- API-03: Owner disconnect cascade 5단계 (APPROVAL→EXPIRED, DELAY유지, WC정리, 주소유지, 감사)
- API-04: 5개 TransactionType × 4 티어 HTTP 응답 status 매트릭스
- API-05: waiaas init idempotent + --json (Tauri sidecar IPC용)
- API-06: Python SDK WAIaaSBaseModel + alias_generator=to_camel SSoT
- API-07: @waiaas/core Zod 스키마 export, Python SDK field_validator 수동 매핑

**Success Criteria:**
1. ✓ Tauri sidecar 35초 + integrity_check + CORS 5종 Origin
2. ✓ Owner disconnect cascade 5단계 확정
3. ✓ TransactionType × Tier HTTP status 매트릭스 확정
4. ✓ waiaas init idempotent + Python SDK SSoT + Zod export 패턴 확정

### Phase 30: 스키마 설정 확정

**Goal**: 데이터베이스 스키마와 설정 파일의 미결정 사항이 모두 확정되어, 모든 변경의 데이터 모델이 완전한 상태를 만든다
**Depends on**: Phase 27, Phase 29
**Plans**: 2 plans

Plans:
- [x] 30-01-PLAN.md -- 환경변수 매핑 규칙 평탄화 + SQLite timestamp 초 단위 통일 (SCHEMA-01, SCHEMA-02)
- [x] 30-02-PLAN.md -- agents CHECK 제약 + network 값 통일 + Docker UID 1001 + amount TEXT 근거 + 채널 삭제 BEGIN IMMEDIATE (SCHEMA-03~06)

**Details:**
- SCHEMA-01: config.toml 환경변수 매핑 WAIAAS_{SECTION}_{KEY} 평탄화, 중첩 섹션 금지
- SCHEMA-02: SQLite 타임스탬프 전체 초 단위 통일, UUID v7 시간 정밀도 활용
- SCHEMA-03: agents 테이블 chain/network CHECK 제약조건 (ChainType/NetworkType Enum)
- SCHEMA-04: Docker 볼륨 UID 1001, WAIAAS_DATA_DIR, 소유권 확인 로직
- SCHEMA-05: amount TEXT 유지 근거 (JS Number < u64 < uint256), amount_lamports 유보
- SCHEMA-06: 알림 채널 삭제/비활성화 BEGIN IMMEDIATE 동시성 보호

**Success Criteria:**
1. ✓ config.toml 환경변수 매핑 규칙 평탄화 + Zod 중첩 감지 에러
2. ✓ SQLite 타임스탬프 초 단위 통일 + UUID v7 근거
3. ✓ agents CHECK 제약 + Docker UID 1001 + amount TEXT 근거 + 채널 BEGIN IMMEDIATE

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 26. 체인 어댑터 안정화 | 2/2 | ✓ Complete | 2026-02-08 |
| 27. 데몬 보안 기반 확립 | 3/3 | ✓ Complete | 2026-02-08 |
| 28. 의존성 빌드 환경 해소 | 1/1 | ✓ Complete | 2026-02-08 |
| 29. API 통합 프로토콜 완성 | 3/3 | ✓ Complete | 2026-02-08 |
| 30. 스키마 설정 확정 | 2/2 | ✓ Complete | 2026-02-08 |

---

## Milestone Summary

**Key Decisions:**

- Solana blockhash freshness guard: getBlockHeight() 사용, FRESHNESS_THRESHOLD_SECONDS=20초
- AES-GCM nonce 충돌: 매번 새 salt→새 AES 키→n=1, Birthday Problem 전제 미충족 (구조적 불가능)
- JWT Secret dual-key 5분 전환 윈도우 (고정값, 운영 복잡성 방지)
- flock exclusive non-blocking (Windows 포트 바인딩 fallback, PID 파일 보조 격하)
- Rate Limiter 2단계: globalRateLimit(IP 1000/min) + sessionRateLimit(세션 300/min)
- killSwitchGuard 503 SYSTEM_LOCKED (기존 401에서 변경), recover→/v1/admin/recover
- Master Password Argon2id 통일 (SHA-256 해시 전송 폐기, X-Master-Password 평문 localhost)
- SIWE viem/siwe 3단계 검증 (parse→validate→verifyMessage), ethers 완전 제거
- Tauri sidecar 종료 35초 (기존 5초), 4단계 종료 플로우 (HTTP→SIGTERM→SIGKILL)
- CORS 5종 Origin (macOS/Linux 2종 + Windows 2종 + http://localhost:1420 개발)
- Owner disconnect cascade 5단계, DELAY 유지 (Pitfall 3 방지)
- TransactionType 무관 원칙 (HTTP status 동일, 차이는 응답 type 필드로만)
- config.toml 중첩 섹션 금지, 17개 키 평탄화
- SQLite 타임스탬프 전체 초 단위, network 'mainnet' 통일

**Issues Resolved:**

- Solana sign 시점 blockhash 만료 경쟁 조건
- EVM nonce 관리 타입 불안전
- AES-GCM nonce 충돌 확률 오류 수학
- JWT Secret rotation 시 기존 세션 즉시 무효화 문제
- PID 파일 TOCTOU 경쟁 조건
- 미인증 공격자의 인증 사용자 rate limit 소진 가능성
- killSwitchGuard 허용 엔드포인트 미확정
- SHA-256 vs Argon2id 보안 수준 불일치
- ethers 130KB+ 불필요 의존성
- Tauri sidecar 5초 타임아웃으로 인한 SQLite WAL 손상 위험
- Owner disconnect 시 cascade 동작 미확정
- TransactionType별 HTTP status 모호
- config.toml 중첩 섹션과 환경변수 매핑 불일치
- SQLite 타임스탬프 정밀도 혼란 (밀리초 vs 초)

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None (0 anti-patterns, 0 integration violations)

---

_For current project status, see .planning/ROADMAP.md_
