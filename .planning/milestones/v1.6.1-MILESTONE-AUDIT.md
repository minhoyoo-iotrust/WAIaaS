---
milestone: v1.6.1
audited: 2026-02-16
status: tech_debt
scores:
  requirements: 24/24
  phases: 5/5
  integration: 18/18
  flows: 6/6
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: core (cross-phase)
    items:
      - "@waiaas/core 에러 코드 카운트 스냅샷 테스트 3개 실패 (86→90, WC 에러 코드 4개 추가 미반영)"
      - "@waiaas/core NotificationEventType 카운트 스냅샷 테스트 1개 실패 (24→25, APPROVAL_CHANNEL_SWITCHED 추가 미반영)"
  - phase: all (process)
    items:
      - "VERIFICATION.md 파일 5개 페이즈 모두 누락 (실행 시 verifier 미실행)"
      - "ROADMAP.md Progress 테이블 미갱신 (Phase 149/150 'Not started'으로 표시, 실제 완료)"
---

# v1.6.1 Milestone Audit: WalletConnect Owner 승인

**Audited:** 2026-02-16
**Status:** tech_debt (모든 요구사항 충족, 경미한 테스트 스냅샷 부채)

## Requirements Coverage (24/24)

| Requirement | Phase | Status | Evidence |
|-------------|-------|--------|----------|
| INFRA-01: SignClient 초기화/종료 | 146 | Satisfied | WcSessionService + DaemonLifecycle Step 4c-6/shutdown |
| INFRA-02: DB v16 마이그레이션 | 146 | Satisfied | wc_sessions, wc_store, approval_channel 추가 |
| INFRA-03: SqliteKeyValueStorage | 146 | Satisfied | IKeyValueStorage 5개 메서드 SQLite 구현 |
| INFRA-04: 세션 복구 | 146 | Satisfied | restoreSessions() wc_sessions→sessionMap 복원 |
| INFRA-05: Admin Settings WC 설정 | 146 | Satisfied | walletconnect.project_id + relay_url 설정, hot-reload 감지 |
| PAIR-01: pairing URI + QR | 147 | Satisfied | createPairing() → QR base64 dataURL |
| PAIR-02: QR 스캔 세션 성립 | 147 | Satisfied | waitForApproval() → wc_sessions INSERT + sessionMap |
| PAIR-03: 세션 상태 조회 | 147 | Satisfied | GET /v1/wallets/:id/wc/session + getSessionInfo() |
| PAIR-04: 세션 해제 | 147 | Satisfied | DELETE /v1/wallets/:id/wc/session + disconnectSession() |
| PAIR-05: Admin UI QR + 실시간 확인 | 147+150 | Satisfied | wallets.tsx QR 모달 + walletconnect.tsx 전용 페이지 |
| PAIR-06: CLI QR 터미널 출력 | 147 | Satisfied | owner connect --poll 명령, QRCode.toString(terminal) |
| SIGN-01: APPROVAL 시 WC 서명 요청 | 148 | Satisfied | stage4Wait → void wcSigningBridge.requestSignature() |
| SIGN-02: 서명 검증 후 승인 | 148 | Satisfied | verifySIWE/Ed25519 → approvalWorkflow.approve() |
| SIGN-03: WC 거부 시 reject | 148 | Satisfied | error code 4001/5000 → approvalWorkflow.reject() |
| SIGN-04: EVM + Solana 지원 | 148 | Satisfied | personal_sign + solana_signMessage 양 분기 |
| SIGN-05: approval_channel 기록 | 148 | Satisfied | UPDATE approval_channel='walletconnect' |
| SIGN-06: 타임아웃 동기화 | 148 | Satisfied | pending_approvals.expires_at → WC expiry (최소 60초) |
| FALL-01: WC 실패 → Telegram 전환 | 149 | Satisfied | fallbackToTelegram() 3개 guard + 2개 에러 분기 |
| FALL-02: 단일 승인 소스 원칙 | 149 | Satisfied | isApprovalStillPending() race condition 방지 |
| FALL-03: 채널 전환 EventBus 이벤트 | 149 | Satisfied | approval:channel-switched + APPROVAL_CHANNEL_SWITCHED 알림 |
| DX-01: Admin WC 세션 관리 페이지 | 150 | Satisfied | walletconnect.tsx 전용 페이지 + wallets.tsx WC 섹션 |
| DX-02: MCP WC 도구 | 150 | Satisfied | wc_connect, wc_status, wc_disconnect (18개 도구) |
| DX-03: SDK WC 메서드 | 150 | Satisfied | TS wcConnect/wcStatus/wcDisconnect + Python 동일 |
| DX-04: Skill 파일 업데이트 | 150 | Satisfied | wallet.skill.md 섹션 12: WalletConnect Session Management |

## Phase Verification (5/5)

| Phase | Plans | Tests Added | Self-Check | VERIFICATION.md |
|-------|-------|-------------|------------|-----------------|
| 146: WC 인프라 세팅 | 2/2 | 27 | PASSED | Missing |
| 147: QR 페어링 + REST API | 2/2 | 18 | PASSED | Missing |
| 148: WC 서명 요청 | 2/2 | 29 | PASSED | Missing |
| 149: Telegram Fallback | 2/2 | 13 | PASSED | Missing |
| 150: Admin UI + DX | 2/2 | 0 (SDK/MCP 기존 테스트) | PASSED | Missing |

**Total plans executed:** 10/10
**Total WC tests added:** 87 (69 daemon + MCP/SDK 기존)
**Test progression:** 1,524 → 1,551 → 1,569 → 1,598 → 1,611

## Integration Check (18/18 connected, 0 orphaned, 0 missing)

### Cross-Phase Wiring

| From | To | Export | Status |
|------|----|--------|--------|
| 146 | 147,148,149,150 | WcSessionService | Connected |
| 146 | WcSessionService | SqliteKeyValueStorage | Connected |
| 146 | All | DB v16 (wc_sessions, wc_store, approval_channel) | Connected |
| 147 | 148,150 | createPairing/getSessionInfo/disconnectSession/getPairingStatus | Connected |
| 147 | createPairing | CAIP2_CHAIN_IDS | Connected |
| 147 | Admin/CLI | REST API 4 endpoints | Connected |
| 148 | 149 | WcSigningBridge.requestSignature() | Connected |
| 148 | stages.ts | fire-and-forget via PipelineContext | Connected |
| 149 | WcSigningBridge | fallbackToTelegram() | Connected |
| 149 | EventBus | approval:channel-switched | Connected |
| 149 | NotificationService | APPROVAL_CHANNEL_SWITCHED | Connected |
| 150 | Admin | walletconnect.tsx 전용 페이지 | Connected |
| 150 | Admin | wallets.tsx WC 섹션 endpoints | Connected |
| 150 | MCP | wc_connect/wc_status/wc_disconnect tools | Connected |
| 150 | TS SDK | wcConnect/wcStatus/wcDisconnect methods | Connected |
| 150 | Python SDK | wc_connect/wc_status/wc_disconnect methods | Connected |
| 150 | CLI | owner connect/disconnect/status commands | Connected |
| 150 | Skills | wallet.skill.md 섹션 12 | Connected |

### DI Chain (Complete)

```
daemon.ts L503: WcSessionService 초기화
  ↓
daemon.ts L522: WcSigningBridge 초기화 (wcSessionService + approvalWorkflow)
  ↓
server.ts L333: transactionRoutes → wcSigningBridge
  ↓
transactions.ts L368: PipelineContext → wcSigningBridge
  ↓
stages.ts L550: stage4Wait → void ctx.wcSigningBridge.requestSignature()
```

### Auth Protection (Correct)

| Route Pattern | Auth | Applied |
|---------------|------|---------|
| `/v1/wallets/:id/wc/*` | masterAuth | server.ts L182 |
| `/v1/wallet/wc/*` | sessionAuth (wildcard) | server.ts L189 |

## E2E Flows (6/6)

| # | Flow | Status |
|---|------|--------|
| 1 | Agent tx → APPROVAL → stage4Wait → WcSigningBridge → Owner approve → pipeline resume | Complete |
| 2 | WC fail → fallbackToTelegram → approval_channel='telegram' → EventBus → Notification | Complete |
| 3 | Admin UI → QR 모달 → 3초 폴링 → 세션 성립 → 세션 관리 | Complete |
| 4 | CLI owner connect → QR 터미널 → --poll 대기 → 세션 성립 | Complete |
| 5 | MCP wc_connect → sessionAuth → POST /v1/wallet/wc/pair → QR 반환 | Complete |
| 6 | SDK wcConnect/wcStatus/wcDisconnect → sessionAuth → REST API | Complete |

## Tech Debt

### 1. @waiaas/core 스냅샷 테스트 (4개 실패)

| Test File | Test Name | Expected | Actual | Cause |
|-----------|-----------|----------|--------|-------|
| package-exports.test.ts | error codes are exported | 86 | 90 | WC_NOT_CONFIGURED, WC_SESSION_EXISTS, WC_SESSION_NOT_FOUND, WC_SIGNING_FAILED |
| i18n.test.ts | all error codes have messages | 86 | 90 | 동일 |
| error-codes.test.ts | has exactly 86 error codes | 86 | 90 | 동일 |
| enum-ssot.test.ts | NotificationEventType has 24 values | 24 | 25 | APPROVAL_CHANNEL_SWITCHED |

**영향:** 기능 정상, 테스트 기대값만 갱신 필요 (5분 이내 수정 가능)

### 2. VERIFICATION.md 누락 (5개 페이즈)

Phase 146-150 모두 VERIFICATION.md 파일 없음. SUMMARY.md Self-Check 결과로 대체 검증 가능하나, 공식 검증 프로세스 미수행.

### 3. ROADMAP.md 미갱신

Phase 149, 150이 "Not started"로 표시되어 있으나 실제로는 완료 상태. Progress 테이블 업데이트 필요.

## Build & Test Summary

| Package | Build | Tests |
|---------|-------|-------|
| @waiaas/core | PASS | 4 FAIL (스냅샷 카운트) |
| @waiaas/daemon | PASS | 1,611 PASS |
| @waiaas/adapter-solana | PASS | PASS |
| @waiaas/adapter-evm | PASS | 143 PASS |
| @waiaas/sdk | PASS | 121 PASS |
| @waiaas/mcp | PASS | 171 PASS |
| @waiaas/admin | PASS | PASS |
| @waiaas/cli | PASS | PASS |

---
*Milestone audit: v1.6.1 WalletConnect Owner 승인*
*Audited: 2026-02-16*
