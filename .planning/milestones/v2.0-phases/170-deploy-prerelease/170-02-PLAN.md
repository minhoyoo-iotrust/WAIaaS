---
phase: 170-deploy-prerelease
plan: 02
type: execute
wave: 2
depends_on: [170-01]
files_modified:
  - .github/workflows/release.yml
autonomous: false
requirements: [DEPLOY-02, DEPLOY-03]

must_haves:
  truths:
    - "release.yml publish-check job이 8개 publishable 패키지를 전수 검증한다"
    - "release.yml deploy job이 --dry-run 없이 실제 npm publish를 수행한다"
    - "release.yml docker-publish job이 GHCR + Docker Hub 양쪽에 이미지를 push한다"
    - "Docker Hub 자격증명(DOCKERHUB_USERNAME, DOCKERHUB_TOKEN)이 GitHub Secrets로 등록되고, waiaas/daemon Docker Hub 레포지토리가 존재한다"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "8패키지 publish + Docker Hub push + dry-run 제거된 배포 워크플로우"
      contains: "DOCKERHUB_USERNAME"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "packages/*/package.json"
      via: "npm publish 루프"
      pattern: "npm publish"
    - from: ".github/workflows/release.yml"
      to: "Docker Hub"
      via: "docker/login-action + build-push-action"
      pattern: "docker.io"
---

<objective>
Docker Hub push + release.yml dry-run 제거 + 전체 배포 파이프라인 활성화

Purpose: release.yml을 v2.0 실제 배포용으로 전환하여 release-please Release PR 머지 시 npm publish + Docker push가 자동 실행되게 한다
Output: 완전한 배포 워크플로우(8패키지 npm + GHCR + Docker Hub), Docker Hub 자격증명 설정 가이드
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: release.yml 전면 업데이트 -- 8패키지 publish + Docker Hub + dry-run 제거</name>
  <files>.github/workflows/release.yml</files>
  <action>
release.yml을 아래 3가지 영역에서 수정한다:

**A. publish-check job 확장 (4패키지 → 8패키지)**

현재 `for pkg in core sdk cli mcp` 루프를 8개 패키지로 확장한다. adapter 패키지는 경로가 `packages/adapters/solana`와 `packages/adapters/evm`으로 중첩되어 있으므로 단순 루프 대신 경로 배열을 사용:

```yaml
- name: npm publish dry-run
  run: |
    PACKAGES=(
      packages/core
      packages/daemon
      packages/cli
      packages/sdk
      packages/mcp
      packages/skills
      packages/adapters/solana
      packages/adapters/evm
    )
    for pkg_path in "${PACKAGES[@]}"; do
      echo "--- Checking $pkg_path ---"
      cd "$pkg_path"
      npm publish --dry-run 2>&1 || exit 1
      cd "$GITHUB_WORKSPACE"
    done
```

**B. deploy job: dry-run 제거 + 8패키지 실제 publish**

1. `npm publish (dry-run)` step을 실제 `npm publish`로 변경:
   - `--dry-run` 플래그 제거
   - `--access public` 추가 (scoped 패키지는 기본 restricted)
   - 8개 패키지 전체로 확장 (publish-check과 동일한 PACKAGES 배열)
   - `NODE_AUTH_TOKEN` 환경변수 유지

2. npmjs.com 인증 설정 추가:
   ```yaml
   - name: Setup npmrc
     run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
     env:
       NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
   ```

3. Deploy summary step 업데이트:
   - "dry-run (activate in v2.0)" → "published to npm"
   - Docker Hub 정보 추가

**C. docker-publish job: Docker Hub 추가**

기존 GHCR push를 유지하면서 Docker Hub push를 추가한다:

1. Docker Hub 로그인 step 추가 (GHCR 로그인 뒤):
   ```yaml
   - name: Login to Docker Hub
     uses: docker/login-action@v3
     with:
       username: ${{ secrets.DOCKERHUB_USERNAME }}
       password: ${{ secrets.DOCKERHUB_TOKEN }}
   ```

2. Docker metadata에 Docker Hub 이미지 추가:
   ```yaml
   images: |
     ghcr.io/${{ github.repository }}
     waiaas/daemon
   ```
   이렇게 하면 동일 태그가 GHCR과 Docker Hub 양쪽에 적용된다.

3. 태그 패턴에 RC pre-release 지원 추가:
   ```yaml
   tags: |
     type=raw,value=latest,enable=${{ !contains(github.event.release.tag_name, '-') }}
     type=semver,pattern=v{{version}}
     type=semver,pattern=v{{major}},enable=${{ !contains(github.event.release.tag_name, '-') }}
     type=semver,pattern=v{{major}}.{{minor}},enable=${{ !contains(github.event.release.tag_name, '-') }}
   ```
   RC 태그(v2.0.0-rc.1)에서는 latest, major, major.minor 태그를 생성하지 않고 full version만 태깅한다.

주의: docker-publish의 `if: github.event_name == 'release'` 조건은 유지한다 (workflow_dispatch에서는 Docker push 안 함).
  </action>
  <verify>
`cat .github/workflows/release.yml | grep -c "dry-run"` 결과가 publish-check의 1개만 남고 deploy에는 없어야 한다. `grep "DOCKERHUB" .github/workflows/release.yml`로 Docker Hub 자격증명 참조 확인. `grep -c "packages/" .github/workflows/release.yml`로 8개 패키지 경로가 publish-check과 deploy 양쪽에 존재 확인.
  </verify>
  <done>release.yml이 8개 패키지 npm publish(실제) + GHCR + Docker Hub 이미지 push를 수행하도록 업데이트됨</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Docker Hub 자격증명 GitHub Secrets 설정</name>
  <action>Docker Hub에 로그인하여 Access Token을 생성하고, GitHub 리포지토리 Secrets에 등록한다.</action>
  <how-to-verify>
아래 단계를 수행해 주세요:

1. **Docker Hub Access Token 생성:**
   - https://hub.docker.com/settings/security 접속
   - "New Access Token" 클릭
   - Description: "waiaas-github-actions"
   - Access permissions: "Read, Write, Delete"
   - 토큰 복사

2. **GitHub Secrets 등록:**
   - https://github.com/minho-yoo/waiaas/settings/secrets/actions 접속
   - "New repository secret" 으로 두 개 등록:
     - Name: `DOCKERHUB_USERNAME` / Value: Docker Hub 사용자명
     - Name: `DOCKERHUB_TOKEN` / Value: 위에서 생성한 Access Token

3. **Docker Hub에 waiaas/daemon 레포지토리 생성:**
   - https://hub.docker.com/repositories 접속
   - "Create Repository" 클릭
   - Name: `daemon`, Namespace: `waiaas` (또는 개인 계정)
   - Visibility: Public

4. **검증:**
   - GitHub Actions 탭에서 release.yml 워크플로우의 Secrets 참조 확인
   - `docker login -u $DOCKERHUB_USERNAME --password-stdin` 테스트 (선택)
  </how-to-verify>
  <verify>GitHub Secrets에 DOCKERHUB_USERNAME, DOCKERHUB_TOKEN 등록 확인</verify>
  <done>Docker Hub Access Token이 GitHub Secrets로 등록되고 waiaas/daemon 레포지토리가 Docker Hub에 존재하는 상태</done>
  <resume-signal>"Docker Hub secrets 설정 완료" 또는 문제 설명</resume-signal>
</task>

</tasks>

<verification>
1. release.yml publish-check: 8개 패키지 경로 존재
2. release.yml deploy: --dry-run 플래그 없음, --access public 존재, 8개 패키지
3. release.yml docker-publish: GHCR + Docker Hub 양쪽 로그인 + 이미지 태그
4. Docker Hub secrets (DOCKERHUB_USERNAME, DOCKERHUB_TOKEN) GitHub에 등록됨
5. RC 태그에서는 latest/major 태그 생성 안 함
</verification>

<success_criteria>
release.yml deploy job이 dry-run 없이 8개 npm 패키지를 실제 publish하고, docker-publish가 GHCR + Docker Hub 양쪽에 이미지를 push하며, Docker Hub 자격증명이 GitHub Secrets로 설정된 상태
</success_criteria>

<output>
After completion, create `.planning/phases/170-deploy-prerelease/170-02-SUMMARY.md`
</output>
