---
phase: 167-test-gates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/coverage-gate.sh
  - scripts/verify-enum-ssot.ts
  - packages/core/vitest.config.ts
  - packages/daemon/vitest.config.ts
  - packages/adapters/solana/vitest.config.ts
  - packages/sdk/vitest.config.ts
autonomous: true
requirements: [TEST-02, TEST-03]

must_haves:
  truths:
    - "전체 코드베이스 커버리지가 Hard 80% 게이트를 통과한다"
    - "패키지별 커버리지 리포트(coverage-summary.json)가 생성된다"
    - "Enum SSoT 16개가 빌드타임 4단계 검증을 통과한다"
    - "COVERAGE_GATE_MODE=hard bash scripts/coverage-gate.sh 가 exit code 0을 반환한다"
    - "pnpm run verify:enums 가 exit code 0을 반환한다"
  artifacts:
    - path: "scripts/coverage-gate.sh"
      provides: "패키지별 커버리지 게이트 검증 스크립트"
    - path: "scripts/verify-enum-ssot.ts"
      provides: "16 enums 4-stage 빌드타임 검증"
    - path: "packages/core/coverage/coverage-summary.json"
      provides: "@waiaas/core 커버리지 리포트"
    - path: "packages/daemon/coverage/coverage-summary.json"
      provides: "@waiaas/daemon 커버리지 리포트"
  key_links:
    - from: "scripts/coverage-gate.sh"
      to: "packages/*/coverage/coverage-summary.json"
      via: "jq .total.lines.pct 파싱"
      pattern: "jq.*total\\.lines\\.pct"
    - from: "scripts/verify-enum-ssot.ts"
      to: "packages/core/src/index.js"
      via: "SSoT 배열 + Zod enum import"
      pattern: "import.*CHAIN_TYPES.*ChainTypeEnum"
---

<objective>
커버리지 Hard 80% 게이트 통과 + Enum SSoT 16개 빌드타임 4단계 검증 통과를 달성한다.

Purpose: v2.0 릴리스 품질 기준 중 코드 커버리지와 타입 일관성 보증. 4개 핵심 패키지(core 90%, daemon 85%, solana 80%, sdk 80%)의 라인 커버리지가 임계치를 넘고, 16개 enum이 Zod → TS → DB CHECK 전 계층에서 일관됨을 빌드타임에 보증한다.
Output: 커버리지 게이트 통과 (hard 모드) + Enum SSoT 검증 통과
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/coverage-gate.sh
@scripts/verify-enum-ssot.ts
@packages/core/vitest.config.ts
@packages/daemon/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 커버리지 Hard 게이트 실행 + 미달 패키지 보강</name>
  <files>
    scripts/coverage-gate.sh
    packages/core/vitest.config.ts
    packages/daemon/vitest.config.ts
    packages/adapters/solana/vitest.config.ts
    packages/sdk/vitest.config.ts
  </files>
  <action>
  1. `pnpm turbo run build` 후 `pnpm turbo run test:unit -- --coverage` 실행하여 4개 패키지 커버리지 수집
  2. `COVERAGE_GATE_MODE=hard bash scripts/coverage-gate.sh` 실행
  3. 각 패키지의 커버리지 임계치 확인:
     - packages/core: lines >= 90%
     - packages/daemon: lines >= 85%
     - packages/adapters/solana: lines >= 80%
     - packages/sdk: lines >= 80%
  4. 미달 패키지가 있으면:
     - 커버리지가 부족한 모듈을 식별 (coverage-summary.json의 개별 파일 분석)
     - 커버리지가 낮은 핵심 모듈에 누락된 분기/함수 테스트 추가
     - 또는 테스트 불가능한 코드(외부 의존성 글루 코드)를 exclude에 추가
  5. 모든 패키지가 임계치를 통과할 때까지 반복
  6. 이미 모든 패키지가 통과하면 통과 확인만 수행
  </action>
  <verify>
  `COVERAGE_GATE_MODE=hard bash scripts/coverage-gate.sh` exit code 0
  4개 패키지 모두 "OK" 출력
  </verify>
  <done>4개 핵심 패키지 커버리지가 Hard 게이트 임계치를 통과하고 패키지별 coverage-summary.json이 생성됨</done>
</task>

<task type="auto">
  <name>Task 2: Enum SSoT 16개 빌드타임 4단계 검증</name>
  <files>scripts/verify-enum-ssot.ts</files>
  <action>
  1. `pnpm turbo run build` 후 `pnpm run verify:enums` 실행
  2. 4단계 검증 확인:
     - Step 1: SSoT 배열 <-> Zod enum.options 일치
     - Step 2: 배열 내 중복값 없음
     - Step 3: DB CHECK 제약 조건이 SSoT 배열과 일치 (in-memory SQLite로 검증)
     - Step 4: 값 개수 스냅샷 일치 (의도하지 않은 추가/삭제 감지)
  3. 실패 시:
     - Step 1/2 실패: core 패키지의 enum 정의 수정
     - Step 3 실패: Drizzle 스키마의 CHECK 제약 수정
     - Step 4 실패: expectedCount 업데이트 (의도적 변경인 경우) 또는 enum 정의 수정
  4. 이미 16개 전수 통과하면 통과 확인만 수행

  **16개 enum 목록**: ChainType, NetworkType, SolanaNetworkType, EvmNetworkType, EnvironmentType, WalletStatus, TransactionStatus, TransactionType, PolicyType, PolicyTier, SessionStatus, NotificationEventType, NotificationLogStatus, AuditAction, KillSwitchState, OwnerState
  </action>
  <verify>
  `pnpm run verify:enums` exit code 0
  "16 enums verified across 4 stages. All checks passed." 출력
  </verify>
  <done>Enum SSoT 16개가 빌드타임 4단계 검증(Zod → TS → OpenAPI → Drizzle CHECK)을 전수 통과</done>
</task>

</tasks>

<verification>
- `COVERAGE_GATE_MODE=hard bash scripts/coverage-gate.sh` → exit code 0
- `pnpm run verify:enums` → exit code 0, "16 enums verified" 출력
- nightly.yml full-suite job과 동일한 검증이 로컬에서 통과
</verification>

<success_criteria>
- 전체 코드베이스 커버리지가 Hard 80% 게이트를 통과하며, 패키지별 커버리지 리포트가 생성된다
- Enum SSoT 16개가 빌드타임 4단계 검증을 통과한다
- TEST-02, TEST-03 요구사항 충족
</success_criteria>

<output>
After completion, create `.planning/phases/167-test-gates/167-02-SUMMARY.md`
</output>
