---
phase: 166-design-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/validate-openapi.ts
  - package.json
  - .github/workflows/ci.yml
autonomous: true
requirements:
  - VERIFY-03

must_haves:
  truths:
    - "GET /doc 엔드포인트에서 생성된 OpenAPI 3.0 스펙이 유효성 검증 도구로 0 errors를 통과한다"
    - "OpenAPI 유효성 검증이 CI 파이프라인에 통합되어 PR/push 시 자동 실행된다"
    - "검증 스크립트를 로컬에서 `pnpm run validate:openapi` 명령으로 실행할 수 있다"
  artifacts:
    - path: "scripts/validate-openapi.ts"
      provides: "OpenAPI 스펙 유효성 검증 스크립트"
      contains: "SwaggerParser.validate"
    - path: "package.json"
      provides: "validate:openapi 스크립트 등록"
      contains: "validate:openapi"
    - path: ".github/workflows/ci.yml"
      provides: "CI 파이프라인에 OpenAPI 검증 step 추가"
      contains: "Validate OpenAPI"
  key_links:
    - from: "scripts/validate-openapi.ts"
      to: "packages/daemon/src/api/server.ts"
      via: "createApp() 호출 -> GET /doc 요청 -> 스펙 JSON 추출 -> SwaggerParser.validate()"
      pattern: "createApp|/doc|validate"
    - from: ".github/workflows/ci.yml"
      to: "scripts/validate-openapi.ts"
      via: "pnpm run validate:openapi"
      pattern: "validate:openapi"
---

<objective>
OpenAPI 3.0 스펙(GET /doc 엔드포인트)의 유효성을 검증하는 스크립트를 작성하고 CI에 통합하여, 스펙에 에러가 0건임을 자동으로 보증한다.

Purpose: API 소비자(SDK, MCP, 외부 개발자)가 정확한 OpenAPI 스펙을 기반으로 클라이언트를 생성할 수 있도록 보증한다. CI에서 자동 검증하여 회귀를 방지한다.
Output: scripts/validate-openapi.ts (검증 스크립트), package.json (스크립트 등록), .github/workflows/ci.yml (CI 통합)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/daemon/src/api/server.ts
@packages/daemon/src/__tests__/api-server.test.ts
@.github/workflows/ci.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: @apidevtools/swagger-parser 도입 + 검증 스크립트 작성</name>
  <files>
    scripts/validate-openapi.ts
    package.json
  </files>
  <action>
1. `@apidevtools/swagger-parser`를 루트 devDependencies에 추가한다:
   ```bash
   pnpm add -D -w @apidevtools/swagger-parser @types/swagger-schema-official
   ```
   (swagger-parser가 OpenAPI 3.0/3.1 JSON 검증을 지원하며, `swagger-cli validate`의 프로그래매틱 버전이다)

2. `scripts/validate-openapi.ts` 파일을 생성한다:
   - daemon 패키지의 `createApp()`을 import하여 테스트용 Hono 앱을 생성한다
   - 기존 테스트(api-server.test.ts의 `createTestApp()` 패턴)를 참고하여 의존성 stub을 구성한다
   - GET /doc 엔드포인트에 요청하여 OpenAPI JSON을 추출한다
   - `SwaggerParser.validate(spec)`으로 유효성 검증을 수행한다
   - 결과를 stdout에 출력한다: 성공 시 "OpenAPI spec valid (0 errors)", 실패 시 에러 목록 + exit code 1
   - 참고: daemon의 createApp은 db, keystore 등 의존성이 필요하므로, 검증 스크립트에서는 실제 daemon을 기동하지 않고 GET /doc에서 반환하는 JSON을 직접 파일로 덤프하거나, 더 간단하게 createApp에 최소한의 stub을 전달하는 방식을 사용한다
   - 대안 접근: api-server.test.ts에서 사용하는 `createTestApp()` 헬퍼와 동일한 방식으로 mock 의존성을 주입하여 app 인스턴스를 생성하고, `app.request('/doc')` 호출로 스펙을 추출한다. 이 방식이 실제 Hono 라우트 등록을 거치므로 가장 정확하다.
   - 만약 의존성 주입이 복잡하면: `tsx scripts/validate-openapi.ts` 실행 시 먼저 daemon을 잠깐 기동하여 `/doc`에서 JSON을 fetch한 후 검증하는 2단계 접근도 가능하다. 단 이 경우 DB 파일이나 config가 필요할 수 있으므로 임시 디렉토리를 사용한다.
   - **가장 간단한 접근**: api-server.test.ts의 `createTestApp()` 패턴을 그대로 복제하여 스크립트에서 사용한다. 이미 테스트에서 검증된 패턴이므로 안정적이다.

3. package.json의 scripts에 `"validate:openapi": "tsx scripts/validate-openapi.ts"` 를 추가한다.

4. 스크립트를 실행하여 현재 OpenAPI 스펙이 0 errors를 통과하는지 확인한다:
   ```bash
   pnpm run validate:openapi
   ```
   에러가 발견되면 해당 라우트 정의를 수정하여 0 errors를 달성한다.

주의사항:
- @apidevtools/swagger-parser는 ESM/CJS 호환성이 까다로울 수 있다. tsx가 처리해 줄 것으로 예상하지만, import 문제 발생 시 dynamic import나 CJS 래퍼를 사용한다.
- OpenAPI 3.0.0 스펙을 검증한다 (Hono가 3.0.0을 생성하므로).
  </action>
  <verify>
`pnpm run validate:openapi` 실행 시 exit code 0 + "OpenAPI spec valid" 메시지 출력. `cat package.json | grep validate:openapi` 결과가 존재.
  </verify>
  <done>scripts/validate-openapi.ts가 존재하고, pnpm run validate:openapi가 0 errors로 통과하며, package.json에 스크립트가 등록되어 있다.</done>
</task>

<task type="auto">
  <name>Task 2: CI 파이프라인에 OpenAPI 검증 step 추가</name>
  <files>.github/workflows/ci.yml</files>
  <action>
.github/workflows/ci.yml의 stage2 job에 OpenAPI 유효성 검증 step을 추가한다:

1. 위치: "Verify Enum SSoT" step 바로 다음에 배치한다 (빌드 후 검증 단계에 해당)
2. step 내용:
   ```yaml
   - name: Validate OpenAPI Spec
     run: pnpm run validate:openapi
   ```

3. 이 step은 stage2(PR only + full suite)에만 추가한다. stage1(affected only)에는 추가하지 않는다 — OpenAPI 스펙은 전체 라우트가 등록된 상태에서만 의미있으므로 full build 이후에 검증해야 한다.

4. nightly.yml에도 동일한 step 추가를 고려하되, nightly가 이미 stage2를 포함하거나 full suite를 실행한다면 중복이므로 ci.yml만 수정한다.
  </action>
  <verify>
`grep "Validate OpenAPI" .github/workflows/ci.yml` 결과가 존재하고, "Verify Enum SSoT" step 다음에 위치한다. YAML 문법이 유효한지 `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` 또는 유사한 방법으로 확인.
  </verify>
  <done>ci.yml stage2에 "Validate OpenAPI Spec" step이 추가되어 있고, YAML 문법이 유효하다.</done>
</task>

</tasks>

<verification>
1. `pnpm run validate:openapi` 실행 시 exit code 0
2. scripts/validate-openapi.ts가 GET /doc 스펙을 추출하여 SwaggerParser.validate()를 수행한다
3. .github/workflows/ci.yml에 "Validate OpenAPI Spec" step이 존재한다
4. YAML 문법이 유효하다
</verification>

<success_criteria>
- OpenAPI 3.0 스펙이 유효성 검증 도구로 0 errors를 통과한다
- 검증이 CI에 통합되어 자동 실행된다
- 로컬에서 pnpm run validate:openapi로 실행 가능하다
- VERIFY-03 요구사항이 충족된다
</success_criteria>

<output>
After completion, create `.planning/phases/166-design-verification/166-02-SUMMARY.md`
</output>
