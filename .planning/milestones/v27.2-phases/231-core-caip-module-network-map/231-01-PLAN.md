---
phase: 231-core-caip-module-network-map
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/caip/caip2.ts
  - packages/core/src/caip/caip19.ts
  - packages/core/src/caip/index.ts
  - packages/core/src/__tests__/caip.test.ts
autonomous: true
requirements:
  - CAIP-01
  - CAIP-02
  - CAIP-03
  - CAIP-04
  - CAIP-05

must_haves:
  truths:
    - "parseCaip2('eip155:1') returns { namespace: 'eip155', reference: '1' }"
    - "formatCaip2('eip155', '1') returns 'eip155:1'"
    - "parseCaip19('eip155:1/erc20:0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48') returns correct chainId, assetNamespace, assetReference"
    - "formatCaip19('eip155:1', 'erc20', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48') returns correct CAIP-19 URI"
    - "parseCaip2(formatCaip2(ns, ref)) roundtrip preserves data for all valid inputs"
    - "parseCaip19(formatCaip19(chainId, ns, ref)) roundtrip preserves data for all valid inputs"
    - "Caip2Schema rejects malformed strings and accepts valid CAIP-2 strings including underscore references"
    - "Caip19Schema rejects malformed strings and accepts valid CAIP-19 strings including .% in asset reference"
  artifacts:
    - path: "packages/core/src/caip/caip2.ts"
      provides: "CAIP-2 parser, formatter, Zod schema, types"
      exports: ["Caip2Schema", "Caip2", "Caip2Params", "parseCaip2", "formatCaip2"]
    - path: "packages/core/src/caip/caip19.ts"
      provides: "CAIP-19 parser, formatter, Zod schema, types"
      exports: ["Caip19AssetTypeSchema", "Caip19Schema", "Caip19", "Caip19Params", "parseCaip19", "formatCaip19"]
    - path: "packages/core/src/caip/index.ts"
      provides: "Barrel export for caip module"
    - path: "packages/core/src/__tests__/caip.test.ts"
      provides: "Comprehensive test suite for CAIP-2/19 parsing, formatting, validation"
      min_lines: 100
  key_links:
    - from: "packages/core/src/caip/caip19.ts"
      to: "packages/core/src/caip/caip2.ts"
      via: "import Caip2Schema for chainId validation within CAIP-19"
      pattern: "import.*Caip2Schema.*from.*caip2"
    - from: "packages/core/src/caip/index.ts"
      to: "packages/core/src/caip/caip2.ts"
      via: "barrel re-export"
      pattern: "export.*from.*caip2"
    - from: "packages/core/src/caip/index.ts"
      to: "packages/core/src/caip/caip19.ts"
      via: "barrel re-export"
      pattern: "export.*from.*caip19"
---

<objective>
Implement the CAIP-2 and CAIP-19 parser/formatter module with Zod validation schemas, following TDD (RED-GREEN-REFACTOR).

Purpose: Provide spec-compliant CAIP-2 (chain ID) and CAIP-19 (asset type URI) parsing and formatting as the foundation for all subsequent CAIP work in phases 231-02, 232, 233, 234. Zero new npm dependencies -- pure Zod + TypeScript.

Output: 3 source files in `packages/core/src/caip/` (caip2.ts, caip19.ts, index.ts) + 1 test file with comprehensive coverage of parsing, formatting, roundtrip, validation, and edge cases.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/231-core-caip-module-network-map/231-RESEARCH.md
@packages/core/src/enums/chain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CAIP-2/19 test suite (RED phase)</name>
  <files>
    packages/core/src/__tests__/caip.test.ts
  </files>
  <action>
Create test file `packages/core/src/__tests__/caip.test.ts` with the following test groups. All tests should import from `../caip/index.js` (the module barrel). Tests will FAIL because the source files don't exist yet.

**Test groups:**

1. **Caip2Schema validation** (~8 tests):
   - Accepts `eip155:1`, `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp`, `eip155:11155111`, `eip155:137`
   - Accepts underscore references: `starknet:SN_GOERLI` (per spec, `[-_a-zA-Z0-9]{1,32}`)
   - Rejects empty string, no-colon strings, namespace too long (>8 chars), namespace with uppercase, reference too long (>32 chars), special chars not in `[-_a-zA-Z0-9]`

2. **parseCaip2()** (~5 tests):
   - Parses `eip155:1` -> `{ namespace: 'eip155', reference: '1' }`
   - Parses `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp` -> correct components
   - Parses `eip155:11155111` -> `{ namespace: 'eip155', reference: '11155111' }`
   - Throws ZodError for `eip155` (no colon) -- NOTE: new parseCaip2 uses Zod, not custom error
   - Throws ZodError for empty string

3. **formatCaip2()** (~4 tests):
   - `formatCaip2('eip155', '1')` returns `'eip155:1'`
   - `formatCaip2('solana', '5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp')` returns correct string
   - Throws ZodError for invalid namespace (e.g., 'INVALID' -- uppercase not allowed)
   - Throws ZodError for empty reference

4. **CAIP-2 roundtrip** (~2 tests):
   - `parseCaip2(formatCaip2('eip155', '1'))` returns `{ namespace: 'eip155', reference: '1' }`
   - `formatCaip2(parseCaip2('solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp').namespace, parseCaip2(...).reference)` equals original

5. **Caip19Schema / Caip19AssetTypeSchema validation** (~8 tests):
   - Accepts `eip155:1/slip44:60`, `eip155:1/erc20:0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48`
   - Accepts `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/slip44:501`
   - Accepts `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v`
   - Accepts asset reference with `.` and `%` characters (spec allows `[-.%a-zA-Z0-9]{1,128}`)
   - Rejects empty string, missing `/`, missing asset namespace, asset reference >128 chars
   - Caip19Schema is same reference as Caip19AssetTypeSchema (alias)

6. **parseCaip19()** (~5 tests):
   - Parses `eip155:1/slip44:60` -> `{ chainId: 'eip155:1', assetNamespace: 'slip44', assetReference: '60' }`
   - Parses `eip155:1/erc20:0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48` -> correct components
   - Parses `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v` -> correct components
   - Throws ZodError for `eip155:1` (missing asset part)
   - Throws ZodError for empty string

7. **formatCaip19()** (~4 tests):
   - `formatCaip19('eip155:1', 'slip44', '60')` returns `'eip155:1/slip44:60'`
   - `formatCaip19('eip155:1', 'erc20', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48')` returns correct string
   - Throws ZodError for invalid chain ID component
   - Throws ZodError for invalid asset namespace (uppercase)

8. **CAIP-19 roundtrip** (~2 tests):
   - `parseCaip19(formatCaip19(...))` identity for EVM token
   - `parseCaip19(formatCaip19(...))` identity for Solana token

Import: `import { Caip2Schema, Caip19Schema, Caip19AssetTypeSchema, parseCaip2, formatCaip2, parseCaip19, formatCaip19 } from '../caip/index.js';`
Also import `{ ZodError } from 'zod'` for error type assertions.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec vitest run src/__tests__/caip.test.ts 2>&1 | tail -5` -- expected: ALL tests FAIL (module not found). This confirms RED phase.
  </verify>
  <done>Test file exists at packages/core/src/__tests__/caip.test.ts with ~38 test cases covering all 8 groups. All tests fail because source module does not exist yet.</done>
</task>

<task type="auto">
  <name>Task 2: Implement CAIP-2/19 module (GREEN phase)</name>
  <files>
    packages/core/src/caip/caip2.ts
    packages/core/src/caip/caip19.ts
    packages/core/src/caip/index.ts
  </files>
  <action>
Create the `packages/core/src/caip/` directory and implement 3 files:

**1. `packages/core/src/caip/caip2.ts`:**

```typescript
import { z } from 'zod';

// CAIP-2 spec: namespace = [-a-z0-9]{3,8}, reference = [-_a-zA-Z0-9]{1,32}
// Source: standards.chainagnostic.org/CAIPs/caip-2
// IMPORTANT: reference includes underscore per official spec (e.g., SN_GOERLI)
export const Caip2Schema = z.string().regex(
  /^[-a-z0-9]{3,8}:[-_a-zA-Z0-9]{1,32}$/,
  'Invalid CAIP-2 chain ID format (expected namespace:reference)',
);
export type Caip2 = z.infer<typeof Caip2Schema>;

export interface Caip2Params {
  namespace: string;
  reference: string;
}

export function parseCaip2(chainId: string): Caip2Params {
  Caip2Schema.parse(chainId);
  const idx = chainId.indexOf(':');
  return {
    namespace: chainId.slice(0, idx),
    reference: chainId.slice(idx + 1),
  };
}

export function formatCaip2(namespace: string, reference: string): string {
  const result = `${namespace}:${reference}`;
  Caip2Schema.parse(result);
  return result;
}
```

**2. `packages/core/src/caip/caip19.ts`:**

```typescript
import { z } from 'zod';

// CAIP-19 asset type: chainId/assetNamespace:assetReference
// chainId = CAIP-2 (namespace:reference)
// assetNamespace = [-a-z0-9]{3,8}
// assetReference = [-.%a-zA-Z0-9]{1,128}
// Source: standards.chainagnostic.org/CAIPs/caip-19
export const Caip19AssetTypeSchema = z.string().regex(
  /^[-a-z0-9]{3,8}:[-_a-zA-Z0-9]{1,32}\/[-a-z0-9]{3,8}:[-.%a-zA-Z0-9]{1,128}$/,
  'Invalid CAIP-19 asset type format (expected chainId/namespace:reference)',
);
export type Caip19AssetType = z.infer<typeof Caip19AssetTypeSchema>;

// Convenience alias: WAIaaS only handles fungible tokens -> AssetType is sufficient
export const Caip19Schema = Caip19AssetTypeSchema;
export type Caip19 = Caip19AssetType;

export interface Caip19Params {
  chainId: string;        // CAIP-2 chain ID
  assetNamespace: string; // e.g., "slip44", "erc20", "token"
  assetReference: string; // e.g., "60", "0xa0b8...", "EPjF..."
}

export function parseCaip19(assetType: string): Caip19Params {
  Caip19AssetTypeSchema.parse(assetType);
  const slashIdx = assetType.indexOf('/');
  const chainId = assetType.slice(0, slashIdx);
  const assetPart = assetType.slice(slashIdx + 1);
  const colonIdx = assetPart.indexOf(':');
  return {
    chainId,
    assetNamespace: assetPart.slice(0, colonIdx),
    assetReference: assetPart.slice(colonIdx + 1),
  };
}

export function formatCaip19(
  chainId: string,
  assetNamespace: string,
  assetReference: string,
): string {
  const result = `${chainId}/${assetNamespace}:${assetReference}`;
  Caip19AssetTypeSchema.parse(result);
  return result;
}
```

**3. `packages/core/src/caip/index.ts`:**

Barrel export all public API from caip2.ts and caip19.ts:

```typescript
// CAIP-2 (chain ID)
export { Caip2Schema, type Caip2, type Caip2Params, parseCaip2, formatCaip2 } from './caip2.js';

// CAIP-19 (asset type)
export {
  Caip19AssetTypeSchema,
  Caip19Schema,
  type Caip19AssetType,
  type Caip19,
  type Caip19Params,
  parseCaip19,
  formatCaip19,
} from './caip19.js';
```

NOTE: index.ts will be extended in plan 231-02 with network-map.ts and asset-helpers.ts exports.
  </action>
  <verify>
`cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec vitest run src/__tests__/caip.test.ts` -- ALL tests PASS. This confirms GREEN phase.
  </verify>
  <done>All ~38 CAIP-2/19 tests pass. parseCaip2, formatCaip2, parseCaip19, formatCaip19 work correctly with Zod validation. Caip2Schema and Caip19Schema validate spec-compliant strings. Roundtrip fidelity confirmed.</done>
</task>

</tasks>

<verification>
1. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec vitest run src/__tests__/caip.test.ts` -- all tests pass
2. `cd /Users/minho.yoo/dev/wallet/WAIaaS && pnpm --filter @waiaas/core exec tsc --noEmit` -- no TypeScript errors in core package
3. Verify roundtrip fidelity: parse(format(x)) === x for all tested CAIP-2 and CAIP-19 values
4. Verify Caip2Schema accepts underscore in reference (e.g., `starknet:SN_GOERLI`)
5. Verify Caip19Schema accepts `.` and `%` in asset reference
</verification>

<success_criteria>
- packages/core/src/caip/caip2.ts exists with parseCaip2, formatCaip2, Caip2Schema exports
- packages/core/src/caip/caip19.ts exists with parseCaip19, formatCaip19, Caip19Schema, Caip19AssetTypeSchema exports
- packages/core/src/caip/index.ts barrel-exports all public API
- All ~38 tests in caip.test.ts pass
- TypeScript compiles without errors
- Zero new npm dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/231-core-caip-module-network-map/231-01-SUMMARY.md`
</output>
