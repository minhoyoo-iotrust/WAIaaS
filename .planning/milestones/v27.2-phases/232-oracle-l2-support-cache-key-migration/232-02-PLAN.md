---
phase: 232-oracle-l2-support-cache-key-migration
plan: 02
type: tdd
wave: 2
depends_on: [232-01]
files_modified:
  - packages/daemon/src/__tests__/price-cache.test.ts
  - packages/daemon/src/__tests__/coingecko-oracle.test.ts
  - packages/daemon/src/__tests__/pyth-oracle.test.ts
  - packages/daemon/src/__tests__/oracle-chain.test.ts
  - packages/daemon/src/pipeline/resolve-effective-amount-usd.ts
  - packages/daemon/src/__tests__/resolve-effective-amount-usd.test.ts
autonomous: true
requirements: [ORCL-03]

must_haves:
  truths:
    - "buildCacheKey tests verify CAIP-19 output for ethereum-mainnet, polygon-mainnet, and mainnet (Solana)"
    - "CoinGecko oracle L2 test verifies Polygon USDC is queried via 'polygon-pos' platformId (not 'ethereum')"
    - "Pyth oracle test verifies getPrice for SOL/native uses CAIP-19 cache key to find feed ID"
    - "OracleChain test verifies cache key format is CAIP-19 in fallback and cross-validation flows"
    - "Cross-validation test confirms getFeedId(buildCacheKey(network, address)) returns correct feed ID for all 4 PYTH_FEED_IDS entries"
    - "resolveEffectiveAmountUsd passes network to priceOracle.getPrice for TOKEN_TRANSFER"
    - "All existing oracle tests pass with updated expectations (no regressions)"
  artifacts:
    - path: "packages/daemon/src/__tests__/price-cache.test.ts"
      provides: "buildCacheKey CAIP-19 output tests + resolveNetwork fallback tests"
      contains: "eip155:1/slip44:60|eip155:137/erc20"
    - path: "packages/daemon/src/__tests__/coingecko-oracle.test.ts"
      provides: "L2 token price query tests via CoinGecko"
      contains: "polygon-pos|polygon-mainnet"
    - path: "packages/daemon/src/__tests__/pyth-oracle.test.ts"
      provides: "Pyth oracle tests with CAIP-19 cache keys"
      contains: "eip155:1/slip44:60|solana:5eykt"
    - path: "packages/daemon/src/__tests__/oracle-chain.test.ts"
      provides: "OracleChain tests with CAIP-19 cache keys"
      contains: "buildCacheKey"
    - path: "packages/daemon/src/pipeline/resolve-effective-amount-usd.ts"
      provides: "Network-aware TokenRef construction for oracle calls"
      contains: "network"
  key_links:
    - from: "packages/daemon/src/__tests__/price-cache.test.ts"
      to: "packages/daemon/src/infrastructure/oracle/price-cache.ts"
      via: "Tests verify buildCacheKey + resolveNetwork output correctness"
      pattern: "buildCacheKey.*eip155"
    - from: "packages/daemon/src/__tests__/coingecko-oracle.test.ts"
      to: "packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts"
      via: "Tests verify L2 network platform resolution in CoinGecko API calls"
      pattern: "polygon-pos|polygon-mainnet"
    - from: "packages/daemon/src/pipeline/resolve-effective-amount-usd.ts"
      to: "packages/daemon/src/infrastructure/oracle/oracle-chain.ts"
      via: "TOKEN_TRANSFER passes network in TokenRef to priceOracle.getPrice"
      pattern: "network.*NetworkType"
---

<objective>
Update all oracle test suites for CAIP-19 cache key format, add L2 token price tests, add cross-validation tests for key atomicity, and thread network through pipeline callers.

Purpose: Verify the CAIP-19 migration works correctly end-to-end and ensure L2 token prices can be resolved via CoinGecko with accurate network-based platform mapping. Prevent regressions in existing oracle behavior.

Output: All oracle tests pass with CAIP-19 expectations. L2 price resolution verified. Pipeline callers pass network to oracle.
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/232-oracle-l2-support-cache-key-migration/232-RESEARCH.md
@.planning/phases/232-oracle-l2-support-cache-key-migration/232-01-SUMMARY.md

# Source files (read before modifying)
@packages/daemon/src/__tests__/price-cache.test.ts
@packages/daemon/src/__tests__/coingecko-oracle.test.ts
@packages/daemon/src/__tests__/pyth-oracle.test.ts
@packages/daemon/src/__tests__/oracle-chain.test.ts
@packages/daemon/src/pipeline/resolve-effective-amount-usd.ts
@packages/daemon/src/__tests__/resolve-effective-amount-usd.test.ts

# Implementation from Plan 01
@packages/daemon/src/infrastructure/oracle/price-cache.ts
@packages/daemon/src/infrastructure/oracle/coingecko-platform-ids.ts
@packages/daemon/src/infrastructure/oracle/pyth-feed-ids.ts
@packages/daemon/src/infrastructure/oracle/coingecko-oracle.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update oracle test suites for CAIP-19 cache key format + add L2 tests</name>
  <files>
    packages/daemon/src/__tests__/price-cache.test.ts
    packages/daemon/src/__tests__/coingecko-oracle.test.ts
    packages/daemon/src/__tests__/pyth-oracle.test.ts
    packages/daemon/src/__tests__/oracle-chain.test.ts
  </files>
  <action>
    **price-cache.test.ts:**
    1. Update existing `buildCacheKey` tests to use new signature `buildCacheKey(network, address)`:
       - `buildCacheKey('ethereum-mainnet', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48')` should equal `'eip155:1/erc20:0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48'` (CAIP-19 format, lowercase).
       - `buildCacheKey('mainnet', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v')` should equal `'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/token:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'` (Solana base58 preserved).
    2. Add new tests:
       - `buildCacheKey('ethereum-mainnet', 'native')` should equal `'eip155:1/slip44:60'`.
       - `buildCacheKey('polygon-mainnet', 'native')` should equal `'eip155:137/slip44:966'`.
       - `buildCacheKey('polygon-mainnet', '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359')` should equal `'eip155:137/erc20:0x3c499c542cef5e3811e1192ce70d8cc03d5c3359'`.
       - `buildCacheKey('mainnet', 'native')` should equal `'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp/slip44:501'`.
    3. Add `resolveNetwork` tests:
       - `resolveNetwork('solana')` returns `'mainnet'`.
       - `resolveNetwork('ethereum')` returns `'ethereum-mainnet'`.
       - `resolveNetwork('ethereum', 'polygon-mainnet')` returns `'polygon-mainnet'` (explicit takes priority).
       - `resolveNetwork('solana', 'devnet')` returns `'devnet'`.
    4. Add cross-validation test (Pitfall 1 prevention):
       - Import `PYTH_FEED_IDS` and `buildCacheKey`.
       - For each known network+address pair (mainnet/native, ethereum-mainnet/native, mainnet/USDC, mainnet/USDT), verify `PYTH_FEED_IDS.has(buildCacheKey(network, address))` is true.

    **coingecko-oracle.test.ts:**
    1. Update existing token fixtures to include `network` field:
       - `SOLANA_USDC`: add `network: 'mainnet'` (was using implicit default).
       - `ETH_USDC`: add `network: 'ethereum-mainnet'`.
    2. Update test expectations that check `result.get(...)` keys -- they should now be CAIP-19 format.
       - For example, `result.get('solana:EPjFWdd5...')` becomes `result.get('solana:5eykt.../token:EPjFWdd5...')`.
    3. Add L2 test cases:
       - Create `POLYGON_USDC` fixture: `{ address: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359', symbol: 'USDC', decimals: 6, chain: 'ethereum', network: 'polygon-mainnet' }`.
       - Test `getPrice(POLYGON_USDC)`: mock fetch should receive URL with `polygon-pos` platformId (not `ethereum`). Verify result returns valid PriceInfo.
       - Test `getPrices([ETH_USDC, POLYGON_USDC])`: verify they are batched into SEPARATE API calls (different platformIds). Verify result Map has 2 entries with distinct CAIP-19 keys.
    4. Update `getPrices` native token test expectations to use CAIP-19 cache keys.
    5. Verify the mock fetch URL contains the correct platformId for each network.

    **pyth-oracle.test.ts:**
    1. Update token fixtures to include `network` field where appropriate.
    2. Update `getPrice` test for SOL/native: the cacheKey used internally should now be CAIP-19. Verify the test still calls Pyth API with the correct feed ID (the Pyth API behavior hasn't changed, only the internal cache key derivation).
    3. Update `getPrices` batch test: verify result Map keys are CAIP-19 format.
    4. Ensure `getPrice` for an unregistered token still throws `PriceNotAvailableError`.

    **oracle-chain.test.ts:**
    1. Update `SOL_TOKEN` and `ETH_TOKEN` test fixtures to include `network` field.
    2. Update any hardcoded cache key expectations (e.g., `'solana:native'` -> CAIP-19 equivalent).
    3. Verify cross-validation still works: primary (Pyth) and fallback (CoinGecko) both return prices, deviation check triggers isStale correctly.
    4. Verify stale cache fallback uses CAIP-19 keys.
  </action>
  <verify>
    Run `pnpm vitest run packages/daemon/src/__tests__/price-cache.test.ts packages/daemon/src/__tests__/coingecko-oracle.test.ts packages/daemon/src/__tests__/pyth-oracle.test.ts packages/daemon/src/__tests__/oracle-chain.test.ts` -- all tests pass.
  </verify>
  <done>
    All 4 oracle test suites pass with CAIP-19 key expectations. L2 (Polygon) CoinGecko price query test verifies correct platform routing. Cross-validation test confirms PYTH_FEED_IDS keys match buildCacheKey output. No regressions in existing oracle behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Thread network through pipeline oracle callers</name>
  <files>
    packages/daemon/src/pipeline/resolve-effective-amount-usd.ts
    packages/daemon/src/__tests__/resolve-effective-amount-usd.test.ts
  </files>
  <action>
    **resolve-effective-amount-usd.ts:**
    1. Import `NetworkType` from `@waiaas/core`.
    2. Add `network?: string` parameter to the function signature (after `chain`):
       `resolveEffectiveAmountUsd(request, txType, chain, priceOracle, network?)`.
       The `network` parameter is optional for backward compatibility -- if not provided, the oracle's internal `resolveNetwork` handles the fallback.
    3. In the `TOKEN_TRANSFER` case, pass `network` in the TokenRef:
       ```typescript
       const tokenPrice = await priceOracle.getPrice({
         address: req.token.address,
         decimals: req.token.decimals,
         chain: chain as ChainType,
         network: network as NetworkType | undefined,
       });
       ```
    4. In the BATCH helper `resolveBatchUsd`, thread `network` through (add parameter, pass to TOKEN_TRANSFER getPrice calls).
    5. Do NOT change the getNativePrice calls -- they take ChainType and the oracle resolves network internally.

    **stages.ts caller update (if needed):**
    Check `packages/daemon/src/pipeline/stages.ts` line 328-330 where `resolveEffectiveAmountUsd` is called. It currently passes `ctx.wallet.chain`. Add `ctx.resolvedNetwork` as the network parameter:
    ```typescript
    priceResult = await resolveEffectiveAmountUsd(
      req as unknown as Record<string, unknown>, txType, ctx.wallet.chain, ctx.priceOracle, ctx.resolvedNetwork,
    );
    ```
    Note: stages.ts is already using `ctx.resolvedNetwork` for policy evaluation (line 323). This is the same value we need for oracle calls.

    **resolve-effective-amount-usd.test.ts:**
    1. Update existing test calls to optionally include network parameter where relevant.
    2. Add a test verifying that when `network` is passed, the oracle receives it in the TokenRef:
       - Create a mock oracle, call `resolveEffectiveAmountUsd(request, 'TOKEN_TRANSFER', 'ethereum', mockOracle, 'polygon-mainnet')`.
       - Verify `mockOracle.getPrice` was called with `{ ..., network: 'polygon-mainnet' }`.
    3. Add a test verifying backward compatibility: when `network` is undefined, oracle is called without network field (resolveNetwork handles default).
    4. Verify existing tests still pass without modification (network is optional, defaults are backward compatible).
  </action>
  <verify>
    Run `pnpm vitest run packages/daemon/src/__tests__/resolve-effective-amount-usd.test.ts` -- all tests pass.
    Run `pnpm turbo run typecheck --filter=@waiaas/daemon` -- zero type errors.
  </verify>
  <done>
    resolveEffectiveAmountUsd passes network to priceOracle.getPrice for TOKEN_TRANSFER requests. Pipeline stages.ts threads ctx.resolvedNetwork to oracle calls. Tests verify network is forwarded correctly. All existing tests pass without modification (backward compatible).
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run packages/daemon/src/__tests__/price-cache.test.ts packages/daemon/src/__tests__/coingecko-oracle.test.ts packages/daemon/src/__tests__/pyth-oracle.test.ts packages/daemon/src/__tests__/oracle-chain.test.ts packages/daemon/src/__tests__/resolve-effective-amount-usd.test.ts` -- ALL pass.
2. `pnpm turbo run typecheck --filter=@waiaas/daemon` -- zero errors.
3. `pnpm turbo run lint --filter=@waiaas/daemon` -- zero errors.
4. Cross-validation: `PYTH_FEED_IDS.has(buildCacheKey('mainnet', 'native'))` is true (verified in test).
5. L2 discrimination: CoinGecko oracle uses `polygon-pos` platformId for `polygon-mainnet` tokens (verified in test).
6. No legacy `chain:address` format cache keys in tests or assertions.
</verification>

<success_criteria>
- All oracle test suites pass with CAIP-19 key expectations (zero legacy format assertions).
- L2 token price query test verifies CoinGecko platform routing via network (not chain).
- PYTH_FEED_IDS key atomicity is verified by cross-validation test.
- Pipeline callers pass network to oracle for accurate L2 token pricing.
- All existing tests pass without regressions (backward compatible).
</success_criteria>

<output>
After completion, create `.planning/phases/232-oracle-l2-support-cache-key-migration/232-02-SUMMARY.md`
</output>
