# Milestone v0.4: 테스트 전략 및 계획 수립

**Status:** SHIPPED 2026-02-07
**Phases:** 14-18
**Total Plans:** 9

## Overview

v0.2에서 완성한 17개 설계 문서와 v0.3에서 확보한 일관성 대응표를 역방향 검증하는 테스트 전략을 수립한다. 테스트 레벨 정의와 Mock 경계 설정을 기반으로, 보안 공격 시나리오 25건 이상, 블록체인 3단계 테스트 환경, Enum/설정 일관성 자동 검증, CI/CD 파이프라인, 배포 타겟별 테스트 범위를 확정하여 구현 단계에서 "무엇을 어떻게 테스트할 것인가"가 명확한 상태를 만든다.

## Phases

### Phase 14: 테스트 기반 정의

**Goal**: 전체 테스트 전략의 뼈대가 확정되어, 이후 도메인별 시나리오 작성 시 "어떤 레벨에서, 어떤 Mock으로, 어떤 커버리지 목표로" 테스트할지 참조할 수 있다
**Depends on**: Nothing (v0.4 첫 페이즈)
**Requirements**: TLVL-01, TLVL-02, TLVL-03, MOCK-01, MOCK-02, MOCK-03, MOCK-04
**Plans**: 2 plans

Plans:
- [x] 14-01: 테스트 레벨 정의, 모듈 매트릭스, 커버리지 목표 (TLVL-01, TLVL-02, TLVL-03)
- [x] 14-02: Mock 경계 매트릭스, 인터페이스 스펙, Contract Test 전략 (MOCK-01, MOCK-02, MOCK-03, MOCK-04)

**Details:**
- 6개 테스트 레벨(Unit/Integration/E2E/Chain Integration/Security/Platform) 범위/환경/빈도 정의
- 9개 모듈 x 6개 레벨 O/X 매트릭스
- 패키지별 커버리지 4-tier (Critical 90%+, High 80%+, Normal 70%+, Low 50%+)
- @waiaas/daemon 9개 서브모듈 세분화 커버리지
- 5개 외부 의존성 Mock 방식 매트릭스
- IClock (now(): Date), IOwnerSigner (Owner 서명 추상화) 인터페이스 스펙
- 5개 인터페이스 팩토리 함수 기반 Contract Test 전략
- Completed: 2026-02-06

### Phase 15: 보안 테스트 시나리오

**Goal**: WAIaaS 3계층 보안 모델의 모든 공격 벡터가 시나리오로 문서화되어, 구현 시 "이 보안 계층이 올바르게 동작하는가"를 체계적으로 검증할 수 있다
**Depends on**: Phase 14 (테스트 레벨 및 Mock 경계 참조)
**Requirements**: SEC-01, SEC-02, SEC-03, SEC-04, SEC-05
**Plans**: 3 plans

Plans:
- [x] 15-01: Layer 1 세션 인증 공격 시나리오 12건 + ownerAuth 8건 (SEC-01)
- [x] 15-02: Layer 2 정책 우회 9건 + Layer 3 Kill Switch/AutoStop 8건 (SEC-02, SEC-03)
- [x] 15-03: 키스토어 보안 + 외부 위협 + 경계값 테스트 + E2E 연쇄 체인 (SEC-04, SEC-05)

**Details:**
- Layer 1: sessionAuth 12건(JWT 위조/만료/폐기/탈취 등) + ownerAuth 8건
- Layer 2: TOCTOU, 금액 분할, 시간 조작 등 9건
- Layer 3: Kill Switch 상태 우회, 복구 brute-force, AutoStop 트리거 등 8건
- 키스토어: authTag 변조, 잘못된 패스워드, 메모리 클리어 등 10건
- 경계값: 4-tier 금액 +/-1 lamport, 시간 경계 8건, TOCTOU 3건
- E2E 연쇄 체인: Layer 1-2-3 관통 공격 5건
- 전체 통계: 47건 + 경계값 19건 + 체인 5건 = 71건
- Completed: 2026-02-06

### Phase 16: 블록체인 & 일관성 검증 전략

**Goal**: 블록체인 의존성을 3단계로 격리하는 테스트 환경 전략과, v0.3에서 확보한 Enum/설정 SSoT의 자동 검증 방법이 확정되어 있다
**Depends on**: Phase 14 (Mock 경계, 특히 블록체인 RPC Mock 방식 참조)
**Requirements**: CHAIN-01, CHAIN-02, CHAIN-03, CHAIN-04, ENUM-01, ENUM-02, ENUM-03
**Plans**: 2 plans

Plans:
- [x] 16-01: 블록체인 3단계 테스트 환경 + Mock RPC 시나리오 + Local Validator E2E + EVM Stub (CHAIN-01~04)
- [x] 16-02: Enum SSoT 빌드타임 검증 + config.toml 테스트 + NOTE-01~11 매핑 (ENUM-01~03)

**Details:**
- Solana 3단계: Mock RPC 13건 / Local Validator E2E 5흐름 / Devnet 3건
- createMockRpcTransport() Stateless/Stateful 팩토리 패턴
- EvmAdapterStub 테스트 5항목 (타입준수/isConnected/getHealth/11메서드throw/Registry)
- Enum SSoT: as const -> TypeScript -> Zod -> Drizzle -> DB CHECK 단방향 파생 체인
- config.toml 3단계 로딩 12개 테스트 케이스
- NOTE-01~11 테스트 매핑 (4건 필요, 7건 불필요, 22개 테스트 케이스)
- Completed: 2026-02-06

### Phase 17: CI/CD 파이프라인 설계

**Goal**: 테스트 자동화 파이프라인 구조가 확정되어, 구현 단계에서 워크플로우 YAML을 바로 작성할 수 있다
**Depends on**: Phase 14, 15, 16 (모든 테스트 유형과 범위가 정의된 후)
**Requirements**: CICD-01, CICD-02, CICD-03
**Plans**: 1 plan

Plans:
- [x] 17-01: CI/CD 파이프라인 4단계 구조 + GitHub Actions 워크플로우 + 커버리지 게이트 설계 (CICD-01, CICD-02, CICD-03)

**Details:**
- 4단계: Stage 1(매 커밋 ~2min), Stage 2(매 PR ~5min), Stage 3(nightly ~10min), Stage 4(릴리스 ~15min)
- GitHub Actions: ci.yml + nightly.yml + release.yml + coverage-report.yml + setup composite action
- Turborepo --affected vs 전체 실행 전략
- Soft/Hard 커버리지 게이트 + 6단계 전환 우선순위
- coverage-report.yml fork PR 보안 분리
- turbo.json test:* cache: false
- Completed: 2026-02-06

### Phase 18: 배포 타겟별 테스트

**Goal**: 4개 배포 타겟(CLI Daemon/Docker/Desktop/Telegram Bot) 각각의 테스트 범위와 검증 방법이 확정되어, 플랫폼별 품질 기준이 명확하다
**Depends on**: Phase 14 (테스트 레벨 중 Platform 레벨 참조), Phase 17 (CI 파이프라인에 통합 방법)
**Requirements**: PLAT-01, PLAT-02, PLAT-03, PLAT-04
**Plans**: 1 plan

Plans:
- [x] 18-01: 4개 배포 타겟별 테스트 범위, 시나리오, 검증 방법, CI/CD 통합 매핑 (PLAT-01, PLAT-02, PLAT-03, PLAT-04)

**Details:**
- CLI Daemon: 32건 (init/start/stop/status, 시그널 처리, exit codes, Windows fallback)
- Docker: 18건 (빌드/compose/named volume/환경변수/hostname/grace period/Secrets/healthcheck)
- Tauri Desktop: 자동 6건 + 수동 QA 28건 (빌드/SEA/IPC/Setup Wizard/트레이/WalletConnect)
- Telegram Bot: 34건 (Long Polling/8명령어/5콜백/2-Tier 인증/MarkdownV2/Graceful shutdown)
- 총 118건 시나리오 (자동화 90건 + 수동 QA 28건)
- Completed: 2026-02-07

---

## Milestone Summary

**Key Decisions:**

- 테스트 전략 선행 수립 (구현 전 검증 체계 확정)
- IClock/IOwnerSigner 신규 인터페이스 추가 필요 식별
- 보안 위험도 기반 4-tier 커버리지 차등 적용
- Soft->Hard 커버리지 게이트 점진적 전환
- Enum SSoT as const 배열 단방향 파생 체인
- Mock RPC 13개 시나리오 확정 (Solana 에러 매핑 11종 + SEC-05 경계값 교차)
- TOCTOU 테스트 Integration 레벨 필수 (실제 SQLite + BEGIN IMMEDIATE)
- Telegram Bot 명령어/콜백 Integration, Long Polling만 Platform 분리
- Tauri CI 빌드 선택적 Stage 4 job

**Issues Resolved:**

- REST API SSoT와 내부 에러 코드 매핑 혼동 방지 (이중 참조 병기)
- nonce 엔드포인트 경로 SSoT 확정 (/v1/nonce)
- 기본 정책(1/10/50 SOL) vs 커스텀 정책(0.1/1/10 SOL) 이중 경계값 검증

**Issues Deferred:**

- 없음

**Technical Debt Incurred:**

- 없음

---

_For current project status, see .planning/ROADMAP.md_
