---
phase: 198-signing-protocol-v1-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/design/73-signing-protocol-v1.md
autonomous: true
requirements:
  - PROTO-01
  - PROTO-02

must_haves:
  truths:
    - "SignRequest Zod 스키마가 version, requestId, chain, network, message, displayMessage, metadata, responseChannel, expiresAt 필드와 타입 제약 조건을 모두 명시하고 있다"
    - "SignResponse Zod 스키마가 version, requestId, action, signature, signerAddress, signedAt 필드와 타입 제약 조건을 모두 명시하고 있다"
    - "서명 메시지 포맷이 EIP-191(EVM)과 Ed25519(Solana) 양쪽 체인에 대해 텍스트 템플릿과 인코딩 방식을 확정하고 있다"
    - "유니버셜 링크 URL 구조(지갑 도메인 base URL + /waiaas/sign 경로 + base64url 인코딩 data 파라미터)가 확정되어 있다"
    - "지갑 개발사가 AASA/assetlinks.json에 추가할 정확한 경로와 설정이 명시되어 있다"
    - "URL 길이 제한 대응 전략(2KB 이내 유지 + requestId 기반 fallback)이 명시되어 있다"
  artifacts:
    - path: "internal/design/73-signing-protocol-v1.md"
      provides: "Signing Protocol v1 설계서 — 스키마, 서명 포맷, 유니버셜 링크 섹션"
      contains: "SignRequestSchema"
  key_links:
    - from: "internal/design/73-signing-protocol-v1.md"
      to: "internal/objectives/m26-01-wallet-signing-sdk.md"
      via: "스키마 정의 formalization"
      pattern: "SignRequestSchema|SignResponseSchema"
---

<objective>
Signing Protocol v1 설계 문서(doc 73)를 생성하고, 프로토콜 개요 + SignRequest/SignResponse 스키마 + 서명 메시지 포맷 + 유니버셜 링크 URL 구조 섹션을 작성한다.

Purpose: m26-01 objective에 분산되어 있는 서명 프로토콜 스키마와 유니버셜 링크 설계를 공식 설계 문서로 확정하여, SDK와 데몬 구현의 입력으로 사용할 수 있게 한다.
Output: `internal/design/73-signing-protocol-v1.md` 파일 (Sections 1-5: 개요, 설계 원칙, 스키마, 서명 포맷, 유니버셜 링크)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/objectives/m26-00-wallet-sdk-design.md
@internal/objectives/m26-01-wallet-signing-sdk.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 설계 문서 골격 + 프로토콜 개요 + 설계 원칙 작성</name>
  <files>internal/design/73-signing-protocol-v1.md</files>
  <action>
`internal/design/73-signing-protocol-v1.md` 파일을 생성한다. 한국어로 작성한다.

문서 전체 골격(목차)을 먼저 잡고, Section 1~2를 완성한다:

**Section 1: 개요**
- 문서 목적: WAIaaS Signing Protocol v1의 모든 스키마, 전송 채널, 보안 모델을 확정
- 프로토콜 개요: 세션 관리 없는 1회성 서명 프로토콜. AI 에이전트의 트랜잭션이 정책에 의해 PENDING_APPROVAL 상태가 되면, Owner의 지갑 앱으로 서명 요청을 전달하고, 서명된 응답을 받아 실행하는 플로우
- 적용 범위: 이 프로토콜을 기반으로 m26-01(@waiaas/wallet-sdk + 데몬 컴포넌트), m26-02(알림 채널), m26-03(Push Relay)가 설계/구현됨
- 2가지 응답 채널 소개: (A) ntfy 직접 푸시 (메신저 불필요), (B) Telegram 메신저 중계
- m26-00의 승인 채널 전체 구조 표(5가지 채널, 우선순위) 포함

**Section 2: 설계 원칙**
- 세션리스: WalletConnect 대비 세션 관리 불필요. 요청마다 독립적
- self-hosted 호환: WAIaaS 도메인 불필요. 지갑 개발사 도메인 활용
- Zod SSoT: 스키마는 Zod로 정의하고 TypeScript 타입을 derive
- 기존 인프라 재사용: ownerAuth(Ed25519/SIWE) 서명 검증, ntfy 알림 채널
- 보안 기본: requestId UUID v7 기반 1회용 토픽, 서명 검증으로 위조 방지

**목차 (전체 문서 구조 — 이후 Plan 02에서 나머지 섹션 작성)**:
1. 개요
2. 설계 원칙
3. SignRequest 스키마
4. SignResponse 스키마
5. 서명 메시지 포맷
6. 유니버셜 링크 URL 구조
7. ntfy 채널 프로토콜
8. Telegram 채널 프로토콜
9. 요청 만료 + 재시도 정책
10. 보안 모델
11. 에러 코드
12. 기술 결정 요약

Section 7~12의 자리는 비워두되 `<!-- Plan 02에서 작성 -->` 주석을 남긴다.
  </action>
  <verify>파일이 존재하고, Section 1(개요)과 Section 2(설계 원칙)가 완성되어 있으며, 전체 목차가 12개 섹션으로 구성되어 있는지 확인</verify>
  <done>doc 73 파일이 생성되고, 프로토콜 개요와 설계 원칙이 m26-00/m26-01 objective 내용을 기반으로 확정되어 있다</done>
</task>

<task type="auto">
  <name>Task 2: SignRequest/SignResponse 스키마 + 서명 메시지 포맷 + 유니버셜 링크 섹션 작성</name>
  <files>internal/design/73-signing-protocol-v1.md</files>
  <action>
doc 73의 Section 3~6을 작성한다.

**Section 3: SignRequest 스키마**
- m26-01의 `SignRequestSchema` Zod 코드를 그대로 포함 (TypeScript 코드 블록)
- 각 필드별 상세 설명 표:
  | 필드 | 타입 | 필수 | 설명 | 제약 조건 |
  - version: z.literal('1') — 프로토콜 버전 고정
  - requestId: z.string().uuid() — UUID v7, 응답 매칭 + 토픽 이름에 사용
  - chain: z.enum(['solana', 'evm']) — 지원 체인
  - network: z.string() — "ethereum-mainnet", "devnet" 등 (resolveNetwork() 출력과 동일)
  - message: z.string() — 서명할 메시지 (Section 5의 포맷)
  - displayMessage: z.string() — 지갑 앱 UI에 표시할 사람 읽기용 요약
  - metadata: txId, type(5-type discriminatedUnion), from, to, amount?, symbol?, policyTier(APPROVAL|DELAY)
  - responseChannel: discriminatedUnion('type') — ntfy 또는 telegram
  - expiresAt: z.string().datetime() — ISO 8601, 기본 30분
- responseChannel 서브타입 상세:
  - ntfy: { type: 'ntfy', responseTopic: string, serverUrl?: string }
  - telegram: { type: 'telegram', botUsername: string }
- base64url 인코딩 시 예상 크기 분석 (JSON → base64url → URL 길이)

**Section 4: SignResponse 스키마**
- m26-01의 `SignResponseSchema` Zod 코드 포함
- 각 필드별 상세 설명 표
- action='approve'일 때 signature 필수, 'reject'일 때 optional
- signerAddress가 Owner의 등록된 주소와 일치해야 함 (검증 로직은 ownerAuth 재사용)

**Section 5: 서명 메시지 포맷**
- 텍스트 템플릿 (m26-01의 서명 메시지 포맷 그대로):
  ```
  WAIaaS Transaction Approval
  Transaction: {txId}
  Type: {type}
  ...
  Nonce: {nonce}
  ```
- EVM 체인: EIP-191 personal_sign 방식. "\x19Ethereum Signed Message:\n" 접두어
- Solana 체인: Ed25519 메시지 서명. 바이트 배열로 인코딩
- Nonce 생성 규칙: UUID v7 (requestId 재사용)
- 메시지 바이트 인코딩: UTF-8 → hex(EVM) 또는 base64(Solana)

**Section 6: 유니버셜 링크 URL 구조**
- URL 패턴: `https://{wallet.universalLink.base}{wallet.universalLink.signPath}?data={base64url(JSON.stringify(SignRequest))}`
- 구체 예시: `https://link.dcentwallet.com/waiaas/sign?data=eyJ2ZXJzaW9uIjoi...`
- 플랫폼별 동작 표: 모바일+앱설치(앱열림), 모바일+미설치(웹페이지), PC(웹페이지+QR)
- AASA 설정 가이드: `/waiaas/*` 경로를 apple-app-site-association에 추가
- assetlinks.json 설정 가이드: 안드로이드 App Links에 패키지 추가
- 딥링크 fallback: `{scheme}://{deepLink.signPath}?data=...` 형태
- URL 길이 제한 대응:
  - SignRequest JSON이 약 500-800 바이트 → base64url 약 700-1100자 → 전체 URL 약 800-1200자 (2KB 이내)
  - 2KB 초과 시 대안: URL에는 requestId만 포함, 전체 데이터는 ntfy 토픽에서 조회
  </action>
  <verify>Section 3~6이 모두 작성되어 있고, SignRequestSchema/SignResponseSchema Zod 코드가 포함되어 있으며, 유니버셜 링크 URL 예시가 있는지 확인</verify>
  <done>SignRequest/SignResponse 스키마가 모든 필드 설명과 제약 조건을 포함하여 확정되고, 서명 메시지 포맷(EIP-191/Ed25519)이 명시되며, 유니버셜 링크 URL 구조가 지갑 개발사가 바로 적용할 수 있는 수준으로 확정되어 있다</done>
</task>

</tasks>

<verification>
- [ ] doc 73 파일이 `internal/design/73-signing-protocol-v1.md`에 존재한다
- [ ] Section 1~6이 모두 작성되어 있다
- [ ] SignRequestSchema Zod 코드가 m26-01 objective와 일치한다
- [ ] SignResponseSchema Zod 코드가 m26-01 objective와 일치한다
- [ ] 서명 메시지 텍스트 템플릿이 포함되어 있다
- [ ] EIP-191 (EVM) 서명 방식이 명시되어 있다
- [ ] Ed25519 (Solana) 서명 방식이 명시되어 있다
- [ ] 유니버셜 링크 URL 패턴과 예시가 포함되어 있다
- [ ] AASA / assetlinks.json 설정 가이드가 포함되어 있다
- [ ] URL 길이 제한 대응 전략이 명시되어 있다
</verification>

<success_criteria>
PROTO-01 완료: SignRequest/SignResponse Zod 스키마가 모든 필드, 타입, 제약 조건과 함께 확정되고, 서명 메시지 포맷이 체인별로 명시됨
PROTO-02 완료: 유니버셜 링크 URL 구조가 확정되어 지갑 개발사가 AASA/assetlinks.json에 추가할 경로를 알 수 있음
</success_criteria>

<output>
After completion, create `.planning/phases/198-signing-protocol-v1-design/198-01-SUMMARY.md`
</output>
