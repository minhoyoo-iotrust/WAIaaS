---
phase: 200-notification-channel-push-relay-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/design/75-notification-channel-push-relay.md
autonomous: true
requirements: [NOTIF-01, NOTIF-02, NOTIF-03]

must_haves:
  truths:
    - "서명 토픽(waiaas-sign-{walletId})과 알림 토픽(waiaas-notify-{walletId})의 분리 구조가 확정되어 있다"
    - "ntfy priority 차등 정책(서명 5, 보안 알림 5, 일반 알림 3)이 확정되어 있다"
    - "NotificationMessage Zod 스키마(6개 카테고리, 전체 필드)가 확정되어 있다"
    - "SDK subscribeToNotifications() + parseNotification() 인터페이스가 확정되어 있다"
    - "WalletNotificationChannel과 기존 INotificationChannel 통합 방식(NotificationService 확장)이 확정되어 있다"
    - "SettingsService 알림 관련 3개 키가 확정되어 있다"
  artifacts:
    - path: "internal/design/75-notification-channel-push-relay.md"
      provides: "알림 채널 설계 (Sections 1-5)"
      contains: "NotificationMessageSchema"
  key_links:
    - from: "doc 75 Section 2 (토픽 구조)"
      to: "doc 73 Section 7 (ntfy 채널 프로토콜)"
      via: "토픽 네이밍 일관성 (waiaas-sign-* / waiaas-notify-*)"
      pattern: "waiaas-notify-\\{walletId\\}"
    - from: "doc 75 Section 4 (WalletNotificationChannel)"
      to: "doc 74 Section 7 (NtfySigningChannel)"
      via: "동일 ntfy 서버 공유, 토픽 접두어로 분리"
      pattern: "INotificationChannel"
    - from: "doc 75 Section 3 (SDK 알림 API)"
      to: "doc 74 Section 2 (SDK 공개 API)"
      via: "subscribeToNotifications + parseNotification 추가"
      pattern: "subscribeToNotifications"
---

<objective>
알림 채널 설계서(doc 75 Sections 1-5) 작성 -- 서명/알림 토픽 분리 구조, NotificationMessage 스키마, SDK 알림 API, WalletNotificationChannel 통합 설계를 확정한다.

Purpose: m26-02(지갑 앱 알림 채널) 구현 시 바로 시작할 수 있는 입력 사양 제공
Output: internal/design/75-notification-channel-push-relay.md Sections 1-5
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/objectives/m26-02-wallet-notification-channel.md
@internal/design/73-signing-protocol-v1.md
@internal/design/74-wallet-sdk-daemon-components.md
@.planning/phases/199-wallet-sdk-daemon-components-design/199-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 문서 개요 + 토픽 분리 구조 + NotificationMessage 스키마 작성</name>
  <files>internal/design/75-notification-channel-push-relay.md</files>
  <action>
doc 75 파일을 새로 생성하여 다음 섹션들을 작성한다:

**Section 1: 개요**
- 문서 목적: m26-02/m26-03 구현 입력 사양
- 적용 범위: 알림 채널(m26-02) + Push Relay Server(m26-03)
- doc 73/74와의 관계 (프로토콜 스키마 참조, SDK API 확장, 데몬 컴포넌트 확장)
- 문서 구조 미리보기 (Section 1-10 목차)

**Section 2: 서명/알림 토픽 분리 구조 (NOTIF-01)**
- 토픽 네이밍 규칙 3개 정의:
  - `waiaas-sign-{walletId}` — 서명 요청 (기존, doc 73 Section 7)
  - `waiaas-response-{requestId}` — 서명 응답 (기존, doc 73 Section 7)
  - `waiaas-notify-{walletId}` — 일반 알림 (신규, m26-02)
- ntfy priority 차등 정책 표:
  - priority 5 (urgent): 서명 요청(sign_request), 보안 알림(security_alert, Kill Switch)
  - priority 4 (high): 정책 위반(policy_violation)
  - priority 3 (default): 나머지 알림(transaction_completed, transaction_pending, session_event, system)
- 카테고리별 priority 매핑 표 (6개 카테고리 x priority)
- ntfy publish 포맷: JSON body + Title + Priority + Tags 헤더 (doc 73 Section 7.2 패턴과 일관)
- self-hosted ntfy: 기존 notifications.ntfy_server 재사용 (doc 74 Section 9 결정 참조)
- 토픽 접두어 SettingsService 키: signing_sdk.notify_topic_prefix (기본: "waiaas-notify")

**Section 3: NotificationMessage 스키마 (NOTIF-02 일부)**
- NotificationMessageSchema Zod 정의: m26-02 목표 파일의 스키마를 기반으로 확정
  - version: z.literal('1')
  - type: z.literal('notification') — SignRequest의 type과 구분
  - notificationId: z.string().uuid() — UUID v7
  - category: z.enum(['transaction_completed', 'transaction_pending', 'policy_violation', 'session_event', 'security_alert', 'system'])
  - title: z.string() — 짧은 제목 (푸시 알림 헤더)
  - body: z.string() — 상세 내용
  - metadata: z.record(z.string()).optional() — 카테고리별 추가 정보
  - walletId: z.string().uuid()
  - timestamp: z.string().datetime()
- 카테고리별 metadata 규격 표 (6개 카테고리 x metadata 필드들):
  - transaction_completed: { txId, txHash, status, from, to, amount?, symbol? }
  - transaction_pending: { txId, status, reason }
  - policy_violation: { txId, policyType, violatedRule }
  - session_event: { sessionId, event: 'created'|'expired'|'renewed', walletName }
  - security_alert: { alertType: 'kill_switch'|'anomaly', severity, description }
  - system: { eventType: 'daemon_start'|'daemon_stop'|'update_available', version? }
- ntfy publish 시 인코딩: JSON body + base64url (2KB 이내이면 직접 JSON, 초과 시 ntfy attach 필드 사용)
- NotificationMessage와 SignRequest 구분: type 필드 ('notification' vs 없음/SDK 파싱에서 URL 기반 감지)
  </action>
  <verify>
grep으로 doc 75 파일에 "NotificationMessageSchema", "waiaas-notify-{walletId}", "priority" 키워드 존재 확인.
Section 1, 2, 3 헤딩이 모두 존재하는지 grep 확인.
  </verify>
  <done>
doc 75에 Section 1(개요), Section 2(토픽 분리 + priority 차등), Section 3(NotificationMessage 스키마 + 6개 카테고리 metadata) 작성 완료. NOTIF-01 충족, NOTIF-02 스키마 부분 충족.
  </done>
</task>

<task type="auto">
  <name>Task 2: SDK 알림 API + WalletNotificationChannel 통합 + SettingsService 키 작성</name>
  <files>internal/design/75-notification-channel-push-relay.md</files>
  <action>
doc 75에 다음 섹션들을 추가한다:

**Section 4: SDK 알림 API (NOTIF-02 나머지)**
- subscribeToNotifications() 시그니처 확정:
  ```typescript
  function subscribeToNotifications(
    walletId: string,
    callback: (notification: NotificationMessage) => void,
    options?: { serverUrl?: string }
  ): () => void;  // unsubscribe 함수 반환
  ```
  - 매개변수 상세: walletId (UUID), callback (파싱+검증된 NotificationMessage 전달), options.serverUrl (self-hosted ntfy URL, 기본 https://ntfy.sh)
  - 반환값: unsubscribe() 함수 (EventSource.close() 호출)
  - 내부 구현 개요: ntfy SSE GET `{serverUrl}/waiaas-notify-{walletId}/sse` → JSON 파싱 → NotificationMessageSchema.parse() → callback
  - 에러 처리: SSE 연결 실패 시 console.warn + 자동 재연결(EventSource 내장), 파싱 실패 시 skip + console.warn
  - 타입스크립트 에러 클래스: NotificationParseError

- parseNotification() 시그니처 확정:
  ```typescript
  function parseNotification(data: string): NotificationMessage;
  ```
  - 매개변수: ntfy SSE 이벤트의 data 문자열 (JSON)
  - 반환값: NotificationMessage (Zod 검증 완료)
  - 에러: NotificationParseError (Zod 검증 실패 시)

- @waiaas/wallet-sdk index.ts export 목록 업데이트 (기존 6개 + 신규 2개 = 8개):
  parseSignRequest, buildSignResponse, formatDisplayMessage, sendViaNtfy, sendViaTelegram, subscribeToRequests, subscribeToNotifications, parseNotification

**Section 5: WalletNotificationChannel + NotificationService 통합 (NOTIF-03)**
- WalletNotificationChannel 인터페이스:
  ```typescript
  class WalletNotificationChannel implements INotificationChannel {
    readonly type = 'wallet_ntfy';
    async send(event: NotificationEvent): Promise<void>;
  }
  ```
- INotificationChannel 기존 인터페이스 참조 (v1.3.4 구현 완료)
- send() 구현 로직:
  1. event의 walletId 확인
  2. 해당 wallet의 owner_approval_method가 'sdk_ntfy'인지 확인 → 아니면 skip
  3. SettingsService signing_sdk.notifications_enabled 확인 → false면 skip
  4. SettingsService signing_sdk.notify_categories 필터 확인 → 빈 배열이면 전체 통과, 아니면 카테고리 매칭
  5. NotificationEvent → NotificationMessage 변환 (카테고리 매핑 + metadata 구성)
  6. ntfy publish: POST {ntfy_server}/{notify_topic_prefix}-{walletId} + JSON body + Priority 헤더
- NotificationService 확장 방식:
  - 기존 채널 배열에 WalletNotificationChannel 추가 (channels.push)
  - 채널 초기화 시 signing_sdk.enabled 확인 → true면 WalletNotificationChannel 인스턴스 생성
  - 알림 발행 시 모든 채널에 순차 전달 (기존 동작 유지, 신규 채널만 추가)
- NotificationEvent → NotificationMessage 변환 매핑 표 (기존 이벤트 타입 → 6개 카테고리 매핑)
- SettingsService 알림 관련 키 3개 확정 (m26-02 목표 파일과 일치):
  - signing_sdk.notifications_enabled: boolean, 기본 true
  - signing_sdk.notify_topic_prefix: string, 기본 "waiaas-notify"
  - signing_sdk.notify_categories: JSON array, 기본 [] (전체)
- 파일/모듈 구조:
  - packages/daemon/src/services/notification/channels/wallet-notification-channel.ts (신규)
  - packages/wallet-sdk/src/schemas.ts (NotificationMessageSchema 추가)
  - packages/wallet-sdk/src/notifications.ts (subscribeToNotifications, parseNotification)
  - packages/wallet-sdk/src/index.ts (export 추가)
  </action>
  <verify>
grep으로 doc 75에 "subscribeToNotifications", "WalletNotificationChannel", "INotificationChannel", "notifications_enabled" 키워드 존재 확인.
Section 4, 5 헤딩이 모두 존재하는지 grep 확인.
  </verify>
  <done>
doc 75에 Section 4(SDK 알림 API 2개 함수 확정), Section 5(WalletNotificationChannel 통합 + SettingsService 3키 + 이벤트 매핑) 작성 완료. NOTIF-02, NOTIF-03 충족. m26-02 구현 입력 사양 확정.
  </done>
</task>

</tasks>

<verification>
1. doc 75 파일이 internal/design/75-notification-channel-push-relay.md에 존재
2. Section 1-5 헤딩이 모두 존재
3. NotificationMessageSchema Zod 정의가 6개 카테고리를 포함
4. 토픽 네이밍 규칙 3종(sign, response, notify)이 명시
5. priority 차등 표가 존재 (5/4/3 매핑)
6. subscribeToNotifications(), parseNotification() 시그니처가 명시
7. WalletNotificationChannel 클래스 + INotificationChannel 통합 방식이 명시
8. SettingsService 3개 키(notifications_enabled, notify_topic_prefix, notify_categories)가 명시
</verification>

<success_criteria>
- NOTIF-01: 서명/알림 토픽 분리 구조 + ntfy priority 차등 정책이 Section 2에 확정
- NOTIF-02: NotificationMessage 스키마(Section 3) + SDK subscribeToNotifications()/parseNotification()(Section 4) 인터페이스 확정
- NOTIF-03: WalletNotificationChannel + INotificationChannel 통합 지점(Section 5) 확정
- 모든 인터페이스가 TypeScript 코드 레벨로 명시되어 m26-02에서 바로 구현 가능
</success_criteria>

<output>
After completion, create `.planning/phases/200-notification-channel-push-relay-design/200-01-SUMMARY.md`
</output>
