---
phase: 199-wallet-sdk-daemon-components-design
plan: 02
type: execute
wave: 2
depends_on:
  - 199-01
files_modified:
  - internal/design/74-wallet-sdk-daemon-components.md
autonomous: true
requirements:
  - DMON-01
  - DMON-02
  - DMON-03
  - DMON-04
  - DMON-05

must_haves:
  truths:
    - "SignRequestBuilder/SignResponseHandler의 인터페이스, 메서드 시그니처, 책임 경계가 확정되어 있다"
    - "NtfySigningChannel/TelegramSigningChannel의 인터페이스와 기존 인프라(v1.3 ntfy, v1.6 Telegram Bot) 재사용 지점이 확정되어 있다"
    - "WalletLinkRegistry(저장 구조) + ApprovalChannelRouter(5단계 우선순위 라우팅 로직)이 확정되어 있다"
    - "SettingsService signing_sdk 6개 키(enabled/request_expiry_min/preferred_channel/preferred_wallet/ntfy_request_topic_prefix/ntfy_response_topic_prefix)가 확정되어 있다"
    - "wallets.owner_approval_method 컬럼 설계(CHECK 제약, NULL 허용) + REST API approval_method 필드가 확정되어 있다"
  artifacts:
    - path: "internal/design/74-wallet-sdk-daemon-components.md"
      provides: "데몬 컴포넌트 인터페이스 + SettingsService 키 + DB 스키마 설계 완성본"
      contains: "## 6."
  key_links:
    - from: "internal/design/74-wallet-sdk-daemon-components.md"
      to: "internal/design/73-signing-protocol-v1.md"
      via: "ntfy/Telegram 채널 프로토콜 참조"
      pattern: "ntfy.*채널|Telegram.*채널|Section 7|Section 8"
    - from: "internal/design/74-wallet-sdk-daemon-components.md"
      to: "internal/objectives/m26-01-wallet-signing-sdk.md"
      via: "데몬 컴포넌트 인터페이스 공식화"
      pattern: "SignRequestBuilder|SignResponseHandler|WalletLinkRegistry|ApprovalChannelRouter"
---

<objective>
doc 74에 데몬 측 컴포넌트(SignRequestBuilder/SignResponseHandler/채널/라우터) 인터페이스, SettingsService signing_sdk 키, wallets.owner_approval_method DB 스키마, REST API 변경 사항을 확정하여 설계 문서를 완성한다.

Purpose: m26-01 구현 시 데몬 측 서명 컴포넌트를 바로 구현할 수 있도록 인터페이스 사양을 확정한다.
Output: internal/design/74-wallet-sdk-daemon-components.md (Sections 5-11 완성, 전체 문서 완성본)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@internal/design/73-signing-protocol-v1.md
@internal/objectives/m26-00-wallet-sdk-design.md
@internal/objectives/m26-01-wallet-signing-sdk.md

@.planning/phases/199-wallet-sdk-daemon-components-design/199-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 데몬 컴포넌트 개요 + SignRequestBuilder/SignResponseHandler + 채널 인터페이스 확정</name>
  <files>internal/design/74-wallet-sdk-daemon-components.md</files>
  <action>
doc 74의 Plan 02 placeholder 섹션들을 실제 내용으로 교체한다.

1. **Section 5: 데몬 측 컴포넌트 개요** --
   a) 6개 컴포넌트 책임 매트릭스 표:
   | 컴포넌트 | 역할 | 의존 | 위치 |
   SignRequestBuilder, SignResponseHandler, NtfySigningChannel, TelegramSigningChannel, WalletLinkRegistry, ApprovalChannelRouter

   b) 컴포넌트 간 데이터 흐름 다이어그램:
   ```
   PENDING_APPROVAL
     → ApprovalChannelRouter (채널 결정)
       → SignRequestBuilder (SignRequest 생성)
         → NtfySigningChannel / TelegramSigningChannel (전송)
           → [Owner 서명]
             → NtfySigningChannel / TelegramSigningChannel (수신)
               → SignResponseHandler (검증 + 실행)
   ```

   c) 파일 구조 (m26-01에서 실제 생성할 파일):
   ```
   packages/daemon/src/services/signing-sdk/
     sign-request-builder.ts
     sign-response-handler.ts
     wallet-link-registry.ts
     channels/
       signing-channel.interface.ts   # ISigningChannel 인터페이스
       ntfy-signing-channel.ts
       telegram-signing-channel.ts
     approval-channel-router.ts
   ```

2. **Section 6: SignRequestBuilder + SignResponseHandler** --

   a) ISignRequestBuilder 인터페이스:
   ```typescript
   interface ISignRequestBuilder {
     build(params: BuildSignRequestParams): Promise<SignRequestResult>;
   }

   type BuildSignRequestParams = {
     transaction: Transaction;           // PENDING_APPROVAL 상태의 트랜잭션
     wallet: Wallet;                     // 지갑 정보 (chain, owner 주소)
     channel: 'ntfy' | 'telegram';       // 선택된 응답 채널
   };

   type SignRequestResult = {
     signRequest: SignRequest;
     universalLinkUrl: string;
     deepLinkUrl?: string;               // deepLink 설정이 있는 경우
     responseTopic?: string;             // ntfy 채널인 경우
   };
   ```
   - build() 내부 로직: (1) requestId 생성(UUID v7), (2) 서명 메시지 텍스트 생성(doc 73 Section 5 템플릿), (3) displayMessage 생성, (4) expiresAt 계산(SettingsService에서 만료시간 조회), (5) responseChannel 구성(채널별), (6) SignRequest 조립, (7) 유니버셜 링크 URL 생성(WalletLinkRegistry 조회), (8) base64url 인코딩 + 2KB 초과 체크
   - 의존: WalletLinkRegistry(지갑 링크 정보), SettingsService(만료 시간, 토픽 접두어)

   b) ISignResponseHandler 인터페이스:
   ```typescript
   interface ISignResponseHandler {
     handle(params: HandleSignResponseParams): Promise<HandleSignResponseResult>;
   }

   type HandleSignResponseParams = {
     signResponse: SignResponse;
     sourceChannel: 'ntfy' | 'telegram';
     telegramChatId?: number;            // telegram 채널인 경우 chatId 검증용
   };

   type HandleSignResponseResult = {
     action: 'approved' | 'rejected';
     transactionId: string;
   };
   ```
   - handle() 내부 로직: (1) requestId로 원본 SignRequest 조회, (2) 만료 확인(expiresAt), (3) 이미 처리 여부 확인(SIGN_REQUEST_ALREADY_PROCESSED), (4) signerAddress 검증(Owner 주소 매칭), (5) Telegram인 경우 chatId 검증, (6) action=approve: 서명 검증(ownerAuth EIP-191/Ed25519), (7) 트랜잭션 상태 전환(EXECUTING/CANCELLED), (8) 결과 반환
   - 의존: ownerAuth(기존 v1.2 검증 로직), TransactionService(상태 전환)
   - 에러: doc 73 Section 11의 8개 에러 코드 매핑

3. **Section 7: NtfySigningChannel + TelegramSigningChannel** --

   a) ISigningChannel 공통 인터페이스:
   ```typescript
   interface ISigningChannel {
     readonly type: 'ntfy' | 'telegram';
     sendRequest(signRequest: SignRequest, universalLinkUrl: string, wallet: Wallet): Promise<void>;
     waitForResponse(requestId: string, expiresAt: Date, signal?: AbortSignal): Promise<SignResponse>;
   }
   ```

   b) NtfySigningChannel 구현 설계:
   - sendRequest(): doc 73 Section 7.2의 JSON publish 프로토콜(Priority:5, Actions 헤더, click URL)
   - waitForResponse(): doc 73 Section 7.3의 SSE 구독(GET /{responseTopic}/sse). 종료 조건: SignResponse 수신 / expiresAt 도달 / 네트워크 에러(재연결 3회)
   - 의존: SettingsService(ntfy_server URL, 토픽 접두어), fetch(ntfy HTTP API)
   - 기존 인프라 재사용: v1.3 NtfyChannel의 HTTP publish 로직

   c) TelegramSigningChannel 구현 설계:
   - sendRequest(): doc 73 Section 8.1의 Bot API sendMessage(InlineKeyboardMarkup에 유니버셜 링크)
   - waitForResponse(): 기존 Telegram Bot Long Polling에 /sign_response 명령어 핸들러 등록. handle() 호출 시 Promise resolve
   - 의존: TelegramNotificationService(기존 v1.6 Bot 인프라), chatId 매핑
   - 기존 인프라 재사용: v1.6 TelegramNotificationService의 sendMessage + Long Polling
  </action>
  <verify>
doc 74에서 ISignRequestBuilder, ISignResponseHandler, ISigningChannel 인터페이스가 TypeScript 코드 블록으로 정의되어 있는지 grep 확인. "BuildSignRequestParams", "HandleSignResponseParams", "NtfySigningChannel", "TelegramSigningChannel" 키워드 존재 확인.
  </verify>
  <done>SignRequestBuilder(build 메서드 + 7단계 내부 로직) + SignResponseHandler(handle 메서드 + 8단계 검증 로직) + ISigningChannel 공통 인터페이스 + NtfySigningChannel(publish/SSE) + TelegramSigningChannel(Bot API/Long Polling) 인터페이스와 책임 경계가 확정되어 있다</done>
</task>

<task type="auto">
  <name>Task 2: WalletLinkRegistry + ApprovalChannelRouter + SettingsService 키 + DB 스키마 + 기술 결정 요약</name>
  <files>internal/design/74-wallet-sdk-daemon-components.md</files>
  <action>
doc 74의 나머지 섹션(8-11)을 작성하여 문서를 완성한다.

1. **Section 8: WalletLinkRegistry + ApprovalChannelRouter** --

   a) WalletLinkRegistry 인터페이스:
   ```typescript
   interface IWalletLinkRegistry {
     getWalletLink(walletName: string): WalletLinkConfig;
     getAllWallets(): WalletLinkConfig[];
     buildUniversalLinkUrl(walletName: string, signRequest: SignRequest): string;
     buildDeepLinkUrl(walletName: string, signRequest: SignRequest): string | null;
   }
   ```
   - 저장 구조: SettingsService의 `signing_sdk.wallets` 키에 JSON 배열로 저장 (m26-01 objective에서 결정). settings 테이블 활용
   - CRUD: Admin UI에서 지갑 등록/수정/삭제 → SettingsService 통해 저장/조회
   - 캐시: SettingsService 값 변경 시 캐시 무효화 (기존 SettingsService 패턴 따름)

   b) ApprovalChannelRouter 인터페이스:
   ```typescript
   interface IApprovalChannelRouter {
     resolveChannel(wallet: Wallet): Promise<ResolvedChannel>;
   }

   type ResolvedChannel = {
     type: 'sdk_ntfy' | 'sdk_telegram' | 'walletconnect' | 'telegram_bot' | 'rest';
     signingChannel?: ISigningChannel;    // sdk_ntfy / sdk_telegram 시
   };
   ```
   - 라우팅 로직 의사코드 (5단계 우선순위):
   ```
   1. wallet.owner_approval_method가 설정됨?
      → YES: 해당 채널 반환 (sdk_ntfy/sdk_telegram/walletconnect/telegram_bot/rest)
      → NO: 2단계로
   2. signing_sdk.enabled === true?
      → NO: 4단계로
   3. signing_sdk.preferred_channel 확인
      → "ntfy": sdk_ntfy 반환
      → "telegram": sdk_telegram 반환
   4. WalletConnect 세션 활성?
      → YES: walletconnect 반환
      → NO: 5단계로
   5. Telegram chatId 설정됨?
      → YES: telegram_bot 반환
      → NO: rest 반환
   ```
   - 의존: SettingsService(signing_sdk.enabled, preferred_channel), WcSigningBridge(WC 세션 확인)

2. **Section 9: SettingsService signing_sdk 키** --
   m26-01 objective에서 정의된 6개 키를 공식화:

   | 키 | 타입 | 기본값 | 검증 | 설명 |
   |---|---|---|---|---|
   | signing_sdk.enabled | boolean | false | - | SDK 전체 활성/비활성 |
   | signing_sdk.request_expiry_min | number | 30 | min:1, max:1440 | 서명 요청 유효 시간(분) |
   | signing_sdk.preferred_channel | string | "ntfy" | enum: ntfy, telegram | 기본 응답 채널 |
   | signing_sdk.preferred_wallet | string | null | WalletLinkRegistry에 존재해야 함 | 글로벌 기본 지갑 |
   | signing_sdk.ntfy_request_topic_prefix | string | "waiaas-sign" | regex: ^[a-z0-9-]+$ | ntfy 요청 토픽 접두어 |
   | signing_sdk.ntfy_response_topic_prefix | string | "waiaas-response" | regex: ^[a-z0-9-]+$ | ntfy 응답 토픽 접두어 |

   + signing_sdk.wallets (JSON 배열, WalletLinkRegistry 저장소)

   Admin UI에서의 표시 위치: System > Settings > Signing SDK 섹션
   ntfy_server URL은 기존 [notifications] ntfy_server 재사용 (별도 키 추가 안 함)

3. **Section 10: wallets.owner_approval_method + REST API** --

   a) DB 스키마 변경:
   ```sql
   ALTER TABLE wallets ADD COLUMN owner_approval_method TEXT;
   -- CHECK (owner_approval_method IN ('sdk_ntfy', 'sdk_telegram', 'walletconnect', 'telegram_bot', 'rest'))
   ```
   - NULL 허용 (미설정 = 글로벌 fallback)
   - 마이그레이션 버전: 기존 schema_version 테이블 패턴 따름
   - Drizzle 스키마 변경: wallets 테이블에 ownerApprovalMethod 컬럼 추가

   b) REST API 변경:
   - `PUT /v1/wallets/:id/owner` 요청 스키마에 `approval_method` optional 필드 추가
   - `GET /v1/wallets/:id` 응답에 `owner_approval_method` 필드 포함
   - 유효하지 않은 approval_method → 400 에러
   - Owner 미등록 지갑에 approval_method 설정 시도 → 400 에러 ("Owner must be registered first")

   c) Admin UI 변경:
   - 지갑 상세 페이지 Owner Settings 섹션에 Approval Method 라디오 버튼 추가
   - m26-01 objective의 와이어프레임 참조
   - Owner 미등록 시 비활성(disabled) 처리
   - 미구성 인프라 선택 시 경고 메시지 (예: ntfy 미설정 + sdk_ntfy → "ntfy is not configured")

4. **Section 11: 기술 결정 요약** --
   Phase 199에서 내린 설계 결정 정리 표:
   - SDK parseSignRequest의 동기/비동기 분기 (data=동기, requestId=비동기 → Promise<SignRequest> 반환)
   - ISigningChannel 공통 인터페이스 도입 (ntfy/telegram 채널 교체 가능)
   - WalletLinkRegistry 저장소를 settings 테이블 JSON으로 결정 (별도 테이블 아님)
   - ApprovalChannelRouter 5단계 fallback 순서 확정
   - owner_approval_method CHECK 제약 + NULL 허용 패턴
   - 문서 메타데이터 (문서 번호: 74, 생성일, 선행 문서: 73, 관련 마일스톤)
  </action>
  <verify>
doc 74에서 IWalletLinkRegistry, IApprovalChannelRouter, ResolvedChannel 인터페이스, SettingsService 6개 키 표, ALTER TABLE wallets ADD COLUMN, PUT /v1/wallets/:id/owner 스키마가 포함되어 있는지 grep 확인. "signing_sdk.enabled", "owner_approval_method", "ApprovalChannelRouter", "WalletLinkRegistry" 키워드 존재 확인.
  </verify>
  <done>WalletLinkRegistry(JSON 저장 구조 + CRUD) + ApprovalChannelRouter(5단계 라우팅 의사코드) + SettingsService 6개 키(타입/기본값/검증) + wallets.owner_approval_method(ALTER TABLE + CHECK + Drizzle) + REST API approval_method 필드 + Admin UI 와이어프레임 참조 + 기술 결정 요약이 확정되어 doc 74가 완성되어 있다</done>
</task>

</tasks>

<verification>
1. doc 74 전체 11개 섹션이 모두 실제 내용으로 채워져 있다 (placeholder 없음)
2. Section 5: 6개 데몬 컴포넌트 책임 매트릭스 + 데이터 흐름 다이어그램
3. Section 6: SignRequestBuilder(build 7단계) + SignResponseHandler(handle 8단계) 인터페이스
4. Section 7: ISigningChannel + NtfySigningChannel + TelegramSigningChannel
5. Section 8: WalletLinkRegistry(JSON 저장) + ApprovalChannelRouter(5단계 라우팅)
6. Section 9: SettingsService 6개 키 + signing_sdk.wallets
7. Section 10: wallets.owner_approval_method ALTER TABLE + REST API + Admin UI
8. Section 11: 기술 결정 요약 표 + 문서 메타데이터
</verification>

<success_criteria>
- doc 74가 완성본으로 존재한다 (모든 11개 섹션)
- 데몬 6개 컴포넌트의 TypeScript 인터페이스가 확정되어 있다
- ApprovalChannelRouter의 5단계 라우팅 로직이 의사코드로 확정되어 있다
- SettingsService signing_sdk 6개 키 + wallets JSON이 확정되어 있다
- wallets.owner_approval_method 컬럼 + REST API 변경이 확정되어 있다
- m26-01에서 바로 구현을 시작할 수 있는 상태
</success_criteria>

<output>
After completion, create `.planning/phases/199-wallet-sdk-daemon-components-design/199-02-SUMMARY.md`
</output>
