---
phase: 199-wallet-sdk-daemon-components-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/design/74-wallet-sdk-daemon-components.md
autonomous: true
requirements:
  - WSDK-01
  - WSDK-02
  - WSDK-03

must_haves:
  truths:
    - "@waiaas/wallet-sdk 6개 공개 함수의 시그니처, 매개변수 타입, 반환 타입이 확정되어 있다"
    - "WalletLinkConfig Zod 스키마 + registerWallet() 등록 플로우가 확정되어 지갑 개발사가 해야 할 작업 목록을 알 수 있다"
    - "packages/wallet-sdk/ 디렉토리 구조, tsconfig, package.json 설정, 빌드/배포 방법이 확정되어 있다"
  artifacts:
    - path: "internal/design/74-wallet-sdk-daemon-components.md"
      provides: "Wallet SDK 공개 API + WalletLinkConfig + 패키지 구조 설계"
      contains: "## 1."
  key_links:
    - from: "internal/design/74-wallet-sdk-daemon-components.md"
      to: "internal/design/73-signing-protocol-v1.md"
      via: "SignRequest/SignResponse 스키마 참조"
      pattern: "SignRequestSchema|SignResponseSchema"
    - from: "internal/design/74-wallet-sdk-daemon-components.md"
      to: "internal/objectives/m26-01-wallet-signing-sdk.md"
      via: "SDK API 시그니처 공식화"
      pattern: "parseSignRequest|buildSignResponse|formatDisplayMessage|sendViaNtfy|sendViaTelegram|subscribeToRequests"
---

<objective>
doc 74(Wallet SDK + 데몬 컴포넌트 설계서) 문서를 생성하고, @waiaas/wallet-sdk 패키지의 공개 API 인터페이스(6개 함수 시그니처 + 반환 타입), WalletLinkConfig 스키마 + registerWallet() 등록 플로우, 패키지 구조 + 빌드/배포 설정을 확정한다.

Purpose: m26-01 구현 시 SDK 패키지를 바로 생성하고 공개 API를 구현할 수 있도록 입력 사양을 확정한다.
Output: internal/design/74-wallet-sdk-daemon-components.md (Sections 1-5, 전체 목차 포함)
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@internal/design/73-signing-protocol-v1.md
@internal/objectives/m26-00-wallet-sdk-design.md
@internal/objectives/m26-01-wallet-signing-sdk.md

@.planning/phases/198-signing-protocol-v1-design/198-01-SUMMARY.md
@.planning/phases/198-signing-protocol-v1-design/198-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: doc 74 골격 + 문서 개요 + SDK 공개 API 6개 함수 시그니처 확정</name>
  <files>internal/design/74-wallet-sdk-daemon-components.md</files>
  <action>
doc 74 설계 문서를 생성한다. doc 73의 형식과 구조를 따른다.

1. **문서 골격 생성** -- 전체 섹션 목차:
   - 1. 개요 (문서 목적, 적용 범위, doc 73 참조 관계)
   - 2. @waiaas/wallet-sdk 공개 API
   - 3. WalletLinkConfig + registerWallet()
   - 4. 패키지 구조 + 빌드/배포
   - 5. 데몬 측 컴포넌트 개요
   - 6. SignRequestBuilder + SignResponseHandler
   - 7. NtfySigningChannel + TelegramSigningChannel
   - 8. WalletLinkRegistry + ApprovalChannelRouter
   - 9. SettingsService signing_sdk 키
   - 10. wallets.owner_approval_method 컬럼 + REST API
   - 11. 기술 결정 요약

2. **Section 1: 개요** -- 문서 목적(doc 73 프로토콜을 기반으로 SDK/데몬 컴포넌트 인터페이스 확정), 적용 범위(m26-01 구현 입력), doc 73과의 관계(스키마 참조, 채널 프로토콜 참조)

3. **Section 2: @waiaas/wallet-sdk 공개 API** -- m26-01 objective에 정의된 6개 함수를 공식 TypeScript 시그니처로 확정:

   a) `parseSignRequest(url: string): SignRequest | Promise<SignRequest>` -- 유니버셜 링크/딥링크 URL에서 SignRequest 추출 + Zod 검증. data 파라미터(인라인) / requestId 파라미터(ntfy 조회) 2가지 모드 분기. 에러: InvalidSignRequestUrlError, SignRequestExpiredError

   b) `buildSignResponse(params: { requestId: string; action: 'approve' | 'reject'; signature?: string; signerAddress: string }): SignResponse` -- SignResponse 객체 생성. signedAt 자동 생성(현재 시각 ISO 8601). approve 시 signature 필수 검증

   c) `formatDisplayMessage(request: SignRequest): string` -- SignRequest를 사람 읽기용 텍스트로 변환. 지갑 앱 UI 표시용. Amount/Symbol 없으면 해당 줄 생략

   d) `sendViaNtfy(response: SignResponse, responseTopic: string, serverUrl?: string): Promise<void>` -- ntfy 응답 토픽에 base64url(JSON) POST. 기본 serverUrl: https://ntfy.sh

   e) `sendViaTelegram(response: SignResponse, botUsername: string): void` -- 플랫폼(Android/iOS/기타) 감지 후 Telegram 딥링크/유니버셜 링크/클립보드 순서로 전송. /sign_response {base64url(SignResponse)} 형식

   f) `subscribeToRequests(topic: string, callback: (request: SignRequest) => void, options?: { serverUrl?: string; signal?: AbortSignal }): () => void` -- ntfy 요청 토픽 SSE 구독. 콜백으로 SignRequest 전달. AbortSignal로 구독 취소. 반환값은 unsubscribe 함수

   각 함수마다: 시그니처(전체 TypeScript), 매개변수 상세 표, 반환 타입 상세, 에러 케이스, 코드 예시(지갑 앱 통합 시나리오)를 포함한다.

   Sections 5-11은 Plan 02에서 작성할 것이므로 "Plan 02에서 작성" placeholder를 남긴다.
  </action>
  <verify>
internal/design/74-wallet-sdk-daemon-components.md 파일이 존재하고, Section 1-2가 작성되었으며, 6개 함수 시그니처가 TypeScript 코드 블록으로 포함되어 있는지 확인한다. grep으로 parseSignRequest, buildSignResponse, formatDisplayMessage, sendViaNtfy, sendViaTelegram, subscribeToRequests 6개 함수명이 모두 존재하는지 확인.
  </verify>
  <done>doc 74 전체 목차(11개 섹션) + Section 1(개요) + Section 2(SDK 공개 API 6개 함수 시그니처/매개변수/반환타입/에러/코드예시)가 확정되어 있다</done>
</task>

<task type="auto">
  <name>Task 2: WalletLinkConfig 스키마 + registerWallet() 플로우 + 패키지 구조 확정</name>
  <files>internal/design/74-wallet-sdk-daemon-components.md</files>
  <action>
doc 74에 Section 3, Section 4를 작성한다.

1. **Section 3: WalletLinkConfig + registerWallet()** --

   a) WalletLinkConfig Zod 스키마 확정 -- m26-01 objective의 스키마를 기반으로 공식화:
   ```typescript
   const WalletLinkConfigSchema = z.object({
     name: z.string().min(1).max(50).regex(/^[a-z0-9-]+$/),  // "dcent"
     displayName: z.string().min(1).max(100),                  // "D'CENT Wallet"
     universalLink: z.object({
       base: z.string().url(),                                 // "https://link.dcentwallet.com"
       signPath: z.string().startsWith('/'),                   // "/waiaas/sign"
     }),
     deepLink: z.object({
       scheme: z.string(),                                     // "dcent"
       signPath: z.string(),                                   // "/waiaas-sign"
     }).optional(),
     ntfy: z.object({
       requestTopicPattern: z.string(),                        // "{prefix}-{walletId}" 패턴
     }).optional(),
     supportedChains: z.array(z.enum(['solana', 'evm'])).min(1),
   });
   ```
   각 필드 상세 표(필드/타입/필수/설명/제약조건) 포함.

   b) registerWallet() 인터페이스:
   - `registerWallet(config: WalletLinkConfig): void` -- SDK에서 지갑 메타데이터 등록 (SDK 내부 Registry에 저장, 데몬 측 WalletLinkRegistry와는 별개)
   - SDK 초기화 시 사용 예시 코드

   c) 지갑 개발사 통합 작업 목록 -- D'CENT 예시로 체크리스트:
   - AASA 파일에 /waiaas/* 경로 추가
   - assetlinks.json 확인 (Android)
   - 앱 내 URL 핸들러 구현 (/waiaas/sign 경로)
   - ntfy 구독 설정 (subscribeToRequests)
   - 서명 응답 전송 (sendViaNtfy / sendViaTelegram)
   - 웹 fallback 페이지 구현 (PC QR 코드)

2. **Section 4: 패키지 구조 + 빌드/배포** --

   a) 디렉토리 구조:
   ```
   packages/wallet-sdk/
     src/
       index.ts                    # re-export 공개 API
       schemas.ts                  # SignRequest/SignResponse Zod 스키마 (doc 73에서 정의)
       parse-request.ts            # parseSignRequest()
       build-response.ts           # buildSignResponse()
       display.ts                  # formatDisplayMessage()
       channels/
         ntfy.ts                   # sendViaNtfy(), subscribeToRequests()
         telegram.ts               # sendViaTelegram()
         index.ts                  # 채널 통합 인터페이스
       wallet-config.ts            # registerWallet(), WalletLinkConfig
       utils/
         base64url.ts              # base64url encode/decode
         platform.ts               # detectPlatform()
       errors.ts                   # SDK 전용 에러 클래스
     package.json
     tsconfig.json
     tsup.config.ts
     README.md
   ```

   b) package.json 핵심 설정:
   - name: @waiaas/wallet-sdk
   - exports: { ".": { import, require, types } }
   - peerDependencies: zod (기존 모노레포와 동일 버전)
   - dependencies: 최소화 (zod만 peer, fetch는 내장)

   c) 빌드 설정: tsup (ESM + CJS dual output), 타겟 환경(React Native, Electron, Node.js)

   d) 배포: 기존 모노레포 release-please + OIDC Trusted Publishing 파이프라인 통합

   e) 대상 환경별 호환성 표:
   | 환경 | 지원 | 비고 |
   | React Native | O | fetch 내장, ntfy SSE 가능 |
   | Electron | O | Node.js 기반 |
   | Node.js 18+ | O | fetch 내장 |
   | 브라우저 | 부분 | sendViaTelegram만 (딥링크) |
  </action>
  <verify>
doc 74에서 WalletLinkConfigSchema Zod 정의, registerWallet 함수 시그니처, 디렉토리 구조, package.json 설정이 포함되어 있는지 grep으로 확인. "WalletLinkConfigSchema", "registerWallet", "packages/wallet-sdk", "tsup" 키워드 존재 확인.
  </verify>
  <done>WalletLinkConfig Zod 스키마(name/displayName/universalLink/deepLink/ntfy/supportedChains) + registerWallet() 인터페이스 + 지갑 개발사 통합 체크리스트 + packages/wallet-sdk/ 디렉토리 구조 + package.json + 빌드/배포 설정이 확정되어 있다</done>
</task>

</tasks>

<verification>
1. internal/design/74-wallet-sdk-daemon-components.md 파일이 존재하고 11개 섹션 목차가 있다
2. Section 1(개요): 문서 목적, 적용 범위, doc 73 참조 관계가 명시되어 있다
3. Section 2(SDK 공개 API): 6개 함수 모두 TypeScript 시그니처 + 매개변수 표 + 반환 타입 + 에러 케이스가 있다
4. Section 3(WalletLinkConfig): Zod 스키마 + registerWallet() + 지갑 개발사 통합 체크리스트가 있다
5. Section 4(패키지 구조): 디렉토리 구조 + package.json + 빌드/배포 설정이 있다
</verification>

<success_criteria>
- doc 74 Sections 1-4가 완성되어 있다
- 6개 SDK 공개 함수의 시그니처와 반환 타입이 TypeScript 코드 블록으로 확정되어 있다
- WalletLinkConfig Zod 스키마가 확정되어 있다
- packages/wallet-sdk/ 패키지 구조와 빌드/배포 설정이 확정되어 있다
- Sections 5-11에는 Plan 02 placeholder가 있다
</success_criteria>

<output>
After completion, create `.planning/phases/199-wallet-sdk-daemon-components-design/199-01-SUMMARY.md`
</output>
