---
phase: 201-design-doc-update-cross-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/design/35-notification-architecture.md
  - internal/design/37-rest-api-complete-spec.md
  - internal/design/25-sqlite-schema.md
  - internal/design/67-admin-web-ui-spec.md
autonomous: true
requirements: [DOCS-01, DOCS-02, DOCS-03, DOCS-04]

must_haves:
  truths:
    - "doc 35에 WalletNotificationChannel 어댑터와 waiaas-sign-*/waiaas-notify-* 토픽 분리 구조가 설명되어 있다"
    - "doc 37에 PUT /v1/wallets/:id/owner 요청 스키마에 approval_method 필드가 추가되어 있고 GET /v1/wallets/:id 응답에 owner_approval_method가 포함되어 있다"
    - "doc 25에 wallets.owner_approval_method 컬럼 정의와 ALTER TABLE 마이그레이션이 추가되어 있다"
    - "doc 67에 Wallet Detail 페이지 Owner Settings 섹션에 Approval Method UI 와이어프레임과 컴포넌트 동작 규칙이 추가되어 있다"
    - "4개 설계 문서 간 용어, 스키마, enum 값이 일관성을 유지한다"
  artifacts:
    - path: "internal/design/35-notification-architecture.md"
      provides: "WalletNotificationChannel 어댑터 + 서명/알림 토픽 분리 구조"
      contains: "WalletNotificationChannel"
    - path: "internal/design/37-rest-api-complete-spec.md"
      provides: "approval_method 필드 확장 REST API 스펙"
      contains: "approval_method"
    - path: "internal/design/25-sqlite-schema.md"
      provides: "owner_approval_method 컬럼 + 마이그레이션"
      contains: "owner_approval_method"
    - path: "internal/design/67-admin-web-ui-spec.md"
      provides: "Approval Method UI 와이어프레임 + 컴포넌트 설계"
      contains: "Approval Method"
  key_links:
    - from: "internal/design/25-sqlite-schema.md"
      to: "internal/design/37-rest-api-complete-spec.md"
      via: "owner_approval_method 컬럼 <-> REST API approval_method 필드"
      pattern: "owner_approval_method"
    - from: "internal/design/37-rest-api-complete-spec.md"
      to: "internal/design/67-admin-web-ui-spec.md"
      via: "PUT /v1/wallets/:id/owner approval_method <-> Admin UI Approval Method 라디오"
      pattern: "approval_method"
    - from: "internal/design/35-notification-architecture.md"
      to: "internal/design/75-notification-channel-push-relay.md"
      via: "INotificationChannel 인터페이스 + WalletNotificationChannel 참조"
      pattern: "WalletNotificationChannel"
---

<objective>
4개 기존 설계 문서(doc 35/37/25/67)에 Phase 198-200에서 확정된 신규 설계(doc 73/74/75)를 반영하고, 문서 간 교차 검증으로 설계 부채 0건을 유지한다.

Purpose: v2.6 마일스톤의 최종 단계로, 신규 설계가 기존 문서에 통합되어야 구현 시 단일 소스를 참조할 수 있다.
Output: 4개 설계 문서 업데이트 + 교차 검증 PASS
</objective>

<execution_context>
@/Users/minho.yoo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/minho.yoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 신규 설계 문서 (변경 소스)
@internal/design/73-signing-protocol-v1.md
@internal/design/74-wallet-sdk-daemon-components.md
@internal/design/75-notification-channel-push-relay.md

# 업데이트 대상 설계 문서
@internal/design/35-notification-architecture.md
@internal/design/37-rest-api-complete-spec.md
@internal/design/25-sqlite-schema.md
@internal/design/67-admin-web-ui-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: doc 35 알림 아키텍처 + doc 37 REST API 업데이트</name>
  <files>internal/design/35-notification-architecture.md, internal/design/37-rest-api-complete-spec.md</files>
  <action>
**doc 35 (35-notification-architecture.md) 업데이트:**

1. 문서 헤더에 v2.6 보완 날짜 추가: `**v2.6 보완:** 2026-02-20`

2. 섹션 1.1 목적에 다음 항목 추가:
   - `**WalletNotificationChannel 어댑터**: 지갑 앱 알림 채널 (waiaas-notify-{walletId} ntfy 토픽)`
   - `**서명/알림 토픽 분리**: waiaas-sign-{walletId} (서명 요청) vs waiaas-notify-{walletId} (일반 알림)`

3. 섹션 1.5 알림 호출 포인트 테이블 하단에 `[v2.6]` 주석으로 다음 추가:
   - `[v2.6] 지갑 앱 알림` | `(25개 NotificationEventType 중 필터링)` | `WalletNotificationChannel.send()` | `NotificationService -> WalletNotificationChannel (별도 ntfy 토픽)`
   - 토픽 분리 설명: 서명 요청은 `waiaas-sign-{walletId}` 토픽(doc 73 참조), 알림은 `waiaas-notify-{walletId}` 토픽(doc 75 참조)

4. 섹션 2 INotificationChannel 인터페이스 하단에 `[v2.6]` 주석으로 참조 추가:
   - WalletNotificationChannel이 INotificationChannel을 구현한다는 참조 (상세는 doc 75 섹션 5 참조)

5. 섹션 13 구현 노트 또는 섹션 14 직전에 새 섹션 추가 (기존 섹션 번호를 깨지 않도록 13.2 또는 적절한 위치):
   ```
   ### 13.2 [v2.6] WalletNotificationChannel + 서명/알림 토픽 구조

   v2.6에서 WalletNotificationChannel이 4번째 INotificationChannel 구현체로 추가된다. 기존 3개 채널(Telegram/Discord/ntfy)과 병렬로 동작하며, 지갑 앱에 ntfy push로 알림을 전달한다.

   **토픽 분리:**
   | 토픽 | 접두어 | 용도 | 참조 |
   |------|--------|------|------|
   | 서명 요청 | waiaas-sign-{walletId} | 데몬 -> 지갑 앱: 서명 요청 | doc 73, doc 74 |
   | 서명 응답 | waiaas-response-{requestId} | 지갑 앱 -> 데몬: 서명 결과 | doc 73 |
   | 일반 알림 | waiaas-notify-{walletId} | 데몬 -> 지갑 앱: 알림 | doc 75 |

   **ntfy priority 차등 (알림 토픽):**
   | 카테고리 | priority | 예시 이벤트 |
   |---------|----------|------------|
   | security_alert | 5 (urgent) | KILL_SWITCH_ACTIVATED |
   | policy_violation | 4 (high) | 정책 위반 감지 |
   | transaction | 3 (default) | TX_CONFIRMED, TX_FAILED |
   | session | 3 (default) | SESSION_CREATED |
   | system | 3 (default) | DAILY_SUMMARY |
   | owner | 3 (default) | Owner 관련 알림 |

   **NotificationService 통합:** WalletNotificationChannel은 기존 채널 배열에 추가 등록되어 broadcast/notify 시 함께 호출된다. 내부에서 walletId 조건과 카테고리 필터를 적용하여 해당 지갑에 알림을 보낸다.

   **상세 설계:** doc 75 (75-notification-channel-push-relay.md) 섹션 5 참조.
   ```

6. 섹션 14 요구사항 매핑 총괄에 v2.6 행 추가:
   - `[v2.6] WalletNotificationChannel` | **doc 75로 확장** | 섹션 13.2: 토픽 분리 + WalletNotificationChannel 참조. 상세 구현은 doc 75 섹션 5

7. 참조 문서 목록(문서 헤더)에 doc 73, 74, 75 추가

**doc 37 (37-rest-api-complete-spec.md) 업데이트:**

1. 문서 헤더에 v2.6 보완 날짜 추가: `**v2.6 보완:** 2026-02-20`

2. 섹션 1.4 전체 엔드포인트 요약에 v2.6 변경 주석 추가:
   > **[v2.6] 변경:** PUT /v1/wallets/:id/owner 요청 스키마에 `approval_method` optional 필드 추가. GET /v1/wallets/:id 응답에 `owner_approval_method` 필드 추가. doc 74 섹션 10.2 참조.

3. 섹션 8 Owner API 영역에 기존 PUT /v1/wallets/:id/owner에 대한 스키마 변경 추가. 기존 section 8.14 (GET /v1/owner/agents/:id) 하단 또는 가장 적절한 위치에 `[v2.6]` 주석으로:

   ```
   #### [v2.6] PUT /v1/wallets/:id/owner -- approval_method 필드 추가

   기존 PUT /v1/wallets/:id/owner 요청 스키마에 `approval_method` optional 필드를 추가한다.

   **변경된 Request Zod 스키마:**

   const UpdateOwnerSchema = z.object({
     owner_address: z.string(),
     approval_method: z.enum([
       'sdk_ntfy', 'sdk_telegram', 'walletconnect', 'telegram_bot', 'rest',
     ]).nullable().optional(),
     // optional: 생략 시 기존 값 유지
     // null: 글로벌 fallback으로 초기화
   });

   **검증 규칙:**
   | 조건 | 결과 | HTTP |
   |------|------|------|
   | approval_method가 유효한 enum 값 | DB 업데이트 | 200 |
   | approval_method가 유효하지 않은 값 | 에러 | 400 |
   | approval_method 생략 | 기존 값 유지 | 200 |
   | approval_method: null (명시적) | NULL로 초기화 (글로벌 fallback) | 200 |
   | Owner 미등록 지갑에 설정 시도 | 에러 | 400 "Owner must be registered first" |

   **GET /v1/wallets/:id 응답 변경:**
   응답에 `owner_approval_method` 필드 추가 (null | string). 미설정 시 null.

   상세: doc 74 (74-wallet-sdk-daemon-components.md) 섹션 10.2 참조.
   ```

4. 섹션 15 전체 엔드포인트 맵에 v2.6 변경 주석으로 PUT /v1/wallets/:id/owner 행에 `[v2.6 스키마 확장]` 표시 추가

5. 참조 문서 목록(문서 헤더)에 doc 74 추가
  </action>
  <verify>
doc 35에서 "WalletNotificationChannel", "waiaas-sign-", "waiaas-notify-" 문자열이 검색되는지 확인.
doc 37에서 "approval_method", "owner_approval_method", "sdk_ntfy" 문자열이 검색되는지 확인.
두 문서 모두 v2.6 보완 날짜가 헤더에 존재하는지 확인.
  </verify>
  <done>
doc 35에 WalletNotificationChannel 어댑터와 서명/알림 토픽 분리 구조(waiaas-sign-*/waiaas-notify-*)가 추가되어 있다.
doc 37에 PUT /v1/wallets/:id/owner 요청의 approval_method 필드와 GET /v1/wallets/:id 응답의 owner_approval_method 필드가 추가되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: doc 25 SQLite 스키마 + doc 67 Admin UI 업데이트</name>
  <files>internal/design/25-sqlite-schema.md, internal/design/67-admin-web-ui-spec.md</files>
  <action>
**doc 25 (25-sqlite-schema.md) 업데이트:**

1. 문서 헤더에 v2.6 업데이트 날짜 추가: `**v2.6 업데이트:** 2026-02-20`

2. 섹션 2.1 agents 테이블 Drizzle 스키마에 `ownerApprovalMethod` 컬럼 추가:
   - 위치: `suspensionReason` 바로 다음
   ```typescript
   ownerApprovalMethod: text('owner_approval_method'),  // [v2.6] 지갑별 승인 방법 (NULL = 글로벌 fallback)
   ```
   - CHECK 제약 추가 (기존 table => [...] 배열에):
   ```typescript
   check('check_owner_approval_method', sql`owner_approval_method IS NULL OR owner_approval_method IN ('sdk_ntfy', 'sdk_telegram', 'walletconnect', 'telegram_bot', 'rest')`),
   ```

3. 섹션 2.1 SQL CREATE TABLE 블록에 컬럼 추가:
   ```sql
   owner_approval_method TEXT
     CHECK (owner_approval_method IS NULL OR owner_approval_method IN ('sdk_ntfy', 'sdk_telegram', 'walletconnect', 'telegram_bot', 'rest')),
   ```

4. 섹션 2.1 컬럼 설명 테이블에 행 추가:
   | `owner_approval_method` | TEXT | NULL | - | [v2.6] 지갑별 Owner 승인 방법. NULL이면 ApprovalChannelRouter 글로벌 fallback 사용. enum: sdk_ntfy, sdk_telegram, walletconnect, telegram_bot, rest |

5. 섹션 4 마이그레이션 전략에 v2.6 마이그레이션 섹션 추가 (기존 마지막 마이그레이션 다음에):
   ```
   ### 4.13 [v2.6] 마이그레이션: wallets.owner_approval_method 컬럼 추가

   v2.6에서 wallets 테이블에 `owner_approval_method` 컬럼을 추가한다. NULL 허용이므로 ALTER TABLE ADD COLUMN으로 간단히 추가 가능하다 (테이블 재생성 불필요).

   **전제 조건:**
   - v0.8 마이그레이션(섹션 4.11) 완료 상태

   **마이그레이션 SQL:**

   -- v2.6: owner_approval_method 컬럼 추가
   ALTER TABLE wallets ADD COLUMN owner_approval_method TEXT;

   **CHECK 제약 추가 (선택적):**
   SQLite에서 ALTER TABLE으로 CHECK 제약을 추가할 수 없으므로, CHECK 제약은 애플리케이션 레벨(Zod 검증)에서 처리한다.
   향후 테이블 재생성이 필요한 다른 마이그레이션과 함께 CHECK 제약을 DB 레벨에 적용할 수 있다.

   **검증:**
   PRAGMA table_info(wallets); 로 owner_approval_method 컬럼 존재 확인.

   **상세:** doc 74 (74-wallet-sdk-daemon-components.md) 섹션 10.1 참조.
   ```

6. 섹션 6 전체 스키마 export의 agents/wallets Drizzle 정의에 ownerApprovalMethod 컬럼 추가 (이 섹션은 전체 스키마 복사본이므로 동기화 필수)

7. 섹션 8 요구사항 매핑 총괄의 v0.8 요구사항 그룹 하단에 v2.6 행 추가:
   ```
   **v2.6 추가 요구사항:**

   | 요구사항 | 테이블/섹션 | 커버리지 |
   |---------|-----------|---------|
   | DOCS-03 (owner_approval_method 컬럼) | wallets (섹션 2.1) | `owner_approval_method` TEXT nullable + CHECK 제약. NULL = 글로벌 fallback. enum: sdk_ntfy/sdk_telegram/walletconnect/telegram_bot/rest |
   ```

8. 참조 문서 목록(문서 헤더)에 doc 74 추가

**doc 67 (67-admin-web-ui-spec.md) 업데이트:**

1. 문서 헤더 또는 개요에 v2.6 보완 날짜 추가

2. 섹션 8.2.2 Detail 뷰 (`#/agents/:id`) 와이어프레임에 Owner Settings 섹션 추가. 기존 와이어프레임의 "Terminate Agent" 버튼 위에 Owner Settings 블록 삽입:

   ```
   │                                                     │
   │  ── Owner Settings ─────────────────────────────── │
   │                                                     │
   │  Owner Address: 0x1234...5678                       │
   │  Owner State:   [LOCKED]                            │
   │                                                     │
   │  Approval Method                                    │
   │  (*) Use default (from global config)               │
   │  ( ) SDK + ntfy (direct push)                       │
   │  ( ) SDK + Telegram (messenger)                     │
   │  ( ) WalletConnect                                  │
   │  ( ) Telegram Bot (/approve command)                │
   │  ( ) Manual REST API                                │
   │                                                     │
   │  [Save Approval Method]                             │
   │                                                     │
   │  ───────────────────────────────────────────────── │
   ```

3. 섹션 8.2.2 하단에 Owner Settings 컴포넌트 상세 설계 추가:

   ```
   #### [v2.6] Owner Settings > Approval Method 컴포넌트

   **컴포넌트:** `ApprovalMethodSelector`

   **props:**
   | prop | 타입 | 설명 |
   |------|------|------|
   | walletId | string | 대상 지갑 ID |
   | currentMethod | string | null | 현재 설정값 (null = Use default) |
   | ownerAddress | string | null | Owner 주소 (null이면 전체 비활성) |
   | ownerState | 'NONE' | 'GRACE' | 'LOCKED' | Owner 상태 |

   **라디오 옵션:**
   | 값 | 라벨 | DB 값 |
   |-----|------|-------|
   | default | Use default (from global config) | NULL |
   | sdk_ntfy | SDK + ntfy (direct push) | 'sdk_ntfy' |
   | sdk_telegram | SDK + Telegram (messenger) | 'sdk_telegram' |
   | walletconnect | WalletConnect | 'walletconnect' |
   | telegram_bot | Telegram Bot (/approve command) | 'telegram_bot' |
   | rest | Manual REST API | 'rest' |

   **UI 동작 규칙:**
   | 조건 | 동작 |
   |------|------|
   | Owner 미등록 (ownerAddress === null) | 라디오 전체 disabled. 안내: "Register an owner first" |
   | Owner 등록됨 | 라디오 활성. 현재값 선택 상태 |
   | Save 클릭 | PUT /v1/wallets/{id}/owner { approval_method: selectedValue } |
   | "Use default" 선택 후 Save | PUT /v1/wallets/{id}/owner { approval_method: null } |

   **데이터 흐름:**
   - 마운트 시: GET /v1/wallets/{id} 응답의 owner_approval_method 값으로 초기 선택
   - Save: PUT /v1/wallets/{id}/owner { approval_method } -> 200: toast "Approval method updated" -> 데이터 갱신
   - 에러: 400 시 toast에 에러 메시지 표시

   **경고 메시지 (조건부):**
   | 조건 | 경고 텍스트 |
   |------|-----------|
   | SDK 옵션 + signing_sdk.enabled = false | "Signing SDK is not enabled. Enable it in System > Settings." |
   | SDK 옵션 + signing_sdk.wallets = [] | "No wallet registered in Signing SDK settings." |

   상세: doc 74 (74-wallet-sdk-daemon-components.md) 섹션 10.3 참조.
   ```

4. 기존 Owner 필드 설명 업데이트:
   - 기존: "**Owner 필드**: 읽기 전용. Owner 등록은 SIWS/SIWE 서명이 필요하므로 Admin UI 범위 밖"
   - 변경: "**Owner 필드**: Owner Address/State는 읽기 전용. [v2.6] Approval Method는 Owner 등록 후 수정 가능 (라디오 선택 + Save)."

5. 참조 문서(문서 하단 관련 설계 문서)에 doc 74 추가
  </action>
  <verify>
doc 25에서 "owner_approval_method" 문자열이 검색되는지 확인 (Drizzle 스키마, SQL CREATE TABLE, 마이그레이션 모두).
doc 67에서 "Approval Method", "ApprovalMethodSelector", "sdk_ntfy" 문자열이 검색되는지 확인.
두 문서 모두 v2.6 날짜가 헤더에 존재하는지 확인.
  </verify>
  <done>
doc 25에 wallets.owner_approval_method 컬럼(Drizzle + SQL + 마이그레이션 4.13)이 추가되어 있다.
doc 67에 Wallet Detail 페이지 Owner Settings > Approval Method UI 와이어프레임, ApprovalMethodSelector 컴포넌트 설계, UI 동작 규칙이 추가되어 있다.
  </done>
</task>

<task type="auto">
  <name>Task 3: 교차 검증 + 일관성 확인</name>
  <files>internal/design/35-notification-architecture.md, internal/design/37-rest-api-complete-spec.md, internal/design/25-sqlite-schema.md, internal/design/67-admin-web-ui-spec.md</files>
  <action>
4개 설계 문서 업데이트 완료 후, 다음 교차 검증 항목을 확인한다. 불일치 발견 시 해당 문서를 수정한다.

**검증 1: enum 값 일관성**
- doc 25의 CHECK 제약 enum: `'sdk_ntfy', 'sdk_telegram', 'walletconnect', 'telegram_bot', 'rest'`
- doc 37의 approval_method z.enum: 동일 5개 값
- doc 67의 라디오 옵션: 동일 5개 값
- doc 74(원본)의 OwnerApprovalMethodSchema: 동일 5개 값
모두 정확히 일치하는지 확인.

**검증 2: 컬럼명 일관성**
- DB 컬럼명: `owner_approval_method` (snake_case)
- Drizzle 필드명: `ownerApprovalMethod` (camelCase)
- REST API 요청 필드: `approval_method`
- REST API 응답 필드: `owner_approval_method`
doc 74 원본과 일치하는지 확인.

**검증 3: 토픽 접두어 일관성**
- doc 35의 토픽: `waiaas-sign-{walletId}`, `waiaas-notify-{walletId}`
- doc 73의 토픽: 동일 접두어
- doc 75의 토픽: 동일 접두어
접두어와 구분자가 일치하는지 확인.

**검증 4: NULL 의미 일관성**
- doc 25: NULL = 글로벌 fallback
- doc 37: approval_method 생략 = 기존 값 유지, null = 글로벌 fallback으로 초기화
- doc 67: "Use default" = NULL
- doc 74: NULL = ApprovalChannelRouter 글로벌 fallback 진입
모두 동일한 의미로 사용되는지 확인.

**검증 5: 문서 간 참조 무결성**
- doc 35가 doc 73/74/75를 참조하는지 확인
- doc 37이 doc 74를 참조하는지 확인
- doc 25가 doc 74를 참조하는지 확인
- doc 67이 doc 74를 참조하는지 확인

**검증 결과 기록:**
각 검증 항목이 PASS이면 별도 작업 없음. FAIL이면 해당 문서를 수정하여 일관성을 맞춘다.

교차 검증 결과를 SUMMARY에 기록한다.
  </action>
  <verify>
4개 설계 문서에서 다음 grep 검증:
1. `grep -c "owner_approval_method" internal/design/25-sqlite-schema.md` >= 3 (Drizzle + SQL + 마이그레이션)
2. `grep -c "approval_method" internal/design/37-rest-api-complete-spec.md` >= 3 (요청/응답/검증)
3. `grep -c "WalletNotificationChannel" internal/design/35-notification-architecture.md` >= 2
4. `grep -c "Approval Method" internal/design/67-admin-web-ui-spec.md` >= 3 (와이어프레임/컴포넌트/동작규칙)
5. `grep "sdk_ntfy" internal/design/25-sqlite-schema.md internal/design/37-rest-api-complete-spec.md internal/design/67-admin-web-ui-spec.md` - 3개 파일 모두에서 발견
  </verify>
  <done>
4개 설계 문서 간 enum 값, 컬럼명, 토픽 접두어, NULL 의미, 참조 링크가 모두 일관성을 유지한다. 교차 검증 PASS, 설계 부채 0건.
  </done>
</task>

</tasks>

<verification>
1. 4개 설계 문서에 v2.6 날짜가 포함되어 있다
2. doc 35에 WalletNotificationChannel + 서명/알림 토픽 분리가 기술되어 있다
3. doc 37에 PUT /v1/wallets/:id/owner approval_method 확장이 기술되어 있다
4. doc 25에 owner_approval_method 컬럼 + ALTER TABLE 마이그레이션이 기술되어 있다
5. doc 67에 Approval Method UI 와이어프레임 + 컴포넌트 설계가 기술되어 있다
6. 5개 교차 검증 항목(enum/컬럼명/토픽/NULL 의미/참조)이 모두 PASS이다
</verification>

<success_criteria>
- 4개 설계 문서가 업데이트되어 git diff로 변경 확인 가능
- 교차 검증 5개 항목 모두 PASS
- 설계 부채 0건 유지
</success_criteria>

<output>
After completion, create `.planning/phases/201-design-doc-update-cross-verification/201-01-SUMMARY.md`
</output>
